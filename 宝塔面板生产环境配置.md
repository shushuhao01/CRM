# 宝塔面板生产环境配置指南

## 🎯 生产环境数据库配置

### 第一步：创建 backend/.env 文件

在宝塔面板文件管理器中，进入 `/www/wwwroot/CRM/backend/` 目录，创建 `.env` 文件：

```bash
# ===========================================
# CRM系统生产环境配置文件
# ===========================================

# 数据库配置（必填）
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=您的数据库名
DB_USERNAME=您的用户名
DB_PASSWORD=您的密码
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00

# 应用配置
NODE_ENV=production
PORT=3000
APP_NAME=CRM系统

# JWT配置（生产环境必须修改）
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=7d

# CORS配置
CORS_ORIGIN=*
CORS_CREDENTIALS=true

# 文件上传配置
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif,pdf,doc,docx,xls,xlsx

# 邮件配置（可选）
MAIL_HOST=smtp.qq.com
MAIL_PORT=587
MAIL_USER=your-email@qq.com
MAIL_PASS=your-email-password
MAIL_FROM=your-email@qq.com

# 日志配置
LOG_LEVEL=info
LOG_MAX_FILES=30
LOG_MAX_SIZE=10m

# 安全配置
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100
SESSION_SECRET=your-session-secret-change-this

# 系统配置
SYSTEM_NAME=CRM客户管理系统
SYSTEM_VERSION=1.0.0
SYSTEM_DESCRIPTION=企业级客户关系管理系统
```

### 第二步：在宝塔面板中配置

1. **登录宝塔面板**
2. **进入文件管理器**
3. **导航到项目目录**：`/www/wwwroot/CRM/backend/`
4. **创建 .env 文件**：
   - 点击"新建文件"
   - 文件名输入：`.env`
   - 复制上面的配置内容
   - **重要**：将以下信息替换为您的实际信息：
     ```
     DB_DATABASE=您的数据库名
     DB_USERNAME=您的用户名
     DB_PASSWORD=您的密码
     ```

### 第三步：导入数据库表结构

在宝塔面板终端中执行：

```bash
# 进入项目目录
cd /www/wwwroot/CRM

# 导入数据库表结构
mysql -u 您的用户名 -p 您的数据库名 < backend/database-init.sql
```

或者使用宝塔面板数据库管理：
1. 宝塔面板 → 数据库
2. 点击您的数据库名 → 管理
3. 点击"导入" → 选择 `backend/database-init.sql` 文件

### 第四步：设置文件权限

```bash
# 设置项目文件权限
chown -R www:www /www/wwwroot/CRM
chmod +x /www/wwwroot/CRM/*.sh
```

### 第五步：测试数据库连接

```bash
# 进入项目目录
cd /www/wwwroot/CRM

# 运行数据库连接测试
./test-db.sh
```

## 🔧 常见配置问题解决

### 1. 数据库连接失败
- 检查数据库服务是否启动
- 确认用户名密码正确
- 检查数据库权限设置

### 2. 端口冲突
- 默认后端端口是3000
- 如有冲突，修改 `.env` 中的 `PORT=3001`

### 3. 权限问题
```bash
chmod 644 /www/wwwroot/CRM/backend/.env
chown www:www /www/wwwroot/CRM/backend/.env
```

## 🚀 快速部署命令

```bash
# 一键完成所有配置和部署
cd /www/wwwroot/CRM
./start.sh
```

## 📊 验证部署成功

1. **数据库连接测试**：`./test-db.sh`
2. **后端服务状态**：`pm2 list`
3. **API健康检查**：`curl http://localhost:3000/health`

## 🔐 安全提醒

⚠️ **生产环境安全配置**：
1. 修改默认的JWT_SECRET
2. 设置强密码策略
3. 配置防火墙规则
4. 定期备份数据库
5. 启用HTTPS证书

## 📞 技术支持

如遇问题：
1. 查看PM2日志：`pm2 logs crm-backend`
2. 查看数据库日志：宝塔面板 → 数据库 → 日志
3. 检查Nginx配置：宝塔面板 → 网站 → 配置文件