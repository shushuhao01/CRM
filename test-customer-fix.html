<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户新增修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>客户新增修复测试</h1>
        <p>此页面用于测试修复后的客户新增流程，验证数据不会丢失。</p>

        <div class="test-section">
            <h3>1. 检查当前存储状态</h3>
            <button onclick="checkCurrentStorage()">检查存储状态</button>
            <div id="storageStatus"></div>
        </div>

        <div class="test-section">
            <h3>2. 模拟添加客户</h3>
            <button onclick="simulateAddCustomer()">模拟添加客户</button>
            <div id="addResult"></div>
        </div>

        <div class="test-section">
            <h3>3. 测试强制同步</h3>
            <button onclick="testForceSyncData()">测试强制同步</button>
            <div id="syncResult"></div>
        </div>

        <div class="test-section">
            <h3>4. 验证数据完整性</h3>
            <button onclick="verifyDataIntegrity()">验证数据完整性</button>
            <div id="verifyResult"></div>
        </div>

        <div class="test-section">
            <h3>5. 清理测试数据</h3>
            <button onclick="cleanupTestData()">清理测试数据</button>
            <div id="cleanupResult"></div>
        </div>

        <div class="test-section">
            <h3>测试日志</h3>
            <div id="testLog" class="log"></div>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        let testCustomers = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function checkCurrentStorage() {
            try {
                const storageKey = 'crm_customers_unified';
                const data = localStorage.getItem(storageKey);
                
                if (data) {
                    const parsed = JSON.parse(data);
                    const count = parsed.customers ? parsed.customers.length : 0;
                    document.getElementById('storageStatus').innerHTML = `
                        <div class="success">存储状态正常</div>
                        <div>客户数量: ${count}</div>
                        <div>最后更新: ${new Date(parsed.lastUpdated).toLocaleString()}</div>
                        <div>版本: ${parsed.version}</div>
                    `;
                    log(`存储检查完成，当前有 ${count} 个客户`, 'success');
                } else {
                    document.getElementById('storageStatus').innerHTML = `
                        <div class="info">存储为空</div>
                    `;
                    log('存储为空', 'info');
                }
            } catch (error) {
                document.getElementById('storageStatus').innerHTML = `
                    <div class="error">存储检查失败: ${error.message}</div>
                `;
                log(`存储检查失败: ${error.message}`, 'error');
            }
        }

        function simulateAddCustomer() {
            try {
                // 生成测试客户数据
                const testCustomer = {
                    id: 'test_' + Date.now(),
                    code: 'TEST' + Date.now(),
                    name: '测试客户' + Date.now(),
                    phone: '1' + Math.floor(Math.random() * 9000000000 + 1000000000),
                    age: 25,
                    address: '测试地址',
                    level: 'normal',
                    status: 'active',
                    salesPersonId: 'test_sales',
                    orderCount: 0,
                    createTime: new Date().toISOString(),
                    createdBy: 'test_user'
                };

                // 模拟添加到存储
                const storageKey = 'crm_customers_unified';
                let data = localStorage.getItem(storageKey);
                let customers = [];
                
                if (data) {
                    const parsed = JSON.parse(data);
                    customers = parsed.customers || [];
                }
                
                customers.push(testCustomer);
                testCustomers.push(testCustomer);
                
                const storageData = {
                    customers: customers,
                    lastUpdated: Date.now(),
                    version: '1.0.0'
                };
                
                localStorage.setItem(storageKey, JSON.stringify(storageData));
                
                document.getElementById('addResult').innerHTML = `
                    <div class="success">成功添加测试客户</div>
                    <div>客户ID: ${testCustomer.id}</div>
                    <div>客户姓名: ${testCustomer.name}</div>
                    <div>手机号: ${testCustomer.phone}</div>
                    <div>当前总数: ${customers.length}</div>
                `;
                
                log(`成功添加测试客户: ${testCustomer.name} (${testCustomer.phone})`, 'success');
                
            } catch (error) {
                document.getElementById('addResult').innerHTML = `
                    <div class="error">添加客户失败: ${error.message}</div>
                `;
                log(`添加客户失败: ${error.message}`, 'error');
            }
        }

        function testForceSyncData() {
            try {
                log('开始测试强制同步...', 'info');
                
                // 记录同步前的数据
                const beforeData = localStorage.getItem('crm_customers_unified');
                const beforeCount = beforeData ? JSON.parse(beforeData).customers.length : 0;
                log(`同步前客户数量: ${beforeCount}`, 'info');
                
                // 模拟强制同步过程
                // 这里我们检查修复后的逻辑是否会保留数据
                
                // 检查是否有旧格式数据需要迁移
                const oldKeys = ['crm_store_customer', 'crm_customers', 'customers', 'customer_data', 'mock_customers'];
                let hasOldData = false;
                
                for (const key of oldKeys) {
                    if (localStorage.getItem(key)) {
                        hasOldData = true;
                        break;
                    }
                }
                
                log(`检查旧格式数据: ${hasOldData ? '发现旧数据' : '无旧数据'}`, 'info');
                
                // 模拟新的强制同步逻辑
                const currentData = localStorage.getItem('crm_customers_unified');
                if (currentData) {
                    const parsed = JSON.parse(currentData);
                    log(`存储中有数据，应该保留: ${parsed.customers.length} 个客户`, 'success');
                } else {
                    log('存储中无数据，会尝试迁移', 'info');
                }
                
                // 记录同步后的数据
                const afterData = localStorage.getItem('crm_customers_unified');
                const afterCount = afterData ? JSON.parse(afterData).customers.length : 0;
                log(`同步后客户数量: ${afterCount}`, afterCount >= beforeCount ? 'success' : 'error');
                
                document.getElementById('syncResult').innerHTML = `
                    <div class="${afterCount >= beforeCount ? 'success' : 'error'}">强制同步测试完成</div>
                    <div>同步前: ${beforeCount} 个客户</div>
                    <div>同步后: ${afterCount} 个客户</div>
                    <div>数据${afterCount >= beforeCount ? '保留' : '丢失'}</div>
                `;
                
            } catch (error) {
                document.getElementById('syncResult').innerHTML = `
                    <div class="error">强制同步测试失败: ${error.message}</div>
                `;
                log(`强制同步测试失败: ${error.message}`, 'error');
            }
        }

        function verifyDataIntegrity() {
            try {
                const data = localStorage.getItem('crm_customers_unified');
                if (!data) {
                    document.getElementById('verifyResult').innerHTML = `
                        <div class="error">验证失败: 无存储数据</div>
                    `;
                    log('验证失败: 无存储数据', 'error');
                    return;
                }
                
                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];
                
                // 检查测试客户是否还在
                let foundTestCustomers = 0;
                for (const testCustomer of testCustomers) {
                    const found = customers.find(c => c.id === testCustomer.id);
                    if (found) {
                        foundTestCustomers++;
                    }
                }
                
                const isIntegrityOk = foundTestCustomers === testCustomers.length;
                
                document.getElementById('verifyResult').innerHTML = `
                    <div class="${isIntegrityOk ? 'success' : 'error'}">数据完整性验证${isIntegrityOk ? '通过' : '失败'}</div>
                    <div>总客户数: ${customers.length}</div>
                    <div>测试客户数: ${testCustomers.length}</div>
                    <div>找到测试客户: ${foundTestCustomers}</div>
                `;
                
                log(`数据完整性验证${isIntegrityOk ? '通过' : '失败'}: ${foundTestCustomers}/${testCustomers.length}`, 
                    isIntegrityOk ? 'success' : 'error');
                
            } catch (error) {
                document.getElementById('verifyResult').innerHTML = `
                    <div class="error">验证失败: ${error.message}</div>
                `;
                log(`验证失败: ${error.message}`, 'error');
            }
        }

        function cleanupTestData() {
            try {
                const data = localStorage.getItem('crm_customers_unified');
                if (data) {
                    const parsed = JSON.parse(data);
                    const customers = parsed.customers || [];
                    
                    // 移除测试客户
                    const cleanedCustomers = customers.filter(c => !c.id.startsWith('test_'));
                    
                    const storageData = {
                        customers: cleanedCustomers,
                        lastUpdated: Date.now(),
                        version: '1.0.0'
                    };
                    
                    localStorage.setItem('crm_customers_unified', JSON.stringify(storageData));
                    
                    document.getElementById('cleanupResult').innerHTML = `
                        <div class="success">清理完成</div>
                        <div>移除了 ${testCustomers.length} 个测试客户</div>
                        <div>剩余客户: ${cleanedCustomers.length}</div>
                    `;
                    
                    log(`清理完成，移除了 ${testCustomers.length} 个测试客户`, 'success');
                    testCustomers = [];
                } else {
                    document.getElementById('cleanupResult').innerHTML = `
                        <div class="info">无需清理</div>
                    `;
                    log('无需清理', 'info');
                }
            } catch (error) {
                document.getElementById('cleanupResult').innerHTML = `
                    <div class="error">清理失败: ${error.message}</div>
                `;
                log(`清理失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查存储状态
        window.onload = function() {
            log('测试页面加载完成', 'success');
            checkCurrentStorage();
        };
    </script>
</body>
</html>