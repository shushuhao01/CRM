# 数据库表缺失问题说明

## 问题原因

**为什么前端要查询这些表格，但数据库中没有？**

这是因为项目在开发过程中，后端代码使用了 **TypeORM** 的 Entity 模式来定义数据模型，但 `database/schema.sql` 文件没有同步更新所有对应的表结构。

### 具体原因分析：

1. **开发模式不同步**
   - 后端开发时定义了 Entity（如 `Permission.ts`, `LogisticsTracking.ts` 等）
   - 但忘记在 `schema.sql` 中添加对应的表结构
   - 导致全新部署时数据库缺少这些表

2. **TypeORM 的自动同步问题**
   - 开发环境可能启用了 `synchronize: true`，会自动创建表
   - 但生产环境不应该使用自动同步，需要手动执行 SQL
   - 所以生产环境部署时会缺少这些表

## 缺失的表清单

根据后端 Entity 定义，以下表在 `schema.sql` 中缺失：

| 序号 | 表名 | Entity 文件 | 用途 | 状态 |
|------|------|------------|------|------|
| 1 | `permissions` | Permission.ts | 权限表 | ✅ 已添加 |
| 2 | `permissions_closure` | Permission.ts | 权限树形结构关系表 | ✅ 已添加 |
| 3 | `user_permissions` | UserPermission.ts | 用户个人权限表 | ✅ 已添加 |
| 4 | `logistics_status` | LogisticsStatus.ts | 物流状态配置表 | ✅ 已添加 |
| 5 | `logistics_tracking` | LogisticsTracking.ts | 物流跟踪表 | ✅ 已添加 |
| 6 | `logistics_traces` | LogisticsTrace.ts | 物流轨迹表 | ✅ 已添加 |
| 7 | `order_items` | OrderItem.ts | 订单明细表 | ✅ 已添加 |
| 8 | `order_status_history` | OrderStatusHistory.ts | 订单状态历史表 | ✅ 已添加 |

## 解决方案

### 方案一：全新部署（推荐）

如果是全新部署，直接使用更新后的 `schema.sql`：

```bash
# 在宝塔面板或命令行执行
mysql -u用户名 -p密码 数据库名 < database/schema.sql
```

### 方案二：现有数据库补充（推荐用于已有数据）

如果数据库已有数据，使用补充脚本：

```bash
# 在宝塔面板或命令行执行
mysql -u用户名 -p密码 数据库名 < database/add-missing-tables.sql
```

或在宝塔面板 - 数据库 - 管理 - SQL 中执行 `add-missing-tables.sql` 的内容。

### 方案三：检查并手动创建

1. 登录数据库
2. 检查哪些表缺失：
```sql
SHOW TABLES LIKE 'permissions';
SHOW TABLES LIKE 'user_permissions';
SHOW TABLES LIKE 'logistics_tracking';
SHOW TABLES LIKE 'order_items';
```

3. 根据检查结果，从 `add-missing-tables.sql` 中复制对应的 CREATE TABLE 语句执行

## 影响范围

### 登录功能
- **影响**：如果缺少 `permissions` 表，登录时记录日志可能失败
- **解决**：已在 `UserController.ts` 中用 try-catch 包裹，不会阻止登录

### 物流功能
- **影响**：物流跟踪、轨迹查询功能无法使用
- **需要**：`logistics_tracking`, `logistics_traces`, `logistics_status` 表

### 订单功能
- **影响**：订单明细、状态历史记录功能受限
- **需要**：`order_items`, `order_status_history` 表

### 权限管理
- **影响**：细粒度权限控制功能无法使用
- **需要**：`permissions`, `permissions_closure`, `user_permissions` 表

## 预防措施

为避免将来再次出现此类问题：

1. **开发规范**
   - 每次添加新 Entity 时，同步更新 `schema.sql`
   - 在 `database/migrations/` 目录记录数据库变更

2. **部署检查**
   - 部署前对比 Entity 文件和 schema.sql
   - 使用脚本自动检查表是否完整

3. **文档维护**
   - 更新数据库版本说明文档
   - 记录每次表结构变更

## 更新记录

- **2024-11-25 v1.8.4**：添加 6 个缺失的表
  - user_permissions
  - logistics_status
  - logistics_tracking
  - logistics_traces
  - order_items
  - order_status_history

- **2024-11-25 v1.8.3**：添加权限相关表
  - permissions
  - permissions_closure

## 相关文件

- `database/schema.sql` - 完整数据库结构（已更新）
- `database/add-missing-tables.sql` - 补充缺失表的脚本
- `backend/src/entities/` - 所有 Entity 定义
- `backend/src/controllers/UserController.ts` - 已优化登录逻辑

## 技术说明

### TypeORM Entity vs SQL Schema

**Entity（代码定义）**：
```typescript
@Entity('permissions')
export class Permission {
  @PrimaryGeneratedColumn()
  id: number;
  
  @Column({ length: 100 })
  name: string;
}
```

**对应的 SQL**：
```sql
CREATE TABLE `permissions` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(100) NOT NULL
);
```

两者必须保持一致，否则会导致运行时错误。
