<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端到后端连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>前端到后端连接测试</h1>
        <p>测试从前端页面到后端API的连接</p>
        
        <div class="test-section">
            <h3>1. 基础连接测试</h3>
            <button onclick="testBasicConnection()">测试基础连接</button>
            <div id="basicResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. 登录API测试</h3>
            <button onclick="testLoginAPI()">测试登录API</button>
            <div id="loginResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. 模拟前端登录流程</h3>
            <button onclick="simulateFrontendLogin()">模拟前端登录</button>
            <div id="simulateResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. 检查浏览器控制台</h3>
            <button onclick="checkConsoleErrors()">检查控制台错误</button>
            <div id="consoleResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/v1';
        
        function showResult(elementId, type, content) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.style.display = 'block';
            element.innerHTML = content;
        }
        
        async function testBasicConnection() {
            showResult('basicResult', 'info', '正在测试基础连接...');
            
            try {
                console.log('开始测试基础连接');
                const response = await fetch(`${API_BASE_URL}/health`);
                console.log('健康检查响应:', response);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('健康检查数据:', data);
                    showResult('basicResult', 'success', 
                        `✅ 基础连接成功<br>状态: ${response.status}<br>响应: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                } else {
                    console.error('健康检查失败:', response.status, response.statusText);
                    showResult('basicResult', 'error', 
                        `❌ 基础连接失败<br>状态: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('基础连接错误:', error);
                showResult('basicResult', 'error', 
                    `❌ 基础连接错误<br>错误: ${error.message}<br>详情: <pre>${error.stack}</pre>`);
            }
        }
        
        async function testLoginAPI() {
            showResult('loginResult', 'info', '正在测试登录API...');
            
            try {
                console.log('开始测试登录API');
                const loginData = {
                    username: 'admin',
                    password: 'admin123'
                };
                
                console.log('发送登录请求:', loginData);
                const response = await fetch(`${API_BASE_URL}/mock-auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                console.log('登录响应:', response);
                console.log('响应头:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('登录数据:', data);
                    showResult('loginResult', 'success', 
                        `✅ 登录API成功<br>状态: ${response.status}<br>消息: ${data.message}<br>用户: ${data.data?.user?.realName}<br>响应: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                } else {
                    const errorText = await response.text();
                    console.error('登录API失败:', response.status, response.statusText, errorText);
                    showResult('loginResult', 'error', 
                        `❌ 登录API失败<br>状态: ${response.status} ${response.statusText}<br>错误: <pre>${errorText}</pre>`);
                }
            } catch (error) {
                console.error('登录API错误:', error);
                showResult('loginResult', 'error', 
                    `❌ 登录API错误<br>错误: ${error.message}<br>详情: <pre>${error.stack}</pre>`);
            }
        }
        
        async function simulateFrontendLogin() {
            showResult('simulateResult', 'info', '正在模拟前端登录流程...');
            
            try {
                console.log('开始模拟前端登录流程');
                
                // 步骤1: 清除现有认证信息
                localStorage.removeItem('token');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('user_info');
                console.log('已清除现有认证信息');
                
                // 步骤2: 发送登录请求
                const loginData = {
                    username: 'admin',
                    password: 'admin123',
                    rememberMe: false
                };
                
                console.log('发送登录请求:', loginData);
                const response = await fetch(`${API_BASE_URL}/mock-auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                console.log('登录响应:', response);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('登录成功，数据:', data);
                    
                    // 步骤3: 保存认证信息
                    if (data.data?.accessToken) {
                        localStorage.setItem('accessToken', data.data.accessToken);
                        localStorage.setItem('token', data.data.accessToken);
                        console.log('已保存accessToken');
                    }
                    
                    if (data.data?.user) {
                        localStorage.setItem('user_info', JSON.stringify(data.data.user));
                        console.log('已保存用户信息');
                    }
                    
                    // 步骤4: 测试认证API
                    console.log('测试认证API...');
                    const meResponse = await fetch(`${API_BASE_URL}/mock-auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${data.data.accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('认证API响应:', meResponse);
                    
                    if (meResponse.ok) {
                        const meData = await meResponse.json();
                        console.log('认证API成功:', meData);
                        showResult('simulateResult', 'success', 
                            `✅ 前端登录流程模拟成功<br>
                            1. 登录成功: ${data.message}<br>
                            2. Token已保存: ${data.data.accessToken.substring(0, 20)}...<br>
                            3. 用户信息已保存: ${data.data.user.realName}<br>
                            4. 认证API测试成功<br>
                            <pre>用户信息: ${JSON.stringify(meData, null, 2)}</pre>`);
                    } else {
                        const meError = await meResponse.text();
                        console.error('认证API失败:', meResponse.status, meError);
                        showResult('simulateResult', 'error', 
                            `⚠️ 登录成功但认证API失败<br>
                            登录状态: ${response.status}<br>
                            认证API状态: ${meResponse.status}<br>
                            认证错误: <pre>${meError}</pre>`);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('登录失败:', response.status, response.statusText, errorText);
                    showResult('simulateResult', 'error', 
                        `❌ 登录失败<br>状态: ${response.status} ${response.statusText}<br>错误: <pre>${errorText}</pre>`);
                }
            } catch (error) {
                console.error('前端登录流程错误:', error);
                showResult('simulateResult', 'error', 
                    `❌ 前端登录流程错误<br>错误: ${error.message}<br>详情: <pre>${error.stack}</pre>`);
            }
        }
        
        function checkConsoleErrors() {
            showResult('consoleResult', 'info', '检查浏览器控制台...');
            
            const results = [];
            
            // 检查网络状态
            results.push(`网络状态: ${navigator.onLine ? '在线' : '离线'}`);
            
            // 检查当前页面信息
            results.push(`当前页面: ${window.location.href}`);
            results.push(`协议: ${window.location.protocol}`);
            results.push(`主机: ${window.location.host}`);
            
            // 检查本地存储
            const token = localStorage.getItem('token') || localStorage.getItem('accessToken');
            const userInfo = localStorage.getItem('user_info');
            results.push(`Token存在: ${token ? '是' : '否'}`);
            results.push(`用户信息存在: ${userInfo ? '是' : '否'}`);
            
            // 检查浏览器支持
            results.push(`Fetch API支持: ${typeof fetch !== 'undefined' ? '是' : '否'}`);
            results.push(`LocalStorage支持: ${typeof localStorage !== 'undefined' ? '是' : '否'}`);
            
            showResult('consoleResult', 'info', 
                `浏览器环境检查:<br><pre>${results.join('\n')}</pre><br>
                <strong>请打开浏览器开发者工具的控制台查看详细的网络请求日志</strong>`);
        }
        
        // 页面加载时自动运行基础测试
        window.onload = function() {
            console.log('页面加载完成，开始自动测试');
            setTimeout(() => {
                testBasicConnection();
            }, 1000);
        };
        
        // 监听所有网络错误
        window.addEventListener('error', function(e) {
            console.error('页面错误:', e);
        });
        
        // 监听未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function(e) {
            console.error('未处理的Promise拒绝:', e);
        });
    </script>
</body>
</html>