<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限控制测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .role-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .role-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .role-btn.super-admin {
            background-color: #ff4757;
            color: white;
        }
        .role-btn.admin {
            background-color: #ff6b6b;
            color: white;
        }
        .role-btn.department-manager {
            background-color: #ffa502;
            color: white;
        }
        .role-btn.sales-staff {
            background-color: #2ed573;
            color: white;
        }
        .role-btn.customer-service {
            background-color: #3742fa;
            color: white;
        }
        .role-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .current-user {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .permission-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .ranking-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }
        .log {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 Dashboard权限控制测试</h1>
        <p>此页面用于测试不同角色用户在Dashboard中看到的数据范围是否正确。</p>

        <div class="test-section">
            <h3>1. 角色切换测试</h3>
            <p>点击下面的按钮模拟不同角色的用户登录：</p>
            <div class="role-buttons">
                <button class="role-btn super-admin" onclick="switchRole('super_admin')">超级管理员</button>
                <button class="role-btn admin" onclick="switchRole('admin')">系统管理员</button>
                <button class="role-btn department-manager" onclick="switchRole('department_manager')">部门经理</button>
                <button class="role-btn sales-staff" onclick="switchRole('sales_staff')">销售人员</button>
                <button class="role-btn customer-service" onclick="switchRole('customer_service')">客服人员</button>
            </div>

            <div class="current-user" id="currentUser">
                <strong>当前用户：</strong>未登录
            </div>

            <div class="permission-info" id="permissionInfo">
                <strong>权限参数：</strong>暂无
            </div>
        </div>

        <div class="test-section">
            <h3>2. 核心指标权限测试</h3>
            <p>验证不同角色用户看到的指标标签是否包含正确的数据范围标识：</p>
            <div class="metrics-grid" id="metricsGrid">
                <!-- 动态生成指标卡片 -->
            </div>
        </div>

        <div class="test-section">
            <h3>3. 排行榜权限测试</h3>
            <p>验证排行榜标题是否根据用户权限显示正确的数据范围：</p>
            <div class="ranking-section" id="rankingSection">
                <strong>排行榜标题：</strong><span id="rankingTitle">暂无</span>
            </div>
        </div>

        <div class="test-section">
            <h3>4. API调用测试</h3>
            <p>测试Dashboard API调用时是否传递了正确的权限参数：</p>
            <button onclick="testDashboardAPI()" style="margin-bottom: 15px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">测试Dashboard API</button>
            <div class="log" id="apiLog">等待测试...</div>
        </div>

        <div class="test-section">
            <h3>5. 测试结果</h3>
            <div id="testResults">
                <div class="status loading">等待测试...</div>
            </div>
        </div>
    </div>

    <script>
        let currentRole = null;
        let testResults = [];

        // 模拟用户数据
        const mockUsers = {
            'super_admin': {
                id: 1,
                name: '超级管理员',
                role: 'super_admin',
                departmentId: null,
                department: null
            },
            'admin': {
                id: 2,
                name: '系统管理员',
                role: 'admin',
                departmentId: null,
                department: null
            },
            'department_manager': {
                id: 3,
                name: '部门经理',
                role: 'department_manager',
                departmentId: 1,
                department: '销售部'
            },
            'sales_staff': {
                id: 4,
                name: '销售人员',
                role: 'sales_staff',
                departmentId: 1,
                department: '销售部'
            },
            'customer_service': {
                id: 5,
                name: '客服人员',
                role: 'customer_service',
                departmentId: 2,
                department: '客服部'
            }
        };

        // 切换角色
        function switchRole(role) {
            currentRole = role;
            const user = mockUsers[role];
            
            // 更新当前用户显示
            document.getElementById('currentUser').innerHTML = `
                <strong>当前用户：</strong>${user.name} (${user.role})
                <br><strong>部门：</strong>${user.department || '无'}
                <br><strong>用户ID：</strong>${user.id}
                <br><strong>部门ID：</strong>${user.departmentId || '无'}
            `;

            // 生成权限参数
            const permissionParams = getUserPermissionParams(user);
            document.getElementById('permissionInfo').innerHTML = `
                <strong>权限参数：</strong>
                <pre>${JSON.stringify(permissionParams, null, 2)}</pre>
            `;

            // 更新指标显示
            updateMetricsDisplay(user);

            // 更新排行榜标题
            updateRankingTitle(user);

            // 添加测试结果
            addTestResult(`✅ 成功切换到角色：${user.name}`, 'success');
        }

        // 获取用户权限参数（模拟Dashboard.vue中的逻辑）
        function getUserPermissionParams(user) {
            if (!user) return {};
            
            const params = {
                userRole: user.role,
                userId: user.id,
                departmentId: user.departmentId || user.department
            };
            
            // 根据角色设置数据范围
            switch (user.role) {
                case 'super_admin':
                case 'admin':
                    params.dataScope = 'all';
                    break;
                case 'department_manager':
                case 'manager':
                    params.dataScope = 'department';
                    params.departmentId = user.departmentId || user.department;
                    break;
                case 'sales_staff':
                case 'customer_service':
                default:
                    params.dataScope = 'personal';
                    params.userId = user.id;
                    break;
            }
            
            return params;
        }

        // 获取指标标签（模拟Dashboard.vue中的逻辑）
        function getMetricLabels(user) {
            if (!user) return {};
            
            const isAdmin = user.role === 'super_admin' || user.role === 'admin';
            const isDeptManager = user.role === 'department_manager' || user.role === 'manager';
            
            if (isAdmin) {
                return {
                    orders: '今日订单（全部）',
                    customers: '新增客户（全部）',
                    revenue: '今日业绩（全部）',
                    monthlyOrders: '本月单数（全部）',
                    monthlyRevenue: '本月业绩（全部）',
                    service: '待处理售后（全部）'
                };
            } else if (isDeptManager) {
                return {
                    orders: '今日订单（部门）',
                    customers: '新增客户（部门）',
                    revenue: '今日业绩（部门）',
                    monthlyOrders: '本月单数（部门）',
                    monthlyRevenue: '本月业绩（部门）',
                    service: '待处理售后（部门）'
                };
            } else {
                return {
                    orders: '今日订单（个人）',
                    customers: '新增客户（个人）',
                    revenue: '今日业绩（个人）',
                    monthlyOrders: '本月单数（个人）',
                    monthlyRevenue: '本月业绩（个人）',
                    service: '待处理售后（个人）'
                };
            }
        }

        // 获取排行榜标题（模拟Dashboard.vue中的逻辑）
        function getRankingTitle(user) {
            if (!user) return '本月业绩排名';
            
            const isAdmin = user.role === 'super_admin' || user.role === 'admin';
            const isDeptManager = user.role === 'department_manager' || user.role === 'manager';
            
            if (isAdmin) {
                return '本月业绩排名（全部）';
            } else if (isDeptManager) {
                return '本月业绩排名（部门）';
            } else {
                return '本月业绩排名（个人）';
            }
        }

        // 更新指标显示
        function updateMetricsDisplay(user) {
            const labels = getMetricLabels(user);
            const metricsGrid = document.getElementById('metricsGrid');
            
            const metrics = [
                { key: 'orders', label: labels.orders, value: '128', color: '#409EFF' },
                { key: 'customers', label: labels.customers, value: '45', color: '#67C23A' },
                { key: 'revenue', label: labels.revenue, value: '¥25,680', color: '#E6A23C' },
                { key: 'monthlyOrders', label: labels.monthlyOrders, value: '1,256', color: '#722ED1' },
                { key: 'monthlyRevenue', label: labels.monthlyRevenue, value: '¥156,890', color: '#13C2C2' },
                { key: 'service', label: labels.service, value: '12', color: '#F56C6C' }
            ];

            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card" style="background: ${metric.color};">
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${metric.value}</div>
                </div>
            `).join('');

            // 验证标签是否正确
            const expectedSuffix = user.role === 'super_admin' || user.role === 'admin' ? '（全部）' :
                                 user.role === 'department_manager' ? '（部门）' : '（个人）';
            
            const allLabelsCorrect = metrics.every(metric => metric.label.includes(expectedSuffix));
            
            if (allLabelsCorrect) {
                addTestResult(`✅ 指标标签权限控制正确：所有标签都包含"${expectedSuffix}"`, 'success');
            } else {
                addTestResult(`❌ 指标标签权限控制错误：标签应该包含"${expectedSuffix}"`, 'error');
            }
        }

        // 更新排行榜标题
        function updateRankingTitle(user) {
            const title = getRankingTitle(user);
            document.getElementById('rankingTitle').textContent = title;

            // 验证标题是否正确
            const expectedSuffix = user.role === 'super_admin' || user.role === 'admin' ? '（全部）' :
                                 user.role === 'department_manager' ? '（部门）' : '（个人）';
            
            if (title.includes(expectedSuffix)) {
                addTestResult(`✅ 排行榜标题权限控制正确：${title}`, 'success');
            } else {
                addTestResult(`❌ 排行榜标题权限控制错误：应该包含"${expectedSuffix}"`, 'error');
            }
        }

        // 测试Dashboard API
        async function testDashboardAPI() {
            if (!currentRole) {
                addTestResult('❌ 请先选择一个角色', 'error');
                return;
            }

            const user = mockUsers[currentRole];
            const permissionParams = getUserPermissionParams(user);
            
            const apiLog = document.getElementById('apiLog');
            apiLog.textContent = '正在测试API调用...\n';

            try {
                // 模拟API调用
                apiLog.textContent += `发送权限参数：\n${JSON.stringify(permissionParams, null, 2)}\n\n`;
                
                // 验证权限参数
                const requiredFields = ['userRole', 'userId', 'dataScope'];
                const missingFields = requiredFields.filter(field => !permissionParams[field]);
                
                if (missingFields.length > 0) {
                    apiLog.textContent += `❌ 缺少必要字段：${missingFields.join(', ')}\n`;
                    addTestResult('❌ API权限参数不完整', 'error');
                } else {
                    apiLog.textContent += '✅ 权限参数完整\n';
                    
                    // 验证数据范围设置
                    const expectedDataScope = user.role === 'super_admin' || user.role === 'admin' ? 'all' :
                                            user.role === 'department_manager' ? 'department' : 'personal';
                    
                    if (permissionParams.dataScope === expectedDataScope) {
                        apiLog.textContent += `✅ 数据范围设置正确：${expectedDataScope}\n`;
                        addTestResult('✅ API权限参数设置正确', 'success');
                    } else {
                        apiLog.textContent += `❌ 数据范围设置错误：期望${expectedDataScope}，实际${permissionParams.dataScope}\n`;
                        addTestResult('❌ API权限参数设置错误', 'error');
                    }
                }
                
            } catch (error) {
                apiLog.textContent += `❌ API测试失败：${error.message}\n`;
                addTestResult('❌ API测试失败', 'error');
            }
        }

        // 添加测试结果
        function addTestResult(message, type) {
            testResults.push({ message, type, timestamp: new Date().toLocaleTimeString() });
            updateTestResults();
        }

        // 更新测试结果显示
        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            
            if (testResults.length === 0) {
                resultsDiv.innerHTML = '<div class="status loading">等待测试...</div>';
                return;
            }

            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            
            let html = `<div class="status ${errorCount > 0 ? 'error' : 'success'}">
                测试完成：${successCount} 个通过，${errorCount} 个失败
            </div><br>`;
            
            html += testResults.map(result => `
                <div class="status ${result.type}">
                    [${result.timestamp}] ${result.message}
                </div>
            `).join('<br>');
            
            resultsDiv.innerHTML = html;
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('📋 权限控制测试页面已加载', 'success');
            addTestResult('💡 请选择一个角色开始测试', 'loading');
        });
    </script>
</body>
</html>