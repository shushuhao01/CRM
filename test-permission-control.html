<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒé™æ§åˆ¶æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .role-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .role-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .role-btn.super-admin {
            background-color: #ff4757;
            color: white;
        }
        .role-btn.admin {
            background-color: #ff6b6b;
            color: white;
        }
        .role-btn.department-manager {
            background-color: #ffa502;
            color: white;
        }
        .role-btn.sales-staff {
            background-color: #2ed573;
            color: white;
        }
        .role-btn.customer-service {
            background-color: #3742fa;
            color: white;
        }
        .role-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .current-user {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .permission-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .ranking-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }
        .log {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Dashboardæƒé™æ§åˆ¶æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¸åŒè§’è‰²ç”¨æˆ·åœ¨Dashboardä¸­çœ‹åˆ°çš„æ•°æ®èŒƒå›´æ˜¯å¦æ­£ç¡®ã€‚</p>

        <div class="test-section">
            <h3>1. è§’è‰²åˆ‡æ¢æµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ¨¡æ‹Ÿä¸åŒè§’è‰²çš„ç”¨æˆ·ç™»å½•ï¼š</p>
            <div class="role-buttons">
                <button class="role-btn super-admin" onclick="switchRole('super_admin')">è¶…çº§ç®¡ç†å‘˜</button>
                <button class="role-btn admin" onclick="switchRole('admin')">ç³»ç»Ÿç®¡ç†å‘˜</button>
                <button class="role-btn department-manager" onclick="switchRole('department_manager')">éƒ¨é—¨ç»ç†</button>
                <button class="role-btn sales-staff" onclick="switchRole('sales_staff')">é”€å”®äººå‘˜</button>
                <button class="role-btn customer-service" onclick="switchRole('customer_service')">å®¢æœäººå‘˜</button>
            </div>

            <div class="current-user" id="currentUser">
                <strong>å½“å‰ç”¨æˆ·ï¼š</strong>æœªç™»å½•
            </div>

            <div class="permission-info" id="permissionInfo">
                <strong>æƒé™å‚æ•°ï¼š</strong>æš‚æ— 
            </div>
        </div>

        <div class="test-section">
            <h3>2. æ ¸å¿ƒæŒ‡æ ‡æƒé™æµ‹è¯•</h3>
            <p>éªŒè¯ä¸åŒè§’è‰²ç”¨æˆ·çœ‹åˆ°çš„æŒ‡æ ‡æ ‡ç­¾æ˜¯å¦åŒ…å«æ­£ç¡®çš„æ•°æ®èŒƒå›´æ ‡è¯†ï¼š</p>
            <div class="metrics-grid" id="metricsGrid">
                <!-- åŠ¨æ€ç”ŸæˆæŒ‡æ ‡å¡ç‰‡ -->
            </div>
        </div>

        <div class="test-section">
            <h3>3. æ’è¡Œæ¦œæƒé™æµ‹è¯•</h3>
            <p>éªŒè¯æ’è¡Œæ¦œæ ‡é¢˜æ˜¯å¦æ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤ºæ­£ç¡®çš„æ•°æ®èŒƒå›´ï¼š</p>
            <div class="ranking-section" id="rankingSection">
                <strong>æ’è¡Œæ¦œæ ‡é¢˜ï¼š</strong><span id="rankingTitle">æš‚æ— </span>
            </div>
        </div>

        <div class="test-section">
            <h3>4. APIè°ƒç”¨æµ‹è¯•</h3>
            <p>æµ‹è¯•Dashboard APIè°ƒç”¨æ—¶æ˜¯å¦ä¼ é€’äº†æ­£ç¡®çš„æƒé™å‚æ•°ï¼š</p>
            <button onclick="testDashboardAPI()" style="margin-bottom: 15px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">æµ‹è¯•Dashboard API</button>
            <div class="log" id="apiLog">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>5. æµ‹è¯•ç»“æœ</h3>
            <div id="testResults">
                <div class="status loading">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script>
        let currentRole = null;
        let testResults = [];

        // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
        const mockUsers = {
            'super_admin': {
                id: 1,
                name: 'è¶…çº§ç®¡ç†å‘˜',
                role: 'super_admin',
                departmentId: null,
                department: null
            },
            'admin': {
                id: 2,
                name: 'ç³»ç»Ÿç®¡ç†å‘˜',
                role: 'admin',
                departmentId: null,
                department: null
            },
            'department_manager': {
                id: 3,
                name: 'éƒ¨é—¨ç»ç†',
                role: 'department_manager',
                departmentId: 1,
                department: 'é”€å”®éƒ¨'
            },
            'sales_staff': {
                id: 4,
                name: 'é”€å”®äººå‘˜',
                role: 'sales_staff',
                departmentId: 1,
                department: 'é”€å”®éƒ¨'
            },
            'customer_service': {
                id: 5,
                name: 'å®¢æœäººå‘˜',
                role: 'customer_service',
                departmentId: 2,
                department: 'å®¢æœéƒ¨'
            }
        };

        // åˆ‡æ¢è§’è‰²
        function switchRole(role) {
            currentRole = role;
            const user = mockUsers[role];
            
            // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
            document.getElementById('currentUser').innerHTML = `
                <strong>å½“å‰ç”¨æˆ·ï¼š</strong>${user.name} (${user.role})
                <br><strong>éƒ¨é—¨ï¼š</strong>${user.department || 'æ— '}
                <br><strong>ç”¨æˆ·IDï¼š</strong>${user.id}
                <br><strong>éƒ¨é—¨IDï¼š</strong>${user.departmentId || 'æ— '}
            `;

            // ç”Ÿæˆæƒé™å‚æ•°
            const permissionParams = getUserPermissionParams(user);
            document.getElementById('permissionInfo').innerHTML = `
                <strong>æƒé™å‚æ•°ï¼š</strong>
                <pre>${JSON.stringify(permissionParams, null, 2)}</pre>
            `;

            // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
            updateMetricsDisplay(user);

            // æ›´æ–°æ’è¡Œæ¦œæ ‡é¢˜
            updateRankingTitle(user);

            // æ·»åŠ æµ‹è¯•ç»“æœ
            addTestResult(`âœ… æˆåŠŸåˆ‡æ¢åˆ°è§’è‰²ï¼š${user.name}`, 'success');
        }

        // è·å–ç”¨æˆ·æƒé™å‚æ•°ï¼ˆæ¨¡æ‹ŸDashboard.vueä¸­çš„é€»è¾‘ï¼‰
        function getUserPermissionParams(user) {
            if (!user) return {};
            
            const params = {
                userRole: user.role,
                userId: user.id,
                departmentId: user.departmentId || user.department
            };
            
            // æ ¹æ®è§’è‰²è®¾ç½®æ•°æ®èŒƒå›´
            switch (user.role) {
                case 'super_admin':
                case 'admin':
                    params.dataScope = 'all';
                    break;
                case 'department_manager':
                case 'manager':
                    params.dataScope = 'department';
                    params.departmentId = user.departmentId || user.department;
                    break;
                case 'sales_staff':
                case 'customer_service':
                default:
                    params.dataScope = 'personal';
                    params.userId = user.id;
                    break;
            }
            
            return params;
        }

        // è·å–æŒ‡æ ‡æ ‡ç­¾ï¼ˆæ¨¡æ‹ŸDashboard.vueä¸­çš„é€»è¾‘ï¼‰
        function getMetricLabels(user) {
            if (!user) return {};
            
            const isAdmin = user.role === 'super_admin' || user.role === 'admin';
            const isDeptManager = user.role === 'department_manager' || user.role === 'manager';
            
            if (isAdmin) {
                return {
                    orders: 'ä»Šæ—¥è®¢å•ï¼ˆå…¨éƒ¨ï¼‰',
                    customers: 'æ–°å¢å®¢æˆ·ï¼ˆå…¨éƒ¨ï¼‰',
                    revenue: 'ä»Šæ—¥ä¸šç»©ï¼ˆå…¨éƒ¨ï¼‰',
                    monthlyOrders: 'æœ¬æœˆå•æ•°ï¼ˆå…¨éƒ¨ï¼‰',
                    monthlyRevenue: 'æœ¬æœˆä¸šç»©ï¼ˆå…¨éƒ¨ï¼‰',
                    service: 'å¾…å¤„ç†å”®åï¼ˆå…¨éƒ¨ï¼‰'
                };
            } else if (isDeptManager) {
                return {
                    orders: 'ä»Šæ—¥è®¢å•ï¼ˆéƒ¨é—¨ï¼‰',
                    customers: 'æ–°å¢å®¢æˆ·ï¼ˆéƒ¨é—¨ï¼‰',
                    revenue: 'ä»Šæ—¥ä¸šç»©ï¼ˆéƒ¨é—¨ï¼‰',
                    monthlyOrders: 'æœ¬æœˆå•æ•°ï¼ˆéƒ¨é—¨ï¼‰',
                    monthlyRevenue: 'æœ¬æœˆä¸šç»©ï¼ˆéƒ¨é—¨ï¼‰',
                    service: 'å¾…å¤„ç†å”®åï¼ˆéƒ¨é—¨ï¼‰'
                };
            } else {
                return {
                    orders: 'ä»Šæ—¥è®¢å•ï¼ˆä¸ªäººï¼‰',
                    customers: 'æ–°å¢å®¢æˆ·ï¼ˆä¸ªäººï¼‰',
                    revenue: 'ä»Šæ—¥ä¸šç»©ï¼ˆä¸ªäººï¼‰',
                    monthlyOrders: 'æœ¬æœˆå•æ•°ï¼ˆä¸ªäººï¼‰',
                    monthlyRevenue: 'æœ¬æœˆä¸šç»©ï¼ˆä¸ªäººï¼‰',
                    service: 'å¾…å¤„ç†å”®åï¼ˆä¸ªäººï¼‰'
                };
            }
        }

        // è·å–æ’è¡Œæ¦œæ ‡é¢˜ï¼ˆæ¨¡æ‹ŸDashboard.vueä¸­çš„é€»è¾‘ï¼‰
        function getRankingTitle(user) {
            if (!user) return 'æœ¬æœˆä¸šç»©æ’å';
            
            const isAdmin = user.role === 'super_admin' || user.role === 'admin';
            const isDeptManager = user.role === 'department_manager' || user.role === 'manager';
            
            if (isAdmin) {
                return 'æœ¬æœˆä¸šç»©æ’åï¼ˆå…¨éƒ¨ï¼‰';
            } else if (isDeptManager) {
                return 'æœ¬æœˆä¸šç»©æ’åï¼ˆéƒ¨é—¨ï¼‰';
            } else {
                return 'æœ¬æœˆä¸šç»©æ’åï¼ˆä¸ªäººï¼‰';
            }
        }

        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetricsDisplay(user) {
            const labels = getMetricLabels(user);
            const metricsGrid = document.getElementById('metricsGrid');
            
            const metrics = [
                { key: 'orders', label: labels.orders, value: '128', color: '#409EFF' },
                { key: 'customers', label: labels.customers, value: '45', color: '#67C23A' },
                { key: 'revenue', label: labels.revenue, value: 'Â¥25,680', color: '#E6A23C' },
                { key: 'monthlyOrders', label: labels.monthlyOrders, value: '1,256', color: '#722ED1' },
                { key: 'monthlyRevenue', label: labels.monthlyRevenue, value: 'Â¥156,890', color: '#13C2C2' },
                { key: 'service', label: labels.service, value: '12', color: '#F56C6C' }
            ];

            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card" style="background: ${metric.color};">
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${metric.value}</div>
                </div>
            `).join('');

            // éªŒè¯æ ‡ç­¾æ˜¯å¦æ­£ç¡®
            const expectedSuffix = user.role === 'super_admin' || user.role === 'admin' ? 'ï¼ˆå…¨éƒ¨ï¼‰' :
                                 user.role === 'department_manager' ? 'ï¼ˆéƒ¨é—¨ï¼‰' : 'ï¼ˆä¸ªäººï¼‰';
            
            const allLabelsCorrect = metrics.every(metric => metric.label.includes(expectedSuffix));
            
            if (allLabelsCorrect) {
                addTestResult(`âœ… æŒ‡æ ‡æ ‡ç­¾æƒé™æ§åˆ¶æ­£ç¡®ï¼šæ‰€æœ‰æ ‡ç­¾éƒ½åŒ…å«"${expectedSuffix}"`, 'success');
            } else {
                addTestResult(`âŒ æŒ‡æ ‡æ ‡ç­¾æƒé™æ§åˆ¶é”™è¯¯ï¼šæ ‡ç­¾åº”è¯¥åŒ…å«"${expectedSuffix}"`, 'error');
            }
        }

        // æ›´æ–°æ’è¡Œæ¦œæ ‡é¢˜
        function updateRankingTitle(user) {
            const title = getRankingTitle(user);
            document.getElementById('rankingTitle').textContent = title;

            // éªŒè¯æ ‡é¢˜æ˜¯å¦æ­£ç¡®
            const expectedSuffix = user.role === 'super_admin' || user.role === 'admin' ? 'ï¼ˆå…¨éƒ¨ï¼‰' :
                                 user.role === 'department_manager' ? 'ï¼ˆéƒ¨é—¨ï¼‰' : 'ï¼ˆä¸ªäººï¼‰';
            
            if (title.includes(expectedSuffix)) {
                addTestResult(`âœ… æ’è¡Œæ¦œæ ‡é¢˜æƒé™æ§åˆ¶æ­£ç¡®ï¼š${title}`, 'success');
            } else {
                addTestResult(`âŒ æ’è¡Œæ¦œæ ‡é¢˜æƒé™æ§åˆ¶é”™è¯¯ï¼šåº”è¯¥åŒ…å«"${expectedSuffix}"`, 'error');
            }
        }

        // æµ‹è¯•Dashboard API
        async function testDashboardAPI() {
            if (!currentRole) {
                addTestResult('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            const user = mockUsers[currentRole];
            const permissionParams = getUserPermissionParams(user);
            
            const apiLog = document.getElementById('apiLog');
            apiLog.textContent = 'æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...\n';

            try {
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                apiLog.textContent += `å‘é€æƒé™å‚æ•°ï¼š\n${JSON.stringify(permissionParams, null, 2)}\n\n`;
                
                // éªŒè¯æƒé™å‚æ•°
                const requiredFields = ['userRole', 'userId', 'dataScope'];
                const missingFields = requiredFields.filter(field => !permissionParams[field]);
                
                if (missingFields.length > 0) {
                    apiLog.textContent += `âŒ ç¼ºå°‘å¿…è¦å­—æ®µï¼š${missingFields.join(', ')}\n`;
                    addTestResult('âŒ APIæƒé™å‚æ•°ä¸å®Œæ•´', 'error');
                } else {
                    apiLog.textContent += 'âœ… æƒé™å‚æ•°å®Œæ•´\n';
                    
                    // éªŒè¯æ•°æ®èŒƒå›´è®¾ç½®
                    const expectedDataScope = user.role === 'super_admin' || user.role === 'admin' ? 'all' :
                                            user.role === 'department_manager' ? 'department' : 'personal';
                    
                    if (permissionParams.dataScope === expectedDataScope) {
                        apiLog.textContent += `âœ… æ•°æ®èŒƒå›´è®¾ç½®æ­£ç¡®ï¼š${expectedDataScope}\n`;
                        addTestResult('âœ… APIæƒé™å‚æ•°è®¾ç½®æ­£ç¡®', 'success');
                    } else {
                        apiLog.textContent += `âŒ æ•°æ®èŒƒå›´è®¾ç½®é”™è¯¯ï¼šæœŸæœ›${expectedDataScope}ï¼Œå®é™…${permissionParams.dataScope}\n`;
                        addTestResult('âŒ APIæƒé™å‚æ•°è®¾ç½®é”™è¯¯', 'error');
                    }
                }
                
            } catch (error) {
                apiLog.textContent += `âŒ APIæµ‹è¯•å¤±è´¥ï¼š${error.message}\n`;
                addTestResult('âŒ APIæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message, type) {
            testResults.push({ message, type, timestamp: new Date().toLocaleTimeString() });
            updateTestResults();
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            
            if (testResults.length === 0) {
                resultsDiv.innerHTML = '<div class="status loading">ç­‰å¾…æµ‹è¯•...</div>';
                return;
            }

            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            
            let html = `<div class="status ${errorCount > 0 ? 'error' : 'success'}">
                æµ‹è¯•å®Œæˆï¼š${successCount} ä¸ªé€šè¿‡ï¼Œ${errorCount} ä¸ªå¤±è´¥
            </div><br>`;
            
            html += testResults.map(result => `
                <div class="status ${result.type}">
                    [${result.timestamp}] ${result.message}
                </div>
            `).join('<br>');
            
            resultsDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('ğŸ“‹ æƒé™æ§åˆ¶æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            addTestResult('ğŸ’¡ è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹æµ‹è¯•', 'loading');
        });
    </script>
</body>
</html>