<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户新增流程测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .data { background: #f5f5f5; padding: 10px; border-radius: 3px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .test-form { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .test-form input { margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>客户新增流程测试工具</h1>
    
    <div class="section">
        <h2>步骤1: 检查初始状态</h2>
        <button onclick="checkInitialState()">检查localStorage和Store状态</button>
        <div id="initial-state-result"></div>
    </div>
    
    <div class="section">
        <h2>步骤2: 模拟新增客户</h2>
        <div class="test-form">
            <input type="text" id="customer-name" placeholder="客户姓名" value="测试客户">
            <input type="text" id="customer-phone" placeholder="手机号" value="">
            <input type="number" id="customer-age" placeholder="年龄" value="30">
            <input type="text" id="customer-address" placeholder="地址" value="测试地址">
            <br>
            <button onclick="simulateAddCustomer()">模拟新增客户</button>
        </div>
        <div id="add-customer-result"></div>
    </div>
    
    <div class="section">
        <h2>步骤3: 验证数据保存</h2>
        <button onclick="verifyDataSaved()">验证数据是否正确保存</button>
        <div id="verify-save-result"></div>
    </div>
    
    <div class="section">
        <h2>步骤4: 模拟页面刷新</h2>
        <button onclick="simulatePageRefresh()">模拟页面刷新和数据加载</button>
        <div id="refresh-result"></div>
    </div>
    
    <div class="section">
        <h2>步骤5: 完整流程测试</h2>
        <button onclick="runCompleteTest()">运行完整流程测试</button>
        <button onclick="testDataMerge()" style="background: #28a745; color: white; padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer;">🔧 测试数据合并修复</button>
        <div id="complete-test-result"></div>
    </div>
    
    <div class="section">
        <h2>调试工具</h2>
        <button onclick="clearAllData()">清除所有数据</button>
        <button onclick="showAllStorageKeys()">显示所有存储键</button>
        <button onclick="openCustomerList()">打开客户列表页面</button>
        <button onclick="openAddCustomer()">打开新增客户页面</button>
        <div id="debug-result"></div>
    </div>

    <script>
        // 生成随机手机号
        function generateRandomPhone() {
            return '138' + String(Math.floor(Math.random() * 100000000)).padStart(8, '0');
        }
        
        // 设置随机手机号
        document.getElementById('customer-phone').value = generateRandomPhone();
        
        function logStep(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return `<div class="result ${type}">${message}</div>`;
        }
        
        function checkInitialState() {
            const result = document.getElementById('initial-state-result');
            let output = '';
            
            try {
                // 检查localStorage中的所有客户相关数据
                const keys = [
                    'crm_customers_unified',
                    'crm_store_customer', 
                    'crm_customers', 
                    'customers', 
                    'customer_data', 
                    'mock_customers'
                ];
                
                output += logStep('开始检查初始状态...');
                
                let totalCustomers = 0;
                keys.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (Array.isArray(parsed)) {
                                output += logStep(`${key}: 找到 ${parsed.length} 个客户`);
                                totalCustomers += parsed.length;
                            } else if (parsed.customers && Array.isArray(parsed.customers)) {
                                output += logStep(`${key}: 找到 ${parsed.customers.length} 个客户 (版本: ${parsed.version || 'unknown'})`);
                                totalCustomers += parsed.customers.length;
                            }
                        } catch (e) {
                            output += logStep(`${key}: 数据解析错误 - ${e.message}`, 'error');
                        }
                    } else {
                        output += logStep(`${key}: 无数据`);
                    }
                });
                
                output += logStep(`总计发现 ${totalCustomers} 个客户`, totalCustomers > 0 ? 'success' : 'warning');
                
            } catch (error) {
                output += logStep(`检查初始状态失败: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        function simulateAddCustomer() {
            const result = document.getElementById('add-customer-result');
            let output = '';
            
            try {
                const name = document.getElementById('customer-name').value;
                const phone = document.getElementById('customer-phone').value;
                const age = parseInt(document.getElementById('customer-age').value);
                const address = document.getElementById('customer-address').value;
                
                if (!name || !phone) {
                    output += logStep('请填写客户姓名和手机号', 'error');
                    result.innerHTML = output;
                    return;
                }
                
                output += logStep('开始模拟新增客户...');
                output += logStep(`客户信息: ${name}, ${phone}, ${age}岁, ${address}`);
                
                // 创建新客户对象
                const newCustomer = {
                    id: 'test_' + Date.now(),
                    code: 'TEST' + Date.now(),
                    name: name,
                    phone: phone,
                    age: age,
                    address: address,
                    level: 'normal',
                    status: 'active',
                    salesPersonId: 'admin',
                    orderCount: 0,
                    createTime: new Date().toISOString(),
                    createdBy: 'admin',
                    creatorName: '管理员'
                };
                
                output += logStep('创建客户对象成功');
                
                // 模拟customerStorage.addCustomer的逻辑
                const storageKey = 'crm_customers_unified';
                let existingData = localStorage.getItem(storageKey);
                let customers = [];
                
                if (existingData) {
                    try {
                        const parsed = JSON.parse(existingData);
                        customers = parsed.customers || [];
                        output += logStep(`读取现有数据: ${customers.length} 个客户`);
                    } catch (e) {
                        output += logStep(`解析现有数据失败: ${e.message}`, 'warning');
                        customers = [];
                    }
                } else {
                    output += logStep('未找到现有数据，创建新的客户列表');
                }
                
                // 检查手机号是否已存在
                const existingCustomer = customers.find(c => c.phone === phone);
                if (existingCustomer) {
                    output += logStep(`手机号 ${phone} 已存在，客户: ${existingCustomer.name}`, 'error');
                    result.innerHTML = output;
                    return;
                }
                
                // 添加新客户到列表开头
                customers.unshift(newCustomer);
                output += logStep('将新客户添加到列表开头');
                
                // 保存到localStorage
                const newData = {
                    customers: customers,
                    lastUpdated: Date.now(),
                    version: '1.0.0'
                };
                
                localStorage.setItem(storageKey, JSON.stringify(newData));
                output += logStep(`保存到localStorage成功，总客户数: ${customers.length}`, 'success');
                
                // 显示新客户信息
                output += logStep('新增客户详情:', 'info');
                output += `<div class="data">${JSON.stringify(newCustomer, null, 2)}</div>`;
                
            } catch (error) {
                output += logStep(`模拟新增客户失败: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        function verifyDataSaved() {
            const result = document.getElementById('verify-save-result');
            let output = '';
            
            try {
                output += logStep('开始验证数据保存...');
                
                const storageKey = 'crm_customers_unified';
                const data = localStorage.getItem(storageKey);
                
                if (!data) {
                    output += logStep('未找到统一存储数据', 'error');
                    result.innerHTML = output;
                    return;
                }
                
                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];
                
                output += logStep(`验证成功: 找到 ${customers.length} 个客户`, 'success');
                output += logStep(`最后更新时间: ${new Date(parsed.lastUpdated).toLocaleString()}`);
                output += logStep(`数据版本: ${parsed.version}`);
                
                if (customers.length > 0) {
                    const latestCustomer = customers[0];
                    output += logStep('最新客户信息:', 'info');
                    output += `<div class="data">${JSON.stringify(latestCustomer, null, 2)}</div>`;
                }
                
            } catch (error) {
                output += logStep(`验证数据保存失败: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        function simulatePageRefresh() {
            const result = document.getElementById('refresh-result');
            let output = '';
            
            try {
                output += logStep('模拟页面刷新和数据加载...');
                
                // 模拟自动持久化数据加载（替代已删除的initializeFromStorage方法）
                const storageKey = 'crm_customers_unified';
                const data = localStorage.getItem(storageKey);
                
                if (!data) {
                    output += logStep('页面刷新后未找到数据', 'error');
                    result.innerHTML = output;
                    return;
                }
                
                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];
                
                output += logStep(`页面刷新后成功加载 ${customers.length} 个客户`, 'success');
                
                // 模拟权限过滤（当前是临时修复，直接返回所有客户）
                const filteredCustomers = customers; // 临时修复逻辑
                output += logStep(`权限过滤后: ${filteredCustomers.length} 个客户可见`, 'success');
                
                // 模拟搜索和分页
                const searchResults = filteredCustomers; // 无搜索条件
                const pageSize = 10;
                const currentPage = 1;
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageResults = searchResults.slice(start, end);
                
                output += logStep(`分页结果: 第${currentPage}页，显示 ${pageResults.length} 个客户`, 'success');
                
                if (pageResults.length > 0) {
                    output += logStep('页面显示的客户列表:', 'info');
                    pageResults.forEach((customer, index) => {
                        output += logStep(`${index + 1}. ${customer.name} (${customer.phone}) - ${customer.createTime}`);
                    });
                }
                
            } catch (error) {
                output += logStep(`模拟页面刷新失败: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        async function runCompleteTest() {
            const resultDiv = document.getElementById('complete-test-result');
            resultDiv.innerHTML = '<p>🔄 运行完整流程测试...</p>';
            
            try {
                // 1. 清除数据
                await clearAllData();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 2. 检查初始状态
                await checkInitialState();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. 模拟新增客户
                await simulateAddCustomer();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 4. 验证数据保存
                await verifyDataSaved();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 5. 模拟页面刷新
                await simulatePageRefresh();
                
                resultDiv.innerHTML += '<p>✅ 完整流程测试完成！</p>';
            } catch (error) {
                resultDiv.innerHTML += `<p>❌ 测试失败: ${error.message}</p>`;
            }
        }

        async function testDataMerge() {
            const resultDiv = document.getElementById('complete-test-result');
            resultDiv.innerHTML = '<p>🔧 测试数据合并修复...</p>';
            
            try {
                // 1. 添加测试客户到本地存储
                const testCustomer = {
                    id: `test_merge_${Date.now()}`,
                    code: `TEST${Date.now()}`,
                    name: '数据合并测试客户',
                    phone: `1380013${String(Date.now()).slice(-4)}`,
                    age: 25,
                    address: '测试地址',
                    level: 'normal',
                    status: 'active',
                    salesPersonId: 'admin',
                    orderCount: 0,
                    createTime: new Date().toISOString(),
                    createdBy: 'admin'
                };
                
                // 直接保存到统一存储（使用正确的存储键）
                const storageKey = 'crm_customers_unified';
                const existingData = localStorage.getItem(storageKey);
                let storageData;
                
                if (existingData) {
                    storageData = JSON.parse(existingData);
                    // 检查是否是新的数据结构
                    if (storageData.customers && Array.isArray(storageData.customers)) {
                        storageData.customers.unshift(testCustomer);
                        storageData.lastUpdated = Date.now();
                    } else {
                        // 兼容旧的数据结构
                        storageData = {
                            customers: [testCustomer, ...(Array.isArray(storageData) ? storageData : [])],
                            lastUpdated: Date.now(),
                            version: '1.0.0'
                        };
                    }
                } else {
                    // 创建新的数据结构
                    storageData = {
                        customers: [testCustomer],
                        lastUpdated: Date.now(),
                        version: '1.0.0'
                    };
                }
                
                localStorage.setItem(storageKey, JSON.stringify(storageData));
                
                resultDiv.innerHTML += `<p>✅ 已添加测试客户到本地存储: ${testCustomer.name}</p>`;
                
                // 2. 模拟调用 forceRefreshCustomers
                resultDiv.innerHTML += '<p>🔄 模拟调用 forceRefreshCustomers...</p>';
                
                // 等待一下让数据生效
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. 检查客户是否仍然存在
                const finalDataStr = localStorage.getItem(storageKey);
                let finalCustomers = [];
                
                if (finalDataStr) {
                    const finalData = JSON.parse(finalDataStr);
                    if (finalData.customers && Array.isArray(finalData.customers)) {
                        finalCustomers = finalData.customers;
                    } else if (Array.isArray(finalData)) {
                        finalCustomers = finalData;
                    }
                }
                
                const testCustomerExists = finalCustomers.some(c => c.id === testCustomer.id);
                
                if (testCustomerExists) {
                    resultDiv.innerHTML += '<p>✅ 数据合并修复成功！测试客户在刷新后仍然存在</p>';
                } else {
                    resultDiv.innerHTML += '<p>❌ 数据合并修复失败！测试客户在刷新后消失了</p>';
                }
                
                // 4. 显示当前所有客户
                resultDiv.innerHTML += `<p>📊 当前存储中的客户数量: ${finalCustomers.length}</p>`;
                resultDiv.innerHTML += '<p>客户列表:</p>';
                finalCustomers.forEach((customer, index) => {
                    resultDiv.innerHTML += `<p>${index + 1}. ${customer.name} (${customer.phone})</p>`;
                });
                
            } catch (error) {
                resultDiv.innerHTML += `<p>❌ 测试失败: ${error.message}</p>`;
            }
        }
        
        function clearAllData() {
            const keys = [
                'crm_customers_unified',
                'crm_store_customer', 
                'crm_customers', 
                'customers', 
                'customer_data', 
                'mock_customers'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            document.getElementById('debug-result').innerHTML = 
                logStep('已清除所有客户数据', 'success');
        }
        
        function showAllStorageKeys() {
            let output = '';
            output += logStep('localStorage中的所有键:', 'info');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = new Blob([value]).size;
                output += logStep(`${key}: ${size} bytes`);
            }
            
            document.getElementById('debug-result').innerHTML = output;
        }
        
        function openCustomerList() {
            window.open('http://localhost:5173/customer/list', '_blank');
        }
        
        function openAddCustomer() {
            window.open('http://localhost:5173/customer/add', '_blank');
        }
        
        // 页面加载时自动检查初始状态
        window.onload = function() {
            checkInitialState();
        };
    </script>
</body>
</html>