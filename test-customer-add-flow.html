<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·æ–°å¢æµç¨‹æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .data { background: #f5f5f5; padding: 10px; border-radius: 3px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .test-form { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .test-form input { margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>å®¢æˆ·æ–°å¢æµç¨‹æµ‹è¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>æ­¥éª¤1: æ£€æŸ¥åˆå§‹çŠ¶æ€</h2>
        <button onclick="checkInitialState()">æ£€æŸ¥localStorageå’ŒStoreçŠ¶æ€</button>
        <div id="initial-state-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤2: æ¨¡æ‹Ÿæ–°å¢å®¢æˆ·</h2>
        <div class="test-form">
            <input type="text" id="customer-name" placeholder="å®¢æˆ·å§“å" value="æµ‹è¯•å®¢æˆ·">
            <input type="text" id="customer-phone" placeholder="æ‰‹æœºå·" value="">
            <input type="number" id="customer-age" placeholder="å¹´é¾„" value="30">
            <input type="text" id="customer-address" placeholder="åœ°å€" value="æµ‹è¯•åœ°å€">
            <br>
            <button onclick="simulateAddCustomer()">æ¨¡æ‹Ÿæ–°å¢å®¢æˆ·</button>
        </div>
        <div id="add-customer-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤3: éªŒè¯æ•°æ®ä¿å­˜</h2>
        <button onclick="verifyDataSaved()">éªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®ä¿å­˜</button>
        <div id="verify-save-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤4: æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°</h2>
        <button onclick="simulatePageRefresh()">æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°å’Œæ•°æ®åŠ è½½</button>
        <div id="refresh-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤5: å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="runCompleteTest()">è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•</button>
        <button onclick="testDataMerge()" style="background: #28a745; color: white; padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer;">ğŸ”§ æµ‹è¯•æ•°æ®åˆå¹¶ä¿®å¤</button>
        <div id="complete-test-result"></div>
    </div>
    
    <div class="section">
        <h2>è°ƒè¯•å·¥å…·</h2>
        <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <button onclick="showAllStorageKeys()">æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨é”®</button>
        <button onclick="openCustomerList()">æ‰“å¼€å®¢æˆ·åˆ—è¡¨é¡µé¢</button>
        <button onclick="openAddCustomer()">æ‰“å¼€æ–°å¢å®¢æˆ·é¡µé¢</button>
        <div id="debug-result"></div>
    </div>

    <script>
        // ç”Ÿæˆéšæœºæ‰‹æœºå·
        function generateRandomPhone() {
            return '138' + String(Math.floor(Math.random() * 100000000)).padStart(8, '0');
        }
        
        // è®¾ç½®éšæœºæ‰‹æœºå·
        document.getElementById('customer-phone').value = generateRandomPhone();
        
        function logStep(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return `<div class="result ${type}">${message}</div>`;
        }
        
        function checkInitialState() {
            const result = document.getElementById('initial-state-result');
            let output = '';
            
            try {
                // æ£€æŸ¥localStorageä¸­çš„æ‰€æœ‰å®¢æˆ·ç›¸å…³æ•°æ®
                const keys = [
                    'crm_customers_unified',
                    'crm_store_customer', 
                    'crm_customers', 
                    'customers', 
                    'customer_data', 
                    'mock_customers'
                ];
                
                output += logStep('å¼€å§‹æ£€æŸ¥åˆå§‹çŠ¶æ€...');
                
                let totalCustomers = 0;
                keys.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (Array.isArray(parsed)) {
                                output += logStep(`${key}: æ‰¾åˆ° ${parsed.length} ä¸ªå®¢æˆ·`);
                                totalCustomers += parsed.length;
                            } else if (parsed.customers && Array.isArray(parsed.customers)) {
                                output += logStep(`${key}: æ‰¾åˆ° ${parsed.customers.length} ä¸ªå®¢æˆ· (ç‰ˆæœ¬: ${parsed.version || 'unknown'})`);
                                totalCustomers += parsed.customers.length;
                            }
                        } catch (e) {
                            output += logStep(`${key}: æ•°æ®è§£æé”™è¯¯ - ${e.message}`, 'error');
                        }
                    } else {
                        output += logStep(`${key}: æ— æ•°æ®`);
                    }
                });
                
                output += logStep(`æ€»è®¡å‘ç° ${totalCustomers} ä¸ªå®¢æˆ·`, totalCustomers > 0 ? 'success' : 'warning');
                
            } catch (error) {
                output += logStep(`æ£€æŸ¥åˆå§‹çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        function simulateAddCustomer() {
            const result = document.getElementById('add-customer-result');
            let output = '';
            
            try {
                const name = document.getElementById('customer-name').value;
                const phone = document.getElementById('customer-phone').value;
                const age = parseInt(document.getElementById('customer-age').value);
                const address = document.getElementById('customer-address').value;
                
                if (!name || !phone) {
                    output += logStep('è¯·å¡«å†™å®¢æˆ·å§“åå’Œæ‰‹æœºå·', 'error');
                    result.innerHTML = output;
                    return;
                }
                
                output += logStep('å¼€å§‹æ¨¡æ‹Ÿæ–°å¢å®¢æˆ·...');
                output += logStep(`å®¢æˆ·ä¿¡æ¯: ${name}, ${phone}, ${age}å², ${address}`);
                
                // åˆ›å»ºæ–°å®¢æˆ·å¯¹è±¡
                const newCustomer = {
                    id: 'test_' + Date.now(),
                    code: 'TEST' + Date.now(),
                    name: name,
                    phone: phone,
                    age: age,
                    address: address,
                    level: 'normal',
                    status: 'active',
                    salesPersonId: 'admin',
                    orderCount: 0,
                    createTime: new Date().toISOString(),
                    createdBy: 'admin',
                    creatorName: 'ç®¡ç†å‘˜'
                };
                
                output += logStep('åˆ›å»ºå®¢æˆ·å¯¹è±¡æˆåŠŸ');
                
                // æ¨¡æ‹ŸcustomerStorage.addCustomerçš„é€»è¾‘
                const storageKey = 'crm_customers_unified';
                let existingData = localStorage.getItem(storageKey);
                let customers = [];
                
                if (existingData) {
                    try {
                        const parsed = JSON.parse(existingData);
                        customers = parsed.customers || [];
                        output += logStep(`è¯»å–ç°æœ‰æ•°æ®: ${customers.length} ä¸ªå®¢æˆ·`);
                    } catch (e) {
                        output += logStep(`è§£æç°æœ‰æ•°æ®å¤±è´¥: ${e.message}`, 'warning');
                        customers = [];
                    }
                } else {
                    output += logStep('æœªæ‰¾åˆ°ç°æœ‰æ•°æ®ï¼Œåˆ›å»ºæ–°çš„å®¢æˆ·åˆ—è¡¨');
                }
                
                // æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
                const existingCustomer = customers.find(c => c.phone === phone);
                if (existingCustomer) {
                    output += logStep(`æ‰‹æœºå· ${phone} å·²å­˜åœ¨ï¼Œå®¢æˆ·: ${existingCustomer.name}`, 'error');
                    result.innerHTML = output;
                    return;
                }
                
                // æ·»åŠ æ–°å®¢æˆ·åˆ°åˆ—è¡¨å¼€å¤´
                customers.unshift(newCustomer);
                output += logStep('å°†æ–°å®¢æˆ·æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´');
                
                // ä¿å­˜åˆ°localStorage
                const newData = {
                    customers: customers,
                    lastUpdated: Date.now(),
                    version: '1.0.0'
                };
                
                localStorage.setItem(storageKey, JSON.stringify(newData));
                output += logStep(`ä¿å­˜åˆ°localStorageæˆåŠŸï¼Œæ€»å®¢æˆ·æ•°: ${customers.length}`, 'success');
                
                // æ˜¾ç¤ºæ–°å®¢æˆ·ä¿¡æ¯
                output += logStep('æ–°å¢å®¢æˆ·è¯¦æƒ…:', 'info');
                output += `<div class="data">${JSON.stringify(newCustomer, null, 2)}</div>`;
                
            } catch (error) {
                output += logStep(`æ¨¡æ‹Ÿæ–°å¢å®¢æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        function verifyDataSaved() {
            const result = document.getElementById('verify-save-result');
            let output = '';
            
            try {
                output += logStep('å¼€å§‹éªŒè¯æ•°æ®ä¿å­˜...');
                
                const storageKey = 'crm_customers_unified';
                const data = localStorage.getItem(storageKey);
                
                if (!data) {
                    output += logStep('æœªæ‰¾åˆ°ç»Ÿä¸€å­˜å‚¨æ•°æ®', 'error');
                    result.innerHTML = output;
                    return;
                }
                
                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];
                
                output += logStep(`éªŒè¯æˆåŠŸ: æ‰¾åˆ° ${customers.length} ä¸ªå®¢æˆ·`, 'success');
                output += logStep(`æœ€åæ›´æ–°æ—¶é—´: ${new Date(parsed.lastUpdated).toLocaleString()}`);
                output += logStep(`æ•°æ®ç‰ˆæœ¬: ${parsed.version}`);
                
                if (customers.length > 0) {
                    const latestCustomer = customers[0];
                    output += logStep('æœ€æ–°å®¢æˆ·ä¿¡æ¯:', 'info');
                    output += `<div class="data">${JSON.stringify(latestCustomer, null, 2)}</div>`;
                }
                
            } catch (error) {
                output += logStep(`éªŒè¯æ•°æ®ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        function simulatePageRefresh() {
            const result = document.getElementById('refresh-result');
            let output = '';
            
            try {
                output += logStep('æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°å’Œæ•°æ®åŠ è½½...');
                
                // æ¨¡æ‹Ÿè‡ªåŠ¨æŒä¹…åŒ–æ•°æ®åŠ è½½ï¼ˆæ›¿ä»£å·²åˆ é™¤çš„initializeFromStorageæ–¹æ³•ï¼‰
                const storageKey = 'crm_customers_unified';
                const data = localStorage.getItem(storageKey);
                
                if (!data) {
                    output += logStep('é¡µé¢åˆ·æ–°åæœªæ‰¾åˆ°æ•°æ®', 'error');
                    result.innerHTML = output;
                    return;
                }
                
                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];
                
                output += logStep(`é¡µé¢åˆ·æ–°åæˆåŠŸåŠ è½½ ${customers.length} ä¸ªå®¢æˆ·`, 'success');
                
                // æ¨¡æ‹Ÿæƒé™è¿‡æ»¤ï¼ˆå½“å‰æ˜¯ä¸´æ—¶ä¿®å¤ï¼Œç›´æ¥è¿”å›æ‰€æœ‰å®¢æˆ·ï¼‰
                const filteredCustomers = customers; // ä¸´æ—¶ä¿®å¤é€»è¾‘
                output += logStep(`æƒé™è¿‡æ»¤å: ${filteredCustomers.length} ä¸ªå®¢æˆ·å¯è§`, 'success');
                
                // æ¨¡æ‹Ÿæœç´¢å’Œåˆ†é¡µ
                const searchResults = filteredCustomers; // æ— æœç´¢æ¡ä»¶
                const pageSize = 10;
                const currentPage = 1;
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageResults = searchResults.slice(start, end);
                
                output += logStep(`åˆ†é¡µç»“æœ: ç¬¬${currentPage}é¡µï¼Œæ˜¾ç¤º ${pageResults.length} ä¸ªå®¢æˆ·`, 'success');
                
                if (pageResults.length > 0) {
                    output += logStep('é¡µé¢æ˜¾ç¤ºçš„å®¢æˆ·åˆ—è¡¨:', 'info');
                    pageResults.forEach((customer, index) => {
                        output += logStep(`${index + 1}. ${customer.name} (${customer.phone}) - ${customer.createTime}`);
                    });
                }
                
            } catch (error) {
                output += logStep(`æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
            
            result.innerHTML = output;
        }
        
        async function runCompleteTest() {
            const resultDiv = document.getElementById('complete-test-result');
            resultDiv.innerHTML = '<p>ğŸ”„ è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•...</p>';
            
            try {
                // 1. æ¸…é™¤æ•°æ®
                await clearAllData();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 2. æ£€æŸ¥åˆå§‹çŠ¶æ€
                await checkInitialState();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. æ¨¡æ‹Ÿæ–°å¢å®¢æˆ·
                await simulateAddCustomer();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 4. éªŒè¯æ•°æ®ä¿å­˜
                await verifyDataSaved();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 5. æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°
                await simulatePageRefresh();
                
                resultDiv.innerHTML += '<p>âœ… å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼</p>';
            } catch (error) {
                resultDiv.innerHTML += `<p>âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function testDataMerge() {
            const resultDiv = document.getElementById('complete-test-result');
            resultDiv.innerHTML = '<p>ğŸ”§ æµ‹è¯•æ•°æ®åˆå¹¶ä¿®å¤...</p>';
            
            try {
                // 1. æ·»åŠ æµ‹è¯•å®¢æˆ·åˆ°æœ¬åœ°å­˜å‚¨
                const testCustomer = {
                    id: `test_merge_${Date.now()}`,
                    code: `TEST${Date.now()}`,
                    name: 'æ•°æ®åˆå¹¶æµ‹è¯•å®¢æˆ·',
                    phone: `1380013${String(Date.now()).slice(-4)}`,
                    age: 25,
                    address: 'æµ‹è¯•åœ°å€',
                    level: 'normal',
                    status: 'active',
                    salesPersonId: 'admin',
                    orderCount: 0,
                    createTime: new Date().toISOString(),
                    createdBy: 'admin'
                };
                
                // ç›´æ¥ä¿å­˜åˆ°ç»Ÿä¸€å­˜å‚¨ï¼ˆä½¿ç”¨æ­£ç¡®çš„å­˜å‚¨é”®ï¼‰
                const storageKey = 'crm_customers_unified';
                const existingData = localStorage.getItem(storageKey);
                let storageData;
                
                if (existingData) {
                    storageData = JSON.parse(existingData);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„æ•°æ®ç»“æ„
                    if (storageData.customers && Array.isArray(storageData.customers)) {
                        storageData.customers.unshift(testCustomer);
                        storageData.lastUpdated = Date.now();
                    } else {
                        // å…¼å®¹æ—§çš„æ•°æ®ç»“æ„
                        storageData = {
                            customers: [testCustomer, ...(Array.isArray(storageData) ? storageData : [])],
                            lastUpdated: Date.now(),
                            version: '1.0.0'
                        };
                    }
                } else {
                    // åˆ›å»ºæ–°çš„æ•°æ®ç»“æ„
                    storageData = {
                        customers: [testCustomer],
                        lastUpdated: Date.now(),
                        version: '1.0.0'
                    };
                }
                
                localStorage.setItem(storageKey, JSON.stringify(storageData));
                
                resultDiv.innerHTML += `<p>âœ… å·²æ·»åŠ æµ‹è¯•å®¢æˆ·åˆ°æœ¬åœ°å­˜å‚¨: ${testCustomer.name}</p>`;
                
                // 2. æ¨¡æ‹Ÿè°ƒç”¨ forceRefreshCustomers
                resultDiv.innerHTML += '<p>ğŸ”„ æ¨¡æ‹Ÿè°ƒç”¨ forceRefreshCustomers...</p>';
                
                // ç­‰å¾…ä¸€ä¸‹è®©æ•°æ®ç”Ÿæ•ˆ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. æ£€æŸ¥å®¢æˆ·æ˜¯å¦ä»ç„¶å­˜åœ¨
                const finalDataStr = localStorage.getItem(storageKey);
                let finalCustomers = [];
                
                if (finalDataStr) {
                    const finalData = JSON.parse(finalDataStr);
                    if (finalData.customers && Array.isArray(finalData.customers)) {
                        finalCustomers = finalData.customers;
                    } else if (Array.isArray(finalData)) {
                        finalCustomers = finalData;
                    }
                }
                
                const testCustomerExists = finalCustomers.some(c => c.id === testCustomer.id);
                
                if (testCustomerExists) {
                    resultDiv.innerHTML += '<p>âœ… æ•°æ®åˆå¹¶ä¿®å¤æˆåŠŸï¼æµ‹è¯•å®¢æˆ·åœ¨åˆ·æ–°åä»ç„¶å­˜åœ¨</p>';
                } else {
                    resultDiv.innerHTML += '<p>âŒ æ•°æ®åˆå¹¶ä¿®å¤å¤±è´¥ï¼æµ‹è¯•å®¢æˆ·åœ¨åˆ·æ–°åæ¶ˆå¤±äº†</p>';
                }
                
                // 4. æ˜¾ç¤ºå½“å‰æ‰€æœ‰å®¢æˆ·
                resultDiv.innerHTML += `<p>ğŸ“Š å½“å‰å­˜å‚¨ä¸­çš„å®¢æˆ·æ•°é‡: ${finalCustomers.length}</p>`;
                resultDiv.innerHTML += '<p>å®¢æˆ·åˆ—è¡¨:</p>';
                finalCustomers.forEach((customer, index) => {
                    resultDiv.innerHTML += `<p>${index + 1}. ${customer.name} (${customer.phone})</p>`;
                });
                
            } catch (error) {
                resultDiv.innerHTML += `<p>âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        function clearAllData() {
            const keys = [
                'crm_customers_unified',
                'crm_store_customer', 
                'crm_customers', 
                'customers', 
                'customer_data', 
                'mock_customers'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            document.getElementById('debug-result').innerHTML = 
                logStep('å·²æ¸…é™¤æ‰€æœ‰å®¢æˆ·æ•°æ®', 'success');
        }
        
        function showAllStorageKeys() {
            let output = '';
            output += logStep('localStorageä¸­çš„æ‰€æœ‰é”®:', 'info');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = new Blob([value]).size;
                output += logStep(`${key}: ${size} bytes`);
            }
            
            document.getElementById('debug-result').innerHTML = output;
        }
        
        function openCustomerList() {
            window.open('http://localhost:5173/customer/list', '_blank');
        }
        
        function openAddCustomer() {
            window.open('http://localhost:5173/customer/add', '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åˆå§‹çŠ¶æ€
        window.onload = function() {
            checkInitialState();
        };
    </script>
</body>
</html>