#!/bin/bash

# ========================================
# CRM ç³»ç»ŸæœåŠ¡å™¨éƒ¨ç½²è„šæœ¬ï¼ˆä»…åç«¯ï¼‰
# é€‚ç”¨äºï¼šæœ¬åœ°å·²æ„å»ºå¥½å‰ç«¯ï¼Œåªåœ¨æœåŠ¡å™¨éƒ¨ç½²åç«¯
# ========================================

echo "=========================================="
echo "ğŸš€ CRM ç³»ç»ŸæœåŠ¡å™¨éƒ¨ç½²ï¼ˆä»…åç«¯ï¼‰"
echo "=========================================="

# é¡¹ç›®ç›®å½•
PROJECT_DIR="/www/wwwroot/abc789.cn"

# æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
if [ ! -d "$PROJECT_DIR" ]; then
    echo "âŒ é”™è¯¯ï¼šé¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
    exit 1
fi

cd $PROJECT_DIR

echo ""
echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
echo ""

# ========================================
# æ­¥éª¤ 1ï¼šæ£€æŸ¥ dist ç›®å½•
# ========================================
echo "æ­¥éª¤ 1/4: æ£€æŸ¥å‰ç«¯æ„å»ºæ–‡ä»¶..."

if [ ! -d "dist" ]; then
    echo "âŒ é”™è¯¯ï¼šdist ç›®å½•ä¸å­˜åœ¨ï¼"
    echo "ğŸ’¡ è¯·å…ˆåœ¨æœ¬åœ°æ„å»ºå‰ç«¯ï¼Œç„¶åä¸Šä¼  dist æ–‡ä»¶å¤¹"
    exit 1
fi

if [ ! -f "dist/index.html" ]; then
    echo "âŒ é”™è¯¯ï¼šdist/index.html ä¸å­˜åœ¨ï¼"
    echo "ğŸ’¡ è¯·ç¡®ä¿ dist æ–‡ä»¶å¤¹åŒ…å«å®Œæ•´çš„æ„å»ºæ–‡ä»¶"
    exit 1
fi

echo "âœ… å‰ç«¯æ„å»ºæ–‡ä»¶æ£€æŸ¥é€šè¿‡"

# ========================================
# æ­¥éª¤ 2ï¼šé…ç½® npm é•œåƒ
# ========================================
echo ""
echo "æ­¥éª¤ 2/4: é…ç½® npm é•œåƒ..."
npm config set registry https://registry.npmmirror.com
echo "âœ… npm é•œåƒé…ç½®å®Œæˆ"

# ========================================
# æ­¥éª¤ 3ï¼šå®‰è£…åç«¯ä¾èµ–
# ========================================
echo ""
echo "æ­¥éª¤ 3/4: å®‰è£…åç«¯ä¾èµ–..."

cd backend

# æ£€æŸ¥ .env æ–‡ä»¶
if [ ! -f ".env" ]; then
    echo "âš ï¸  è­¦å‘Šï¼šbackend/.env æ–‡ä»¶ä¸å­˜åœ¨"
    if [ -f ".env.example" ]; then
        echo "ğŸ“ ä» .env.example åˆ›å»º .env æ–‡ä»¶..."
        cp .env.example .env
        echo "âš ï¸  è¯·ç¼–è¾‘ backend/.env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“ä¿¡æ¯ï¼"
    fi
fi

# å®‰è£…ä¾èµ–ï¼ˆä»…ç”Ÿäº§ç¯å¢ƒä¾èµ–ï¼ŒèŠ‚çœç©ºé—´å’Œæ—¶é—´ï¼‰
echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–ï¼ˆä»…ç”Ÿäº§ç¯å¢ƒï¼‰..."
npm install --production

if [ $? -ne 0 ]; then
    echo "âŒ åç«¯ä¾èµ–å®‰è£…å¤±è´¥ï¼"
    exit 1
fi

echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

# ========================================
# æ­¥éª¤ 4ï¼šå¯åŠ¨åç«¯æœåŠ¡
# ========================================
echo ""
echo "æ­¥éª¤ 4/4: å¯åŠ¨åç«¯æœåŠ¡..."

# æ£€æŸ¥ PM2 æ˜¯å¦å·²å®‰è£…
if ! command -v pm2 &> /dev/null; then
    echo "ğŸ“¦ å®‰è£… PM2..."
    npm install -g pm2
fi

# åœæ­¢æ—§æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
pm2 stop crm-backend 2>/dev/null || true
pm2 delete crm-backend 2>/dev/null || true

# å¯åŠ¨æ–°æœåŠ¡
echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡..."
pm2 start npm --name "crm-backend" -- start

# ä¿å­˜ PM2 é…ç½®
pm2 save

# è®¾ç½® PM2 å¼€æœºè‡ªå¯
pm2 startup

echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"

# ========================================
# å®Œæˆ
# ========================================
echo ""
echo "=========================================="
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "=========================================="
echo ""
echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
pm2 list
echo ""
echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—ï¼š"
echo "  pm2 logs crm-backend"
echo ""
echo "ğŸ”„ é‡å¯æœåŠ¡ï¼š"
echo "  pm2 restart crm-backend"
echo ""
echo "ğŸ›‘ åœæ­¢æœåŠ¡ï¼š"
echo "  pm2 stop crm-backend"
echo ""
echo "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š"
echo "  1. é…ç½® Nginxï¼ˆå¦‚æœè¿˜æ²¡é…ç½®ï¼‰"
echo "  2. è®¿é—®ç½‘ç«™æµ‹è¯•åŠŸèƒ½"
echo "  3. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ— é”™è¯¯"
echo ""
