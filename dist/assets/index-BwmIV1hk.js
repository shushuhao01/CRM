const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/settings-CuxbDWOu.js","assets/elementPlus-Bmwh7Rh8.js","assets/vendor-D8Vxqhr-.js","assets/utils-ywHRn0uI.js","assets/settings-B8JH4JCn.css"])))=>i.map(i=>d[i]);
var zs=Object.defineProperty,Ns=Object.defineProperties;var Os=Object.getOwnPropertyDescriptors;var gs=Object.getOwnPropertySymbols;var Bs=Object.prototype.hasOwnProperty,Hs=Object.prototype.propertyIsEnumerable;var rs=(s,e,t)=>e in s?zs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,K=(s,e)=>{for(var t in e||(e={}))Bs.call(e,t)&&rs(s,t,e[t]);if(gs)for(var t of gs(e))Hs.call(e,t)&&rs(s,t,e[t]);return s},Je=(s,e)=>Ns(s,Os(e));var oe=(s,e,t)=>rs(s,typeof e!="symbol"?e+"":e,t);var D=(s,e,t)=>new Promise((r,u)=>{var l=k=>{try{h(t.next(k))}catch(S){u(S)}},p=k=>{try{h(t.throw(k))}catch(S){u(S)}},h=k=>k.done?r(k.value):Promise.resolve(k.value).then(l,p);h((t=t.apply(s,e)).next())});import{aw as Ss,r as A,e as W,az as as,l as ce,ag as y,m as V,Q as L,p as f,J as te,q as a,aA as Fs,M as F,T as z,I as Cs,O as n,S as R,aB as Gs,H as qs,U as o,u as M,w as we,a2 as Ge,P as Ze,aj as ls,ad as js,Z as Qe,c as Ee,F as ye,a9 as ke,R as De,Y as os,aC as As,aD as Ws,n as vs,as as Ys,aE as Js}from"./vendor-D8Vxqhr-.js";import{Q as Ks,r as ks,R as Xs,E as C,F as xe,l as Zs,i as ss,S as Qs,T as Ts,U as et,u as st,V as $s,m as tt,W as hs,b as es,f as at,w as ot,X as nt,M as rt,t as Ms,O as lt,Y as it,Z as dt,_ as ct,$ as ut}from"./elementPlus-Bmwh7Rh8.js";import{c as ms,_ as ve,a as mt,u as he,b as ds,s as ts,d as is,e as ge,f as ee,g as Is,h as pt,i as xs,j as ft,k as gt,l as vt,P as ht,p as _s,m as _t,n as yt,o as wt,r as bt}from"./settings-CuxbDWOu.js";import"./utils-ywHRn0uI.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))r(u);new MutationObserver(u=>{for(const l of u)if(l.type==="childList")for(const p of l.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&r(p)}).observe(document,{childList:!0,subtree:!0});function t(u){const l={};return u.integrity&&(l.integrity=u.integrity),u.referrerPolicy&&(l.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?l.credentials="include":u.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(u){if(u.ep)return;u.ep=!0;const l=t(u);fetch(u.href,l)}})();const Pt=Ss("tabs",()=>{const s=A([{name:"/dashboard",title:"数据看板",component:"Dashboard",closable:!1}]),e=A("/dashboard"),t=A(["Dashboard"]),r=W(()=>s.value.find(g=>g.name===e.value)),u=g=>{s.value.find(m=>m.name===g.name)||(s.value.push(Je(K({},g),{closable:g.name!=="/dashboard"})),g.component&&!t.value.includes(g.component)&&t.value.push(g.component)),e.value=g.name},l=g=>{const P=s.value.findIndex(w=>w.name===g);if(P===-1)return;const m=s.value[P];if(s.value.splice(P,1),m.component){const w=t.value.indexOf(m.component);w>-1&&t.value.splice(w,1)}if(e.value===g&&s.value.length>0){const w=s.value[P]||s.value[P-1];e.value=w.name}},p=g=>{const P=s.value.find(w=>w.name===g),m=s.value.find(w=>w.name==="/dashboard");t.value=[],m!=null&&m.component&&t.value.push(m.component),P!=null&&P.component&&P.component!==(m==null?void 0:m.component)&&t.value.push(P.component),s.value=s.value.filter(w=>w.name==="/dashboard"||w.name===g),e.value=g},h=()=>{s.value=s.value.filter(m=>m.name==="/dashboard"),t.value=["Dashboard"],e.value="/dashboard";const g=as();ms(g).push("/dashboard")};return{tabs:s,activeTab:e,cachedViews:t,currentTab:r,addTab:u,removeTab:l,removeOtherTabs:p,removeAllTabs:h,closeOtherTabs:g=>{p(g)},closeAllTabs:()=>{h()},clearTabs:()=>{s.value=[{name:"/dashboard",title:"数据看板",component:"Dashboard",closable:!1}],t.value=["Dashboard"],e.value="/dashboard"},setActiveTab:g=>{e.value=g},refreshTab:g=>{const P=s.value.find(m=>m.name===g);if(P!=null&&P.component){const m=t.value.indexOf(P.component);m>-1&&(t.value.splice(m,1),setTimeout(()=>{t.value.push(P.component)},0))}}}}),St={class:"loading-content"},Ct={key:0,class:"loading-text"},At={key:1,class:"loading-progress"},kt={class:"progress-container"},Tt={class:"progress-bar"},$t={class:"progress-text"},Mt=ce({__name:"GlobalLoading",props:{visible:{type:Boolean,default:!1},text:{default:"加载中..."},fullScreen:{type:Boolean,default:!0},size:{default:40},progress:{default:-1},showProgress:{type:Boolean,default:!1},showCancel:{type:Boolean,default:!1},cancelable:{type:Boolean,default:!1},onCancel:{}},emits:["cancel","backdropClick"],setup(s,{emit:e}){const t=s,r=e,u=()=>{t.cancelable&&r("backdropClick")},l=()=>{t.onCancel&&t.onCancel(),r("cancel")};return(p,h)=>{const k=y("el-button");return s.visible?(f(),V("div",{key:0,class:te(["global-loading",{"full-screen":s.fullScreen}])},[a("div",{class:"loading-backdrop",onClick:u}),a("div",St,[h[1]||(h[1]=Fs('<div class="loading-spinner" data-v-7e11a068><div class="spinner-container" data-v-7e11a068><div class="spinner-ring" data-v-7e11a068></div><div class="spinner-ring" data-v-7e11a068></div><div class="spinner-ring" data-v-7e11a068></div><div class="spinner-dots" data-v-7e11a068><div class="dot" data-v-7e11a068></div><div class="dot" data-v-7e11a068></div><div class="dot" data-v-7e11a068></div></div></div></div>',1)),s.text?(f(),V("div",Ct,z(s.text),1)):L("",!0),s.showProgress&&s.progress>=0?(f(),V("div",At,[a("div",kt,[a("div",Tt,[a("div",{class:"progress-fill",style:Cs({width:s.progress+"%"})},null,4)]),a("span",$t,z(s.progress)+"%",1)])])):L("",!0),s.showCancel&&s.onCancel?(f(),F(k,{key:2,onClick:l,size:"small",type:"text",class:"cancel-btn"},{default:n(()=>[...h[0]||(h[0]=[R(" 取消 ",-1)])]),_:1})):L("",!0)])],2)):L("",!0)}}}),It=ve(Mt,[["__scopeId","data-v-7e11a068"]]),xt={class:"error-boundary"},Dt={key:1,class:"error-content"},Rt={class:"error-icon"},Vt={class:"error-title"},Ut={class:"error-message"},Lt={class:"error-actions"},Et=ce({__name:"ErrorBoundary",props:{fallbackTitle:{default:"页面出现错误"},fallbackMessage:{default:"抱歉，页面遇到了一些问题，请稍后重试"},showRetry:{type:Boolean,default:!0},onRetry:{}},setup(s,{expose:e}){const t=s,r=as(),u=ms(r),l=A(!1),p=A(""),h=A(""),k=A(""),S=A(!1);Gs((m,w,$)=>(console.error("ErrorBoundary captured error:",m,$),l.value=!0,p.value=t.fallbackTitle,h.value=T(m),k.value=`${m.stack}

Component Info: ${$}`,Y(m,$),!1));const T=m=>m.message.includes("Network Error")?"网络连接失败，请检查网络设置后重试":m.message.includes("timeout")?"请求超时，请稍后重试":m.message.includes("401")?"登录已过期，请重新登录":m.message.includes("403")?"没有权限访问此资源":m.message.includes("404")?"请求的资源不存在":m.message.includes("500")?"服务器内部错误，请稍后重试":t.fallbackMessage,Y=(m,w)=>{const $={message:m.message,stack:m.stack,componentInfo:w,userAgent:navigator.userAgent,url:window.location.href,timestamp:new Date().toISOString()};console.error("Error Report:",$)},G=()=>{t.onRetry?t.onRetry():window.location.reload()},g=()=>{u.push("/dashboard"),C.success("已返回首页")};return e({resetError:()=>{l.value=!1,p.value="",h.value="",k.value="",S.value=!1}}),(m,w)=>{const $=y("el-icon"),b=y("el-button"),O=y("el-collapse-item"),E=y("el-collapse");return f(),V("div",xt,[l.value?(f(),V("div",Dt,[a("div",Rt,[o($,{size:"64",color:"#f56c6c"},{default:n(()=>[o(M(Ks))]),_:1})]),a("h3",Vt,z(p.value),1),a("p",Ut,z(h.value),1),a("div",Lt,[o(b,{onClick:G,type:"primary"},{default:n(()=>[o($,null,{default:n(()=>[o(M(ks))]),_:1}),w[1]||(w[1]=R(" 重试 ",-1))]),_:1}),o(b,{onClick:g},{default:n(()=>[o($,null,{default:n(()=>[o(M(Xs))]),_:1}),w[2]||(w[2]=R(" 返回首页 ",-1))]),_:1})]),S.value?(f(),F(E,{key:0,class:"error-details"},{default:n(()=>[o(O,{title:"错误详情",name:"details"},{default:n(()=>[a("pre",null,z(k.value),1)]),_:1})]),_:1})):L("",!0),S.value?L("",!0):(f(),F(b,{key:1,onClick:w[0]||(w[0]=I=>S.value=!0),type:"text",size:"small",class:"show-details-btn"},{default:n(()=>[...w[3]||(w[3]=[R(" 显示详细信息 ",-1)])]),_:1}))])):qs(m.$slots,"default",{key:0},void 0,!0)])}}}),zt=ve(Et,[["__scopeId","data-v-af8bd6d7"]]),Ce={minLength:8,expirationDays:60,reminderDays:7,defaultPassword:"123456"};class Nt{validatePassword(e){const t=[];return e.length<Ce.minLength&&t.push(`密码长度至少${Ce.minLength}位`),/[A-Z]/.test(e)||t.push("密码必须包含大写字母"),/[a-z]/.test(e)||t.push("密码必须包含小写字母"),/\d/.test(e)||t.push("密码必须包含数字"),/[!@#$%^&*(),.?":{}|<>]/.test(e)||t.push("密码必须包含特殊字符"),e===Ce.defaultPassword&&t.push("不能使用默认密码"),{isValid:t.length===0,errors:t}}isDefaultPassword(e){return e===Ce.defaultPassword}isPasswordExpired(e){if(!e.passwordLastChanged)return!0;const t=new Date(e.passwordLastChanged);return t.setDate(t.getDate()+Ce.expirationDays),new Date>t}needsPasswordReminder(e){if(!e.passwordLastChanged)return!0;const t=new Date(e.passwordLastChanged);return t.setDate(t.getDate()+Ce.expirationDays-Ce.reminderDays),new Date>t&&!this.isPasswordExpired(e)}getPasswordRemainingDays(e){if(!e.passwordLastChanged)return 0;const t=new Date(e.passwordLastChanged);t.setDate(t.getDate()+Ce.expirationDays);const r=new Date,u=t.getTime()-r.getTime(),l=Math.ceil(u/(1e3*60*60*24));return Math.max(0,l)}changePassword(e){return D(this,null,function*(){var t,r;try{const u=this.validatePassword(e.newPassword);if(!u.isValid)return{success:!1,message:u.errors.join(", ")};if(e.newPassword!==e.confirmPassword)return{success:!1,message:"新密码和确认密码不匹配"};try{const{apiService:l}=yield mt(()=>D(this,null,function*(){const{apiService:h}=yield import("./settings-CuxbDWOu.js").then(k=>k.a3);return{apiService:h}}),__vite__mapDeps([0,1,2,3,4])),p=yield l.put("/profile/password",{currentPassword:e.currentPassword,newPassword:e.newPassword,confirmPassword:e.confirmPassword});return this.updateUserPasswordInfo(e.userId||"current",{isDefaultPassword:!1,passwordLastChanged:new Date,forcePasswordChange:!1}),{success:!0,message:p.message||"密码修改成功"}}catch(l){return{success:!1,message:((r=(t=l.response)==null?void 0:t.data)==null?void 0:r.message)||l.message||"密码修改失败"}}}catch(u){return{success:!1,message:"密码修改失败，请稍后重试"}}})}resetPassword(e){return D(this,null,function*(){try{const t=this.validatePassword(e.newPassword);return t.isValid?(yield this.simulateApiCall(),this.updateUserPasswordInfo(e.userId,{isDefaultPassword:!1,passwordLastChanged:new Date,forcePasswordChange:!0}),{success:!0,message:"密码重置成功，用户下次登录时需要修改密码"}):{success:!1,message:t.errors.join(", ")}}catch(t){return{success:!1,message:"密码重置失败，请稍后重试"}}})}resetPasswordByAdmin(e,t){return D(this,null,function*(){try{const r=this.generateTemporaryPassword();return yield this.simulateApiCall(),this.updateUserPasswordInfo(e,{isDefaultPassword:!1,passwordLastChanged:new Date,forcePasswordChange:!0}),{success:!0,message:"密码重置成功，用户下次登录时需要修改密码",tempPassword:r}}catch(r){return{success:!1,message:"密码重置失败，请稍后重试"}}})}generateTemporaryPassword(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";let t="";t+="A",t+="a",t+="1",t+="!";for(let r=4;r<12;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t.split("").sort(()=>Math.random()-.5).join("")}initializeUserPasswordInfo(e){const t=this.getStoredUsers(),r=t.find(u=>u.id===e);r&&!r.passwordLastChanged&&(r.isDefaultPassword=!0,r.passwordLastChanged=new Date,r.forcePasswordChange=!0,localStorage.setItem("users",JSON.stringify(t)))}updateUserPasswordInfo(e,t){const r=this.getStoredUsers(),u=r.findIndex(l=>l.id===e);u!==-1&&(r[u]=K(K({},r[u]),t),localStorage.setItem("users",JSON.stringify(r)))}getStoredUsers(){const e=localStorage.getItem("users");return e?JSON.parse(e):[]}simulateApiCall(){return D(this,null,function*(){return new Promise(e=>{setTimeout(e,1e3)})})}}const _e=new Nt,Ot={key:0,class:"modal-overlay"},Bt={class:"modal-container"},Ht={class:"modal-header"},Ft={class:"modal-body"},Gt={key:0,class:"warning-message"},qt={class:"warning-text"},jt={key:0},Wt={key:1},Yt={key:2},Jt={class:"form-group"},Kt={key:0,class:"error-text"},Xt={class:"form-group"},Zt={key:0,class:"error-text"},Qt={class:"password-requirements"},ea={class:"form-group"},sa={key:0,class:"error-text"},ta={class:"form-actions"},aa=["disabled"],oa=ce({__name:"PasswordChangeModal",props:{visible:{type:Boolean},isForced:{type:Boolean,default:!1},isDefaultPassword:{type:Boolean,default:!1},isExpired:{type:Boolean,default:!1}},emits:["close","success"],setup(s,{emit:e}){const t=s,r=e,u=he(),l=A({currentPassword:"",newPassword:"",confirmPassword:""}),p=A({currentPassword:"",newPassword:"",confirmPassword:""}),h=A(!1),k=W(()=>l.value.newPassword.length>=8),S=W(()=>/[A-Z]/.test(l.value.newPassword)),T=W(()=>/[a-z]/.test(l.value.newPassword)),Y=W(()=>/\d/.test(l.value.newPassword)),G=W(()=>/[!@#$%^&*(),.?":{}|<>]/.test(l.value.newPassword)),g=W(()=>l.value.currentPassword&&l.value.newPassword&&l.value.confirmPassword&&k.value&&S.value&&T.value&&Y.value&&G.value&&l.value.newPassword===l.value.confirmPassword);we(()=>l.value.newPassword,w=>{if(w){const $=_e.validatePassword(w);p.value.newPassword=$.isValid?"":$.errors.join(", ")}else p.value.newPassword=""}),we(()=>l.value.confirmPassword,w=>{w&&l.value.newPassword?p.value.confirmPassword=w===l.value.newPassword?"":"两次输入的密码不一致":p.value.confirmPassword=""});const P=()=>D(this,null,function*(){var w;if(g.value){h.value=!0,p.value={currentPassword:"",newPassword:"",confirmPassword:""};try{const $={userId:((w=u.user)==null?void 0:w.id)||"",currentPassword:l.value.currentPassword,newPassword:l.value.newPassword,confirmPassword:l.value.confirmPassword},b=yield _e.changePassword($);b.success?(u.user&&(u.user.isDefaultPassword=!1,u.user.passwordLastChanged=new Date,u.user.forcePasswordChange=!1),r("success"),m()):b.message.includes("当前密码")?p.value.currentPassword=b.message:p.value.newPassword=b.message}catch($){p.value.newPassword="修改密码失败，请稍后重试"}finally{h.value=!1}}}),m=()=>{t.isForced||(l.value={currentPassword:"",newPassword:"",confirmPassword:""},p.value={currentPassword:"",newPassword:"",confirmPassword:""},r("close"))};return(w,$)=>s.visible?(f(),V("div",Ot,[a("div",Bt,[a("div",Ht,[a("h3",null,z(s.isForced?"强制修改密码":"修改密码"),1),s.isForced?L("",!0):(f(),V("button",{key:0,onClick:m,class:"close-btn"},"×"))]),a("div",Ft,[s.isForced?(f(),V("div",Gt,[$[3]||($[3]=a("div",{class:"warning-icon"},"⚠️",-1)),a("div",qt,[s.isDefaultPassword?(f(),V("p",jt,"检测到您正在使用默认密码，为了账户安全，请立即修改密码。")):s.isExpired?(f(),V("p",Wt,"您的密码已过期，请立即修改密码。")):(f(),V("p",Yt,"管理员要求您修改密码，请设置新密码。"))])])):L("",!0),a("form",{onSubmit:Ge(P,["prevent"]),class:"password-form"},[a("div",Jt,[$[4]||($[4]=a("label",{for:"currentPassword"},"当前密码",-1)),Ze(a("input",{id:"currentPassword","onUpdate:modelValue":$[0]||($[0]=b=>l.value.currentPassword=b),type:"password",class:te({error:p.value.currentPassword}),placeholder:"请输入当前密码",required:""},null,2),[[ls,l.value.currentPassword]]),p.value.currentPassword?(f(),V("span",Kt,z(p.value.currentPassword),1)):L("",!0)]),a("div",Xt,[$[6]||($[6]=a("label",{for:"newPassword"},"新密码",-1)),Ze(a("input",{id:"newPassword","onUpdate:modelValue":$[1]||($[1]=b=>l.value.newPassword=b),type:"password",class:te({error:p.value.newPassword}),placeholder:"请输入新密码",required:""},null,2),[[ls,l.value.newPassword]]),p.value.newPassword?(f(),V("span",Zt,z(p.value.newPassword),1)):L("",!0),a("div",Qt,[$[5]||($[5]=a("p",null,"密码要求：",-1)),a("ul",null,[a("li",{class:te({valid:k.value})},"至少8位字符",2),a("li",{class:te({valid:S.value})},"包含大写字母",2),a("li",{class:te({valid:T.value})},"包含小写字母",2),a("li",{class:te({valid:Y.value})},"包含数字",2),a("li",{class:te({valid:G.value})},"包含特殊字符",2)])])]),a("div",ea,[$[7]||($[7]=a("label",{for:"confirmPassword"},"确认新密码",-1)),Ze(a("input",{id:"confirmPassword","onUpdate:modelValue":$[2]||($[2]=b=>l.value.confirmPassword=b),type:"password",class:te({error:p.value.confirmPassword}),placeholder:"请再次输入新密码",required:""},null,2),[[ls,l.value.confirmPassword]]),p.value.confirmPassword?(f(),V("span",sa,z(p.value.confirmPassword),1)):L("",!0)]),a("div",ta,[a("button",{type:"submit",disabled:!g.value||h.value,class:"submit-btn"},z(h.value?"修改中...":"确认修改"),9,aa),s.isForced?L("",!0):(f(),V("button",{key:0,type:"button",onClick:m,class:"cancel-btn"}," 取消 "))])],32)])])])):L("",!0)}}),na=ve(oa,[["__scopeId","data-v-e75547a4"]]),ra={key:0,class:"modal-overlay"},la={class:"modal-container"},ia={class:"modal-body"},da={class:"reminder-message"},ca={class:"reminder-text"},ua={key:0},ma={key:1},pa={class:"last-changed"},fa={class:"reminder-actions"},ga={class:"reminder-options"},va={class:"checkbox-label"},ha=["disabled"],_a=ce({__name:"PasswordReminderModal",props:{visible:{type:Boolean},remainingDays:{},lastChanged:{}},emits:["close","changePassword","remindLater"],setup(s,{emit:e}){const t=e,r=A(!1),u=k=>k?new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(k):"未知",l=()=>{t("changePassword"),h()},p=()=>{t("remindLater",r.value),h()},h=()=>{r.value=!1,t("close")};return(k,S)=>s.visible?(f(),V("div",ra,[a("div",la,[a("div",{class:"modal-header"},[S[1]||(S[1]=a("h3",null,"密码过期提醒",-1)),a("button",{onClick:h,class:"close-btn"},"×")]),a("div",ia,[a("div",da,[S[4]||(S[4]=a("div",{class:"reminder-icon"},"🔔",-1)),a("div",ca,[s.remainingDays>0?(f(),V("p",ua,[S[2]||(S[2]=R(" 您的密码将在 ",-1)),a("strong",null,z(s.remainingDays),1),S[3]||(S[3]=R(" 天后过期，建议您及时修改密码以确保账户安全。 ",-1))])):(f(),V("p",ma," 您的密码已过期，请立即修改密码。 ")),a("p",pa," 上次修改时间："+z(u(s.lastChanged)),1)])]),a("div",fa,[a("button",{onClick:l,class:"primary-btn"}," 立即修改密码 "),s.remainingDays>0?(f(),V("button",{key:0,onClick:p,class:"secondary-btn"}," 稍后提醒 ")):L("",!0)]),a("div",ga,[a("label",va,[Ze(a("input",{"onUpdate:modelValue":S[0]||(S[0]=T=>r.value=T),type:"checkbox",disabled:s.remainingDays<=0},null,8,ha),[[js,r.value]]),S[5]||(S[5]=R(" 今天不再提醒 ",-1))])])])])])):L("",!0)}}),ya=ve(_a,[["__scopeId","data-v-62e037f8"]]),Me=class Me{constructor(){oe(this,"api");this.api=ds}static getInstance(){return Me.instance||(Me.instance=new Me),Me.instance}getProfile(){return D(this,null,function*(){if(ts())return console.log("[ProfileAPI] Mock API模式 - 使用模拟数据"),this.getMockProfile();try{const e=yield this.api.get("/profile");return console.log("[ProfileAPI] 获取个人信息成功"),e}catch(e){return console.log("[ProfileAPI] API请求失败，使用模拟数据"),this.getMockProfile()}})}updateProfile(e){return D(this,null,function*(){if(ts()){console.log("[ProfileAPI] Mock API模式 - 模拟更新个人信息");const t=this.getMockProfile();return K(K({},t),e)}try{const t=yield this.api.put("/profile",e);return console.log("[ProfileAPI] 更新个人信息成功"),t}catch(t){console.log("[ProfileAPI] API请求失败，使用模拟数据");const r=this.getMockProfile();return K(K({},r),e)}})}uploadAvatar(e){return D(this,null,function*(){try{const t=new FormData;t.append("avatar",e);const r=yield this.api.post("/profile/avatar",t,{headers:{"Content-Type":"multipart/form-data"}});return console.log("[ProfileAPI] 头像上传成功"),r.url}catch(t){return console.error("[ProfileAPI] 头像上传失败:",t),URL.createObjectURL(e)}})}getPreferences(){return D(this,null,function*(){try{const e=yield this.api.get("/profile/preferences");return console.log("[ProfileAPI] 获取偏好设置成功"),e}catch(e){return console.error("[ProfileAPI] 获取偏好设置失败:",e),this.getDefaultPreferences()}})}updatePreferences(e){return D(this,null,function*(){try{const t=yield this.api.put("/profile/preferences",e);return console.log("[ProfileAPI] 更新偏好设置成功"),t}catch(t){return console.error("[ProfileAPI] 更新偏好设置失败:",t),e}})}getMockProfile(){return{id:"1",username:"admin",name:"管理员",email:"admin@example.com",phone:"13800138000",department:"技术部",role:"管理员",avatar:"",preferences:this.getDefaultPreferences(),lastLoginTime:new Date().toISOString(),createTime:new Date().toISOString()}}getDefaultPreferences(){return{language:"zh-CN",timezone:"Asia/Shanghai",emailNotifications:!0,browserNotifications:!0,smsNotifications:!1,pageSize:20}}};oe(Me,"instance");let cs=Me;const Ke=cs.getInstance(),wa={class:"settings-container"},ba={class:"settings-nav"},Pa=["onClick"],Sa={class:"settings-content"},Ca={key:0,class:"content-section"},Aa={class:"profile-form"},ka={class:"avatar-section"},Ta={class:"avatar-container"},$a={class:"form-actions"},Ma={key:1,class:"content-section"},Ia={class:"password-strength"},xa={class:"strength-bar"},Da={class:"strength-text"},Ra={class:"form-actions"},Va={key:2,class:"content-section"},Ua={class:"preferences-form"},La={class:"preference-group"},Ea={class:"preference-item"},za={class:"preference-item"},Na={class:"preference-group"},Oa={class:"preference-item"},Ba={class:"preference-item"},Ha={class:"preference-item"},Fa={class:"preference-group"},Ga={class:"preference-item"},qa={class:"form-actions"},ja=ce({__name:"PersonalSettingsModal",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(s,{emit:e}){const t=s,r=e,u=he(),l=A("profile"),p=A(!1),h=A(!1),k=A(!1),S=A(),T=A(),Y=A(),G=[{key:"profile",label:"个人信息",icon:xe},{key:"password",label:"密码修改",icon:Zs},{key:"preferences",label:"偏好设置",icon:ss}],g=Qe({name:"",username:"",email:"",phone:"",department:"",role:"",avatar:""}),P=Qe({currentPassword:"",newPassword:"",confirmPassword:""}),m=Qe({language:"zh-CN",timezone:"Asia/Shanghai",emailNotifications:!0,browserNotifications:!0,smsNotifications:!1,pageSize:20}),w={name:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"姓名长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{pattern:new RegExp("^1[3-9]\\d{9}$"),message:"请输入正确的手机号",trigger:"blur"}]},$={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度不能少于8位",trigger:"blur"},{validator:(U,i,j)=>{i&&i===P.currentPassword?j(new Error("新密码不能与当前密码相同")):j()},trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(U,i,j)=>{i!==P.newPassword?j(new Error("两次输入的密码不一致")):j()},trigger:"blur"}]},b=W(()=>{const U=P.newPassword;if(!U)return 0;let i=0;return U.length>=8&&(i+=1),new RegExp("[a-z]").test(U)&&(i+=1),new RegExp("[A-Z]").test(U)&&(i+=1),new RegExp("\\d").test(U)&&(i+=1),new RegExp('[!@#$%^&*(),.?":{}|<>]').test(U)&&(i+=1),i}),O=W(()=>{const U=b.value;return U<=2?"weak":U<=3?"medium":"strong"}),E=W(()=>`${b.value/5*100}%`),I=W(()=>{const U=b.value;return U<=2?"弱":U<=3?"中等":"强"}),_=()=>{r("update:visible",!1)},d=()=>D(this,null,function*(){var U;try{const i=yield Ke.getProfile();g.name=i.name||"",g.username=i.username||"",g.email=i.email||"",g.phone=i.phone||"",g.department=i.department||"",g.role=i.role||"",g.avatar=i.avatar||"",Object.assign(m,i.preferences)}catch(i){console.error("初始化个人信息失败:",i);const j=u.user;j&&(g.name=j.name||"",g.username=((U=j.email)==null?void 0:U.split("@")[0])||"",g.email=j.email||"",g.phone="",g.department=j.department||"",g.role=j.role||"",g.avatar=j.avatar||"")}}),c=()=>{var U;(U=Y.value)==null||U.click()},N=U=>D(this,null,function*(){var j;const i=(j=U.target.files)==null?void 0:j[0];if(i){if(!i.type.startsWith("image/")){C.error("请选择图片文件");return}if(i.size>2*1024*1024){C.error("图片大小不能超过2MB");return}try{const me=yield Ke.uploadAvatar(i);g.avatar=me,C.success("头像上传成功")}catch(me){console.error("头像上传失败:",me),C.error("头像上传失败，请重试")}}}),J=()=>D(this,null,function*(){var U;try{yield(U=S.value)==null?void 0:U.validate(),p.value=!0;const i={name:g.name,email:g.email,phone:g.phone,avatar:g.avatar};yield Ke.updateProfile(i),C.success("个人信息保存成功"),r("success")}catch(i){console.error("保存个人信息失败:",i),C.error("保存个人信息失败，请重试")}finally{p.value=!1}}),q=()=>{var U;d(),(U=S.value)==null||U.clearValidate()},Q=()=>D(this,null,function*(){var U,i;try{yield(U=T.value)==null?void 0:U.validate(),h.value=!0;const j=yield _e.changePassword({userId:((i=u.user)==null?void 0:i.id)||"current",currentPassword:P.currentPassword,newPassword:P.newPassword,confirmPassword:P.confirmPassword});j.success?(C.success("密码修改成功"),be(),r("success")):C.error(j.message||"密码修改失败")}catch(j){console.error("密码修改失败:",j),C.error("密码修改失败，请稍后重试")}finally{h.value=!1}}),be=()=>{var U;Object.assign(P,{currentPassword:"",newPassword:"",confirmPassword:""}),(U=T.value)==null||U.clearValidate()},B=()=>D(this,null,function*(){try{k.value=!0;const U={language:m.language,timezone:m.timezone,emailNotifications:m.emailNotifications,browserNotifications:m.browserNotifications,smsNotifications:m.smsNotifications,pageSize:m.pageSize};yield Ke.updatePreferences(U),C.success("偏好设置保存成功"),r("success")}catch(U){console.error("保存偏好设置失败:",U),C.error("保存偏好设置失败，请重试")}finally{k.value=!1}}),ue=()=>{Object.assign(m,{language:"zh-CN",timezone:"Asia/Shanghai",emailNotifications:!0,browserNotifications:!0,smsNotifications:!1,pageSize:20})};return we(()=>t.visible,U=>{U&&(d(),l.value="profile")}),Ee(()=>{d()}),(U,i)=>{const j=y("el-icon"),me=y("el-avatar"),re=y("el-input"),ae=y("el-form-item"),pe=y("el-col"),Te=y("el-row"),Z=y("el-form"),Pe=y("el-button"),le=y("el-option"),ze=y("el-select"),Ne=y("el-switch"),ns=y("el-dialog");return f(),F(ns,{"model-value":s.visible,"onUpdate:modelValue":_,title:"个人设置",width:"800px","before-close":_,class:"personal-settings-modal"},{default:n(()=>[a("div",wa,[a("div",ba,[(f(),V(ye,null,ke(G,H=>a("div",{key:H.key,class:te(["nav-item",{active:l.value===H.key}]),onClick:fs=>l.value=H.key},[o(j,null,{default:n(()=>[(f(),F(De(H.icon)))]),_:2},1024),a("span",null,z(H.label),1)],10,Pa)),64))]),a("div",Sa,[l.value==="profile"?(f(),V("div",Ca,[i[18]||(i[18]=a("div",{class:"section-header"},[a("h3",null,"个人信息"),a("p",null,"管理您的基本信息和头像")],-1)),a("div",Aa,[a("div",ka,[a("div",Ta,[o(me,{src:g.avatar,size:80,class:"user-avatar"},{default:n(()=>[g.avatar?L("",!0):(f(),F(j,{key:0},{default:n(()=>[o(M(xe))]),_:1}))]),_:1},8,["src"]),a("div",{class:"avatar-overlay",onClick:c},[o(j,null,{default:n(()=>[o(M(Qs))]),_:1}),i[15]||(i[15]=a("span",null,"更换头像",-1))])]),a("input",{ref_key:"avatarInput",ref:Y,type:"file",accept:"image/*",style:{display:"none"},onChange:N},null,544)]),o(Z,{ref_key:"profileFormRef",ref:S,model:g,rules:w,"label-width":"100px",class:"profile-info-form"},{default:n(()=>[o(Te,{gutter:20},{default:n(()=>[o(pe,{span:12},{default:n(()=>[o(ae,{label:"姓名",prop:"name"},{default:n(()=>[o(re,{modelValue:g.name,"onUpdate:modelValue":i[0]||(i[0]=H=>g.name=H),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),o(pe,{span:12},{default:n(()=>[o(ae,{label:"用户名",prop:"username"},{default:n(()=>[o(re,{modelValue:g.username,"onUpdate:modelValue":i[1]||(i[1]=H=>g.username=H),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(Te,{gutter:20},{default:n(()=>[o(pe,{span:12},{default:n(()=>[o(ae,{label:"邮箱",prop:"email"},{default:n(()=>[o(re,{modelValue:g.email,"onUpdate:modelValue":i[2]||(i[2]=H=>g.email=H),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),o(pe,{span:12},{default:n(()=>[o(ae,{label:"手机号",prop:"phone"},{default:n(()=>[o(re,{modelValue:g.phone,"onUpdate:modelValue":i[3]||(i[3]=H=>g.phone=H),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(Te,{gutter:20},{default:n(()=>[o(pe,{span:12},{default:n(()=>[o(ae,{label:"部门"},{default:n(()=>[o(re,{modelValue:g.department,"onUpdate:modelValue":i[4]||(i[4]=H=>g.department=H),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),o(pe,{span:12},{default:n(()=>[o(ae,{label:"角色"},{default:n(()=>[o(re,{modelValue:g.role,"onUpdate:modelValue":i[5]||(i[5]=H=>g.role=H),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),a("div",$a,[o(Pe,{type:"primary",onClick:J,loading:p.value},{default:n(()=>[...i[16]||(i[16]=[R(" 保存更改 ",-1)])]),_:1},8,["loading"]),o(Pe,{onClick:q},{default:n(()=>[...i[17]||(i[17]=[R("重置",-1)])]),_:1})])])])):L("",!0),l.value==="password"?(f(),V("div",Ma,[i[21]||(i[21]=a("div",{class:"section-header"},[a("h3",null,"密码修改"),a("p",null,"定期修改密码以保护账户安全")],-1)),o(Z,{ref_key:"passwordFormRef",ref:T,model:P,rules:$,"label-width":"120px",class:"password-form"},{default:n(()=>[o(ae,{label:"当前密码",prop:"currentPassword"},{default:n(()=>[o(re,{modelValue:P.currentPassword,"onUpdate:modelValue":i[6]||(i[6]=H=>P.currentPassword=H),type:"password",placeholder:"请输入当前密码","show-password":""},null,8,["modelValue"])]),_:1}),o(ae,{label:"新密码",prop:"newPassword"},{default:n(()=>[o(re,{modelValue:P.newPassword,"onUpdate:modelValue":i[7]||(i[7]=H=>P.newPassword=H),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"]),a("div",Ia,[a("div",xa,[a("div",{class:te(["strength-fill",O.value]),style:Cs({width:E.value})},null,6)]),a("span",Da,z(I.value),1)])]),_:1}),o(ae,{label:"确认新密码",prop:"confirmPassword"},{default:n(()=>[o(re,{modelValue:P.confirmPassword,"onUpdate:modelValue":i[8]||(i[8]=H=>P.confirmPassword=H),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),a("div",Ra,[o(Pe,{type:"primary",onClick:Q,loading:h.value},{default:n(()=>[...i[19]||(i[19]=[R(" 修改密码 ",-1)])]),_:1},8,["loading"]),o(Pe,{onClick:be},{default:n(()=>[...i[20]||(i[20]=[R("重置",-1)])]),_:1})])])):L("",!0),l.value==="preferences"?(f(),V("div",Va,[i[33]||(i[33]=a("div",{class:"section-header"},[a("h3",null,"偏好设置"),a("p",null,"个性化您的使用体验")],-1)),a("div",Ua,[a("div",La,[i[24]||(i[24]=a("h4",null,"界面设置",-1)),a("div",Ea,[i[22]||(i[22]=a("div",{class:"preference-label"},[a("span",null,"语言"),a("p",null,"选择界面显示语言")],-1)),o(ze,{modelValue:m.language,"onUpdate:modelValue":i[9]||(i[9]=H=>m.language=H),placeholder:"选择语言"},{default:n(()=>[o(le,{label:"简体中文",value:"zh-CN"}),o(le,{label:"English",value:"en-US"})]),_:1},8,["modelValue"])]),a("div",za,[i[23]||(i[23]=a("div",{class:"preference-label"},[a("span",null,"时区"),a("p",null,"设置您所在的时区")],-1)),o(ze,{modelValue:m.timezone,"onUpdate:modelValue":i[10]||(i[10]=H=>m.timezone=H),placeholder:"选择时区"},{default:n(()=>[o(le,{label:"北京时间 (UTC+8)",value:"Asia/Shanghai"}),o(le,{label:"东京时间 (UTC+9)",value:"Asia/Tokyo"}),o(le,{label:"纽约时间 (UTC-5)",value:"America/New_York"})]),_:1},8,["modelValue"])])]),a("div",Na,[i[28]||(i[28]=a("h4",null,"通知设置",-1)),a("div",Oa,[i[25]||(i[25]=a("div",{class:"preference-label"},[a("span",null,"邮件通知"),a("p",null,"接收重要事件的邮件通知")],-1)),o(Ne,{modelValue:m.emailNotifications,"onUpdate:modelValue":i[11]||(i[11]=H=>m.emailNotifications=H)},null,8,["modelValue"])]),a("div",Ba,[i[26]||(i[26]=a("div",{class:"preference-label"},[a("span",null,"浏览器通知"),a("p",null,"在浏览器中显示通知")],-1)),o(Ne,{modelValue:m.browserNotifications,"onUpdate:modelValue":i[12]||(i[12]=H=>m.browserNotifications=H)},null,8,["modelValue"])]),a("div",Ha,[i[27]||(i[27]=a("div",{class:"preference-label"},[a("span",null,"短信通知"),a("p",null,"接收重要事件的短信通知")],-1)),o(Ne,{modelValue:m.smsNotifications,"onUpdate:modelValue":i[13]||(i[13]=H=>m.smsNotifications=H)},null,8,["modelValue"])])]),a("div",Fa,[i[30]||(i[30]=a("h4",null,"数据设置",-1)),a("div",Ga,[i[29]||(i[29]=a("div",{class:"preference-label"},[a("span",null,"每页显示条数"),a("p",null,"设置表格默认每页显示的数据条数")],-1)),o(ze,{modelValue:m.pageSize,"onUpdate:modelValue":i[14]||(i[14]=H=>m.pageSize=H),placeholder:"选择条数"},{default:n(()=>[o(le,{label:"10条",value:10}),o(le,{label:"20条",value:20}),o(le,{label:"50条",value:50}),o(le,{label:"100条",value:100})]),_:1},8,["modelValue"])])])]),a("div",qa,[o(Pe,{type:"primary",onClick:B,loading:k.value},{default:n(()=>[...i[31]||(i[31]=[R(" 保存设置 ",-1)])]),_:1},8,["loading"]),o(Pe,{onClick:ue},{default:n(()=>[...i[32]||(i[32]=[R("重置",-1)])]),_:1})])])):L("",!0)])])]),_:1},8,["model-value"])}}}),Wa=ve(ja,[["__scopeId","data-v-7ae049d4"]]),Ie=class Ie{constructor(){oe(this,"config",A({mode:"local",autoSync:!0,syncInterval:30,apiEndpoint:"/api/v1",lastUpdatedBy:"",lastUpdatedAt:"",version:1}));oe(this,"status",Qe({loading:!1,syncing:!1,lastSyncAt:null,error:null}));oe(this,"syncTimer",null);oe(this,"STORAGE_KEY","global_storage_config");oe(this,"SYNC_INTERVAL",6e4);this.loadLocalConfig(),this.startPeriodicSync(),this.setupConfigWatcher()}static getInstance(){return Ie.instance||(Ie.instance=new Ie),Ie.instance}isSuperAdmin(){const e=is.getLocalUserInfo();return(e==null?void 0:e.role)==="admin"||is.hasRole("super_admin")}loadLocalConfig(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.config.value=K(K({},this.config.value),t),console.log("[GlobalConfig] 本地配置已加载:",this.config.value)}}catch(e){console.error("[GlobalConfig] 加载本地配置失败:",e)}}saveLocalConfig(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.config.value)),console.log("[GlobalConfig] 配置已保存到本地")}catch(e){console.error("[GlobalConfig] 保存本地配置失败:",e)}}fetchGlobalConfig(){return D(this,null,function*(){try{if(this.status.loading=!0,this.status.error=null,ts())return console.log("[GlobalConfig] Mock API模式 - 使用本地配置"),this.status.lastSyncAt=new Date().toISOString(),this.config.value;const t=(yield ds.get("/system/global-config")).storageConfig;return t.version>this.config.value.version&&(this.config.value=t,this.saveLocalConfig(),console.log("[GlobalConfig] 全局配置已从服务器更新:",t),C.success("全局配置已更新")),this.status.lastSyncAt=new Date().toISOString(),t}catch(e){return console.warn("[GlobalConfig] 获取全局配置失败:",e),this.status.error=e instanceof Error?e.message:"获取配置失败",null}finally{this.status.loading=!1}})}updateGlobalConfig(e){return D(this,null,function*(){if(!this.isSuperAdmin())return C.error("只有超级管理员可以修改全局配置"),!1;try{this.status.syncing=!0,this.status.error=null;const t=is.getLocalUserInfo(),r=Je(K(K({},this.config.value),e),{lastUpdatedBy:(t==null?void 0:t.realName)||(t==null?void 0:t.username)||"未知用户",lastUpdatedAt:new Date().toISOString(),version:this.config.value.version+1});return ts()?(console.log("[GlobalConfig] Mock API模式 - 仅更新本地配置:",r),this.config.value=r,this.saveLocalConfig(),C.success("全局配置已更新（本地模式）"),!0):(yield ds.put("/system/global-config",{storageConfig:r}),this.config.value=r,this.saveLocalConfig(),console.log("[GlobalConfig] 全局配置已更新:",r),C.success("全局配置已更新并同步"),!0)}catch(t){return console.error("[GlobalConfig] 更新全局配置失败:",t),this.status.error=t instanceof Error?t.message:"更新配置失败",C.error("更新全局配置失败: "+this.status.error),!1}finally{this.status.syncing=!1}})}startPeriodicSync(){this.fetchGlobalConfig(),this.syncTimer=window.setInterval(()=>{this.fetchGlobalConfig()},this.SYNC_INTERVAL),console.log("[GlobalConfig] 定期同步已启动")}stopPeriodicSync(){this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null,console.log("[GlobalConfig] 定期同步已停止"))}setupConfigWatcher(){we(()=>this.config.value,e=>{this.saveLocalConfig(),console.log("[GlobalConfig] 配置已更新:",e)},{deep:!0})}syncConfig(){return D(this,null,function*(){yield this.fetchGlobalConfig()})}resetToDefault(){return D(this,null,function*(){if(!this.isSuperAdmin())return C.error("只有超级管理员可以重置全局配置"),!1;const e={mode:"local",autoSync:!0,syncInterval:30,apiEndpoint:"/api/v1"};return yield this.updateGlobalConfig(e)})}getConfigInfo(){return{lastUpdatedBy:this.config.value.lastUpdatedBy,lastUpdatedAt:this.config.value.lastUpdatedAt,version:this.config.value.version,canModify:this.isSuperAdmin()}}destroy(){this.stopPeriodicSync()}};oe(Ie,"instance");let us=Ie;const Le=us.getInstance();typeof window!="undefined"&&window.addEventListener("beforeunload",()=>{Le.destroy()});const Ya={key:0,class:"storage-mode-switch"},Ja={class:"mode-text"},Ka={class:"mode-status"},Xa={key:0,class:"api-unavailable"},Za={key:0},Qa={key:0},eo={class:"dialog-footer"},so={class:"sync-progress"},to={class:"sync-message"},ao=ce({__name:"StorageModeSwitch",setup(s){const e=he(),t=A(!1),r=A(null),u=W(()=>!e.isLoggedIn||!e.currentUser||!t.value?!1:e.isSuperAdmin);we(()=>[e.isLoggedIn,e.currentUser,e.isSuperAdmin],()=>{r.value&&clearTimeout(r.value),r.value=setTimeout(()=>{e.isLoggedIn&&e.currentUser?(t.value=!0,console.log("[StorageModeSwitch] 用户状态已稳定，isSuperAdmin:",e.isSuperAdmin)):t.value=!1},100)},{immediate:!0});const l=A(!1),p=A(!1),h=A(0),k=A(""),S=A(""),T=A(!1),Y=ge.getConfig(),G=ge.getStatus(),g=ge.getModeIndicator(),P=Le.config;Le.status;const m=A({mode:"local",autoSync:!1,syncInterval:5,fallbackToLocal:!0,showModeIndicator:!0}),w=d=>D(this,null,function*(){if(!T.value)try{switch(T.value=!0,d){case"switch-local":yield $("local");break;case"switch-api":yield $("api");break;case"sync-data":yield O();break;case"settings":E();break}}catch(c){console.error("操作失败:",c),C.error("操作失败，请稍后重试")}finally{T.value=!1}}),$=d=>D(this,null,function*(){e.isSuperAdmin?(yield Le.updateGlobalConfig({mode:d}))&&(yield ge.switchMode(d),C.success(`已切换到${b(d)}模式并全局同步`)):(yield ge.switchMode(d),C.success(`已切换到${b(d)}模式`))}),b=d=>({local:"本地存储",api:"API存储"})[d]||d,O=()=>D(this,null,function*(){if(G.value.currentMode==="local"){C.warning("本地存储模式无法进行数据同步");return}p.value=!0,h.value=0,k.value="",S.value="准备同步数据...";try{if(!(yield ge.checkApiStatus()))throw new Error("API服务不可用");const c=[{progress:20,message:"检查连接状态..."},{progress:40,message:"验证用户权限..."},{progress:60,message:"同步数据中..."},{progress:80,message:"验证数据完整性..."},{progress:100,message:"同步完成"}];for(const J of c)yield new Promise(q=>setTimeout(q,500)),h.value=J.progress,S.value=J.message;(yield ge.syncData())?(k.value="success",S.value="数据同步成功",C.success("数据同步完成")):(k.value="exception",S.value="数据同步失败",C.error("数据同步失败")),setTimeout(()=>{p.value=!1},1500)}catch(d){console.error("同步失败:",d),k.value="exception",S.value=d instanceof Error?d.message:"同步过程中发生错误",C.error("数据同步失败："+(d instanceof Error?d.message:"未知错误")),setTimeout(()=>{p.value=!1},2e3)}}),E=()=>{Object.assign(m.value,Y.value),l.value=!0},I=()=>D(this,null,function*(){try{e.isSuperAdmin?(yield Le.updateGlobalConfig({mode:m.value.mode,autoSync:m.value.autoSync,syncInterval:m.value.syncInterval}))&&(ge.updateConfig(m.value),C.success("全局设置保存成功"),l.value=!1):(ge.updateConfig(m.value),C.success("本地设置保存成功"),l.value=!1)}catch(d){console.error("保存设置失败:",d),C.error("设置保存失败")}});Ee(()=>D(this,null,function*(){if(Object.assign(m.value,Y.value),e.isLoggedIn&&!e.isSuperAdmin){yield Le.syncConfig();const d=P.value;d.mode!==Y.value.mode&&(yield ge.switchMode(d.mode))}})),we(()=>P.value,d=>D(this,null,function*(){!e.isSuperAdmin&&d.mode!==Y.value.mode&&(console.log("[StorageModeSwitch] 应用全局配置:",d.mode),yield ge.switchMode(d.mode),C.info(`存储模式已更新为：${b(d.mode)}`))}),{deep:!0});const _=()=>{const d=G.value.currentMode;let N={local:"本地存储模式：数据保存在浏览器本地，离线可用，但不会同步到其他设备",api:"API存储模式：数据保存在服务器，可在多设备间同步，需要网络连接"}[d]||`${d}模式`;return!G.value.apiAvailable&&d==="api"&&(N+="（当前API不可用，已自动切换到本地模式）"),N};return os(()=>{r.value&&(clearTimeout(r.value),r.value=null)}),(d,c)=>{const N=y("el-icon"),J=y("el-tooltip"),q=y("el-button"),Q=y("el-dropdown-item"),be=y("el-dropdown-menu"),B=y("el-dropdown"),ue=y("el-alert"),U=y("el-radio"),i=y("el-radio-group"),j=y("el-form-item"),me=y("el-switch"),re=y("el-input-number"),ae=y("el-form"),pe=y("el-dialog"),Te=y("el-progress");return u.value?(f(),V("div",Ya,[M(g).showIndicator?(f(),F(J,{key:0,content:_(),placement:"bottom"},{default:n(()=>[a("div",{class:te(["mode-indicator",`mode-indicator--${M(g).color}`])},[o(N,{class:"mode-icon"},{default:n(()=>[(f(),F(De(M(g).icon)))]),_:1}),a("span",Ja,z(M(g).text),1),a("span",Ka,z(M(g).status),1)],2)]),_:1},8,["content"])):L("",!0),o(B,{trigger:"click",placement:"bottom-end",onCommand:w},{dropdown:n(()=>[o(be,null,{default:n(()=>[o(Q,{command:"switch-local",disabled:M(G).currentMode==="local"},{default:n(()=>[o(N,null,{default:n(()=>[o(M(et))]),_:1}),c[10]||(c[10]=R(" 切换到本地模式 ",-1))]),_:1},8,["disabled"]),o(Q,{command:"switch-api",disabled:M(G).currentMode==="api"||!M(G).apiAvailable},{default:n(()=>[o(N,null,{default:n(()=>[o(M(st))]),_:1}),c[11]||(c[11]=R(" 切换到API模式 ",-1)),M(G).apiAvailable?L("",!0):(f(),V("span",Xa,"(不可用)"))]),_:1},8,["disabled"]),o(Q,{command:"sync-data",disabled:M(G).syncInProgress},{default:n(()=>[o(N,null,{default:n(()=>[o(M(ks))]),_:1}),c[12]||(c[12]=R(" 同步数据 ",-1))]),_:1},8,["disabled"]),o(Q,{divided:"",command:"settings"},{default:n(()=>[o(N,null,{default:n(()=>[o(M(ss))]),_:1}),c[13]||(c[13]=R(" 存储设置 ",-1))]),_:1})]),_:1})]),default:n(()=>[o(q,{type:"primary",loading:T.value||M(G).syncInProgress,size:"small",disabled:T.value},{default:n(()=>[o(N,null,{default:n(()=>[o(M(ss))]),_:1}),c[9]||(c[9]=R(" 存储模式 ",-1)),o(N,{class:"el-icon--right"},{default:n(()=>[o(M(Ts))]),_:1})]),_:1},8,["loading","disabled"])]),_:1}),o(pe,{modelValue:l.value,"onUpdate:modelValue":c[7]||(c[7]=Z=>l.value=Z),title:"存储模式设置",width:"500px","close-on-click-modal":!1},{footer:n(()=>[a("div",eo,[o(q,{onClick:c[6]||(c[6]=Z=>l.value=!1)},{default:n(()=>[...c[23]||(c[23]=[R("取消",-1)])]),_:1}),o(q,{type:"primary",onClick:I},{default:n(()=>[...c[24]||(c[24]=[R("保存设置",-1)])]),_:1})])]),default:n(()=>[M(e).isSuperAdmin?(f(),F(ue,{key:0,title:"超级管理员模式",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:n(()=>[R(" 您的配置将全局同步到所有用户。当前全局配置版本："+z(M(P).version)+" ",1),c[14]||(c[14]=a("br",null,null,-1)),M(P).lastUpdatedBy?(f(),V("span",Za," 最后更新："+z(M(P).lastUpdatedBy)+" ("+z(new Date(M(P).lastUpdatedAt).toLocaleString())+") ",1)):L("",!0)]),_:1})):(f(),F(ue,{key:1,title:"普通用户模式",type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:n(()=>[c[15]||(c[15]=R(" 您的配置将跟随超级管理员的全局设置。 ",-1)),c[16]||(c[16]=a("br",null,null,-1)),R(" 当前全局模式："+z(b(M(P).mode))+" ",1),M(P).lastUpdatedBy?(f(),V("span",Qa," (由 "+z(M(P).lastUpdatedBy)+" 配置) ",1)):L("",!0)]),_:1})),o(ae,{model:m.value,"label-width":"120px",onSubmit:c[5]||(c[5]=Ge(()=>{},["prevent"]))},{default:n(()=>[o(j,{label:"默认模式"},{default:n(()=>[o(i,{modelValue:m.value.mode,"onUpdate:modelValue":c[0]||(c[0]=Z=>m.value.mode=Z)},{default:n(()=>[o(U,{value:"local"},{default:n(()=>[...c[17]||(c[17]=[R("本地存储",-1)])]),_:1}),o(U,{value:"api",disabled:!M(G).apiAvailable},{default:n(()=>[...c[18]||(c[18]=[R("API存储",-1)])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),o(j,{label:"自动同步"},{default:n(()=>[o(me,{modelValue:m.value.autoSync,"onUpdate:modelValue":c[1]||(c[1]=Z=>m.value.autoSync=Z)},null,8,["modelValue"]),c[19]||(c[19]=a("div",{class:"form-help"},"启用后将定期自动同步数据",-1))]),_:1}),m.value.autoSync?(f(),F(j,{key:0,label:"同步间隔"},{default:n(()=>[o(re,{modelValue:m.value.syncInterval,"onUpdate:modelValue":c[2]||(c[2]=Z=>m.value.syncInterval=Z),min:1,max:60,"controls-position":"right"},null,8,["modelValue"]),c[20]||(c[20]=a("span",{class:"input-suffix"},"分钟",-1))]),_:1})):L("",!0),o(j,{label:"故障回退"},{default:n(()=>[o(me,{modelValue:m.value.fallbackToLocal,"onUpdate:modelValue":c[3]||(c[3]=Z=>m.value.fallbackToLocal=Z)},null,8,["modelValue"]),c[21]||(c[21]=a("div",{class:"form-help"},"API失败时自动回退到本地存储",-1))]),_:1}),o(j,{label:"显示指示器"},{default:n(()=>[o(me,{modelValue:m.value.showModeIndicator,"onUpdate:modelValue":c[4]||(c[4]=Z=>m.value.showModeIndicator=Z)},null,8,["modelValue"]),c[22]||(c[22]=a("div",{class:"form-help"},"在界面上显示当前存储模式",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(pe,{modelValue:p.value,"onUpdate:modelValue":c[8]||(c[8]=Z=>p.value=Z),title:"数据同步",width:"400px","close-on-click-modal":!1,"show-close":!1},{default:n(()=>[a("div",so,[o(Te,{percentage:h.value,status:k.value,"stroke-width":8},null,8,["percentage","status"]),a("p",to,z(S.value),1)])]),_:1},8,["modelValue"])])):L("",!0)}}}),oo=ve(ao,[["__scopeId","data-v-986484a7"]]),no={xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",fill:"currentColor"},ro=ce({__name:"IconHelpCenter",setup(s){return(e,t)=>(f(),V("svg",no,[...t[0]||(t[0]=[a("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"},null,-1)])]))}}),lo={key:0,class:"help-center-container"},io=ce({__name:"HelpCenter",setup(s){const e=as(),t=he(),r=W(()=>t.isAdmin||t.isSuperAdmin),u=()=>{e.push("/help-center")};return(l,p)=>{const h=y("el-tooltip");return r.value?(f(),V("div",lo,[o(h,{content:"帮助中心",placement:"bottom"},{default:n(()=>[a("div",{class:"help-center-button",onClick:u},[o(ro)])]),_:1})])):L("",!0)}}}),co=ve(io,[["__scopeId","data-v-2fd152c7"]]),se={getSubscriptions:()=>ee.get("/message/subscriptions"),updateSubscription:(s,e)=>ee.put(`/message/subscriptions/${s}`,e),getDepartmentSubscriptions:s=>{const e=s?{departmentId:s}:{};return ee.get("/message/subscriptions/departments",{params:e})},updateDepartmentSubscription:(s,e,t)=>ee.put(`/message/subscriptions/${s}/departments/${e}`,t),batchUpdateDepartmentSubscriptions:(s,e)=>ee.put(`/message/subscriptions/${s}/departments/batch`,{configs:e}),getAnnouncements:s=>ee.get("/message/announcements",{params:s}),createAnnouncement:s=>ee.post("/message/announcements",s),updateAnnouncement:(s,e)=>ee.put(`/message/announcements/${s}`,e),deleteAnnouncement:s=>ee.delete(`/message/announcements/${s}`),publishAnnouncement:s=>ee.post(`/message/announcements/${s}/publish`),getConfigs:()=>ee.get("/message/configs"),updateConfig:(s,e)=>ee.put(`/message/configs/${s}`,e),testConfig:s=>ee.post(`/message/configs/${s}/test`),getSystemMessages:s=>ee.get("/message/system-messages",{params:s}),markMessageAsRead:s=>ee.put(`/message/system-messages/${s}/read`),markAllMessagesAsRead:()=>ee.put("/message/system-messages/read-all"),getMessageStats:()=>ee.get("/message/stats")},Un=Object.freeze(Object.defineProperty({__proto__:null,messageApi:se},Symbol.toStringTag,{value:"Module"})),Ds=Ss("message",()=>{const s=A([]),e=A([]),t=A([]),r=A([]),u=A(!1),l=W(()=>r.value.filter(_=>!_.isRead).length),p=W(()=>e.value.filter(_=>_.status==="published"&&_.isMarquee)),h=W(()=>e.value.filter(_=>_.status==="published"&&_.isPopup));return{subscriptions:s,announcements:e,configs:t,systemMessages:r,loading:u,unreadMessageCount:l,activeAnnouncements:p,popupAnnouncements:h,loadSubscriptions:()=>D(void 0,null,function*(){try{u.value=!0;const _=yield se.getSubscriptions();s.value=_.data.map(d=>{var c,N,J,q,Q;return Je(K({},d),{isGlobalEnabled:(N=(c=d.isGlobalEnabled)!=null?c:d.isSubscribed)!=null?N:!1,globalNotificationMethods:(q=(J=d.globalNotificationMethods)!=null?J:d.notificationMethods)!=null?q:[],departmentConfigs:(Q=d.departmentConfigs)!=null?Q:[]})})}catch(_){throw console.error("加载订阅设置失败:",_),_}finally{u.value=!1}}),updateSubscription:(_,d)=>D(void 0,null,function*(){try{const c=yield se.updateSubscription(_,d),N=s.value.findIndex(J=>J.id===_);return N!==-1&&(s.value[N]=K(K({},s.value[N]),d)),c}catch(c){throw console.error("更新订阅设置失败:",c),c}}),updateDepartmentSubscription:(_,d,c)=>D(void 0,null,function*(){try{const N=yield se.updateDepartmentSubscription(_,d,c),J=s.value.find(q=>q.id===_);if(J){const q=J.departmentConfigs.findIndex(Q=>Q.departmentId===d);q!==-1&&(J.departmentConfigs[q]=K(K({},J.departmentConfigs[q]),c))}return N}catch(N){throw console.error("更新部门订阅设置失败:",N),N}}),loadAnnouncements:_=>D(void 0,null,function*(){try{u.value=!0;const d=yield se.getAnnouncements(_);return e.value=d.data||[],d}catch(d){console.error("加载公告失败:",d),C.error("加载公告失败"),e.value=[]}finally{u.value=!1}}),createAnnouncement:_=>D(void 0,null,function*(){try{const d=yield se.createAnnouncement(_);return Array.isArray(e.value)||(e.value=[]),e.value.unshift(d.data),C.success("公告创建成功"),d.data}catch(d){throw console.error("创建公告失败:",d),C.error("创建公告失败"),d}}),updateAnnouncement:(_,d)=>D(void 0,null,function*(){try{const c=yield se.updateAnnouncement(_,d);Array.isArray(e.value)||(e.value=[]);const N=e.value.findIndex(J=>J.id===_);return N!==-1&&(e.value[N]=K(K({},e.value[N]),d)),C.success("公告更新成功"),c.data}catch(c){throw console.error("更新公告失败:",c),C.error("更新公告失败"),c}}),deleteAnnouncement:_=>D(void 0,null,function*(){try{if(yield se.deleteAnnouncement(_),!Array.isArray(e.value)){e.value=[];return}const d=e.value.findIndex(c=>c.id===_);d!==-1&&e.value.splice(d,1),C.success("公告删除成功")}catch(d){console.error("删除公告失败:",d),C.error("删除公告失败")}}),loadConfigs:()=>D(void 0,null,function*(){try{u.value=!0;const _=yield se.getConfigs();t.value=_.data}catch(_){console.error("加载配置失败:",_),C.error("加载配置失败")}finally{u.value=!1}}),updateConfig:(_,d)=>D(void 0,null,function*(){try{yield se.updateConfig(_,d);const c=t.value.findIndex(N=>N.id===_);c!==-1&&(t.value[c]=K(K({},t.value[c]),d)),C.success("配置更新成功")}catch(c){console.error("更新配置失败:",c),C.error("更新配置失败")}}),testConfig:_=>D(void 0,null,function*(){try{yield se.testConfig(_),C.success("配置测试成功")}catch(d){console.error("配置测试失败:",d),C.error("配置测试失败")}}),loadSystemMessages:_=>D(void 0,null,function*(){try{const d=yield se.getSystemMessages(_);return r.value=d.data,d}catch(d){console.error("加载系统消息失败:",d),C.error("加载系统消息失败")}}),markMessageAsRead:_=>D(void 0,null,function*(){try{yield se.markMessageAsRead(_);const d=r.value.find(c=>c.id===_);d&&(d.isRead=!0)}catch(d){console.error("标记消息已读失败:",d)}}),markAllMessagesAsRead:()=>D(void 0,null,function*(){try{yield se.markAllMessagesAsRead(),r.value.forEach(_=>{_.isRead=!0}),C.success("所有消息已标记为已读")}catch(_){console.error("标记所有消息已读失败:",_),C.error("标记消息已读失败")}}),markAnnouncementAsRead:_=>D(void 0,null,function*(){try{const d=e.value.find(c=>c.id===_);d&&(d.read=!0),C.success("已标记为已读")}catch(d){console.error("标记公告已读失败:",d),C.error("标记失败")}}),messageApi:se}}),uo={class:"message-bell-container"},mo={class:"message-header"},po={class:"header-stats"},fo={class:"header-actions"},go={class:"tab-label"},vo={class:"message-list"},ho=["onClick"],_o={class:"message-icon"},yo={class:"message-content"},wo={class:"message-title"},bo={class:"message-text"},Po={class:"message-meta"},So={class:"message-category"},Co={class:"message-time"},Ao={class:"message-actions"},ko={key:0,class:"empty-state"},To={class:"tab-label"},$o={class:"announcement-list"},Mo=["onClick"],Io={class:"announcement-icon"},xo={class:"announcement-content"},Do={class:"announcement-title"},Ro={class:"announcement-text"},Vo={class:"announcement-meta"},Uo={class:"announcement-time"},Lo={class:"announcement-author"},Eo={class:"announcement-actions"},zo={key:0,class:"empty-state"},No=ce({__name:"MessageBell",setup(s){const e=Is(),t=Ds(),r=he(),u=A(!1),l=A("messages"),p=W(()=>e.messages),h=W(()=>!t.announcements||!Array.isArray(t.announcements)?[]:t.announcements.filter(E=>E.status==="published")),k=W(()=>e.unreadCount),S=W(()=>h.value.filter(E=>!E.read).length),T=W(()=>k.value+S.value),Y=W(()=>p.value.length+h.value.length),G=()=>{u.value=!1},g=()=>D(this,null,function*(){try{e.markAllAsRead();for(const E of h.value)E.read||(yield $(E.id));C.success("所有消息已标记为已读")}catch(E){console.error("标记已读失败:",E),C.error("操作失败")}}),P=()=>D(this,null,function*(){try{yield es.confirm("确认清空所有消息吗？此操作不可恢复。","确认清空",{type:"warning"}),e.clearAllMessages(),C.success("消息已清空")}catch(E){E!=="cancel"&&console.error("清空消息失败:",E)}}),m=E=>{e.markAsRead(E)},w=E=>D(this,null,function*(){try{yield es.confirm("确认删除此消息吗？","确认删除",{type:"warning"}),e.deleteMessage(E),C.success("消息已删除")}catch(I){I!=="cancel"&&console.error("删除消息失败:",I)}}),$=E=>D(this,null,function*(){try{const I=h.value.find(_=>_.id===E);I&&(I.read=!0)}catch(I){console.error("标记公告已读失败:",I)}}),b=E=>{E.read||m(E.id),E.actionUrl&&console.log("跳转到:",E.actionUrl)},O=E=>{E.read||$(E.id),es.alert(E.content,E.title,{confirmButtonText:"确定",type:"info"})};return Ee(()=>{r.isLoggedIn&&t.loadAnnouncements()}),(E,I)=>{const _=y("el-icon"),d=y("el-badge"),c=y("el-tag"),N=y("el-button"),J=y("el-empty"),q=y("el-tab-pane"),Q=y("el-tabs"),be=y("el-dialog");return f(),V("div",uo,[a("div",{class:"message-bell",onClick:I[0]||(I[0]=B=>u.value=!0)},[o(d,{value:T.value>99?"99+":T.value,hidden:T.value===0},{default:n(()=>[o(_,{size:20,class:"bell-icon"},{default:n(()=>[o(M($s))]),_:1})]),_:1},8,["value","hidden"])]),o(be,{modelValue:u.value,"onUpdate:modelValue":I[2]||(I[2]=B=>u.value=B),title:"消息中心",width:"700px","before-close":G,class:"message-dialog"},{default:n(()=>[a("div",mo,[a("div",po,[o(c,{type:"info",size:"small"},{default:n(()=>[R(" 共 "+z(Y.value)+" 条 ",1)]),_:1}),T.value>0?(f(),F(c,{key:0,type:"danger",size:"small"},{default:n(()=>[R(z(T.value)+" 条未读 ",1)]),_:1})):L("",!0)]),a("div",fo,[T.value>0?(f(),F(N,{key:0,type:"primary",size:"small",onClick:g},{default:n(()=>[...I[3]||(I[3]=[R(" 全部已读 ",-1)])]),_:1})):L("",!0),o(N,{type:"danger",size:"small",onClick:P},{default:n(()=>[...I[4]||(I[4]=[R(" 清空消息 ",-1)])]),_:1})])]),o(Q,{modelValue:l.value,"onUpdate:modelValue":I[1]||(I[1]=B=>l.value=B),class:"message-tabs"},{default:n(()=>[o(q,{label:"系统消息",name:"messages"},{label:n(()=>[a("div",go,[o(_,null,{default:n(()=>[o(M(tt))]),_:1}),I[5]||(I[5]=a("span",null,"系统消息",-1)),k.value>0?(f(),F(d,{key:0,value:k.value>99?"99+":k.value,class:"tab-badge"},null,8,["value"])):L("",!0)])]),default:n(()=>[a("div",vo,[(f(!0),V(ye,null,ke(p.value,B=>(f(),V("div",{key:B.id,class:te(["message-item",{unread:!B.read}]),onClick:ue=>b(B)},[a("div",_o,[o(_,{color:B.color,size:20},{default:n(()=>[(f(),F(De(B.icon)))]),_:2},1032,["color"])]),a("div",yo,[a("div",wo,[R(z(B.title)+" ",1),B.read?L("",!0):(f(),F(c,{key:0,type:"danger",size:"small"},{default:n(()=>[...I[6]||(I[6]=[R("未读",-1)])]),_:1}))]),a("div",bo,z(B.content),1),a("div",Po,[a("span",So,z(B.category),1),a("span",Co,z(B.time),1)])]),a("div",Ao,[B.read?L("",!0):(f(),F(N,{key:0,type:"primary",size:"small",onClick:Ge(ue=>m(B.id),["stop"])},{default:n(()=>[...I[7]||(I[7]=[R(" 已读 ",-1)])]),_:1},8,["onClick"])),o(N,{type:"danger",size:"small",onClick:Ge(ue=>w(B.id),["stop"])},{default:n(()=>[...I[8]||(I[8]=[R(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,ho))),128)),p.value.length===0?(f(),V("div",ko,[o(J,{description:"暂无系统消息"})])):L("",!0)])]),_:1}),o(q,{label:"系统公告",name:"announcements"},{label:n(()=>[a("div",To,[o(_,null,{default:n(()=>[o(M(hs))]),_:1}),I[9]||(I[9]=a("span",null,"系统公告",-1)),S.value>0?(f(),F(d,{key:0,value:S.value>99?"99+":S.value,class:"tab-badge"},null,8,["value"])):L("",!0)])]),default:n(()=>[a("div",$o,[(f(!0),V(ye,null,ke(h.value,B=>(f(),V("div",{key:B.id,class:te(["announcement-item",{unread:!B.read}]),onClick:ue=>O(B)},[a("div",Io,[o(_,{color:"#409eff",size:20},{default:n(()=>[o(M(hs))]),_:1})]),a("div",xo,[a("div",Do,[R(z(B.title)+" ",1),B.read?L("",!0):(f(),F(c,{key:0,type:"danger",size:"small"},{default:n(()=>[...I[10]||(I[10]=[R("未读",-1)])]),_:1})),o(c,{type:B.type==="company"?"primary":"success",size:"small"},{default:n(()=>[R(z(B.type==="company"?"全公司":"部门"),1)]),_:2},1032,["type"])]),a("div",Ro,z(B.content),1),a("div",Vo,[a("span",Uo,z(B.publishedAt),1),a("span",Lo,z(B.createdBy),1)])]),a("div",Eo,[B.read?L("",!0):(f(),F(N,{key:0,type:"primary",size:"small",onClick:Ge(ue=>$(B.id),["stop"])},{default:n(()=>[...I[11]||(I[11]=[R(" 已读 ",-1)])]),_:1},8,["onClick"]))])],10,Mo))),128)),h.value.length===0?(f(),V("div",zo,[o(J,{description:"暂无系统公告"})])):L("",!0)])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}}),Oo=ve(No,[["__scopeId","data-v-599f1f5a"]]),Bo={key:0,class:"announcement-carousel"},Ho={class:"carousel-container"},Fo={class:"announcement-icon"},Go={class:"carousel-content"},qo=["onClick"],jo={class:"announcement-title"},Wo={class:"announcement-time"},Yo={class:"carousel-actions"},Jo={key:0,class:"announcement-detail"},Ko={class:"detail-meta"},Xo={class:"publish-time"},Zo=["innerHTML"],Qo={key:0,class:"target-departments"},en=ce({__name:"AnnouncementCarousel",setup(s){const e=Ds(),t=he(),r=A(),u=A(!1),l=A(!1),p=A(null),h=A(new Set),k=W(()=>!e.announcements||!Array.isArray(e.announcements)?[]:e.announcements.filter(b=>b.status==="published"&&b.isMarquee&&!h.value.has(b.id)&&S(b)).sort((b,O)=>new Date(O.publishedAt||O.publishTime).getTime()-new Date(b.publishedAt||b.publishTime).getTime()).slice(0,5)),S=b=>{const O=new Date,E=new Date(b.publishedAt||b.publishTime);if(b.status==="scheduled"&&b.scheduledAt&&new Date(b.scheduledAt)>O)return!1;const I=new Date(E.getTime()+30*24*60*60*1e3);return O<=I},T=b=>{p.value=b,l.value=!0},Y=()=>{r.value&&(u.value?r.value.play():r.value.pause(),u.value=!u.value)},G=()=>{k.value.forEach(b=>{h.value.add(b.id)}),localStorage.setItem("closedAnnouncementIds",JSON.stringify([...h.value]))},g=()=>D(this,null,function*(){if(p.value)try{yield e.markAnnouncementAsRead(p.value.id),C.success("已标记为已读"),l.value=!1}catch(b){C.error("标记失败，请重试")}}),P=b=>{const O=new Date(b),I=new Date().getTime()-O.getTime();return I<60*1e3?"刚刚":I<60*60*1e3?`${Math.floor(I/(60*1e3))}分钟前`:I<24*60*60*1e3?`${Math.floor(I/(60*60*1e3))}小时前`:O.toLocaleDateString()},m=b=>new Date(b).toLocaleString(),w=b=>({company:"danger",department:"warning",system:"info"})[b]||"info",$=b=>({company:"全公司",department:"部门",system:"系统"})[b]||"未知";return Ee(()=>{const b=localStorage.getItem("closedAnnouncementIds");if(b)try{const O=JSON.parse(b);h.value=new Set(O)}catch(O){console.warn("Failed to parse closed announcement IDs:",O)}t.isLoggedIn&&e.loadAnnouncements()}),os(()=>{localStorage.setItem("closedAnnouncementIds",JSON.stringify([...h.value]))}),(b,O)=>{var J;const E=y("el-icon"),I=y("el-carousel-item"),_=y("el-carousel"),d=y("el-button"),c=y("el-tag"),N=y("el-dialog");return k.value.length>0?(f(),V("div",Bo,[a("div",Ho,[a("div",Fo,[o(E,{size:16,color:"#f56c6c"},{default:n(()=>[o(M($s))]),_:1})]),a("div",Go,[o(_,{ref_key:"carouselRef",ref:r,height:"32px",autoplay:!0,interval:5e3,loop:!0,"show-indicators":!1,arrow:k.value.length>1?"hover":"never",direction:"vertical",class:"announcement-slider"},{default:n(()=>[(f(!0),V(ye,null,ke(k.value,q=>(f(),F(I,{key:q.id,class:"carousel-item"},{default:n(()=>[a("div",{class:"announcement-item",onClick:Q=>T(q)},[a("span",jo,z(q.title),1),a("span",Wo,z(P(q.publishedAt||q.publishTime)),1)],8,qo)]),_:2},1024))),128))]),_:1},8,["arrow"])]),a("div",Yo,[k.value.length>1?(f(),F(d,{key:0,type:"text",size:"small",onClick:Y,class:"pause-btn"},{default:n(()=>[o(E,{size:12},{default:n(()=>[(f(),F(De(u.value?"VideoPlay":"VideoPause")))]),_:1})]),_:1})):L("",!0),o(d,{type:"text",size:"small",onClick:G,class:"close-btn"},{default:n(()=>[o(E,{size:12},{default:n(()=>[o(M(at))]),_:1})]),_:1})])]),o(N,{modelValue:l.value,"onUpdate:modelValue":O[1]||(O[1]=q=>l.value=q),title:(J=p.value)==null?void 0:J.title,width:"600px",class:"announcement-dialog"},{footer:n(()=>[o(d,{onClick:O[0]||(O[0]=q=>l.value=!1)},{default:n(()=>[...O[3]||(O[3]=[R("关闭",-1)])]),_:1}),p.value&&!p.value.read?(f(),F(d,{key:0,type:"primary",onClick:g},{default:n(()=>[...O[4]||(O[4]=[R(" 标记已读 ",-1)])]),_:1})):L("",!0)]),default:n(()=>{var q;return[p.value?(f(),V("div",Jo,[a("div",Ko,[o(c,{type:w(p.value.type)},{default:n(()=>[R(z($(p.value.type)),1)]),_:1},8,["type"]),a("span",Xo," 发布时间："+z(m(p.value.publishedAt||p.value.publishTime)),1)]),a("div",{class:"detail-content",innerHTML:p.value.content},null,8,Zo),(q=p.value.targetDepartments)!=null&&q.length?(f(),V("div",Qo,[O[2]||(O[2]=a("span",{class:"label"},"目标部门：",-1)),(f(!0),V(ye,null,ke(p.value.targetDepartments,Q=>(f(),F(c,{key:Q,size:"small",class:"dept-tag"},{default:n(()=>[R(z(Q),1)]),_:2},1024))),128))])):L("",!0)])):L("",!0)]}),_:1},8,["modelValue","title"])])):L("",!0)}}}),sn=ve(en,[["__scopeId","data-v-b05febc7"]]),ne={xs:480,sm:768,md:992,lg:1200,xl:1920},ys=s=>s<ne.sm?"mobile":s<ne.lg?"tablet":"desktop",ws=s=>s<ne.xs?"xs":s<ne.sm?"sm":s<ne.md?"md":s<ne.lg?"lg":"xl",tn=()=>{const s=A(window.innerWidth),e=A(window.innerHeight),t=A(ys(s.value)),r=A(ws(s.value)),u=A(t.value==="mobile"),l=A(t.value==="tablet"),p=A(t.value==="desktop"),h=()=>{s.value=window.innerWidth,e.value=window.innerHeight,t.value=ys(s.value),r.value=ws(s.value),u.value=t.value==="mobile",l.value=t.value==="tablet",p.value=t.value==="desktop"};return Ee(()=>{window.addEventListener("resize",h),h()}),os(()=>{window.removeEventListener("resize",h)}),{windowWidth:s,windowHeight:e,deviceType:t,screenSize:r,isMobile:u,isTablet:l,isDesktop:p,isXs:()=>r.value==="xs",isSm:()=>r.value==="sm",isMd:()=>r.value==="md",isLg:()=>r.value==="lg",isXl:()=>r.value==="xl",gtXs:()=>s.value>ne.xs,gtSm:()=>s.value>ne.sm,gtMd:()=>s.value>ne.md,gtLg:()=>s.value>ne.lg,ltSm:()=>s.value<ne.sm,ltMd:()=>s.value<ne.md,ltLg:()=>s.value<ne.lg,ltXl:()=>s.value<ne.xl}},bs=(s,e)=>{let t=null;return(...r)=>{t&&clearTimeout(t),t=setTimeout(()=>{s(...r)},e)}};class an{constructor(){oe(this,"timerId",null);oe(this,"reminderCount",0);oe(this,"lastReminderDate","");oe(this,"config",{enabled:!0,minInterval:2*60*60*1e3,maxInterval:6*60*60*1e3,maxRemindersPerDay:3});oe(this,"onReminderCallback",null)}startReminder(e,t){!this.config.enabled||!e||(this.onReminderCallback=t,this.resetDailyCountIfNeeded(),!(this.reminderCount>=this.config.maxRemindersPerDay)&&this.scheduleNextReminder(e))}stopReminder(){this.timerId&&(clearTimeout(this.timerId),this.timerId=null),this.onReminderCallback=null}scheduleNextReminder(e){if(!_e.needsPasswordReminder(e))return;const t=Math.floor(Math.random()*(this.config.maxInterval-this.config.minInterval)+this.config.minInterval);this.timerId=window.setTimeout(()=>{this.handleReminder(e)},t),console.log(`下次密码提醒将在 ${Math.round(t/1e3/60)} 分钟后触发`)}handleReminder(e){if(this.resetDailyCountIfNeeded(),this.reminderCount>=this.config.maxRemindersPerDay){console.log("今日密码提醒次数已达上限");return}if(!_e.needsPasswordReminder(e))return;const t=`password_reminder_${e.id}_${new Date().toDateString()}`;localStorage.getItem(t)==="true"||this.onReminderCallback&&(this.onReminderCallback(),this.reminderCount++,this.saveReminderState()),this.scheduleNextReminder(e)}resetDailyCountIfNeeded(){const e=new Date().toDateString();this.lastReminderDate!==e&&(this.reminderCount=0,this.lastReminderDate=e,this.saveReminderState())}saveReminderState(){const e={reminderCount:this.reminderCount,lastReminderDate:this.lastReminderDate};localStorage.setItem("passwordReminderState",JSON.stringify(e))}loadReminderState(){try{const e=localStorage.getItem("passwordReminderState");if(e){const t=JSON.parse(e);this.reminderCount=t.reminderCount||0,this.lastReminderDate=t.lastReminderDate||""}}catch(e){console.error("加载密码提醒状态失败:",e)}}updateConfig(e){this.config=K(K({},this.config),e)}getConfig(){return K({},this.config)}getTodayReminderCount(){return this.resetDailyCountIfNeeded(),this.reminderCount}init(){this.loadReminderState(),this.resetDailyCountIfNeeded()}}const Xe=new an,on=[{id:"dashboard",title:"数据看板",icon:"Odometer",path:"/dashboard",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["dashboard"],dataScope:"all"},{id:"customer",title:"客户管理",icon:"User",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer"],children:[{id:"customer-list",title:"客户列表",path:"/customer/list",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer:list"],dataScope:"department"},{id:"customer-add",title:"新增客户",path:"/customer/add",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer:add"]},{id:"customer-groups",title:"客户分组",path:"/customer/groups",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer:groups"]},{id:"customer-tags",title:"客户标签",path:"/customer/tags",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer:tags"]}]},{id:"order",title:"订单管理",icon:"ShoppingCart",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["order"],children:[{id:"order-list",title:"订单列表",path:"/order/list",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["order:list"],dataScope:"department"},{id:"order-add",title:"新增订单",path:"/order/add",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["order:add"]},{id:"order-audit",title:"订单审核",path:"/order/audit",roles:["super_admin","admin","department_manager"],permissions:["order:audit"]}]},{id:"service-management",title:"服务管理",icon:"IconCustomerService",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["service"],children:[{id:"service-call",title:"通话管理",path:"/service-management/call",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["service:call"]},{id:"service-sms",title:"短信管理",path:"/service-management/sms",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["service:sms"]}]},{id:"performance",title:"业绩统计",icon:"TrendCharts",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance"],children:[{id:"performance-personal",title:"个人业绩",path:"/performance/personal",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance:personal"],dataScope:"self"},{id:"performance-team",title:"团队业绩",path:"/performance/team",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance:team"],dataScope:"department"},{id:"performance-analysis",title:"业绩分析",path:"/performance/analysis",roles:["super_admin","admin","department_manager"],permissions:["performance:analysis"],dataScope:"department"},{id:"performance-share",title:"业绩分享",path:"/performance/share",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance:share"]}]},{id:"logistics",title:"物流管理",icon:"Van",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["logistics"],children:[{id:"logistics-shipping",title:"发货列表",path:"/logistics/shipping",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["logistics:shipping"]},{id:"logistics-list",title:"物流列表",path:"/logistics/list",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["logistics:list"]},{id:"logistics-track",title:"物流跟踪",path:"/logistics/track",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["logistics:tracking"]},{id:"logistics-status-update",title:"状态更新",path:"/logistics/status-update",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["logistics:status"]},{id:"logistics-companies",title:"物流公司",path:"/logistics/companies",roles:["super_admin","admin","department_manager"],permissions:["logistics:companies"]}]},{id:"service",title:"售后管理",icon:"IconHeadset",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["aftersale"],children:[{id:"service-list",title:"售后订单",path:"/service/list",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["aftersale:order"],dataScope:"department"},{id:"service-add",title:"新建售后",path:"/service/add",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["aftersale:add"]},{id:"service-data",title:"售后数据",path:"/service/data",roles:["super_admin","admin","department_manager"],permissions:["aftersale:analysis"],dataScope:"department"}]},{id:"data",title:"资料管理",icon:"Files",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["data"],children:[{id:"data-list",title:"资料列表",path:"/data/list",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["data:list"]},{id:"data-search",title:"客户查询",path:"/data/search",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["data:customer"]},{id:"data-recycle",title:"回收站",path:"/data/recycle",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["data:recycle"]}]},{id:"product",title:"商品管理",icon:"Box",roles:["super_admin","admin"],permissions:["sales:product"],children:[{id:"product-list",title:"商品列表",path:"/product/list",roles:["super_admin","admin"],permissions:["sales:product:view"]},{id:"product-add",title:"新增商品",path:"/product/add",roles:["super_admin","admin"],permissions:["sales:product:add"]},{id:"product-inventory",title:"库存管理",path:"/product/inventory",roles:["super_admin","admin"],permissions:["sales:product:edit"]},{id:"product-analytics",title:"商品分析",path:"/product/analytics",roles:["super_admin","admin"],permissions:["product:analytics"]}]},{id:"system",title:"系统管理",icon:"Setting",roles:["super_admin","admin"],permissions:["system"],children:[{id:"system-departments",title:"部门管理",path:"/system/departments",roles:["super_admin","admin"],permissions:["system:department"]},{id:"system-users",title:"用户管理",path:"/system/users",roles:["super_admin","admin"],permissions:["system:user"]},{id:"system-roles",title:"角色权限",path:"/system/roles",roles:["super_admin","admin"],permissions:["system:role"]},{id:"system-permissions",title:"权限管理",path:"/system/permissions",roles:["super_admin","admin"],permissions:["system:permission"]},{id:"system-settings",title:"系统设置",path:"/system/settings",roles:["super_admin","admin"],permissions:["system:settings"]},{id:"system-super-admin-panel",title:"超管面板",path:"/system/super-admin-panel",roles:["super_admin"],permissions:["system:admin"]},{id:"system-customer-service-permissions",title:"客服管理",path:"/system/customer-service-permissions",roles:["super_admin","admin"],permissions:["customer_service:manage"]}]}];function nn(s,e,t){return s.hidden?!1:e==="super_admin"||t.includes("*")?!0:s.roles&&s.roles.length>0&&!s.roles.includes(e)?!1:s.permissions&&s.permissions.length>0?s.requireAll?s.permissions.every(r=>t.includes(r)):s.permissions.some(r=>t.includes(r)):!0}function Rs(s,e,t){const r=[];for(const u of s)if(nn(u,e,t)){const l=K({},u);if(u.children&&u.children.length>0){const p=Rs(u.children,e,t);p.length>0&&(l.children=p,r.push(l))}else r.push(l)}return r}function rn(s){const e=he();if(!e.currentUser)return[];const t=e.currentUser.role,r=e.permissions;return t==="super_admin"||t==="admin"||r.includes("*")?s:Rs(s,t,r)}const ln=ce({__name:"DynamicMenu",props:{collapse:{type:Boolean,default:!1},uniqueOpened:{type:Boolean,default:!0},router:{type:Boolean,default:!0}},emits:["select","open"],setup(s,{emit:e}){const t={Odometer:it,User:xe,ShoppingCart:lt,TrendCharts:Ms,Van:rt,Files:nt,Box:ot,Setting:ss,IconCustomerService:xe,IconHeadset:xe},r=e,u=As();he();const l=W(()=>u.path),p=W(()=>rn(on)),h=T=>typeof T=="string"?t[T]||xe:T,k=T=>{r("select",T)},S=T=>{r("open",T)};return(T,Y)=>{const G=y("el-icon"),g=y("el-menu-item"),P=y("el-sub-menu"),m=y("el-menu");return f(),F(m,{"default-active":l.value,class:"sidebar-menu",collapse:s.collapse,"unique-opened":s.uniqueOpened,router:s.router,onSelect:k,onOpen:S},{default:n(()=>[(f(!0),V(ye,null,ke(p.value,w=>(f(),V(ye,{key:w.id},[w.children&&w.children.length>0?(f(),F(P,{key:0,index:w.id},{title:n(()=>[w.icon?(f(),F(G,{key:0},{default:n(()=>[(f(),F(De(h(w.icon))))]),_:2},1024)):L("",!0),a("span",null,z(w.title),1)]),default:n(()=>[(f(!0),V(ye,null,ke(w.children,$=>(f(),V(ye,{key:$.id},[$.path?(f(),F(g,{key:0,index:$.path},{default:n(()=>[R(z($.title),1)]),_:2},1032,["index"])):L("",!0)],64))),128))]),_:2},1032,["index"])):w.path?(f(),F(g,{key:1,index:w.path},{title:n(()=>[R(z(w.title),1)]),default:n(()=>[w.icon?(f(),F(G,{key:0},{default:n(()=>[(f(),F(De(h(w.icon))))]),_:2},1024)):L("",!0)]),_:2},1032,["index"])):L("",!0)],64))),128))]),_:1},8,["default-active","collapse","unique-opened","router"])}}}),dn=ve(ln,[["__scopeId","data-v-24718ca6"]]),cn={class:"app-container"},un={key:0,class:"login-layout"},mn={class:"header-left"},pn={class:"logo"},fn={class:"header-right"},gn={class:"user-info"},vn={class:"tabs-container"},hn={class:"tabs-actions"},_n={class:"page-content"},yn=ce({__name:"App",setup(s){const e=As(),t=as(),r=he(),u=Pt(),l=pt(),p=xs(),h=Is(),k=ft(),S=ms(t),T=A(!1),{isMobile:Y}=tn(),G=A(!1),g=A(!1),P=A(!1),m=A(!1),w=A(!1),$=A(0),b=A(""),O=A(!1),E=W(()=>e.path==="/login"||!r.token),I=W(()=>Y.value?T.value?"0px":"240px":T.value?"64px":"260px"),_=W(()=>e.path),d=W({get:()=>u.activeTab,set:v=>u.setActiveTab(v)}),c=W(()=>u.tabs),N=W(()=>u.cachedViews),J=()=>{T.value=!T.value},q=()=>{Y.value&&!T.value&&(T.value=!0)},Q=v=>{const x=d.value;u.removeTab(v),x===v&&d.value!==v&&S.push(d.value)},be=bs(v=>{S.push(v.props.name)},300),B=v=>{switch(v){case"profile":ue();break;case"password":U();break;case"logout":i();break}},ue=()=>{O.value=!0},U=()=>{G.value=!0},i=()=>D(this,null,function*(){try{yield es.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),r.logout(),u.clearTabs(),C.success("退出登录成功"),S.push("/login")}catch(v){}}),j=v=>{switch(v){case"closeOthers":u.closeOtherTabs(d.value);break;case"closeAll":u.closeAllTabs(),S.push("/dashboard");break}},me=bs(v=>{if(console.log("菜单选择:",v),console.log("当前路径:",e.path),console.log("用户权限:",r.isAdmin,r.isManager),(v.startsWith("/system/")||v==="system")&&pe(),v&&v.startsWith("/")){if(v.startsWith("/system/")){if(v==="/system/super-admin-panel"&&!r.isSuperAdmin){C.warning("您没有超级管理员权限，无法访问此页面");return}else if(v!=="/system/super-admin-panel"&&!r.isAdmin){C.warning("您没有权限访问此页面，请联系管理员");return}}S.push(v).catch(x=>{console.error("菜单导航失败:",x),C.error(`页面导航失败: ${x.message||"未知错误"}`)})}},300),re=v=>{console.log("子菜单展开:",v),ae(v)},ae=v=>{console.log("开始智能滚动定位:",v),vs(()=>{const x=document.querySelector(".sidebar-menu"),fe=document.querySelector(`.sidebar-menu .el-sub-menu[index="${v}"]`);if(!x||!fe){console.log("未找到菜单元素:",{sidebarMenu:!!x,targetSubMenu:!!fe});return}const de=(ie=0)=>{setTimeout(()=>{const $e=x.clientHeight,Se=x.scrollTop,Ve=fe.offsetTop,Ue=fe.offsetHeight,je=x.scrollHeight-$e;if(console.log("滚动计算参数:",{attempt:ie,menuHeight:$e,menuScrollTop:Se,targetMenuTop:Ve,targetMenuHeight:Ue,maxScrollTop:je,scrollHeight:x.scrollHeight}),Ue<50&&ie<5){console.log("子菜单可能还在展开中，继续等待..."),de(ie+1);return}const Be=Ve-Se,We=Be+Ue;console.log("视口位置:",{menuTopInViewport:Be,menuBottomInViewport:We,viewportHeight:$e});const He=10,Fe=20;let X=Se,Ye=!1;Be<He?(X=Ve-He,Ye=!0,console.log("需要向上滚动")):We>$e-Fe&&(X=Ve+Ue-$e+Fe,Ye=!0,console.log("需要向下滚动")),X=Math.max(0,Math.min(X,je)),console.log("滚动决策:",{needScroll:Ye,currentScrollTop:Se,targetScrollTop:X,scrollDiff:Math.abs(X-Se)}),Ye&&Math.abs(X-Se)>2?(console.log("执行滚动到:",X),x.scrollTo({top:X,behavior:"smooth"})):console.log("无需滚动或滚动距离太小")},ie===0?100:200)};de()})},pe=()=>{ae("system")},Te=()=>{vs(()=>{const v=document.querySelector(".sidebar-menu");v?(console.log("初始化侧边栏滚轮事件"),v.addEventListener("wheel",Z,{passive:!1})):console.log("未找到侧边栏菜单元素")})},Z=v=>{v.preventDefault(),v.stopPropagation();const x=v.currentTarget,fe=80,de=x.scrollTop,ie=x.scrollHeight-x.clientHeight;console.log("鼠标滚轮事件:",{deltaY:v.deltaY,currentScrollTop:de,maxScrollTop:ie,scrollHeight:x.scrollHeight,clientHeight:x.clientHeight});const Oe=v.deltaY>0?de+fe:de-fe,Re=Math.max(0,Math.min(Oe,ie));console.log("滚动到:",Re),x.scrollTo({top:Re,behavior:"smooth"})},Pe=v=>{v.preventDefault()},le=()=>{const v=r.user;if(v&&!r.isSuperAdmin){if(_e.initializeUserPasswordInfo(v.id),m.value=v.isDefaultPassword||!1,w.value=_e.isPasswordExpired(v),P.value=v.forcePasswordChange||!1,$.value=_e.getPasswordRemainingDays(v),b.value=`password_reminder_${v.id}_${new Date().toDateString()}`,m.value||w.value||P.value){G.value=!0,P.value=!1;return}_e.needsPasswordReminder(v)&&(localStorage.getItem(b.value)==="true"||(g.value=!0))}},ze=()=>{C.success("密码修改成功"),G.value=!1,P.value=!1,setTimeout(()=>{le()},1e3)},Ne=()=>{O.value=!1},ns=()=>{g.value=!1},H=()=>{g.value=!1,G.value=!0},fs=v=>{v&&localStorage.setItem(b.value,"true"),g.value=!1};we(e,v=>{var x;v.path!=="/login"&&((x=v.meta)!=null&&x.title)&&u.addTab({name:v.path,title:v.meta.title,component:v.name})},{immediate:!0});const Vs=()=>{const v=r.user;!v||r.isSuperAdmin||Xe.startReminder(v,()=>{if(_e.needsPasswordReminder(v)){const x=`password_reminder_${v.id}_${new Date().toDateString()}`;localStorage.getItem(x)==="true"||(g.value=!0)}})},Us=()=>{Xe.stopReminder()};we(()=>r.isLoggedIn,v=>{v&&r.user?(le(),Vs()):Us()},{immediate:!0}),Ee(()=>{q(),p.initConfig(),Xe.init(),l.initNetworkListener(),Es(),Ls(),Te(),setTimeout(()=>{r.user&&!E.value&&le()},1e3),setTimeout(()=>{var v,x;console.log("=== 用户权限调试信息 ==="),console.log("当前用户:",r.user),console.log("用户角色:",(v=r.user)==null?void 0:v.role),console.log("用户UserRole:",(x=r.user)==null?void 0:x.userRole),console.log("isAdmin:",r.isAdmin),console.log("isSuperAdmin:",r.isSuperAdmin),console.log("isLoggedIn:",r.isLoggedIn),console.log("token:",r.token?"已设置":"未设置"),console.log("========================")},2e3)});let qe=null;const Ls=()=>{k.checkAndTransferOrders(),qe=window.setInterval(()=>{k.checkAndTransferOrders()},3e4)};os(()=>{Xe.stopReminder();const v=document.querySelector(".sidebar-menu");v&&v.removeEventListener("wheel",Z),qe&&(clearInterval(qe),qe=null)});const Es=()=>{const{MessageType:v}=h;h.sendMessage(v.ORDER_SIGNED,"客户张三的订单 #20240120001 已成功签收，请及时跟进后续服务。",{relatedId:"20240120001",relatedType:"order"}),h.sendMessage(v.AUDIT_REJECTED,"订单 #20240120002 审核被拒绝，原因：商品信息不完整，请重新提交。",{relatedId:"20240120002",relatedType:"order"}),h.sendMessage(v.ORDER_SHIPPED,"订单 #20240120003 已从仓库发出，物流单号：SF1234567890，预计2-3天到达。",{relatedId:"20240120003",relatedType:"order"}),h.sendMessage(v.PACKAGE_ANOMALY,"订单 #20240120004 的包裹在运输过程中出现异常，请联系物流公司处理。",{relatedId:"20240120004",relatedType:"order"}),h.sendMessage(v.CUSTOMER_CALL,"客户李四（手机：138****5678）来电咨询订单进度，请及时回复。",{relatedId:"customer_001",relatedType:"customer"}),setTimeout(()=>{const x=h.messages;x.length>=3&&h.markAsRead(x[2].id)},100)};return we(Y,v=>{v&&!T.value&&(T.value=!0)}),(v,x)=>{var Fe;const fe=y("router-view"),de=y("el-icon"),ie=y("el-dropdown-item"),Oe=y("el-dropdown-menu"),Re=y("el-dropdown"),$e=y("el-header"),Se=y("el-aside"),Ve=y("el-tab-pane"),Ue=y("el-tabs"),je=y("More"),Be=y("el-button"),We=y("el-main"),He=y("el-container");return f(),V("div",cn,[o(It,{visible:M(l).globalLoading,text:M(l).globalLoadingText,progress:M(l).globalLoadingProgress,"show-progress":M(l).globalLoadingProgress>=0},null,8,["visible","text","progress","show-progress"]),E.value?(f(),V("div",un,[o(zt,null,{default:n(()=>[o(fe)]),_:1})])):(f(),F(He,{key:1,class:"layout-container"},{default:n(()=>[o($e,{class:"header"},{default:n(()=>[a("div",mn,[o(de,{class:"menu-toggle",onClick:J},{default:n(()=>[o(M(dt))]),_:1}),a("div",pn,[o(de,null,{default:n(()=>[o(M(Ms))]),_:1}),x[3]||(x[3]=a("span",{class:"logo-text"},"智能销售CRM",-1))])]),a("div",fn,[o(oo),o(co),o(Oo),o(Re,{onCommand:B},{dropdown:n(()=>[o(Oe,null,{default:n(()=>[o(ie,{command:"profile"},{default:n(()=>[...x[4]||(x[4]=[R("个人设置",-1)])]),_:1}),o(ie,{command:"password"},{default:n(()=>[...x[5]||(x[5]=[R("修改密码",-1)])]),_:1}),o(ie,{divided:"",command:"logout"},{default:n(()=>[...x[6]||(x[6]=[R("退出登录",-1)])]),_:1})]),_:1})]),default:n(()=>{var X;return[a("span",gn,[o(de,null,{default:n(()=>[o(M(xe))]),_:1}),R(" "+z(((X=M(r).user)==null?void 0:X.name)||"管理员")+" ",1),o(de,null,{default:n(()=>[o(M(Ts))]),_:1})])]}),_:1})])]),_:1}),o(sn),o(He,null,{default:n(()=>[o(Se,{width:I.value,class:te(["sidebar",{"sidebar-mobile":M(Y),"sidebar-collapsed":T.value}])},{default:n(()=>[o(dn,{"default-active":_.value,class:"sidebar-menu",collapse:T.value,"unique-opened":!0,router:"",onSelect:M(me),onOpen:re},null,8,["default-active","collapse","onSelect"])]),_:1},8,["width","class"]),o(We,{class:"main-content"},{default:n(()=>[a("div",vn,[o(Ue,{modelValue:d.value,"onUpdate:modelValue":x[0]||(x[0]=X=>d.value=X),type:"card",closable:"",onTabRemove:Q,onTabClick:M(be),onContextmenu:Pe,class:"page-tabs"},{default:n(()=>[(f(!0),V(ye,null,ke(c.value,X=>(f(),F(Ve,{key:X.name,label:X.title,name:X.name,closable:X.name!=="/dashboard"},null,8,["label","name","closable"]))),128))]),_:1},8,["modelValue","onTabClick"]),a("div",hn,[o(Re,{onCommand:j},{dropdown:n(()=>[o(Oe,null,{default:n(()=>[o(ie,{command:"closeOthers"},{default:n(()=>[...x[7]||(x[7]=[R("关闭其他",-1)])]),_:1}),o(ie,{command:"closeAll"},{default:n(()=>[...x[8]||(x[8]=[R("关闭全部",-1)])]),_:1})]),_:1})]),default:n(()=>[o(Be,{size:"small",text:""},{default:n(()=>[o(de,null,{default:n(()=>[o(je)]),_:1})]),_:1})]),_:1})])]),a("div",_n,[o(fe,null,{default:n(({Component:X})=>[(f(),F(Ws,{include:N.value},[(f(),F(De(X)))],1032,["include"]))]),_:1})])]),_:1})]),_:1})]),_:1})),M(Y)&&!T.value?(f(),V("div",{key:2,class:"mobile-overlay",onClick:J})):L("",!0),o(na,{visible:G.value,"is-forced":P.value,"is-default-password":m.value,"is-expired":w.value,onClose:x[1]||(x[1]=X=>G.value=!1),onSuccess:ze},null,8,["visible","is-forced","is-default-password","is-expired"]),o(ya,{visible:g.value,"remaining-days":$.value,"last-changed":(Fe=M(r).user)==null?void 0:Fe.passwordLastChanged,onClose:ns,onChangePassword:H,onRemindLater:fs},null,8,["visible","remaining-days","last-changed"]),o(Wa,{visible:O.value,"onUpdate:visible":x[2]||(x[2]=X=>O.value=X),onSuccess:Ne},null,8,["visible"])])}}}),wn=ve(yn,[["__scopeId","data-v-2e510d81"]]);function bn(){return D(this,null,function*(){const s={success:!0,errors:[],warnings:[],info:{browserCompatibility:vt(),storageUsage:gt(),storageAvailable:!1}};try{s.info.browserCompatibility.localStorage||(s.errors.push("localStorage不可用，数据持久化功能将无法正常工作"),s.success=!1);const t=ht.getInstance();try{const l="__deployment_test__",p={test:!0,timestamp:Date.now()};if(!t.save({key:l,version:"1.0.0"},p))s.errors.push("localStorage保存测试失败"),s.success=!1;else{const k=t.load({key:l,version:"1.0.0"});!k||k.test!==!0?(s.errors.push("localStorage加载测试失败"),s.success=!1):s.info.storageAvailable=!0,t.remove(l)}}catch(l){s.errors.push(`存储功能测试失败: ${l}`),s.success=!1}const r=s.info.storageUsage;r.percentage>80&&s.warnings.push(`存储空间使用率过高: ${r.percentage.toFixed(1)}%`),console.log("[Deployment] 生产环境检查通过");const u=["orders","customers","performance","departments","services"];for(const l of u)try{const p={key:`crm_store_${l}`,version:"1.0.0"};t.load(p)}catch(p){s.warnings.push(`Store ${l} 配置可能有问题`)}}catch(e){s.errors.push(`部署检查过程中发生错误: ${e}`),s.success=!1}return s})}function Pn(s){console.log(`
=== 部署前检查结果 ===`),s.success?console.log("✅ 检查通过，可以部署"):console.log("❌ 检查失败，请修复以下问题后再部署"),s.errors.length>0&&(console.log(`
🚨 错误:`),s.errors.forEach(e=>console.log(`  - ${e}`)))}function Sn(){return D(this,null,function*(){try{const s=yield bn();s.success||Pn(s)}catch(s){}})}const Cn={install(s){s.directive("permission",{mounted(e,t){_s(e,t)},updated(e,t){_s(e,t)}}),s.config.globalProperties.$hasPermission=_t,s.config.globalProperties.$hasAnyPermission=yt,s.config.globalProperties.$hasAllPermissions=wt}},An={mounted(s,e){Ps(s,e)},updated(s,e){Ps(s,e)}};function Ps(s,e){const t=he();let r=!0,u={};typeof e.value=="string"||Array.isArray(e.value)?u.permission=e.value:typeof e.value=="object"&&(u=K({},e.value));const{permission:l,role:p,mode:h="any",invert:k=!1}=u;if(p){const S=Array.isArray(p)?p:[p],T=t.roles||[];h==="all"?r=S.every(Y=>T.includes(Y)):r=S.some(Y=>T.includes(Y))}if(l&&r){const S=Array.isArray(l)?l:[l];h==="all"?r=S.every(T=>t.hasPermission(T)):r=S.some(T=>t.hasPermission(T))}t.isAdmin&&(r=!0),k&&(r=!r),r?(s.style.display="",s.style.visibility="visible"):(s.style.display="none",s.style.visibility="hidden")}function kn(s){s.directive("permission",An)}const ps=(s,e,t)=>{console.error("全局错误:",s,t);try{C.error("应用出现错误，请刷新页面重试")}catch(r){console.error("错误处理器本身出错:",r)}},Tn=s=>s.message==="ResizeObserver loop completed with undelivered notifications."?(s.stopImmediatePropagation(),!1):!0;window.addEventListener("error",s=>{Tn(s)&&ps(s.error||new Error(s.message))});window.addEventListener("unhandledrejection",s=>{console.error("未处理的Promise拒绝:",s.reason),ps(s.reason instanceof Error?s.reason:new Error(String(s.reason))),s.preventDefault()});const Ae=Ys(wn);Ae.config.errorHandler=ps;for(const[s,e]of Object.entries(ct))Ae.component(s,e);Ae.use(Js());const $n=he(),Mn=()=>D(void 0,null,function*(){try{yield $n.initUser()}catch(e){console.error("[App] 用户状态初始化失败:",e)}xs().initTheme(),Ae.use(bt),Ae.use(ut),Ae.use(Cn),kn(Ae),Ae.mount("#app"),Sn()});Mn();export{Ds as a,Un as b,se as m,_e as p,tn as u};
