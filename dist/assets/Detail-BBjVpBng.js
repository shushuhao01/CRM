var jl=Object.defineProperty,ql=Object.defineProperties;var Gl=Object.getOwnPropertyDescriptors;var Vt=Object.getOwnPropertySymbols;var Wl=Object.prototype.hasOwnProperty,Zl=Object.prototype.propertyIsEnumerable;var Tt=($,C,A)=>C in $?jl($,C,{enumerable:!0,configurable:!0,writable:!0,value:A}):$[C]=A,It=($,C)=>{for(var A in C||(C={}))Wl.call(C,A)&&Tt($,A,C[A]);if(Vt)for(var A of Vt(C))Zl.call(C,A)&&Tt($,A,C[A]);return $},St=($,C)=>ql($,Gl(C));var S=($,C,A)=>new Promise((I,J)=>{var se=U=>{try{E(A.next(U))}catch(Q){J(Q)}},Ie=U=>{try{E(A.throw(U))}catch(Q){J(Q)}},E=U=>U.done?I(U.value):Promise.resolve(U.value).then(se,Ie);E((A=A.apply($,C)).next())});import{l as Kl,aC as Yl,az as Jl,r as _,Z as ke,e as Ce,w as et,c as Ql,Y as Xl,ag as V,aq as ea,m as h,p as r,q as o,U as t,u as d,T as m,O as l,S as u,J as ta,M as b,F as R,Q as x,a9 as H,P as Ve,V as Pt}from"./vendor-D8Vxqhr-.js";import{a3 as la,h as Ne,m as aa,a4 as xt,W as sa,a5 as oa,T as Ut,a6 as na,p as Dt,a7 as tt,a2 as Me,F as ia,q as ra,a8 as da,c as ua,d as ca,s as pa,n as ma,a9 as va,aa as fa,E as p,b as lt}from"./elementPlus-Bmwh7Rh8.js";import{u as _a,j as ya,t as ga,S as K,w as j,x as ha,C as Ae,c as ba,_ as wa}from"./settings-CuxbDWOu.js";import{u as ka}from"./service-CXxf5jtg.js";import{u as Ca}from"./call-C9NCWzRc.js";import{m as Te}from"./phone-DsAzMHsn.js";import{d as Y}from"./sensitiveInfo-BWt1a88R.js";import{C as Va}from"./CreateTemplateDialog-CGzWjSM2.js";import"./utils-ywHRn0uI.js";const Ta={class:"customer-detail"},Ia={class:"page-header"},Sa={class:"header-left"},Pa={class:"customer-title"},xa={class:"header-actions"},Ua={class:"first-row"},Da={class:"card-header"},Na={class:"card-title"},Ma={key:1,class:"edit-actions"},Aa={key:0,class:"info-display"},Oa={class:"customer-info-row"},$a={class:"info-item name-section"},Ra={class:"customer-name-display"},Ea={class:"info-item code-section"},za=["title"],Fa={class:"info-item phone-section"},La={class:"phone-container-horizontal"},Ba=["onClick"],Ha={key:1,class:"field-value"},ja={class:"customer-info-row"},qa={class:"info-item"},Ga={key:1,class:"field-value"},Wa={class:"info-item"},Za={class:"field-value"},Ka={class:"info-item"},Ya={class:"field-value"},Ja={class:"info-item"},Qa={class:"field-value"},Xa={class:"info-item"},es={class:"field-value"},ts={class:"customer-info-row tags-row"},ls={class:"info-item tags-section"},as={key:0,class:"customer-tags"},ss={key:1,class:"field-value"},os={class:"info-group-right"},ns={class:"info-item compact"},is={class:"field-value"},rs={class:"info-item compact"},ds={class:"field-value"},us={class:"info-item compact"},cs={class:"field-value improvement-goals"},ps={key:0},ms={key:1,class:"no-goals"},vs={class:"customer-info-row create-time-row"},fs={class:"info-item"},_s={class:"field-value"},ys={class:"info-item"},gs={class:"field-value"},hs={class:"info-item"},bs={class:"field-value"},ws={class:"info-item"},ks={class:"field-value"},Cs={class:"customer-info-row"},Vs={class:"info-item address-item"},Ts={class:"address-content"},Is={class:"customer-info-row"},Ss={class:"info-item medical-item"},Ps={class:"medical-history-section"},xs={key:0,class:"latest-medical-info"},Us={class:"medical-record"},Ds={class:"medical-content"},Ns={class:"medical-date"},Ms={class:"medical-operator"},As={key:1,class:"medical-history-toggle"},Os={class:"medical-history-list"},$s={class:"medical-content"},Rs={class:"medical-date"},Es={class:"medical-operator"},zs={class:"add-medical-section"},Fs={class:"add-medical-form"},Ls={class:"form-actions"},Bs={key:2,class:"no-medical-info"},Hs={class:"customer-info-row"},js={class:"info-item notes-item"},qs={key:0,class:"notes-content"},Gs={class:"notes-text"},Ws={key:1,class:"notes-edit"},Zs={class:"notes-actions"},Ks={class:"phone-management"},Ys={class:"phone-list"},Js={key:0,class:"add-phone"},Qs={class:"second-row"},Xs={class:"card-header"},eo={class:"card-title"},to={class:"stat-item consumption"},lo={class:"stat-icon"},ao={class:"stat-content"},so={class:"stat-value"},oo={class:"stat-item orders"},no={class:"stat-icon"},io={class:"stat-content"},ro={class:"stat-value"},uo={class:"stat-item returns"},co={class:"stat-icon"},po={class:"stat-content"},mo={class:"stat-value"},vo={class:"stat-item last-order"},fo={class:"stat-icon"},_o={class:"stat-content"},yo={class:"stat-value"},go={class:"tab-content"},ho={class:"tab-header"},bo={class:"amount"},wo={class:"tab-content"},ko={class:"tab-header"},Co={key:0,class:"amount"},Vo={key:1},To={class:"tab-content"},Io={class:"tab-header"},So={class:"tab-content"},Po={class:"tab-header"},xo={class:"timeline-container"},Uo={class:"timeline-header"},Do={class:"timeline-title"},No={class:"timeline-content"},Mo={class:"timeline-footer"},Ao={class:"timeline-author"},Oo={key:0,class:"timeline-actions"},$o={class:"tab-content"},Ro={class:"tab-header"},Eo={class:"tags-container"},zo={class:"template-select-wrapper"},Fo={class:"template-preview"},Lo={class:"preview-title"},Bo={class:"preview-content"},Ho={class:"template-variables"},jo={class:"send-limit-info"},qo=Kl({__name:"Detail",setup($){const C=Yl(),A=Jl(),I=_a(),J=ya(),se=ka(),Ie=ga(),E=Ca(),U=ba(A),Q=a=>{const e=I.currentUser;return e?e.role==="admin"?a:e.role==="department_manager"?a.filter(n=>{const c=I.getUserById(n.createdBy);return(c==null?void 0:c.department)===e.department}):e.role==="sales_staff"?a.filter(n=>n.createdBy===e.id):e.role==="customer_service"?a.filter(n=>n.servicePersonId===e.id):a.filter(n=>n.createdBy===e.id):[]},at=_("orders"),X=_(!1),st=_(!1),Oe=_(!1),$e=_(!1),Re=_(!1),ce=_(""),G=_(!1),W=_(!1),pe=_(!1),me=_(!1),Se=_(!1),Ee=_(!1),ze=_(!1),Fe=_(!1),Le=_(!1),Be=_([]),ve=_({todayCount:0,monthCount:0}),D=ke({phone:"",templateId:"",variables:{}}),Nt={phone:[{required:!0,message:"请选择接收号码",trigger:"change"}],templateId:[{required:!0,message:"请选择短信模板",trigger:"change"}]},i=_({id:"",code:"",name:"",phone:"",email:"",address:"",level:"",gender:"",birthday:"",salesPerson:"",createdAt:"",improvementGoals:[]}),fe=_({totalConsumption:0,orderCount:0,returnCount:0,lastOrderDate:""}),w=ke({code:"",name:"",phone:"",email:"",address:"",level:"",gender:"",birthday:"",salesperson:"",age:null,height:null,weight:null,wechatId:"",source:""}),Z=_([]),z=_(""),oe=_(!1),F=_([]),_e=_(!1),ye=_(!1),ne=_(""),He=_(!1),Pe=_(!1),ie=_(""),je=_(!1),N=ke({phone:"",purpose:"",note:""}),f=ke({type:"",title:"",content:"",nextFollowUp:""}),ee=_(!1),ge=_(""),L=ke({name:"",type:""}),Mt={type:[{required:!0,message:"请选择跟进类型",trigger:"change"}],title:[{required:!0,message:"请输入跟进标题",trigger:"blur"}],content:[{required:!0,message:"请输入跟进内容",trigger:"blur"}]},te=_([]),re=_([]),qe=_([]),B=_([]),de=_([]),ot=_();Ce(()=>{const a=I.currentUser;if(!a)return!1;if(I.isSuperAdmin)return!0;if(I.isDepartmentLeader){if(i.value.createdBy===a.id||i.value.salesPersonId===a.id)return!0;const e=I.users.find(c=>c.id===i.value.createdBy),n=I.users.find(c=>c.id===i.value.salesPersonId);return e&&e.departmentId===a.departmentId||n&&n.departmentId===a.departmentId}return i.value.createdBy===a.id||i.value.salesPersonId===a.id});const At=Ce(()=>ce.value?te.value.filter(a=>a.orderNo.includes(ce.value)||a.products.includes(ce.value)):te.value),O=Ce(()=>Be.value.find(a=>a.id===D.templateId)),nt=Ce(()=>{if(!O.value)return"";let a=O.value.content;return O.value.variables&&O.value.variables.forEach(e=>{const n=D.variables[e.key]||`{${e.key}}`;a=a.replace(new RegExp(`\\{${e.key}\\}`,"g"),n)}),a}),it=Ce(()=>ve.value.todayCount<1&&ve.value.monthCount<5&&D.phone&&D.templateId),Ot=()=>{U.push("/customer/list")},$t=()=>{i.value.phone?N.phone=i.value.phone:i.value.otherPhones&&i.value.otherPhones.length>0?N.phone=i.value.otherPhones[0]:N.phone="",G.value=!0},Rt=()=>{if(!i.value.phone&&(!i.value.otherPhones||i.value.otherPhones.length===0)){p.warning("该客户没有手机号码，无法发送短信");return}D.phone=i.value.phone||i.value.otherPhones&&i.value.otherPhones[0]||"",D.templateId="",D.variables={},rt(),dt(),me.value=!0},Et=()=>{Se.value=!0},zt=a=>{console.log("模板申请数据:",a),p.success("模板申请已提交，等待管理员审核"),Se.value=!1,rt()},Ft=()=>{D.variables={},O.value&&O.value.variables&&O.value.variables.forEach(a=>{D.variables[a.key]=a.defaultValue||""})},Lt=()=>S(this,null,function*(){try{if(yield ot.value.validate(),!it.value){p.warning("已达到发送限制，无法发送短信");return}Le.value=!0;const a={customerId:i.value.id,phone:D.phone,templateId:D.templateId,variables:D.variables,content:nt.value};yield new Promise(e=>setTimeout(e,2e3)),p.success("短信发送成功，等待审核"),me.value=!1,dt()}catch(a){console.error("发送短信失败:",a),p.error("发送短信失败，请重试")}finally{Le.value=!1}}),rt=()=>S(this,null,function*(){try{Be.value=[{id:"1",name:"客户问候模板",content:"尊敬的{customerName}，感谢您选择我们的服务！如有任何问题，请随时联系我们。",variables:[{key:"customerName",label:"客户姓名",placeholder:"请输入客户姓名",defaultValue:i.value.name}],status:"approved"},{id:"2",name:"预约提醒模板",content:"尊敬的{customerName}，您预约的{serviceName}将在{appointmentTime}开始，请准时到达。",variables:[{key:"customerName",label:"客户姓名",placeholder:"请输入客户姓名",defaultValue:i.value.name},{key:"serviceName",label:"服务名称",placeholder:"请输入服务名称"},{key:"appointmentTime",label:"预约时间",placeholder:"请输入预约时间"}],status:"approved"},{id:"3",name:"活动通知模板",content:"亲爱的{customerName}，我们有新的优惠活动：{activityName}，详情请咨询客服。",variables:[{key:"customerName",label:"客户姓名",placeholder:"请输入客户姓名",defaultValue:i.value.name},{key:"activityName",label:"活动名称",placeholder:"请输入活动名称"}],status:"approved"}]}catch(a){console.error("加载短信模板失败:",a),p.error("加载短信模板失败")}}),dt=()=>S(this,null,function*(){try{ve.value={todayCount:0,monthCount:2}}catch(a){console.error("加载短信统计失败:",a)}}),Bt=()=>{W.value=!0},Ht=()=>{X.value=!0,Object.assign(w,i.value),Z.value=i.value.otherPhones||[]},jt=a=>({VIP客户:"level-vip",SVIP客户:"level-svip",普通客户:"level-normal"})[a]||"level-normal",qt=a=>({VIP客户:"warning",SVIP客户:"danger",普通客户:"info"})[a]||"info",Gt=a=>({normal:"普通客户",vip:"VIP客户",svip:"SVIP客户"})[a]||a,Wt=a=>({已完成:"success",进行中:"warning",已取消:"danger",待付款:"info"})[a]||"info",Zt=a=>({退货:"warning",退款:"danger",换货:"info",维修:"success"})[a]||"info",Kt=a=>({已完成:"success",处理中:"warning",待处理:"info",已拒绝:"danger"})[a]||"info",Yt=a=>({已接通:"success",未接通:"warning",忙线:"info",拒接:"danger"})[a]||"info",ut=a=>({电话跟进:"primary",微信沟通:"success",上门拜访:"warning",邮件联系:"info",其他:""})[a]||"",Jt=a=>({male:"男",female:"女",男:"男",女:"女"})[a]||a,Qt=a=>({online:"线上推广",offline:"线下门店",referral:"朋友推荐",social:"社交媒体",search:"搜索引擎",advertisement:"广告投放",other:"其他渠道"})[a]||a,Xt=a=>({high_value:"高价值客户",potential:"潜在客户",loyal:"忠实客户",new:"新客户",inactive:"不活跃客户",complaint:"投诉客户",vip:"VIP客户"})[a]||a,el=a=>({优质客户:"success",重点关注:"warning",高消费:"danger",潜在客户:"info",忠实客户:"success",新客户:"primary",不活跃客户:"",投诉客户:"danger",VIP客户:"warning"})[a]||"info",tl=()=>{X.value?ct():(X.value=!0,Object.assign(w,i.value),Z.value=i.value.otherPhones||[])},ct=()=>{X.value=!1,Object.assign(w,i.value),Z.value=[],oe.value=!1,z.value=""},ll=()=>S(this,null,function*(){st.value=!0;try{yield new Promise(a=>setTimeout(a,1e3)),Object.assign(i.value,w),i.value.otherPhones=[...Z.value],X.value=!1,p.success("保存成功")}catch(a){p.error("保存失败")}finally{st.value=!1}}),al=()=>{if(!z.value.trim()){p.warning("请输入手机号");return}if(!/^1[3-9]\d{9}$/.test(z.value)){p.warning("请输入正确的手机号格式");return}if(Z.value.includes(z.value)||w.phone===z.value){p.warning("该手机号已存在");return}Z.value.push(z.value),z.value="",oe.value=!1,p.success("添加成功")},sl=a=>{Z.value.splice(a,1),p.success("删除成功")},ol=()=>{z.value="",oe.value=!1},nl=()=>S(this,null,function*(){if(!ne.value.trim()){p.warning("请输入疾病信息");return}He.value=!0;try{yield new Promise(e=>setTimeout(e,1e3));const a={id:Date.now(),content:ne.value.trim(),createTime:new Date().toISOString(),operator:"当前用户",operationType:"add"};F.value.unshift(a),ne.value="",ye.value=!1,p.success("疾病信息添加成功")}catch(a){p.error("添加失败，请重试")}finally{He.value=!1}}),il=()=>{ne.value="",ye.value=!1},rl=()=>{ie.value=i.value.notes||"",Pe.value=!0},dl=()=>{ie.value="",Pe.value=!1},ul=()=>S(this,null,function*(){je.value=!0;try{yield new Promise(a=>setTimeout(a,800)),i.value.notes=ie.value.trim(),Pe.value=!1,ie.value="",p.success("客户备注保存成功")}catch(a){p.error("保存失败，请重试")}finally{je.value=!1}}),pt=a=>new Date(a).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),cl=()=>S(this,null,function*(){if(!i.value.code){p.warning("客户编码为空");return}try{yield ha(i.value.code),p.success("客户编码已复制到剪贴板")}catch(a){p.error("复制失败，请手动复制")}}),pl=()=>{N.phone=i.value.phone,G.value=!0},mt=a=>{let e=a;a.length===11&&a.startsWith("1")||/^\d{7,8}$/.test(a),e=a,N.phone=e,G.value=!0},ml=()=>S(this,null,function*(){var e;const a=j.checkCallPermission(((e=I.userInfo)==null?void 0:e.id)||"guest",Ae.MAKE_CALL);if(!a.hasAccess){p.error(a.reason||"无权限发起通话");return}Ee.value=!0;try{const n={customerId:C.params.id,customerName:i.value.name,phone:N.phone,purpose:N.purpose,notes:N.notes,type:"outbound"};yield E.startCall(n),p.success("通话已发起"),G.value=!1,yield ht()}catch(n){console.error("外呼失败:",n),p.error("外呼失败")}finally{Ee.value=!1}}),vt=()=>{U.push({path:"/order/add",query:{customerId:C.params.id,customerName:i.value.name,customerPhone:i.value.phone,customerEmail:i.value.email,customerAddress:i.value.address}})},vl=()=>{U.push({path:"/service/add",query:{customerId:C.params.id,customerName:i.value.name,customerPhone:i.value.phone,customerEmail:i.value.email}})},fl=()=>{ee.value=!1,ge.value="",f.type="",f.title="",f.content="",f.nextFollowUp="",W.value=!0},_l=()=>S(this,null,function*(){var a;if(!f.type||!f.title||!f.content){p.warning("请填写完整的跟进信息");return}ze.value=!0;try{if(yield new Promise(e=>setTimeout(e,1e3)),ee.value){const e=B.value.findIndex(n=>n.id===ge.value);if(e>-1){const n=B.value[e];B.value[e]=St(It({},n),{type:f.type,title:f.title,content:f.content,createTime:n.createTime,author:n.author}),p.success("跟进记录更新成功")}}else{const e={id:Date.now().toString(),type:f.type,title:f.title,content:f.content,author:((a=I.currentUser)==null?void 0:a.name)||"当前用户",createTime:new Date().toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),canEdit:!0};B.value.unshift(e),p.success("跟进记录保存成功")}W.value=!1,ee.value=!1,ge.value="",f.type="",f.title="",f.content="",f.nextFollowUp=""}catch(e){p.error("保存失败")}finally{ze.value=!1}}),yl=()=>{L.name="",L.type="",pe.value=!0},gl=()=>S(this,null,function*(){if(!L.name.trim()){p.warning("请输入标签名称");return}Fe.value=!0;try{yield new Promise(a=>setTimeout(a,500)),de.value.push({id:Date.now(),name:L.name,type:L.type}),p.success("标签添加成功"),pe.value=!1}catch(a){p.error("添加失败")}finally{Fe.value=!1}}),hl=a=>S(this,null,function*(){try{yield lt.confirm("确定要删除这个标签吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),de.value=de.value.filter(e=>e.id!==a),p.success("标签删除成功")}catch(e){}}),bl=a=>{const e=a.props.name;e==="orders"&&te.value.length===0?We():e==="service"&&re.value.length===0?gt():e==="calls"&&qe.value.length===0?ht():e==="followup"&&B.value.length===0&&Rl()},wl=a=>{U.push(`/order/detail/${a}`)},kl=a=>{U.push(`/order/edit/${a}`)},Cl=a=>S(this,null,function*(){try{yield lt.confirm("确定要取消这个订单吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),p.success("订单已取消"),We()}catch(e){}}),Vl=a=>{U.push(`/service/detail/${a}`)},Tl=a=>{U.push(`/service/edit/${a}`)},Il=a=>S(this,null,function*(){try{yield E.getCallDetail(a),p.success("查看通话详情")}catch(e){console.error("获取通话详情失败:",e),p.error("获取通话详情失败")}}),Sl=a=>S(this,null,function*(){var n;const e=j.checkCallPermission(((n=I.userInfo)==null?void 0:n.id)||"guest",Ae.PLAY_RECORDING);if(!e.hasAccess){p.error(e.reason||"无权限播放录音");return}try{yield E.playRecording(a),p.success("开始播放录音")}catch(c){console.error("播放录音失败:",c),p.error("播放录音失败")}}),Pl=a=>S(this,null,function*(){var n;const e=j.checkCallPermission(((n=I.userInfo)==null?void 0:n.id)||"guest",Ae.DOWNLOAD_RECORDING);if(!e.hasAccess){p.error(e.reason||"无权限下载录音");return}try{yield E.downloadRecording(a),p.success("录音下载已开始")}catch(c){console.error("下载录音失败:",c),p.error("下载录音失败")}}),xl=a=>{p.info("分享通话功能开发中")},Ul=a=>{N.phone=a,N.purpose="回拨",N.notes="",G.value=!0},Dl=a=>{var n;const e=j.checkCallPermission(((n=I.userInfo)==null?void 0:n.id)||"guest",Ae.EDIT_RECORDS);if(!e.hasAccess){p.error(e.reason||"无权限编辑通话记录");return}p.info("编辑通话记录功能开发中")},Nl=a=>{f.type="电话跟进",f.title=`${a.callType}跟进`,f.content=`基于${a.callTime}的${a.callType}通话进行跟进`,f.nextTime="",f.priority="medium",f.status="pending",W.value=!0},Ml=a=>{const e=new Date(a);return(new Date().getTime()-e.getTime())/(1e3*60*60)<=24},Al=a=>{const e=B.value.find(n=>n.id===a);if(!e){p.error("找不到要编辑的跟进记录");return}ee.value=!0,ge.value=a,f.type=e.type,f.title=e.title,f.content=e.content,f.nextFollowUp="",W.value=!0},Ol=a=>S(this,null,function*(){if(!I.isAdmin){p.error("权限不足，仅超级管理员可以删除跟进记录");return}try{yield lt.confirm("确定要删除这条跟进记录吗？删除后无法恢复。","确认删除",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}),yield new Promise(n=>setTimeout(n,500));const e=B.value.findIndex(n=>n.id===a);e>-1&&(B.value.splice(e,1),p.success("跟进记录删除成功"))}catch(e){}}),$l=()=>{W.value=!1,ee.value=!1,ge.value="",f.type="",f.title="",f.content="",f.nextFollowUp=""},Ge=()=>S(this,null,function*(){try{const a=C.params.id,e=C.query.code;if(e&&!a){const c=Ie.getCustomerByCode(e);if(c){U.replace(`/customer/detail/${c.id}`);return}else{p.error("未找到对应的客户信息"),U.push("/customer/list");return}}if(!a){p.error("客户ID不能为空"),U.push("/customer/list");return}const n=Ie.customers.find(c=>c.id===a);if(!n){p.error("未找到客户信息"),U.push("/customer/list");return}console.log("找到客户信息:",n),i.value={id:n.id,code:n.code||"ZS202401201420",name:n.name,phone:n.phone,email:n.email||"",address:n.address||"",level:n.level||"VIP客户",gender:n.gender||"男",birthday:n.birthday||"1990-01-01",age:n.age||34,height:n.height||175,weight:n.weight||70,wechatId:n.wechatId||"",salesperson:n.salesperson||"李销售",createTime:n.createTime||"2023-01-15",joinTime:n.joinTime||"2023-01-10",source:n.source||"朋友推荐",medicalHistory:n.medicalHistory||"",tags:n.tags||["优质客户","重点关注","高消费"],improvementGoals:n.improvementGoals||["减肥","降血压","改善睡眠"],otherPhones:n.otherPhones||[],notes:n.notes||"客户对产品很满意，建议定期回访。"},de.value=[{id:1,name:"优质客户",type:"success"},{id:2,name:"重点关注",type:"warning"}],F.value=[{id:1,content:"高血压，需要定期监测血压，控制饮食",createTime:"2024-01-15T10:30:00.000Z",operator:"李医生",operationType:"add"},{id:2,content:"糖尿病，需要控制血糖，定期检查",createTime:"2023-12-20T14:20:00.000Z",operator:"王医生",operationType:"add"},{id:3,content:"轻微脂肪肝，建议减少油腻食物摄入",createTime:"2023-11-10T09:15:00.000Z",operator:"张医生",operationType:"add"}]}catch(a){console.error("加载客户详情失败:",a),p.error("加载客户详情失败")}}),We=()=>S(this,null,function*(){Oe.value=!0;try{yield new Promise(c=>setTimeout(c,1e3));const a=C.params.id,n=Q(J.orders).filter(c=>c.customerId===a);te.value=n.map(c=>({id:c.id,orderNo:c.orderNumber,products:c.products.map(g=>g.name).join(", "),totalAmount:c.totalAmount,status:ft(c.status),orderDate:c.createTime})),te.value.length===0&&(te.value=[{id:"1",orderNo:"ORD20240120001",products:"商品A, 商品B",totalAmount:599,status:"已完成",orderDate:"2024-01-20 14:30:00"},{id:"2",orderNo:"ORD20240115002",products:"商品C",totalAmount:299,status:"进行中",orderDate:"2024-01-15 09:15:00"},{id:"3",orderNo:"ORD20240110003",products:"商品D, 商品E, 商品F",totalAmount:899,status:"待付款",orderDate:"2024-01-10 16:45:00"}])}finally{Oe.value=!1}}),ft=a=>({pending:"待确认",confirmed:"已确认",shipped:"已发货",delivered:"已完成",cancelled:"已取消",draft:"草稿"})[a]||a,_t=a=>({return:"退货",exchange:"换货",repair:"维修",refund:"退款"})[a]||a,yt=a=>({pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"})[a]||a,gt=()=>S(this,null,function*(){$e.value=!0;try{yield new Promise(n=>setTimeout(n,800));const a=C.params.id,e=se.services.filter(n=>n.customerId===a);re.value=e.map(n=>({id:n.id,serviceNo:n.serviceNumber,orderNo:n.orderNumber,type:_t(n.serviceType),reason:n.reason,amount:n.price||0,status:yt(n.status),createTime:n.createTime})),re.value.length===0&&(re.value=[{id:"1",serviceNo:"SER20240118001",orderNo:"ORD20240115002",type:"退货",reason:"商品质量问题",amount:299,status:"已完成",createTime:"2024-01-18 10:20:00"}])}finally{$e.value=!1}}),ht=()=>S(this,null,function*(){Re.value=!0;try{const a=C.params.id;yield E.loadCallRecords({customerId:a,pageSize:10,currentPage:1}),qe.value=E.callRecords.map(e=>({id:e.id,callType:e.type==="inbound"?"呼入":"呼出",phone:e.phone,duration:e.duration?`${Math.floor(e.duration/60)}分${e.duration%60}秒`:"-",status:e.status==="connected"?"已接通":e.status==="busy"?"忙线":e.status==="no_answer"?"未接听":e.status==="failed"?"失败":"未知",summary:e.summary||"-",callTime:e.startTime}))}catch(a){console.error("加载通话记录失败:",a),p.error("加载通话记录失败")}finally{Re.value=!1}}),Rl=()=>S(this,null,function*(){try{B.value=[{id:"1",type:"电话跟进",title:"产品咨询跟进",content:"客户对新产品很感兴趣，已发送详细资料，约定下周再次联系。",author:"李销售",createTime:"2024-01-19 16:00:00",canEdit:!0},{id:"2",type:"微信沟通",title:"售后问题处理",content:"客户反馈商品质量问题，已安排退货处理，客户表示满意。",author:"李销售",createTime:"2024-01-18 14:30:00",canEdit:!0}]}catch(a){console.error("加载跟进记录失败:",a)}});et(()=>C.params.id,a=>{a&&Ge()});const Ze=()=>{const a=C.params.id,n=Q(J.orders).filter(v=>v.customerId===a),c=se.services.filter(v=>v.customerId===a),g=n.filter(v=>v.auditStatus==="approved").reduce((v,T)=>v+T.totalAmount,0),ue=n.length,M=c.filter(v=>v.serviceType==="return").length,le=n.length>0?n.sort((v,T)=>new Date(T.createTime).getTime()-new Date(v.createTime).getTime())[0].createTime:"";fe.value={totalConsumption:g,orderCount:ue,returnCount:M,lastOrderDate:le}};return et(()=>J.orders,()=>{const a=C.params.id,c=Q(J.orders).filter(g=>g.customerId===a).map(g=>({id:g.id,orderNo:g.orderNumber,products:g.products.map(ue=>ue.name).join(", "),totalAmount:g.totalAmount,status:ft(g.status),orderDate:g.createTime}));te.value=c,Ze()},{deep:!0}),et(()=>se.services,()=>{const a=C.params.id,n=se.services.filter(c=>c.customerId===a).map(c=>({id:c.id,serviceNo:c.serviceNumber,orderNo:c.orderNumber,type:_t(c.serviceType),reason:c.reason,amount:c.price||0,status:yt(c.status),createTime:c.createTime}));re.value=n,Ze()},{deep:!0}),Ql(()=>{Ge(),We(),gt(),Ze();const a=e=>{const{customerId:n}=e.detail;n===C.params.id&&(Ge(),p.success("检测到手机号更新，已刷新客户信息"))};window.addEventListener("customer-phone-updated",a),Xl(()=>{window.removeEventListener("customer-phone-updated",a)})}),(a,e)=>{const n=V("el-button"),c=V("el-tag"),g=V("el-icon"),ue=V("el-collapse-transition"),M=V("el-input"),le=V("el-tooltip"),v=V("el-form-item"),T=V("el-col"),ae=V("el-row"),k=V("el-option"),q=V("el-select"),Ke=V("el-input-number"),bt=V("el-date-picker"),he=V("el-form"),xe=V("el-card"),P=V("el-table-column"),Ye=V("el-table"),be=V("el-tab-pane"),Ue=V("el-dropdown-item"),El=V("el-dropdown-menu"),zl=V("el-dropdown"),Fl=V("el-timeline-item"),Ll=V("el-timeline"),Bl=V("el-tabs"),De=V("el-dialog"),Hl=V("el-alert"),Je=ea("loading");return r(),h("div",Ta,[o("div",Ia,[o("div",Sa,[t(n,{icon:d(la),onClick:Ot,class:"back-btn"},null,8,["icon"]),o("div",Pa,[o("h2",null,m(i.value.name),1),t(c,{class:ta(jt(i.value.level)),size:"large"},{default:l(()=>[u(m(i.value.level),1)]),_:1},8,["class"])])]),o("div",xa,[t(n,{type:"primary",icon:d(Ne),onClick:$t,class:"action-btn"},{default:l(()=>[...e[39]||(e[39]=[u(" 拨打电话 ",-1)])]),_:1},8,["icon"]),t(n,{type:"info",icon:d(aa),onClick:Rt,class:"action-btn"},{default:l(()=>[...e[40]||(e[40]=[u(" 发送短信 ",-1)])]),_:1},8,["icon"]),t(n,{type:"success",icon:d(xt),onClick:vt,class:"action-btn"},{default:l(()=>[...e[41]||(e[41]=[u(" 新建订单 ",-1)])]),_:1},8,["icon"]),t(n,{type:"warning",icon:d(sa),onClick:Bt,class:"action-btn"},{default:l(()=>[...e[42]||(e[42]=[u(" 添加跟进 ",-1)])]),_:1},8,["icon"]),t(n,{icon:d(oa),onClick:Ht,class:"action-btn edit-btn"},{default:l(()=>[...e[43]||(e[43]=[u(" 编辑客户 ",-1)])]),_:1},8,["icon"])])]),o("div",Ua,[t(xe,{class:"customer-info-card",shadow:"hover"},{header:l(()=>[o("div",Da,[o("span",Na,[t(g,null,{default:l(()=>[t(d(ia))]),_:1}),e[44]||(e[44]=u(" 客户信息 ",-1))]),X.value?(r(),h("div",Ma,[t(n,{type:"primary",size:"small",onClick:ll},{default:l(()=>[...e[46]||(e[46]=[u("保存",-1)])]),_:1}),t(n,{size:"small",onClick:ct},{default:l(()=>[...e[47]||(e[47]=[u("取消",-1)])]),_:1})])):(r(),b(n,{key:0,type:"text",onClick:tl,icon:d(tt)},{default:l(()=>[...e[45]||(e[45]=[u("编辑",-1)])]),_:1},8,["icon"]))])]),default:l(()=>[X.value?(r(),b(he,{key:1,model:w,"label-width":"80px",class:"edit-form"},{default:l(()=>[t(ae,{gutter:24},{default:l(()=>[t(T,{span:8},{default:l(()=>[t(v,{label:"客户编码"},{default:l(()=>[t(M,{modelValue:w.code,"onUpdate:modelValue":e[5]||(e[5]=s=>w.code=s),readonly:""},{suffix:l(()=>[t(le,{content:"客户编码自动生成，不可修改"},{default:l(()=>[t(g,null,{default:l(()=>[t(d(Me))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"姓名"},{default:l(()=>[t(M,{modelValue:w.name,"onUpdate:modelValue":e[6]||(e[6]=s=>w.name=s)},null,8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"主手机号"},{default:l(()=>[t(M,{value:d(Y)(w.phone,d(K).PHONE),readonly:""},{suffix:l(()=>[t(le,{content:"敏感信息已加密显示，不可修改"},{default:l(()=>[t(g,null,{default:l(()=>[t(d(Me))]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"邮箱"},{default:l(()=>[t(M,{value:d(Y)(w.email,d(K).EMAIL),readonly:""},{suffix:l(()=>[t(le,{content:"敏感信息已加密显示，不可修改"},{default:l(()=>[t(g,null,{default:l(()=>[t(d(Me))]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),t(ae,{gutter:24},{default:l(()=>[t(T,{span:24},{default:l(()=>[t(v,{label:"其他手机号"},{default:l(()=>[o("div",Ks,[o("div",Ys,[(r(!0),h(R,null,H(Z.value,(s,y)=>(r(),b(c,{key:y,closable:"",onClose:Qe=>sl(y),class:"phone-tag"},{default:l(()=>[u(m(d(Y)(s,d(K).PHONE)),1)]),_:2},1032,["onClose"]))),128)),oe.value?x("",!0):(r(),b(n,{key:0,type:"primary",plain:"",size:"small",onClick:e[7]||(e[7]=s=>oe.value=!0),icon:d(Dt)},{default:l(()=>[...e[74]||(e[74]=[u(" 添加手机号 ",-1)])]),_:1},8,["icon"]))]),oe.value?(r(),h("div",Js,[t(M,{modelValue:z.value,"onUpdate:modelValue":e[8]||(e[8]=s=>z.value=s),placeholder:"请输入手机号",style:{width:"200px","margin-right":"10px"}},null,8,["modelValue"]),t(n,{type:"primary",size:"small",onClick:al},{default:l(()=>[...e[75]||(e[75]=[u("确认",-1)])]),_:1}),t(n,{size:"small",onClick:ol},{default:l(()=>[...e[76]||(e[76]=[u("取消",-1)])]),_:1})])):x("",!0)])]),_:1})]),_:1})]),_:1}),t(ae,{gutter:24},{default:l(()=>[t(T,{span:8},{default:l(()=>[t(v,{label:"客户等级"},{default:l(()=>[t(q,{modelValue:w.level,"onUpdate:modelValue":e[9]||(e[9]=s=>w.level=s),placeholder:"请选择"},{default:l(()=>[t(k,{label:"普通客户",value:"普通客户"}),t(k,{label:"VIP客户",value:"VIP客户"}),t(k,{label:"SVIP客户",value:"SVIP客户"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"年龄"},{default:l(()=>[t(Ke,{modelValue:w.age,"onUpdate:modelValue":e[10]||(e[10]=s=>w.age=s),min:0,max:150,placeholder:"请输入年龄"},null,8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"身高(cm)"},{default:l(()=>[t(Ke,{modelValue:w.height,"onUpdate:modelValue":e[11]||(e[11]=s=>w.height=s),min:0,max:300,placeholder:"请输入身高"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(ae,{gutter:24},{default:l(()=>[t(T,{span:8},{default:l(()=>[t(v,{label:"体重(kg)"},{default:l(()=>[t(Ke,{modelValue:w.weight,"onUpdate:modelValue":e[12]||(e[12]=s=>w.weight=s),min:0,max:500,placeholder:"请输入体重"},null,8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"性别"},{default:l(()=>[t(q,{modelValue:w.gender,"onUpdate:modelValue":e[13]||(e[13]=s=>w.gender=s),placeholder:"请选择"},{default:l(()=>[t(k,{label:"男",value:"男"}),t(k,{label:"女",value:"女"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"客户来源"},{default:l(()=>[t(q,{modelValue:w.source,"onUpdate:modelValue":e[14]||(e[14]=s=>w.source=s),placeholder:"请选择"},{default:l(()=>[t(k,{label:"朋友推荐",value:"朋友推荐"}),t(k,{label:"线上推广",value:"线上推广"}),t(k,{label:"线下门店",value:"线下门店"}),t(k,{label:"社交媒体",value:"社交媒体"}),t(k,{label:"搜索引擎",value:"搜索引擎"}),t(k,{label:"广告投放",value:"广告投放"}),t(k,{label:"其他渠道",value:"其他渠道"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(ae,{gutter:24},{default:l(()=>[t(T,{span:8},{default:l(()=>[t(v,{label:"微信号"},{default:l(()=>[t(M,{value:d(Y)(w.wechatId,d(K).WECHAT),readonly:""},{suffix:l(()=>[t(le,{content:"敏感信息已加密显示，不可修改"},{default:l(()=>[t(g,null,{default:l(()=>[t(d(Me))]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"生日"},{default:l(()=>[t(bt,{modelValue:w.birthday,"onUpdate:modelValue":e[15]||(e[15]=s=>w.birthday=s),type:"date",placeholder:"选择日期"},null,8,["modelValue"])]),_:1})]),_:1}),t(T,{span:8},{default:l(()=>[t(v,{label:"销售人员"},{default:l(()=>[t(M,{modelValue:w.salesperson,"onUpdate:modelValue":e[16]||(e[16]=s=>w.salesperson=s)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(ae,{gutter:24},{default:l(()=>[t(T,{span:24},{default:l(()=>[t(v,{label:"详细地址"},{default:l(()=>[t(M,{modelValue:w.address,"onUpdate:modelValue":e[17]||(e[17]=s=>w.address=s),placeholder:"请输入详细地址"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])):(r(),h("div",Aa,[o("div",Oa,[o("div",$a,[e[48]||(e[48]=o("span",{class:"field-label"},"客户姓名",-1)),o("span",Ra,m(i.value.name||"暂无"),1)]),o("div",Ea,[e[49]||(e[49]=o("span",{class:"field-label"},"客户编码",-1)),o("span",{class:"customer-code-display",onClick:cl,title:"点击复制编码："+(i.value.code||"暂无")},m(i.value.code||"暂无"),9,za)]),o("div",Fa,[e[50]||(e[50]=o("span",{class:"field-label"},"联系电话",-1)),o("div",La,[i.value.phone||i.value.otherPhones&&i.value.otherPhones.length>0?(r(),h(R,{key:0},[i.value.phone?(r(),h("span",{key:0,class:"phone-display",onClick:e[0]||(e[0]=s=>mt(i.value.phone))},[u(m(d(Y)(i.value.phone,d(K).PHONE))+" ",1),t(g,{class:"call-icon"},{default:l(()=>[t(d(Ne))]),_:1})])):x("",!0),(r(!0),h(R,null,H(i.value.otherPhones,s=>(r(),h("span",{key:s,class:"phone-display",onClick:y=>mt(s)},[u(m(d(Y)(s,d(K).PHONE))+" ",1),t(g,{class:"call-icon"},{default:l(()=>[t(d(Ne))]),_:1})],8,Ba))),128))],64)):(r(),h("span",Ha,"暂无"))])])]),o("div",ja,[o("div",qa,[e[51]||(e[51]=o("span",{class:"field-label"},"客户等级",-1)),i.value.level?(r(),b(c,{key:0,type:qt(i.value.level),class:"level-tag",size:"small"},{default:l(()=>[u(m(Gt(i.value.level)),1)]),_:1},8,["type"])):(r(),h("span",Ga,"暂无"))]),o("div",Wa,[e[52]||(e[52]=o("span",{class:"field-label"},"年龄",-1)),o("span",Za,m(i.value.age?i.value.age+"岁":"暂无"),1)]),o("div",Ka,[e[53]||(e[53]=o("span",{class:"field-label"},"身高",-1)),o("span",Ya,m(i.value.height?i.value.height+"cm":"暂无"),1)]),o("div",Ja,[e[54]||(e[54]=o("span",{class:"field-label"},"体重",-1)),o("span",Qa,m(i.value.weight?i.value.weight+"kg":"暂无"),1)]),o("div",Xa,[e[55]||(e[55]=o("span",{class:"field-label"},"性别",-1)),o("span",es,m(Jt(i.value.gender)||"暂无"),1)])]),o("div",ts,[o("div",ls,[e[56]||(e[56]=o("span",{class:"field-label"},"客户标签",-1)),i.value.tags&&i.value.tags.length>0?(r(),h("div",as,[(r(!0),h(R,null,H(i.value.tags,s=>(r(),b(c,{key:s,type:el(s),size:"small"},{default:l(()=>[u(m(Xt(s)),1)]),_:2},1032,["type"]))),128))])):(r(),h("span",ss,"暂无"))]),o("div",os,[o("div",ns,[e[57]||(e[57]=o("span",{class:"field-label"},"进粉时间",-1)),o("span",is,m(i.value.joinTime||"暂无"),1)]),o("div",rs,[e[58]||(e[58]=o("span",{class:"field-label"},"负责销售",-1)),o("span",ds,m(i.value.salesperson||"暂无"),1)]),o("div",us,[e[59]||(e[59]=o("span",{class:"field-label"},"改善问题",-1)),o("span",cs,[i.value.improvementGoals&&i.value.improvementGoals.length>0?(r(),h("span",ps,m(i.value.improvementGoals.join("、")),1)):(r(),h("span",ms,"暂无"))])])])]),o("div",vs,[o("div",fs,[e[60]||(e[60]=o("span",{class:"field-label"},"创建时间",-1)),o("span",_s,m(i.value.createTime||"暂无"),1)]),o("div",ys,[e[61]||(e[61]=o("span",{class:"field-label"},"客户来源",-1)),o("span",gs,m(Qt(i.value.source)||"暂无"),1)]),o("div",hs,[e[62]||(e[62]=o("span",{class:"field-label"},"微信号",-1)),o("span",bs,m(i.value.wechatId?d(Y)(i.value.wechatId,d(K).WECHAT):"暂无"),1)]),o("div",ws,[e[63]||(e[63]=o("span",{class:"field-label"},"邮箱",-1)),o("span",ks,m(i.value.email?d(Y)(i.value.email,d(K).EMAIL):"暂无"),1)])]),o("div",Cs,[o("div",Vs,[e[64]||(e[64]=o("span",{class:"field-label"},"详细地址",-1)),o("div",Ts,m(i.value.address||"暂无"),1)])]),o("div",Is,[o("div",Ss,[e[69]||(e[69]=o("span",{class:"field-label"},"疾病史",-1)),o("div",Ps,[F.value.length>0?(r(),h("div",xs,[o("div",Us,[o("span",Ds,m(F.value[0].content),1),o("span",Ns,m(pt(F.value[0].createTime)),1),o("span",Ms,m(F.value[0].operator),1)])])):x("",!0),F.value.length>1?(r(),h("div",As,[t(n,{type:"text",size:"small",onClick:e[1]||(e[1]=s=>_e.value=!_e.value),class:"toggle-btn"},{default:l(()=>[t(g,null,{default:l(()=>[_e.value?(r(),b(d(na),{key:1})):(r(),b(d(Ut),{key:0}))]),_:1}),u(" "+m(_e.value?"收起":"查看")+"历史记录 ("+m(F.value.length-1)+"条) ",1)]),_:1})])):x("",!0),t(ue,null,{default:l(()=>[Ve(o("div",Os,[(r(!0),h(R,null,H(F.value.slice(1),(s,y)=>(r(),h("div",{class:"medical-record history-record",key:y},[o("span",$s,m(s.content),1),o("span",Rs,m(pt(s.createTime)),1),o("span",Es,m(s.operator),1)]))),128))],512),[[Pt,_e.value]])]),_:1}),o("div",zs,[t(n,{type:"primary",size:"small",onClick:e[2]||(e[2]=s=>ye.value=!ye.value),class:"add-medical-btn"},{default:l(()=>[t(g,null,{default:l(()=>[t(d(Dt))]),_:1}),e[65]||(e[65]=u(" 新增疾病信息 ",-1))]),_:1}),t(ue,null,{default:l(()=>[Ve(o("div",Fs,[t(M,{modelValue:ne.value,"onUpdate:modelValue":e[3]||(e[3]=s=>ne.value=s),type:"textarea",rows:3,placeholder:"请输入疾病信息...",maxlength:"500","show-word-limit":"",class:"medical-input"},null,8,["modelValue"]),o("div",Ls,[t(n,{size:"small",onClick:il},{default:l(()=>[...e[66]||(e[66]=[u("取消",-1)])]),_:1}),t(n,{type:"primary",size:"small",onClick:nl,loading:He.value},{default:l(()=>[...e[67]||(e[67]=[u(" 保存 ",-1)])]),_:1},8,["loading"])])],512),[[Pt,ye.value]])]),_:1})]),F.value.length===0?(r(),h("div",Bs,[...e[68]||(e[68]=[o("span",{class:"empty-text"},"暂无疾病史记录",-1)])])):x("",!0)])])]),o("div",Hs,[o("div",js,[e[73]||(e[73]=o("span",{class:"field-label"},"客户备注",-1)),Pe.value?(r(),h("div",Ws,[t(M,{modelValue:ie.value,"onUpdate:modelValue":e[4]||(e[4]=s=>ie.value=s),type:"textarea",rows:3,placeholder:"请输入客户备注...",maxlength:"1000","show-word-limit":"",class:"notes-input"},null,8,["modelValue"]),o("div",Zs,[t(n,{size:"small",onClick:dl},{default:l(()=>[...e[71]||(e[71]=[u("取消",-1)])]),_:1}),t(n,{type:"primary",size:"small",onClick:ul,loading:je.value},{default:l(()=>[...e[72]||(e[72]=[u(" 保存 ",-1)])]),_:1},8,["loading"])])])):(r(),h("div",qs,[o("span",Gs,m(i.value.notes||"暂无备注"),1),t(n,{type:"text",size:"small",onClick:rl,class:"edit-notes-btn"},{default:l(()=>[t(g,null,{default:l(()=>[t(d(tt))]),_:1}),e[70]||(e[70]=u(" 编辑 ",-1))]),_:1})]))])])]))]),_:1})]),o("div",Qs,[t(xe,{class:"stats-card",shadow:"hover"},{header:l(()=>[o("div",Xs,[o("span",eo,[t(g,null,{default:l(()=>[t(d(ca))]),_:1}),e[77]||(e[77]=u(" 客户统计 ",-1))])])]),default:l(()=>[t(ae,{gutter:24,class:"stats-row"},{default:l(()=>[t(T,{span:6},{default:l(()=>[o("div",to,[o("div",lo,[t(g,null,{default:l(()=>[t(d(ra))]),_:1})]),o("div",ao,[o("div",so,"¥"+m(fe.value.totalConsumption.toLocaleString()),1),e[78]||(e[78]=o("div",{class:"stat-label"},"累计消费",-1))])])]),_:1}),t(T,{span:6},{default:l(()=>[o("div",oo,[o("div",no,[t(g,null,{default:l(()=>[t(d(xt))]),_:1})]),o("div",io,[o("div",ro,m(fe.value.orderCount),1),e[79]||(e[79]=o("div",{class:"stat-label"},"订单数量",-1))])])]),_:1}),t(T,{span:6},{default:l(()=>[o("div",uo,[o("div",co,[t(g,null,{default:l(()=>[t(d(da))]),_:1})]),o("div",po,[o("div",mo,m(fe.value.returnCount),1),e[80]||(e[80]=o("div",{class:"stat-label"},"退货次数",-1))])])]),_:1}),t(T,{span:6},{default:l(()=>[o("div",vo,[o("div",fo,[t(g,null,{default:l(()=>[t(d(ua))]),_:1})]),o("div",_o,[o("div",yo,m(fe.value.lastOrderDate||"暂无"),1),e[81]||(e[81]=o("div",{class:"stat-label"},"最后下单",-1))])])]),_:1})]),_:1})]),_:1})]),t(xe,{class:"tab-card"},{default:l(()=>[t(Bl,{modelValue:at.value,"onUpdate:modelValue":e[19]||(e[19]=s=>at.value=s),onTabClick:bl},{default:l(()=>[t(be,{label:"订单历史",name:"orders"},{default:l(()=>[o("div",go,[o("div",ho,[t(n,{onClick:vt,icon:"Plus",type:"primary",size:"small"},{default:l(()=>[...e[82]||(e[82]=[u("新建订单",-1)])]),_:1}),t(M,{modelValue:ce.value,"onUpdate:modelValue":e[18]||(e[18]=s=>ce.value=s),placeholder:"搜索订单号、商品名称",style:{width:"300px"},clearable:""},{prefix:l(()=>[t(g,null,{default:l(()=>[t(d(pa))]),_:1})]),_:1},8,["modelValue"])]),Ve((r(),b(Ye,{data:At.value,style:{width:"100%"}},{default:l(()=>[t(P,{prop:"orderNo",label:"订单号",width:"180"}),t(P,{prop:"products",label:"商品"}),t(P,{prop:"totalAmount",label:"订单金额",width:"120"},{default:l(({row:s})=>[o("span",bo,"¥"+m(s.totalAmount.toLocaleString()),1)]),_:1}),t(P,{prop:"status",label:"订单状态",width:"100"},{default:l(({row:s})=>[t(c,{type:Wt(s.status)},{default:l(()=>[u(m(s.status),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"orderDate",label:"下单时间",width:"180"}),t(P,{label:"操作",width:"200"},{default:l(({row:s})=>[t(n,{onClick:y=>wl(s.id),size:"small",type:"primary",link:""},{default:l(()=>[...e[83]||(e[83]=[u("查看",-1)])]),_:1},8,["onClick"]),s.status==="待付款"?(r(),b(n,{key:0,onClick:y=>kl(s.id),size:"small",type:"warning",link:""},{default:l(()=>[...e[84]||(e[84]=[u("编辑",-1)])]),_:1},8,["onClick"])):x("",!0),s.status==="待付款"?(r(),b(n,{key:1,onClick:y=>Cl(s.id),size:"small",type:"danger",link:""},{default:l(()=>[...e[85]||(e[85]=[u("取消",-1)])]),_:1},8,["onClick"])):x("",!0)]),_:1})]),_:1},8,["data"])),[[Je,Oe.value]])])]),_:1}),t(be,{label:"售后记录",name:"service"},{default:l(()=>[o("div",wo,[o("div",ko,[t(n,{onClick:vl,icon:"Plus",type:"primary",size:"small"},{default:l(()=>[...e[86]||(e[86]=[u("新建售后",-1)])]),_:1})]),Ve((r(),b(Ye,{data:re.value,style:{width:"100%"}},{default:l(()=>[t(P,{prop:"serviceNo",label:"售后单号",width:"180"}),t(P,{prop:"orderNo",label:"关联订单",width:"180"}),t(P,{prop:"type",label:"售后类型",width:"100"},{default:l(({row:s})=>[t(c,{type:Zt(s.type)},{default:l(()=>[u(m(s.type),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"reason",label:"售后原因"}),t(P,{prop:"amount",label:"退款金额",width:"120"},{default:l(({row:s})=>[s.amount?(r(),h("span",Co,"¥"+m(s.amount.toLocaleString()),1)):(r(),h("span",Vo,"-"))]),_:1}),t(P,{prop:"status",label:"处理状态",width:"100"},{default:l(({row:s})=>[t(c,{type:Kt(s.status)},{default:l(()=>[u(m(s.status),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"createTime",label:"申请时间",width:"180"}),t(P,{label:"操作",width:"150"},{default:l(({row:s})=>[t(n,{onClick:y=>Vl(s.id),size:"small",type:"primary",link:""},{default:l(()=>[...e[87]||(e[87]=[u("查看",-1)])]),_:1},8,["onClick"]),s.status==="待处理"?(r(),b(n,{key:0,onClick:y=>Tl(s.id),size:"small",type:"warning",link:""},{default:l(()=>[...e[88]||(e[88]=[u("处理",-1)])]),_:1},8,["onClick"])):x("",!0)]),_:1})]),_:1},8,["data"])),[[Je,$e.value]])])]),_:1}),t(be,{label:"通话记录",name:"calls"},{default:l(()=>{var s;return[o("div",To,[o("div",Io,[d(j).checkCallPermission(((s=d(I).userInfo)==null?void 0:s.id)||"guest","MAKE_CALL").hasAccess?(r(),b(n,{key:0,onClick:pl,icon:"Phone",type:"success",size:"small"},{default:l(()=>[...e[89]||(e[89]=[u("发起通话",-1)])]),_:1})):x("",!0)]),Ve((r(),b(Ye,{data:qe.value,style:{width:"100%"}},{default:l(()=>[t(P,{prop:"callType",label:"通话类型",width:"100"},{default:l(({row:y})=>[t(c,{type:y.callType==="呼出"?"success":"info"},{default:l(()=>[u(m(y.callType),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"phone",label:"电话号码",width:"150"},{default:l(({row:y})=>[u(m(d(Te)(y.phone)),1)]),_:1}),t(P,{prop:"duration",label:"通话时长",width:"120"}),t(P,{prop:"status",label:"通话状态",width:"100"},{default:l(({row:y})=>[t(c,{type:Yt(y.status)},{default:l(()=>[u(m(y.status),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"summary",label:"通话摘要"}),t(P,{prop:"callTime",label:"通话时间",width:"180"}),t(P,{label:"操作",width:"200"},{default:l(({row:y})=>{var Qe,wt;return[d(j).checkCallPermission(((Qe=d(I).userInfo)==null?void 0:Qe.id)||"guest","VIEW_RECORDS").hasAccess?(r(),b(n,{key:0,onClick:we=>Il(y.id),size:"small",type:"primary",link:""},{default:l(()=>[...e[90]||(e[90]=[u("详情",-1)])]),_:1},8,["onClick"])):x("",!0),y.status==="已接通"&&d(j).checkCallPermission(((wt=d(I).userInfo)==null?void 0:wt.id)||"guest","PLAY_RECORDING").hasAccess?(r(),b(n,{key:1,onClick:we=>Sl(y.id),size:"small",type:"success",link:""},{default:l(()=>[...e[91]||(e[91]=[u("播放",-1)])]),_:1},8,["onClick"])):x("",!0),t(n,{onClick:we=>Nl(y),size:"small",type:"warning",link:""},{default:l(()=>[...e[92]||(e[92]=[u("跟进",-1)])]),_:1},8,["onClick"]),t(zl,{trigger:"click"},{dropdown:l(()=>[t(El,null,{default:l(()=>{var we,kt,Ct;return[y.status==="已接通"&&d(j).checkCallPermission(((we=d(I).userInfo)==null?void 0:we.id)||"guest","DOWNLOAD_RECORDING").hasAccess?(r(),b(Ue,{key:0,onClick:Xe=>Pl(y.id)},{default:l(()=>[t(g,null,{default:l(()=>[t(d(ma))]),_:1}),e[94]||(e[94]=u("下载录音 ",-1))]),_:1},8,["onClick"])):x("",!0),t(Ue,{onClick:Xe=>xl(y.id)},{default:l(()=>[t(g,null,{default:l(()=>[t(d(va))]),_:1}),e[95]||(e[95]=u("分享通话 ",-1))]),_:1},8,["onClick"]),d(j).checkCallPermission(((kt=d(I).userInfo)==null?void 0:kt.id)||"guest","MAKE_CALL").hasAccess?(r(),b(Ue,{key:1,onClick:Xe=>Ul(y.phone)},{default:l(()=>[t(g,null,{default:l(()=>[t(d(Ne))]),_:1}),e[96]||(e[96]=u("回拨 ",-1))]),_:1},8,["onClick"])):x("",!0),d(j).checkCallPermission(((Ct=d(I).userInfo)==null?void 0:Ct.id)||"guest","EDIT_RECORDS").hasAccess?(r(),b(Ue,{key:2,onClick:Xe=>Dl(y.id)},{default:l(()=>[t(g,null,{default:l(()=>[t(d(tt))]),_:1}),e[97]||(e[97]=u("编辑记录 ",-1))]),_:1},8,["onClick"])):x("",!0)]}),_:2},1024)]),default:l(()=>[t(n,{size:"small",type:"info",link:""},{default:l(()=>[e[93]||(e[93]=u(" 更多",-1)),t(g,{class:"el-icon--right"},{default:l(()=>[t(d(Ut))]),_:1})]),_:1})]),_:2},1024)]}),_:1})]),_:1},8,["data"])),[[Je,Re.value]])])]}),_:1}),t(be,{label:"跟进记录",name:"followup"},{default:l(()=>[o("div",So,[o("div",Po,[t(n,{onClick:fl,icon:"Plus",type:"primary",size:"small"},{default:l(()=>[...e[98]||(e[98]=[u("添加跟进",-1)])]),_:1})]),o("div",xo,[t(Ll,null,{default:l(()=>[(r(!0),h(R,null,H(B.value,s=>(r(),b(Fl,{key:s.id,timestamp:s.createTime,type:ut(s.type)},{default:l(()=>[t(xe,{class:"timeline-card"},{default:l(()=>[o("div",Uo,[o("span",Do,m(s.title),1),t(c,{type:ut(s.type),size:"small"},{default:l(()=>[u(m(s.type),1)]),_:2},1032,["type"])]),o("div",No,m(s.content),1),o("div",Mo,[o("span",Ao,m(s.author),1),Ml(s.createTime)?(r(),h("div",Oo,[t(n,{onClick:y=>Al(s.id),size:"small",type:"primary",link:""},{default:l(()=>[...e[99]||(e[99]=[u(" 编辑 ",-1)])]),_:1},8,["onClick"]),d(I).isAdmin?(r(),b(n,{key:0,onClick:y=>Ol(s.id),size:"small",type:"danger",link:""},{default:l(()=>[...e[100]||(e[100]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])):x("",!0)])):(r(),b(le,{key:1,content:"超过24小时的跟进记录不可编辑",placement:"top"},{default:l(()=>[t(n,{size:"small",type:"info",link:"",disabled:""},{default:l(()=>[...e[101]||(e[101]=[u(" 已锁定 ",-1)])]),_:1})]),_:1}))])]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1})])])]),_:1}),t(be,{label:"客户标签",name:"tags"},{default:l(()=>[o("div",$o,[o("div",Ro,[t(n,{onClick:yl,icon:"Plus",type:"primary",size:"small"},{default:l(()=>[...e[102]||(e[102]=[u("添加标签",-1)])]),_:1})]),o("div",Eo,[(r(!0),h(R,null,H(de.value,s=>(r(),b(c,{key:s.id,type:s.type,closable:"",onClose:y=>hl(s.id),class:"tag-item"},{default:l(()=>[u(m(s.name),1)]),_:2},1032,["type","onClose"]))),128)),de.value.length===0?(r(),b(c,{key:0,type:"info"},{default:l(()=>[...e[103]||(e[103]=[u("暂无标签",-1)])]),_:1})):x("",!0)])])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(De,{modelValue:G.value,"onUpdate:modelValue":e[24]||(e[24]=s=>G.value=s),title:"发起外呼",width:"500px"},{footer:l(()=>[t(n,{onClick:e[23]||(e[23]=s=>G.value=!1)},{default:l(()=>[...e[104]||(e[104]=[u("取消",-1)])]),_:1}),t(n,{onClick:ml,type:"primary",loading:Ee.value},{default:l(()=>[...e[105]||(e[105]=[u("开始通话",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(he,{model:N,"label-width":"80px"},{default:l(()=>[t(v,{label:"电话号码"},{default:l(()=>[t(q,{modelValue:N.phone,"onUpdate:modelValue":e[20]||(e[20]=s=>N.phone=s),placeholder:"请选择客户号码",filterable:"","allow-create":""},{default:l(()=>[i.value.phone?(r(),b(k,{key:0,label:`${d(Te)(i.value.phone)} (主号码)`,value:i.value.phone},null,8,["label","value"])):x("",!0),(r(!0),h(R,null,H(i.value.otherPhones,(s,y)=>(r(),b(k,{key:s,label:`${d(Te)(s)} (备用号码${y+1})`,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"通话目的"},{default:l(()=>[t(q,{modelValue:N.purpose,"onUpdate:modelValue":e[21]||(e[21]=s=>N.purpose=s),placeholder:"请选择"},{default:l(()=>[t(k,{label:"销售跟进",value:"sales"}),t(k,{label:"客户回访",value:"callback"}),t(k,{label:"售后服务",value:"service"}),t(k,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"备注"},{default:l(()=>[t(M,{modelValue:N.note,"onUpdate:modelValue":e[22]||(e[22]=s=>N.note=s),type:"textarea",rows:"3",placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(De,{modelValue:W.value,"onUpdate:modelValue":e[29]||(e[29]=s=>W.value=s),title:ee.value?"编辑跟进记录":"添加跟进记录",width:"600px"},{footer:l(()=>[t(n,{onClick:$l},{default:l(()=>[...e[106]||(e[106]=[u("取消",-1)])]),_:1}),t(n,{onClick:_l,type:"primary",loading:ze.value},{default:l(()=>[u(m(ee.value?"更新":"保存"),1)]),_:1},8,["loading"])]),default:l(()=>[t(he,{model:f,rules:Mt,ref:"followUpFormRef","label-width":"80px"},{default:l(()=>[t(v,{label:"跟进类型",prop:"type"},{default:l(()=>[t(q,{modelValue:f.type,"onUpdate:modelValue":e[25]||(e[25]=s=>f.type=s),placeholder:"请选择"},{default:l(()=>[t(k,{label:"电话跟进",value:"电话跟进"}),t(k,{label:"微信沟通",value:"微信沟通"}),t(k,{label:"上门拜访",value:"上门拜访"}),t(k,{label:"邮件联系",value:"邮件联系"}),t(k,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"跟进标题",prop:"title"},{default:l(()=>[t(M,{modelValue:f.title,"onUpdate:modelValue":e[26]||(e[26]=s=>f.title=s),placeholder:"请输入跟进标题"},null,8,["modelValue"])]),_:1}),t(v,{label:"跟进内容",prop:"content"},{default:l(()=>[t(M,{modelValue:f.content,"onUpdate:modelValue":e[27]||(e[27]=s=>f.content=s),type:"textarea",rows:"4",placeholder:"请输入跟进内容"},null,8,["modelValue"])]),_:1}),t(v,{label:"下次跟进"},{default:l(()=>[t(bt,{modelValue:f.nextFollowUp,"onUpdate:modelValue":e[28]||(e[28]=s=>f.nextFollowUp=s),type:"datetime",placeholder:"选择下次跟进时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(De,{modelValue:me.value,"onUpdate:modelValue":e[33]||(e[33]=s=>me.value=s),title:"发送短信",width:"600px"},{footer:l(()=>[t(n,{onClick:e[32]||(e[32]=s=>me.value=!1)},{default:l(()=>[...e[109]||(e[109]=[u("取消",-1)])]),_:1}),t(n,{onClick:Lt,type:"primary",loading:Le.value,disabled:!it.value},{default:l(()=>[...e[110]||(e[110]=[u("发送短信",-1)])]),_:1},8,["loading","disabled"])]),default:l(()=>[t(he,{model:D,rules:Nt,ref_key:"smsFormRef",ref:ot,"label-width":"100px"},{default:l(()=>[t(v,{label:"接收号码",prop:"phone"},{default:l(()=>[t(q,{modelValue:D.phone,"onUpdate:modelValue":e[30]||(e[30]=s=>D.phone=s),placeholder:"请选择客户号码",filterable:""},{default:l(()=>[i.value.phone?(r(),b(k,{key:0,label:`${d(Te)(i.value.phone)} (主号码)`,value:i.value.phone},null,8,["label","value"])):x("",!0),(r(!0),h(R,null,H(i.value.otherPhones,(s,y)=>(r(),b(k,{key:s,label:`${d(Te)(s)} (备用号码${y+1})`,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"短信模板",prop:"templateId"},{default:l(()=>[o("div",zo,[t(q,{modelValue:D.templateId,"onUpdate:modelValue":e[31]||(e[31]=s=>D.templateId=s),placeholder:"请选择短信模板",onChange:Ft,style:{flex:"1","margin-right":"10px"}},{default:l(()=>[(r(!0),h(R,null,H(Be.value,s=>(r(),b(k,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(n,{type:"primary",icon:d(fa),onClick:Et,class:"apply-template-btn",title:"申请新模板"},{default:l(()=>[...e[107]||(e[107]=[u(" 申请模板 ",-1)])]),_:1},8,["icon"])])]),_:1}),O.value?(r(),b(v,{key:0,label:"模板预览"},{default:l(()=>[o("div",Fo,[o("div",Lo,m(O.value.name),1),o("div",Bo,m(nt.value),1),e[108]||(e[108]=o("div",{class:"preview-note"},"注：实际发送时会替换模板变量",-1))])]),_:1})):x("",!0),O.value&&O.value.variables&&O.value.variables.length>0?(r(),b(v,{key:1,label:"模板变量"},{default:l(()=>[o("div",Ho,[(r(!0),h(R,null,H(O.value.variables,s=>(r(),h("div",{key:s.key,class:"variable-item"},[o("label",null,m(s.label)+"：",1),t(M,{modelValue:D.variables[s.key],"onUpdate:modelValue":y=>D.variables[s.key]=y,placeholder:s.placeholder||`请输入${s.label}`,size:"small"},null,8,["modelValue","onUpdate:modelValue","placeholder"])]))),128))])]),_:1})):x("",!0),t(v,{label:"发送限制"},{default:l(()=>[o("div",jo,[t(Hl,{title:`今日已发送：${ve.value.todayCount}/1 条，本月已发送：${ve.value.monthCount}/5 条`,type:"info",closable:!1},null,8,["title"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(De,{modelValue:pe.value,"onUpdate:modelValue":e[37]||(e[37]=s=>pe.value=s),title:"添加标签",width:"400px"},{footer:l(()=>[t(n,{onClick:e[36]||(e[36]=s=>pe.value=!1)},{default:l(()=>[...e[111]||(e[111]=[u("取消",-1)])]),_:1}),t(n,{onClick:gl,type:"primary",loading:Fe.value},{default:l(()=>[...e[112]||(e[112]=[u("保存",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(he,{model:L,"label-width":"80px"},{default:l(()=>[t(v,{label:"标签名称"},{default:l(()=>[t(M,{modelValue:L.name,"onUpdate:modelValue":e[34]||(e[34]=s=>L.name=s),placeholder:"请输入标签名称"},null,8,["modelValue"])]),_:1}),t(v,{label:"标签颜色"},{default:l(()=>[t(q,{modelValue:L.type,"onUpdate:modelValue":e[35]||(e[35]=s=>L.type=s),placeholder:"请选择颜色"},{default:l(()=>[t(k,{label:"默认",value:""}),t(k,{label:"成功",value:"success"}),t(k,{label:"信息",value:"info"}),t(k,{label:"警告",value:"warning"}),t(k,{label:"危险",value:"danger"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Va,{modelValue:Se.value,"onUpdate:modelValue":e[38]||(e[38]=s=>Se.value=s),mode:"apply",onSubmit:zt},null,8,["modelValue"])])}}}),ln=wa(qo,[["__scopeId","data-v-cd04e985"]]);export{ln as default};
