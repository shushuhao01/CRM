var M=(R,D,T)=>new Promise(($,v)=>{var U=p=>{try{N(T.next(p))}catch(g){v(g)}},V=p=>{try{N(T.throw(p))}catch(g){v(g)}},N=p=>p.done?$(p.value):Promise.resolve(p.value).then(U,V);N((T=T.apply(R,D)).next())});import{l as ue,aC as me,az as pe,r as b,Z as z,c as fe,z as _e,ag as d,m as S,p as _,q as t,U as o,M as O,O as n,S as h,u as C,a7 as ve,F as A,a9 as H,T as m,Q as L}from"./vendor-D8Vxqhr-.js";import{j as ge,u as ye,c as ke,_ as he}from"./settings-CuxbDWOu.js";import{n as Ne,s as be,r as Q,ad as Te,F as we,a1 as xe,w as P,e as Se,E as u}from"./elementPlus-Bmwh7Rh8.js";import"./utils-ywHRn0uI.js";const Ce={class:"logistics-track"},Ve={class:"page-header"},Oe={class:"header-actions"},De={class:"card-header"},Ue={class:"header-info"},Ie={class:"header-actions"},Be={class:"basic-info"},Me={class:"info-grid"},Pe={class:"info-item"},$e={class:"value"},Ee={class:"info-item"},Fe={class:"value"},ze={class:"info-item"},Ae={class:"value"},He={class:"info-item"},Re={class:"value"},je={class:"info-item"},qe={class:"value"},Ke={class:"info-item"},Ye={class:"value"},Le={class:"tracking-timeline"},Qe={class:"timeline-content"},Ze={class:"timeline-meta"},Je={key:0,class:"timeline-location"},Ge={key:1,class:"timeline-operator"},We={class:"dialog-footer"},Xe=ue({__name:"Track",setup(R){const D=me(),T=pe(),$=ke(T),v=ge(),U=ye(),V=b(!1),N=b(!1),p=b(!1),g=b(!1),y=new Set,c=b(!1),f=z({trackingNo:"",company:""}),w=z({trackingNos:"",company:""}),l=z({trackingNo:"",companyName:"",status:"",receiverName:"",receiverPhone:"",receiverAddress:"",shipTime:"",estimatedTime:""}),E=b([]),F=b([{code:"SF",name:"顺丰速运"},{code:"YTO",name:"圆通速递"},{code:"ZTO",name:"中通快递"},{code:"STO",name:"申通快递"},{code:"YD",name:"韵达速递"},{code:"HTKY",name:"百世快递"},{code:"JD",name:"京东物流"},{code:"EMS",name:"中国邮政"}]),Z=a=>({pending:"info",shipped:"warning",in_transit:"primary",delivering:"primary",delivered:"success",exception:"danger"})[a]||"info",J=a=>({pending:"待发货",shipped:"已发货",in_transit:"运输中",delivering:"派送中",delivered:"已签收",exception:"异常"})[a]||"未知",G=a=>({已签收:Se,派送中:P,运输中:P,已发货:P,异常:xe})[a]||P,j=a=>{const e=U.currentUser;return e?e.role==="admin"?a:e.role==="department_manager"?a.filter(i=>{const k=U.getUserById(i.createdBy);return(k==null?void 0:k.department)===e.department}):e.role==="sales_staff"?a.filter(i=>i.createdBy===e.id):e.role==="customer_service"?a.filter(i=>i.servicePersonId===e.id):a.filter(i=>i.createdBy===e.id):[]},I=()=>M(this,null,function*(){if(!f.trackingNo.trim()){u.warning("请输入物流单号");return}if(!c.value){V.value=!0;try{const e=j(v.orders).find(r=>r.expressNo===f.trackingNo.trim());if(!e){u.warning("未找到该快递单号对应的订单");return}if(!e.expressCompany||!e.expressNo){u.warning("该订单尚未发货或缺少物流信息");return}if(yield new Promise(r=>{const x=setTimeout(()=>{y.delete(x),r(void 0)},1e3);y.add(x)}),c.value)return;Object.assign(l,{trackingNo:e.expressNo,companyName:ae(e.expressCompany)||e.expressCompany,status:e.status,receiverName:e.customerName,receiverPhone:e.phone||"138****1234",receiverAddress:e.address,shipTime:e.shipTime||e.createTime,estimatedTime:e.estimatedDeliveryTime||""});const i=[],k=new Date;if((e.status==="shipped"||e.status==="delivered")&&(i.push({time:e.shipTime||e.createTime,status:"已发货",description:`快件已从${e.expressCompany}发出，快递单号：${e.expressNo}`,location:"发货地",operator:"物流员",type:"warning"}),e.status==="delivered")){const r=new Date(e.shipTime||e.createTime);r.setDate(r.getDate()+1),i.unshift({time:r.toISOString().replace("T"," ").substring(0,19),status:"运输中",description:"快件正在运输途中",location:"中转站",operator:"系统",type:"info"}),r.setDate(r.getDate()+1),i.unshift({time:r.toISOString().replace("T"," ").substring(0,19),status:"派送中",description:`快件正在派送中，派送员正在配送至${e.address}`,location:e.address.split("省")[0]+"省"||"目的地",operator:"派送员",type:"primary"}),r.setHours(r.getHours()+4),i.unshift({time:r.toISOString().replace("T"," ").substring(0,19),status:"已签收",description:`您的快件已由${e.customerName}签收，感谢使用${e.expressCompany}`,location:e.address,operator:e.customerName,type:"success"})}E.value=i,c.value||u.success("查询成功")}catch(a){c.value||u.error("查询失败，请稍后重试")}finally{c.value||(V.value=!1)}}}),W=()=>{f.trackingNo="",f.company="",Object.assign(l,{trackingNo:"",companyName:"",status:"",receiverName:"",receiverPhone:"",receiverAddress:"",shipTime:"",estimatedTime:""}),E.value=[]},X=()=>M(this,null,function*(){if(!(!l.trackingNo||c.value)){N.value=!0;try{yield new Promise(a=>{const e=setTimeout(()=>{y.delete(e),a(void 0)},1e3);y.add(e)}),c.value||u.success("轨迹已刷新")}catch(a){c.value||u.error("刷新失败")}finally{c.value||(N.value=!1)}}}),ee=()=>{if(!l.trackingNo){u.warning("请先查询物流轨迹");return}$.push(`/logistics/track/detail/${l.trackingNo}`)},te=()=>{if(!l.trackingNo){u.warning("请先查询物流轨迹");return}u.success("导出功能开发中...")},se=()=>M(this,null,function*(){if(!w.trackingNos.trim()){u.warning("请输入物流单号");return}if(!c.value){p.value=!0;try{yield new Promise(a=>{const e=setTimeout(()=>{y.delete(e),a(void 0)},2e3);y.add(e)}),c.value||(u.success("批量查询完成"),g.value=!1)}catch(a){c.value||u.error("批量查询失败")}finally{c.value||(p.value=!1)}}}),ae=a=>{const e=F.value.find(i=>i.code===a);return(e==null?void 0:e.name)||""};return fe(()=>{v.setupLogisticsEventListener(),v.startLogisticsAutoSync();const a=D.query.trackingNo,e=D.query.company;a&&(f.trackingNo=a,e&&(f.company=e),I()),v.$subscribe((i,k)=>{l.trackingNo&&i.events.some(r=>r.key==="expressNo"||r.key==="expressCompany"||r.key==="status")&&j(v.orders).find(B=>B.expressNo===l.trackingNo)&&I()})}),_e(()=>{c.value=!0,y.forEach(a=>{clearTimeout(a)}),y.clear()}),(a,e)=>{const i=d("el-button"),k=d("el-input"),r=d("el-form-item"),x=d("el-option"),B=d("el-select"),q=d("el-form"),K=d("el-card"),oe=d("el-tag"),ne=d("el-divider"),Y=d("el-icon"),ie=d("el-timeline-item"),re=d("el-timeline"),le=d("el-empty"),ce=d("el-dialog");return _(),S("div",Ce,[t("div",Ve,[e[7]||(e[7]=t("h2",null,"物流跟踪",-1)),t("div",Oe,[o(i,{onClick:te,icon:C(Ne)},{default:n(()=>[...e[6]||(e[6]=[h(" 导出轨迹 ",-1)])]),_:1},8,["icon"])])]),o(K,{class:"search-card"},{default:n(()=>[o(q,{model:f,inline:!0,class:"search-form"},{default:n(()=>[o(r,{label:"物流单号"},{default:n(()=>[o(k,{modelValue:f.trackingNo,"onUpdate:modelValue":e[0]||(e[0]=s=>f.trackingNo=s),placeholder:"请输入物流单号",clearable:"",style:{width:"300px"},onKeyup:ve(I,["enter"])},null,8,["modelValue"])]),_:1}),o(r,{label:"物流公司"},{default:n(()=>[o(B,{modelValue:f.company,"onUpdate:modelValue":e[1]||(e[1]=s=>f.company=s),placeholder:"请选择物流公司",clearable:"",style:{width:"200px"}},{default:n(()=>[(_(!0),S(A,null,H(F.value,s=>(_(),O(x,{key:s.code,label:s.name,value:s.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(r,null,{default:n(()=>[o(i,{onClick:I,type:"primary",icon:C(be),loading:V.value},{default:n(()=>[...e[8]||(e[8]=[h(" 查询轨迹 ",-1)])]),_:1},8,["icon","loading"]),o(i,{onClick:W,icon:C(Q)},{default:n(()=>[...e[9]||(e[9]=[h(" 重置 ",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),l.trackingNo?(_(),O(K,{key:0,class:"result-card"},{header:n(()=>[t("div",De,[t("div",Ue,[t("h3",null,m(l.trackingNo),1),o(oe,{type:Z(l.status),size:"large"},{default:n(()=>[h(m(J(l.status)),1)]),_:1},8,["type"])]),t("div",Ie,[o(i,{onClick:ee,type:"primary",size:"small"},{default:n(()=>[...e[10]||(e[10]=[h(" 查看详情 ",-1)])]),_:1}),o(i,{onClick:X,icon:C(Q),size:"small",loading:N.value},{default:n(()=>[...e[11]||(e[11]=[h(" 刷新轨迹 ",-1)])]),_:1},8,["icon","loading"])])])]),default:n(()=>[t("div",Be,[t("div",Me,[t("div",Pe,[e[12]||(e[12]=t("span",{class:"label"},"物流公司：",-1)),t("span",$e,m(l.companyName),1)]),t("div",Ee,[e[13]||(e[13]=t("span",{class:"label"},"收货人：",-1)),t("span",Fe,m(l.receiverName),1)]),t("div",ze,[e[14]||(e[14]=t("span",{class:"label"},"联系电话：",-1)),t("span",Ae,m(l.receiverPhone),1)]),t("div",He,[e[15]||(e[15]=t("span",{class:"label"},"收货地址：",-1)),t("span",Re,m(l.receiverAddress),1)]),t("div",je,[e[16]||(e[16]=t("span",{class:"label"},"发货时间：",-1)),t("span",qe,m(l.shipTime),1)]),t("div",Ke,[e[17]||(e[17]=t("span",{class:"label"},"预计送达：",-1)),t("span",Ye,m(l.estimatedTime),1)])])]),o(ne),t("div",Le,[e[18]||(e[18]=t("h4",null,"物流轨迹",-1)),o(re,null,{default:n(()=>[(_(!0),S(A,null,H(E.value,(s,de)=>(_(),O(ie,{key:de,timestamp:s.time,type:s.type,icon:G(s.status)},{default:n(()=>[t("div",Qe,[t("h5",null,m(s.status),1),t("p",null,m(s.description),1),t("div",Ze,[s.location?(_(),S("div",Je,[o(Y,null,{default:n(()=>[o(C(Te))]),_:1}),t("span",null,m(s.location),1)])):L("",!0),s.operator?(_(),S("div",Ge,[o(Y,null,{default:n(()=>[o(C(we))]),_:1}),t("span",null,m(s.operator),1)])):L("",!0)])])]),_:2},1032,["timestamp","type","icon"]))),128))]),_:1})])]),_:1})):(_(),O(le,{key:1,description:"请输入物流单号查询轨迹信息"})),o(ce,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=s=>g.value=s),title:"批量查询",width:"600px"},{footer:n(()=>[t("span",We,[o(i,{onClick:e[4]||(e[4]=s=>g.value=!1)},{default:n(()=>[...e[19]||(e[19]=[h("取消",-1)])]),_:1}),o(i,{onClick:se,type:"primary",loading:p.value},{default:n(()=>[...e[20]||(e[20]=[h(" 批量查询 ",-1)])]),_:1},8,["loading"])])]),default:n(()=>[o(q,{model:w,"label-width":"100px"},{default:n(()=>[o(r,{label:"物流单号"},{default:n(()=>[o(k,{modelValue:w.trackingNos,"onUpdate:modelValue":e[2]||(e[2]=s=>w.trackingNos=s),type:"textarea",rows:6,placeholder:"请输入物流单号，每行一个"},null,8,["modelValue"])]),_:1}),o(r,{label:"物流公司"},{default:n(()=>[o(B,{modelValue:w.company,"onUpdate:modelValue":e[3]||(e[3]=s=>w.company=s),placeholder:"请选择物流公司",style:{width:"100%"}},{default:n(()=>[(_(!0),S(A,null,H(F.value,s=>(_(),O(x,{key:s.code,label:s.name,value:s.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),nt=he(Xe,[["__scopeId","data-v-2073ab98"]]);export{nt as default};
