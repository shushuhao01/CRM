import{aw as e,r as a,e as l,l as t,Z as s,ag as r,m as o,q as n,p as i,U as d,a2 as u,O as c,u as m,S as p,Q as v,F as g,a9 as f,T as h,M as y,aA as b,b as _,Y as k,J as w,P as T,V as S}from"./vendor-BtukhyiH.js";import{u as R,_ as A,h as C,d as V,b as I,e as D,E as j,S as N,c as x}from"./index-BGtT17ll.js";import{C as $,A as P,E as U,b as E,T as B,R as z,a9 as M,I as O,F as H,r as q,Z as L,H as F,j as Y,Q as J,aa as G,$ as W,a2 as Q,L as Z}from"./elementPlus-DxaqjplL.js";import{orderApi as K}from"./order-CdFdv0YM.js";import{a as X}from"./sensitiveInfo-PTigg6SS.js";import{D as ee}from"./DynamicTable-BXyvPHDr.js";import"./utils-DfI7e5Rl.js";import"./TableColumnSettings-CpY_V997.js";const ae=e("rejectionReason",()=>{const e=a([{id:"1",name:"地址不正确",description:"收货地址信息有误或不完整",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"2",name:"缺少定金截图",description:"未上传定金支付截图或截图不清晰",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"3",name:"产品没有库存",description:"所选产品暂时缺货",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"4",name:"客户信息有误",description:"客户联系方式或身份信息不正确",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"5",name:"快递送不到",description:"收货地址超出配送范围",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"6",name:"风险客户",description:"需要进一步核实客户信息",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"7",name:"订单金额异常",description:"订单金额计算有误或存在异常",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"8",name:"重复下单",description:"客户重复提交相同订单",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"9",name:"产品信息不符",description:"产品规格、型号等信息与实际不符",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"},{id:"10",name:"其他",description:"其他原因，需要在备注中详细说明",isDefault:!0,createTime:"2024-01-01 00:00:00",createdBy:"system"}]),t=a=>e.value.find(e=>e.id===a),s=l(()=>e.value);return{rejectionReasons:e,reasons:s,getAllReasons:()=>e.value,getReasonOptions:()=>e.value.map(e=>({label:e.description||e.name,value:e.id,description:e.description})),getReasonById:t,getReasonByName:a=>e.value.find(e=>e.name===a),addReason:async a=>{await new Promise(e=>setTimeout(e,500));const l={...a,id:Date.now().toString(),createTime:(new Date).toLocaleString("zh-CN"),isDefault:!1};return e.value.push(l),l},updateReason:(a,l)=>{const t=e.value.findIndex(e=>e.id===a);return-1!==t?(e.value[t]={...e.value[t],...l},e.value[t]):null},deleteReason:async a=>{await new Promise(e=>setTimeout(e,300));const l=e.value.findIndex(e=>e.id===a);if(-1!==l){if(e.value[l].isDefault)throw new Error("不能删除系统预设原因");return e.value.splice(l,1),!0}throw new Error("拒绝原因不存在")},isOtherReason:e=>{const a=t(e);return"其他"===a?.name}}}),le={class:"rejection-reason-management"},te={class:"add-reason-section"},se={class:"reason-buttons-section"},re={class:"reason-buttons-grid"},oe={class:"reason-button-content"},ne={class:"reason-info"},ie={class:"reason-name"},de={key:0,class:"reason-description"},ue={class:"reason-meta"},ce={class:"create-time"},me={class:"creator"},pe={class:"reason-actions"},ve={key:0,class:"empty-state"},ge=A(t({__name:"RejectionReasonManagement",emits:["close"],setup(e){const l=ae(),t=R(),b=a(),_=s({name:"",description:""}),k={name:[{required:!0,message:"请输入拒绝原因名称",trigger:"blur"},{min:2,max:30,message:"长度在 2 到 30 个字符",trigger:"blur"},{validator:(e,a,t)=>{l.reasons.some(e=>e.name===a)?t(new Error("该拒绝原因已存在")):t()},trigger:"blur"}],description:[{max:200,message:"描述不能超过200个字符",trigger:"blur"}]},w=a(!1),T=a(null),S=async()=>{b.value&&await b.value.validate(async e=>{if(e){w.value=!0;try{await l.addReason({name:_.name,description:_.description||void 0,createdBy:t.user?.name||"当前用户"}),U.success("添加成功"),_.name="",_.description="",b.value?.resetFields()}catch(a){U.error("添加失败")}finally{w.value=!1}}})};return(e,a)=>{const t=r("el-input"),s=r("el-form-item"),R=r("el-button"),A=r("el-form"),C=r("el-tag"),V=r("el-empty");return n(),o("div",le,[i("div",te,[a[3]||(a[3]=i("h4",null,"添加新的拒绝原因",-1)),d(A,{ref_key:"addFormRef",ref:b,model:_,rules:k,onSubmit:u(S,["prevent"])},{default:c(()=>[d(s,{prop:"name",label:"原因名称"},{default:c(()=>[d(t,{modelValue:_.name,"onUpdate:modelValue":a[0]||(a[0]=e=>_.name=e),placeholder:"请输入拒绝原因名称",maxlength:"30","show-word-limit":""},null,8,["modelValue"])]),_:1}),d(s,{prop:"description",label:"详细描述"},{default:c(()=>[d(t,{modelValue:_.description,"onUpdate:modelValue":a[1]||(a[1]=e=>_.description=e),type:"textarea",rows:3,placeholder:"请输入详细描述（选填）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),d(s,null,{default:c(()=>[d(R,{type:"primary",onClick:S,loading:w.value,icon:m($)},{default:c(()=>[...a[2]||(a[2]=[p(" 添加原因 ",-1)])]),_:1},8,["loading","icon"])]),_:1})]),_:1},8,["model"])]),i("div",se,[a[5]||(a[5]=i("h4",null,"现有拒绝原因",-1)),i("div",re,[(n(!0),o(g,null,f(m(l).reasons,e=>(n(),o("div",{key:e.id,class:"reason-button-item"},[i("div",oe,[i("div",ne,[i("div",ie,h(e.name),1),e.description?(n(),o("div",de,h(e.description),1)):v("",!0),i("div",ue,[i("span",ce,h(e.createTime),1),i("span",me,h(e.createdBy),1)])]),i("div",pe,[e.isDefault?(n(),y(C,{key:1,type:"info",size:"small"},{default:c(()=>[...a[4]||(a[4]=[p("系统预设",-1)])]),_:1})):(n(),y(R,{key:0,type:"danger",size:"small",icon:m(P),onClick:a=>(async e=>{try{await E.confirm(`确定要删除拒绝原因"${e.name}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),T.value=e.id;try{await l.deleteReason(e.id),U.success("删除成功")}catch(a){U.error("删除失败")}finally{T.value=null}}catch{}})(e),loading:T.value===e.id,circle:"",title:"删除"},null,8,["icon","onClick","loading"]))])])]))),128))]),0===m(l).reasons.length?(n(),o("div",ve,[d(V,{description:"暂无拒绝原因"})])):v("",!0)])])}}}),[["__scopeId","data-v-648e178a"]]),fe={class:"order-audit"},he={class:"summary-cards"},ye={class:"summary-content"},be={class:"summary-icon pending"},_e={class:"summary-info"},ke={class:"summary-value"},we={class:"summary-content"},Te={class:"summary-icon amount"},Se={class:"summary-info"},Re={class:"summary-value"},Ae={class:"summary-content"},Ce={class:"summary-icon today"},Ve={class:"summary-info"},Ie={class:"summary-value"},De={class:"summary-content"},je={class:"summary-icon urgent"},Ne={class:"summary-info"},xe={class:"summary-value"},$e={class:"quick-filter-content"},Pe={class:"filter-buttons"},Ue={class:"header-tabs"},Ee={key:1,class:"count-text"},Be={class:"tab-label"},ze={class:"tab-label"},Me={class:"header-actions-right"},Oe={class:"total-info"},He={class:"amount"},qe={key:0,class:"order-detail-content"},Le={class:"card-header"},Fe={class:"info-item"},Ye={class:"value"},Je={class:"info-item"},Ge={class:"value amount"},We={class:"info-item"},Qe={class:"value deposit-amount"},Ze={class:"info-item"},Ke={class:"value cod-amount"},Xe={class:"info-item"},ea={class:"value"},aa={class:"info-item"},la={class:"value"},ta={class:"info-item"},sa={class:"value"},ra={class:"info-item"},oa={class:"value"},na={class:"info-item"},ia={class:"value"},da={class:"info-item"},ua={class:"value"},ca={class:"info-item"},ma={class:"value"},pa={class:"info-item"},va={class:"info-item"},ga={class:"value"},fa={class:"info-item deposit-screenshots-section"},ha={key:0,class:"screenshot-gallery"},ya=["onClick"],ba={class:"image-error"},_a={class:"screenshot-name"},ka={class:"screenshot-overlay"},wa={key:1,class:"value no-data"},Ta={class:"card-header"},Sa={class:"header-left"},Ra=["data-action"],Aa={class:"timeline-header-compact"},Ca={class:"action-name"},Va={class:"timeline-body-compact"},Ia={class:"operator"},Da={key:0,class:"remark"},ja={class:"dialog-footer"},Na={key:0,class:"image-viewer-container"},xa={class:"image-error-large"},$a={key:0,class:"image-navigation"},Pa={class:"image-counter"},Ua={class:"rejection-reason-section"},Ea={class:"batch-orders"},Ba={class:"dialog-footer"},za={class:"dialog-footer"},Ma=A(t({__name:"Audit",setup(e){const t=b(),u=x(t),A=R();C();const $=V(),P=I(),le=ae(),te=a(!1),se=a(!1),re=a(!1),oe=a(!1),ne=a(!1),ie=a(!1),de=a(!1),ue=a(!1),ce=a(!1),me=a(!1),pe=a([]),ve=a(0),Ma=a(!0),Oa=a("pending"),Ha=s({pending:0,approved:0,rejected:0}),qa=s({pending:!1});a([]);const La=a([]),Fa=a([]),Ya=a([]),Ja=a(),Ga=a(),Wa=a(),Qa=a([]),Za=a(!1),Ka=l(()=>A.users.filter(e=>["sales_staff","department_manager","admin","super_admin"].includes(e.role)).map(e=>({id:e.id,name:e.realName||e.name||e.username,department:e.department||"未分配"}))),Xa=l(()=>{const e=Qa.value?.length||0,a=ol.value?.length||0;return e>0&&e<a}),el=l(()=>ce.value?`批量审核订单 (${Qa.value?.length||0}个)`:"订单审核"),al=s({pendingCount:0,pendingAmount:0,todayCount:0,urgentCount:0}),ll=s({orderNo:"",customerName:"",salesPerson:"",minAmount:"",maxAmount:"",dateRange:[]}),tl=a("today"),sl=[{label:"今日",value:"today"},{label:"昨日",value:"yesterday"},{label:"本周",value:"thisWeek"},{label:"本月",value:"thisMonth"},{label:"今年",value:"thisYear"},{label:"全部",value:"all"}],rl=s({page:1,size:20,total:0}),ol=l(()=>{switch(Oa.value){case"pending":default:return La.value;case"approved":return Fa.value;case"rejected":return Ya.value}}),nl=l(()=>[{prop:"orderNo",label:"订单号",width:160,visible:!0},{prop:"customerName",label:"客户姓名",width:120,visible:!0},{prop:"customerPhone",label:"客户电话",width:140,visible:!0},{prop:"salesPerson",label:"销售人员",width:100,visible:!0},{prop:"totalAmount",label:"订单金额",width:120,align:"right",visible:!0},{prop:"productCount",label:"商品数量",width:100,align:"center",visible:!0},{prop:"createTime",label:"创建时间",width:160,visible:!0},{prop:"waitingTime",label:"等待时间",width:120,align:"center",visible:"pending"===Oa.value},{prop:"auditStatus",label:"审核状态",width:120,align:"center",visible:"pending"!==Oa.value},{prop:"hasBeenAudited",label:"审核标识",width:100,align:"center",visible:"pending"===Oa.value},{prop:"auditTime",label:"审核时间",width:160,visible:"pending"!==Oa.value},{prop:"auditor",label:"审核人",width:100,visible:"pending"!==Oa.value},{prop:"remark",label:"订单备注",minWidth:150,showOverflowTooltip:!0,visible:!0}]),il=a({}),dl=s({result:null,remark:"",rejectionReasonId:""}),ul=s({content:""}),cl=s({result:null,rejectionReason:"",remark:""}),ml=l(()=>({result:[{required:!0,message:"请选择审核结果",trigger:"change"}],rejectionReasonId:"rejected"===dl.result?[{required:!0,message:"请选择拒绝原因",trigger:"change"}]:[],remark:[]})),pl={content:[{required:!0,message:"请输入备注内容",trigger:"blur"},{min:2,message:"备注内容至少2个字符",trigger:"blur"}]},vl=l(()=>({result:[{required:!0,message:"请选择审核结果",trigger:"change"}],rejectionReason:"rejected"===cl.result?[{required:!0,message:"请选择拒绝原因",trigger:"change"}]:[],remark:[]})),gl=e=>e>=48?"danger":e>=24?"warning":"success",fl=e=>{switch(e){case"approved":return"success";case"rejected":return"danger";case"pending":return"warning";default:return"info"}},hl=e=>{switch(e){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":return"待审核";default:return"未知"}},yl=e=>{if(!e)return"-";return{wechat:"微信支付",alipay:"支付宝",bank_transfer:"银行转账",unionpay:"云闪付",cod:"货到付款",cash:"现金",card:"刷卡",other:"其他"}[e]||e},bl=e=>{Oa.value=e,Qa.value=[],Za.value=!1,rl.page=1,Rl()},_l=e=>{Qa.value=e?[...ol.value]:[]},kl=e=>{Qa.value=e,Za.value=e.length===ol.value.length},wl=(e,a)=>{il.value=e,dl.result=a,dl.remark="",dl.rejectionReasonId="",ce.value=!1,ne.value=!0},Tl=e=>{Qa.value&&0!==Qa.value.length?(dl.result=e,dl.remark="",dl.rejectionReasonId="",ce.value=!0,ne.value=!0):U.warning("请先选择要审核的订单")},Sl=(e,a)=>{const l="approved"===a?"重新通过":"撤销";E.confirm(`确认${l}此订单吗？`,"操作确认",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await new Promise(e=>setTimeout(e,1e3));const t=ol.value,s=t.findIndex(a=>a.id===e.id);s>-1&&t.splice(s,1),e.auditStatus=a,e.auditTime=(new Date).toLocaleString(),e.auditor=A.user.name,"approved"===a?Fa.value.unshift(e):Ya.value.unshift(e),Rl(),U.success(`订单${l}成功`)}catch(t){U.error(`${l}失败`)}}).catch(()=>{})},Rl=()=>{Ha.pending=La.value.length,Ha.approved=Fa.value.length,Ha.rejected=Ya.value.length,al.pendingCount=La.value.length,al.pendingAmount=La.value.reduce((e,a)=>e+a.totalAmount,0)},Al=async()=>{Ja.value&&await Ja.value.validate(async e=>{if(e){se.value=!0;try{await new Promise(e=>setTimeout(e,1500));const e=ce.value?Qa.value:[il.value],a="approved"===dl.result?"通过":"拒绝";e.forEach(e=>{const a="approved"===dl.result,l=dl.rejectionReasonId?le.getReasonById(dl.rejectionReasonId)?.name||dl.remark||"":dl.remark||"";$.auditOrder(e.id,a,a?dl.remark||"":l);const t=La.value.findIndex(a=>a.id===e.id);t>-1&&La.value.splice(t,1),e.auditStatus=dl.result,e.auditTime=(new Date).toLocaleString(),e.auditor=A.user.name,e.auditRemark=dl.remark,"approved"===dl.result?Fa.value.unshift(e):Ya.value.unshift(e)}),Jl(),Rl(),Qa.value=[],Za.value=!1,U.success(`成功${a}${e.length}个订单`),e.forEach(e=>{const a="approved"===dl.result?P.MessageType.AUDIT_APPROVED:P.MessageType.AUDIT_REJECTED,l="approved"===dl.result?"审核通过":"审核拒绝";if(P.sendMessage(a,`订单 ${e.orderNo} (客户: ${e.customerName}, 金额: ¥${e.totalAmount?.toLocaleString()}) 已${l}`,{relatedId:e.id,relatedType:"order",actionUrl:`/order/detail/${e.id}`}),"approved"===dl.result)P.sendMessage(P.MessageType.ORDER_PENDING_SHIPMENT,`订单 ${e.orderNo} 审核通过，已流转到物流发货列表，等待发货`,{relatedId:e.id,relatedType:"order",actionUrl:"/logistics/shipping"});else{const a=dl.rejectionReasonId?le.getReasonById(dl.rejectionReasonId)?.name||dl.remark||"":dl.remark||"";P.sendMessage(P.MessageType.AUDIT_REJECTED,`订单 ${e.orderNo} 审核被拒绝，已退回修改。拒绝原因：${a}`,{relatedId:e.id,relatedType:"order",actionUrl:`/order/edit/${e.id}`})}}),ne.value=!1,dl.result="",dl.remark="",dl.rejectionReasonId=""}catch(a){U.error("审核失败")}finally{se.value=!1}}})},Cl=async()=>{Ga.value&&await Ga.value.validate(async e=>{if(e){re.value=!0;try{await new Promise(e=>setTimeout(e,800));const e=ol.value.find(e=>e.id===il.value.id);e&&(e.remark=ul.content),U.success("备注保存成功"),ie.value=!1,ul.content=""}catch(a){U.error("保存备注失败")}finally{re.value=!1}}})},Vl=()=>{ne.value=!1,dl.result=null,dl.remark="",dl.rejectionReasonId="",ce.value=!1,Ja.value?.clearValidate()},Il=()=>{de.value=!1,cl.result=null,cl.rejectionReason="",cl.remark="",il.value={},Wa.value?.clearValidate()},Dl=()=>{me.value=!1,pe.value=[],ve.value=0},jl=()=>{ve.value>0&&ve.value--},Nl=()=>{ve.value<pe.value.length-1&&ve.value++},xl=e=>{switch(e){case"created":return"primary";case"submitted":return"warning";case"approved":return"success";case"rejected":return"danger";default:return"info"}},$l=e=>{switch(e){case"created":return"Plus";case"submitted":return"Upload";case"approved":return"Check";case"rejected":return"Close";default:return"InfoFilled"}},Pl=e=>{switch(e){case"created":return"info";case"submitted":return"warning";case"approved":return"success";case"rejected":return"danger";default:return""}},Ul=async()=>{Wa.value&&await Wa.value.validate(async e=>{if(e){oe.value=!0;try{await new Promise(e=>setTimeout(e,1e3));const e=il.value,a=cl.result;e.auditStatus=a,e.auditTime=(new Date).toLocaleString(),e.auditor=A.userInfo?.name||"当前用户",e.auditRemark=cl.remark,e.auditHistory||(e.auditHistory=[]),e.auditHistory.push({id:e.auditHistory.length+1,action:a,actionName:"approved"===a?"审核通过":"审核拒绝",operator:A.userInfo?.name||"当前用户",operatorRole:"审核员",time:(new Date).toLocaleString(),remark:cl.remark});const l=La.value.findIndex(a=>a.id===e.id);l>-1&&La.value.splice(l,1),"approved"===a?Fa.value.unshift(e):Ya.value.unshift(e),Jl(),Rl();const t="approved"===a?P.MessageType.AUDIT_APPROVED:P.MessageType.AUDIT_REJECTED,s="approved"===a?"审核通过":"审核拒绝";if(P.sendMessage(t,`订单 ${e.orderNo} (客户: ${e.customerName}, 金额: ¥${e.totalAmount?.toLocaleString()}) 已${s}`,{relatedId:e.id,relatedType:"order",actionUrl:`/order/detail/${e.id}`}),"approved"===a)$.auditOrder(e.id,!0,cl.remark||""),P.sendMessage(P.MessageType.ORDER_PENDING_SHIPMENT,`订单 ${e.orderNo} 审核通过，已流转到物流发货列表，等待发货`,{relatedId:e.id,relatedType:"order",actionUrl:"/logistics/shipping"});else{const a=cl.rejectionReason||cl.remark;$.auditOrder(e.id,!1,a),P.sendMessage(P.MessageType.AUDIT_REJECTED,`订单 ${e.orderNo} 审核被拒绝，已退回修改。拒绝原因：${a}`,{relatedId:e.id,relatedType:"order",actionUrl:`/order/edit/${e.id}`})}U.success("订单"+("approved"===a?"审核通过":"审核拒绝")),Il()}catch(a){U.error("审核失败，请重试")}finally{oe.value=!1}}})},El=()=>{rl.page=1,Ql()},Bl=()=>{Object.assign(ll,{orderNo:"",customerName:"",salesPerson:"",minAmount:"",maxAmount:"",dateRange:[]}),El()},zl=e=>{tl.value=e;const a=new Date,l=new Date(a);l.setDate(l.getDate()-1);const t=new Date(a);t.setDate(a.getDate()-a.getDay());const s=new Date(a.getFullYear(),a.getMonth(),1),r=new Date(a.getFullYear(),0,1);switch(e){case"today":ll.dateRange=[a,a];break;case"yesterday":ll.dateRange=[l,l];break;case"thisWeek":ll.dateRange=[t,a];break;case"thisMonth":ll.dateRange=[s,a];break;case"thisYear":ll.dateRange=[r,a];break;case"all":ll.dateRange=[]}El()},Ml=()=>{Qa.value=[],Za.value=!1,Ql(),Gl()},Ol=()=>{ue.value=!0},Hl=()=>{ue.value=!1},ql=e=>{Ja.value&&Ja.value.clearValidate(["remark"])},Ll=e=>{"rejected"!==e&&(dl.rejectionReasonId=""),Ja.value&&Ja.value.clearValidate(["rejectionReasonId","remark"])},Fl=e=>{rl.size=e,Ql()},Yl=e=>{rl.page=e,Ql()},Jl=()=>{const e=La.value.length,a=La.value.reduce((e,a)=>e+a.totalAmount,0),l=(new Date).toISOString().split("T")[0],t=La.value.filter(e=>new Date(e.createTime).toISOString().split("T")[0]===l).length,s=new Date,r=La.value.filter(e=>{const a=new Date(e.createTime);return(s.getTime()-a.getTime())/36e5>24}).length;Object.assign(al,{pendingCount:e,pendingAmount:a,todayCount:t,urgentCount:r}),console.log("汇总数据已更新",al)},Gl=async()=>{try{const e=await K.getStatistics();Object.assign(al,{pendingCount:e.pendingCount,pendingAmount:e.pendingAmount,todayCount:e.todayCount,urgentCount:e.urgentCount}),console.log("汇总数据加载成功",al)}catch(e){console.error("加载汇总数据失败:",e),Jl()}},Wl=e=>{const a=A.currentUser;if(!a)return console.log("[数据权限] 没有当前用户，返回空列表"),[];if(console.log("[数据权限] 当前用户:",{id:a.id,name:a.name,role:a.role,department:a.department}),"super_admin"===a.role||"admin"===a.role)return console.log("[数据权限] 超管/管理员角色，可查看全部订单:",e.length),e;if("department_manager"===a.role){const l=e.filter(e=>{const l=A.getUserById(e.salesPersonId||e.createdBy),t=l?.department===a.department;return t&&console.log("[数据权限] 部门匹配:",e.orderNumber,l?.name),t});return console.log("[数据权限] 部门经理，可查看部门订单:",l.length),l}if("sales_staff"===a.role||"employee"===a.role){const l=e.filter(e=>{const l=e.salesPersonId===a.id||e.createdBy===a.name;return l&&console.log("[数据权限] 销售员订单匹配:",e.orderNumber,e.salesPersonId,a.id),l});return console.log("[数据权限] 销售员，可查看自己的订单:",l.length),l}if("customer_service"===a.role)return console.log("[数据权限] 客服角色，可查看全部待审核订单:",e.length),e;const l=e.filter(e=>e.salesPersonId===a.id||e.createdBy===a.name);return console.log("[数据权限] 其他角色，可查看自己的订单:",l.length),l},Ql=async()=>{te.value=!0;try{const e=Wl($.orders).filter(e=>{if(console.log(`[订单审核] 检查订单 ${e.orderNumber}`,{status:e.status,auditStatus:e.auditStatus,markType:e.markType,hasBeenAudited:e.hasBeenAudited,isAuditTransferred:e.isAuditTransferred}),"reserved"===e.markType)return console.log(`[订单审核] ❌ 订单 ${e.orderNumber} 是预留单，跳过`),!1;if("return"===e.markType)return console.log(`[订单审核] ❌ 订单 ${e.orderNumber} 是退单，跳过`),!1;return["pending_audit","confirmed"].includes(e.status)?"pending"!==e.auditStatus?(console.log(`[订单审核] ❌ 订单 ${e.orderNumber} auditStatus不是pending，跳过`,{auditStatus:e.auditStatus}),!1):"shipped"===e.status||"delivered"===e.status||"cancelled"===e.status?(console.log(`[订单审核] ❌ 订单 ${e.orderNumber} 状态为${e.status}，不应该出现在待审核列表，跳过`),!1):!0===e.hasBeenAudited&&"approved"===e.auditStatus?(console.log(`[订单审核] ❌ 订单 ${e.orderNumber} 已经审核通过，不应该出现在待审核列表，跳过`),!1):(console.log(`[订单审核] ✅✅✅ 订单 ${e.orderNumber} 通过筛选`,{status:e.status,auditStatus:e.auditStatus,markType:e.markType||"normal"}),!0):(console.log(`[订单审核] ❌ 订单 ${e.orderNumber} 状态不是待审核状态，跳过`,{status:e.status}),!1)});e.sort((e,a)=>{const l=new Date(e.createTime).getTime();return new Date(a.createTime).getTime()-l}),console.log(`[订单审核] 筛选结果：共 ${e.length} 个待审核订单（已按时间倒序）`),await new Promise(e=>setTimeout(e,300));const a=e.map(e=>({id:e.id,orderNo:e.orderNumber,customerId:e.customerId,customerName:e.customerName,customerPhone:e.customerPhone,salesPerson:e.createdBy,totalAmount:e.totalAmount,depositAmount:e.depositAmount,codAmount:e.totalAmount-e.depositAmount,productCount:e.products.length,createTime:e.createTime,waitingHours:Math.floor(((new Date).getTime()-new Date(e.createTime).getTime())/36e5),remark:e.remark||"",auditStatus:e.auditStatus,hasBeenAudited:e.hasBeenAudited||!1,deliveryAddress:e.receiverAddress,paymentScreenshots:e.depositScreenshots&&e.depositScreenshots.length>0?e.depositScreenshots.map((e,a)=>({id:a+1,url:e,name:`定金截图${a+1}.jpg`})):e.depositScreenshot?[{id:1,url:e.depositScreenshot,name:"定金截图.jpg"}]:[],depositScreenshots:e.depositScreenshots||(e.depositScreenshot?[e.depositScreenshot]:[]),auditHistory:[{id:1,action:"created",actionName:"订单创建",operator:e.customerName,operatorRole:"客户",time:e.createTime,remark:"客户下单"},{id:2,action:"submitted",actionName:"提交审核",operator:e.createdBy,operatorRole:"销售员",time:e.createTime,remark:"销售员提交订单审核"}]}));console.log(`[订单审核] 转换后的真实订单数量: ${a.length}`),La.value=a;const l=Wl($.orders);console.log("[订单审核] 开始筛选已审核订单，总订单数:",l.length),Fa.value=l.filter(e=>{const a="approved"===e.auditStatus&&"reserved"!==e.markType&&"return"!==e.markType;return a&&console.log("[订单审核] ✅ 审核通过订单:",e.orderNumber,e.auditStatus),a}).map(e=>({id:e.id,orderNo:e.orderNumber,customerId:e.customerId,customerName:e.customerName,customerPhone:e.customerPhone,salesPerson:e.createdBy,totalAmount:e.totalAmount,depositAmount:e.depositAmount,codAmount:e.totalAmount-e.depositAmount,productCount:e.products.length,createTime:e.createTime,auditStatus:e.auditStatus,auditTime:e.auditTime||e.updateTime,auditor:e.auditor||"系统",auditRemark:e.auditRemark||"",deliveryAddress:e.receiverAddress,paymentScreenshots:e.depositScreenshots&&e.depositScreenshots.length>0?e.depositScreenshots.map((e,a)=>({id:a+1,url:e,name:`定金截图${a+1}.jpg`})):e.depositScreenshot?[{id:1,url:e.depositScreenshot,name:"定金截图.jpg"}]:[],depositScreenshots:e.depositScreenshots||(e.depositScreenshot?[e.depositScreenshot]:[])})),Ya.value=l.filter(e=>{const a="rejected"===e.auditStatus&&"reserved"!==e.markType&&"return"!==e.markType;return a&&console.log("[订单审核] ❌ 审核拒绝订单:",e.orderNumber,e.auditStatus,e.status),a}).map(e=>({id:e.id,orderNo:e.orderNumber,customerId:e.customerId,customerName:e.customerName,customerPhone:e.customerPhone,salesPerson:e.createdBy,totalAmount:e.totalAmount,depositAmount:e.depositAmount,codAmount:e.totalAmount-e.depositAmount,productCount:e.products.length,createTime:e.createTime,auditStatus:e.auditStatus,auditTime:e.auditTime||e.updateTime,auditor:e.auditor||"系统",auditRemark:e.auditRemark||e.rejectReason||"",deliveryAddress:e.receiverAddress,paymentScreenshots:e.depositScreenshots&&e.depositScreenshots.length>0?e.depositScreenshots.map((e,a)=>({id:a+1,url:e,name:`定金截图${a+1}.jpg`})):e.depositScreenshot?[{id:1,url:e.depositScreenshot,name:"定金截图.jpg"}]:[],depositScreenshots:e.depositScreenshots||(e.depositScreenshot?[e.depositScreenshot]:[])})),console.log(`[订单审核] 最终数据统计：待审核=${La.value.length}, 已通过=${Fa.value.length}, 已拒绝=${Ya.value.length}`),Rl(),Jl(),rl.total=ol.value?.length||0}catch(e){console.error("加载订单列表失败:",e),U.error("加载订单列表失败"),La.value=[],Fa.value=[],Ya.value=[],rl.total=0}finally{te.value=!1}},Zl=e=>{console.log("[订单审核] 收到订单流转事件:",e),Ql(),U.info(`${e.length} 个订单已流转到审核列表`)},Kl=()=>{console.log("[订单审核] 收到刷新审核列表事件"),Ql()},Xl=e=>{console.log("[订单审核] 订单状态变更:",e),Ql()};return _(async()=>{await A.loadUsers();try{console.log("[订单审核] 正在从API加载订单数据..."),await $.loadOrdersFromAPI(),console.log("[订单审核] API数据加载完成，订单总数:",$.orders.length)}catch(e){console.error("[订单审核] 从API加载订单失败:",e)}zl("all"),Gl(),D.on(j.ORDER_TRANSFERRED,Zl),D.on(j.REFRESH_AUDIT_LIST,Kl),D.on(j.ORDER_STATUS_CHANGED,Xl)}),k(()=>{D.off(j.ORDER_TRANSFERRED,Zl),D.off(j.REFRESH_AUDIT_LIST,Kl),D.off(j.ORDER_STATUS_CHANGED,Xl)}),(e,a)=>{const l=r("el-icon"),t=r("el-card"),s=r("el-col"),b=r("el-row"),_=r("el-button"),k=r("el-input"),R=r("el-form-item"),C=r("el-option"),V=r("el-select"),I=r("el-date-picker"),D=r("el-form"),j=r("el-badge"),x=r("el-tab-pane"),P=r("el-tabs"),E=r("el-divider"),K=r("el-checkbox"),ae=r("el-link"),La=r("el-tag"),Fa=r("Document"),Ya=r("el-image"),Rl=r("el-radio"),Jl=r("el-radio-group"),Gl=r("el-timeline-item"),Wl=r("el-timeline"),Ql=r("el-collapse-transition"),Zl=r("el-dialog");return n(),o("div",fe,[a[76]||(a[76]=i("div",{class:"page-header"},[i("h2",null,"订单审核")],-1)),i("div",he,[d(b,{gutter:20},{default:c(()=>[d(s,{span:6},{default:c(()=>[d(t,{class:"summary-card"},{default:c(()=>[i("div",ye,[i("div",be,[d(l,null,{default:c(()=>[d(m(B))]),_:1})]),i("div",_e,[i("div",ke,h(al.pendingCount),1),a[26]||(a[26]=i("div",{class:"summary-label"},"待审核订单",-1))])])]),_:1})]),_:1}),d(s,{span:6},{default:c(()=>[d(t,{class:"summary-card"},{default:c(()=>[i("div",we,[i("div",Te,[d(l,null,{default:c(()=>[d(m(z))]),_:1})]),i("div",Se,[i("div",Re,"¥"+h((al.pendingAmount||0).toLocaleString()),1),a[27]||(a[27]=i("div",{class:"summary-label"},"待审核金额",-1))])])]),_:1})]),_:1}),d(s,{span:6},{default:c(()=>[d(t,{class:"summary-card"},{default:c(()=>[i("div",Ae,[i("div",Ce,[d(l,null,{default:c(()=>[d(m(M))]),_:1})]),i("div",Ve,[i("div",Ie,h(al.todayCount),1),a[28]||(a[28]=i("div",{class:"summary-label"},"今日新增",-1))])])]),_:1})]),_:1}),d(s,{span:6},{default:c(()=>[d(t,{class:"summary-card"},{default:c(()=>[i("div",De,[i("div",je,[d(l,null,{default:c(()=>[d(m(O))]),_:1})]),i("div",Ne,[i("div",xe,h(al.urgentCount),1),a[29]||(a[29]=i("div",{class:"summary-label"},"超时订单",-1))])])]),_:1})]),_:1})]),_:1})]),d(t,{class:"quick-filter-card"},{default:c(()=>[i("div",$e,[a[30]||(a[30]=i("span",{class:"filter-label"},"快捷筛选：",-1)),i("div",Pe,[(n(),o(g,null,f(sl,e=>d(_,{key:e.value,type:tl.value===e.value?"primary":"default",class:w({"active-filter":tl.value===e.value}),size:"small",round:"",onClick:a=>zl(e.value)},{default:c(()=>[p(h(e.label),1)]),_:2},1032,["type","class","onClick"])),64))])])]),_:1}),d(t,{class:"search-card"},{default:c(()=>[d(D,{model:ll,inline:""},{default:c(()=>[d(R,{label:"订单号"},{default:c(()=>[d(k,{modelValue:ll.orderNo,"onUpdate:modelValue":a[0]||(a[0]=e=>ll.orderNo=e),placeholder:"请输入订单号",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),d(R,{label:"客户姓名"},{default:c(()=>[d(k,{modelValue:ll.customerName,"onUpdate:modelValue":a[1]||(a[1]=e=>ll.customerName=e),placeholder:"请输入客户姓名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),d(R,{label:"销售人员"},{default:c(()=>[d(V,{modelValue:ll.salesPerson,"onUpdate:modelValue":a[2]||(a[2]=e=>ll.salesPerson=e),placeholder:"请选择销售人员",clearable:"",filterable:"",style:{width:"200px"}},{default:c(()=>[d(C,{label:"全部",value:""}),(n(!0),o(g,null,f(Ka.value,e=>(n(),y(C,{key:e.id,label:e.name,value:e.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),d(R,{label:"订单金额"},{default:c(()=>[d(k,{modelValue:ll.minAmount,"onUpdate:modelValue":a[3]||(a[3]=e=>ll.minAmount=e),placeholder:"最小金额",type:"number",style:{width:"120px"}},null,8,["modelValue"]),a[31]||(a[31]=i("span",{style:{margin:"0 8px"}},"-",-1)),d(k,{modelValue:ll.maxAmount,"onUpdate:modelValue":a[4]||(a[4]=e=>ll.maxAmount=e),placeholder:"最大金额",type:"number",style:{width:"120px"}},null,8,["modelValue"])]),_:1}),d(R,{label:"创建时间"},{default:c(()=>[d(I,{modelValue:ll.dateRange,"onUpdate:modelValue":a[5]||(a[5]=e=>ll.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),d(R,null,{default:c(()=>[d(_,{onClick:El,type:"primary",icon:m(H)},{default:c(()=>[...a[32]||(a[32]=[p("搜索",-1)])]),_:1},8,["icon"]),d(_,{onClick:Bl,icon:m(q)},{default:c(()=>[...a[33]||(a[33]=[p("重置",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),d(t,{class:"table-card-container"},{default:c(()=>[d(ee,{data:ol.value,columns:nl.value,"storage-key":`order-audit-${Oa.value}`,loading:te.value,"show-selection":!0,"show-actions":!0,total:rl.total,"page-sizes":[10,20,50,100],"current-page":rl.page,"page-size":rl.size,onSelectionChange:kl,onSizeChange:Fl,onCurrentChange:Yl},{"header-actions":c(()=>[i("div",Ue,[d(P,{modelValue:Oa.value,"onUpdate:modelValue":a[7]||(a[7]=e=>Oa.value=e),onTabChange:bl,class:"audit-tabs"},{default:c(()=>[d(x,{label:"待审核",name:"pending"},{label:c(()=>[i("span",{class:"tab-label",onClick:a[6]||(a[6]=e=>{qa["pending"]=!0})},[d(l,null,{default:c(()=>[d(m(B))]),_:1}),a[34]||(a[34]=p(" 待审核 ",-1)),!qa.pending&&Ha.pending>0?(n(),y(j,{key:0,value:Ha.pending,max:99,class:"tab-badge"},null,8,["value"])):Ha.pending>0?(n(),o("span",Ee,h(Ha.pending),1)):v("",!0)])]),_:1}),d(x,{label:"已审核通过",name:"approved"},{label:c(()=>[i("span",Be,[d(l,null,{default:c(()=>[d(m(F))]),_:1}),a[35]||(a[35]=p(" 已审核通过 ",-1))])]),_:1}),d(x,{label:"审核拒绝",name:"rejected"},{label:c(()=>[i("span",ze,[d(l,null,{default:c(()=>[d(m(Y))]),_:1}),a[36]||(a[36]=p(" 审核拒绝 ",-1))])]),_:1})]),_:1},8,["modelValue"])]),a[39]||(a[39]=i("div",{class:"header-spacer"},null,-1)),i("div",Me,[d(_,{onClick:a[8]||(a[8]=e=>Tl("approved")),type:"success",disabled:0===Qa.value.length,icon:m(F),size:"small"},{default:c(()=>[p(" 批量通过 ("+h(Qa.value.length)+") ",1)]),_:1},8,["disabled","icon"]),d(_,{onClick:a[9]||(a[9]=e=>Tl("rejected")),type:"danger",disabled:0===Qa.value.length,icon:m(Y),size:"small"},{default:c(()=>[p(" 批量拒绝 ("+h(Qa.value.length)+") ",1)]),_:1},8,["disabled","icon"]),d(_,{onClick:Ml,icon:m(q),size:"small"},{default:c(()=>[...a[37]||(a[37]=[p("刷新",-1)])]),_:1},8,["icon"]),d(E,{direction:"vertical"}),d(K,{modelValue:Za.value,"onUpdate:modelValue":a[10]||(a[10]=e=>Za.value=e),onChange:_l,indeterminate:Xa.value},{default:c(()=>[...a[38]||(a[38]=[p(" 全选 ",-1)])]),_:1},8,["modelValue","indeterminate"]),d(E,{direction:"vertical"}),i("span",Oe,"共 "+h(rl.total)+" 条记录",1)])]),"column-orderNo":c(({row:e})=>[d(ae,{type:"primary",onClick:a=>(e=>{e.id&&u.push(`/order/detail/${e.id}`)})(e),underline:!1},{default:c(()=>[p(h(e.orderNo),1)]),_:2},1032,["onClick"])]),"column-customerName":c(({row:e})=>[d(ae,{type:"primary",onClick:a=>(e=>{if(e.customerId)u.push(`/customer/detail/${e.customerId}`);else{const a=$.getOrderById(e.id);a&&a.customerId?u.push(`/customer/detail/${a.customerId}`):U.warning("客户ID不存在")}})(e),underline:!1},{default:c(()=>[p(h(e.customerName),1)]),_:2},1032,["onClick"])]),customerPhone:c(({row:e})=>[p(h(m(X)(e.customerPhone,"phone")),1)]),totalAmount:c(({row:e})=>[i("span",He,"¥"+h((e.totalAmount||0).toLocaleString()),1)]),waitingTime:c(({row:e})=>[d(La,{type:gl(e.waitingHours),size:"small"},{default:c(()=>[p(h(e.waitingHours)+"小时 ",1)]),_:2},1032,["type"])]),auditStatus:c(({row:e})=>[d(La,{type:fl(e.auditStatus),size:"small"},{default:c(()=>[p(h(hl(e.auditStatus)),1)]),_:2},1032,["type"])]),hasBeenAudited:c(({row:e})=>[e.hasBeenAudited?(n(),y(La,{key:0,type:"success",size:"small",effect:"plain"},{default:c(()=>[...a[40]||(a[40]=[p(" 已审核 ",-1)])]),_:1})):(n(),y(La,{key:1,type:"info",size:"small",effect:"plain"},{default:c(()=>[...a[41]||(a[41]=[p(" 待审核 ",-1)])]),_:1}))]),"table-actions":c(({row:e})=>[d(_,{onClick:a=>(e=>{il.value=e,cl.result=null,cl.rejectionReason="",cl.remark="",de.value=!0})(e),type:"primary",link:"",size:"small",icon:m(L)},{default:c(()=>[...a[42]||(a[42]=[p(" 查看 ",-1)])]),_:1},8,["onClick","icon"]),"pending"===Oa.value?(n(),o(g,{key:0},[d(_,{onClick:a=>wl(e,"approved"),type:"success",link:"",size:"small",icon:m(F)},{default:c(()=>[...a[43]||(a[43]=[p(" 通过 ",-1)])]),_:1},8,["onClick","icon"]),d(_,{onClick:a=>wl(e,"rejected"),type:"danger",link:"",size:"small",icon:m(Y)},{default:c(()=>[...a[44]||(a[44]=[p(" 拒绝 ",-1)])]),_:1},8,["onClick","icon"])],64)):"approved"===Oa.value?(n(),y(_,{key:1,onClick:a=>Sl(e,"rejected"),type:"danger",link:"",size:"small",icon:m(Y)},{default:c(()=>[...a[45]||(a[45]=[p(" 撤销 ",-1)])]),_:1},8,["onClick","icon"])):"rejected"===Oa.value?(n(),y(_,{key:2,onClick:a=>Sl(e,"approved"),type:"success",link:"",size:"small",icon:m(F)},{default:c(()=>[...a[46]||(a[46]=[p(" 重新通过 ",-1)])]),_:1},8,["onClick","icon"])):v("",!0),d(_,{onClick:a=>(e=>{il.value=e,ul.content=e.remark||"",ie.value=!0})(e),type:"warning",link:"",size:"small",icon:m(J)},{default:c(()=>[...a[47]||(a[47]=[p(" 备注 ",-1)])]),_:1},8,["onClick","icon"])]),_:1},8,["data","columns","storage-key","loading","total","current-page","page-size"])]),_:1}),d(Zl,{modelValue:de.value,"onUpdate:modelValue":a[15]||(a[15]=e=>de.value=e),title:"订单审核",width:"800px","before-close":Il},{footer:c(()=>[i("div",ja,[d(_,{onClick:Il},{default:c(()=>[...a[68]||(a[68]=[p("取消",-1)])]),_:1}),d(_,{onClick:Ul,type:"primary",loading:oe.value,disabled:!cl.result},{default:c(()=>[p(" 确认"+h("approved"===cl.result?"通过":"拒绝"),1)]),_:1},8,["loading","disabled"])])]),default:c(()=>[il.value?(n(),o("div",qe,[d(t,{class:"order-info-card",shadow:"never"},{header:c(()=>[i("div",Le,[d(l,null,{default:c(()=>[d(Fa)]),_:1}),a[48]||(a[48]=i("span",null,"订单基本信息",-1))])]),default:c(()=>[d(b,{gutter:20},{default:c(()=>[d(s,{span:12},{default:c(()=>[i("div",Fe,[a[49]||(a[49]=i("span",{class:"label"},"订单号：",-1)),i("span",Ye,h(il.value.orderNo),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",Je,[a[50]||(a[50]=i("span",{class:"label"},"订单金额：",-1)),i("span",Ge,"¥"+h(il.value.totalAmount?.toLocaleString()),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",We,[a[51]||(a[51]=i("span",{class:"label"},"定金金额：",-1)),i("span",Qe,"¥"+h((il.value.depositAmount||0).toLocaleString()),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",Ze,[a[52]||(a[52]=i("span",{class:"label"},"到付金额：",-1)),i("span",Ke,"¥"+h((il.value.codAmount||0).toLocaleString()),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",Xe,[a[53]||(a[53]=i("span",{class:"label"},"支付方式：",-1)),i("span",ea,h(yl(il.value.paymentMethod)),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",aa,[a[54]||(a[54]=i("span",{class:"label"},"客户姓名：",-1)),i("span",la,h(il.value.customerName),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",ta,[a[55]||(a[55]=i("span",{class:"label"},"联系电话：",-1)),i("span",sa,h(m(X)(il.value.customerPhone,m(N).PHONE,m(A).currentUser?.id||"")),1)])]),_:1}),d(s,{span:24},{default:c(()=>[i("div",ra,[a[56]||(a[56]=i("span",{class:"label"},"收货地址：",-1)),i("span",oa,h(il.value.deliveryAddress),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",na,[a[57]||(a[57]=i("span",{class:"label"},"销售人员：",-1)),i("span",ia,h(il.value.salesPerson),1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",da,[a[58]||(a[58]=i("span",{class:"label"},"产品数量：",-1)),i("span",ua,h(il.value.productCount)+" 件",1)])]),_:1}),d(s,{span:12},{default:c(()=>[i("div",ca,[a[59]||(a[59]=i("span",{class:"label"},"创建时间：",-1)),i("span",ma,h(il.value.createTime),1)])]),_:1}),il.value.waitingHours?(n(),y(s,{key:0,span:12},{default:c(()=>[i("div",pa,[a[60]||(a[60]=i("span",{class:"label"},"等待时间：",-1)),i("span",{class:w(["value",gl(il.value.waitingHours)])},h(il.value.waitingHours)+" 小时 ",3)])]),_:1})):v("",!0),il.value.remark?(n(),y(s,{key:1,span:24},{default:c(()=>[i("div",va,[a[61]||(a[61]=i("span",{class:"label"},"订单备注：",-1)),i("span",ga,h(il.value.remark),1)])]),_:1})):v("",!0),d(s,{span:24},{default:c(()=>[i("div",fa,[a[63]||(a[63]=i("span",{class:"label"},"支付截图：",-1)),il.value.paymentScreenshots&&il.value.paymentScreenshots.length>0?(n(),o("div",ha,[(n(!0),o(g,null,f(il.value.paymentScreenshots,(e,t)=>(n(),o("div",{key:e.id,class:"screenshot-item",onClick:e=>((e,a)=>{pe.value=e.map(e=>e.url),ve.value=a,me.value=!0})(il.value.paymentScreenshots,t)},[d(Ya,{src:e.url,alt:e.name,fit:"cover",class:"screenshot-thumbnail","preview-disabled":!0},{error:c(()=>[i("div",ba,[d(l,null,{default:c(()=>[d(m(G))]),_:1}),a[62]||(a[62]=i("span",null,"加载失败",-1))])]),_:1},8,["src","alt"]),i("div",_a,h(e.name),1),i("div",ka,[d(l,{class:"view-icon"},{default:c(()=>[d(m(W))]),_:1})])],8,ya))),128))])):(n(),o("span",wa,"暂无支付截图"))])]),_:1})]),_:1})]),_:1}),d(t,{class:"audit-action-card",shadow:"never"},{header:c(()=>[i("div",Ta,[d(l,null,{default:c(()=>[d(m(J))]),_:1}),a[64]||(a[64]=i("span",null,"审核操作",-1))])]),default:c(()=>[d(D,{ref_key:"quickAuditFormRef",ref:Wa,model:cl,rules:vl.value,"label-width":"100px"},{default:c(()=>[d(R,{label:"审核结果",prop:"result",required:!1},{default:c(()=>[d(Jl,{modelValue:cl.result,"onUpdate:modelValue":a[11]||(a[11]=e=>cl.result=e)},{default:c(()=>[d(Rl,{label:"approved"},{default:c(()=>[d(l,{color:"#67c23a"},{default:c(()=>[d(m(F))]),_:1}),a[65]||(a[65]=p(" 审核通过 ",-1))]),_:1}),d(Rl,{label:"rejected"},{default:c(()=>[d(l,{color:"#f56c6c"},{default:c(()=>[d(m(Y))]),_:1}),a[66]||(a[66]=p(" 审核拒绝 ",-1))]),_:1})]),_:1},8,["modelValue"])]),_:1}),"rejected"===cl.result?(n(),y(R,{key:0,label:"拒绝原因",prop:"rejectionReason",required:""},{default:c(()=>[d(V,{modelValue:cl.rejectionReason,"onUpdate:modelValue":a[12]||(a[12]=e=>cl.rejectionReason=e),placeholder:"请选择拒绝原因",style:{width:"100%"}},{default:c(()=>[(n(!0),o(g,null,f(m(le).reasons,e=>(n(),y(C,{key:e.id,label:e.name,value:e.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):v("",!0),d(R,{label:"审核备注",prop:"remark",required:!1},{default:c(()=>[d(k,{modelValue:cl.remark,"onUpdate:modelValue":a[13]||(a[13]=e=>cl.remark=e),type:"textarea",rows:3,placeholder:"请输入审核备注（选填）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1}),d(t,{class:"audit-history-card",shadow:"never"},{header:c(()=>[i("div",{class:"card-header",onClick:a[14]||(a[14]=e=>Ma.value=!Ma.value),style:{cursor:"pointer"}},[i("div",Sa,[d(l,null,{default:c(()=>[d(m(B))]),_:1}),a[67]||(a[67]=i("span",null,"审核轨迹",-1)),d(j,{value:il.value?.auditHistory?.length||0,max:99,type:"info",style:{"margin-left":"8px"}},null,8,["value"])]),d(l,{class:w(["collapse-icon",{collapsed:Ma.value}])},{default:c(()=>[d(m(Q))]),_:1},8,["class"])])]),default:c(()=>[d(Ql,null,{default:c(()=>[T(i("div",null,[d(Wl,{size:"small"},{default:c(()=>[(n(!0),o(g,null,f(il.value?.auditHistory||[],e=>(n(),y(Gl,{key:e.id,timestamp:e.time,type:xl(e.action),icon:$l(e.action),placement:"top"},{default:c(()=>[i("div",{class:"timeline-content-compact","data-action":e.action},[i("div",Aa,[i("span",Ca,h(e.actionName),1),d(La,{type:Pl(e.action),size:"small"},{default:c(()=>[p(h(e.operatorRole),1)]),_:2},1032,["type"])]),i("div",Va,[i("span",Ia,h(e.operator),1),e.remark?(n(),o("span",Da,h(e.remark),1)):v("",!0)])],8,Ra)]),_:2},1032,["timestamp","type","icon"]))),128))]),_:1})],512),[[S,!Ma.value]])]),_:1})]),_:1})])):v("",!0)]),_:1},8,["modelValue"]),d(Zl,{modelValue:me.value,"onUpdate:modelValue":a[16]||(a[16]=e=>me.value=e),title:"支付截图查看",width:"80%","before-close":Dl,class:"image-viewer-dialog"},{default:c(()=>[pe.value.length>0?(n(),o("div",Na,[d(Ya,{src:pe.value[ve.value],fit:"contain",class:"viewer-image"},{error:c(()=>[i("div",xa,[d(l,{size:"48"},{default:c(()=>[d(m(G))]),_:1}),a[69]||(a[69]=i("p",null,"图片加载失败",-1))])]),_:1},8,["src"]),pe.value.length>1?(n(),o("div",$a,[d(_,{onClick:jl,disabled:0===ve.value,circle:"",class:"nav-btn prev-btn"},{default:c(()=>[d(l,null,{default:c(()=>[d(m(Z))]),_:1})]),_:1},8,["disabled"]),i("span",Pa,h(ve.value+1)+" / "+h(pe.value.length),1),d(_,{onClick:Nl,disabled:ve.value===pe.value.length-1,circle:"",class:"nav-btn next-btn"},{default:c(()=>[d(l,null,{default:c(()=>[d(m(Q))]),_:1})]),_:1},8,["disabled"])])):v("",!0)])):v("",!0)]),_:1},8,["modelValue"]),d(Zl,{modelValue:ne.value,"onUpdate:modelValue":a[20]||(a[20]=e=>ne.value=e),title:el.value,width:"600px","before-close":Vl},{footer:c(()=>[i("div",Ba,[d(_,{onClick:Vl},{default:c(()=>[...a[73]||(a[73]=[p("取消",-1)])]),_:1}),d(_,{onClick:Al,type:"primary",loading:se.value},{default:c(()=>[p(" 确认"+h("approved"===dl.result?"通过":"拒绝"),1)]),_:1},8,["loading"])])]),default:c(()=>[d(D,{ref_key:"auditFormRef",ref:Ja,model:dl,rules:ml.value,"label-width":"100px"},{default:c(()=>[d(R,{label:"审核结果",prop:"result",required:!1},{default:c(()=>[d(Jl,{modelValue:dl.result,"onUpdate:modelValue":a[17]||(a[17]=e=>dl.result=e),onChange:Ll},{default:c(()=>[d(Rl,{label:"approved"},{default:c(()=>[d(l,{color:"#67c23a"},{default:c(()=>[d(m(F))]),_:1}),a[70]||(a[70]=p(" 审核通过 ",-1))]),_:1}),d(Rl,{label:"rejected"},{default:c(()=>[d(l,{color:"#f56c6c"},{default:c(()=>[d(m(Y))]),_:1}),a[71]||(a[71]=p(" 审核拒绝 ",-1))]),_:1})]),_:1},8,["modelValue"])]),_:1}),"rejected"===dl.result?(n(),y(R,{key:0,label:"拒绝原因",prop:"rejectionReasonId",required:""},{default:c(()=>[i("div",Ua,[d(V,{modelValue:dl.rejectionReasonId,"onUpdate:modelValue":a[18]||(a[18]=e=>dl.rejectionReasonId=e),placeholder:"请选择拒绝原因",clearable:"",filterable:"",onChange:ql,style:{width:"300px"}},{default:c(()=>[(n(!0),o(g,null,f(m(le).getReasonOptions(),e=>(n(),y(C,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d(_,{type:"text",onClick:Ol,style:{"margin-left":"8px","flex-shrink":"0"}},{default:c(()=>[...a[72]||(a[72]=[p(" 管理原因 ",-1)])]),_:1})])]),_:1})):v("",!0),d(R,{label:"审核备注",prop:"remark",required:!1},{default:c(()=>[d(k,{modelValue:dl.remark,"onUpdate:modelValue":a[19]||(a[19]=e=>dl.remark=e),type:"textarea",rows:4,placeholder:"rejected"===dl.result?dl.rejectionReasonId?"请输入补充说明（选填）":"请先选择拒绝原因":"请输入审核备注（选填）",maxlength:"500","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),ce.value?(n(),y(R,{key:1,label:"影响订单"},{default:c(()=>[i("div",Ea,[(n(!0),o(g,null,f(Qa.value,e=>(n(),y(La,{key:e.id,class:"order-tag",closable:"",onClose:a=>(e=>{const a=Qa.value.findIndex(a=>a.id===e.id);a>-1&&Qa.value.splice(a,1)})(e)},{default:c(()=>[p(h(e.orderNo)+" - ¥"+h((e.totalAmount||0).toLocaleString()),1)]),_:2},1032,["onClose"]))),128))])]),_:1})):v("",!0)]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),d(Zl,{modelValue:ie.value,"onUpdate:modelValue":a[24]||(a[24]=e=>ie.value=e),title:"添加订单备注",width:"500px"},{footer:c(()=>[i("div",za,[d(_,{onClick:a[23]||(a[23]=e=>ie.value=!1)},{default:c(()=>[...a[74]||(a[74]=[p("取消",-1)])]),_:1}),d(_,{onClick:Cl,type:"primary",loading:re.value},{default:c(()=>[...a[75]||(a[75]=[p(" 保存备注 ",-1)])]),_:1},8,["loading"])])]),default:c(()=>[d(D,{ref_key:"remarkFormRef",ref:Ga,model:ul,rules:pl,"label-width":"80px"},{default:c(()=>[d(R,{label:"订单号"},{default:c(()=>[d(k,{modelValue:il.value.orderNo,"onUpdate:modelValue":a[21]||(a[21]=e=>il.value.orderNo=e),disabled:""},null,8,["modelValue"])]),_:1}),d(R,{label:"备注内容",prop:"content"},{default:c(()=>[d(k,{modelValue:ul.content,"onUpdate:modelValue":a[22]||(a[22]=e=>ul.content=e),type:"textarea",rows:4,placeholder:"请输入备注内容",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),d(Zl,{modelValue:ue.value,"onUpdate:modelValue":a[25]||(a[25]=e=>ue.value=e),title:"拒绝原因管理",width:"800px",onClose:Hl},{default:c(()=>[d(ge,{onClose:Hl})]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-214b78aa"]]);export{Ma as default};
