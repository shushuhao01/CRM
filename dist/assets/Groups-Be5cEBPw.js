import{C as e,E as a,b as l}from"./elementPlus-DxaqjplL.js";import{l as t,aA as o,r as s,Z as r,b as u,ag as n,aq as i,m as c,q as d,p,U as m,O as g,S as f,u as v,P as y,M as _,T as b,F as h,a9 as C}from"./vendor-BtukhyiH.js";import{d as S}from"./sensitiveInfo-PTigg6SS.js";import{g as w,A as V,u as k,i as U,S as T,_ as O}from"./index-BGtT17ll.js";import"./utils-DfI7e5Rl.js";const z=()=>{const e=window.location.hostname;return e.includes("abc789.cn")||e.includes("vercel.app")||e.includes("netlify.app")||e.includes("railway.app")||!e.includes("localhost")&&!e.includes("127.0.0.1")},A=async e=>{if(z())try{return console.log("[CustomerGroupApi] 生产环境：调用真实API"),await w.get(V.CUSTOMERS.GROUPS.LIST,e)}catch(a){throw console.error("[CustomerGroupApi] API调用失败:",a),a}try{const a=localStorage.getItem("customer_groups");let l=a?JSON.parse(a):[];e?.name&&(l=l.filter(a=>a.name.toLowerCase().includes(e.name.toLowerCase()))),e?.status&&(l=l.filter(a=>a.status===e.status));const t=e?.page||1,o=e?.pageSize||20,s=(t-1)*o,r=s+o;return{data:{list:l.slice(s,r),total:l.length,page:t,pageSize:o},code:200,message:"success",success:!0}}catch(a){return console.error("获取分组列表失败:",a),{data:{list:[],total:0,page:1,pageSize:20},code:500,message:"获取分组列表失败",success:!1}}},G=async e=>{if(z())try{return console.log("[CustomerGroupApi] 生产环境：创建分组"),await w.post(V.CUSTOMERS.GROUPS.CREATE,e)}catch(a){throw console.error("[CustomerGroupApi] 创建分组失败:",a),a}try{const a=localStorage.getItem("customer_groups"),l=a?JSON.parse(a):[],t={...e,id:Date.now().toString(),createTime:(new Date).toLocaleString("zh-CN"),customerCount:0};return l.unshift(t),localStorage.setItem("customer_groups",JSON.stringify(l)),{data:t,code:200,message:"success",success:!0}}catch(a){return console.error("创建分组失败:",a),{data:null,code:500,message:"创建分组失败",success:!1}}},N=async(e,a)=>{if(z())try{return console.log("[CustomerGroupApi] 生产环境：更新分组"),await w.put(V.CUSTOMERS.GROUPS.UPDATE(e),a)}catch(l){throw console.error("[CustomerGroupApi] 更新分组失败:",l),l}try{const l=localStorage.getItem("customer_groups"),t=l?JSON.parse(l):[],o=t.findIndex(a=>a.id===e);return-1===o?{data:null,code:404,message:"分组不存在",success:!1}:(t[o]={...t[o],...a},localStorage.setItem("customer_groups",JSON.stringify(t)),{data:t[o],code:200,message:"success",success:!0})}catch(l){return console.error("更新分组失败:",l),{data:null,code:500,message:"更新分组失败",success:!1}}},P=async e=>{if(z())try{return console.log("[CustomerGroupApi] 生产环境：删除分组"),await w.delete(V.CUSTOMERS.GROUPS.DELETE(e))}catch(a){throw console.error("[CustomerGroupApi] 删除分组失败:",a),a}try{const a=localStorage.getItem("customer_groups"),l=(a?JSON.parse(a):[]).filter(a=>a.id!==e);return localStorage.setItem("customer_groups",JSON.stringify(l)),{data:null,code:200,message:"success",success:!0}}catch(a){return console.error("删除分组失败:",a),{data:null,code:500,message:"删除分组失败",success:!1}}},E={class:"customer-groups"},I={class:"page-header"},x={class:"header-actions"},R={class:"pagination-container"},j={class:"condition-builder"},q=O(t({__name:"Groups",setup(t){const w=o(),V=k(),O=U(),z=s(!1),q=s(!1),D=s(!1),J=s(!1),L=s(!1),M=s(""),B=s(),F=s(null),H=r({name:"",status:""}),Z=s([]),$=s([]),K=s([]),Q=r({currentPage:1,pageSize:20,total:0}),W=r({id:"",name:"",description:"",status:"active",conditions:[]}),X={name:[{required:!0,message:"请输入分组名称",trigger:"blur"}],description:[{required:!0,message:"请输入分组描述",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},Y=async()=>{z.value=!0;try{0===O.customers.length&&await O.loadCustomers();const e={name:H.name,status:H.status,page:Q.currentPage,pageSize:Q.pageSize},l=await A(e);if(l.success){const e=l.data?.list||[];e.forEach(e=>{e.customerCount=oe(e)}),Z.value=e,Q.total=l.data?.total||0,console.log("[CustomerGroups] 加载分组列表成功:",e.length)}else a.error(l.message||"加载数据失败")}catch(e){console.error("[CustomerGroups] 加载分组数据失败:",e),a.error("加载数据失败")}finally{z.value=!1}},ee=()=>{Q.currentPage=1,Y()},ae=()=>{H.name="",H.status="",ee()},le=()=>{M.value="新增分组",ue(),J.value=!0},te=(e,a)=>a&&0!==a.length?e.filter(e=>a.every(a=>{const{field:l,operator:t,value:o}=a;if(!l||!t||void 0===o||""===o)return!0;let s=e[l];switch(l){case"level":s=e.level||"bronze";break;case"registerTime":s=e.createTime?new Date(e.createTime).getTime():0;break;case"lastOrderTime":s=e.lastOrderTime?new Date(e.lastOrderTime).getTime():0;break;case"totalAmount":s=e.totalAmount||0}switch(t){case"eq":return s===o;case"ne":return s!==o;case"gt":return Number(s)>Number(o);case"lt":return Number(s)<Number(o);case"gte":return Number(s)>=Number(o);case"lte":return Number(s)<=Number(o);case"contains":return String(s).toLowerCase().includes(String(o).toLowerCase());default:return!1}})):e,oe=e=>{const a=O.customers||[];return te(a,e.conditions).length},se=async()=>{if(B.value)try{let e;await B.value.validate(),q.value=!0,e=W.id?await N(W.id,{name:W.name,description:W.description,status:W.status,conditions:W.conditions}):await G({name:W.name,description:W.description,status:W.status,conditions:W.conditions}),e.success?(a.success(W.id?"更新成功":"创建成功"),J.value=!1,Y()):a.error(e.message||"操作失败")}catch(e){console.error("提交分组失败:",e),a.error("操作失败")}finally{q.value=!1}},re=()=>{B.value?.clearValidate(),ue()},ue=()=>{W.id="",W.name="",W.description="",W.status="active",W.conditions=[]},ne=e=>{$.value=e},ie=()=>{W.conditions.push({field:"",operator:"",value:""})};return u(()=>{Y()}),(t,o)=>{const s=n("el-icon"),r=n("el-button"),u=n("el-input"),k=n("el-form-item"),U=n("el-option"),A=n("el-select"),G=n("el-form"),N=n("el-card"),$=n("el-table-column"),oe=n("el-tag"),ue=n("el-table"),ce=n("el-pagination"),de=n("el-radio"),pe=n("el-radio-group"),me=n("el-dialog"),ge=n("el-link"),fe=i("loading");return d(),c("div",E,[p("div",I,[o[11]||(o[11]=p("h2",null,"客户分组管理",-1)),p("div",x,[m(r,{type:"primary",onClick:le},{default:g(()=>[m(s,null,{default:g(()=>[m(v(e))]),_:1}),o[10]||(o[10]=f(" 新增分组 ",-1))]),_:1})])]),m(N,{class:"search-card"},{default:g(()=>[m(G,{model:H,inline:""},{default:g(()=>[m(k,{label:"分组名称"},{default:g(()=>[m(u,{modelValue:H.name,"onUpdate:modelValue":o[0]||(o[0]=e=>H.name=e),placeholder:"请输入分组名称",clearable:""},null,8,["modelValue"])]),_:1}),m(k,{label:"状态"},{default:g(()=>[m(A,{modelValue:H.status,"onUpdate:modelValue":o[1]||(o[1]=e=>H.status=e),placeholder:"请选择状态",clearable:""},{default:g(()=>[m(U,{label:"启用",value:"active"}),m(U,{label:"禁用",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),m(k,null,{default:g(()=>[m(r,{type:"primary",onClick:ee},{default:g(()=>[...o[12]||(o[12]=[f("搜索",-1)])]),_:1}),m(r,{onClick:ae},{default:g(()=>[...o[13]||(o[13]=[f("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),m(N,{class:"table-card"},{default:g(()=>[y((d(),_(ue,{data:Z.value,onSelectionChange:ne},{default:g(()=>[m($,{type:"selection",width:"55"}),m($,{prop:"name",label:"分组名称"}),m($,{prop:"description",label:"分组描述"}),m($,{prop:"customerCount",label:"客户数量"}),m($,{prop:"status",label:"状态"},{default:g(({row:e})=>[m(oe,{type:"active"===e.status?"success":"danger"},{default:g(()=>[f(b("active"===e.status?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),m($,{prop:"createTime",label:"创建时间"}),m($,{label:"操作",width:"250"},{default:g(({row:e})=>[m(r,{type:"primary",size:"small",onClick:a=>(e=>{M.value="编辑分组",Object.assign(W,{...e,conditions:e.conditions||[]}),J.value=!0})(e)},{default:g(()=>[...o[14]||(o[14]=[f("编辑",-1)])]),_:1},8,["onClick"]),m(r,{type:"info",size:"small",onClick:l=>(async e=>{F.value=e,L.value=!0,D.value=!0;try{const a=O.customers||[],l=te(a,e.conditions);K.value=l,console.log("[CustomerGroups] 分组客户数量:",l.length)}catch(l){console.error("[CustomerGroups] 加载客户数据失败:",l),a.error("加载客户数据失败")}finally{D.value=!1}})(e)},{default:g(()=>[...o[15]||(o[15]=[f("查看客户",-1)])]),_:1},8,["onClick"]),m(r,{type:"danger",size:"small",onClick:t=>(async e=>{try{await l.confirm(`确定要删除分组"${e.name}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await P(e.id);t.success?(a.success("删除成功"),Y()):a.error(t.message||"删除失败")}catch(t){"cancel"!==t&&(console.error("删除分组失败:",t),a.error("删除失败"))}})(e)},{default:g(()=>[...o[16]||(o[16]=[f("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[fe,z.value]]),p("div",R,[m(ce,{"current-page":Q.currentPage,"onUpdate:currentPage":o[2]||(o[2]=e=>Q.currentPage=e),"page-size":Q.pageSize,"onUpdate:pageSize":o[3]||(o[3]=e=>Q.pageSize=e),"page-sizes":[10,20,50,100],total:Q.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Y,onCurrentChange:Y},null,8,["current-page","page-size","total"])])]),_:1}),m(me,{modelValue:J.value,"onUpdate:modelValue":o[8]||(o[8]=e=>J.value=e),title:M.value,width:"600px",onClose:re},{footer:g(()=>[m(r,{onClick:o[7]||(o[7]=e=>J.value=!1)},{default:g(()=>[...o[21]||(o[21]=[f("取消",-1)])]),_:1}),m(r,{type:"primary",onClick:se,loading:q.value},{default:g(()=>[...o[22]||(o[22]=[f(" 确定 ",-1)])]),_:1},8,["loading"])]),default:g(()=>[m(G,{ref_key:"formRef",ref:B,model:W,rules:X,"label-width":"100px"},{default:g(()=>[m(k,{label:"分组名称",prop:"name"},{default:g(()=>[m(u,{modelValue:W.name,"onUpdate:modelValue":o[4]||(o[4]=e=>W.name=e),placeholder:"请输入分组名称"},null,8,["modelValue"])]),_:1}),m(k,{label:"分组描述",prop:"description"},{default:g(()=>[m(u,{modelValue:W.description,"onUpdate:modelValue":o[5]||(o[5]=e=>W.description=e),type:"textarea",rows:3,placeholder:"请输入分组描述"},null,8,["modelValue"])]),_:1}),m(k,{label:"状态",prop:"status"},{default:g(()=>[m(pe,{modelValue:W.status,"onUpdate:modelValue":o[6]||(o[6]=e=>W.status=e)},{default:g(()=>[m(de,{label:"active"},{default:g(()=>[...o[17]||(o[17]=[f("启用",-1)])]),_:1}),m(de,{label:"inactive"},{default:g(()=>[...o[18]||(o[18]=[f("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),m(k,{label:"分组条件"},{default:g(()=>[p("div",j,[(d(!0),c(h,null,C(W.conditions,(e,a)=>(d(),c("div",{key:a,class:"condition-item"},[m(A,{modelValue:e.field,"onUpdate:modelValue":a=>e.field=a,placeholder:"选择字段"},{default:g(()=>[m(U,{label:"客户等级",value:"level"}),m(U,{label:"注册时间",value:"registerTime"}),m(U,{label:"最后消费时间",value:"lastOrderTime"}),m(U,{label:"消费金额",value:"totalAmount"})]),_:1},8,["modelValue","onUpdate:modelValue"]),m(A,{modelValue:e.operator,"onUpdate:modelValue":a=>e.operator=a,placeholder:"选择条件"},{default:g(()=>[m(U,{label:"等于",value:"eq"}),m(U,{label:"不等于",value:"ne"}),m(U,{label:"大于",value:"gt"}),m(U,{label:"小于",value:"lt"}),m(U,{label:"包含",value:"contains"})]),_:1},8,["modelValue","onUpdate:modelValue"]),m(u,{modelValue:e.value,"onUpdate:modelValue":a=>e.value=a,placeholder:"输入值"},null,8,["modelValue","onUpdate:modelValue"]),m(r,{type:"danger",size:"small",onClick:e=>(e=>{W.conditions.splice(e,1)})(a)},{default:g(()=>[...o[19]||(o[19]=[f("删除",-1)])]),_:1},8,["onClick"])]))),128)),m(r,{type:"primary",size:"small",onClick:ie},{default:g(()=>[...o[20]||(o[20]=[f("添加条件",-1)])]),_:1})])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),m(me,{modelValue:L.value,"onUpdate:modelValue":o[9]||(o[9]=e=>L.value=e),title:"分组客户列表",width:"800px"},{default:g(()=>[y((d(),_(ue,{data:K.value},{default:g(()=>[m($,{prop:"name",label:"客户姓名",width:"120"},{default:g(({row:e})=>[m(ge,{type:"primary",onClick:a=>{return l=e,void w.push({name:"CustomerDetail",params:{id:l.id}});var l},underline:!1},{default:g(()=>[f(b(e.name),1)]),_:2},1032,["onClick"])]),_:1}),m($,{prop:"phone",label:"手机号"},{default:g(({row:e})=>[f(b(v(S)(e.phone,v(T).PHONE,v(V).currentUser?.id||"")),1)]),_:1}),m($,{prop:"level",label:"客户等级"},{default:g(({row:e})=>["diamond"===e.level?(d(),_(oe,{key:0,type:"danger"},{default:g(()=>[...o[23]||(o[23]=[f("钻石",-1)])]),_:1})):"gold"===e.level?(d(),_(oe,{key:1,type:"warning"},{default:g(()=>[...o[24]||(o[24]=[f("金牌",-1)])]),_:1})):"silver"===e.level?(d(),_(oe,{key:2,type:"info"},{default:g(()=>[...o[25]||(o[25]=[f("银牌",-1)])]),_:1})):(d(),_(oe,{key:3,type:""},{default:g(()=>[...o[26]||(o[26]=[f("铜牌",-1)])]),_:1}))]),_:1}),m($,{prop:"totalAmount",label:"消费金额"},{default:g(({row:e})=>[f(" ¥"+b((e.totalAmount||0).toFixed(2)),1)]),_:1}),m($,{prop:"lastOrderTime",label:"最后消费时间"})]),_:1},8,["data"])),[[fe,D.value]])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-0c4f1931"]]);export{q as default};
