import{u as e,d as t,i as l,f as a,e as r,E as n,l as o,c as s,_ as i}from"./index-BGtT17ll.js";import{l as u,aA as d,r as c,e as m,Z as p,w as g,b as v,Y as f,ag as h,m as b,q as w,p as _,U as y,O as S,u as C,T as A,F as k,a9 as D,S as R,M as I,Q as x}from"./vendor-BtukhyiH.js";import{useDepartmentStore as T}from"./department-BMF6-9dP.js";import{T as N}from"./TableColumnSettings-CpY_V997.js";import{t as U,a4 as V,U as $,z,ab as O,ad as j,F as P,G as Y,s as M,ae as F,E}from"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";const L={class:"team-performance"},J={class:"metrics-grid"},B={class:"metrics-row"},H={class:"metric-card"},W={class:"metric-icon total-performance"},q={class:"metric-content"},G={class:"metric-value"},Q={class:"metric-card"},Z={class:"metric-icon total-orders"},K={class:"metric-content"},X={class:"metric-value"},ee={class:"metric-card"},te={class:"metric-icon avg-performance"},le={class:"metric-content"},ae={class:"metric-value"},re={class:"metrics-row"},ne={class:"metric-card"},oe={class:"metric-icon sign-orders"},se={class:"metric-content"},ie={class:"metric-value"},ue={class:"metric-card"},de={class:"metric-icon sign-rate"},ce={class:"metric-content"},me={class:"metric-value"},pe={class:"metric-card"},ge={class:"metric-icon sign-performance"},ve={class:"metric-content"},fe={class:"metric-value"},he={class:"quick-filters"},be={class:"filter-section"},we={class:"filter-left"},_e={class:"filter-right"},ye={class:"performance-table"},Se={key:0,class:"amount"},Ce={key:2,class:"count"},Ae={key:3},ke={class:"pagination-wrapper"},De={key:0,class:"member-detail-content"},Re={class:"member-info"},Ie={class:"info-item"},xe={class:"value"},Te={class:"info-item"},Ne={class:"value"},Ue={class:"info-item"},Ve={class:"value"},$e={class:"info-item"},ze={class:"value"},Oe={class:"order-section"},je={class:"amount"},Pe={class:"deposit"},Ye={class:"collection"},Me={class:"product-details-cell"},Fe={class:"order-pagination"},Ee={class:"fullscreen-content"},Le={class:"fullscreen-filters"},Je={class:"filter-left"},Be={class:"filter-right"},He={class:"fullscreen-table"},We={class:"amount"},qe={class:"amount"},Ge={class:"amount"},Qe={class:"amount"},Ze={class:"amount"},Ke={class:"amount"},Xe={class:"operation-buttons"},et={class:"fullscreen-pagination"},tt={class:"stats-section"},lt={class:"dialog-footer"},at="team-performance-columns",rt=i(u({__name:"Team",setup(i){const u=d(),rt=s(u),nt=e(),ot=T(),st=t(),it=l(),ut=a(),dt=c(!1),ct=c("today"),mt=c(["2025-01-01","2025-01-31"]),pt=c(""),gt=c("orderAmount"),vt=m(()=>{const e=nt.currentUser;return e?"super_admin"===e.role||"admin"===e.role?ot.departmentList:"department_manager"===e.role||"sales_staff"===e.role?ot.departmentList.filter(t=>t.id===e.departmentId||t.id===e.department):[]:[]}),ft=c(!1),ht=p({enabled:!0,permissionType:"all",allowedRoles:["super_admin","admin","department_manager","sales"],whitelist:[],dailyLimit:0}),bt=c(),wt=c([{prop:"department",label:"部门",width:100,align:"center",visible:!0},{prop:"username",label:"用户名",width:100,align:"center",visible:!0},{prop:"employeeNumber",label:"工号",width:100,align:"center",visible:!1},{prop:"createTime",label:"创建时间",width:110,align:"center",visible:!1},{prop:"orderCount",label:"下单单数",width:90,align:"center",visible:!0},{prop:"orderAmount",label:"下单业绩",width:120,align:"center",visible:!0},{prop:"shipCount",label:"发货单数",width:90,align:"center",visible:!0},{prop:"shipAmount",label:"发货业绩",width:120,align:"center",visible:!0},{prop:"shipRate",label:"发货率",width:80,align:"center",visible:!0},{prop:"signCount",label:"签收单数",width:90,align:"center",visible:!0},{prop:"signAmount",label:"签收业绩",width:120,align:"center",visible:!0},{prop:"signRate",label:"签收率",width:80,align:"center",visible:!0},{prop:"transitCount",label:"在途单数",width:90,align:"center",visible:!0},{prop:"transitAmount",label:"在途业绩",width:120,align:"center",visible:!0},{prop:"transitRate",label:"在途率",width:80,align:"center",visible:!0},{prop:"rejectCount",label:"拒收单数",width:90,align:"center",visible:!0},{prop:"rejectAmount",label:"拒收业绩",width:120,align:"center",visible:!0},{prop:"rejectRate",label:"拒收率",width:80,align:"center",visible:!0},{prop:"returnCount",label:"退货单数",width:90,align:"center",visible:!0},{prop:"returnAmount",label:"退货业绩",width:120,align:"center",visible:!0},{prop:"returnRate",label:"退货率",width:80,align:"center",visible:!0}]),_t=m(()=>wt.value.filter(e=>e.visible)),yt=p({todayCount:0,weekCount:0,monthCount:0}),St=m(()=>nt.users||[]),Ct=c(1),At=c(30),kt=c(100),Dt=c(!1),Rt=c(null),It=c(1),xt=c(30),Tt=c(50),Nt=c(1),Ut=c(!1),Vt=m(()=>{const e=nt.currentUser;if(!e)return{totalPerformance:0,totalOrders:0,avgPerformance:0,signOrders:0,signRate:0,signPerformance:0};let t=st.orders.filter(e=>"approved"===e.auditStatus);if(mt.value&&2===mt.value.length&&mt.value[0]&&mt.value[1]){const[e,l]=mt.value;t=t.filter(t=>{const a=(t.orderDate||t.createTime)?.split(" ")[0]||"";return a>=e&&a<=l})}nt.isSuperAdmin||"admin"===e.role||"super_admin"===e.role||(t=nt.isManager||"department_manager"===e.role?t.filter(t=>{const l=nt.getUserById?.(t.salesPersonId);return l?.departmentId===e.departmentId}):t.filter(t=>{const l=nt.getUserById?.(t.salesPersonId);return l?.departmentId===e.departmentId}));const l=t.reduce((e,t)=>e+t.totalAmount,0),a=t.length,r=t.filter(e=>"delivered"===e.status),n=r.length,o=r.reduce((e,t)=>e+t.totalAmount,0),s=a>0?n/a*100:0,i=(()=>{const e=nt.currentUser;if(!e)return 0;let t=0;return t=nt.isSuperAdmin||"admin"===e.role?nt.users?.filter(e=>"sales_staff"===e.role||"department_manager"===e.role).length||0:(nt.isManager||e.role,nt.users?.filter(t=>t.departmentId===e.departmentId&&("sales_staff"===t.role||"department_manager"===t.role)).length||0),t})();return{totalPerformance:l,totalOrders:a,avgPerformance:i>0?l/i:0,signOrders:n,signRate:Number(s.toFixed(1)),signPerformance:o}}),$t=[{label:"今日",value:"today"},{label:"昨日",value:"yesterday"},{label:"本周",value:"thisWeek"},{label:"上周",value:"lastWeek"},{label:"近7天",value:"last7days"},{label:"本月",value:"thisMonth"},{label:"今年",value:"thisYear"},{label:"全部",value:"all"}],zt=m(()=>{const e=nt.currentUser;if(!e)return console.log("[团队业绩] 当前用户不存在"),[];console.log("[团队业绩] 当前用户:",e.name,"角色:",e.role),console.log("[团队业绩] 系统总用户数:",nt.users?.length||0);let t=[];if(nt.isSuperAdmin||"admin"===e.role||"super_admin"===e.role?(t=nt.users||[],console.log("[团队业绩] 超级管理员，可访问所有用户:",t.length)):nt.isManager||"department_manager"===e.role?(t=nt.users?.filter(t=>t.departmentId===e.departmentId)||[],console.log("[团队业绩] 部门经理，可访问本部门用户:",t.length)):(t=nt.users?.filter(t=>t.departmentId===e.departmentId)||[],console.log("[团队业绩] 普通成员，可访问同部门用户:",t.length)),pt.value){console.log("[团队业绩] 应用部门筛选:",pt.value);const e=t.length;t=t.filter(e=>String(e.departmentId)===String(pt.value)),console.log("[团队业绩] 筛选后用户数:",t.length,"(筛选前:",e,")")}return t.map(t=>{let l=st.orders.filter(e=>"approved"===e.auditStatus&&(!(!e.salesPersonId||!t.id||String(e.salesPersonId)!==String(t.id))||!(!e.createdBy||!t.name||e.createdBy!==t.name)));if(mt.value&&2===mt.value.length&&mt.value[0]&&mt.value[1]){const[e,t]=mt.value;l=l.filter(l=>{const a=(l.orderDate||l.createTime)?.split(" ")[0]||"";return a>=e&&a<=t})}const a=l.length,r=l.reduce((e,t)=>e+(t.totalAmount||0),0);let n=0,o=0,s=0,i=0;ut.performanceShares&&ut.performanceShares.forEach(e=>{if("active"===e.status){if(mt.value&&2===mt.value.length&&mt.value[0]&&mt.value[1]){const[t,l]=mt.value,a=(e.shareDate||e.createdAt)?.split(" ")[0]||"";if(a<t||a>l)return}if(String(e.createdById)===String(t.id)){if(l.find(t=>t.orderNumber===e.orderNumber)){const t=e.shareMembers.reduce((e,t)=>e+t.percentage,0)/100;n+=(e.orderAmount||0)*t,s+=t}}e.shareMembers.forEach(l=>{if(String(l.userId)===String(t.id)){const t=l.percentage/100;o+=(e.orderAmount||0)*t,i+=t}})}});const u=Math.max(0,r-n+o),d=Math.max(0,a-s+i),c=l.filter(e=>"shipped"===e.status||"delivered"===e.status),m=c.length,p=c.reduce((e,t)=>e+t.totalAmount,0),g=a>0?m/a*100:0,v=l.filter(e=>"delivered"===e.status),f=v.length,h=v.reduce((e,t)=>e+t.totalAmount,0),b=a>0?f/a*100:0,w=l.filter(e=>"shipped"===e.status&&"delivered"!==e.logisticsStatus),_=w.length,y=w.reduce((e,t)=>e+t.totalAmount,0),S=a>0?_/a*100:0,C=l.filter(e=>"rejected"===e.status||"rejected_returned"===e.status),A=C.length,k=C.reduce((e,t)=>e+t.totalAmount,0),D=a>0?A/a*100:0,R=l.filter(e=>"logistics_returned"===e.status),I=R.length,x=R.reduce((e,t)=>e+t.totalAmount,0),T=a>0?I/a*100:0;let N="未知部门";if(t.departmentId){const e=ot.departments?.find(e=>String(e.id)===String(t.departmentId));e?N=e.name:t.department&&"未知部门"!==t.department&&(N=t.department)}else t.department&&"未知部门"!==t.department&&(N=t.department);let U="2023/01/01";const V=t.createTime||t.createdAt;if(V){U=V.split(" ")[0].replace(/-/g,"/")}return{id:t.id,name:t.name||t.realName||"未知",username:t.username||"-",employeeNumber:t.employeeNumber||"-",department:N,createTime:U,joinDate:U,orderCount:d,orderAmount:u,originalAmount:r,sharedAmount:n,receivedAmount:o,shipCount:m,shipAmount:p,shipRate:Number(g.toFixed(1)),signCount:f,signAmount:h,signRate:Number(b.toFixed(1)),transitCount:_,transitAmount:y,transitRate:Number(S.toFixed(1)),rejectCount:A,rejectAmount:k,rejectRate:Number(D.toFixed(1)),returnCount:I,returnAmount:x,returnRate:Number(T.toFixed(1)),isCurrentUser:t.id===e.id}}).sort((e,t)=>{switch(gt.value){case"orderAmount":default:return t.orderAmount-e.orderAmount;case"signAmount":return t.signAmount-e.signAmount;case"signRate":return t.signRate-e.signRate;case"orderCount":return t.orderCount-e.orderCount}})}),Ot=c(null),jt=m(()=>{if(!Ot.value||!Rt.value)return console.log("[订单列表] 未选择成员"),[];const e=Rt.value;console.log("[订单列表] 查询成员订单:",e.name,"ID:",Ot.value),console.log("[订单列表] 筛选日期范围:",mt.value);const t=st.orders.filter(t=>{if("approved"!==t.auditStatus)return!1;if(mt.value&&2===mt.value.length&&mt.value[0]&&mt.value[1]){const e=(t.orderDate||t.createTime||"").split(" ")[0],l=mt.value[0],a=mt.value[1];if(e<l||e>a)return!1}return!(!t.salesPersonId||!Ot.value||String(t.salesPersonId)!==String(Ot.value))||!(!t.createdBy||!e.name||t.createdBy!==e.name)});return console.log("[订单列表] 找到订单数量:",t.length),t.map(e=>{const t=it.customers?.find(t=>t.id===e.customerId);return{id:e.id,orderNo:e.orderNumber||e.id,orderDate:e.createTime||"",customerName:t?.name||e.customerName||"未知客户",amount:e.totalAmount,depositAmount:e.depositAmount||0,collectionAmount:e.totalAmount-(e.depositAmount||0),logisticsCompany:e.logisticsCompany||"待发货",trackingNumber:e.trackingNumber||"暂无",productDetails:e.products?.map(e=>`${e.name} x${e.quantity}`).join(", ")||"暂无详情"}})}),Pt=m(()=>{const e=(It.value-1)*xt.value,t=e+xt.value;return jt.value.slice(e,t)});g(jt,e=>{Tt.value=e.length,It.value=1},{immediate:!0});const Yt=e=>e.toLocaleString(),Mt=e=>{ct.value=e;const t=new Date,l=e=>e.toISOString().split("T")[0];switch(e){case"all":mt.value=["",""];break;case"today":mt.value=[l(t),l(t)];break;case"yesterday":const e=new Date(t);e.setDate(t.getDate()-1),mt.value=[l(e),l(e)];break;case"thisWeek":const a=new Date(t);a.setDate(t.getDate()-t.getDay()),mt.value=[l(a),l(t)];break;case"lastWeek":const r=new Date(t);r.setDate(t.getDate()-t.getDay()-1);const n=new Date(r);n.setDate(r.getDate()-6),mt.value=[l(n),l(r)];break;case"last7days":const o=new Date(t);o.setDate(t.getDate()-7),mt.value=[l(o),l(t)];break;case"thisMonth":const s=new Date(t.getFullYear(),t.getMonth(),1);mt.value=[l(s),l(t)];break;case"thisYear":const i=new Date(t.getFullYear(),0,1);mt.value=[l(i),l(t)]}},Ft=async()=>{console.log("刷新数据",{dateRange:mt.value,selectedDepartment:pt.value,sortBy:gt.value}),await il(),E.success("数据已刷新")},Et=e=>{wt.value=e},Lt=m(()=>{const e=nt.currentUser;return!!e&&("super_admin"===e.role||"admin"===e.role)}),Jt=m(()=>{const e=localStorage.getItem("crm_performance_export_config");if(!e)return!0;try{const t=JSON.parse(e);if(!t.enabled)return!1;const l=nt.currentUser;return!!l&&("all"===t.permissionType||("role"===t.permissionType?t.allowedRoles?.includes(l.role)||!1:"whitelist"===t.permissionType&&t.whitelist?.includes(l.id)||!1))}catch(t){return console.error("解析导出配置失败:",t),!0}}),Bt=()=>{Ht(),Wt(),ft.value=!0},Ht=()=>{const e=localStorage.getItem("crm_performance_export_config");if(e)try{const t=JSON.parse(e);Object.assign(ht,t)}catch(t){console.error("加载导出配置失败:",t)}},Wt=()=>{const e=localStorage.getItem("crm_performance_export_stats");if(e)try{const t=JSON.parse(e),l=(new Date).toISOString().split("T")[0],a=qt(new Date),r=(new Date).toISOString().slice(0,7);yt.todayCount=t[l]||0,yt.weekCount=Object.keys(t).filter(e=>qt(new Date(e))===a).reduce((e,l)=>e+(t[l]||0),0),yt.monthCount=Object.keys(t).filter(e=>e.startsWith(r)).reduce((e,l)=>e+(t[l]||0),0)}catch(t){console.error("加载导出统计失败:",t)}},qt=e=>{const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),l=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-l);const a=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t.getTime()-a.getTime())/864e5+1)/7)},Gt=()=>{const e={enabled:ht.enabled,permissionType:ht.permissionType,allowedRoles:ht.allowedRoles,whitelist:ht.whitelist,dailyLimit:ht.dailyLimit};localStorage.setItem("crm_performance_export_config",JSON.stringify(e)),E.success("导出权限设置已保存并全局生效"),ft.value=!1},Qt=()=>{ht.enabled=!0,ht.permissionType="all",ht.allowedRoles=["super_admin","admin","department_manager","sales"],ht.whitelist=[],ht.dailyLimit=0,Gt(),E.success("已恢复默认设置")},Zt=async()=>{if((()=>{try{const e=localStorage.getItem("crm_performance_export_config");if(!e)return!0;const t=JSON.parse(e).dailyLimit||0;if(0===t)return!0;const l=(new Date).toISOString().split("T")[0],a=localStorage.getItem("crm_performance_export_stats");return!(((a?JSON.parse(a):{})[l]||0)>=t&&(E.warning(`每日导出次数已达上限（${t}次）`),1))}catch(e){return console.error("检查导出限制失败:",e),!0}})())try{const e=await o(()=>import("./utils-DfI7e5Rl.js").then(e=>e.x),[]),t=mt.value&&2===mt.value.length?`${mt.value[0]}_${mt.value[1]}`:"全部时间",l=e.utils.book_new(),a=[["团队业绩汇总报表"],["统计时间",t.replace("_"," 至 ")],["生成时间",(new Date).toLocaleString("zh-CN")],[],["指标","数值"],["团队总业绩",`¥${Yt(Vt.value.totalPerformance)}`],["团队订单",Vt.value.totalOrders],["人均业绩",`¥${Yt(Vt.value.avgPerformance)}`],["签收单数",Vt.value.signOrders],["签收率",`${Vt.value.signRate}%`],["签收业绩",`¥${Yt(Vt.value.signPerformance)}`]],r=e.utils.aoa_to_sheet(a);r["!cols"]=[{wch:15},{wch:20}],e.utils.book_append_sheet(l,r,"团队概览");const n=[["成员业绩明细"],[],["序号","部门","成员","用户名","工号","创建时间","下单单数","下单业绩","发货单数","发货业绩","发货率","签收单数","签收业绩","签收率","在途单数","在途业绩","在途率","拒收单数","拒收业绩","拒收率","退货单数","退货业绩","退货率"]];zt.value.forEach((e,t)=>{n.push([t+1,e.department,e.name,e.username,e.employeeNumber,e.createTime,e.orderCount,e.orderAmount,e.shipCount,e.shipAmount,`${e.shipRate}%`,e.signCount,e.signAmount,`${e.signRate}%`,e.transitCount,e.transitAmount,`${e.transitRate}%`,e.rejectCount,e.rejectAmount,`${e.rejectRate}%`,e.returnCount,e.returnAmount,`${e.returnRate}%`])});const s=e.utils.aoa_to_sheet(n);s["!cols"]=[{wch:6},{wch:12},{wch:10},{wch:12},{wch:12},{wch:18},{wch:10},{wch:12},{wch:10},{wch:12},{wch:8},{wch:10},{wch:12},{wch:8},{wch:10},{wch:12},{wch:8},{wch:10},{wch:12},{wch:8},{wch:10},{wch:12},{wch:8}],e.utils.book_append_sheet(l,s,"成员业绩明细");const i=[["业绩排行榜"],[],["排名","成员","用户名","工号","部门","下单业绩","签收业绩","签收率"]];[...zt.value].sort((e,t)=>t.orderAmount-e.orderAmount).forEach((e,t)=>{i.push([t+1,e.name,e.username,e.employeeNumber,e.department,e.orderAmount,e.signAmount,`${e.signRate}%`])});const u=e.utils.aoa_to_sheet(i);u["!cols"]=[{wch:6},{wch:12},{wch:12},{wch:12},{wch:12},{wch:15},{wch:15},{wch:10}],e.utils.book_append_sheet(l,u,"业绩排行榜");const d=new Date,c=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`,m=`团队业绩报表_${t}_${c}_${`${String(d.getHours()).padStart(2,"0")}${String(d.getMinutes()).padStart(2,"0")}${String(d.getSeconds()).padStart(2,"0")}`}.xlsx`;e.writeFile(l,m),(()=>{try{const e=(new Date).toISOString().split("T")[0],t=localStorage.getItem("crm_performance_export_stats"),l=t?JSON.parse(t):{};l[e]=(l[e]||0)+1,localStorage.setItem("crm_performance_export_stats",JSON.stringify(l))}catch(e){console.error("记录导出统计失败:",e)}})(),E.success("数据导出成功")}catch(e){console.error("导出失败:",e),E.error("数据导出失败，请重试")}},Kt=()=>{Ut.value=!0},Xt=({row:e})=>e.isCurrentUser?"current-user-row":"",el=e=>{const{columns:t,data:l}=e,a=[];return t.forEach((e,t)=>{if(0===t)return void(a[t]="合计");if(1===t)return void(a[t]=`${l.length}人`);const r=e.property;if(r){if(r.includes("Amount")){const e=l.reduce((e,t)=>e+(Number(t[r])||0),0);return void(a[t]=`¥${Yt(e)}`)}if(r.includes("Count")){const e=l.reduce((e,t)=>e+(Number(t[r])||0),0);return void(a[t]=e%1==0?String(e):e.toFixed(1))}if(r.includes("Rate")){const e=l.filter(e=>void 0!==e[r]&&null!==e[r]);if(e.length>0){const l=e.reduce((e,t)=>e+(Number(t[r])||0),0)/e.length;a[t]=`${l.toFixed(1)}%`}else a[t]="0%";return}a[t]=""}else a[t]=""}),a},tl=e=>{const{columns:t,data:l}=e,a=[];return t.forEach((e,t)=>{if(0===t)return void(a[t]="合计");if(1===t)return void(a[t]=`${l.length}人`);const r=e.property;if(r){if(r.includes("Amount")){const e=l.reduce((e,t)=>e+(Number(t[r])||0),0);return void(a[t]=`¥${Yt(e)}`)}if(r.includes("Count")){const e=l.reduce((e,t)=>e+(Number(t[r])||0),0);return void(a[t]=e%1==0?String(e):e.toFixed(1))}if(r.includes("Rate")){const e=l.filter(e=>void 0!==e[r]&&null!==e[r]);if(e.length>0){const l=e.reduce((e,t)=>e+(Number(t[r])||0),0)/e.length;a[t]=`${l.toFixed(1)}%`}else a[t]="0%";return}["department","username","employeeNumber","createTime"].includes(r)?a[t]="-":a[t]=""}else a[t]=""}),a},ll=e=>e>=90?"success":e>=80?"warning":e>=70?"info":"danger",al=e=>{Rt.value=e,Dt.value=!0,rl(e.id)},rl=e=>{Ot.value=e,Nt.value=1,console.log("加载成员订单",e,"订单数量:",jt.value.length)},nl=e=>{At.value=e,Ct.value=1,Ft()},ol=e=>{Ct.value=e,Ft()},sl=()=>{Rt.value?.id&&rl(Number(Rt.value.id))},il=async()=>{try{dt.value=!0,await Promise.all([st.getOrders(),it.loadCustomers(),nt.loadUsers(),ot.initData()])}catch(e){console.error("刷新数据失败:",e),E.error("数据刷新失败")}finally{dt.value=!1}};g([()=>st.orders,()=>nt.users,()=>ot.departments,()=>ct.value],()=>{},{deep:!0});let ul=null;const dl=()=>{console.log("[团队业绩] 收到订单状态变化事件，刷新数据"),il()};return v(async()=>{const e=localStorage.getItem(at);if(e)try{const t=JSON.parse(e);t.some(e=>("employeeNumber"===e.prop||"createTime"===e.prop)&&!0===e.visible)&&(localStorage.removeItem(at),console.log("[团队业绩] 清除旧的列设置缓存"))}catch(l){localStorage.removeItem(at)}0===ot.departments.length&&await ot.fetchDepartments();const t=nt.currentUser;if(t&&("department_manager"!==t.role&&"sales_staff"!==t.role||(pt.value=t.departmentId||t.department||"",console.log("[团队业绩] 默认选择部门:",pt.value))),t&&st.orders.length>0){let e=0;if(st.orders.forEach(l=>{l.salesPersonId&&void 0!==l.salesPersonId||(l.salesPersonId=t.id,e++)}),e>0){console.log(`[团队业绩] 自动修复了 ${e} 个订单的salesPersonId`),console.log(`[团队业绩] 当前用户ID: ${t.id} (类型: ${typeof t.id})`);const l=st.orders.filter(e=>String(e.salesPersonId)===String(t.id));console.log(`[团队业绩] 修复后匹配到 ${l.length} 个订单`),st.orders=[...st.orders];const a={orders:st.orders};localStorage.setItem("crm_store_order",JSON.stringify({data:a})),console.log("[团队业绩] 已保存到localStorage，即将刷新页面"),setTimeout(()=>{location.reload()},500),console.log("[团队业绩] 已保存到localStorage")}}Mt("today"),await il(),ul=setInterval(il,3e5),r.on(n.ORDER_STATUS_CHANGED,dl),r.on(n.REFRESH_ORDER_LIST,dl)}),f(()=>{ul&&clearInterval(ul),r.off(n.ORDER_STATUS_CHANGED,dl),r.off(n.REFRESH_ORDER_LIST,dl)}),(e,t)=>{const l=h("el-icon"),a=h("el-button"),r=h("el-date-picker"),n=h("el-option"),o=h("el-select"),s=h("el-table-column"),i=h("el-tag"),u=h("el-table"),d=h("el-pagination"),c=h("el-dialog"),m=h("el-switch"),p=h("el-form-item"),g=h("el-radio"),v=h("el-radio-group"),f=h("el-checkbox"),T=h("el-checkbox-group"),E=h("el-input-number"),ot=h("el-form"),st=h("el-divider"),it=h("el-descriptions-item"),ut=h("el-descriptions");return w(),b("div",L,[t[59]||(t[59]=_("div",{class:"page-header"},[_("h1",{class:"page-title"},"团队业绩")],-1)),_("div",J,[_("div",B,[_("div",H,[_("div",W,[y(l,null,{default:S(()=>[y(C(U))]),_:1})]),_("div",q,[_("div",G,"¥"+A(Yt(Vt.value.totalPerformance)),1),t[21]||(t[21]=_("div",{class:"metric-label"},"团队总业绩",-1))])]),_("div",Q,[_("div",Z,[y(l,null,{default:S(()=>[y(C(V))]),_:1})]),_("div",K,[_("div",X,A(Vt.value.totalOrders),1),t[22]||(t[22]=_("div",{class:"metric-label"},"团队订单",-1))])]),_("div",ee,[_("div",te,[y(l,null,{default:S(()=>[y(C($))]),_:1})]),_("div",le,[_("div",ae,"¥"+A(Yt(Vt.value.avgPerformance)),1),t[23]||(t[23]=_("div",{class:"metric-label"},"人均业绩",-1))])])]),_("div",re,[_("div",ne,[_("div",oe,[y(l,null,{default:S(()=>[y(C(z))]),_:1})]),_("div",se,[_("div",ie,A(Vt.value.signOrders),1),t[24]||(t[24]=_("div",{class:"metric-label"},"签收单数",-1))])]),_("div",ue,[_("div",de,[y(l,null,{default:S(()=>[y(C(O))]),_:1})]),_("div",ce,[_("div",me,A(Vt.value.signRate)+"%",1),t[25]||(t[25]=_("div",{class:"metric-label"},"签收率",-1))])]),_("div",pe,[_("div",ge,[y(l,null,{default:S(()=>[y(C(j))]),_:1})]),_("div",ve,[_("div",fe,"¥"+A(Yt(Vt.value.signPerformance)),1),t[26]||(t[26]=_("div",{class:"metric-label"},"签收业绩",-1))])])])]),_("div",he,[(w(),b(k,null,D($t,e=>y(a,{key:e.value,type:ct.value===e.value?"primary":"",onClick:t=>Mt(e.value),class:"filter-btn"},{default:S(()=>[R(A(e.label),1)]),_:2},1032,["type","onClick"])),64))]),_("div",be,[_("div",we,[y(r,{modelValue:mt.value,"onUpdate:modelValue":t[0]||(t[0]=e=>mt.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"date-picker"},null,8,["modelValue"]),y(o,{modelValue:pt.value,"onUpdate:modelValue":t[1]||(t[1]=e=>pt.value=e),placeholder:"选择部门",class:"department-select",size:"default"},{default:S(()=>["super_admin"===C(nt).currentUser?.role||"admin"===C(nt).currentUser?.role?(w(),I(n,{key:0,label:"全部部门",value:""})):x("",!0),(w(!0),b(k,null,D(vt.value,e=>(w(),I(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),y(o,{modelValue:gt.value,"onUpdate:modelValue":t[2]||(t[2]=e=>gt.value=e),placeholder:"排序方式",class:"sort-select",size:"default"},{default:S(()=>[y(n,{label:"按下单业绩排序",value:"orderAmount"}),y(n,{label:"按签收业绩排序",value:"signAmount"}),y(n,{label:"按签收率排序",value:"signRate"}),y(n,{label:"按下单数排序",value:"orderCount"})]),_:1},8,["modelValue"])]),_("div",_e,[y(a,{type:"primary",onClick:Ft,class:"query-btn"},{default:S(()=>[y(l,null,{default:S(()=>[y(C(P))]),_:1}),t[27]||(t[27]=R(" 查询 ",-1))]),_:1}),Jt.value?(w(),I(a,{key:0,onClick:Zt,class:"export-btn"},{default:S(()=>[y(l,null,{default:S(()=>[y(C(Y))]),_:1}),t[28]||(t[28]=R(" 批量导出 ",-1))]),_:1})):x("",!0),Lt.value?(w(),I(a,{key:1,onClick:Bt,class:"export-settings-btn",title:"导出权限设置"},{default:S(()=>[y(l,null,{default:S(()=>[y(C(M))]),_:1})]),_:1})):x("",!0),y(a,{onClick:Kt,class:"fullscreen-btn"},{default:S(()=>[y(l,null,{default:S(()=>[y(C(F))]),_:1}),t[29]||(t[29]=R(" 全屏查看 ",-1))]),_:1}),y(N,{columns:wt.value,"storage-key":at,onColumnsChange:Et,ref_key:"columnSettingsRef",ref:bt},null,8,["columns"])])]),_("div",ye,[y(u,{data:zt.value,stripe:"",class:"data-table","row-class-name":Xt,border:"","show-summary":"","summary-method":el},{default:S(()=>[y(s,{type:"index",label:"序号",width:"60",align:"center",fixed:"left"}),y(s,{prop:"name",label:"成员",width:"100",align:"center",fixed:"left"}),(w(!0),b(k,null,D(_t.value,e=>(w(),I(s,{key:e.prop,prop:e.prop,label:e.label,width:e.width,align:e.align},{default:S(({row:t})=>[e.prop.includes("Amount")?(w(),b("span",Se," ¥"+A(Yt(t[e.prop])),1)):e.prop.includes("Rate")?(w(),I(i,{key:1,type:ll(t[e.prop]),size:"small"},{default:S(()=>[R(A(t[e.prop])+"% ",1)]),_:2},1032,["type"])):e.prop.includes("Count")?(w(),b("span",Ce,A("number"==typeof t[e.prop]?t[e.prop]%1==0?t[e.prop]:t[e.prop].toFixed(1):t[e.prop]),1)):(w(),b("span",Ae,A(t[e.prop]),1))]),_:2},1032,["prop","label","width","align"]))),128)),y(s,{label:"操作",width:"120",align:"center",fixed:"right"},{default:S(({row:e})=>[y(a,{type:"primary",size:"small",onClick:t=>al(e)},{default:S(()=>[...t[30]||(t[30]=[R(" 查看详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),_("div",ke,[y(d,{"current-page":Ct.value,"onUpdate:currentPage":t[3]||(t[3]=e=>Ct.value=e),"page-size":At.value,"onUpdate:pageSize":t[4]||(t[4]=e=>At.value=e),"page-sizes":[30,50,100],total:kt.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:nl,onCurrentChange:ol},null,8,["current-page","page-size","total"])])]),y(c,{modelValue:Dt.value,"onUpdate:modelValue":t[7]||(t[7]=e=>Dt.value=e),title:`${Rt.value?.name} - 订单业绩详情`,width:"90%",top:"5vh",class:"member-dialog"},{default:S(()=>[Rt.value?(w(),b("div",De,[_("div",Re,[_("div",Ie,[t[31]||(t[31]=_("span",{class:"label"},"姓名：",-1)),_("span",xe,A(Rt.value.name),1)]),_("div",Te,[t[32]||(t[32]=_("span",{class:"label"},"部门：",-1)),_("span",Ne,A(Rt.value.department),1)]),_("div",Ue,[t[33]||(t[33]=_("span",{class:"label"},"创建时间：",-1)),_("span",Ve,A(Rt.value.createTime),1)]),_("div",$e,[t[34]||(t[34]=_("span",{class:"label"},"签收率：",-1)),_("span",ze,A(Rt.value.signRate)+"%",1)])]),_("div",Oe,[t[36]||(t[36]=_("h4",null,"订单列表",-1)),y(u,{data:Pt.value,stripe:"",border:"",class:"order-table"},{default:S(()=>[y(s,{type:"index",label:"序号",width:"60",align:"center"}),y(s,{prop:"orderNo",label:"订单号",width:"140","show-overflow-tooltip":""}),y(s,{prop:"orderDate",label:"下单日期",width:"110","show-overflow-tooltip":""}),y(s,{prop:"customerName",label:"客户姓名",width:"110","show-overflow-tooltip":""}),y(s,{prop:"amount",label:"金额",width:"110",align:"right","show-overflow-tooltip":""},{default:S(({row:e})=>[_("span",je,"¥"+A(Yt(e.amount)),1)]),_:1}),y(s,{prop:"depositAmount",label:"定金",width:"100",align:"right","show-overflow-tooltip":""},{default:S(({row:e})=>[_("span",Pe,"¥"+A(Yt(e.depositAmount)),1)]),_:1}),y(s,{prop:"collectionAmount",label:"代收",width:"100",align:"right","show-overflow-tooltip":""},{default:S(({row:e})=>[_("span",Ye,"¥"+A(Yt(e.collectionAmount)),1)]),_:1}),y(s,{prop:"logisticsCompany",label:"物流公司",width:"120","show-overflow-tooltip":""}),y(s,{prop:"trackingNumber",label:"快递单号",width:"160","show-overflow-tooltip":""}),y(s,{prop:"productDetails",label:"产品详情","min-width":"200","show-overflow-tooltip":""},{default:S(({row:e})=>[_("div",Me,A(e.productDetails),1)]),_:1}),y(s,{label:"操作",width:"100",align:"center",fixed:"right"},{default:S(({row:e})=>[y(a,{type:"primary",size:"small",onClick:t=>{return l=e,void rt.push(`/order/detail/${l.id}`);var l}},{default:S(()=>[...t[35]||(t[35]=[R(" 查看 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),_("div",Fe,[y(d,{"current-page":It.value,"onUpdate:currentPage":t[5]||(t[5]=e=>It.value=e),"page-size":xt.value,"onUpdate:pageSize":t[6]||(t[6]=e=>xt.value=e),"page-sizes":[30,50,100],total:Tt.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:sl,onCurrentChange:sl},null,8,["current-page","page-size","total"])])])])):x("",!0)]),_:1},8,["modelValue","title"]),y(c,{modelValue:Ut.value,"onUpdate:modelValue":t[13]||(t[13]=e=>Ut.value=e),title:"团队业绩 - 全屏查看",width:"95%",top:"2vh",class:"fullscreen-dialog","close-on-click-modal":!1},{default:S(()=>[_("div",Ee,[_("div",Le,[_("div",Je,[y(r,{modelValue:mt.value,"onUpdate:modelValue":t[8]||(t[8]=e=>mt.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"date-picker",size:"small"},null,8,["modelValue"]),y(o,{modelValue:pt.value,"onUpdate:modelValue":t[9]||(t[9]=e=>pt.value=e),placeholder:"选择部门",class:"department-select",size:"small"},{default:S(()=>["super_admin"===C(nt).currentUser?.role||"admin"===C(nt).currentUser?.role?(w(),I(n,{key:0,label:"全部部门",value:""})):x("",!0),(w(!0),b(k,null,D(vt.value,e=>(w(),I(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),y(o,{modelValue:gt.value,"onUpdate:modelValue":t[10]||(t[10]=e=>gt.value=e),placeholder:"排序方式",class:"sort-select",size:"small"},{default:S(()=>[y(n,{label:"按下单业绩排序",value:"orderAmount"}),y(n,{label:"按签收业绩排序",value:"signAmount"}),y(n,{label:"按签收率排序",value:"signRate"}),y(n,{label:"按下单数排序",value:"orderCount"})]),_:1},8,["modelValue"])]),_("div",Be,[y(a,{type:"primary",onClick:Ft,size:"small"},{default:S(()=>[y(l,null,{default:S(()=>[y(C(P))]),_:1}),t[37]||(t[37]=R(" 查询 ",-1))]),_:1}),Jt.value?(w(),I(a,{key:0,onClick:Zt,size:"small"},{default:S(()=>[y(l,null,{default:S(()=>[y(C(Y))]),_:1}),t[38]||(t[38]=R(" 批量导出 ",-1))]),_:1})):x("",!0)])]),_("div",He,[y(u,{data:zt.value,stripe:"",class:"data-table fullscreen-data-table","row-class-name":Xt,border:"",height:"calc(100vh - 300px)",style:{width:"100%"},"show-summary":"","summary-method":tl},{default:S(()=>[y(s,{type:"index",label:"序号",width:"60",align:"center",fixed:"left"}),y(s,{prop:"name",label:"成员",width:"100",align:"center",fixed:"left"}),y(s,{prop:"department",label:"部门",width:"100",align:"center"}),y(s,{prop:"username",label:"用户名",width:"110",align:"center"}),y(s,{prop:"employeeNumber",label:"工号",width:"110",align:"center"}),y(s,{prop:"createTime",label:"创建时间",width:"160",align:"center"}),y(s,{prop:"orderCount",label:"下单数",width:"70",align:"center"}),y(s,{prop:"orderAmount",label:"下单业绩",width:"100",align:"center"},{default:S(({row:e})=>[_("span",We,"¥"+A(Yt(e.orderAmount)),1)]),_:1}),y(s,{prop:"shipCount",label:"发货数",width:"70",align:"center"}),y(s,{prop:"shipAmount",label:"发货业绩",width:"100",align:"center"},{default:S(({row:e})=>[_("span",qe,"¥"+A(Yt(e.shipAmount)),1)]),_:1}),y(s,{prop:"shipRate",label:"发货率",width:"70",align:"center"},{default:S(({row:e})=>[y(i,{type:ll(e.shipRate),size:"small"},{default:S(()=>[R(A(e.shipRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),y(s,{prop:"signCount",label:"签收数",width:"70",align:"center"}),y(s,{prop:"signAmount",label:"签收业绩",width:"100",align:"center"},{default:S(({row:e})=>[_("span",Ge,"¥"+A(Yt(e.signAmount)),1)]),_:1}),y(s,{prop:"signRate",label:"签收率",width:"70",align:"center"},{default:S(({row:e})=>[y(i,{type:ll(e.signRate),size:"small"},{default:S(()=>[R(A(e.signRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),y(s,{prop:"transitCount",label:"在途数",width:"70",align:"center"}),y(s,{prop:"transitAmount",label:"在途业绩",width:"100",align:"center"},{default:S(({row:e})=>[_("span",Qe,"¥"+A(Yt(e.transitAmount)),1)]),_:1}),y(s,{prop:"transitRate",label:"在途率",width:"70",align:"center"},{default:S(({row:e})=>[y(i,{type:"info",size:"small"},{default:S(()=>[R(A(e.transitRate)+"% ",1)]),_:2},1024)]),_:1}),y(s,{prop:"rejectCount",label:"拒收数",width:"70",align:"center"}),y(s,{prop:"rejectAmount",label:"拒收业绩",width:"100",align:"center"},{default:S(({row:e})=>[_("span",Ze,"¥"+A(Yt(e.rejectAmount)),1)]),_:1}),y(s,{prop:"rejectRate",label:"拒收率",width:"70",align:"center"},{default:S(({row:e})=>[y(i,{type:ll(100-e.rejectRate),size:"small"},{default:S(()=>[R(A(e.rejectRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),y(s,{prop:"returnCount",label:"退货数",width:"70",align:"center"}),y(s,{prop:"returnAmount",label:"退货业绩",width:"100",align:"center"},{default:S(({row:e})=>[_("span",Ke,"¥"+A(Yt(e.returnAmount)),1)]),_:1}),y(s,{prop:"returnRate",label:"退货率",width:"70",align:"center"},{default:S(({row:e})=>[y(i,{type:ll(100-e.returnRate),size:"small"},{default:S(()=>[R(A(e.returnRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),y(s,{label:"操作",width:"120",align:"center",fixed:"right"},{default:S(({row:e})=>[_("div",Xe,[y(a,{type:"primary",size:"small",onClick:t=>al(e)},{default:S(()=>[...t[39]||(t[39]=[R(" 查看详情 ",-1)])]),_:1},8,["onClick"]),y(a,{type:"warning",size:"small",onClick:t=>{return l=e,void console.log("分析成员业绩",l);var l}},{default:S(()=>[...t[40]||(t[40]=[R(" 分析业绩 ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])]),_("div",et,[y(d,{"current-page":Ct.value,"onUpdate:currentPage":t[11]||(t[11]=e=>Ct.value=e),"page-size":At.value,"onUpdate:pageSize":t[12]||(t[12]=e=>At.value=e),"page-sizes":[30,50,100,200],total:kt.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:nl,onCurrentChange:ol},null,8,["current-page","page-size","total"])])])]),_:1},8,["modelValue"]),y(c,{modelValue:ft.value,"onUpdate:modelValue":t[20]||(t[20]=e=>ft.value=e),title:"导出权限设置",width:"700px","close-on-click-modal":!1},{footer:S(()=>[_("div",lt,[y(a,{onClick:t[19]||(t[19]=e=>ft.value=!1)},{default:S(()=>[...t[56]||(t[56]=[R("取消",-1)])]),_:1}),y(a,{type:"primary",onClick:Gt},{default:S(()=>[...t[57]||(t[57]=[R("保存设置",-1)])]),_:1}),y(a,{onClick:Qt},{default:S(()=>[...t[58]||(t[58]=[R("恢复默认",-1)])]),_:1})])]),default:S(()=>[y(ot,{ref:"exportFormRef",model:ht,"label-width":"140px"},{default:S(()=>[y(p,{label:"启用导出功能"},{default:S(()=>[y(m,{modelValue:ht.enabled,"onUpdate:modelValue":t[14]||(t[14]=e=>ht.enabled=e),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"]),t[41]||(t[41]=_("div",{class:"form-item-tip"}," 关闭后，所有成员将无法使用业绩导出功能 ",-1))]),_:1}),ht.enabled?(w(),I(p,{key:0,label:"权限控制方式"},{default:S(()=>[y(v,{modelValue:ht.permissionType,"onUpdate:modelValue":t[15]||(t[15]=e=>ht.permissionType=e)},{default:S(()=>[y(g,{label:"all"},{default:S(()=>[...t[42]||(t[42]=[R("所有人可用",-1)])]),_:1}),y(g,{label:"role"},{default:S(()=>[...t[43]||(t[43]=[R("按角色控制",-1)])]),_:1}),y(g,{label:"whitelist"},{default:S(()=>[...t[44]||(t[44]=[R("白名单控制",-1)])]),_:1})]),_:1},8,["modelValue"]),t[45]||(t[45]=_("div",{class:"form-item-tip"}," 选择导出功能的权限控制方式 ",-1))]),_:1})):x("",!0),ht.enabled&&"role"===ht.permissionType?(w(),I(p,{key:1,label:"允许的角色"},{default:S(()=>[y(T,{modelValue:ht.allowedRoles,"onUpdate:modelValue":t[16]||(t[16]=e=>ht.allowedRoles=e)},{default:S(()=>[y(f,{label:"super_admin"},{default:S(()=>[...t[46]||(t[46]=[R("超级管理员",-1)])]),_:1}),y(f,{label:"admin"},{default:S(()=>[...t[47]||(t[47]=[R("管理员",-1)])]),_:1}),y(f,{label:"department_manager"},{default:S(()=>[...t[48]||(t[48]=[R("部门经理",-1)])]),_:1}),y(f,{label:"sales"},{default:S(()=>[...t[49]||(t[49]=[R("销售人员",-1)])]),_:1}),y(f,{label:"customer_service"},{default:S(()=>[...t[50]||(t[50]=[R("客服人员",-1)])]),_:1})]),_:1},8,["modelValue"]),t[51]||(t[51]=_("div",{class:"form-item-tip"}," 选择允许使用导出功能的角色 ",-1))]),_:1})):x("",!0),ht.enabled&&"whitelist"===ht.permissionType?(w(),I(p,{key:2,label:"白名单成员"},{default:S(()=>[y(o,{modelValue:ht.whitelist,"onUpdate:modelValue":t[17]||(t[17]=e=>ht.whitelist=e),multiple:"",filterable:"",placeholder:"选择允许导出的成员",style:{width:"100%"}},{default:S(()=>[(w(!0),b(k,null,D(St.value,e=>(w(),I(n,{key:e.id,label:`${e.name} (${e.id})`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t[52]||(t[52]=_("div",{class:"form-item-tip"}," 只有白名单中的成员可以使用导出功能，其他人看不到导出按钮 ",-1))]),_:1})):x("",!0),ht.enabled?(w(),I(p,{key:3,label:"导出限制"},{default:S(()=>[y(E,{modelValue:ht.dailyLimit,"onUpdate:modelValue":t[18]||(t[18]=e=>ht.dailyLimit=e),min:0,max:100,placeholder:"每日导出次数限制"},null,8,["modelValue"]),t[53]||(t[53]=_("span",{style:{"margin-left":"10px"}},"次/天（0表示不限制）",-1)),t[54]||(t[54]=_("div",{class:"form-item-tip"}," 限制每个成员每天的导出次数，防止滥用 ",-1))]),_:1})):x("",!0)]),_:1},8,["model"]),y(st),_("div",tt,[t[55]||(t[55]=_("h3",null,"导出统计",-1)),y(ut,{column:3,border:""},{default:S(()=>[y(it,{label:"今日导出次数"},{default:S(()=>[R(A(yt.todayCount),1)]),_:1}),y(it,{label:"本周导出次数"},{default:S(()=>[R(A(yt.weekCount),1)]),_:1}),y(it,{label:"本月导出次数"},{default:S(()=>[R(A(yt.monthCount),1)]),_:1})]),_:1})])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-5a93fc94"]]);export{rt as default};
