var re=Object.defineProperty,de=Object.defineProperties;var me=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var j=(i,r,u)=>r in i?re(i,r,{enumerable:!0,configurable:!0,writable:!0,value:u}):i[r]=u,A=(i,r)=>{for(var u in r||(r={}))ce.call(r,u)&&j(i,u,r[u]);if(W)for(var u of W(r))pe.call(r,u)&&j(i,u,r[u]);return i},Q=(i,r)=>de(i,me(r));var G=(i,r,u)=>new Promise((f,k)=>{var C=g=>{try{_(u.next(g))}catch(w){k(w)}},S=g=>{try{_(u.throw(g))}catch(w){k(w)}},_=g=>g.done?f(g.value):Promise.resolve(g.value).then(C,S);_((u=u.apply(i,r)).next())});import{l as ve,r as y,e as B,w as H,ag as v,m as x,p as d,F as N,U as n,O as s,Q as U,M as V,a9 as I,q as o,T as m,S as c,u as ge,a7 as fe,n as _e}from"./vendor-D8Vxqhr-.js";import{a2 as be,E as J}from"./elementPlus-Bmwh7Rh8.js";import{_ as we}from"./settings-CuxbDWOu.js";const ye={class:"category-option"},Ve={class:"category-name"},xe={class:"category-desc"},he={class:"content-wrapper"},ke={class:"content-info"},Ce={class:"content-stats"},De={class:"char-count"},Te={class:"sms-count"},Ne={class:"variables-section"},Ue={class:"variables-list"},Se={class:"variables-tip"},Ee={class:"template-settings"},qe={class:"tags-wrapper"},Be={key:0,class:"preview-section"},Ie={class:"preview-content"},Pe={class:"preview-header"},Re={class:"preview-text"},ze={class:"dialog-footer"},Fe={class:"footer-info"},$e={class:"submit-tip"},Me={class:"footer-actions"},Oe={class:"full-preview"},Le={class:"preview-info"},Ke={class:"preview-content-full"},We={class:"content-display"},je={key:0,class:"preview-variables"},Ae={class:"variables-display"},Qe=ve({__name:"CreateTemplateDialog",props:{modelValue:{type:Boolean},mode:{default:"apply"},initialData:{}},emits:["update:modelValue","submit"],setup(i,{expose:r,emit:u}){const f=i,k=u,C=y(),S=y(),_=y(!1),g=y(!1),w=y(!1),E=y(!1),D=y(""),t=y({name:"",category:"",content:"",scenario:"",description:"",isDefault:!1,isPublic:!1,tags:[]}),F=[{value:"order",label:"订单通知",description:"订单确认、发货、收货等通知"},{value:"logistics",label:"物流通知",description:"发货、配送、签收等物流信息"},{value:"marketing",label:"营销推广",description:"促销活动、新品推荐等营销内容"},{value:"service",label:"客服通知",description:"售后服务、客户关怀等通知"},{value:"system",label:"系统通知",description:"系统维护、账户变更等系统消息"},{value:"reminder",label:"提醒通知",description:"付款提醒、到期提醒等"}],X=B(()=>({name:[{required:!0,message:"请输入模板名称",trigger:"blur"},{min:2,max:50,message:"模板名称长度在 2 到 50 个字符",trigger:"blur"}],category:[{required:!0,message:"请选择模板分类",trigger:"change"}],content:[{required:!0,message:"请输入模板内容",trigger:"blur"},{min:10,max:500,message:"模板内容长度在 10 到 500 个字符",trigger:"blur"},{validator:(a,e,p)=>{if(["赌博","彩票","贷款","投资理财"].some(R=>e.includes(R))){p(new Error("模板内容包含敏感词汇，请修改"));return}p()},trigger:"blur"}],scenario:[{required:!0,message:"请描述使用场景",trigger:"blur"},{min:5,max:200,message:"使用场景描述长度在 5 到 200 个字符",trigger:"blur"}],description:f.mode==="apply"?[{required:!0,message:"请输入申请说明",trigger:"blur"},{min:10,max:300,message:"申请说明长度在 10 到 300 个字符",trigger:"blur"}]:[]})),Y=B(()=>f.mode==="apply"?"申请短信模板":"创建短信模板"),h=B(()=>{if(!t.value.content)return[];const a=t.value.content.match(/\{(\w+)\}/g);return a?[...new Set(a.map(e=>e.slice(1,-1)))]:[]}),Z=B(()=>{let a=t.value.content;return h.value.forEach(e=>{const p=ee(e);a=a.replace(new RegExp(`\\{${e}\\}`,"g"),p)}),a});H(()=>f.modelValue,a=>{_.value=a,a&&f.initialData&&Object.assign(t.value,f.initialData)}),H(_,a=>{k("update:modelValue",a),a||M()});const ee=a=>({customerName:"张先生",orderNo:"ORD20240115001",amount:"299.00",deliveryTime:"2024-01-16 14:00",trackingNo:"SF1234567890",productName:"商品名称",companyName:"公司名称",phone:"138****8888",code:"123456",date:"2024-01-15",time:"14:30"})[a]||`[${a}]`,le=a=>{const e=F.find(p=>p.value===a);return(e==null?void 0:e.label)||a},te=()=>{},ae=()=>{E.value=!0,_e(()=>{var a;(a=S.value)==null||a.focus()})},$=()=>{const a=D.value.trim();if(a&&!t.value.tags.includes(a)){if(t.value.tags.length>=5){J.warning("最多只能添加5个标签");return}t.value.tags.push(a)}D.value="",E.value=!1},se=a=>{const e=t.value.tags.indexOf(a);e>-1&&t.value.tags.splice(e,1)},oe=()=>G(this,null,function*(){var a;try{yield(a=C.value)==null?void 0:a.validate(),g.value=!0;const e=Q(A({},t.value),{variables:h.value,mode:f.mode,createdAt:new Date().toLocaleString()});yield new Promise(p=>setTimeout(p,1500)),k("submit",e),J.success(f.mode==="apply"?"模板申请已提交，等待管理员审核":"模板创建成功"),P()}catch(e){console.error("提交失败:",e)}finally{g.value=!1}}),P=()=>{_.value=!1},M=()=>{var a;t.value={name:"",category:"",content:"",scenario:"",description:"",isDefault:!1,isPublic:!1,tags:[]},E.value=!1,D.value="",(a=C.value)==null||a.resetFields()};return r({resetForm:M}),(a,e)=>{const p=v("el-input"),b=v("el-form-item"),O=v("el-option"),R=v("el-select"),z=v("el-tag"),ne=v("el-icon"),L=v("el-checkbox"),T=v("el-button"),ie=v("el-form"),K=v("el-dialog"),q=v("el-descriptions-item"),ue=v("el-descriptions");return d(),x(N,null,[n(K,{modelValue:_.value,"onUpdate:modelValue":e[9]||(e[9]=l=>_.value=l),title:Y.value,width:"700px","before-close":P,class:"create-template-dialog"},{footer:s(()=>[o("div",ze,[o("div",Fe,[o("span",$e,m(i.mode==="apply"?"提交后将进入审核流程":"创建后立即生效"),1)]),o("div",Me,[n(T,{onClick:P},{default:s(()=>[...e[21]||(e[21]=[c("取消",-1)])]),_:1}),n(T,{type:"primary",onClick:oe,loading:g.value},{default:s(()=>[c(m(i.mode==="apply"?"提交申请":"创建模板"),1)]),_:1},8,["loading"])])])]),default:s(()=>[n(ie,{model:t.value,rules:X.value,ref_key:"formRef",ref:C,"label-width":"100px",class:"template-form"},{default:s(()=>[n(b,{label:"模板名称",prop:"name"},{default:s(()=>[n(p,{modelValue:t.value.name,"onUpdate:modelValue":e[0]||(e[0]=l=>t.value.name=l),placeholder:"请输入模板名称，建议简洁明了",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),n(b,{label:"模板分类",prop:"category"},{default:s(()=>[n(R,{modelValue:t.value.category,"onUpdate:modelValue":e[1]||(e[1]=l=>t.value.category=l),placeholder:"请选择模板分类",style:{width:"100%"}},{default:s(()=>[(d(),x(N,null,I(F,l=>n(O,{key:l.value,label:l.label,value:l.value},{default:s(()=>[o("div",ye,[o("span",Ve,m(l.label),1),o("span",xe,m(l.description),1)])]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(b,{label:"模板内容",prop:"content"},{default:s(()=>[o("div",he,[n(p,{modelValue:t.value.content,"onUpdate:modelValue":e[2]||(e[2]=l=>t.value.content=l),type:"textarea",rows:8,placeholder:`请输入短信模板内容

支持变量格式：{变量名}
例如：您好{customerName}，您的订单{orderNo}已确认。

注意：短信内容需符合相关法规要求`,maxlength:"500","show-word-limit":"",onInput:te},null,8,["modelValue"]),o("div",ke,[o("div",Ce,[o("span",De,"字符数: "+m(t.value.content.length)+"/500",1),o("span",Te,"预计短信条数: "+m(Math.ceil(t.value.content.length/70)),1)])])])]),_:1}),h.value.length>0?(d(),V(b,{key:0,label:"检测到的变量"},{default:s(()=>[o("div",Ne,[o("div",Ue,[(d(!0),x(N,null,I(h.value,l=>(d(),V(z,{key:l,class:"variable-tag",type:"info"},{default:s(()=>[c(m(l),1)]),_:2},1024))),128))]),o("div",Se,[n(ne,null,{default:s(()=>[n(ge(be))]),_:1}),e[12]||(e[12]=c(" 系统自动检测到以上变量，请确保在使用时提供对应的值 ",-1))])])]),_:1})):U("",!0),n(b,{label:"使用场景",prop:"scenario"},{default:s(()=>[n(p,{modelValue:t.value.scenario,"onUpdate:modelValue":e[3]||(e[3]=l=>t.value.scenario=l),type:"textarea",rows:2,placeholder:"请描述此模板的使用场景，如：订单确认后通知客户",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),i.mode==="apply"?(d(),V(b,{key:1,label:"申请说明",prop:"description"},{default:s(()=>[n(p,{modelValue:t.value.description,"onUpdate:modelValue":e[4]||(e[4]=l=>t.value.description=l),type:"textarea",rows:3,placeholder:"请说明申请此模板的用途和必要性，以便管理员审核",maxlength:"300","show-word-limit":""},null,8,["modelValue"])]),_:1})):U("",!0),i.mode==="create"?(d(),V(b,{key:2,label:"模板设置"},{default:s(()=>[o("div",Ee,[n(L,{modelValue:t.value.isDefault,"onUpdate:modelValue":e[5]||(e[5]=l=>t.value.isDefault=l)},{default:s(()=>[...e[13]||(e[13]=[c("设为默认模板",-1)])]),_:1},8,["modelValue"]),n(L,{modelValue:t.value.isPublic,"onUpdate:modelValue":e[6]||(e[6]=l=>t.value.isPublic=l)},{default:s(()=>[...e[14]||(e[14]=[c("公开模板（其他用户可见）",-1)])]),_:1},8,["modelValue"])]),e[15]||(e[15]=o("div",{class:"settings-tip"}," 默认模板将在发送短信时优先显示；公开模板可被其他用户使用 ",-1))]),_:1})):U("",!0),n(b,{label:"标签",prop:"tags"},{default:s(()=>[o("div",qe,[(d(!0),x(N,null,I(t.value.tags,l=>(d(),V(z,{key:l,closable:"",onClose:Ge=>se(l),class:"tag-item"},{default:s(()=>[c(m(l),1)]),_:2},1032,["onClose"]))),128)),E.value?(d(),V(p,{key:0,ref_key:"tagInputRef",ref:S,modelValue:D.value,"onUpdate:modelValue":e[7]||(e[7]=l=>D.value=l),size:"small",style:{width:"100px"},onKeyup:fe($,["enter"]),onBlur:$},null,8,["modelValue"])):(d(),V(T,{key:1,size:"small",onClick:ae,class:"add-tag-btn"},{default:s(()=>[...e[16]||(e[16]=[c(" + 添加标签 ",-1)])]),_:1}))]),e[17]||(e[17]=o("div",{class:"tags-tip"}," 添加标签便于分类和搜索模板 ",-1))]),_:1})]),_:1},8,["model","rules"]),t.value.content?(d(),x("div",Be,[e[20]||(e[20]=o("h4",{class:"preview-title"},"模板预览",-1)),o("div",Ie,[o("div",Pe,[e[19]||(e[19]=o("span",{class:"preview-label"},"短信内容预览：",-1)),n(T,{size:"small",type:"primary",link:"",onClick:e[8]||(e[8]=l=>w.value=!0)},{default:s(()=>[...e[18]||(e[18]=[c(" 完整预览 ",-1)])]),_:1})]),o("div",Re,m(Z.value),1)])])):U("",!0)]),_:1},8,["modelValue","title"]),n(K,{modelValue:w.value,"onUpdate:modelValue":e[11]||(e[11]=l=>w.value=l),title:"模板预览",width:"500px",class:"preview-dialog"},{footer:s(()=>[n(T,{onClick:e[10]||(e[10]=l=>w.value=!1)},{default:s(()=>[...e[24]||(e[24]=[c("关闭",-1)])]),_:1})]),default:s(()=>[o("div",Oe,[o("div",Le,[n(ue,{column:1,size:"small"},{default:s(()=>[n(q,{label:"模板名称"},{default:s(()=>[c(m(t.value.name),1)]),_:1}),n(q,{label:"分类"},{default:s(()=>[c(m(le(t.value.category)),1)]),_:1}),n(q,{label:"字符数"},{default:s(()=>[c(m(t.value.content.length),1)]),_:1}),n(q,{label:"预计条数"},{default:s(()=>[c(m(Math.ceil(t.value.content.length/70)),1)]),_:1})]),_:1})]),o("div",Ke,[e[22]||(e[22]=o("h5",null,"短信内容：",-1)),o("div",We,m(t.value.content),1)]),h.value.length>0?(d(),x("div",je,[e[23]||(e[23]=o("h5",null,"包含变量：",-1)),o("div",Ae,[(d(!0),x(N,null,I(h.value,l=>(d(),V(z,{key:l,size:"small",class:"variable-tag"},{default:s(()=>[c(m(l),1)]),_:2},1024))),128))])])):U("",!0)])]),_:1},8,["modelValue"])],64)}}}),Ze=we(Qe,[["__scopeId","data-v-af076099"]]);export{Ze as C};
