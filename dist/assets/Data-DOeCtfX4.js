var B=(ee,j,z)=>new Promise((A,$)=>{var R=h=>{try{b(z.next(h))}catch(O){$(O)}},F=h=>{try{b(z.throw(h))}catch(O){$(O)}},b=h=>h.done?A(h.value):Promise.resolve(h.value).then(R,F);b((z=z.apply(ee,j)).next())});import{l as ke,az as Ce,r as S,e as Z,w as Oe,c as Ne,n as re,Y as Me,ag as C,aq as ze,m as Ae,p as f,q as s,U as r,O as o,S as g,u as m,T as y,J as L,M as _,P as Ve,Q as Fe}from"./vendor-D8Vxqhr-.js";import{n as Ue,r as Be,O as Le,a6 as Y,T as E,q as Ye,al as Ee,c as Pe,a1 as $e,s as Re,E as P}from"./elementPlus-Bmwh7Rh8.js";import{u as qe,j as Ie,c as je,_ as Je}from"./settings-CuxbDWOu.js";import{u as Ke}from"./service-CXxf5jtg.js";import{i as I}from"./utils-ywHRn0uI.js";const Qe={class:"service-data-container"},Xe={class:"page-header"},Ge={class:"header-actions"},He={class:"metrics-grid"},We={class:"metric-card"},Ze={class:"metric-icon"},et={class:"metric-content"},tt={class:"metric-value"},at={class:"metric-card"},st={class:"metric-icon refund"},rt={class:"metric-content"},nt={class:"metric-value"},ot={class:"metric-card"},lt={class:"metric-icon today"},it={class:"metric-content"},dt={class:"metric-value"},ct={class:"metric-card"},ut={class:"metric-icon pending"},pt={class:"metric-content"},vt={class:"metric-value"},mt={class:"metric-card"},ft={class:"metric-icon urgent"},gt={class:"metric-content"},_t={class:"metric-value"},yt={class:"charts-section"},ht={class:"chart-row"},Tt={class:"chart-card"},St={class:"chart-header"},bt={class:"chart-card"},wt={class:"chart-row"},xt={class:"chart-card"},Dt={class:"chart-card"},kt={class:"orders-section"},Ct={class:"section-header"},Ot={class:"section-actions"},Nt={class:"pagination-wrapper"},Mt=ke({__name:"Data",setup(ee){const j=Ce(),z=je(j),A=Ke(),$=qe();Ie();const R=S(["2024-01-01","2024-01-31"]),F=S(!1),b=S(""),h=S(""),O=S("30days"),N=S(1),U=S(20),te=S(0),J=S(),K=S(),Q=S(),X=S();let w=null,x=null,D=null,k=null;const c=Z(()=>{const t=V(),e=new Date().toISOString().slice(0,10),a=t.length,l=t.filter(T=>T.createTime.slice(0,10)===e).length,v=t.filter(T=>T.status==="pending").length,p=t.filter(T=>T.priority==="urgent").length,u=t.filter(T=>T.serviceType==="return"||T.serviceType==="refund").reduce((T,d)=>T+(d.price||0),0),i=a>0?Math.random()*20-10:0,n=l>0?Math.random()*30-15:0,M=v>0?Math.random()*25-12.5:0,H=p>0?Math.random()*40-20:0,W=u>0?Math.random()*15-7.5:0;return{totalOrders:a,ordersTrend:Number(i.toFixed(1)),refundAmount:u,refundTrend:Number(W.toFixed(1)),todayOrders:l,todayTrend:Number(n.toFixed(1)),pendingOrders:v,pendingTrend:Number(M.toFixed(1)),urgentOrders:p,urgentTrend:Number(H.toFixed(1))}}),V=()=>{const t=$.currentUser;if(!t)return[];const e=A.services;return t.role==="admin"?e:t.role==="manager"||t.role==="department_manager"?e.filter(a=>a.department?a.department===t.department||a.department===t.departmentId:a.createdBy===t.id||a.assignedTo===t.name||a.assignedTo===t.id||a.handlerId===t.id):t.role==="customer_service"?e.filter(a=>a.createdBy===t.id||a.assignedTo===t.name||a.assignedTo===t.id||a.handlerId===t.id||a.handlerName===t.name):t.role==="sales_staff"?e.filter(a=>a.createdBy===t.id||a.salesPersonId===t.id||a.salesPerson===t.name||a.assignedTo===t.name||a.assignedTo===t.id):e.filter(a=>a.createdBy===t.id||a.assignedTo===t.name||a.assignedTo===t.id)},ne=Z(()=>V().map(e=>({id:e.id,orderNo:e.serviceNumber,originalOrderNo:e.orderNumber,customerName:e.customerName,productName:e.productName||"未知商品",serviceType:e.serviceType,amount:e.price||0,status:e.status,priority:e.priority,createTime:e.createTime,updateTime:e.updateTime||e.createTime}))),oe=Z(()=>{let t=ne.value;return b.value&&(t=t.filter(e=>e.orderNo.toLowerCase().includes(b.value.toLowerCase())||e.customerName.includes(b.value)||e.originalOrderNo.toLowerCase().includes(b.value.toLowerCase()))),h.value&&(t=t.filter(e=>e.status===h.value)),te.value=t.length,t.slice((N.value-1)*U.value,N.value*U.value)}),le=t=>{console.log("日期范围变更:",t),G(),q()},ie=()=>{P.success("数据导出功能开发中...")},de=()=>B(this,null,function*(){F.value=!0;try{yield G(),q(),P.success("数据已刷新")}catch(t){P.error("数据刷新失败")}finally{F.value=!1}}),G=()=>B(this,null,function*(){try{yield A.loadAfterSalesServices()}catch(t){console.error("加载售后数据失败:",t)}}),ce=()=>{N.value=1},ue=()=>{N.value=1},pe=t=>{U.value=t,N.value=1},ve=t=>{N.value=t},me=t=>({return:"退货",exchange:"换货",repair:"维修",refund:"退款"})[t]||t,fe=t=>({return:"danger",exchange:"warning",repair:"info",refund:"success"})[t]||"info",ge=t=>({pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"})[t]||t,_e=t=>({pending:"warning",processing:"primary",resolved:"success",closed:"info"})[t]||"info",ye=t=>{z.push(`/service/detail/${t.id}`)},he=t=>B(this,null,function*(){try{yield A.updateServiceStatus(t.id,"processing","开始处理"),P.success(`开始处理订单 ${t.orderNo}`)}catch(e){P.error("处理失败")}}),Te=()=>{console.log("更新趋势图:",O.value),ae()},ae=()=>{if(!J.value)return;w&&w.dispose(),w=I(J.value);const t=V();let e=[],a=0;switch(O.value){case"7days":a=7,e=Array.from({length:a},(u,i)=>{const n=new Date;return n.setDate(n.getDate()-(a-1)+i),n.toISOString().slice(5,10)});break;case"30days":a=30,e=Array.from({length:a},(u,i)=>{const n=new Date;return n.setDate(n.getDate()-(a-1)+i),n.toISOString().slice(5,10)});break;case"3months":a=90,e=Array.from({length:a},(u,i)=>{const n=new Date;return n.setDate(n.getDate()-(a-1)+i),n.toISOString().slice(5,10)});break;case"6months":a=180,e=Array.from({length:a},(u,i)=>{const n=new Date;return n.setDate(n.getDate()-(a-1)+i),n.toISOString().slice(5,10)});break;default:a=7,e=Array.from({length:a},(u,i)=>{const n=new Date;return n.setDate(n.getDate()-(a-1)+i),n.toISOString().slice(5,10)})}const l=e.map(u=>t.filter(i=>i.createTime.slice(5,10)===u).length);let v=e;if(a>30){const u=Math.ceil(a/10);v=e.map((i,n)=>n%u===0?i:"")}const p={title:{text:"售后订单趋势",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:u=>{const i=u[0].dataIndex;return`${e[i]}: ${u[0].value}个订单`}},xAxis:{type:"category",data:v,axisLabel:{rotate:a>30?45:0}},yAxis:{type:"value"},series:[{data:l,type:"line",smooth:!0,itemStyle:{color:"#409EFF"}}]};w.setOption(p)},Se=()=>{if(!K.value)return;x&&x.dispose(),x=I(K.value);const t=V(),e=[{name:"退货",value:t.filter(l=>l.serviceType==="return").length},{name:"换货",value:t.filter(l=>l.serviceType==="exchange").length},{name:"维修",value:t.filter(l=>l.serviceType==="repair").length},{name:"退款",value:t.filter(l=>l.serviceType==="refund").length}],a={title:{text:"售后类型分布",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"item"},series:[{type:"pie",radius:"60%",data:e,emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};x.setOption(a)},be=()=>{if(!Q.value)return;D&&D.dispose(),D=I(Q.value);const e=V().filter(v=>v.status==="resolved"||v.status==="closed"),a=[0,0,0,0,0];e.forEach(v=>{const p=new Date(v.createTime),u=new Date(v.updateTime||v.createTime),i=Math.ceil((u-p)/(1e3*60*60*24));i<=1?a[0]++:i<=3?a[1]++:i<=7?a[2]++:i<=15?a[3]++:a[4]++});const l={title:{text:"处理时长分析",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}: {c}个订单"},xAxis:{type:"category",data:["0-1天","1-3天","3-7天","7-15天","15天以上"]},yAxis:{type:"value"},series:[{data:a,type:"bar",itemStyle:{color:"#67C23A"}}]};D.setOption(l)},we=()=>{if(!X.value)return;k&&k.dispose(),k=I(X.value);const e=V().filter(p=>p.serviceType==="return"||p.serviceType==="refund"),a=Array.from({length:7},(p,u)=>{const i=new Date;return i.setDate(i.getDate()-6+u),i.toISOString().slice(5,10)}),l=a.map(p=>e.filter(u=>u.createTime.slice(5,10)===p).reduce((u,i)=>u+(i.price||0),0)),v={title:{text:"退款金额趋势",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}: ¥{c}"},xAxis:{type:"category",data:a},yAxis:{type:"value"},series:[{data:l,type:"line",smooth:!0,itemStyle:{color:"#F56C6C"}}]};k.setOption(v)},q=()=>{re(()=>{ae(),Se(),be(),we()})},xe=()=>{q()};Oe(()=>A.services,()=>{q()},{deep:!0});const se=()=>{w==null||w.resize(),x==null||x.resize(),D==null||D.resize(),k==null||k.resize()};return Ne(()=>B(this,null,function*(){yield G(),re(()=>{xe(),window.addEventListener("resize",se)})})),Me(()=>{window.removeEventListener("resize",se),w==null||w.dispose(),x==null||x.dispose(),D==null||D.dispose(),k==null||k.dispose()}),(t,e)=>{const a=C("el-date-picker"),l=C("el-icon"),v=C("el-button"),p=C("el-option"),u=C("el-select"),i=C("el-input"),n=C("el-table-column"),M=C("el-tag"),H=C("el-table"),W=C("el-pagination"),T=ze("loading");return f(),Ae("div",Qe,[s("div",Xe,[e[8]||(e[8]=s("h1",{class:"page-title"},"售后数据看板",-1)),s("div",Ge,[r(a,{modelValue:R.value,"onUpdate:modelValue":e[0]||(e[0]=d=>R.value=d),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:le},null,8,["modelValue"]),r(v,{type:"primary",onClick:ie},{default:o(()=>[r(l,null,{default:o(()=>[r(m(Ue))]),_:1}),e[6]||(e[6]=g(" 导出数据 ",-1))]),_:1}),r(v,{onClick:de},{default:o(()=>[r(l,null,{default:o(()=>[r(m(Be))]),_:1}),e[7]||(e[7]=g(" 刷新 ",-1))]),_:1})])]),s("div",He,[s("div",We,[s("div",Ze,[r(l,null,{default:o(()=>[r(m(Le))]),_:1})]),s("div",et,[s("div",tt,y(c.value.totalOrders),1),e[9]||(e[9]=s("div",{class:"metric-label"},"售后订单数量",-1)),s("div",{class:L(["metric-trend",{positive:c.value.ordersTrend>0,negative:c.value.ordersTrend<0}])},[c.value.ordersTrend>0?(f(),_(l,{key:0},{default:o(()=>[r(m(Y))]),_:1})):(f(),_(l,{key:1},{default:o(()=>[r(m(E))]),_:1})),g(" "+y(Math.abs(c.value.ordersTrend))+"% ",1)],2)])]),s("div",at,[s("div",st,[r(l,null,{default:o(()=>[r(m(Ye))]),_:1})]),s("div",rt,[s("div",nt,"¥"+y(c.value.refundAmount.toLocaleString()),1),e[10]||(e[10]=s("div",{class:"metric-label"},"已退款金额",-1)),s("div",{class:L(["metric-trend",{positive:c.value.refundTrend>0,negative:c.value.refundTrend<0}])},[c.value.refundTrend>0?(f(),_(l,{key:0},{default:o(()=>[r(m(Y))]),_:1})):(f(),_(l,{key:1},{default:o(()=>[r(m(E))]),_:1})),g(" "+y(Math.abs(c.value.refundTrend))+"% ",1)],2)])]),s("div",ot,[s("div",lt,[r(l,null,{default:o(()=>[r(m(Ee))]),_:1})]),s("div",it,[s("div",dt,y(c.value.todayOrders),1),e[11]||(e[11]=s("div",{class:"metric-label"},"今日售后单",-1)),s("div",{class:L(["metric-trend",{positive:c.value.todayTrend>0,negative:c.value.todayTrend<0}])},[c.value.todayTrend>0?(f(),_(l,{key:0},{default:o(()=>[r(m(Y))]),_:1})):(f(),_(l,{key:1},{default:o(()=>[r(m(E))]),_:1})),g(" "+y(Math.abs(c.value.todayTrend))+"% ",1)],2)])]),s("div",ct,[s("div",ut,[r(l,null,{default:o(()=>[r(m(Pe))]),_:1})]),s("div",pt,[s("div",vt,y(c.value.pendingOrders),1),e[12]||(e[12]=s("div",{class:"metric-label"},"待处理",-1)),s("div",{class:L(["metric-trend",{positive:c.value.pendingTrend>0,negative:c.value.pendingTrend<0}])},[c.value.pendingTrend>0?(f(),_(l,{key:0},{default:o(()=>[r(m(Y))]),_:1})):(f(),_(l,{key:1},{default:o(()=>[r(m(E))]),_:1})),g(" "+y(Math.abs(c.value.pendingTrend))+"% ",1)],2)])]),s("div",mt,[s("div",ft,[r(l,null,{default:o(()=>[r(m($e))]),_:1})]),s("div",gt,[s("div",_t,y(c.value.urgentOrders),1),e[13]||(e[13]=s("div",{class:"metric-label"},"紧急订单",-1)),s("div",{class:L(["metric-trend",{positive:c.value.urgentTrend>0,negative:c.value.urgentTrend<0}])},[c.value.urgentTrend>0?(f(),_(l,{key:0},{default:o(()=>[r(m(Y))]),_:1})):(f(),_(l,{key:1},{default:o(()=>[r(m(E))]),_:1})),g(" "+y(Math.abs(c.value.urgentTrend))+"% ",1)],2)])])]),s("div",yt,[s("div",ht,[s("div",Tt,[s("div",St,[e[14]||(e[14]=s("h3",null,"售后订单趋势",-1)),r(u,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=d=>O.value=d),onChange:Te},{default:o(()=>[r(p,{label:"最近7天",value:"7days"}),r(p,{label:"最近30天",value:"30days"}),r(p,{label:"最近3个月",value:"3months"}),r(p,{label:"最近6个月",value:"6months"})]),_:1},8,["modelValue"])]),s("div",{class:"chart-content",ref_key:"trendChart",ref:J},null,512)]),s("div",bt,[e[15]||(e[15]=s("div",{class:"chart-header"},[s("h3",null,"售后类型分布")],-1)),s("div",{class:"chart-content",ref_key:"typeChart",ref:K},null,512)])]),s("div",wt,[s("div",xt,[e[16]||(e[16]=s("div",{class:"chart-header"},[s("h3",null,"处理时长分析")],-1)),s("div",{class:"chart-content",ref_key:"durationChart",ref:Q},null,512)]),s("div",Dt,[e[17]||(e[17]=s("div",{class:"chart-header"},[s("h3",null,"退款金额趋势")],-1)),s("div",{class:"chart-content",ref_key:"refundChart",ref:X},null,512)])])]),s("div",kt,[s("div",Ct,[e[18]||(e[18]=s("h3",null,"售后订单明细",-1)),s("div",Ot,[r(i,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=d=>b.value=d),placeholder:"搜索订单号、客户名称",style:{width:"200px","margin-right":"10px"},onInput:ce},{prefix:o(()=>[r(l,null,{default:o(()=>[r(m(Re))]),_:1})]),_:1},8,["modelValue"]),r(u,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=d=>h.value=d),placeholder:"状态筛选",onChange:ue},{default:o(()=>[r(p,{label:"全部",value:""}),r(p,{label:"待处理",value:"pending"}),r(p,{label:"处理中",value:"processing"}),r(p,{label:"已解决",value:"resolved"}),r(p,{label:"已关闭",value:"closed"})]),_:1},8,["modelValue"])])]),Ve((f(),_(H,{data:oe.value,stripe:""},{default:o(()=>[r(n,{prop:"orderNo",label:"售后单号",width:"140"}),r(n,{prop:"originalOrderNo",label:"原订单号",width:"140"}),r(n,{prop:"customerName",label:"客户姓名",width:"100"}),r(n,{prop:"productName",label:"商品名称","min-width":"150"}),r(n,{prop:"serviceType",label:"售后类型",width:"100"},{default:o(({row:d})=>[r(M,{type:fe(d.serviceType)},{default:o(()=>[g(y(me(d.serviceType)),1)]),_:2},1032,["type"])]),_:1}),r(n,{prop:"amount",label:"涉及金额",width:"100"},{default:o(({row:d})=>[g(" ¥"+y(d.amount.toLocaleString()),1)]),_:1}),r(n,{prop:"status",label:"状态",width:"100"},{default:o(({row:d})=>[r(M,{type:_e(d.status)},{default:o(()=>[g(y(ge(d.status)),1)]),_:2},1032,["type"])]),_:1}),r(n,{prop:"priority",label:"优先级",width:"80"},{default:o(({row:d})=>[d.priority==="urgent"?(f(),_(M,{key:0,type:"danger",size:"small"},{default:o(()=>[...e[19]||(e[19]=[g("紧急",-1)])]),_:1})):d.priority==="high"?(f(),_(M,{key:1,type:"warning",size:"small"},{default:o(()=>[...e[20]||(e[20]=[g("高",-1)])]),_:1})):(f(),_(M,{key:2,type:"info",size:"small"},{default:o(()=>[...e[21]||(e[21]=[g("普通",-1)])]),_:1}))]),_:1}),r(n,{prop:"createTime",label:"创建时间",width:"120"}),r(n,{prop:"updateTime",label:"更新时间",width:"120"}),r(n,{label:"操作",width:"150",fixed:"right"},{default:o(({row:d})=>[r(v,{type:"primary",size:"small",onClick:De=>ye(d)},{default:o(()=>[...e[22]||(e[22]=[g("查看",-1)])]),_:1},8,["onClick"]),d.status==="pending"?(f(),_(v,{key:0,type:"success",size:"small",onClick:De=>he(d)},{default:o(()=>[...e[23]||(e[23]=[g("处理",-1)])]),_:1},8,["onClick"])):Fe("",!0)]),_:1})]),_:1},8,["data"])),[[T,F.value]]),s("div",Nt,[r(W,{"current-page":N.value,"onUpdate:currentPage":e[4]||(e[4]=d=>N.value=d),"page-size":U.value,"onUpdate:pageSize":e[5]||(e[5]=d=>U.value=d),"page-sizes":[10,20,50,100],total:te.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:pe,onCurrentChange:ve},null,8,["current-page","page-size","total"])])])])}}}),Lt=Je(Mt,[["__scopeId","data-v-d05488f0"]]);export{Lt as default};
