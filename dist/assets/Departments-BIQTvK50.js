import{l as e,r as l,Z as a,e as s,w as t,ag as n,M as i,q as o,O as d,p as c,U as r,m as u,Q as m,T as p,S as v,n as f,u as y,F as g,a9 as h,J as k,R as b,a2 as w,I as _,aA as C,b as V,aq as D,P as x}from"./vendor-BtukhyiH.js";import{_ as I,c as z}from"./index-BGtT17ll.js";import{E as S,u as T,D as P,o as U,a5 as j,v as O,a8 as A,n as L,t as q,l as N,s as E,au as M,H as B,j as Q,r as $,a7 as F,af as R,ae as Z,B as H,C as J,aL as K,F as Y,aK as G,aM as W,Z as X,Q as ee,aq as le,Y as ae,A as se}from"./elementPlus-DxaqjplL.js";import{useDepartmentStore as te}from"./department-BMF6-9dP.js";import{D as ne}from"./DepartmentDialog-DC5RKZN6.js";import{D as ie}from"./DynamicTable-BXyvPHDr.js";import"./utils-DfI7e5Rl.js";import"./departmentPermissionService-CTPloDh0.js";import"./TableColumnSettings-CpY_V997.js";const oe={class:"move-content"},de={class:"current-info"},ce={class:"info-item"},re={class:"value"},ue={class:"info-item"},me={class:"value"},pe={class:"info-item"},ve={class:"value"},fe={key:0,class:"preview-info"},ye={class:"info-item"},ge={class:"value"},he={class:"info-item"},ke={class:"value"},be={class:"info-item"},we={class:"value"},_e={class:"dialog-footer"},Ce=I(e({__name:"MoveDepartmentDialog",props:{modelValue:{type:Boolean},department:{default:null}},emits:["update:modelValue","success"],setup(e,{emit:y}){const g=e,h=y,k=te(),b=l(),w=l(!1),_=a({newParentId:null,newSort:1}),C={newSort:[{required:!0,message:"请输入排序位置",trigger:"blur"}]},V={value:"id",label:"name",children:"children"},D=s(()=>{if(!g.department?.parentId)return null;const e=k.getDepartmentById(g.department.parentId);return e?.name}),x=s(()=>{if(!g.department)return[];const e=l=>l.filter(e=>e.id!==g.department.id&&!I(e.id,g.department.id)).map(l=>({...l,children:l.children?e(l.children):[]}));return e(k.departmentTree)}),I=(e,l)=>{const a=(e,l)=>{for(const s of e){if(s.id===l)return s;if(s.children){const e=a(s.children,l);if(e)return e}}return null},s=a(k.departmentTree,e);if(!s)return!1;let t=s;for(;t.parentId;){if(t.parentId===l)return!0;if(t=a(k.departmentTree,t.parentId)||t,!t.parentId)break}return!1},z=s(()=>{if(!g.department)return null;const e=_.newParentId?k.getDepartmentById(_.newParentId):null,l=e?e.level+1:1;return{newParentName:e?.name,newLevel:l}}),T=()=>{Object.assign(_,{newParentId:null,newSort:1}),f(()=>{b.value?.clearValidate()})},P=()=>{g.department?Object.assign(_,{newParentId:g.department.parentId,newSort:g.department.sort}):T()};t(()=>g.modelValue,e=>{e&&P()}),t(()=>g.department,()=>{g.modelValue&&P()});const U=()=>{h("update:modelValue",!1),T()},j=async()=>{if(b.value&&g.department)try{if(!(await b.value.validate()))return;if(_.newParentId===g.department.parentId&&_.newSort===g.department.sort)return void S.warning("部门位置没有变化");w.value=!0,await k.moveDepartment(g.department.id,_.newParentId,_.newSort),h("success")}catch(e){S.error(e instanceof Error?e.message:"移动失败")}finally{w.value=!1}};return(l,a)=>{const s=n("el-divider"),t=n("el-tree-select"),f=n("el-form-item"),y=n("el-input-number"),g=n("el-form"),h=n("el-button"),k=n("el-dialog");return o(),i(k,{"model-value":e.modelValue,title:"移动部门",width:"500px","before-close":U,class:"move-dialog"},{footer:d(()=>[c("div",_e,[r(h,{onClick:U,class:"cancel-btn"},{default:d(()=>[...a[10]||(a[10]=[v("取消",-1)])]),_:1}),r(h,{type:"primary",onClick:j,loading:w.value,class:"submit-btn"},{default:d(()=>[...a[11]||(a[11]=[v(" 确认移动 ",-1)])]),_:1},8,["loading"])])]),default:d(()=>[c("div",oe,[c("div",de,[a[5]||(a[5]=c("h4",null,"当前部门信息",-1)),c("div",ce,[a[2]||(a[2]=c("span",{class:"label"},"部门名称：",-1)),c("span",re,p(e.department?.name),1)]),c("div",ue,[a[3]||(a[3]=c("span",{class:"label"},"当前层级：",-1)),c("span",me,p(e.department?.level)+"级",1)]),c("div",pe,[a[4]||(a[4]=c("span",{class:"label"},"当前上级：",-1)),c("span",ve,p(D.value||"无（顶级部门）"),1)])]),r(s),r(g,{ref_key:"formRef",ref:b,model:_,rules:C,"label-width":"100px"},{default:d(()=>[r(f,{label:"目标上级",prop:"newParentId"},{default:d(()=>[r(t,{modelValue:_.newParentId,"onUpdate:modelValue":a[0]||(a[0]=e=>_.newParentId=e),data:x.value,props:V,placeholder:"请选择新的上级部门（留空为顶级部门）",clearable:"","check-strictly":"","render-after-expand":!1,style:{width:"100%"}},null,8,["modelValue","data"])]),_:1}),r(f,{label:"排序位置",prop:"newSort"},{default:d(()=>[r(y,{modelValue:_.newSort,"onUpdate:modelValue":a[1]||(a[1]=e=>_.newSort=e),min:1,max:999,placeholder:"在同级部门中的排序位置",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),z.value?(o(),u("div",fe,[a[9]||(a[9]=c("h4",null,"移动预览",-1)),c("div",ye,[a[6]||(a[6]=c("span",{class:"label"},"新上级部门：",-1)),c("span",ge,p(z.value.newParentName||"无（顶级部门）"),1)]),c("div",he,[a[7]||(a[7]=c("span",{class:"label"},"新层级：",-1)),c("span",ke,p(z.value.newLevel)+"级",1)]),c("div",be,[a[8]||(a[8]=c("span",{class:"label"},"排序位置：",-1)),c("span",we,"第"+p(_.newSort)+"位",1)])])):m("",!0)])]),_:1},8,["model-value"])}}}),[["__scopeId","data-v-878b8fd0"]]),Ve={class:"dialog-header"},De={class:"header-left"},xe={class:"department-info"},Ie={class:"dept-avatar"},ze={class:"dept-details"},Se={class:"dept-name"},Te={class:"dept-code"},Pe={class:"header-right"},Ue={class:"permission-stats"},je={class:"stat-item"},Oe={class:"stat-number"},Ae={class:"stat-item"},Le={class:"stat-number"},qe={class:"action-bar"},Ne={class:"action-left"},Ee={class:"section-title"},Me={class:"action-right"},Be={class:"template-section"},Qe={class:"template-header"},$e={class:"template-grid"},Fe=["onClick"],Re={class:"template-icon"},Ze={class:"template-content"},He={class:"template-name"},Je={class:"template-desc"},Ke={class:"template-badge"},Ye={class:"permission-content"},Ge={class:"permission-grid"},We={class:"category-header"},Xe={class:"category-title"},el={class:"category-info"},ll={class:"category-text"},al={class:"category-name"},sl={class:"category-count"},tl={class:"permission-list"},nl={class:"permission-info"},il={class:"permission-main"},ol={class:"permission-name"},dl={class:"permission-desc"},cl={class:"dialog-footer"},rl={class:"footer-left"},ul={class:"selected-summary"},ml={class:"footer-right"},pl=I(e({__name:"PermissionDialog",props:{modelValue:{type:Boolean},department:{}},emits:["update:modelValue","success"],setup(e,{emit:m}){const f=e,C=m,V=te(),D=l(!1),x=l(""),I=a({permissions:[]}),z=[{key:"customer",name:"客户管理",icon:T,color:"#3b82f6",permissions:[{key:"customer.view",name:"查看客户",description:"查看客户列表和详细信息",level:"basic"},{key:"customer.create",name:"新增客户",description:"创建新的客户记录",level:"basic"},{key:"customer.edit",name:"编辑客户",description:"修改客户信息",level:"advanced"},{key:"customer.delete",name:"删除客户",description:"删除客户记录",level:"admin"},{key:"customer.export",name:"导出客户",description:"导出客户数据",level:"advanced"},{key:"customer.import",name:"导入客户",description:"批量导入客户数据",level:"admin"}]},{key:"order",name:"订单管理",icon:U,color:"#10b981",permissions:[{key:"order.view",name:"查看订单",description:"查看订单列表和详情",level:"basic"},{key:"order.create",name:"创建订单",description:"新建订单",level:"basic"},{key:"order.edit",name:"编辑订单",description:"修改订单信息",level:"advanced"},{key:"order.cancel",name:"取消订单",description:"取消订单",level:"advanced"},{key:"order.delete",name:"删除订单",description:"删除订单记录",level:"admin"},{key:"order.audit",name:"审核订单",description:"订单审核权限",level:"admin"}]},{key:"finance",name:"财务管理",icon:j,color:"#f59e0b",permissions:[{key:"finance.view",name:"查看财务",description:"查看财务报表",level:"basic"},{key:"finance.invoice",name:"开具发票",description:"开具和管理发票",level:"advanced"},{key:"finance.payment",name:"付款管理",description:"处理付款事务",level:"advanced"},{key:"finance.report",name:"财务报告",description:"生成财务报告",level:"admin"},{key:"finance.audit",name:"财务审核",description:"财务数据审核",level:"admin"}]},{key:"logistics",name:"物流管理",icon:O,color:"#8b5cf6",permissions:[{key:"logistics.view",name:"查看物流",description:"查看物流信息",level:"basic"},{key:"logistics.track",name:"物流跟踪",description:"跟踪物流状态",level:"basic"},{key:"logistics.manage",name:"物流管理",description:"管理物流配送",level:"advanced"},{key:"logistics.config",name:"物流配置",description:"配置物流参数",level:"admin"}]},{key:"service",name:"客服管理",icon:A,color:"#06b6d4",permissions:[{key:"service.view",name:"查看工单",description:"查看客服工单",level:"basic"},{key:"service.handle",name:"处理工单",description:"处理客服工单",level:"basic"},{key:"service.assign",name:"分配工单",description:"分配工单给其他人",level:"advanced"},{key:"service.close",name:"关闭工单",description:"关闭已完成工单",level:"advanced"},{key:"service.report",name:"客服报告",description:"生成客服报告",level:"admin"}]},{key:"data",name:"资料管理",icon:L,color:"#f59e0b",permissions:[{key:"data.view",name:"查看资料",description:"查看资料列表和详情",level:"basic"},{key:"data.search",name:"客户查询",description:"查询客户归属信息",level:"basic"},{key:"data.assign",name:"分配资料",description:"分配资料给其他成员",level:"advanced"},{key:"data.archive",name:"封存资料",description:"封存和恢复资料",level:"advanced"},{key:"data.export",name:"导出资料",description:"导出资料数据",level:"admin"}]},{key:"analytics",name:"数据分析",icon:q,color:"#ef4444",permissions:[{key:"analytics.view",name:"查看报表",description:"查看数据报表",level:"basic"},{key:"analytics.export",name:"导出报表",description:"导出分析报表",level:"advanced"},{key:"analytics.custom",name:"自定义报表",description:"创建自定义报表",level:"admin"},{key:"analytics.dashboard",name:"数据看板",description:"访问数据看板",level:"admin"}]}],R=[{key:"basic",name:"基础权限",description:"适合普通员工的基础操作权限",icon:T,count:10,permissions:["customer.view","customer.create","order.view","order.create","finance.view","logistics.view","service.view","analytics.view","data.view","data.search"]},{key:"advanced",name:"高级权限",description:"适合主管级别的进阶操作权限",icon:P,count:18,permissions:["customer.view","customer.create","customer.edit","customer.export","order.view","order.create","order.edit","order.cancel","finance.view","finance.invoice","finance.payment","logistics.view","logistics.track","logistics.manage","service.view","service.handle","service.assign","service.close","analytics.view","analytics.export","data.view","data.search","data.assign"]},{key:"admin",name:"管理员权限",description:"拥有所有操作权限，适合管理员",icon:N,count:25,permissions:z.flatMap(e=>e.permissions.map(e=>e.key))},{key:"custom",name:"自定义权限",description:"根据需要自由选择权限组合",icon:E,count:0,permissions:[]}],Z=s(()=>z.reduce((e,l)=>e+l.permissions.length,0)),H=e=>{const l={basic:{text:"基础",type:"success"},advanced:{text:"高级",type:"warning"},admin:{text:"管理",type:"danger"}};return l[e]||l.basic},J=e=>{const l=z.find(l=>l.key===e);return!!l&&l.permissions.every(e=>I.permissions.includes(e.key))},K=e=>{const l=z.find(l=>l.key===e);if(!l)return!1;const a=l.permissions.filter(e=>I.permissions.includes(e.key)).length;return a>0&&a<l.permissions.length},Y=e=>{const l=z.find(l=>l.key===e);return l?l.permissions.filter(e=>I.permissions.includes(e.key)).length:0},G=e=>{const l=z.find(l=>l.key===e);return l?.name||e},W=()=>{I.permissions=z.flatMap(e=>e.permissions.map(e=>e.key))},X=()=>{I.permissions=[],x.value=""},ee=()=>{I.permissions=[...f.department?.permissions||[]],x.value=""},le=()=>{C("update:modelValue",!1)},ae=async()=>{if(f.department){D.value=!0;try{await V.updateDepartmentPermissions(f.department.id,I.permissions),S.success("权限配置保存成功"),C("success"),le()}catch(e){S.error("保存失败，请重试")}finally{D.value=!1}}else S.error("请先选择部门")};return t(()=>f.department,e=>{e&&(I.permissions=[...e.permissions||[]])},{immediate:!0}),(l,a)=>{const s=n("el-icon"),t=n("el-button"),m=n("el-button-group"),f=n("el-checkbox"),C=n("el-tag"),V=n("el-checkbox-group"),S=n("el-dialog");return o(),i(S,{"model-value":e.modelValue,title:"权限配置",width:"1200px","before-close":le,class:"permission-dialog","align-center":"","destroy-on-close":""},{footer:d(()=>[c("div",cl,[c("div",rl,[c("div",ul,[r(s,null,{default:d(()=>[r(y(F))]),_:1}),c("span",null,"已选择 "+p(I.permissions.length)+" 项权限",1),(o(!0),u(g,null,h(z.filter(e=>Y(e.key)>0).map(e=>e.key),e=>(o(),i(C,{key:e,size:"small",class:"category-tag"},{default:d(()=>[v(p(G(e)),1)]),_:2},1024))),128))])]),c("div",ml,[r(t,{onClick:le,size:"large"},{default:d(()=>[...a[10]||(a[10]=[v(" 取消 ",-1)])]),_:1}),r(t,{type:"primary",onClick:ae,loading:D.value,size:"large"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(B))]),_:1}),a[11]||(a[11]=v(" 保存配置 ",-1))]),_:1},8,["loading"])])])]),default:d(()=>[c("div",Ve,[c("div",De,[c("div",xe,[c("div",Ie,[r(s,null,{default:d(()=>[r(y(M))]),_:1})]),c("div",ze,[c("h3",Se,p(e.department?.name||"未选择部门"),1),c("p",Te,"部门编码："+p(e.department?.code||"暂无"),1)])])]),c("div",Pe,[c("div",Ue,[c("div",je,[c("span",Oe,p(I.permissions.length),1),a[2]||(a[2]=c("span",{class:"stat-label"},"已选权限",-1))]),a[4]||(a[4]=c("div",{class:"stat-divider"},null,-1)),c("div",Ae,[c("span",Le,p(Z.value),1),a[3]||(a[3]=c("span",{class:"stat-label"},"总权限数",-1))])])])]),c("div",qe,[c("div",Ne,[c("h4",Ee,[r(s,null,{default:d(()=>[r(y(E))]),_:1}),a[5]||(a[5]=v(" 权限配置 ",-1))])]),c("div",Me,[r(m,{class:"action-buttons"},{default:d(()=>[r(t,{onClick:W,type:"primary",plain:"",size:"small"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(B))]),_:1}),a[6]||(a[6]=v(" 全选 ",-1))]),_:1}),r(t,{onClick:X,size:"small"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(Q))]),_:1}),a[7]||(a[7]=v(" 清空 ",-1))]),_:1}),r(t,{onClick:ee,size:"small"},{default:d(()=>[r(s,null,{default:d(()=>[r(y($))]),_:1}),a[8]||(a[8]=v(" 重置 ",-1))]),_:1})]),_:1})])]),c("div",Be,[c("div",Qe,[r(s,null,{default:d(()=>[r(y(P))]),_:1}),a[9]||(a[9]=c("span",null,"快捷模板",-1))]),c("div",$e,[(o(),u(g,null,h(R,e=>c("div",{key:e.key,onClick:l=>(e=>{const l=R.find(l=>l.key===e);l&&("custom"!==e?(I.permissions=[...l.permissions],x.value=e):x.value=e)})(e.key),class:k(["template-card",{active:x.value===e.key}])},[c("div",Re,[r(s,null,{default:d(()=>[(o(),i(b(e.icon)))]),_:2},1024)]),c("div",Ze,[c("h5",He,p(e.name),1),c("p",Je,p(e.description),1)]),c("div",Ke,[c("span",null,p(e.count)+"项",1)])],10,Fe)),64))])]),c("div",Ye,[c("div",Ge,[(o(),u(g,null,h(z,e=>c("div",{key:e.key,class:"permission-category"},[c("div",We,[c("div",Xe,[r(f,{"model-value":J(e.key),indeterminate:K(e.key),onChange:l=>((e,l)=>{const a=z.find(l=>l.key===e);a&&(l?a.permissions.forEach(e=>{I.permissions.includes(e.key)||I.permissions.push(e.key)}):a.permissions.forEach(e=>{const l=I.permissions.indexOf(e.key);l>-1&&I.permissions.splice(l,1)}))})(e.key,l),onClick:a[0]||(a[0]=w(()=>{},["stop"])),class:"category-checkbox"},{default:d(()=>[c("div",el,[c("div",{class:"category-icon",style:_({backgroundColor:e.color})},[r(s,null,{default:d(()=>[(o(),i(b(e.icon)))]),_:2},1024)],4),c("div",ll,[c("span",al,p(e.name),1),c("span",sl,p(Y(e.key))+"/"+p(e.permissions.length),1)])])]),_:2},1032,["model-value","indeterminate","onChange"])])]),c("div",tl,[r(V,{modelValue:I.permissions,"onUpdate:modelValue":a[1]||(a[1]=e=>I.permissions=e)},{default:d(()=>[(o(!0),u(g,null,h(e.permissions,e=>(o(),u("div",{key:e.key,class:"permission-item"},[r(f,{value:e.key,class:"permission-checkbox"},{default:d(()=>[c("div",nl,[c("div",il,[c("span",ol,p(e.name),1),r(C,{type:H(e.level).type,size:"small",class:"permission-level"},{default:d(()=>[v(p(H(e.level).text),1)]),_:2},1032,["type"])]),c("p",dl,p(e.description),1)])]),_:2},1032,["value"])]))),128))]),_:2},1032,["modelValue"])])])),64))])])]),_:1},8,["model-value"])}}}),[["__scopeId","data-v-cdbf6ec0"]]),vl={class:"departments-container"},fl={class:"page-header"},yl={class:"header-actions"},gl={class:"stats-cards"},hl={class:"stat-card"},kl={class:"stat-icon total"},bl={class:"stat-content"},wl={class:"stat-number"},_l={class:"stat-card"},Cl={class:"stat-icon active"},Vl={class:"stat-content"},Dl={class:"stat-number"},xl={class:"stat-card"},Il={class:"stat-icon members"},zl={class:"stat-content"},Sl={class:"stat-number"},Tl={class:"stat-card"},Pl={class:"stat-icon hierarchy"},Ul={class:"stat-content"},jl={class:"stat-number"},Ol={class:"search-section"},Al={class:"department-list-section"},Ll={class:"section-header"},ql={class:"section-title"},Nl={class:"section-actions"},El={key:0,class:"department-cards-container"},Ml={key:0,class:"empty-state"},Bl={key:1,class:"department-cards-grid"},Ql={class:"card-header"},$l={class:"department-info"},Fl={class:"department-icon"},Rl={class:"department-details"},Zl={class:"department-name"},Hl={class:"department-code"},Jl={class:"department-status"},Kl={class:"card-content"},Yl={class:"info-table"},Gl={class:"info-row"},Wl={class:"info-value"},Xl={class:"info-row"},ea={class:"info-value"},la={class:"info-row"},aa={class:"info-value"},sa={class:"info-row"},ta={class:"info-value"},na={key:0,class:"info-row"},ia={class:"info-value"},oa={class:"card-actions"},da={class:"action-buttons"},ca={key:0,class:"children-indicator"},ra={key:1},ua={class:"department-name-cell"},ma={key:0},pa={key:1,class:"text-gray"},va={class:"dialog-footer"},fa=I(e({__name:"Departments",setup(e){const a=C(),t=z(a),b=te(),w=l(""),_=l(""),I=l(""),P=l(!1),U=l(!1),j=l(!1),O=l(!1),A=l(null),L=l(!1),q=l("card"),N=s(()=>{let e=b.departmentTree;if(w.value){const l=w.value.toLowerCase();e=E(e,l)}return _.value&&(e=Q(e,_.value)),I.value&&(e=oe(e,parseInt(I.value))),e}),E=(e,l)=>e.filter(e=>{const a=e.name.toLowerCase().includes(l)||e.code.toLowerCase().includes(l),s=e.children&&e.children.length>0&&E(e.children,l).length>0;return!(!a&&!s)&&{...e,children:e.children?E(e.children,l):[]}}).map(e=>({...e,children:e.children?E(e.children,l):[]})),Q=(e,l)=>e.map(e=>{const a=e.children?Q(e.children,l):[];return e.status===l||a.length>0?{...e,children:a}:null}).filter(e=>null!==e),oe=(e,l)=>e.filter(e=>e.level===l).map(e=>({...e,children:e.children?oe(e.children,l):[]})),de=e=>["","primary","success","warning","danger"][e]||"info",ce=e=>new Date(e).toLocaleString("zh-CN"),re=()=>{},ue=()=>{},me=()=>{w.value="",_.value="",I.value="",S.success("数据已刷新")},pe=()=>{A.value=null,L.value=!1,P.value=!0},ve=e=>{A.value=e,L.value=!0,P.value=!0},fe=e=>{t.push(`/system/department/detail/${e.id}`)},ye=e=>{t.push(`/system/department/members/${e.id}`)},ge=(e,l)=>{switch(e){case"permission":(e=>{A.value=e,j.value=!0})(l);break;case"members":ye(l);break;case"move":he(l);break;case"delete":ke(l)}},he=e=>{A.value=e,U.value=!0},ke=async e=>{try{await b.deleteDepartment(e.id),S.success("部门删除成功")}catch(l){S.error(l instanceof Error?l.message:"删除失败")}},be=l(!1),we=async e=>{if(be.value)return void console.log("[Departments] 正在更新数据，忽略状态切换事件");if(!e||!e.id)return void console.log("[Departments] 部门ID无效，忽略状态切换事件");const l=e.status,a="active"===l?"启用":"禁用";try{e.statusLoading=!0,await b.updateDepartmentStatus(e.id,l),S.success(`部门${a}成功`)}catch(s){e.status="active"===l?"inactive":"active",S.error(s instanceof Error?s.message:`${a}失败`)}finally{e.statusLoading=!1}},_e=async()=>{P.value=!1;try{be.value=!0,console.log("[Departments] 部门操作成功，重新加载数据"),await b.fetchDepartments(),await b.fetchDepartmentStats(),await f(),console.log("[Departments] 数据重新加载完成，当前部门数量:",b.departments.length),console.log("[Departments] 部门树结构:",b.departmentTree.length),console.log("[Departments] 过滤后的部门数量:",N.value.length),!L.value&&0===N.value.length&&b.departments.length>0&&(console.log("[Departments] 检测到新增部门但列表为空，重置过滤条件"),w.value="",_.value="",I.value=""),S.success(L.value?"部门更新成功":"部门创建成功")}catch(e){console.error("[Departments] 重新加载数据失败:",e),S.success(L.value?"部门更新成功":"部门创建成功")}finally{setTimeout(()=>{be.value=!1,console.log("[Departments] 数据更新完成，恢复状态切换功能")},1e3)}},Ve=()=>{U.value=!1,S.success("部门移动成功")},De=()=>{j.value=!1,S.success("权限配置已保存")},xe=()=>{t.push("/system/department-roles")},Ie=()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{S.success("已退出全屏模式")}).catch(()=>{S.error("退出全屏失败")}):document.documentElement.requestFullscreen().then(()=>{S.success("已进入全屏模式")}).catch(()=>{S.error("全屏模式不支持")})},ze=()=>{O.value=!0},Se=e=>{q.value=e},Te=s(()=>[{prop:"statusSwitch",label:"启用状态",width:100,visible:!0,sortable:!1,showOverflowTooltip:!1,slot:"statusSwitch"},{prop:"name",label:"部门名称",width:200,visible:!0,sortable:!1,showOverflowTooltip:!0,slot:"name"},{prop:"code",label:"部门编码",width:120,visible:!0,sortable:!0,showOverflowTooltip:!1},{prop:"managerName",label:"部门负责人",width:120,visible:!0,sortable:!1,showOverflowTooltip:!1,slot:"managerName"},{prop:"memberCount",label:"成员数量",width:100,visible:!0,sortable:!0,showOverflowTooltip:!1,slot:"memberCount"},{prop:"level",label:"层级",width:80,visible:!0,sortable:!0,showOverflowTooltip:!1,slot:"level"},{prop:"status",label:"状态",width:100,visible:!0,sortable:!1,showOverflowTooltip:!1,slot:"status"},{prop:"updatedAt",label:"更新时间",width:180,visible:!0,sortable:!0,showOverflowTooltip:!1,slot:"updatedAt"}]),Pe=e=>{console.log("列设置变化:",e)};return V(async()=>{try{console.log("[Departments] 开始初始化部门数据"),await b.initData(),console.log("[Departments] 页面初始化完成，部门数量:",b.departments.length)}catch(e){console.error("[Departments] 初始化部门数据失败:",e),S.error("加载部门数据失败，请稍后重试")}}),(e,l)=>{const a=n("el-button"),s=n("el-icon"),f=n("el-col"),C=n("el-row"),V=n("el-input"),z=n("el-option"),S=n("el-select"),E=n("el-button-group"),Q=n("el-empty"),te=n("el-switch"),oe=n("el-link"),be=n("el-tag"),Ue=n("el-dropdown-item"),je=n("el-dropdown-menu"),Oe=n("el-dropdown"),Ae=n("el-dialog"),Le=D("loading");return o(),u("div",vl,[c("div",fl,[l[15]||(l[15]=c("h2",{class:"page-title"},"部门管理",-1)),c("div",yl,[r(a,{type:"warning",icon:y(R),onClick:ze,class:"guide-btn"},{default:d(()=>[...l[11]||(l[11]=[v(" 操作指南 ",-1)])]),_:1},8,["icon"]),r(a,{type:"success",icon:y(Z),onClick:Ie,class:"fullscreen-btn"},{default:d(()=>[...l[12]||(l[12]=[v(" 全屏查看 ",-1)])]),_:1},8,["icon"]),r(a,{type:"info",icon:y(H),onClick:xe,class:"role-btn"},{default:d(()=>[...l[13]||(l[13]=[v(" 角色管理 ",-1)])]),_:1},8,["icon"]),r(a,{type:"primary",icon:y(J),onClick:pe,class:"add-btn"},{default:d(()=>[...l[14]||(l[14]=[v(" 新建部门 ",-1)])]),_:1},8,["icon"])])]),c("div",gl,[r(C,{gutter:20},{default:d(()=>[r(f,{span:6},{default:d(()=>[c("div",hl,[c("div",kl,[r(s,null,{default:d(()=>[r(y(M))]),_:1})]),c("div",bl,[c("div",wl,p(y(b).stats.totalDepartments),1),l[16]||(l[16]=c("div",{class:"stat-label"},"总部门数",-1))])])]),_:1}),r(f,{span:6},{default:d(()=>[c("div",_l,[c("div",Cl,[r(s,null,{default:d(()=>[r(y(B))]),_:1})]),c("div",Vl,[c("div",Dl,p(y(b).stats.activeDepartments),1),l[17]||(l[17]=c("div",{class:"stat-label"},"活跃部门",-1))])])]),_:1}),r(f,{span:6},{default:d(()=>[c("div",xl,[c("div",Il,[r(s,null,{default:d(()=>[r(y(T))]),_:1})]),c("div",zl,[c("div",Sl,p(y(b).stats.totalMembers),1),l[18]||(l[18]=c("div",{class:"stat-label"},"总成员数",-1))])])]),_:1}),r(f,{span:6},{default:d(()=>[c("div",Tl,[c("div",Pl,[r(s,null,{default:d(()=>[r(y(K))]),_:1})]),c("div",Ul,[c("div",jl,p(Object.keys(y(b).stats.departmentsByType).length),1),l[19]||(l[19]=c("div",{class:"stat-label"},"层级类型",-1))])])]),_:1})]),_:1})]),c("div",Ol,[r(C,{gutter:20,align:"middle"},{default:d(()=>[r(f,{span:8},{default:d(()=>[r(V,{modelValue:w.value,"onUpdate:modelValue":l[0]||(l[0]=e=>w.value=e),placeholder:"搜索部门名称或编码","prefix-icon":y(Y),clearable:"",onInput:re},null,8,["modelValue","prefix-icon"])]),_:1}),r(f,{span:6},{default:d(()=>[r(S,{modelValue:_.value,"onUpdate:modelValue":l[1]||(l[1]=e=>_.value=e),placeholder:"部门状态",clearable:"",onChange:ue},{default:d(()=>[r(z,{label:"全部",value:""}),r(z,{label:"活跃",value:"active"}),r(z,{label:"停用",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),r(f,{span:6},{default:d(()=>[r(S,{modelValue:I.value,"onUpdate:modelValue":l[2]||(l[2]=e=>I.value=e),placeholder:"部门层级",clearable:"",onChange:ue},{default:d(()=>[r(z,{label:"全部",value:""}),r(z,{label:"一级部门",value:"1"}),r(z,{label:"二级部门",value:"2"}),r(z,{label:"三级部门",value:"3"})]),_:1},8,["modelValue"])]),_:1}),r(f,{span:4},{default:d(()=>[r(a,{icon:y($),onClick:me,class:"refresh-btn"},{default:d(()=>[...l[20]||(l[20]=[v(" 刷新 ",-1)])]),_:1},8,["icon"])]),_:1})]),_:1})]),c("div",Al,[c("div",Ll,[c("h3",ql,[r(s,null,{default:d(()=>[r(y(M))]),_:1}),l[21]||(l[21]=v(" 部门列表 ",-1))]),c("div",Nl,[r(E,{class:"view-toggle"},{default:d(()=>[r(a,{type:"card"===q.value?"primary":"default",onClick:l[3]||(l[3]=e=>Se("card")),size:"small"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(G))]),_:1}),l[22]||(l[22]=v(" 卡片 ",-1))]),_:1},8,["type"]),r(a,{type:"table"===q.value?"primary":"default",onClick:l[4]||(l[4]=e=>Se("table")),size:"small"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(F))]),_:1}),l[23]||(l[23]=v(" 列表 ",-1))]),_:1},8,["type"])]),_:1}),r(a,{type:"primary",onClick:pe},{default:d(()=>[r(s,null,{default:d(()=>[r(y(J))]),_:1}),l[24]||(l[24]=v(" 新建部门 ",-1))]),_:1})])]),"card"===q.value?x((o(),u("div",El,[0===N.value.length?(o(),u("div",Ml,[r(Q,{description:"暂无部门数据"})])):(o(),u("div",Bl,[(o(!0),u(g,null,h(N.value,e=>(o(),u("div",{key:e.id,class:k(["department-card",{inactive:"inactive"===e.status}])},[c("div",Ql,[c("div",$l,[c("div",Fl,[1===e.level?(o(),i(s,{key:0},{default:d(()=>[r(y(M))]),_:1})):(o(),i(s,{key:1},{default:d(()=>[r(y(W))]),_:1}))]),c("div",Rl,[c("h4",Zl,p(e.name),1),c("p",Hl,p(e.code),1)])]),c("div",Jl,[r(te,{modelValue:e.status,"onUpdate:modelValue":l=>e.status=l,"active-value":"active","inactive-value":"inactive",loading:e.statusLoading,onChange:l=>we(e)},null,8,["modelValue","onUpdate:modelValue","loading","onChange"])])]),c("div",Kl,[c("div",Yl,[c("div",Gl,[l[25]||(l[25]=c("span",{class:"info-label"},"负责人",-1)),c("span",Wl,p(e.managerName||"未设置"),1)]),c("div",Xl,[l[26]||(l[26]=c("span",{class:"info-label"},"成员数量",-1)),c("span",ea,[r(oe,{type:"primary",onClick:l=>(e=>{t.push(`/system/department/members/${e.id}`)})(e)},{default:d(()=>[v(p(e.memberCount)+"人 ",1)]),_:2},1032,["onClick"])])]),c("div",la,[l[27]||(l[27]=c("span",{class:"info-label"},"部门层级",-1)),c("span",aa,[r(be,{type:de(e.level),size:"small"},{default:d(()=>[v(p(e.level)+"级 ",1)]),_:2},1032,["type"])])]),c("div",sa,[l[28]||(l[28]=c("span",{class:"info-label"},"更新时间",-1)),c("span",ta,p(ce(e.updatedAt)),1)]),e.description?(o(),u("div",na,[l[29]||(l[29]=c("span",{class:"info-label"},"描述",-1)),c("span",ia,p(e.description),1)])):m("",!0)])]),c("div",oa,[c("div",da,[r(a,{type:"primary",link:"",size:"small",onClick:l=>fe(e)},{default:d(()=>[r(s,null,{default:d(()=>[r(y(X))]),_:1}),l[30]||(l[30]=v(" 详情 ",-1))]),_:1},8,["onClick"]),r(a,{type:"primary",link:"",size:"small",onClick:l=>ve(e)},{default:d(()=>[r(s,null,{default:d(()=>[r(y(ee))]),_:1}),l[31]||(l[31]=v(" 编辑 ",-1))]),_:1},8,["onClick"]),r(Oe,{trigger:"click",onCommand:l=>ge(l,e)},{dropdown:d(()=>[r(je,null,{default:d(()=>[r(Ue,{command:"members"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(H))]),_:1}),l[33]||(l[33]=v(" 成员配置 ",-1))]),_:1}),r(Ue,{command:"move",disabled:1===e.level},{default:d(()=>[r(s,null,{default:d(()=>[r(y(ae))]),_:1}),l[34]||(l[34]=v(" 移动部门 ",-1))]),_:1},8,["disabled"]),r(Ue,{command:"delete",disabled:e.children&&e.children.length>0},{default:d(()=>[r(s,null,{default:d(()=>[r(y(se))]),_:1}),l[35]||(l[35]=v(" 删除部门 ",-1))]),_:1},8,["disabled"])]),_:2},1024)]),default:d(()=>[r(a,{type:"primary",link:"",size:"small"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(le))]),_:1}),l[32]||(l[32]=v(" 更多 ",-1))]),_:1})]),_:2},1032,["onCommand"])])]),e.children&&e.children.length>0?(o(),u("div",ca,[r(a,{type:"primary",link:"",onClick:l=>fe(e),class:"children-link"},{default:d(()=>[r(s,null,{default:d(()=>[r(y(W))]),_:1}),v(" "+p(e.children.length)+"个子部门 ",1)]),_:2},1032,["onClick"])])):m("",!0)],2))),128))]))])),[[Le,y(b).loading]]):"table"===q.value?x((o(),u("div",ra,[r(ie,{data:N.value,columns:Te.value,"storage-key":"department-list-columns",title:"部门列表","show-selection":!1,"show-index":!0,"show-pagination":!0,"show-actions":!0,"actions-width":350,"page-size":20,total:N.value.length,onColumnSettingsChange:Pe},{"column-statusSwitch":d(({row:e})=>[r(te,{modelValue:e.status,"onUpdate:modelValue":l=>e.status=l,"active-value":"active","inactive-value":"inactive",loading:e.statusLoading,onChange:l=>we(e)},null,8,["modelValue","onUpdate:modelValue","loading","onChange"])]),"column-name":d(({row:e})=>[c("div",ua,[1===e.level?(o(),i(s,{key:0},{default:d(()=>[r(y(M))]),_:1})):(o(),i(s,{key:1},{default:d(()=>[r(y(W))]),_:1})),c("span",null,p(e.name),1)])]),"column-managerName":d(({row:e})=>[e.managerName?(o(),u("span",ma,p(e.managerName),1)):(o(),u("span",pa,"未设置"))]),"column-memberCount":d(({row:e})=>[r(be,{type:"info",size:"small"},{default:d(()=>[v(p(e.memberCount)+"人",1)]),_:2},1024)]),"column-level":d(({row:e})=>[r(be,{type:de(e.level),size:"small"},{default:d(()=>[v(p(e.level)+"级 ",1)]),_:2},1032,["type"])]),"column-status":d(({row:e})=>[r(be,{type:"active"===e.status?"success":"danger",size:"small"},{default:d(()=>[v(p("active"===e.status?"活跃":"停用"),1)]),_:2},1032,["type"])]),"column-updatedAt":d(({row:e})=>[v(p(ce(e.updatedAt)),1)]),"table-actions":d(({row:e})=>[r(a,{type:"primary",link:"",size:"small",onClick:l=>fe(e)},{default:d(()=>[r(s,null,{default:d(()=>[r(y(X))]),_:1}),l[36]||(l[36]=v(" 详情 ",-1))]),_:1},8,["onClick"]),r(a,{type:"primary",link:"",size:"small",onClick:l=>ve(e)},{default:d(()=>[r(s,null,{default:d(()=>[r(y(ee))]),_:1}),l[37]||(l[37]=v(" 编辑 ",-1))]),_:1},8,["onClick"]),r(a,{type:"primary",link:"",size:"small",onClick:l=>ye(e)},{default:d(()=>[r(s,null,{default:d(()=>[r(y(H))]),_:1}),l[38]||(l[38]=v(" 成员 ",-1))]),_:1},8,["onClick"]),r(a,{type:"warning",link:"",size:"small",onClick:l=>he(e),disabled:1===e.level},{default:d(()=>[r(s,null,{default:d(()=>[r(y(ae))]),_:1}),l[39]||(l[39]=v(" 移动 ",-1))]),_:1},8,["onClick","disabled"]),r(a,{type:"danger",link:"",size:"small",onClick:l=>ke(e),disabled:e.children&&e.children.length>0},{default:d(()=>[r(s,null,{default:d(()=>[r(y(se))]),_:1}),l[40]||(l[40]=v(" 删除 ",-1))]),_:1},8,["onClick","disabled"])]),_:1},8,["data","columns","total"])])),[[Le,y(b).loading]]):m("",!0)]),r(ne,{modelValue:P.value,"onUpdate:modelValue":l[5]||(l[5]=e=>P.value=e),department:A.value,"is-edit":L.value,onSuccess:_e},null,8,["modelValue","department","is-edit"]),r(Ce,{modelValue:U.value,"onUpdate:modelValue":l[6]||(l[6]=e=>U.value=e),department:A.value,onSuccess:Ve},null,8,["modelValue","department"]),r(pl,{modelValue:j.value,"onUpdate:modelValue":l[7]||(l[7]=e=>j.value=e),department:A.value,onSuccess:De},null,8,["modelValue","department"]),r(Ae,{modelValue:O.value,"onUpdate:modelValue":l[10]||(l[10]=e=>O.value=e),title:"部门管理与角色权限操作指南",width:"80%","close-on-click-modal":!1,class:"guide-dialog"},{footer:d(()=>[c("div",va,[r(a,{onClick:l[8]||(l[8]=e=>O.value=!1)},{default:d(()=>[...l[41]||(l[41]=[v("关闭",-1)])]),_:1}),r(a,{type:"primary",onClick:l[9]||(l[9]=e=>O.value=!1)},{default:d(()=>[...l[42]||(l[42]=[v("我知道了",-1)])]),_:1})])]),default:d(()=>[l[43]||(l[43]=c("div",{class:"guide-content"},[c("div",{class:"guide-section"},[c("h3",null,"📋 概述"),c("p",null,"本指南将帮助您理解和使用CRM系统中的部门管理和角色权限功能，确保您能够高效地管理组织架构和权限分配。")]),c("div",{class:"guide-section"},[c("h3",null,"🏢 部门管理"),c("div",{class:"guide-subsection"},[c("h4",null,"基本概念"),c("ul",null,[c("li",null,[c("strong",null,"部门"),v("：组织的基本单位，用于划分不同的业务领域")]),c("li",null,[c("strong",null,"层级结构"),v("：支持多级部门嵌套，形成完整的组织架构")]),c("li",null,[c("strong",null,"部门负责人"),v("：每个部门可以指定一名或多名负责人")])])]),c("div",{class:"guide-subsection"},[c("h4",null,"主要功能"),c("div",{class:"feature-grid"},[c("div",{class:"feature-item"},[c("h5",null,"📋 查看部门列表"),c("ul",null,[c("li",null,"卡片视图：以卡片形式展示部门信息"),c("li",null,"表格视图：以表格形式展示详细数据"),c("li",null,"搜索功能：按部门名称、编码搜索")])]),c("div",{class:"feature-item"},[c("h5",null,"⚙️ 部门操作"),c("ul",null,[c("li",null,"新建部门：创建新的部门"),c("li",null,"编辑部门：修改部门信息"),c("li",null,'查看详情：点击"详情"按钮查看完整信息'),c("li",null,"删除部门：删除不再需要的部门")])])])])]),c("div",{class:"guide-section"},[c("h3",null,"👥 角色权限管理"),c("div",{class:"guide-subsection"},[c("h4",null,"权限类型"),c("div",{class:"permission-grid"},[c("div",{class:"permission-item"},[c("h5",null,"🔧 功能权限"),c("ul",null,[c("li",null,"客户管理：客户信息的增删改查权限"),c("li",null,"订单管理：订单处理和状态更新权限"),c("li",null,"产品管理：产品信息维护权限"),c("li",null,"数据分析：报表和统计数据查看权限")])]),c("div",{class:"permission-item"},[c("h5",null,"📊 数据权限"),c("ul",null,[c("li",null,"全部数据：可以查看所有数据"),c("li",null,"部门数据：只能查看本部门及下级部门数据"),c("li",null,"个人数据：只能查看自己创建的数据")])])])])]),c("div",{class:"guide-section"},[c("h3",null,"📝 操作步骤"),c("div",{class:"steps-grid"},[c("div",{class:"step-item"},[c("h5",null,"1️⃣ 新建部门"),c("ol",null,[c("li",null,'点击"新建部门"按钮'),c("li",null,"填写部门基本信息"),c("li",null,"选择上级部门（如果是子部门）"),c("li",null,"指定部门负责人"),c("li",null,"保存部门信息")])]),c("div",{class:"step-item"},[c("h5",null,"2️⃣ 配置部门权限"),c("ol",null,[c("li",null,"在部门列表中找到目标部门"),c("li",null,'点击"权限"按钮'),c("li",null,"选择要分配的角色"),c("li",null,"配置具体的功能权限"),c("li",null,"保存权限配置")])]),c("div",{class:"step-item"},[c("h5",null,"3️⃣ 管理部门成员"),c("ol",null,[c("li",null,'点击部门的"成员"按钮'),c("li",null,"查看当前部门成员列表"),c("li",null,"添加新成员或移除现有成员"),c("li",null,"为成员分配具体角色"),c("li",null,"确认成员权限设置")])]),c("div",{class:"step-item"},[c("h5",null,"4️⃣ 查看部门详情"),c("ol",null,[c("li",null,'点击部门的"详情"按钮'),c("li",null,"查看部门的完整信息"),c("li",null,"查看部门的权限配置"),c("li",null,"查看部门成员列表"),c("li",null,"查看部门的业务数据统计")])])])]),c("div",{class:"guide-section"},[c("h3",null,"⚠️ 注意事项"),c("div",{class:"warning-grid"},[c("div",{class:"warning-item"},[c("h5",null,"🔒 权限管理"),c("ul",null,[c("li",null,"删除部门前，请确保已妥善处理部门下的所有成员"),c("li",null,"修改部门权限时，会影响该部门下所有成员的权限"),c("li",null,"建议定期审查部门权限配置，确保符合业务需求")])]),c("div",{class:"warning-item"},[c("h5",null,"🛡️ 数据安全"),c("ul",null,[c("li",null,"敏感数据的访问权限应严格控制"),c("li",null,"定期检查用户权限，及时回收不必要的权限"),c("li",null,"重要操作建议启用审批流程")])])])]),c("div",{class:"guide-section"},[c("h3",null,"🆘 常见问题"),c("div",{class:"faq-list"},[c("div",{class:"faq-item"},[c("h5",null,"Q: 如何快速找到特定部门？"),c("p",null,"A: 使用搜索功能，输入部门名称或编码进行快速定位。")]),c("div",{class:"faq-item"},[c("h5",null,"Q: 部门权限修改后多久生效？"),c("p",null,"A: 权限修改后立即生效，用户下次登录或刷新页面即可看到新权限。")]),c("div",{class:"faq-item"},[c("h5",null,"Q: 如何批量管理多个部门的权限？"),c("p",null,"A: 可以通过上级部门统一配置权限，下级部门会自动继承。")]),c("div",{class:"faq-item"},[c("h5",null,"Q: 误删部门怎么办？"),c("p",null,"A: 请联系系统管理员进行数据恢复，建议删除前做好备份。")])])]),c("div",{class:"guide-footer"},[c("p",null,[v("💡 "),c("strong",null,"提示"),v("：如需更多帮助，请联系系统管理员或查看详细的用户手册。")])])],-1))]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-e8b6457f"]]);export{fa as default};
