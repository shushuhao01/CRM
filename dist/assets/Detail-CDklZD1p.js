import{l as e,aA as a,aC as s,r as i,Z as l,e as t,b as r,z as n,ag as o,m as d,q as c,p as u,U as p,u as m,T as v,O as f,S as g,M as y,Q as h,F as _,a9 as k}from"./vendor-BtukhyiH.js";import{L as b,ag as N,Q as T,k as w,J as x,u as S,r as V,F as C,M as O,I as P,a4 as A,R as D,E as I}from"./elementPlus-DxaqjplL.js";import{a as F}from"./sensitiveInfo-PTigg6SS.js";import{d as H,b as $,c as q,_ as j}from"./index-BGtT17ll.js";import"./utils-DfI7e5Rl.js";const U={class:"logistics-detail"},E={class:"page-header"},M={class:"header-left"},Y={class:"header-info"},R={class:"header-meta"},L={class:"tracking-no"},z={class:"header-actions"},J={class:"info-grid"},K={class:"info-item"},Z={class:"value"},B={class:"info-item"},Q={class:"info-item"},G={class:"value"},W={class:"info-item"},X={class:"info-item"},ee={class:"value"},ae={class:"info-item"},se={class:"value"},ie={class:"info-item"},le={class:"value"},te={class:"info-item"},re={class:"value"},ne={class:"receiver-info"},oe={class:"receiver-basic"},de={class:"info-item"},ce={class:"value"},ue={class:"info-item"},pe={class:"value"},me={class:"info-item"},ve={class:"value"},fe={key:0,class:"info-item"},ge={class:"value"},ye={class:"product-summary"},he={class:"summary-item"},_e={class:"value"},ke={class:"summary-item"},be={class:"value"},Ne={class:"summary-item"},Te={class:"value"},we={class:"card-header"},xe={class:"tracking-timeline"},Se={class:"timeline-content"},Ve={key:0,class:"timeline-location"},Ce={key:1,class:"timeline-operator"},Oe={class:"action-buttons"},Pe={class:"related-info"},Ae={class:"related-item"},De={class:"item-header"},Ie={class:"item-content"},Fe={class:"item-meta"},He={class:"related-item"},$e={class:"item-header"},qe={class:"item-content"},je={class:"item-meta"},Ue={class:"related-item"},Ee={class:"item-header"},Me={class:"item-content"},Ye={class:"fee-item"},Re={class:"fee-item"},Le={class:"fee-item total"},ze={class:"operation-log"},Je={class:"log-time"},Ke={class:"log-content"},Ze={class:"log-operator"},Be={class:"log-action"},Qe={class:"dialog-footer"},Ge=j(e({__name:"Detail",setup(e){const j=a(),Ge=s(),We=q(j),Xe=H(),ea=$(),aa=i(!1),sa=i(!1),ia=new Set,la=i(!1),ta=l({id:"",trackingNo:"",orderNo:"",companyName:"",status:"",shipTime:"",estimatedTime:"",actualTime:"",freight:0,insuranceFee:0,receiverName:"",receiverPhone:"",receiverAddress:"",remark:"",customerName:"",customerPhone:"",orderTime:""}),ra=i([]),na=i([]),oa=i([]),da=i([{code:"SF",name:"顺丰速运"},{code:"YTO",name:"圆通速递"},{code:"ZTO",name:"中通快递"},{code:"STO",name:"申通快递"},{code:"YD",name:"韵达速递"},{code:"HTKY",name:"百世快递"},{code:"JD",name:"京东物流"},{code:"EMS",name:"中国邮政"}]),ca=l({company:"",trackingNo:"",shipTime:"",estimatedTime:"",remark:""}),ua={company:[{required:!0,message:"请选择物流公司",trigger:"change"}],trackingNo:[{required:!0,message:"请输入物流单号",trigger:"blur"}],shipTime:[{required:!0,message:"请选择发货时间",trigger:"change"}]},pa=i(),ma=t(()=>ra.value.reduce((e,a)=>e+a.quantity,0)),va=t(()=>ra.value.reduce((e,a)=>e+a.weight*a.quantity,0).toFixed(2)),fa=t(()=>ra.value.reduce((e,a)=>e+a.volume*a.quantity,0)),ga=t(()=>(ta.freight+(ta.insuranceFee||0)).toFixed(2)),ya=e=>({pending:"warning",shipped:"primary",in_transit:"info",delivering:"success",delivered:"success",exception:"danger"}[e]||""),ha=e=>({pending:"待发货",shipped:"已发货",in_transit:"运输中",delivering:"派送中",delivered:"已签收",exception:"异常"}[e]||e),_a=()=>{j.go(-1)},ka=()=>{window.print()},ba=()=>{We.push(`/logistics/edit/${ta.id}`)},Na=()=>{Object.assign(ca,{company:"",trackingNo:"",shipTime:new Date,estimatedTime:"",remark:""}),aa.value=!0},Ta=async()=>{if(!la.value)try{if(await(pa.value?.validate()),la.value)return;if(sa.value=!0,await new Promise(e=>{const a=setTimeout(()=>{ia.delete(a),e(void 0)},1500);ia.add(a)}),!la.value){const e=ta.orderNo.replace("ORD","");Xe.syncOrderStatus(e,"shipped","物流员",`订单已发货，快递公司：${ca.company}，快递单号：${ca.trackingNo}`),ea.sendMessage(ea.MessageType.ORDER_SHIPPED,`订单 ${ta.orderNo} 已发货，快递公司：${ca.company}，快递单号：${ca.trackingNo}`,{relatedId:e,relatedType:"order",actionUrl:`/logistics/detail/${ta.id}`}),I.success("发货成功"),wa(),Fa()}}catch(e){console.error("表单验证失败:",e)}finally{la.value||(sa.value=!1)}},wa=()=>{aa.value=!1,pa.value?.clearValidate()},xa=()=>{I.success("跳转到物流公司官网跟踪页面...")},Sa=()=>{I.success(`拨打电话：${ta.receiverPhone}`)},Va=()=>{I.success("投诉建议功能开发中...")},Ca=()=>{if(ta.id)We.push(`/order/detail/${ta.id}`);else{const e=Xe.getOrderByNumber(ta.orderNo);e?We.push(`/order/detail/${e.id}`):I.warning("未找到对应的订单")}},Oa=()=>{We.push(`/customer/detail/${ta.customerId}`)},Pa=async()=>{if(!la.value)try{await new Promise(e=>{const a=setTimeout(()=>{ia.delete(a),e(void 0)},1e3);ia.add(a)}),la.value||(I.success("轨迹已刷新"),Aa())}catch(e){la.value||I.error("刷新失败")}},Aa=async e=>{if(!la.value)try{if(!e){const a=Ge.params.id;e=Xe.getOrders().find(e=>e.id===a||e.trackingNumber===a||e.expressNo===a||parseInt(e.id)===parseInt(a))}if(!e)return void(na.value=[]);if(e.logisticsHistory&&Array.isArray(e.logisticsHistory)&&e.logisticsHistory.length>0)na.value=e.logisticsHistory.map(e=>({time:e.time||"",status:Da(e.status),description:e.description||"",location:e.location||"",operator:e.operator||"",type:Ia(e.status)})).reverse();else if(e.statusHistory&&Array.isArray(e.statusHistory)){const a=["shipped","delivered","in_transit","out_for_delivery"],s=e.statusHistory.filter(e=>a.includes(e.status)).map(e=>({time:e.time||"",status:Da(e.status),description:e.description||e.remark||"",location:"",operator:e.operator||"",type:Ia(e.status)}));na.value=s.reverse()}else na.value=[]}catch(a){console.error("加载物流轨迹失败:",a),na.value=[]}},Da=e=>({pending:"待发货",picked_up:"已揽收",shipped:"已发货",in_transit:"运输中",out_for_delivery:"派送中",delivered:"已签收",exception:"异常",rejected:"拒收",returned:"已退回"}[e]||e),Ia=e=>({delivered:"success",out_for_delivery:"warning",shipped:"primary",in_transit:"info",picked_up:"info",exception:"danger",rejected:"danger",returned:"info",pending:"warning"}[e]||"info"),Fa=async()=>{if(!la.value)try{const e=Ge.params.id,a=Xe.getOrders();let s=a.find(a=>a.id===e||a.id===String(e)||String(a.id)===String(e)||parseInt(String(a.id))===parseInt(String(e)));if(s||(s=a.find(a=>a.trackingNumber===e||a.expressNo===e||a.trackingNumber&&a.trackingNumber.toString()===e.toString()||a.expressNo&&a.expressNo.toString()===e.toString())),!s)return void I.error("未找到对应的订单信息");if(la.value)return;Object.assign(ta,{id:s.id,trackingNo:s.trackingNumber||s.expressNo||"",orderNo:s.orderNumber,companyName:Ha(s.expressCompany||""),status:$a(s.status,s.logisticsStatus),shipTime:s.shippingTime||s.shipTime||"",estimatedTime:s.estimatedDeliveryTime||"",actualTime:"delivered"===s.logisticsStatus&&s.statusHistory?.find(e=>"delivered"===e.status)?.time||"",freight:0,insuranceFee:0,receiverName:s.receiverName||"",receiverPhone:s.receiverPhone||"",receiverAddress:s.receiverAddress||"",remark:s.remark||"",customerName:s.customerName||"",customerPhone:s.customerPhone||"",orderTime:s.createTime||"",customerId:s.customerId||""}),s.products&&Array.isArray(s.products)?ra.value=s.products.map(e=>({productName:e.name||"",specification:e.specification||"",quantity:e.quantity||0,weight:e.weight||0,volume:e.volume||0})):ra.value=[],s.operationLogs&&Array.isArray(s.operationLogs)?oa.value=s.operationLogs.map(e=>({time:e.time||"",operator:e.operator||"",action:e.action||""})).reverse():oa.value=[],await Aa(s)}catch(e){console.error("加载数据失败:",e),I.error("加载数据失败")}},Ha=e=>({SF:"顺丰速运",YTO:"圆通速递",ZTO:"中通快递",STO:"申通快递",YD:"韵达速递",HTKY:"百世快递",JD:"京东物流",EMS:"中国邮政",DBKD:"德邦快递",UC:"优速快递"}[e]||e),$a=(e,a)=>{if(a)return a;return{pending_shipment:"pending",shipped:"shipped",delivered:"delivered",in_transit:"in_transit",out_for_delivery:"delivering",package_exception:"exception"}[e]||"pending"};return r(()=>{Fa()}),n(()=>{la.value=!0,ia.forEach(e=>clearTimeout(e)),ia.clear()}),(e,a)=>{const s=o("el-button"),i=o("el-tag"),l=o("el-link"),t=o("el-card"),r=o("el-table-column"),n=o("el-table"),I=o("el-icon"),H=o("el-timeline-item"),$=o("el-timeline"),q=o("el-col"),j=o("el-row"),Ge=o("el-option"),We=o("el-select"),Xe=o("el-form-item"),ea=o("el-input"),ia=o("el-date-picker"),la=o("el-form"),Aa=o("el-dialog");return c(),d("div",U,[u("div",E,[u("div",M,[p(s,{onClick:_a,icon:m(b),circle:""},null,8,["icon"]),u("div",Y,[a[6]||(a[6]=u("h2",null,"物流详情",-1)),u("div",R,[u("span",L,v(ta.trackingNo),1),p(i,{type:ya(ta.status),size:"large"},{default:f(()=>[g(v(ha(ta.status)),1)]),_:1},8,["type"])])])]),u("div",z,[p(s,{onClick:ka,icon:m(N)},{default:f(()=>[...a[7]||(a[7]=[g(" 打印 ",-1)])]),_:1},8,["icon"]),p(s,{onClick:ba,type:"primary",icon:m(T)},{default:f(()=>[...a[8]||(a[8]=[g(" 编辑 ",-1)])]),_:1},8,["icon"]),"pending"===ta.status?(c(),y(s,{key:0,onClick:Na,type:"success",icon:m(w)},{default:f(()=>[...a[9]||(a[9]=[g(" 发货 ",-1)])]),_:1},8,["icon"])):h("",!0)])]),p(j,{gutter:20},{default:f(()=>[p(q,{span:16},{default:f(()=>[p(t,{class:"info-card",title:"基本信息"},{header:f(()=>[...a[10]||(a[10]=[u("div",{class:"card-header"},[u("span",null,"基本信息")],-1)])]),default:f(()=>[u("div",J,[u("div",K,[a[11]||(a[11]=u("span",{class:"label"},"物流单号：",-1)),u("span",Z,v(ta.trackingNo),1)]),u("div",B,[a[12]||(a[12]=u("span",{class:"label"},"订单号：",-1)),p(l,{onClick:Ca,type:"primary",class:"value"},{default:f(()=>[g(v(ta.orderNo),1)]),_:1})]),u("div",Q,[a[13]||(a[13]=u("span",{class:"label"},"物流公司：",-1)),u("span",G,v(ta.companyName),1)]),u("div",W,[a[14]||(a[14]=u("span",{class:"label"},"物流状态：",-1)),p(i,{type:ya(ta.status),class:"value"},{default:f(()=>[g(v(ha(ta.status)),1)]),_:1},8,["type"])]),u("div",X,[a[15]||(a[15]=u("span",{class:"label"},"发货时间：",-1)),u("span",ee,v(ta.shipTime||"未发货"),1)]),u("div",ae,[a[16]||(a[16]=u("span",{class:"label"},"预计送达：",-1)),u("span",se,v(ta.estimatedTime||"未设置"),1)]),u("div",ie,[a[17]||(a[17]=u("span",{class:"label"},"实际送达：",-1)),u("span",le,v(ta.actualTime||"未送达"),1)]),u("div",te,[a[18]||(a[18]=u("span",{class:"label"},"运费：",-1)),u("span",re,"¥"+v(ta.freight),1)])])]),_:1}),p(t,{class:"info-card"},{header:f(()=>[...a[19]||(a[19]=[u("div",{class:"card-header"},[u("span",null,"收货信息")],-1)])]),default:f(()=>[u("div",ne,[u("div",oe,[u("div",de,[a[20]||(a[20]=u("span",{class:"label"},"收货人：",-1)),u("span",ce,v(ta.receiverName),1)]),u("div",ue,[a[21]||(a[21]=u("span",{class:"label"},"联系电话：",-1)),u("span",pe,v(m(F)(ta.receiverPhone,"phone")),1)])]),u("div",me,[a[22]||(a[22]=u("span",{class:"label"},"收货地址：",-1)),u("span",ve,v(ta.receiverAddress),1)]),ta.remark?(c(),d("div",fe,[a[23]||(a[23]=u("span",{class:"label"},"备注：",-1)),u("span",ge,v(ta.remark),1)])):h("",!0)])]),_:1}),p(t,{class:"info-card"},{header:f(()=>[...a[24]||(a[24]=[u("div",{class:"card-header"},[u("span",null,"商品信息")],-1)])]),default:f(()=>[p(n,{data:ra.value,style:{width:"100%"}},{default:f(()=>[p(r,{prop:"productName",label:"商品名称"}),p(r,{prop:"specification",label:"规格",width:"120"}),p(r,{prop:"quantity",label:"数量",width:"80"}),p(r,{prop:"weight",label:"重量(kg)",width:"100"}),p(r,{prop:"volume",label:"体积(cm³)",width:"120"})]),_:1},8,["data"]),u("div",ye,[u("div",he,[a[25]||(a[25]=u("span",{class:"label"},"总数量：",-1)),u("span",_e,v(ma.value)+" 件",1)]),u("div",ke,[a[26]||(a[26]=u("span",{class:"label"},"总重量：",-1)),u("span",be,v(va.value)+" kg",1)]),u("div",Ne,[a[27]||(a[27]=u("span",{class:"label"},"总体积：",-1)),u("span",Te,v(fa.value)+" cm³",1)])])]),_:1}),p(t,{class:"info-card"},{header:f(()=>[u("div",we,[a[29]||(a[29]=u("span",null,"物流轨迹",-1)),p(s,{onClick:Pa,icon:m(V),size:"small"},{default:f(()=>[...a[28]||(a[28]=[g(" 刷新 ",-1)])]),_:1},8,["icon"])])]),default:f(()=>[u("div",xe,[p($,null,{default:f(()=>[(c(!0),d(_,null,k(na.value,(e,a)=>(c(),y(H,{key:a,timestamp:e.time,type:e.type,hollow:0!==a},{default:f(()=>[u("div",Se,[u("h4",null,v(e.status),1),u("p",null,v(e.description),1),e.location?(c(),d("div",Ve,[p(I,null,{default:f(()=>[p(m(x))]),_:1}),u("span",null,v(e.location),1)])):h("",!0),e.operator?(c(),d("div",Ce,[p(I,null,{default:f(()=>[p(m(S))]),_:1}),u("span",null,v(e.operator),1)])):h("",!0)])]),_:2},1032,["timestamp","type","hollow"]))),128))]),_:1})])]),_:1})]),_:1}),p(q,{span:8},{default:f(()=>[p(t,{class:"action-card"},{header:f(()=>[...a[30]||(a[30]=[u("div",{class:"card-header"},[u("span",null,"快捷操作")],-1)])]),default:f(()=>[u("div",Oe,[p(s,{onClick:xa,type:"primary",icon:m(C),style:{width:"100%","margin-bottom":"12px"}},{default:f(()=>[...a[31]||(a[31]=[g(" 实时跟踪 ",-1)])]),_:1},8,["icon"]),p(s,{onClick:Sa,type:"success",icon:m(O),style:{width:"100%","margin-bottom":"12px"}},{default:f(()=>[...a[32]||(a[32]=[g(" 联系收货人 ",-1)])]),_:1},8,["icon"]),p(s,{onClick:Va,type:"warning",icon:m(P),style:{width:"100%","margin-bottom":"12px"}},{default:f(()=>[...a[33]||(a[33]=[g(" 投诉建议 ",-1)])]),_:1},8,["icon"])])]),_:1}),p(t,{class:"related-card"},{header:f(()=>[...a[34]||(a[34]=[u("div",{class:"card-header"},[u("span",null,"相关信息")],-1)])]),default:f(()=>[u("div",Pe,[u("div",Ae,[u("div",De,[p(I,null,{default:f(()=>[p(m(A))]),_:1}),a[35]||(a[35]=u("span",null,"关联订单",-1))]),u("div",Ie,[p(l,{onClick:Ca,type:"primary"},{default:f(()=>[g(v(ta.orderNo),1)]),_:1}),u("span",Fe,v(ta.orderTime),1)])]),u("div",He,[u("div",$e,[p(I,null,{default:f(()=>[p(m(S))]),_:1}),a[36]||(a[36]=u("span",null,"客户信息",-1))]),u("div",qe,[p(l,{onClick:Oa,type:"primary"},{default:f(()=>[g(v(ta.customerName),1)]),_:1}),u("span",je,v(m(F)(ta.customerPhone,"phone")),1)])]),u("div",Ue,[u("div",Ee,[p(I,null,{default:f(()=>[p(m(D))]),_:1}),a[37]||(a[37]=u("span",null,"费用信息",-1))]),u("div",Me,[u("div",Ye,[u("span",null,"运费：¥"+v(ta.freight),1)]),u("div",Re,[u("span",null,"保价费：¥"+v(ta.insuranceFee||"0.00"),1)]),u("div",Le,[u("span",null,"总计：¥"+v(ga.value),1)])])])])]),_:1}),p(t,{class:"log-card"},{header:f(()=>[...a[38]||(a[38]=[u("div",{class:"card-header"},[u("span",null,"操作日志")],-1)])]),default:f(()=>[u("div",ze,[(c(!0),d(_,null,k(oa.value,(e,a)=>(c(),d("div",{key:a,class:"log-item"},[u("div",Je,v(e.time),1),u("div",Ke,[u("span",Ze,v(e.operator),1),u("span",Be,v(e.action),1)])]))),128))])]),_:1})]),_:1})]),_:1}),p(Aa,{modelValue:aa.value,"onUpdate:modelValue":a[5]||(a[5]=e=>aa.value=e),title:"发货处理",width:"600px","before-close":wa},{footer:f(()=>[u("span",Qe,[p(s,{onClick:wa},{default:f(()=>[...a[39]||(a[39]=[g("取消",-1)])]),_:1}),p(s,{onClick:Ta,type:"primary",loading:sa.value},{default:f(()=>[...a[40]||(a[40]=[g(" 确认发货 ",-1)])]),_:1},8,["loading"])])]),default:f(()=>[p(la,{ref_key:"shipFormRef",ref:pa,model:ca,rules:ua,"label-width":"100px"},{default:f(()=>[p(Xe,{label:"物流公司",prop:"company"},{default:f(()=>[p(We,{modelValue:ca.company,"onUpdate:modelValue":a[0]||(a[0]=e=>ca.company=e),placeholder:"请选择物流公司",style:{width:"100%"}},{default:f(()=>[(c(!0),d(_,null,k(da.value,e=>(c(),y(Ge,{key:e.code,label:e.name,value:e.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),p(Xe,{label:"物流单号",prop:"trackingNo"},{default:f(()=>[p(ea,{modelValue:ca.trackingNo,"onUpdate:modelValue":a[1]||(a[1]=e=>ca.trackingNo=e),placeholder:"请输入物流单号"},null,8,["modelValue"])]),_:1}),p(Xe,{label:"发货时间",prop:"shipTime"},{default:f(()=>[p(ia,{modelValue:ca.shipTime,"onUpdate:modelValue":a[2]||(a[2]=e=>ca.shipTime=e),type:"datetime",placeholder:"选择发货时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),p(Xe,{label:"预计送达",prop:"estimatedTime"},{default:f(()=>[p(ia,{modelValue:ca.estimatedTime,"onUpdate:modelValue":a[3]||(a[3]=e=>ca.estimatedTime=e),type:"datetime",placeholder:"选择预计送达时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),p(Xe,{label:"备注",prop:"remark"},{default:f(()=>[p(ea,{modelValue:ca.remark,"onUpdate:modelValue":a[4]||(a[4]=e=>ca.remark=e),type:"textarea",rows:3,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-52674fe8"]]);export{Ge as default};
