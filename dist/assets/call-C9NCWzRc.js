var N=Object.defineProperty;var P=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var $=(t,a,o)=>a in t?N(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o,m=(t,a)=>{for(var o in a||(a={}))q.call(a,o)&&$(t,o,a[o]);if(P)for(var o of P(a))j.call(a,o)&&$(t,o,a[o]);return t};var c=(t,a,o)=>new Promise((f,v)=>{var w=u=>{try{h(o.next(u))}catch(d){v(d)}},p=u=>{try{h(o.throw(u))}catch(d){v(d)}},h=u=>u.done?f(u.value):Promise.resolve(u.value).then(w,p);h((o=o.apply(t,a)).next())});import{aw as B,r as i,e as C}from"./vendor-D8Vxqhr-.js";import{f as l}from"./settings-CuxbDWOu.js";import{E as n,a as F}from"./elementPlus-Bmwh7Rh8.js";const G=t=>l.get("/api/calls/records",t),x=t=>l.post("/api/calls/records",t),J=t=>l.post("/api/calls/outbound",t),K=(t,a)=>l.put(`/api/calls/records/${t}/end`,a),L=t=>l.get("/api/calls/followups",t),Q=t=>l.post("/api/calls/followups",t),V=(t,a)=>l.put(`/api/calls/followups/${t}`,a),W=t=>l.get("/api/calls/statistics",t),X=t=>l.get("/api/calls/recordings",t),Y=t=>l.get("/api/calls/config",t?{userId:t}:void 0),Z=t=>l.put("/api/calls/config",t),_=()=>l.post("/api/calls/test-connection"),ee=(t,a)=>l.get(`/api/customers/${t}/calls`,a),ge=t=>l.get("/api/calls/export",t),he=B("call",()=>{const t=i([]),a=i([]),o=i(null),f=i(null),v=i(null),w=i(!1),p=i(null),h=i([]),u=i({current:1,pageSize:20,total:0}),d=i({current:1,pageSize:20,total:0}),S=C(()=>{const r=new Date().toDateString();return t.value.filter(e=>new Date(e.createdAt).toDateString()===r).length}),R=C(()=>{const r=new Date().toDateString();return t.value.filter(e=>new Date(e.createdAt).toDateString()===r).reduce((e,s)=>e+s.duration,0)}),D=C(()=>{if(t.value.length===0)return 0;const r=t.value.filter(e=>e.callStatus==="connected").length;return Math.round(r/t.value.length*100)}),T=C(()=>a.value.filter(r=>r.status==="pending")),I=C(()=>a.value.filter(r=>r.status==="pending"&&r.priority==="urgent")),b=r=>c(void 0,null,function*(){try{const e=yield G(m({page:u.value.current,pageSize:u.value.pageSize},r));return t.value=e.data.records,u.value={current:e.data.page,pageSize:e.data.pageSize,total:e.data.total},e.data}catch(e){throw console.error("获取通话记录失败:",e),n.error("获取通话记录失败"),e}}),O=r=>c(void 0,null,function*(){try{const e=yield L(m({page:d.value.current,pageSize:d.value.pageSize},r));return a.value=e.data.records,d.value={current:e.data.page,pageSize:e.data.pageSize,total:e.data.total},e.data}catch(e){throw console.error("获取跟进记录失败:",e),n.error("获取跟进记录失败"),e}}),E=r=>c(void 0,null,function*(){try{const e=yield J(r);if(e.data.status==="success"){w.value=!0,p.value=new Date;const s={customerId:r.customerId,customerName:"",customerPhone:r.customerPhone,callType:"outbound",callStatus:"connected",startTime:new Date().toISOString(),duration:0,notes:r.notes,followUpRequired:!1,userId:"",userName:"",department:""},g=yield x(s);return o.value=g.data,F({title:"外呼成功",message:`正在呼叫 ${r.customerPhone}`,type:"success"}),e.data}else throw new Error(e.data.message)}catch(e){throw console.error("外呼失败:",e),n.error("外呼失败"),e}}),M=(r,e=!1)=>c(void 0,null,function*(){if(!o.value||!p.value){n.warning("没有正在进行的通话");return}try{const s=new Date,g=Math.floor((s.getTime()-p.value.getTime())/1e3),y=yield K(o.value.id,{endTime:s.toISOString(),duration:g,notes:r,followUpRequired:e}),z=t.value.findIndex(H=>H.id===o.value.id);return z!==-1?t.value[z]=y.data:t.value.unshift(y.data),w.value=!1,p.value=null,o.value=null,F({title:"通话结束",message:`通话时长: ${Math.floor(g/60)}分${g%60}秒`,type:"info"}),y.data}catch(s){throw console.error("结束通话失败:",s),n.error("结束通话失败"),s}}),k=r=>c(void 0,null,function*(){try{const e=yield Q(r);return a.value.unshift(e.data),n.success("跟进记录创建成功"),e.data}catch(e){throw console.error("创建跟进记录失败:",e),n.error("创建跟进记录失败"),e}}),A=(r,e)=>c(void 0,null,function*(){try{const s=yield V(r,e),g=a.value.findIndex(y=>y.id===r);return g!==-1&&(a.value[g]=s.data),n.success("跟进记录更新成功"),s.data}catch(s){throw console.error("更新跟进记录失败:",s),n.error("更新跟进记录失败"),s}}),U=r=>c(void 0,null,function*(){try{const e=yield W(r);return v.value=e.data,e.data}catch(e){throw console.error("获取通话统计失败:",e),n.error("获取通话统计失败"),e}});return{callRecords:t,followUpRecords:a,currentCall:o,phoneConfig:f,callStatistics:v,isCallActive:w,callStartTime:p,recordings:h,pagination:u,followUpPagination:d,todayCallCount:S,todayCallDuration:R,connectionRate:D,pendingFollowUps:T,urgentFollowUps:I,fetchCallRecords:b,fetchFollowUpRecords:O,makeOutboundCall:E,endCall:M,createFollowUp:k,updateFollowUp:A,fetchCallStatistics:U,getStatistics:()=>c(void 0,null,function*(){try{return yield U(),{todayCalls:S.value,totalDuration:R.value,connectionRate:D.value,activeUsers:5}}catch(r){return console.error("获取统计数据失败:",r),{todayCalls:0,totalDuration:0,connectionRate:0,activeUsers:0}}}),fetchRecordings:r=>c(void 0,null,function*(){try{const e=yield X(r);return h.value=e.data.recordings,e.data}catch(e){throw console.error("获取录音列表失败:",e),n.error("获取录音列表失败"),e}}),fetchPhoneConfig:r=>c(void 0,null,function*(){try{const e=yield Y(r);return f.value=e.data,e.data}catch(e){throw console.error("获取电话配置失败:",e),n.error("获取电话配置失败"),e}}),updatePhoneConfig:r=>c(void 0,null,function*(){try{const e=yield Z(r);return f.value=e.data,n.success("电话配置更新成功"),e.data}catch(e){throw console.error("更新电话配置失败:",e),n.error("更新电话配置失败"),e}}),testConnection:()=>c(void 0,null,function*(){try{const r=yield _();return r.data.success?n.success(`连接测试成功，延迟: ${r.data.latency}ms`):n.error(`连接测试失败: ${r.data.message}`),r.data}catch(r){throw console.error("连接测试失败:",r),n.error("连接测试失败"),r}}),fetchCustomerCallHistory:(r,e)=>c(void 0,null,function*(){try{return(yield ee(r,e)).data}catch(s){throw console.error("获取客户通话历史失败:",s),n.error("获取客户通话历史失败"),s}}),saveCallRecord:r=>c(void 0,null,function*(){try{const e=yield x(r);return t.value.unshift(e.data),n.success("通话记录保存成功"),e.data}catch(e){throw console.error("保存通话记录失败:",e),n.error("保存通话记录失败"),e}}),resetState:()=>{t.value=[],a.value=[],o.value=null,f.value=null,v.value=null,w.value=!1,p.value=null,h.value=[],u.value={current:1,pageSize:20,total:0},d.value={current:1,pageSize:20,total:0}}}});export{ge as e,W as g,he as u};
