import{u as e}from"./call-tocDvhqz.js";import{u as l,S as a,c as t,_ as o}from"./index-BGtT17ll.js";import{l as r,aA as d,e as s,r as u,Z as n,b as c,ag as i,aq as m,m as p,q as f,p as v,U as g,S as h,O as _,u as w,F as b,a9 as y,M as C,P as V,T as k}from"./vendor-BtukhyiH.js";import{d as x}from"./sensitiveInfo-PTigg6SS.js";import{M as U,G as z,F as P,az as R,O as N,d as Y,Z as D,Q as j,A as F,E as I,b as M}from"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";const O={class:"outbound-list"},S={class:"page-header"},T={class:"header-content"},$={class:"page-title"},q={class:"header-actions"},H={class:"search-section"},A={class:"table-section"},E={class:"table-header"},L={class:"table-actions"},Z={key:1,style:{color:"#C0C4CC"}},G={key:1,style:{color:"#C0C4CC"}},Q={class:"pagination-wrapper"},B=o(r({__name:"OutboundList",setup(o){const r=e(),B=l(),J=d(),K=t(J),W=s(()=>B.users.filter(e=>["sales_staff","department_manager","admin","super_admin","customer_service"].includes(e.role)).map(e=>({id:e.id,name:e.realName||e.name||e.username}))),X=u(!1),ee=u(!1),le=u(!1),ae=u(!1),te=u([]),oe=u([]),re=u(0),de=u(!1),se=u(!1),ue=u(null),ne=n({customerName:"",customerPhone:"",status:"",dateRange:[],callerId:""}),ce=n({page:1,size:20}),ie=n({customerPhone:"",customerName:"",notes:""}),me=u(),pe={customerPhone:[{required:!0,message:"请输入客户电话",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],customerName:[{required:!0,message:"请输入客户姓名",trigger:"blur"}]},fe=n({type:"",content:"",nextFollowUpTime:""}),ve=u(),ge={type:[{required:!0,message:"请选择跟进类型",trigger:"change"}],content:[{required:!0,message:"请输入跟进内容",trigger:"blur"}]},he=e=>{if(e<60)return`${e}秒`;return`${Math.floor(e/60)}分${e%60}秒`},_e=e=>({connected:"已接通",missed:"未接听",rejected:"拒接",failed:"失败"}[e]||"未知"),we=async()=>{try{X.value=!0;const e={page:ce.page,size:ce.size,...ne,startDate:ne.dateRange[0],endDate:ne.dateRange[1]},l=await r.fetchCallRecords(e);te.value=l.records,re.value=l.total}catch(e){console.error("加载呼出记录失败:",e),I.error("加载数据失败")}finally{X.value=!1}},be=()=>{ce.page=1,we()},ye=()=>{Object.assign(ne,{customerName:"",customerPhone:"",status:"",dateRange:[],callerId:""}),be()},Ce=e=>{oe.value=e},Ve=e=>{ce.size=e,we()},ke=e=>{ce.page=e,we()},xe=async()=>{if(me.value)try{await me.value.validate(),le.value=!0,await r.makeOutboundCall({customerPhone:ie.customerPhone,customerName:ie.customerName,notes:ie.notes}),I.success("外呼已发起"),de.value=!1,me.value.resetFields(),Object.assign(ie,{customerPhone:"",customerName:"",notes:""}),we()}catch(e){console.error("发起外呼失败:",e),I.error("发起外呼失败")}finally{le.value=!1}},Ue=async()=>{if(ve.value&&ue.value)try{await ve.value.validate(),ae.value=!0,await r.createFollowUpRecord({callRecordId:ue.value.id,customerId:ue.value.customerId,type:fe.type,content:fe.content,nextFollowUpTime:fe.nextFollowUpTime||void 0}),I.success("跟进记录已保存"),se.value=!1,ve.value.resetFields(),Object.assign(fe,{type:"",content:"",nextFollowUpTime:""}),we()}catch(e){console.error("保存跟进记录失败:",e),I.error("保存跟进记录失败")}finally{ae.value=!1}},ze=async()=>{if(oe.value&&0!==oe.value.length)try{await M.confirm(`确定要删除选中的 ${oe.value.length} 条记录吗？`,"批量删除",{type:"warning"});const e=oe.value.map(e=>e.id);await r.batchDeleteCallRecords(e),I.success("批量删除成功"),we()}catch(e){"cancel"!==e&&(console.error("批量删除失败:",e),I.error("批量删除失败"))}else I.warning("请先选择要删除的记录")},Pe=async()=>{if(oe.value&&0!==oe.value.length)try{const e=oe.value.map(e=>e.id);await r.exportCallRecords({recordIds:e}),I.success("导出成功")}catch(e){console.error("批量导出失败:",e),I.error("批量导出失败")}else I.warning("请先选择要导出的记录")},Re=async()=>{try{ee.value=!0;const e={...ne,startDate:ne.dateRange[0],endDate:ne.dateRange[1]};await r.exportCallRecords(e),I.success("导出成功")}catch(e){console.error("导出失败:",e),I.error("导出失败")}finally{ee.value=!1}};return c(async()=>{await B.loadUsers(),we()}),(e,l)=>{const t=i("PhoneOutgoing"),o=i("el-icon"),d=i("el-button"),s=i("el-input"),u=i("el-form-item"),n=i("el-option"),c=i("el-select"),B=i("el-date-picker"),J=i("el-form"),Ne=i("el-card"),Ye=i("el-table-column"),De=i("el-tag"),je=i("el-dropdown-item"),Fe=i("el-dropdown-menu"),Ie=i("el-dropdown"),Me=i("el-table"),Oe=i("el-pagination"),Se=i("el-dialog"),Te=m("loading");return f(),p("div",O,[v("div",S,[v("div",T,[v("h1",$,[g(o,null,{default:_(()=>[g(t)]),_:1}),l[18]||(l[18]=h(" 呼出列表 ",-1))]),l[19]||(l[19]=v("p",{class:"page-description"},"管理所有外呼记录，支持批量操作和数据导出",-1))]),v("div",q,[g(d,{type:"primary",onClick:l[0]||(l[0]=e=>de.value=!0)},{default:_(()=>[g(o,null,{default:_(()=>[g(w(U))]),_:1}),l[20]||(l[20]=h(" 发起外呼 ",-1))]),_:1}),g(d,{onClick:Re,loading:ee.value},{default:_(()=>[g(o,null,{default:_(()=>[g(w(z))]),_:1}),l[21]||(l[21]=h(" 导出记录 ",-1))]),_:1},8,["loading"])])]),v("div",H,[g(Ne,null,{default:_(()=>[g(J,{model:ne,inline:""},{default:_(()=>[g(u,{label:"客户姓名"},{default:_(()=>[g(s,{modelValue:ne.customerName,"onUpdate:modelValue":l[1]||(l[1]=e=>ne.customerName=e),placeholder:"请输入客户姓名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),g(u,{label:"客户电话"},{default:_(()=>[g(s,{modelValue:ne.customerPhone,"onUpdate:modelValue":l[2]||(l[2]=e=>ne.customerPhone=e),placeholder:"请输入客户电话",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),g(u,{label:"通话状态"},{default:_(()=>[g(c,{modelValue:ne.status,"onUpdate:modelValue":l[3]||(l[3]=e=>ne.status=e),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:_(()=>[g(n,{label:"全部",value:""}),g(n,{label:"已接通",value:"connected"}),g(n,{label:"未接听",value:"missed"}),g(n,{label:"拒接",value:"rejected"}),g(n,{label:"失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),g(u,{label:"呼叫时间"},{default:_(()=>[g(B,{modelValue:ne.dateRange,"onUpdate:modelValue":l[4]||(l[4]=e=>ne.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),g(u,{label:"呼叫人员"},{default:_(()=>[g(c,{modelValue:ne.callerId,"onUpdate:modelValue":l[5]||(l[5]=e=>ne.callerId=e),placeholder:"请选择人员",clearable:"",style:{width:"150px"}},{default:_(()=>[g(n,{label:"全部",value:""}),(f(!0),p(b,null,y(W.value,e=>(f(),C(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),g(u,null,{default:_(()=>[g(d,{type:"primary",onClick:be},{default:_(()=>[g(o,null,{default:_(()=>[g(w(P))]),_:1}),l[22]||(l[22]=h(" 搜索 ",-1))]),_:1}),g(d,{onClick:ye},{default:_(()=>[...l[23]||(l[23]=[h("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),v("div",A,[g(Ne,null,{header:_(()=>[v("div",E,[v("span",null,"呼出记录 (共 "+k(re.value)+" 条)",1),v("div",L,[g(d,{size:"small",disabled:!oe.value.length,onClick:ze},{default:_(()=>[...l[24]||(l[24]=[h(" 批量删除 ",-1)])]),_:1},8,["disabled"]),g(d,{size:"small",disabled:!oe.value.length,onClick:Pe},{default:_(()=>[...l[25]||(l[25]=[h(" 批量导出 ",-1)])]),_:1},8,["disabled"])])])]),default:_(()=>[V((f(),C(Me,{data:te.value,onSelectionChange:Ce,style:{width:"100%"}},{default:_(()=>[g(Ye,{type:"selection",width:"55"}),g(Ye,{prop:"customerName",label:"客户姓名",width:"120"},{default:_(({row:e})=>[g(d,{text:"",onClick:l=>{return a=e.customerId,void K.push(`/customer-management/detail/${a}`);var a}},{default:_(()=>[h(k(e.customerName),1)]),_:2},1032,["onClick"])]),_:1}),g(Ye,{prop:"customerPhone",label:"客户电话",width:"140"},{default:_(({row:e})=>[h(k(w(x)(e.customerPhone,w(a).PHONE)),1)]),_:1}),g(Ye,{prop:"callerName",label:"呼叫人员",width:"100"}),g(Ye,{prop:"startTime",label:"呼叫时间",width:"160"},{default:_(({row:e})=>{return[h(k((l=e.startTime,new Date(l).toLocaleString("zh-CN"))),1)];var l}),_:1}),g(Ye,{prop:"duration",label:"通话时长",width:"100"},{default:_(({row:e})=>[h(k(he(e.duration)),1)]),_:1}),g(Ye,{prop:"status",label:"通话状态",width:"100"},{default:_(({row:e})=>{return[g(De,{type:(l=e.status,{connected:"success",missed:"warning",rejected:"danger",failed:"info"}[l]||"info")},{default:_(()=>[h(k(_e(e.status)),1)]),_:2},1032,["type"])];var l}),_:1}),g(Ye,{prop:"hasRecording",label:"录音",width:"80"},{default:_(({row:e})=>[e.hasRecording?(f(),C(o,{key:0,color:"#67C23A"},{default:_(()=>[g(w(R))]),_:1})):(f(),p("span",Z,"无"))]),_:1}),g(Ye,{prop:"followUpStatus",label:"跟进状态",width:"100"},{default:_(({row:e})=>[e.followUpStatus?(f(),C(De,{key:0,type:"pending"===e.followUpStatus?"warning":"success",size:"small"},{default:_(()=>[h(k("pending"===e.followUpStatus?"待跟进":"已跟进"),1)]),_:2},1032,["type"])):(f(),p("span",G,"无需跟进"))]),_:1}),g(Ye,{prop:"notes",label:"备注","min-width":"150","show-overflow-tooltip":""}),g(Ye,{label:"操作",width:"200",fixed:"right"},{default:_(({row:e})=>[g(d,{text:"",size:"small",onClick:l=>(async e=>{try{await r.makeOutboundCall({customerPhone:e.customerPhone,customerName:e.customerName,notes:`再次呼叫 - 原记录ID: ${e.id}`}),I.success("外呼已发起"),we()}catch(l){console.error("再次呼叫失败:",l),I.error("再次呼叫失败")}})(e)},{default:_(()=>[g(o,null,{default:_(()=>[g(w(U))]),_:1}),l[26]||(l[26]=h(" 再次呼叫 ",-1))]),_:1},8,["onClick"]),g(d,{text:"",size:"small",onClick:l=>{var a;(a=e).hasRecording?K.push(`/service-management/call/recordings?recordId=${a.id}`):I.warning("该通话没有录音")},disabled:!e.hasRecording},{default:_(()=>[g(o,null,{default:_(()=>[g(w(R))]),_:1}),l[27]||(l[27]=h(" 播放录音 ",-1))]),_:1},8,["onClick","disabled"]),g(d,{text:"",size:"small",onClick:l=>{return a=e,ue.value=a,void(se.value=!0);var a}},{default:_(()=>[g(o,null,{default:_(()=>[g(w(N))]),_:1}),l[28]||(l[28]=h(" 添加跟进 ",-1))]),_:1},8,["onClick"]),g(Ie,null,{dropdown:_(()=>[g(Fe,null,{default:_(()=>[g(je,{onClick:l=>{return a=e,void K.push(`/service-management/call/records/${a.id}`);var a}},{default:_(()=>[g(o,null,{default:_(()=>[g(w(D))]),_:1}),l[30]||(l[30]=h(" 查看详情 ",-1))]),_:1},8,["onClick"]),g(je,{onClick:l=>{return a=e,void console.log("编辑记录:",a);var a}},{default:_(()=>[g(o,null,{default:_(()=>[g(w(j))]),_:1}),l[31]||(l[31]=h(" 编辑记录 ",-1))]),_:1},8,["onClick"]),g(je,{onClick:l=>(async e=>{try{await M.confirm("确定要删除这条通话记录吗？","确认删除",{type:"warning"}),await r.deleteCallRecord(e.id),I.success("删除成功"),we()}catch(l){"cancel"!==l&&(console.error("删除记录失败:",l),I.error("删除失败"))}})(e),divided:""},{default:_(()=>[g(o,null,{default:_(()=>[g(w(F))]),_:1}),l[32]||(l[32]=h(" 删除记录 ",-1))]),_:1},8,["onClick"])]),_:2},1024)]),default:_(()=>[g(d,{text:"",size:"small"},{default:_(()=>[l[29]||(l[29]=h(" 更多",-1)),g(o,null,{default:_(()=>[g(w(Y))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Te,X.value]]),v("div",Q,[g(Oe,{"current-page":ce.page,"onUpdate:currentPage":l[6]||(l[6]=e=>ce.page=e),"page-size":ce.size,"onUpdate:pageSize":l[7]||(l[7]=e=>ce.size=e),"page-sizes":[10,20,50,100],total:re.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Ve,onCurrentChange:ke},null,8,["current-page","page-size","total"])])]),_:1})]),g(Se,{modelValue:de.value,"onUpdate:modelValue":l[12]||(l[12]=e=>de.value=e),title:"发起外呼",width:"500px","close-on-click-modal":!1},{footer:_(()=>[g(d,{onClick:l[11]||(l[11]=e=>de.value=!1)},{default:_(()=>[...l[33]||(l[33]=[h("取消",-1)])]),_:1}),g(d,{type:"primary",onClick:xe,loading:le.value},{default:_(()=>[...l[34]||(l[34]=[h(" 开始呼叫 ",-1)])]),_:1},8,["loading"])]),default:_(()=>[g(J,{model:ie,rules:pe,ref_key:"outboundFormRef",ref:me,"label-width":"80px"},{default:_(()=>[g(u,{label:"客户电话",prop:"customerPhone"},{default:_(()=>[g(s,{modelValue:ie.customerPhone,"onUpdate:modelValue":l[8]||(l[8]=e=>ie.customerPhone=e),placeholder:"请输入客户电话号码",maxlength:"11"},null,8,["modelValue"])]),_:1}),g(u,{label:"客户姓名",prop:"customerName"},{default:_(()=>[g(s,{modelValue:ie.customerName,"onUpdate:modelValue":l[9]||(l[9]=e=>ie.customerName=e),placeholder:"请输入客户姓名"},null,8,["modelValue"])]),_:1}),g(u,{label:"呼叫备注"},{default:_(()=>[g(s,{modelValue:ie.notes,"onUpdate:modelValue":l[10]||(l[10]=e=>ie.notes=e),type:"textarea",rows:3,placeholder:"请输入呼叫备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),g(Se,{modelValue:se.value,"onUpdate:modelValue":l[17]||(l[17]=e=>se.value=e),title:"添加跟进记录",width:"600px","close-on-click-modal":!1},{footer:_(()=>[g(d,{onClick:l[16]||(l[16]=e=>se.value=!1)},{default:_(()=>[...l[35]||(l[35]=[h("取消",-1)])]),_:1}),g(d,{type:"primary",onClick:Ue,loading:ae.value},{default:_(()=>[...l[36]||(l[36]=[h(" 保存 ",-1)])]),_:1},8,["loading"])]),default:_(()=>[g(J,{model:fe,rules:ge,ref_key:"followUpFormRef",ref:ve,"label-width":"100px"},{default:_(()=>[g(u,{label:"跟进类型",prop:"type"},{default:_(()=>[g(c,{modelValue:fe.type,"onUpdate:modelValue":l[13]||(l[13]=e=>fe.type=e),placeholder:"请选择跟进类型"},{default:_(()=>[g(n,{label:"电话跟进",value:"phone"}),g(n,{label:"微信跟进",value:"wechat"}),g(n,{label:"邮件跟进",value:"email"}),g(n,{label:"上门拜访",value:"visit"})]),_:1},8,["modelValue"])]),_:1}),g(u,{label:"跟进内容",prop:"content"},{default:_(()=>[g(s,{modelValue:fe.content,"onUpdate:modelValue":l[14]||(l[14]=e=>fe.content=e),type:"textarea",rows:4,placeholder:"请输入跟进内容"},null,8,["modelValue"])]),_:1}),g(u,{label:"下次跟进"},{default:_(()=>[g(B,{modelValue:fe.nextFollowUpTime,"onUpdate:modelValue":l[15]||(l[15]=e=>fe.nextFollowUpTime=e),type:"datetime",placeholder:"选择下次跟进时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-64da87e9"]]);export{B as default};
