import{l as e,_ as a}from"./index-C4IdUW1A.js";import{am as t,t as l,k as s,I as o,G as r,r as n,P as i,d as c,ay as u,F as d,E as p}from"./elementPlus-DxaqjplL.js";import{i as h}from"./utils-DfI7e5Rl.js";import{u as g,p as v}from"./product-DXlSdbN8.js";import{l as m,r as y,e as f,w as b,b as w,ag as S,aq as x,m as C,q as _,p as k,U as P,O as F,S as W,u as A,F as z,a9 as O,M as T,I as V,R as L,T as R,J as D,Q as I,P as j,n as E}from"./vendor-BtukhyiH.js";import"./env-DLalhsF6.js";const U={class:"product-analytics"},$={class:"page-header"},q={class:"header-actions"},G={class:"metrics-grid"},B={class:"metric-content"},J={class:"metric-info"},M={class:"metric-value"},N={class:"metric-label"},Q={class:"charts-section"},X={class:"card-header"},H={class:"card-header"},K={class:"header-actions"},Y={class:"pagination-wrapper"},Z=a(m({__name:"Analytics",setup(a){const m=g(),Z=y(!1),ee=y([new Date(Date.now()-2592e6),new Date]),ae=y("30days"),te=y(""),le=y(""),se=y(1),oe=y(20),re=y(0),ne=y({salesStatistics:{totalRevenue:0,totalSales:0,totalProducts:0,lowStockWarning:0,revenueChange:"+0%",salesChange:"+0%",productsChange:"+0%",warningChange:"+0%"},salesTrend:{timeLabels:[],salesData:[],revenueData:[]},categorySales:[],topProducts:[],inventoryWarning:{lowStockCount:0,outOfStockCount:0,totalWarning:0,categories:[]}}),ie=f(()=>{const e=m.products||[],a=e.length,r=e.reduce((e,a)=>e+(a.salesCount||0),0),n={totalRevenue:e.reduce((e,a)=>e+(a.salesCount||0)*a.price,0),revenueChange:"+0%",totalSales:r,salesChange:"+0%",totalProducts:a,productsChange:"+0%",lowStockCount:e.filter(e=>e.stock<=e.minStock&&e.stock>0).length,stockChange:"+0%"},i=e=>e>=1e8?(e/1e8).toFixed(1)+"亿":e>=1e4?(e/1e4).toFixed(1)+"万":e.toLocaleString();return[{key:"totalRevenue",label:"总销售额",value:`¥${i(n.totalRevenue||0)}`,change:n.revenueChange,trend:n.revenueChange.startsWith("+")?"up":n.revenueChange.startsWith("-")?"down":"stable",color:"#409EFF",icon:t},{key:"totalSales",label:"总销量",value:i(n.totalSales||0),change:n.salesChange,trend:n.salesChange.startsWith("+")?"up":n.salesChange.startsWith("-")?"down":"stable",color:"#67C23A",icon:l},{key:"totalProducts",label:"商品总数",value:(n.totalProducts||0).toString(),change:n.productsChange,trend:n.productsChange.startsWith("+")?"up":n.productsChange.startsWith("-")?"down":"stable",color:"#E6A23C",icon:s},{key:"lowStockWarning",label:"库存预警",value:(n.lowStockCount||0).toString(),change:n.stockChange,trend:n.stockChange.startsWith("+")?"up":n.stockChange.startsWith("-")?"down":"stable",color:"#F56C6C",icon:o}]}),ce=f(()=>(m.categories||[]).map(e=>({label:e.name,value:e.name}))),ue=f(()=>m.products.map(e=>{const a=e.salesCount*e.price,t=e.salesCount*(e.price-e.costPrice),l=e.price>0?(e.price-e.costPrice)/e.price:0;return{id:e.id,name:e.name,category:e.categoryName,price:e.price,stock:e.stock,sales:e.salesCount,revenue:a,profit:t,profitRate:l}})),de=y(),pe=y(),he=y(),ge=y(),ve=f(()=>{let e=ue.value;if(!e||!Array.isArray(e))return re.value=0,[];te.value&&(e=e.filter(e=>e.name.toLowerCase().includes(te.value.toLowerCase()))),le.value&&(e=e.filter(e=>e.category===le.value)),re.value=e.length;const a=(se.value-1)*oe.value,t=a+oe.value;return e.slice(a,t)}),me=e=>{console.log("日期范围变更:",e),e&&2===e.length&&(_e(),E(()=>{ke()}))},ye=async()=>{try{p.info("正在导出数据...");const a=ve.value.map(e=>({"商品名称":e.name,"分类":e.category,"单价":e.price.toFixed(2),"库存":e.stock,"销量":e.sales,"销售额":e.revenue.toFixed(2),"利润":e.profit.toFixed(2),"利润率":(100*e.profitRate).toFixed(1)+"%","状态":Ce(e.stock)}));e(()=>import("./utils-DfI7e5Rl.js").then(e=>e.x),[]).then(e=>{const t=e.utils.book_new(),l=e.utils.json_to_sheet(a);l["!cols"]=[{wch:25},{wch:15},{wch:12},{wch:10},{wch:10},{wch:15},{wch:15},{wch:12},{wch:12}],e.utils.book_append_sheet(t,l,"商品分析数据");const[s,o]=ee.value,r=`商品分析数据_${s.toISOString().split("T")[0]}_${o.toISOString().split("T")[0]}.xlsx`;e.writeFile(t,r),p.success("数据导出成功")}).catch(()=>{p.error("导出失败，请重试")})}catch(a){console.error("导出数据失败:",a),p.error("导出失败")}},fe=async()=>{p.info("正在刷新数据...");try{await m.fetchProducts(),await _e(),E(()=>{Pe()}),p.success("数据刷新成功")}catch(e){console.error("刷新数据失败:",e),p.error("数据刷新失败")}},be=()=>{se.value=1},we=({prop:e,order:a})=>{console.log("排序变更:",e,a)},Se=e=>{oe.value=e,se.value=1},xe=e=>{se.value=e},Ce=e=>e<10?"库存不足":e<50?"库存偏低":"库存充足",_e=async()=>{Z.value=!0;try{const[e,a]=ee.value,t={startDate:e?.toISOString().split("T")[0],endDate:a?.toISOString().split("T")[0]},[l,s,o,r,n]=await Promise.all([v.getSalesStatistics(t),v.getSalesTrend({...t,period:ae.value}),v.getCategorySales(t),v.getTopProducts({limit:5,...t}),v.getInventoryWarning({})]);ne.value={salesStatistics:l,salesTrend:s,categorySales:o,topProducts:r,inventoryWarning:n},p.success("数据已更新")}catch(e){console.error("加载分析数据失败:",e),p.error("加载数据失败")}finally{Z.value=!1}},ke=()=>{Fe(),We(),Ae(),ze()},Pe=()=>{E(()=>{Fe(),We(),Ae(),ze()})},Fe=()=>{const e=h(de.value),a=ne.value?.salesTrend||{timeLabels:[],revenueData:[]},{timeLabels:t,revenueData:l}=a,s={title:{text:`销售趋势 (${"7days"===ae.value?"近7天":"30days"===ae.value?"近30天":"近90天"})`,left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: ¥{c}"},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:t,boundaryGap:!1},yAxis:{type:"value",name:"销售额",axisLabel:{formatter:function(e){return e>=1e4?(e/1e4).toFixed(1)+"万":e}}},series:[{name:"销售额",data:l,type:"line",smooth:!0,itemStyle:{color:"#409EFF"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(64, 158, 255, 0.3)"},{offset:1,color:"rgba(64, 158, 255, 0.1)"}]}}}]};e.setOption(s)},We=()=>{const e=h(pe.value),a={title:{text:"分类销售占比",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: ¥{c} ({d}%)"},series:[{name:"销售额",type:"pie",radius:"60%",data:(ne.value?.categorySales||[]).map(e=>({name:e.name,value:e.value})),emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};e.setOption(a)},Ae=()=>{const e=h(he.value),a=ne.value?.inventoryWarning||{categories:[]},t={title:{text:"库存状况",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} 件"},xAxis:{type:"category",data:a.categories.map(e=>e.name),axisLabel:{rotate:45,interval:0}},yAxis:{type:"value",name:"库存数量"},series:[{name:"库存",data:a.categories.map(e=>e.totalStock),type:"bar",itemStyle:{color:"#67C23A",borderRadius:[4,4,0,0]},emphasis:{itemStyle:{color:"#85ce61"}}}]};e.setOption(t)},ze=()=>{const e=h(ge.value),a=ne.value?.topProducts||[],t={title:{text:"热销商品TOP5",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} 件"},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value",name:"销量"},yAxis:{type:"category",data:a.map(e=>e.name),axisLabel:{width:100,overflow:"truncate"}},series:[{name:"销量",data:a.map(e=>e.sales),type:"bar",itemStyle:{color:"#E6A23C",borderRadius:[0,4,4,0]},emphasis:{itemStyle:{color:"#eebe77"}},label:{show:!0,position:"right",formatter:"{c}"}}]};e.setOption(t)};return b(ae,()=>{_e().then(()=>{E(()=>{Fe()})})}),b(ee,e=>{e&&2===e.length&&_e().then(()=>{E(()=>{ke()})})},{deep:!0}),w(()=>{(async()=>{await _e()})().then(()=>{Pe()})}),(e,a)=>{const t=S("el-date-picker"),l=S("el-button"),s=S("el-icon"),o=S("el-card"),p=S("el-option"),h=S("el-select"),g=S("el-col"),v=S("el-row"),m=S("el-input"),y=S("el-table-column"),f=S("el-tag"),b=S("el-table"),w=S("el-pagination"),E=x("loading");return _(),C("div",U,[k("div",$,[a[8]||(a[8]=k("h1",{class:"page-title"},"商品分析",-1)),k("div",q,[P(t,{modelValue:ee.value,"onUpdate:modelValue":a[0]||(a[0]=e=>ee.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:me,style:{"margin-right":"12px"}},null,8,["modelValue"]),P(l,{type:"primary",icon:A(r),onClick:ye},{default:F(()=>[...a[6]||(a[6]=[W(" 导出数据 ",-1)])]),_:1},8,["icon"]),P(l,{type:"success",icon:A(n),onClick:fe,style:{"margin-left":"12px"}},{default:F(()=>[...a[7]||(a[7]=[W(" 刷新 ",-1)])]),_:1},8,["icon"])])]),k("div",G,[(_(!0),C(z,null,O(ie.value,e=>(_(),T(o,{key:e.key,class:"metric-card",shadow:"hover"},{default:F(()=>[k("div",B,[k("div",{class:"metric-icon",style:V({backgroundColor:e.color})},[P(s,{size:24},{default:F(()=>[(_(),T(L(e.icon)))]),_:2},1024)],4),k("div",J,[k("div",M,R(e.value),1),k("div",N,R(e.label),1),k("div",{class:D(["metric-change",e.trend])},[P(s,{size:12},{default:F(()=>["up"===e.trend?(_(),T(A(i),{key:0})):I("",!0),"down"===e.trend?(_(),T(A(c),{key:1})):I("",!0),"stable"===e.trend?(_(),T(A(u),{key:2})):I("",!0)]),_:2},1024),W(" "+R(e.change),1)],2)])])]),_:2},1024))),128))]),k("div",Q,[P(v,{gutter:20},{default:F(()=>[P(g,{span:12},{default:F(()=>[P(o,{class:"chart-card",shadow:"hover"},{header:F(()=>[k("div",X,[a[9]||(a[9]=k("span",null,"销售趋势",-1)),P(h,{modelValue:ae.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ae.value=e),size:"small",style:{width:"120px"}},{default:F(()=>[P(p,{label:"近7天",value:"7days"}),P(p,{label:"近30天",value:"30days"}),P(p,{label:"近90天",value:"90days"})]),_:1},8,["modelValue"])])]),default:F(()=>[k("div",{ref_key:"salesTrendChart",ref:de,class:"chart-container"},null,512)]),_:1})]),_:1}),P(g,{span:12},{default:F(()=>[P(o,{class:"chart-card",shadow:"hover"},{header:F(()=>[...a[10]||(a[10]=[k("span",null,"商品分类销售占比",-1)])]),default:F(()=>[k("div",{ref_key:"categoryPieChart",ref:pe,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),P(v,{gutter:20,style:{"margin-top":"20px"}},{default:F(()=>[P(g,{span:12},{default:F(()=>[P(o,{class:"chart-card",shadow:"hover"},{header:F(()=>[...a[11]||(a[11]=[k("span",null,"库存预警",-1)])]),default:F(()=>[k("div",{ref_key:"inventoryChart",ref:he,class:"chart-container"},null,512)]),_:1})]),_:1}),P(g,{span:12},{default:F(()=>[P(o,{class:"chart-card",shadow:"hover"},{header:F(()=>[...a[12]||(a[12]=[k("span",null,"热销商品排行",-1)])]),default:F(()=>[k("div",{ref_key:"topProductsChart",ref:ge,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1})]),P(o,{class:"table-card",shadow:"hover",style:{"margin-top":"20px"}},{header:F(()=>[k("div",H,[a[13]||(a[13]=k("span",null,"商品详细数据",-1)),k("div",K,[P(m,{modelValue:te.value,"onUpdate:modelValue":a[2]||(a[2]=e=>te.value=e),placeholder:"搜索商品名称",style:{width:"200px","margin-right":"12px"},clearable:"",onInput:be},{prefix:F(()=>[P(s,null,{default:F(()=>[P(A(d))]),_:1})]),_:1},8,["modelValue"]),P(h,{modelValue:le.value,"onUpdate:modelValue":a[3]||(a[3]=e=>le.value=e),placeholder:"选择分类",style:{width:"150px"},clearable:""},{default:F(()=>[(_(!0),C(z,null,O(ce.value,e=>(_(),T(p,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),default:F(()=>[j((_(),T(b,{data:ve.value,stripe:"",style:{width:"100%"},onSortChange:we},{default:F(()=>[P(y,{prop:"name",label:"商品名称","min-width":"150"}),P(y,{prop:"category",label:"分类",width:"120"}),P(y,{prop:"price",label:"单价",width:"100",sortable:"custom"},{default:F(({row:e})=>[W(" ¥"+R(e.price.toFixed(2)),1)]),_:1}),P(y,{prop:"stock",label:"库存",width:"100",sortable:"custom"},{default:F(({row:e})=>[k("span",{class:D({"low-stock":e.stock<10})},R(e.stock),3)]),_:1}),P(y,{prop:"sales",label:"销量",width:"100",sortable:"custom"}),P(y,{prop:"revenue",label:"销售额",width:"120",sortable:"custom"},{default:F(({row:e})=>[W(" ¥"+R(e.revenue.toFixed(2)),1)]),_:1}),P(y,{prop:"profit",label:"利润",width:"120",sortable:"custom"},{default:F(({row:e})=>[W(" ¥"+R(e.profit.toFixed(2)),1)]),_:1}),P(y,{prop:"profitRate",label:"利润率",width:"100",sortable:"custom"},{default:F(({row:e})=>[W(R((100*e.profitRate).toFixed(1))+"% ",1)]),_:1}),P(y,{label:"状态",width:"100"},{default:F(({row:e})=>{return[P(f,{type:(a=e.stock,a<10?"danger":a<50?"warning":"success")},{default:F(()=>[W(R(Ce(e.stock)),1)]),_:2},1032,["type"])];var a}),_:1})]),_:1},8,["data"])),[[E,Z.value]]),k("div",Y,[P(w,{"current-page":se.value,"onUpdate:currentPage":a[4]||(a[4]=e=>se.value=e),"page-size":oe.value,"onUpdate:pageSize":a[5]||(a[5]=e=>oe.value=e),"page-sizes":[10,20,50,100],total:re.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Se,onCurrentChange:xe},null,8,["current-page","page-size","total"])])]),_:1})])}}}),[["__scopeId","data-v-4880d05c"]]);export{Z as default};
