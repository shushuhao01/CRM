import{a as e,u as l,_ as a}from"./index-BGtT17ll.js";import{l as t,aA as d,r as o,Z as s,e as n,b as i,ag as r,m,q as u,U as p,O as c,p as f,M as b,Q as _,S as w,F as y,a9 as h,T as v}from"./vendor-BtukhyiH.js";import{E as g}from"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";const V={class:"performance-share-settings"},x={class:"card-header"},k={class:"preview-section"},C={class:"stats-section"},T=a(t({__name:"PerformanceShare",setup(a){const t=e(),T=l(),U=d(),D=o("share"),S=s({enabled:!0,allowCopy:!0,allowDownload:!0,watermarkEnabled:!0,watermarkType:"account",watermarkText:""}),F=s({enabled:!0,permissionType:"all",allowedRoles:["super_admin","admin","department_manager","sales"],whitelist:[],allowedFormats:["xlsx"],dailyLimit:0}),O=s({todayCount:0,weekCount:0,monthCount:0}),j=n(()=>T.users||[]),E=n(()=>"super_admin"===T.currentUser?.role),R=()=>{E.value&&I()},I=()=>{E.value?(t.updatePerformanceShareConfig(S),g.success("业绩分享设置已保存并全局生效")):g.warning("仅超级管理员可以修改设置")},L=()=>{E.value?(S.enabled=!0,S.allowCopy=!0,S.allowDownload=!0,S.watermarkEnabled=!0,S.watermarkType="account",S.watermarkText="",I(),g.success("已恢复默认设置")):g.warning("仅超级管理员可以修改设置")},P=()=>{E.value&&J()},J=()=>{if(!E.value)return void g.warning("仅超级管理员可以修改设置");const e={enabled:F.enabled,permissionType:F.permissionType,allowedRoles:F.allowedRoles,whitelist:F.whitelist,allowedFormats:F.allowedFormats,dailyLimit:F.dailyLimit};localStorage.setItem("crm_performance_export_config",JSON.stringify(e)),g.success("导出权限设置已保存并全局生效")},M=()=>{E.value?(F.enabled=!0,F.permissionType="all",F.allowedRoles=["super_admin","admin","department_manager","sales"],F.whitelist=[],F.allowedFormats=["xlsx"],F.dailyLimit=0,J(),g.success("已恢复默认设置")):g.warning("仅超级管理员可以修改设置")},N=()=>{U.push("/performance/personal"),g.info('请在个人业绩页面点击"分享业绩"按钮查看效果')},Y=e=>{const l=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),a=l.getUTCDay()||7;l.setUTCDate(l.getUTCDate()+4-a);const t=new Date(Date.UTC(l.getUTCFullYear(),0,1));return Math.ceil(((l.getTime()-t.getTime())/864e5+1)/7)};return i(()=>{Object.assign(S,t.performanceShareConfig);const e=localStorage.getItem("crm_performance_export_config");if(e)try{const l=JSON.parse(e);Object.assign(F,l)}catch(l){console.error("加载导出配置失败:",l)}(()=>{const e=localStorage.getItem("crm_performance_export_stats");if(e)try{const l=JSON.parse(e),a=(new Date).toISOString().split("T")[0],t=Y(new Date),d=(new Date).toISOString().slice(0,7);O.todayCount=l[a]||0,O.weekCount=Object.keys(l).filter(e=>Y(new Date(e))===t).reduce((e,a)=>e+(l[a]||0),0),O.monthCount=Object.keys(l).filter(e=>e.startsWith(d)).reduce((e,a)=>e+(l[a]||0),0)}catch(l){console.error("加载导出统计失败:",l)}})()}),(e,l)=>{const a=r("el-tag"),t=r("el-switch"),d=r("el-form-item"),o=r("el-radio"),s=r("el-radio-group"),n=r("el-input"),i=r("el-button"),g=r("el-form"),T=r("el-divider"),U=r("el-tab-pane"),Y=r("el-checkbox"),$=r("el-checkbox-group"),q=r("el-option"),A=r("el-select"),B=r("el-input-number"),Q=r("el-descriptions-item"),W=r("el-descriptions"),Z=r("el-tabs"),z=r("el-card");return u(),m("div",V,[p(z,null,{header:c(()=>[f("div",x,[l[14]||(l[14]=f("span",null,"业绩功能设置",-1)),E.value?_("",!0):(u(),b(a,{key:0,type:"warning"},{default:c(()=>[...l[13]||(l[13]=[w("仅超级管理员可修改",-1)])]),_:1}))])]),default:c(()=>[p(Z,{modelValue:D.value,"onUpdate:modelValue":l[12]||(l[12]=e=>D.value=e),type:"border-card"},{default:c(()=>[p(U,{label:"业绩分享设置",name:"share"},{default:c(()=>[p(g,{ref:"shareFormRef",model:S,"label-width":"140px",disabled:!E.value},{default:c(()=>[p(d,{label:"启用业绩分享"},{default:c(()=>[p(t,{modelValue:S.enabled,"onUpdate:modelValue":l[0]||(l[0]=e=>S.enabled=e),"active-text":"启用","inactive-text":"禁用",onChange:R},null,8,["modelValue"]),l[15]||(l[15]=f("div",{class:"form-item-tip"}," 关闭后，所有成员将无法使用业绩分享功能 ",-1))]),_:1}),p(d,{label:"允许复制图片"},{default:c(()=>[p(t,{modelValue:S.allowCopy,"onUpdate:modelValue":l[1]||(l[1]=e=>S.allowCopy=e),"active-text":"允许","inactive-text":"禁止",disabled:!S.enabled,onChange:R},null,8,["modelValue","disabled"]),l[16]||(l[16]=f("div",{class:"form-item-tip"}," 允许成员复制业绩报告图片到剪贴板 ",-1))]),_:1}),p(d,{label:"允许下载图片"},{default:c(()=>[p(t,{modelValue:S.allowDownload,"onUpdate:modelValue":l[2]||(l[2]=e=>S.allowDownload=e),"active-text":"允许","inactive-text":"禁止",disabled:!S.enabled,onChange:R},null,8,["modelValue","disabled"]),l[17]||(l[17]=f("div",{class:"form-item-tip"}," 允许成员下载业绩报告图片到本地 ",-1))]),_:1}),p(d,{label:"显示水印"},{default:c(()=>[p(t,{modelValue:S.watermarkEnabled,"onUpdate:modelValue":l[3]||(l[3]=e=>S.watermarkEnabled=e),"active-text":"显示","inactive-text":"隐藏",disabled:!S.enabled,onChange:R},null,8,["modelValue","disabled"]),l[18]||(l[18]=f("div",{class:"form-item-tip"}," 在业绩报告图片上显示水印，防止未授权传播 ",-1))]),_:1}),S.watermarkEnabled?(u(),b(d,{key:0,label:"水印类型"},{default:c(()=>[p(s,{modelValue:S.watermarkType,"onUpdate:modelValue":l[4]||(l[4]=e=>S.watermarkType=e),disabled:!S.enabled,onChange:R},{default:c(()=>[p(o,{label:"username"},{default:c(()=>[...l[19]||(l[19]=[w("员工姓名",-1)])]),_:1}),p(o,{label:"account"},{default:c(()=>[...l[20]||(l[20]=[w("员工账号",-1)])]),_:1}),p(o,{label:"department"},{default:c(()=>[...l[21]||(l[21]=[w("部门名称",-1)])]),_:1}),p(o,{label:"phone"},{default:c(()=>[...l[22]||(l[22]=[w("手机尾号",-1)])]),_:1}),p(o,{label:"custom"},{default:c(()=>[...l[23]||(l[23]=[w("自定义",-1)])]),_:1})]),_:1},8,["modelValue","disabled"]),l[24]||(l[24]=f("div",{class:"form-item-tip"}," 选择水印显示的内容类型，默认使用员工账号 ",-1))]),_:1})):_("",!0),S.watermarkEnabled&&"custom"===S.watermarkType?(u(),b(d,{key:1,label:"自定义水印"},{default:c(()=>[p(n,{modelValue:S.watermarkText,"onUpdate:modelValue":l[5]||(l[5]=e=>S.watermarkText=e),placeholder:"输入自定义水印文字",disabled:!S.enabled,onBlur:R,style:{width:"400px"}},null,8,["modelValue","disabled"]),l[25]||(l[25]=f("div",{class:"form-item-tip"}," 自定义水印文字，留空则使用系统名称 ",-1))]),_:1})):_("",!0),E.value?(u(),b(d,{key:2},{default:c(()=>[p(i,{type:"primary",onClick:I},{default:c(()=>[...l[26]||(l[26]=[w("保存设置",-1)])]),_:1}),p(i,{onClick:L},{default:c(()=>[...l[27]||(l[27]=[w("恢复默认",-1)])]),_:1})]),_:1})):_("",!0)]),_:1},8,["model","disabled"]),p(T),f("div",k,[l[29]||(l[29]=f("h3",null,"预览效果",-1)),l[30]||(l[30]=f("p",{class:"preview-tip"},"点击下方按钮预览业绩分享效果",-1)),p(i,{type:"primary",onClick:N,disabled:!S.enabled},{default:c(()=>[...l[28]||(l[28]=[w(" 预览业绩分享 ",-1)])]),_:1},8,["disabled"])])]),_:1}),p(U,{label:"导出权限设置",name:"export"},{default:c(()=>[p(g,{ref:"exportFormRef",model:F,"label-width":"140px",disabled:!E.value},{default:c(()=>[p(d,{label:"启用导出功能"},{default:c(()=>[p(t,{modelValue:F.enabled,"onUpdate:modelValue":l[6]||(l[6]=e=>F.enabled=e),"active-text":"启用","inactive-text":"禁用",onChange:P},null,8,["modelValue"]),l[31]||(l[31]=f("div",{class:"form-item-tip"}," 关闭后，所有成员将无法使用业绩导出功能 ",-1))]),_:1}),F.enabled?(u(),b(d,{key:0,label:"权限控制方式"},{default:c(()=>[p(s,{modelValue:F.permissionType,"onUpdate:modelValue":l[7]||(l[7]=e=>F.permissionType=e),onChange:P},{default:c(()=>[p(o,{label:"all"},{default:c(()=>[...l[32]||(l[32]=[w("所有人可用",-1)])]),_:1}),p(o,{label:"role"},{default:c(()=>[...l[33]||(l[33]=[w("按角色控制",-1)])]),_:1}),p(o,{label:"whitelist"},{default:c(()=>[...l[34]||(l[34]=[w("白名单控制",-1)])]),_:1})]),_:1},8,["modelValue"]),l[35]||(l[35]=f("div",{class:"form-item-tip"}," 选择导出功能的权限控制方式 ",-1))]),_:1})):_("",!0),F.enabled&&"role"===F.permissionType?(u(),b(d,{key:1,label:"允许的角色"},{default:c(()=>[p($,{modelValue:F.allowedRoles,"onUpdate:modelValue":l[8]||(l[8]=e=>F.allowedRoles=e),onChange:P},{default:c(()=>[p(Y,{label:"super_admin"},{default:c(()=>[...l[36]||(l[36]=[w("超级管理员",-1)])]),_:1}),p(Y,{label:"admin"},{default:c(()=>[...l[37]||(l[37]=[w("管理员",-1)])]),_:1}),p(Y,{label:"department_manager"},{default:c(()=>[...l[38]||(l[38]=[w("部门经理",-1)])]),_:1}),p(Y,{label:"sales"},{default:c(()=>[...l[39]||(l[39]=[w("销售人员",-1)])]),_:1}),p(Y,{label:"customer_service"},{default:c(()=>[...l[40]||(l[40]=[w("客服人员",-1)])]),_:1})]),_:1},8,["modelValue"]),l[41]||(l[41]=f("div",{class:"form-item-tip"}," 选择允许使用导出功能的角色 ",-1))]),_:1})):_("",!0),F.enabled&&"whitelist"===F.permissionType?(u(),b(d,{key:2,label:"白名单成员"},{default:c(()=>[p(A,{modelValue:F.whitelist,"onUpdate:modelValue":l[9]||(l[9]=e=>F.whitelist=e),multiple:"",filterable:"",placeholder:"选择允许导出的成员",style:{width:"100%","max-width":"600px"},onChange:P},{default:c(()=>[(u(!0),m(y,null,h(j.value,e=>(u(),b(q,{key:e.id,label:`${e.name} (${e.email})`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l[42]||(l[42]=f("div",{class:"form-item-tip"}," 只有白名单中的成员可以使用导出功能，其他人看不到导出按钮 ",-1))]),_:1})):_("",!0),F.enabled?(u(),b(d,{key:3,label:"导出格式"},{default:c(()=>[p($,{modelValue:F.allowedFormats,"onUpdate:modelValue":l[10]||(l[10]=e=>F.allowedFormats=e),onChange:P},{default:c(()=>[p(Y,{label:"xlsx"},{default:c(()=>[...l[43]||(l[43]=[w("Excel格式(.xlsx)",-1)])]),_:1}),p(Y,{label:"csv"},{default:c(()=>[...l[44]||(l[44]=[w("CSV格式(.csv)",-1)])]),_:1}),p(Y,{label:"pdf",disabled:""},{default:c(()=>[...l[45]||(l[45]=[w("PDF格式(.pdf) - 开发中",-1)])]),_:1})]),_:1},8,["modelValue"]),l[46]||(l[46]=f("div",{class:"form-item-tip"}," 选择允许导出的文件格式 ",-1))]),_:1})):_("",!0),F.enabled?(u(),b(d,{key:4,label:"导出限制"},{default:c(()=>[p(B,{modelValue:F.dailyLimit,"onUpdate:modelValue":l[11]||(l[11]=e=>F.dailyLimit=e),min:0,max:100,placeholder:"每日导出次数限制",onChange:P},null,8,["modelValue"]),l[47]||(l[47]=f("span",{style:{"margin-left":"10px"}},"次/天（0表示不限制）",-1)),l[48]||(l[48]=f("div",{class:"form-item-tip"}," 限制每个成员每天的导出次数，防止滥用 ",-1))]),_:1})):_("",!0),E.value?(u(),b(d,{key:5},{default:c(()=>[p(i,{type:"primary",onClick:J},{default:c(()=>[...l[49]||(l[49]=[w("保存设置",-1)])]),_:1}),p(i,{onClick:M},{default:c(()=>[...l[50]||(l[50]=[w("恢复默认",-1)])]),_:1})]),_:1})):_("",!0)]),_:1},8,["model","disabled"]),p(T),f("div",C,[l[51]||(l[51]=f("h3",null,"导出统计",-1)),p(W,{column:3,border:""},{default:c(()=>[p(Q,{label:"今日导出次数"},{default:c(()=>[w(v(O.todayCount),1)]),_:1}),p(Q,{label:"本周导出次数"},{default:c(()=>[w(v(O.weekCount),1)]),_:1}),p(Q,{label:"本月导出次数"},{default:c(()=>[w(v(O.monthCount),1)]),_:1})]),_:1})])]),_:1})]),_:1},8,["modelValue"])]),_:1})])}}}),[["__scopeId","data-v-6f7995ac"]]);export{T as default};
