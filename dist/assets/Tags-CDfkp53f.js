import{C as e,E as a,b as l}from"./elementPlus-DxaqjplL.js";import{l as t,aA as o,r,Z as s,b as u,ag as n,aq as d,m as i,q as c,p,U as m,O as g,S as f,u as v,P as _,M as y,I as b,T as h,Q as w}from"./vendor-BtukhyiH.js";import{d as C}from"./sensitiveInfo-DVfrBLrU.js";import{u as V,i as k,S as z,_ as T}from"./index-DkAJPKqn.js";import{c as U}from"./customerTags-BceXFDEB.js";import"./utils-DfI7e5Rl.js";const x={class:"customer-tags"},F={class:"page-header"},S={class:"header-actions"},j={class:"pagination-container"},P={key:0,class:"dialog-header"},I={class:"customer-count"},q=T(t({__name:"Tags",setup(t){const T=o(),q=V(),E=k(),O=r(!1),A=r(!1),B=r(!1),D=r(!1),H=r(!1),L=r(""),M=r(),N=r(null),Q=s({name:"",status:""}),R=r([]),Z=r([]),$=r([]),G=s({currentPage:1,pageSize:20,total:0}),J=s({id:"",name:"",color:"#409EFF",status:"active",description:"",customerCount:0,createTime:""}),K={name:[{required:!0,message:"请输入标签名称",trigger:"blur"}],color:[{required:!0,message:"请选择标签颜色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},W=async()=>{O.value=!0;try{0===E.customers.length&&await E.loadCustomers();const e={name:Q.name,status:Q.status,page:G.currentPage,pageSize:G.pageSize},l=await U.getList(e);if(l.success){const e=l.data?.list||[];e.forEach(e=>{e.customerCount=se(e.id)}),R.value=e,G.total=l.data?.total||0,console.log("[CustomerTags] 加载标签列表成功:",e.length)}else a.error(l.message||"加载数据失败")}catch(e){console.error("[CustomerTags] 加载标签数据失败:",e),a.error("加载数据失败")}finally{O.value=!1}},X=()=>{G.currentPage=1,W()},Y=()=>{Q.name="",Q.status="",X()},ee=()=>{L.value="新增标签",te(),D.value=!0},ae=async()=>{if(M.value)try{let e;await M.value.validate(),A.value=!0,e=J.id?await U.update(J.id,{name:J.name,color:J.color,status:J.status,description:J.description}):await U.create({name:J.name,color:J.color,status:J.status,description:J.description}),e.success?(a.success(J.id?"更新成功":"创建成功"),D.value=!1,W()):a.error(e.message||"操作失败")}catch(e){console.error("提交标签失败:",e),a.error("操作失败")}finally{A.value=!1}},le=()=>{M.value?.clearValidate(),te()},te=()=>{Object.assign(J,{id:"",name:"",color:"#409EFF",status:"active",description:""})},oe=e=>{Z.value=e},re=e=>{const a=e.replace("#","");return(299*parseInt(a.substr(0,2),16)+587*parseInt(a.substr(2,2),16)+114*parseInt(a.substr(4,2),16))/1e3>128?"#000000":"#FFFFFF"},se=e=>(E.customers||[]).filter(a=>(a.tags||[]).includes(e)).length;return u(()=>{W()}),(t,o)=>{const r=n("el-icon"),s=n("el-button"),u=n("el-input"),V=n("el-form-item"),k=n("el-option"),Z=n("el-select"),te=n("el-form"),se=n("el-card"),ue=n("el-table-column"),ne=n("el-tag"),de=n("el-link"),ie=n("el-table"),ce=n("el-pagination"),pe=n("el-dialog"),me=n("el-color-picker"),ge=n("el-radio"),fe=n("el-radio-group"),ve=d("loading");return c(),i("div",x,[p("div",F,[o[12]||(o[12]=p("h2",null,"客户标签管理",-1)),p("div",S,[m(s,{type:"primary",onClick:ee},{default:g(()=>[m(r,null,{default:g(()=>[m(v(e))]),_:1}),o[11]||(o[11]=f(" 新增标签 ",-1))]),_:1})])]),m(se,{class:"search-card"},{default:g(()=>[m(te,{model:Q,inline:""},{default:g(()=>[m(V,{label:"标签名称"},{default:g(()=>[m(u,{modelValue:Q.name,"onUpdate:modelValue":o[0]||(o[0]=e=>Q.name=e),placeholder:"请输入标签名称",clearable:""},null,8,["modelValue"])]),_:1}),m(V,{label:"状态"},{default:g(()=>[m(Z,{modelValue:Q.status,"onUpdate:modelValue":o[1]||(o[1]=e=>Q.status=e),placeholder:"请选择状态",clearable:""},{default:g(()=>[m(k,{label:"启用",value:"active"}),m(k,{label:"禁用",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),m(V,null,{default:g(()=>[m(s,{type:"primary",onClick:X},{default:g(()=>[...o[13]||(o[13]=[f("搜索",-1)])]),_:1}),m(s,{onClick:Y},{default:g(()=>[...o[14]||(o[14]=[f("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),m(se,{class:"table-card"},{default:g(()=>[_((c(),y(ie,{data:R.value,onSelectionChange:oe},{default:g(()=>[m(ue,{type:"selection",width:"55"}),m(ue,{prop:"name",label:"标签名称"}),m(ue,{prop:"color",label:"标签颜色"},{default:g(({row:e})=>[m(ne,{color:e.color,style:b({color:re(e.color)})},{default:g(()=>[f(h(e.name),1)]),_:2},1032,["color","style"])]),_:1}),m(ue,{prop:"customerCount",label:"关联客户数"},{default:g(({row:e})=>[m(de,{type:"primary",onClick:l=>(async e=>{N.value=e,H.value=!0,B.value=!0;try{const a=(E.customers||[]).filter(a=>(a.tags||[]).includes(e.id));$.value=a,console.log("[CustomerTags] 标签关联客户数量:",a.length)}catch(l){console.error("[CustomerTags] 加载客户数据失败:",l),a.error("加载客户数据失败")}finally{B.value=!1}})(e),underline:!1},{default:g(()=>[f(h(e.customerCount),1)]),_:2},1032,["onClick"])]),_:1}),m(ue,{prop:"status",label:"状态"},{default:g(({row:e})=>[m(ne,{type:"active"===e.status?"success":"danger"},{default:g(()=>[f(h("active"===e.status?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),m(ue,{prop:"createTime",label:"创建时间"}),m(ue,{label:"操作",width:"200"},{default:g(({row:e})=>[m(s,{type:"primary",size:"small",onClick:a=>(e=>{L.value="编辑标签",Object.assign(J,e),D.value=!0})(e)},{default:g(()=>[...o[15]||(o[15]=[f("编辑",-1)])]),_:1},8,["onClick"]),m(s,{type:"danger",size:"small",onClick:t=>(async e=>{try{await l.confirm(`确定要删除标签"${e.name}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await U.delete(e.id);t.success?(a.success("删除成功"),W()):a.error(t.message||"删除失败")}catch(t){"cancel"!==t&&(console.error("删除标签失败:",t),a.error("删除失败"))}})(e)},{default:g(()=>[...o[16]||(o[16]=[f("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ve,O.value]]),p("div",j,[m(ce,{"current-page":G.currentPage,"onUpdate:currentPage":o[2]||(o[2]=e=>G.currentPage=e),"page-size":G.pageSize,"onUpdate:pageSize":o[3]||(o[3]=e=>G.pageSize=e),"page-sizes":[10,20,50,100],total:G.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:W,onCurrentChange:W},null,8,["current-page","page-size","total"])])]),_:1}),m(pe,{modelValue:H.value,"onUpdate:modelValue":o[4]||(o[4]=e=>H.value=e),title:"标签关联客户列表",width:"900px"},{default:g(()=>[N.value?(c(),i("div",P,[m(ne,{color:N.value.color,style:b({color:re(N.value.color)})},{default:g(()=>[f(h(N.value.name),1)]),_:1},8,["color","style"]),p("span",I,"共 "+h($.value.length)+" 个客户",1)])):w("",!0),_((c(),y(ie,{data:$.value,style:{"margin-top":"16px"}},{default:g(()=>[m(ue,{prop:"name",label:"客户姓名",width:"120"},{default:g(({row:e})=>[m(de,{type:"primary",onClick:a=>{return l=e,void T.push({name:"CustomerDetail",params:{id:l.id}});var l},underline:!1},{default:g(()=>[f(h(e.name),1)]),_:2},1032,["onClick"])]),_:1}),m(ue,{prop:"phone",label:"手机号",width:"140"},{default:g(({row:e})=>[f(h(v(C)(e.phone,v(z).PHONE,v(q).currentUser?.id||"")),1)]),_:1}),m(ue,{prop:"level",label:"客户等级",width:"100"},{default:g(({row:e})=>["diamond"===e.level?(c(),y(ne,{key:0,type:"danger"},{default:g(()=>[...o[17]||(o[17]=[f("钻石",-1)])]),_:1})):"gold"===e.level?(c(),y(ne,{key:1,type:"warning"},{default:g(()=>[...o[18]||(o[18]=[f("金牌",-1)])]),_:1})):"silver"===e.level?(c(),y(ne,{key:2,type:"info"},{default:g(()=>[...o[19]||(o[19]=[f("银牌",-1)])]),_:1})):(c(),y(ne,{key:3,type:""},{default:g(()=>[...o[20]||(o[20]=[f("铜牌",-1)])]),_:1}))]),_:1}),m(ue,{prop:"totalAmount",label:"消费金额",width:"120"},{default:g(({row:e})=>[f(" ¥"+h((e.totalAmount||0).toFixed(2)),1)]),_:1}),m(ue,{prop:"source",label:"客户来源",width:"120"}),m(ue,{prop:"createTime",label:"注册时间",width:"160"})]),_:1},8,["data"])),[[ve,B.value]])]),_:1},8,["modelValue"]),m(pe,{modelValue:D.value,"onUpdate:modelValue":o[10]||(o[10]=e=>D.value=e),title:L.value,width:"500px",onClose:le},{footer:g(()=>[m(s,{onClick:o[9]||(o[9]=e=>D.value=!1)},{default:g(()=>[...o[23]||(o[23]=[f("取消",-1)])]),_:1}),m(s,{type:"primary",onClick:ae,loading:A.value},{default:g(()=>[...o[24]||(o[24]=[f(" 确定 ",-1)])]),_:1},8,["loading"])]),default:g(()=>[m(te,{ref_key:"formRef",ref:M,model:J,rules:K,"label-width":"80px"},{default:g(()=>[m(V,{label:"标签名称",prop:"name"},{default:g(()=>[m(u,{modelValue:J.name,"onUpdate:modelValue":o[5]||(o[5]=e=>J.name=e),placeholder:"请输入标签名称"},null,8,["modelValue"])]),_:1}),m(V,{label:"标签颜色",prop:"color"},{default:g(()=>[m(me,{modelValue:J.color,"onUpdate:modelValue":o[6]||(o[6]=e=>J.color=e)},null,8,["modelValue"])]),_:1}),m(V,{label:"状态",prop:"status"},{default:g(()=>[m(fe,{modelValue:J.status,"onUpdate:modelValue":o[7]||(o[7]=e=>J.status=e)},{default:g(()=>[m(ge,{label:"active"},{default:g(()=>[...o[21]||(o[21]=[f("启用",-1)])]),_:1}),m(ge,{label:"inactive"},{default:g(()=>[...o[22]||(o[22]=[f("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),m(V,{label:"描述"},{default:g(()=>[m(u,{modelValue:J.description,"onUpdate:modelValue":o[8]||(o[8]=e=>J.description=e),type:"textarea",rows:3,placeholder:"请输入标签描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-32c764bd"]]);export{q as default};
