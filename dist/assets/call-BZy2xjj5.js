import{aw as e,r as t,e as a}from"./vendor-BtukhyiH.js";import{g as l,v as o}from"./index-DkAJPKqn.js";import{E as r,a as n}from"./elementPlus-DxaqjplL.js";const c=e=>l.get("/api/calls/records",e),s=e=>l.post("/api/calls/outbound",e),u=(e,t)=>l.put(`/api/calls/records/${e}/end`,t),i=e=>l.get("/api/calls/statistics",e),d=e=>l.get("/api/calls/export",e),m="crm_call_records",g="crm_follow_up_records",v=()=>{if(!localStorage.getItem(m)){const e=(()=>{const e=new Date,t=[],a=[{id:"customer_1",name:"张三",phone:"13800138001"},{id:"customer_2",name:"李四",phone:"13800138002"},{id:"customer_3",name:"王五",phone:"13800138003"},{id:"customer_4",name:"赵六",phone:"13800138004"},{id:"customer_5",name:"孙七",phone:"13800138005"}],l=[{id:"admin",name:"管理员",department:"管理部"},{id:"sales1",name:"张销售",department:"销售一部"},{id:"sales2",name:"李销售",department:"销售二部"}];for(let o=0;o<50;o++){const r=Math.floor(7*Math.random()),n=Math.floor(24*Math.random()),c=Math.floor(60*Math.random()),s=new Date(e.getTime()-24*r*60*60*1e3-60*n*60*1e3-60*c*1e3),u=Math.floor(600*Math.random())+30,i=new Date(s.getTime()+1e3*u),d=a[Math.floor(Math.random()*a.length)],m=l[Math.floor(Math.random()*l.length)],g=Math.random()>.5?"outbound":"inbound",v=["connected","missed","busy","failed","rejected"],h=v[Math.floor(Math.random()*v.length)];t.push({id:`call_${Date.now()}_${o}`,customerId:d.id,customerName:d.name,customerPhone:d.phone,callType:g,callStatus:h,startTime:s.toISOString(),endTime:"connected"===h?i.toISOString():void 0,duration:"connected"===h?u:0,recordingUrl:"connected"===h&&Math.random()>.3?`/mock/recordings/call_${o}.mp3`:void 0,notes:"connected"===h?`通话记录${o+1}`:void 0,followUpRequired:Math.random()>.7,userId:m.id,userName:m.name,department:m.department,createdAt:s.toISOString(),updatedAt:s.toISOString()})}return t.sort((e,t)=>new Date(t.startTime).getTime()-new Date(e.startTime).getTime())})();localStorage.setItem(m,JSON.stringify(e)),console.log("[Call API] 初始化Mock通话记录:",e.length,"条")}if(!localStorage.getItem(g)){const e=(()=>{const e=[],t=new Date;for(let a=0;a<20;a++){const l=Math.floor(7*Math.random()),o=new Date(t.getTime()-24*l*60*60*1e3);e.push({id:`followup_${Date.now()}_${a}`,callId:`call_${Date.now()}_${a}`,customerId:"customer_"+(a%5+1),customerName:["张三","李四","王五","赵六","孙七"][a%5],followUpType:["call","visit","email","message"][Math.floor(4*Math.random())],content:`跟进内容${a+1}`,nextFollowUpDate:new Date(t.getTime()+7*Math.random()*24*60*60*1e3).toISOString(),priority:["low","medium","high","urgent"][Math.floor(4*Math.random())],status:["pending","completed","cancelled"][Math.floor(3*Math.random())],userId:["admin","sales1","sales2"][Math.floor(3*Math.random())],userName:["管理员","张销售","李销售"][Math.floor(3*Math.random())],createdAt:o.toISOString(),updatedAt:o.toISOString()})}return e.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())})();localStorage.setItem(g,JSON.stringify(e)),console.log("[Call API] 初始化Mock跟进记录:",e.length,"条")}},h=(e={})=>{v();let t=JSON.parse(localStorage.getItem(m)||"[]");e.customerId&&(t=t.filter(t=>t.customerId===e.customerId)),e.callType&&(t=t.filter(t=>t.callType===e.callType)),e.callStatus&&(t=t.filter(t=>t.callStatus===e.callStatus)),e.userId&&(t=t.filter(t=>t.userId===e.userId)),e.startDate&&(t=t.filter(t=>new Date(t.startTime)>=new Date(e.startDate))),e.endDate&&(t=t.filter(t=>new Date(t.startTime)<=new Date(e.endDate)));const a=e.page||1,l=e.pageSize||20,o=t.length,r=(a-1)*l,n=r+l;return{records:t.slice(r,n),total:o,page:a,pageSize:l}},p=(e={})=>{v();let t=JSON.parse(localStorage.getItem(m)||"[]");e.startDate&&(t=t.filter(t=>new Date(t.startTime)>=new Date(e.startDate))),e.endDate&&(t=t.filter(t=>new Date(t.startTime)<=new Date(e.endDate)));const a=t.length,l=t.filter(e=>"connected"===e.callStatus).length,o=t.filter(e=>"missed"===e.callStatus).length,r=t.reduce((e,t)=>e+t.duration,0),n=a>0?Math.round(r/a):0,c=a>0?Math.round(l/a*100):0,s=new Map;t.forEach(e=>{const t=e.startTime.split("T")[0],a=s.get(t)||{calls:0,duration:0,connected:0};a.calls++,a.duration+=e.duration,"connected"===e.callStatus&&a.connected++,s.set(t,a)});const u=Array.from(s.entries()).map(([e,t])=>({date:e,calls:t.calls,duration:t.duration,connectionRate:t.calls>0?Math.round(t.connected/t.calls*100):0})).sort((e,t)=>e.date.localeCompare(t.date)),i=new Map;t.forEach(e=>{const t=i.get(e.userId)||{userId:e.userId,userName:e.userName,calls:0,duration:0,connected:0};t.calls++,t.duration+=e.duration,"connected"===e.callStatus&&t.connected++,i.set(e.userId,t)});return{totalCalls:a,totalDuration:r,averageDuration:n,connectedCalls:l,missedCalls:o,connectionRate:c,dailyStats:u,userStats:Array.from(i.values()).map(e=>({userId:e.userId,userName:e.userName,calls:e.calls,duration:e.duration,connectionRate:e.calls>0?Math.round(e.connected/e.calls*100):0})),incomingCalls:t.filter(e=>"inbound"===e.callType).length,outgoingCalls:t.filter(e=>"outbound"===e.callType).length,todayIncrease:Math.floor(20*Math.random())+5}},S=c,f=async e=>o()?(console.log("[Call API] 使用Mock数据 - getCallRecords"),Promise.resolve({data:h(e)})):S(e),w=i,I=async e=>o()?(console.log("[Call API] 使用Mock数据 - getCallStatistics"),Promise.resolve({data:p(e)})):w(e),y=s,D=async e=>{if(o()){console.log("[Call API] 使用Mock数据 - makeOutboundCall",e);const t=JSON.parse(localStorage.getItem(m)||"[]"),a=JSON.parse(localStorage.getItem("currentUser")||'{"id":"admin","name":"管理员"}'),l={id:`call_${Date.now()}`,customerId:e.customerId,customerName:"客户",customerPhone:e.customerPhone,callType:"outbound",callStatus:"connected",startTime:(new Date).toISOString(),endTime:void 0,duration:0,recordingUrl:void 0,notes:e.notes,followUpRequired:!1,userId:a.id,userName:a.name,department:a.department||"未知部门",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};return t.unshift(l),localStorage.setItem(m,JSON.stringify(t)),Promise.resolve({data:{callId:l.id,status:"calling",message:"正在呼叫..."}})}return y(e)};"undefined"!=typeof window&&v();const M=e("call",()=>{const e=t([]),d=t([]),m=t(null),g=t(null),v=t(null),h=t(!1),p=t(null),S=t([]),w=t("idle"),y=t(0),M=t(!1),T=t(!1),C=t(null),O=t(null),N=t(null),_=t(!1),P=t({current:1,pageSize:20,total:0}),$=t({current:1,pageSize:20,total:0}),A=a(()=>{const t=(new Date).toDateString();return e.value.filter(e=>new Date(e.createdAt).toDateString()===t).length}),R=a(()=>{const t=(new Date).toDateString();return e.value.filter(e=>new Date(e.createdAt).toDateString()===t).reduce((e,t)=>e+t.duration,0)}),U=a(()=>{if(0===e.value.length)return 0;const t=e.value.filter(e=>"connected"===e.callStatus).length;return Math.round(t/e.value.length*100)}),z=a(()=>d.value.filter(e=>"pending"===e.status)),J=a(()=>d.value.filter(e=>"pending"===e.status&&"urgent"===e.priority)),b=async t=>{try{const a=o()?f:c,l=await a({page:P.value.current,pageSize:P.value.pageSize,...t});return e.value=l.data.records,P.value={current:l.data.page,pageSize:l.data.pageSize,total:l.data.total},l.data}catch(a){if(console.error("获取通话记录失败:",a),o()){console.log("[Call Store] API失败,使用Mock数据");const a=await f({page:P.value.current,pageSize:P.value.pageSize,...t});return e.value=a.data.records,P.value={current:a.data.page,pageSize:a.data.pageSize,total:a.data.total},a.data}throw r.error("获取通话记录失败"),a}},k=()=>{C.value&&clearInterval(C.value),C.value=window.setInterval(()=>{y.value++},1e3)},x=()=>{C.value&&(clearInterval(C.value),C.value=null)},j=async e=>{try{const t=o()?I:i,a=await t(e);return v.value=a.data,a.data}catch(t){if(console.error("获取通话统计失败:",t),o()){console.log("[Call Store] API失败,使用Mock统计数据");const t=await I(e);return v.value=t.data,t.data}throw r.error("获取通话统计失败"),t}};return{callRecords:e,followUpRecords:d,currentCall:m,phoneConfig:g,callStatistics:v,isCallActive:h,callStartTime:p,recordings:S,pagination:P,followUpPagination:$,callState:w,callDuration:y,isMuted:M,isRecording:T,currentCallCustomer:O,incomingCall:N,isIncomingCallActive:_,todayCallCount:A,todayCallDuration:R,connectionRate:U,pendingFollowUps:z,urgentFollowUps:J,fetchCallRecords:b,fetchFollowUpRecords:async e=>{try{const t=await(e=>l.get("/api/calls/followups",e))({page:$.value.current,pageSize:$.value.pageSize,...e});return d.value=t.data.records,$.value={current:t.data.page,pageSize:t.data.pageSize,total:t.data.total},t.data}catch(t){throw console.error("获取跟进记录失败:",t),r.error("获取跟进记录失败"),t}},makeOutboundCall:async e=>{try{const t=o()?D:s,a=await t(e);return h.value=!0,p.value=new Date,w.value="dialing",y.value=0,M.value=!1,T.value=!0,O.value={id:e.customerId,name:e.customerName||"未知客户",phone:e.customerPhone},m.value=a.data,o()?(setTimeout(()=>{"dialing"===w.value&&(w.value="ringing")},2e3),setTimeout(()=>{"ringing"===w.value&&(w.value="connected",k())},4e3)):(w.value="connected",k()),n({title:"外呼成功",message:`正在呼叫 ${e.customerPhone}`,type:"success"}),a.data}catch(t){console.error("外呼失败:",t),w.value="idle"}},endCall:async(t,a=!1)=>{if(m.value&&p.value)try{const l=new Date,o=Math.floor((l.getTime()-p.value.getTime())/1e3),r=await u(m.value.id,{endTime:l.toISOString(),duration:o,notes:t,followUpRequired:a}),c=e.value.findIndex(e=>e.id===m.value.id);return-1!==c?e.value[c]=r.data:e.value.unshift(r.data),h.value=!1,p.value=null,m.value=null,n({title:"通话结束",message:`通话时长: ${Math.floor(o/60)}分${o%60}秒`,type:"info"}),r.data}catch(l){throw console.error("结束通话失败:",l),r.error("结束通话失败"),l}else r.warning("没有正在进行的通话")},createFollowUp:async e=>{try{const t=await(e=>l.post("/api/calls/followups",e))(e);return d.value.unshift(t.data),r.success("跟进记录创建成功"),t.data}catch(t){throw console.error("创建跟进记录失败:",t),r.error("创建跟进记录失败"),t}},updateFollowUp:async(e,t)=>{try{const a=await((e,t)=>l.put(`/api/calls/followups/${e}`,t))(e,t),o=d.value.findIndex(t=>t.id===e);return-1!==o&&(d.value[o]=a.data),r.success("跟进记录更新成功"),a.data}catch(a){throw console.error("更新跟进记录失败:",a),r.error("更新跟进记录失败"),a}},fetchCallStatistics:j,getStatistics:async()=>{try{return await j(),{todayCalls:A.value,totalDuration:R.value,connectionRate:U.value,activeUsers:5}}catch(e){return console.error("获取统计数据失败:",e),{todayCalls:0,totalDuration:0,connectionRate:0,activeUsers:0}}},fetchRecordings:async e=>{try{const t=await(e=>l.get("/api/calls/recordings",e))(e);return S.value=t.data.recordings,t.data}catch(t){throw console.error("获取录音列表失败:",t),r.error("获取录音列表失败"),t}},fetchPhoneConfig:async e=>{try{const t=await(e=>l.get("/api/calls/config",e?{userId:e}:void 0))(e);return g.value=t.data,t.data}catch(t){throw console.error("获取电话配置失败:",t),r.error("获取电话配置失败"),t}},updatePhoneConfig:async e=>{try{const t=await(e=>l.put("/api/calls/config",e))(e);return g.value=t.data,r.success("电话配置更新成功"),t.data}catch(t){throw console.error("更新电话配置失败:",t),r.error("更新电话配置失败"),t}},testConnection:async()=>{try{const e=await l.post("/api/calls/test-connection");return e.data.success?r.success(`连接测试成功，延迟: ${e.data.latency}ms`):r.error(`连接测试失败: ${e.data.message}`),e.data}catch(e){throw console.error("连接测试失败:",e),r.error("连接测试失败"),e}},fetchCustomerCallHistory:async(e,t)=>{try{const a=await((e,t)=>l.get(`/api/customers/${e}/calls`,t))(e,t);return a.data}catch(a){throw console.error("获取客户通话历史失败:",a),r.error("获取客户通话历史失败"),a}},saveCallRecord:async t=>{try{const o=await(a=t,l.post("/api/calls/records",a));return e.value.unshift(o.data),r.success("通话记录保存成功"),o.data}catch(o){throw console.error("保存通话记录失败:",o),r.error("保存通话记录失败"),o}var a},resetState:()=>{x(),e.value=[],d.value=[],m.value=null,g.value=null,v.value=null,h.value=!1,p.value=null,S.value=[],P.value={current:1,pageSize:20,total:0},$.value={current:1,pageSize:20,total:0},w.value="idle",y.value=0,M.value=!1,T.value=!1,O.value=null,N.value=null,_.value=!1},startCallTimer:k,stopCallTimer:x,toggleMute:()=>{M.value=!M.value,r.success(M.value?"已静音":"已取消静音")},toggleRecording:()=>{T.value=!T.value,r.success(T.value?"录音已开启":"录音已关闭")},hangUp:async t=>{if(m.value&&p.value)try{x();const a=new Date,l=y.value;if(o()){const o={...m.value,endTime:a.toISOString(),duration:l,notes:t||"",callStatus:l>0?"connected":"missed",hasRecording:T.value},r=JSON.parse(localStorage.getItem("crm_call_records")||"[]"),n=r.findIndex(e=>e.id===o.id);-1!==n?r[n]=o:r.unshift(o),localStorage.setItem("crm_call_records",JSON.stringify(r));const c=e.value.findIndex(e=>e.id===o.id);-1!==c?e.value[c]=o:e.value.unshift(o)}else{const o=await u(m.value.id,{endTime:a.toISOString(),duration:l,notes:t,followUpRequired:!1}),r=e.value.findIndex(e=>e.id===m.value.id);-1!==r?e.value[r]=o.data:e.value.unshift(o.data)}w.value="ended",setTimeout(()=>{w.value="idle",h.value=!1,p.value=null,m.value=null,O.value=null,y.value=0,M.value=!1,T.value=!1},1e3),n({title:"通话结束",message:`通话时长: ${Math.floor(l/60)}分${l%60}秒`,type:"info"}),await b()}catch(a){throw console.error("挂断通话失败:",a),r.error("挂断通话失败"),a}else r.warning("没有正在进行的通话")},receiveIncomingCall:e=>{N.value={id:e.id,customerName:e.customerName,customerPhone:e.customerPhone,callTime:(new Date).toISOString()},_.value=!0,n({title:"来电提醒",message:`${e.customerName} (${e.customerPhone})`,type:"info",duration:0})},acceptIncomingCall:async()=>{if(N.value)try{h.value=!0,p.value=new Date,w.value="connected",y.value=0,M.value=!1,T.value=!0,O.value={id:N.value.id,name:N.value.customerName,phone:N.value.customerPhone};const e={id:`call-${Date.now()}`,customerId:N.value.id,customerName:N.value.customerName,customerPhone:N.value.customerPhone,callType:"inbound",callStatus:"connected",startTime:(new Date).toISOString(),duration:0,createdAt:(new Date).toISOString()};m.value=e,k(),N.value=null,_.value=!1,r.success("已接听来电")}catch(e){throw console.error("接听来电失败:",e),r.error("接听来电失败"),e}else r.warning("没有来电")},rejectIncomingCall:async()=>{if(N.value)try{if(o()){const t={id:`call-${Date.now()}`,customerId:N.value.id,customerName:N.value.customerName,customerPhone:N.value.customerPhone,callType:"inbound",callStatus:"rejected",startTime:N.value.callTime,endTime:(new Date).toISOString(),duration:0,notes:"用户拒接",createdAt:(new Date).toISOString()},a=JSON.parse(localStorage.getItem("crm_call_records")||"[]");a.unshift(t),localStorage.setItem("crm_call_records",JSON.stringify(a)),e.value.unshift(t)}N.value=null,_.value=!1,r.info("已拒接来电"),await b()}catch(t){throw console.error("拒接来电失败:",t),r.error("拒接来电失败"),t}else r.warning("没有来电")},missIncomingCall:async()=>{if(N.value)try{if(o()){const t={id:`call-${Date.now()}`,customerId:N.value.id,customerName:N.value.customerName,customerPhone:N.value.customerPhone,callType:"inbound",callStatus:"missed",startTime:N.value.callTime,endTime:(new Date).toISOString(),duration:0,notes:"未接听",createdAt:(new Date).toISOString()},a=JSON.parse(localStorage.getItem("crm_call_records")||"[]");a.unshift(t),localStorage.setItem("crm_call_records",JSON.stringify(a)),e.value.unshift(t)}N.value=null,_.value=!1,n({title:"未接来电",message:"您有一个未接来电",type:"warning"}),await b()}catch(t){console.error("处理未接来电失败:",t)}}}});export{d as e,i as g,M as u};
