var Xe=Object.defineProperty,et=Object.defineProperties;var tt=Object.getOwnPropertyDescriptors;var Ee=Object.getOwnPropertySymbols;var lt=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable;var Re=(S,c,r)=>c in S?Xe(S,c,{enumerable:!0,configurable:!0,writable:!0,value:r}):S[c]=r,we=(S,c)=>{for(var r in c||(c={}))lt.call(c,r)&&Re(S,r,c[r]);if(Ee)for(var r of Ee(c))at.call(c,r)&&Re(S,r,c[r]);return S},Ue=(S,c)=>et(S,tt(c));var oe=(S,c,r)=>new Promise((k,$)=>{var u=v=>{try{h(r.next(v))}catch(f){$(f)}},b=v=>{try{h(r.throw(v))}catch(f){$(f)}},h=v=>v.done?k(v.value):Promise.resolve(v.value).then(u,b);h((r=r.apply(S,c)).next())});import{u as ot,H as ve,_ as me,I as ce}from"./settings-CuxbDWOu.js";import{E as O,b as Fe,ad as nt,F as st,r as Oe,v as rt,T as it,a6 as dt,ax as ut,c as ct,e as pt,ai as mt,ay as _t,s as ft}from"./elementPlus-Bmwh7Rh8.js";import{l as _e,e as ne,c as Le,ag as s,m as L,p as m,H as vt,U as e,O as t,S as _,r as T,Z as pe,w as fe,M as F,Q as W,q as o,T as g,F as se,a9 as re,J as gt,u as Y,Y as je,P as Ae,V as yt,aq as bt}from"./vendor-D8Vxqhr-.js";import{O as ht}from"./OrderDetailDialog-54R0Lf8m.js";import"./utils-ywHRn0uI.js";import"./phone-DsAzMHsn.js";const wt={key:0},St={key:1,class:"no-permission"},kt=_e({__name:"LogisticsStatusPermission",setup(S){const c=ot(),r=ve(),k=ne(()=>{var $,u,b,h;return!!(c.isSuperAdmin||c.isWhitelistMember||c.permissions.includes("logistics:status_update")||(($=c.currentUser)==null?void 0:$.role)==="manager"||((u=c.currentUser)==null?void 0:u.role)==="department_head"||((b=c.currentUser)==null?void 0:b.department)==="logistics"&&((h=c.currentUser)==null?void 0:h.position)==="supervisor")});return Le(()=>oe(this,null,function*(){try{yield r.fetchUserPermission(),k.value||O.warning("您没有访问此功能的权限")}catch($){console.error("获取用户权限失败:",$),O.error("权限验证失败，请重新登录")}})),($,u)=>{const b=s("el-button"),h=s("el-result");return k.value?(m(),L("div",wt,[vt($.$slots,"default",{},void 0,!0)])):(m(),L("div",St,[e(h,{icon:"warning",title:"权限不足","sub-title":"您没有访问物流状态更新功能的权限，请联系管理员"},{extra:t(()=>[e(b,{onClick:u[0]||(u[0]=v=>$.$router.go(-1))},{default:t(()=>[...u[1]||(u[1]=[_("返回上一页",-1)])]),_:1})]),_:1})]))}}}),Vt=me(kt,[["__scopeId","data-v-1b6b174c"]]),Ct={key:0,class:"order-info"},$t={key:1,class:"batch-info"},Tt={class:"order-list"},xt={style:{float:"left"}},Dt={style:{float:"right",color:"var(--el-text-color-secondary)"}},Ut={class:"dialog-footer"},Ot=_e({__name:"StatusUpdateDialog",props:{modelValue:{type:Boolean},orderInfo:{},selectedOrders:{default:()=>[]}},emits:["update:modelValue","success"],setup(S,{emit:c}){const r=S,k=c,$=ve(),u=T(),b=T(!1),h=ne({get:()=>r.modelValue,set:l=>k("update:modelValue",l)}),v=ne(()=>r.selectedOrders.length>0),f=pe({newStatus:"",remark:""}),z=[{value:"delivered",label:"已签收",description:"客户已确认收货"},{value:"rejected",label:"拒收",description:"客户拒绝接收包裹"},{value:"returned",label:"拒收已退回",description:"拒收包裹已退回发货地"},{value:"refunded",label:"退货退款",description:"已处理退货退款"},{value:"abnormal",label:"状态异常",description:"物流状态异常，需要人工处理"}],D={newStatus:[{required:!0,message:"请选择新状态",trigger:"change"}]},j=l=>$.getStatusText(l||""),E=l=>$.getStatusType(l||""),H=l=>{const n=z.find(C=>C.value===l);return(n==null?void 0:n.description)||""},R=()=>oe(this,null,function*(){var l;if(u.value)try{yield u.value.validate();const n=v.value?`确定要将选中的 ${r.selectedOrders.length} 个订单状态更新为"${j(f.newStatus)}"吗？`:`确定要将订单"${(l=r.orderInfo)==null?void 0:l.orderNo}"的状态更新为"${j(f.newStatus)}"吗？`;yield Fe.confirm(n,"确认更新",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),b.value=!0;let C=[];if(v.value){const w=r.selectedOrders.map(P=>P.orderNo);yield $.batchUpdateOrderStatus(w,f.newStatus,f.remark||void 0),O.success(`成功更新 ${w.length} 个订单状态`),C=r.selectedOrders.map(P=>Ue(we({},P),{status:f.newStatus}))}else r.orderInfo&&(yield $.updateOrderStatus(r.orderInfo.orderNo,f.newStatus,f.remark||void 0),O.success("订单状态更新成功"),C=[Ue(we({},r.orderInfo),{status:f.newStatus})]);k("success",{orders:C,newStatus:f.newStatus}),V()}catch(n){n!=="cancel"&&(console.error("更新订单状态失败:",n),O.error("更新失败，请重试"))}finally{b.value=!1}}),V=()=>{h.value=!1,d()},d=()=>{var l;f.newStatus="",f.remark="",(l=u.value)==null||l.clearValidate()};return fe(h,l=>{l&&d()}),(l,n)=>{const C=s("el-tag"),w=s("el-scrollbar"),P=s("el-form-item"),M=s("el-option"),J=s("el-select"),Z=s("el-input"),G=s("el-alert"),X=s("el-form"),N=s("el-button"),I=s("el-dialog");return m(),F(I,{modelValue:h.value,"onUpdate:modelValue":n[2]||(n[2]=x=>h.value=x),title:v.value?"批量更新状态":"更新订单状态",width:"500px",onClose:V},{footer:t(()=>[o("div",Ut,[e(N,{onClick:V},{default:t(()=>[...n[7]||(n[7]=[_("取消",-1)])]),_:1}),e(N,{type:"primary",loading:b.value,onClick:R},{default:t(()=>[_(g(v.value?"批量更新":"更新状态"),1)]),_:1},8,["loading"])])]),default:t(()=>[e(X,{ref_key:"formRef",ref:u,model:f,rules:D,"label-width":"100px"},{default:t(()=>[e(P,{label:"订单信息"},{default:t(()=>{var x,le,ie;return[v.value?(m(),L("div",$t,[o("p",null,[n[6]||(n[6]=o("strong",null,"选中订单：",-1)),_(g(S.selectedOrders.length)+" 个",1)]),e(w,{"max-height":"100px"},{default:t(()=>[o("div",Tt,[(m(!0),L(se,null,re(S.selectedOrders,ee=>(m(),L("div",{key:ee.orderNo,class:"order-item"},g(ee.orderNo)+" - "+g(ee.customerName),1))),128))])]),_:1})])):(m(),L("div",Ct,[o("p",null,[n[3]||(n[3]=o("strong",null,"订单号：",-1)),_(g((x=S.orderInfo)==null?void 0:x.orderNo),1)]),o("p",null,[n[4]||(n[4]=o("strong",null,"客户：",-1)),_(g((le=S.orderInfo)==null?void 0:le.customerName),1)]),o("p",null,[n[5]||(n[5]=o("strong",null,"当前状态：",-1)),e(C,{type:E((ie=S.orderInfo)==null?void 0:ie.status)},{default:t(()=>{var ee;return[_(g(j((ee=S.orderInfo)==null?void 0:ee.status)),1)]}),_:1},8,["type"])])]))]}),_:1}),e(P,{label:"新状态",prop:"newStatus"},{default:t(()=>[e(J,{modelValue:f.newStatus,"onUpdate:modelValue":n[0]||(n[0]=x=>f.newStatus=x),placeholder:"请选择新状态",style:{width:"100%"}},{default:t(()=>[(m(),L(se,null,re(z,x=>e(M,{key:x.value,label:x.label,value:x.value},{default:t(()=>[o("span",xt,g(x.label),1),o("span",Dt,g(x.description),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),e(P,{label:"备注",prop:"remark"},{default:t(()=>[e(Z,{modelValue:f.remark,"onUpdate:modelValue":n[1]||(n[1]=x=>f.remark=x),type:"textarea",rows:3,placeholder:"请输入更新备注（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),f.newStatus?(m(),F(P,{key:0,label:"状态说明"},{default:t(()=>[e(G,{title:H(f.newStatus),type:"info",closable:!1,"show-icon":""},null,8,["title"])]),_:1})):W("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}}),Lt=me(Ot,[["__scopeId","data-v-cf422b3c"]]),Nt={class:"order-info"},It={style:{float:"left"}},zt={style:{float:"right",color:"var(--el-text-color-secondary)"}},Pt={class:"dialog-footer"},Mt=_e({__name:"TodoDialog",props:{modelValue:{type:Boolean},orderInfo:{}},emits:["update:modelValue","success"],setup(S,{emit:c}){const r=S,k=c,$=ve(),u=T(),b=T(!1),h=ne({get:()=>r.modelValue,set:d=>k("update:modelValue",d)}),v=pe({days:null,remark:""}),f=[{value:1,label:"1天后处理",description:"明天处理"},{value:2,label:"2天后处理",description:"后天处理"},{value:3,label:"3天后处理",description:"3天后处理"},{value:5,label:"5天后处理",description:"工作日处理"},{value:7,label:"7天后处理",description:"一周后处理"},{value:10,label:"10天后处理",description:"10天后处理"}],z={days:[{required:!0,message:"请选择处理时间",trigger:"change"}]},D=d=>$.getStatusText(d||""),j=d=>$.getStatusType(d||""),E=()=>{if(!v.days)return"";const d=new Date,l=new Date(d.getTime()+v.days*24*60*60*1e3),n=l.getFullYear(),C=String(l.getMonth()+1).padStart(2,"0"),w=String(l.getDate()).padStart(2,"0"),M=["周日","周一","周二","周三","周四","周五","周六"][l.getDay()];return`${n}-${C}-${w} (${M})`},H=()=>oe(this,null,function*(){if(!(!u.value||!r.orderInfo))try{yield u.value.validate();const d=`确定要将订单"${r.orderInfo.orderNo}"设置为${v.days}天后处理吗？`;yield Fe.confirm(d,"确认设置",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),b.value=!0,yield $.setTodoOrder(r.orderInfo.orderNo,v.days,v.remark||void 0),O.success("待办设置成功"),k("success"),R()}catch(d){d!=="cancel"&&(console.error("设置待办失败:",d),O.error("设置失败，请重试"))}finally{b.value=!1}}),R=()=>{h.value=!1,V()},V=()=>{var d;v.days=null,v.remark="",(d=u.value)==null||d.clearValidate()};return fe(h,d=>{d&&V()}),(d,l)=>{const n=s("el-tag"),C=s("el-form-item"),w=s("el-option"),P=s("el-select"),M=s("el-alert"),J=s("el-input"),Z=s("el-form"),G=s("el-button"),X=s("el-dialog");return m(),F(X,{modelValue:h.value,"onUpdate:modelValue":l[2]||(l[2]=N=>h.value=N),title:"设置待办",width:"450px",onClose:R},{footer:t(()=>[o("div",Pt,[e(G,{onClick:R},{default:t(()=>[...l[6]||(l[6]=[_("取消",-1)])]),_:1}),e(G,{type:"primary",loading:b.value,onClick:H},{default:t(()=>[...l[7]||(l[7]=[_(" 设置待办 ",-1)])]),_:1},8,["loading"])])]),default:t(()=>[e(Z,{ref_key:"formRef",ref:u,model:v,rules:z,"label-width":"80px"},{default:t(()=>[e(C,{label:"订单信息"},{default:t(()=>{var N,I,x;return[o("div",Nt,[o("p",null,[l[3]||(l[3]=o("strong",null,"订单号：",-1)),_(g((N=S.orderInfo)==null?void 0:N.orderNo),1)]),o("p",null,[l[4]||(l[4]=o("strong",null,"客户：",-1)),_(g((I=S.orderInfo)==null?void 0:I.customerName),1)]),o("p",null,[l[5]||(l[5]=o("strong",null,"当前状态：",-1)),e(n,{type:j((x=S.orderInfo)==null?void 0:x.status)},{default:t(()=>{var le;return[_(g(D((le=S.orderInfo)==null?void 0:le.status)),1)]}),_:1},8,["type"])])])]}),_:1}),e(C,{label:"处理时间",prop:"days"},{default:t(()=>[e(P,{modelValue:v.days,"onUpdate:modelValue":l[0]||(l[0]=N=>v.days=N),placeholder:"请选择处理时间",style:{width:"100%"}},{default:t(()=>[(m(),L(se,null,re(f,N=>e(w,{key:N.value,label:N.label,value:N.value},{default:t(()=>[o("span",It,g(N.label),1),o("span",zt,g(N.description),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),v.days?(m(),F(C,{key:0,label:"预计时间"},{default:t(()=>[e(M,{title:E(),type:"info",closable:!1,"show-icon":""},null,8,["title"])]),_:1})):W("",!0),e(C,{label:"备注",prop:"remark"},{default:t(()=>[e(J,{modelValue:v.remark,"onUpdate:modelValue":l[1]||(l[1]=N=>v.remark=N),type:"textarea",rows:3,placeholder:"请输入待办备注（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),e(C,null,{default:t(()=>[e(M,{title:"设置待办后，订单将在指定时间后重新显示在'待更新'列表中，并在'待办'导航栏中显示",type:"warning",closable:!1,"show-icon":""})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),Et=me(Mt,[["__scopeId","data-v-244d9c8f"]]),Rt={class:"tracking-header"},Ft={class:"tracking-info"},jt={class:"tracking-content"},At={key:0,class:"loading-container"},Bt={key:1,class:"empty-container"},Yt={key:2,class:"timeline-container"},qt={class:"timeline-content"},Jt={class:"timeline-description"},Qt={key:0,class:"timeline-location"},Ht={key:1,class:"timeline-operator"},Kt={class:"dialog-footer"},Wt=_e({__name:"TrackingDialog",props:{modelValue:{type:Boolean},trackingNo:{},logisticsCompany:{}},emits:["update:modelValue"],setup(S,{emit:c}){const r=S,k=c,$=ve(),u=T(!1),b=T([]),h=ne({get:()=>r.modelValue,set:V=>k("update:modelValue",V)}),v=ne(()=>{if(b.value.length===0)return"";const d=b.value[0].description.toLowerCase();return d.includes("签收")||d.includes("已收货")?"delivered":d.includes("拒收")||d.includes("拒绝")?"rejected":d.includes("派送")||d.includes("配送")?"delivering":d.includes("运输")||d.includes("转运")?"shipping":d.includes("揽收")||d.includes("收件")?"picked":"unknown"}),f=ne(()=>b.value.length===0?"":b.value[0].time),z=V=>({delivered:"已签收",rejected:"拒收",delivering:"派送中",shipping:"运输中",picked:"已揽收",unknown:"未知状态"})[V]||V,D=V=>({delivered:"success",rejected:"danger",delivering:"warning",shipping:"info",picked:"primary",unknown:"info"})[V]||"info",j=(V,d)=>{if(d===0){const l=V.description.toLowerCase();return l.includes("签收")?"success":l.includes("拒收")?"danger":l.includes("派送")?"warning":"primary"}return"info"},E=()=>oe(this,null,function*(){if(r.trackingNo){u.value=!0;try{const V=yield $.fetchTrackingInfo(r.trackingNo);b.value=V}catch(V){console.error("获取物流轨迹失败:",V),O.error("获取物流轨迹失败，请重试"),b.value=[]}finally{u.value=!1}}}),H=()=>{E()},R=()=>{h.value=!1};return fe(h,V=>{V&&r.trackingNo&&E()}),fe(()=>r.trackingNo,V=>{V&&h.value&&E()}),(V,d)=>{const l=s("el-tag"),n=s("el-descriptions-item"),C=s("el-descriptions"),w=s("el-skeleton"),P=s("el-empty"),M=s("el-icon"),J=s("el-card"),Z=s("el-timeline-item"),G=s("el-timeline"),X=s("el-button"),N=s("el-dialog");return m(),F(N,{modelValue:h.value,"onUpdate:modelValue":d[0]||(d[0]=I=>h.value=I),title:"物流轨迹",width:"600px",onClose:R},{footer:t(()=>[o("div",Kt,[e(X,{onClick:H,loading:u.value},{default:t(()=>[e(M,null,{default:t(()=>[e(Y(Oe))]),_:1}),d[1]||(d[1]=_(" 刷新 ",-1))]),_:1},8,["loading"]),e(X,{onClick:R},{default:t(()=>[...d[2]||(d[2]=[_("关闭",-1)])]),_:1})])]),default:t(()=>[o("div",Rt,[o("div",Ft,[e(C,{column:2,border:""},{default:t(()=>[e(n,{label:"快递单号"},{default:t(()=>[e(l,{type:"primary"},{default:t(()=>[_(g(S.trackingNo),1)]),_:1})]),_:1}),e(n,{label:"物流公司"},{default:t(()=>[_(g(S.logisticsCompany||"未知"),1)]),_:1}),e(n,{label:"当前状态"},{default:t(()=>[e(l,{type:D(v.value)},{default:t(()=>[_(g(z(v.value)),1)]),_:1},8,["type"])]),_:1}),e(n,{label:"最后更新"},{default:t(()=>[_(g(f.value||"暂无数据"),1)]),_:1})]),_:1})])]),o("div",jt,[u.value?(m(),L("div",At,[e(w,{rows:5,animated:""})])):b.value.length===0?(m(),L("div",Bt,[e(P,{description:"暂无物流轨迹信息"})])):(m(),L("div",Yt,[e(G,null,{default:t(()=>[(m(!0),L(se,null,re(b.value,(I,x)=>(m(),F(Z,{key:x,timestamp:I.time,type:j(I,x),size:x===0?"large":"normal",placement:"top"},{default:t(()=>[e(J,{class:gt(["timeline-card",{latest:x===0}])},{default:t(()=>[o("div",qt,[o("div",Jt,g(I.description),1),I.location?(m(),L("div",Qt,[e(M,null,{default:t(()=>[e(Y(nt))]),_:1}),_(" "+g(I.location),1)])):W("",!0),I.operator?(m(),L("div",Ht,[e(M,null,{default:t(()=>[e(Y(st))]),_:1}),_(" 操作员："+g(I.operator),1)])):W("",!0)])]),_:2},1032,["class"])]),_:2},1032,["timestamp","type","size"]))),128))]),_:1})]))])]),_:1},8,["modelValue"])}}}),Zt=me(Wt,[["__scopeId","data-v-d2a6e21c"]]),Gt={class:"card-header"},Xt={class:"header-left"},el={class:"settings-content"},tl={class:"sync-status"},ll={class:"action-buttons"},al={key:0,class:"sync-logs"},ol={class:"log-content"},nl={class:"log-summary"},sl={key:0},rl={key:1},il={key:0,class:"log-errors"},dl=_e({__name:"AutoSyncSettings",setup(S){const c=T(!0),r=pe({enabled:!1,interval:30,batchSize:50,retryCount:3,syncToPerformance:!0,syncToOrderList:!0}),k=pe({isRunning:!1,lastSyncTime:"",config:{}}),$=T(!1),u=T([]),b=T(null),h=ne({get:()=>{const l=[];return r.syncToPerformance&&l.push("performance"),r.syncToOrderList&&l.push("orderList"),l},set:l=>{r.syncToPerformance=l.includes("performance"),r.syncToOrderList=l.includes("orderList")}});Le(()=>{v(),f(),z(),b.value=setInterval(f,3e4)}),je(()=>{b.value&&clearInterval(b.value)});const v=()=>{const l=ce.getConfig();Object.assign(r,l)},f=()=>{const l=ce.getStatus();Object.assign(k,l)},z=()=>{const l=localStorage.getItem("autoSyncLogs");if(l)try{u.value=JSON.parse(l).slice(-10)}catch(n){console.error("加载同步日志失败:",n)}},D=()=>{try{localStorage.setItem("autoSyncLogs",JSON.stringify(u.value))}catch(l){console.error("保存同步日志失败:",l)}},j=l=>{ce.updateConfig({enabled:l}),f(),l?O.success("自动同步已启用"):O.info("自动同步已停用")},E=()=>{ce.updateConfig(r),O.success("配置已保存")},H=()=>{ce.updateConfig({syncToPerformance:r.syncToPerformance,syncToOrderList:r.syncToOrderList}),O.success("同步范围已更新")},R=()=>oe(this,null,function*(){$.value=!0;try{const l=yield ce.manualSync();u.value.unshift(l),u.value.length>10&&(u.value=u.value.slice(0,10)),D(),f(),l.success?O.success(`手动同步完成，更新了 ${l.updatedCount} 个订单`):O.warning(`同步完成但有错误，更新了 ${l.updatedCount} 个订单，${l.errorCount} 个错误`)}catch(l){console.error("手动同步失败:",l),O.error(`手动同步失败: ${l}`)}finally{$.value=!1}}),V=()=>{f(),O.success("状态已刷新")},d=l=>{if(!l)return"";try{return new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch(n){return l}};return(l,n)=>{const C=s("el-icon"),w=s("el-button"),P=s("el-switch"),M=s("el-input-number"),J=s("el-form-item"),Z=s("el-checkbox"),G=s("el-checkbox-group"),X=s("el-form"),N=s("el-tag"),I=s("el-descriptions-item"),x=s("el-descriptions"),le=s("el-divider"),ie=s("el-collapse-item"),ee=s("el-collapse"),Se=s("el-timeline-item"),ke=s("el-timeline"),Ve=s("el-collapse-transition"),Ce=s("el-card");return m(),F(Ce,{class:"auto-sync-settings"},{header:t(()=>[o("div",Gt,[o("div",Xt,[e(w,{type:"text",onClick:n[0]||(n[0]=U=>c.value=!c.value),class:"collapse-btn"},{default:t(()=>[e(C,null,{default:t(()=>[c.value?(m(),F(Y(it),{key:0})):(m(),F(Y(dt),{key:1}))]),_:1}),n[6]||(n[6]=o("span",null,"自动状态同步设置",-1))]),_:1})]),e(P,{modelValue:r.enabled,"onUpdate:modelValue":n[1]||(n[1]=U=>r.enabled=U),onChange:j,"active-text":"启用","inactive-text":"停用"},null,8,["modelValue"])])]),default:t(()=>[e(Ve,null,{default:t(()=>[Ae(o("div",el,[e(X,{model:r,"label-width":"120px",disabled:!r.enabled},{default:t(()=>[e(J,{label:"检测间隔"},{default:t(()=>[e(M,{modelValue:r.interval,"onUpdate:modelValue":n[2]||(n[2]=U=>r.interval=U),min:5,max:1440,step:5,onChange:E},null,8,["modelValue"]),n[7]||(n[7]=o("span",{class:"form-text"},"分钟（建议30-60分钟）",-1))]),_:1}),e(J,{label:"批处理大小"},{default:t(()=>[e(M,{modelValue:r.batchSize,"onUpdate:modelValue":n[3]||(n[3]=U=>r.batchSize=U),min:10,max:200,step:10,onChange:E},null,8,["modelValue"]),n[8]||(n[8]=o("span",{class:"form-text"},"每次处理的订单数量",-1))]),_:1}),e(J,{label:"重试次数"},{default:t(()=>[e(M,{modelValue:r.retryCount,"onUpdate:modelValue":n[4]||(n[4]=U=>r.retryCount=U),min:1,max:10,onChange:E},null,8,["modelValue"]),n[9]||(n[9]=o("span",{class:"form-text"},"失败时的重试次数",-1))]),_:1}),e(J,{label:"同步范围"},{default:t(()=>[e(G,{modelValue:h.value,"onUpdate:modelValue":n[5]||(n[5]=U=>h.value=U),onChange:H},{default:t(()=>[e(Z,{label:"performance"},{default:t(()=>[...n[10]||(n[10]=[_("同步到业绩统计",-1)])]),_:1}),e(Z,{label:"orderList"},{default:t(()=>[...n[11]||(n[11]=[_("同步到订单列表",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","disabled"]),o("div",tl,[e(x,{title:"同步状态",column:2,border:""},{default:t(()=>[e(I,{label:"服务状态"},{default:t(()=>[e(N,{type:k.isRunning?"success":"info"},{default:t(()=>[_(g(k.isRunning?"运行中":"已停止"),1)]),_:1},8,["type"])]),_:1}),e(I,{label:"最后同步"},{default:t(()=>[_(g(k.lastSyncTime?d(k.lastSyncTime):"从未同步"),1)]),_:1})]),_:1})]),o("div",ll,[e(w,{type:"primary",onClick:R,loading:$.value,disabled:!r.enabled},{default:t(()=>[e(C,null,{default:t(()=>[e(Y(Oe))]),_:1}),n[12]||(n[12]=_(" 手动同步 ",-1))]),_:1},8,["loading","disabled"]),e(w,{onClick:V},{default:t(()=>[e(C,null,{default:t(()=>[e(Y(rt))]),_:1}),n[13]||(n[13]=_(" 刷新状态 ",-1))]),_:1})]),u.value.length>0?(m(),L("div",al,[e(le,{"content-position":"left"},{default:t(()=>[...n[14]||(n[14]=[_("同步日志",-1)])]),_:1}),e(ke,null,{default:t(()=>[(m(!0),L(se,null,re(u.value,(U,ge)=>(m(),F(Se,{key:ge,timestamp:d(U.time),type:U.success?"success":"danger"},{default:t(()=>[o("div",ol,[o("div",nl,[_(g(U.success?"同步成功":"同步失败")+" ",1),U.updatedCount>0?(m(),L("span",sl," - 更新了 "+g(U.updatedCount)+" 个订单 ",1)):W("",!0),U.errorCount>0?(m(),L("span",rl," - "+g(U.errorCount)+" 个错误 ",1)):W("",!0)]),U.errors.length>0?(m(),L("div",il,[e(ee,null,{default:t(()=>[e(ie,{title:"查看错误详情"},{default:t(()=>[o("ul",null,[(m(!0),L(se,null,re(U.errors,(ye,$e)=>(m(),L("li",{key:$e},g(ye),1))),128))])]),_:2},1024)]),_:2},1024)])):W("",!0)])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):W("",!0)],512),[[yt,!c.value]])]),_:1})]),_:1})}}}),ul=me(dl,[["__scopeId","data-v-dfb1b452"]]),cl={class:"logistics-status-update"},pl={class:"summary-cards"},ml={class:"summary-header"},_l={class:"auto-refresh-controls"},fl={key:0,class:"refresh-status"},vl={class:"card-content"},gl={class:"card-icon pending"},yl={class:"card-info"},bl={class:"card-value"},hl={class:"card-content"},wl={class:"card-icon updated"},Sl={class:"card-info"},kl={class:"card-value"},Vl={class:"card-content"},Cl={class:"card-icon todo"},$l={class:"card-info"},Tl={class:"card-value"},xl={class:"card-content"},Dl={class:"card-icon total"},Ul={class:"card-info"},Ol={class:"card-value"},Ll={class:"quick-filters"},Nl={class:"search-filters"},Il={class:"list-navigation"},zl={class:"order-list"},Pl={class:"empty-data"},Ml={key:1},El={class:"logistics-update"},Rl={key:1},Fl={class:"pagination"},jl=_e({__name:"StatusUpdate",setup(S){const c=ve(),r=T(!1),k=T("pending"),$=T("today"),u=T(["",""]),b=T(""),h=T(""),v=T([]),f=T([]),z=T(null),D=pe({currentPage:1,pageSize:20,total:0}),j=T(!1),E=T(!1),H=T(!1),R=T(!1),V=T(""),d=T(""),l=T(null),n=T(3e4),C=T(!0),w=pe({pending:0,updated:0,todo:0,total:0}),P=[{label:"今日",value:"today"},{label:"昨日",value:"yesterday"},{label:"3天前",value:"3days"},{label:"5天前",value:"5days"},{label:"10天前",value:"10days"},{label:"本周",value:"week"},{label:"30天",value:"30days"},{label:"今年",value:"year"},{label:"全部",value:"all"}],M=i=>{$.value=i;const a=new Date,y=q=>q.toISOString().split("T")[0];switch(i){case"today":u.value=[y(a),y(a)];break;case"yesterday":const q=new Date(a.getTime()-24*60*60*1e3);u.value=[y(q),y(q)];break;case"3days":const Q=new Date(a.getTime()-3*24*60*60*1e3);u.value=["",y(Q)];break;case"5days":const ae=new Date(a.getTime()-5*24*60*60*1e3);u.value=["",y(ae)];break;case"10days":const B=new Date(a.getTime()-10*24*60*60*1e3);u.value=["",y(B)];break;case"week":const de=new Date(a.getTime()-(a.getDay()-1)*24*60*60*1e3);u.value=[y(de),y(a)];break;case"30days":const Te=new Date(a.getTime()-30*24*60*60*1e3);u.value=[y(Te),y(a)];break;case"year":const xe=new Date(a.getFullYear(),0,1);u.value=[y(xe),y(a)];break;case"all":u.value=["",""];break}D.currentPage=1,A()},J=()=>{D.currentPage=1,A()},Z=()=>{D.currentPage=1,A()},G=()=>{D.currentPage=1,A()},X=i=>{k.value=i,D.currentPage=1,A()},N=i=>{f.value=i},I=i=>{D.currentPage=i,A()},x=i=>{D.pageSize=i,D.currentPage=1,A()},le=i=>{z.value=i,R.value=!0},ie=i=>{z.value=i,f.value=[],j.value=!0},ee=i=>{z.value=i,E.value=!0},Se=i=>{if(O.success("状态更新成功"),A(),te(!0),f.value=[],i&&k.value==="pending"){const a=Pe(i.newStatus),y=i.orders.length;y===1?O.info(`订单已更新为"${a}"状态，可在"已更新"标签页查看`):O.info(`${y}个订单已更新为"${a}"状态，可在"已更新"标签页查看`)}window.dispatchEvent(new CustomEvent("orderStatusUpdated",{detail:{timestamp:Date.now(),updatedOrders:(i==null?void 0:i.orders)||[],newStatus:i==null?void 0:i.newStatus}}))},ke=()=>{O.success("待办设置成功"),A(),te(!0),window.dispatchEvent(new CustomEvent("todoStatusUpdated",{detail:{timestamp:Date.now()}}))},Ve=i=>{R.value=!1,z.value=i,f.value=[],j.value=!0},Ce=i=>{R.value=!1,z.value=i,E.value=!0},U=i=>{console.log("检测到订单发货事件:",i.detail),A(),te(!0),k.value==="pending"&&O.info("检测到新的发货订单，已自动刷新列表")},ge=i=>{const{orderId:a,oldStatus:y,newStatus:q,operator:Q}=i.detail;console.log("检测到订单状态更新:",{orderId:a,oldStatus:y,newStatus:q,operator:Q}),q==="shipped"?(A(),te(!0),O.success(`订单 ${a} 已发货，已同步到物流状态列表`)):["delivered","rejected","returned","abnormal"].includes(q)&&(A(),te(!0))},ye=i=>{console.log("检测到外部订单状态更新:",i.detail),A(),te(!0)},$e=i=>{V.value=i.trackingNo,d.value=i.logisticsCompany,H.value=!0},Ne=()=>{A(!0),te(!0)},Ie=()=>{l.value&&clearInterval(l.value),C.value&&(l.value=setInterval(()=>{te(!0)},n.value))},ze=()=>{l.value&&(clearInterval(l.value),l.value=null)},Be=()=>{C.value=!C.value,C.value?Ie():ze()},A=(i=!1)=>oe(this,null,function*(){r.value=!0;try{c.setFilters({tab:k.value,dateRange:u.value,keyword:b.value,status:h.value}),c.setPagination({currentPage:D.currentPage,pageSize:D.pageSize}),yield c.fetchOrderList(),v.value=c.orderList,D.total=c.pagination.total,i&&O.success("数据刷新成功")}catch(a){console.error("订单列表加载失败:",a),v.value=[],D.total=0,i&&O.error("数据加载失败，请检查网络连接或联系管理员")}finally{r.value=!1}}),te=(i=!1)=>oe(this,null,function*(){try{c.setFilters({tab:k.value,dateRange:u.value,keyword:b.value,status:h.value}),yield c.fetchSummary();const a=c.summary;if(i){const y=we({},w);w.pending=0,w.updated=0,w.todo=0,w.total=0,setTimeout(()=>{be("pending",y.pending,a.pending),be("updated",y.updated,a.updated),be("todo",y.todo,a.todo),be("total",y.total,a.total)},100)}else Object.assign(w,a)}catch(a){console.error("汇总数据加载失败:",a),w.pending=0,w.updated=0,w.todo=0,w.total=0,O.error("汇总数据加载失败")}}),be=(i,a,y)=>{const ae=(y-a)/30;let B=0;const de=setInterval(()=>{B++,B>=30?(w[i]=y,clearInterval(de)):w[i]=Math.round(a+ae*B)},1e3/30)},Ye=()=>{switch(k.value){case"pending":return"暂无待更新订单";case"updated":return"暂无已发货订单";case"todo":return"暂无待办订单";default:return"暂无数据"}},Pe=i=>({pending:"待发货",shipped:"已发货",delivered:"已签收",rejected:"拒收",returned:"拒收已退回",refunded:"退货退款",abnormal:"状态异常",todo:"待办"})[i]||i,qe=i=>({pending:"warning",shipped:"info",delivered:"success",rejected:"warning",returned:"danger",refunded:"danger",abnormal:"danger",todo:"info"})[i]||"info";return Le(()=>{M("today"),te(),Ie(),window.addEventListener("orderStatusUpdated",ye),window.addEventListener("order-status-update",ge),window.addEventListener("order-shipped",U),window.addEventListener("logistics-status-update",U)}),je(()=>{ze(),window.removeEventListener("orderStatusUpdated",ye),window.removeEventListener("order-status-update",ge),window.removeEventListener("order-shipped",U),window.removeEventListener("logistics-status-update",U)}),fe([u,h,b],()=>{te(!0)},{deep:!0}),(i,a)=>{const y=s("el-button"),q=s("el-tooltip"),Q=s("el-icon"),ae=s("el-card"),B=s("el-col"),de=s("el-row"),Te=s("el-date-picker"),xe=s("el-input"),ue=s("el-option"),Je=s("el-select"),Me=s("el-badge"),De=s("el-tab-pane"),Qe=s("el-tabs"),He=s("el-empty"),K=s("el-table-column"),Ke=s("el-tag"),We=s("el-table"),Ze=s("el-pagination"),Ge=bt("loading");return m(),F(Vt,null,{default:t(()=>[o("div",cl,[o("div",pl,[o("div",ml,[a[11]||(a[11]=o("h3",null,"数据汇总",-1)),o("div",_l,[e(q,{content:"切换自动刷新"},{default:t(()=>[e(y,{type:C.value?"success":"info",icon:C.value?"Refresh":"VideoPause",circle:"",size:"small",onClick:Be},null,8,["type","icon"])]),_:1}),e(q,{content:"手动刷新"},{default:t(()=>[e(y,{type:"primary",icon:"Refresh",circle:"",size:"small",onClick:Ne})]),_:1}),C.value?(m(),L("span",fl,[e(Q,{class:"refresh-icon"},{default:t(()=>[e(Y(ut))]),_:1}),a[10]||(a[10]=_(" 实时更新中 ",-1))])):W("",!0)])]),e(de,{gutter:20},{default:t(()=>[e(B,{span:6},{default:t(()=>[e(ae,{class:"summary-card"},{default:t(()=>[o("div",vl,[o("div",gl,[e(Q,null,{default:t(()=>[e(Y(ct))]),_:1})]),o("div",yl,[a[12]||(a[12]=o("div",{class:"card-title"},"待更新",-1)),o("div",bl,g(w.pending),1)])])]),_:1})]),_:1}),e(B,{span:6},{default:t(()=>[e(ae,{class:"summary-card"},{default:t(()=>[o("div",hl,[o("div",wl,[e(Q,null,{default:t(()=>[e(Y(pt))]),_:1})]),o("div",Sl,[a[13]||(a[13]=o("div",{class:"card-title"},"已更新",-1)),o("div",kl,g(w.updated),1)])])]),_:1})]),_:1}),e(B,{span:6},{default:t(()=>[e(ae,{class:"summary-card"},{default:t(()=>[o("div",Vl,[o("div",Cl,[e(Q,null,{default:t(()=>[e(Y(mt))]),_:1})]),o("div",$l,[a[14]||(a[14]=o("div",{class:"card-title"},"待办",-1)),o("div",Tl,g(w.todo),1)])])]),_:1})]),_:1}),e(B,{span:6},{default:t(()=>[e(ae,{class:"summary-card"},{default:t(()=>[o("div",xl,[o("div",Dl,[e(Q,null,{default:t(()=>[e(Y(_t))]),_:1})]),o("div",Ul,[a[15]||(a[15]=o("div",{class:"card-title"},"总计",-1)),o("div",Ol,g(w.total),1)])])]),_:1})]),_:1})]),_:1})]),o("div",Ll,[(m(),L(se,null,re(P,p=>e(y,{key:p.value,type:$.value===p.value?"primary":"",onClick:he=>M(p.value),class:"filter-button",round:""},{default:t(()=>[_(g(p.label),1)]),_:2},1032,["type","onClick"])),64))]),o("div",Nl,[e(de,{gutter:20},{default:t(()=>[e(B,{span:6},{default:t(()=>[e(Te,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=p=>u.value=p),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:J},null,8,["modelValue"])]),_:1}),e(B,{span:6},{default:t(()=>[e(xe,{modelValue:b.value,"onUpdate:modelValue":a[1]||(a[1]=p=>b.value=p),placeholder:"搜索订单号、客户名称",clearable:"",onInput:Z},{prefix:t(()=>[e(Q,null,{default:t(()=>[e(Y(ft))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(B,{span:6},{default:t(()=>[e(Je,{modelValue:h.value,"onUpdate:modelValue":a[2]||(a[2]=p=>h.value=p),placeholder:"选择状态",clearable:"",onChange:G},{default:t(()=>[e(ue,{label:"已发货",value:"shipped"}),e(ue,{label:"已签收",value:"delivered"}),e(ue,{label:"拒收",value:"rejected"}),e(ue,{label:"拒收已退回",value:"returned"}),e(ue,{label:"退货退款",value:"refunded"}),e(ue,{label:"状态异常",value:"abnormal"})]),_:1},8,["modelValue"])]),_:1}),e(B,{span:6},{default:t(()=>[e(y,{type:"primary",onClick:Ne},{default:t(()=>[e(Q,null,{default:t(()=>[e(Y(Oe))]),_:1}),a[16]||(a[16]=_(" 刷新数据 ",-1))]),_:1})]),_:1})]),_:1})]),o("div",Il,[e(Qe,{modelValue:k.value,"onUpdate:modelValue":a[3]||(a[3]=p=>k.value=p),onTabChange:X},{default:t(()=>[e(De,{label:"待更新",name:"pending"},{label:t(()=>[o("span",null,[a[17]||(a[17]=_("待更新 ",-1)),e(Me,{value:w.pending,class:"item pending-badge"},null,8,["value"])])]),_:1}),e(De,{label:"已更新",name:"updated"},{label:t(()=>[...a[18]||(a[18]=[o("span",null,"已更新",-1)])]),_:1}),e(De,{label:"待办",name:"todo"},{label:t(()=>[o("span",null,[a[19]||(a[19]=_("待办 ",-1)),e(Me,{value:w.todo,class:"item todo-badge"},null,8,["value"])])]),_:1})]),_:1},8,["modelValue"])]),e(ul),o("div",zl,[Ae((m(),F(We,{data:v.value,stripe:"",onSelectionChange:N},{empty:t(()=>[o("div",Pl,[e(He,{description:Ye(),"image-size":120},null,8,["description"])])]),default:t(()=>[e(K,{type:"selection",width:"55"}),e(K,{prop:"index",label:"序号",width:"80"}),e(K,{prop:"orderNo",label:"订单号",width:"150"}),e(K,{prop:"customerName",label:"客户名称",width:"120"}),e(K,{prop:"status",label:"状态",width:"100"},{default:t(({row:p})=>[e(Ke,{type:qe(p.status)},{default:t(()=>[_(g(Pe(p.status)),1)]),_:2},1032,["type"])]),_:1}),e(K,{prop:"amount",label:"金额",width:"100"},{default:t(({row:p})=>[_(" ¥"+g(p.amount),1)]),_:1}),e(K,{prop:"trackingNo",label:"快递单号",width:"150"},{default:t(({row:p})=>[p.trackingNo?(m(),F(y,{key:0,type:"text",onClick:he=>$e(p)},{default:t(()=>[_(g(p.trackingNo),1)]),_:2},1032,["onClick"])):(m(),L("span",Ml,"-"))]),_:1}),e(K,{prop:"latestUpdate",label:"物流最新动态",width:"200"},{default:t(({row:p})=>[p.latestUpdate?(m(),F(q,{key:0,content:p.latestUpdate,placement:"top"},{default:t(()=>[o("div",El,g(p.latestUpdate),1)]),_:2},1032,["content"])):(m(),L("span",Rl,"-"))]),_:1}),e(K,{prop:"assignedTo",label:"归属人",width:"100"}),e(K,{prop:"orderDate",label:"下单日期",width:"120"}),e(K,{label:"操作",width:"200",fixed:"right"},{default:t(({row:p})=>[e(y,{size:"small",onClick:he=>le(p)},{default:t(()=>[...a[20]||(a[20]=[_("查看",-1)])]),_:1},8,["onClick"]),k.value==="pending"?(m(),F(y,{key:0,size:"small",type:"primary",onClick:he=>ie(p)},{default:t(()=>[...a[21]||(a[21]=[_(" 更新状态 ",-1)])]),_:1},8,["onClick"])):W("",!0),k.value==="pending"?(m(),F(y,{key:1,size:"small",type:"warning",onClick:he=>ee(p)},{default:t(()=>[...a[22]||(a[22]=[_(" 待办 ",-1)])]),_:1},8,["onClick"])):W("",!0)]),_:1})]),_:1},8,["data"])),[[Ge,r.value]]),o("div",Fl,[e(Ze,{"current-page":D.currentPage,"onUpdate:currentPage":a[4]||(a[4]=p=>D.currentPage=p),"page-size":D.pageSize,"onUpdate:pageSize":a[5]||(a[5]=p=>D.pageSize=p),"page-sizes":[10,20,50,100],total:D.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:x,onCurrentChange:I},null,8,["current-page","page-size","total"])])]),e(Lt,{modelValue:j.value,"onUpdate:modelValue":a[6]||(a[6]=p=>j.value=p),"order-info":z.value,"selected-orders":f.value,onSuccess:Se},null,8,["modelValue","order-info","selected-orders"]),e(Et,{modelValue:E.value,"onUpdate:modelValue":a[7]||(a[7]=p=>E.value=p),"order-info":z.value,onSuccess:ke},null,8,["modelValue","order-info"]),e(Zt,{modelValue:H.value,"onUpdate:modelValue":a[8]||(a[8]=p=>H.value=p),"tracking-no":V.value,"logistics-company":d.value},null,8,["modelValue","tracking-no","logistics-company"]),e(ht,{visible:R.value,"onUpdate:visible":a[9]||(a[9]=p=>R.value=p),order:z.value,"show-action-buttons":k.value==="pending",onUpdateStatus:Ve,onSetTodo:Ce},null,8,["visible","order","show-action-buttons"])])]),_:1})}}}),Kl=me(jl,[["__scopeId","data-v-8423cc98"]]);export{Kl as default};
