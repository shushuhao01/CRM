import{l as e,e as a,r as l,ag as t,M as s,q as n,O as r,m as o,Q as i,p as d,U as u,S as c,u as m,T as p,F as v,a9 as g,Z as f,w as h,b as y,aA as b,J as _}from"./vendor-BtukhyiH.js";import{S as w,_ as k,u as D,c as C}from"./index-DkAJPKqn.js";import{u as T,l as V,N as x,ar as I,B as N,as as S,at as A,E as z,a4 as U,T as L,R as $,F as O,r as M,Z as j,A as q,ac as R,I as F,M as E,au as P,a7 as B,d as H,P as Q,aq as J,O as Z,b as G}from"./elementPlus-DxaqjplL.js";import{u as K,g as W}from"./data-CMMX0NjI.js";import{useDepartmentStore as Y}from"./department-DPqzaatc.js";import{a as X}from"./sensitiveInfo-DVfrBLrU.js";import{getDepartmentMembers as ee}from"./department-BolWvDJg.js";import{D as ae}from"./DynamicTable-BEeD1UIt.js";import{T as le}from"./TableColumnSettings-CrYSHYg1.js";import"./utils-DfI7e5Rl.js";import"./env-DLalhsF6.js";const te={key:0,class:"customer-detail-content"},se={class:"detail-section"},ne={class:"section-title"},re={class:"info-grid"},oe={class:"info-item"},ie={class:"value"},de={class:"info-item"},ue={class:"value"},ce={class:"info-item"},me={class:"value amount"},pe={class:"info-item"},ve={class:"value"},ge={class:"info-item"},fe={class:"value"},he={class:"info-item"},ye={key:0,class:"info-item"},be={class:"value"},_e={class:"info-item"},we={class:"value"},ke={class:"info-item"},De={class:"value"},Ce={class:"info-item full-width"},Te={class:"value"},Ve={key:1,class:"info-item full-width"},xe={class:"value"},Ie={key:2,class:"info-item full-width"},Ne={class:"value"},Se={key:0,class:"detail-section"},Ae={class:"section-title"},ze={class:"archive-info"},Ue={class:"archive-item"},Le={class:"value"},$e={class:"archive-item"},Oe={class:"value"},Me={class:"archive-item"},je={class:"value"},qe={class:"archive-item"},Re={class:"value"},Fe={class:"archive-item full-width"},Ee={class:"value"},Pe={class:"detail-section"},Be={class:"section-title"},He={class:"order-info"},Qe={class:"order-item"},Je={class:"value"},Ze={class:"order-item"},Ge={class:"value"},Ke={class:"order-item"},We={class:"value"},Ye={class:"order-item"},Xe={class:"value"},ea={class:"action-section"},aa={class:"section-title"},la={class:"action-buttons"},ta={class:"operation-history"},sa={class:"collapse-title"},na={key:0,class:"latest-record"},ra={class:"history-list"},oa={class:"history-header"},ia={class:"history-time"},da={class:"history-content"},ua={class:"history-operator"},ca={key:0,class:"department"},ma={key:0,class:"history-target"},pa={key:0,class:"department"},va={key:1,class:"history-reason"},ga={key:2,class:"history-remark"},fa=k(e({__name:"CustomerDetailDialog",props:{modelValue:{type:Boolean},customerData:{}},emits:["update:modelValue","quick-assign","quick-archive","quick-recover","quick-reassign"],setup(e,{emit:f}){const h=e,y=f,b=a({get:()=>h.modelValue,set:e=>y("update:modelValue",e)}),_=l([]),k=a(()=>{const e=h.customerData?.operationRecords||[];return 0===e.length?null:e.reduce((e,a)=>new Date(a.createTime)>new Date(e.createTime)?a:e)}),D=e=>({assign:"分配",archive:"封存",recover:"回收",reassign:"重新分配"}[e]||e),C=e=>{if(!e)return"暂无";return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},z=()=>{y("update:modelValue",!1)},U=e=>({pending:"待分配",assigned:"已分配",archived:"已封存",recovered:"已回收"}[e]||e),L=()=>{h.customerData&&y("quick-assign",h.customerData)},$=()=>{h.customerData&&y("quick-archive",h.customerData)},O=()=>{h.customerData&&y("quick-recover",h.customerData)},M=()=>{h.customerData&&y("quick-reassign",h.customerData)};return(a,l)=>{const f=t("el-icon"),h=t("el-tag"),y=t("el-button"),j=t("el-collapse-item"),q=t("el-collapse"),R=t("el-dialog");return n(),s(R,{modelValue:b.value,"onUpdate:modelValue":l[1]||(l[1]=e=>b.value=e),title:"客户详情",width:"80%","before-close":z,class:"customer-detail-dialog",top:"5vh"},{footer:r(()=>[u(y,{onClick:z},{default:r(()=>[...l[33]||(l[33]=[c("关闭",-1)])]),_:1})]),default:r(()=>{return[e.customerData?(n(),o("div",te,[d("div",se,[d("h3",ne,[u(f,null,{default:r(()=>[u(m(T))]),_:1}),l[2]||(l[2]=c(" 客户基本信息 ",-1))]),d("div",re,[d("div",oe,[l[3]||(l[3]=d("label",null,"客户姓名：",-1)),d("span",ie,p(e.customerData.customerName),1)]),d("div",de,[l[4]||(l[4]=d("label",null,"联系电话：",-1)),d("span",ue,p(m(X)(e.customerData.phone,m(w).PHONE)),1)]),d("div",ce,[l[5]||(l[5]=d("label",null,"订单金额：",-1)),d("span",me,"¥"+p(e.customerData.orderAmount?.toLocaleString()),1)]),d("div",pe,[l[6]||(l[6]=d("label",null,"下单日期：",-1)),d("span",ve,p(e.customerData.orderDate),1)]),d("div",ge,[l[7]||(l[7]=d("label",null,"签收日期：",-1)),d("span",fe,p(e.customerData.signDate),1)]),d("div",he,[l[8]||(l[8]=d("label",null,"当前状态：",-1)),u(h,{type:(a=e.customerData.status,{pending:"",assigned:"success",archived:"warning"}[a]||"")},{default:r(()=>[c(p(U(e.customerData.status)),1)]),_:1},8,["type"])]),"assigned"===e.customerData.status||"archived"===e.customerData.status?(n(),o("div",ye,[l[9]||(l[9]=d("label",null,"操作人：",-1)),d("span",be,p(e.customerData.operatorName||"未知"),1)])):i("",!0),d("div",_e,[l[10]||(l[10]=d("label",null,"归属人：",-1)),d("span",we,p(e.customerData.createdByName||"未知"),1)]),d("div",ke,[l[11]||(l[11]=d("label",null,"创建时间：",-1)),d("span",De,p(C(e.customerData.createTime)),1)]),d("div",Ce,[l[12]||(l[12]=d("label",null,"收货地址：",-1)),d("span",Te,p(e.customerData.address),1)]),e.customerData.remark?(n(),o("div",Ve,[l[13]||(l[13]=d("label",null,"备注信息：",-1)),d("span",xe,p(e.customerData.remark),1)])):i("",!0),e.customerData.isReassigned?(n(),o("div",Ie,[l[15]||(l[15]=d("label",null,"重新分配：",-1)),d("span",Ne,[u(h,{type:"warning",size:"small"},{default:r(()=>[...l[14]||(l[14]=[c("已重新分配",-1)])]),_:1})])])):i("",!0)])]),e.customerData.archiveInfo?(n(),o("div",Se,[d("h3",Ae,[u(f,null,{default:r(()=>[u(m(V))]),_:1}),l[16]||(l[16]=c(" 封存信息 ",-1))]),d("div",ze,[d("div",Ue,[l[17]||(l[17]=d("label",null,"封存时长：",-1)),d("span",Le,p(e.customerData.archiveInfo.duration),1)]),d("div",$e,[l[18]||(l[18]=d("label",null,"封存原因：",-1)),d("span",Oe,p(e.customerData.archiveInfo.reason),1)]),d("div",Me,[l[19]||(l[19]=d("label",null,"封存时间：",-1)),d("span",je,p(C(e.customerData.archiveInfo.archiveTime)),1)]),d("div",qe,[l[20]||(l[20]=d("label",null,"预计解封：",-1)),d("span",Re,p(C(e.customerData.archiveInfo.unarchiveTime)),1)]),d("div",Fe,[l[21]||(l[21]=d("label",null,"封存备注：",-1)),d("span",Ee,p(e.customerData.archiveInfo.remark),1)])])])):i("",!0),d("div",Pe,[d("h3",Be,[u(f,null,{default:r(()=>[u(m(x))]),_:1}),l[22]||(l[22]=c(" 订单信息 ",-1))]),d("div",He,[d("div",Qe,[l[23]||(l[23]=d("label",null,"订单号：",-1)),d("span",Je,p(e.customerData.orderNo),1)]),d("div",Ze,[l[24]||(l[24]=d("label",null,"物流单号：",-1)),d("span",Ge,p(e.customerData.trackingNo||"暂无"),1)]),d("div",Ke,[l[25]||(l[25]=d("label",null,"创建时间：",-1)),d("span",We,p(C(e.customerData.createTime)),1)]),d("div",Ye,[l[26]||(l[26]=d("label",null,"更新时间：",-1)),d("span",Xe,p(C(e.customerData.updateTime)),1)])])]),d("div",ea,[d("h3",aa,[u(f,null,{default:r(()=>[u(m(I))]),_:1}),l[27]||(l[27]=c(" 快捷操作 ",-1))]),d("div",la,["pending"===e.customerData.status?(n(),s(y,{key:0,type:"success",onClick:L,icon:m(N)},{default:r(()=>[...l[28]||(l[28]=[c(" 分配 ",-1)])]),_:1},8,["icon"])):i("",!0),"archived"!==e.customerData.status?(n(),s(y,{key:1,type:"danger",onClick:$,icon:m(S)},{default:r(()=>[...l[29]||(l[29]=[c(" 封存 ",-1)])]),_:1},8,["icon"])):i("",!0),"archived"===e.customerData.status?(n(),s(y,{key:2,type:"info",onClick:M,icon:m(A)},{default:r(()=>[...l[30]||(l[30]=[c(" 重新分配 ",-1)])]),_:1},8,["icon"])):i("",!0),"pending"!==e.customerData.status?(n(),s(y,{key:3,type:"warning",onClick:O,icon:m(A)},{default:r(()=>[...l[31]||(l[31]=[c(" 回收 ",-1)])]),_:1},8,["icon"])):i("",!0)])])])):i("",!0),d("div",ta,[u(q,{modelValue:_.value,"onUpdate:modelValue":l[0]||(l[0]=e=>_.value=e)},{default:r(()=>[u(j,{title:"操作轨迹记录",name:"history"},{title:r(()=>[d("div",sa,[u(f,null,{default:r(()=>[u(m(I))]),_:1}),l[32]||(l[32]=d("span",null,"操作轨迹记录",-1)),k.value?(n(),o("span",na," （最新："+p(k.value.operatorName)+" "+p(D(k.value.type))+" - "+p(C(k.value.createTime))+"） ",1)):i("",!0)])]),default:r(()=>[d("div",ra,[(n(!0),o(v,null,g(e.customerData?.operationRecords||[],e=>{return n(),o("div",{key:e.id,class:"history-item"},[d("div",oa,[u(h,{type:(a=e.type,{assign:"success",archive:"warning",recover:"danger",reassign:"info"}[a]||"info"),size:"small"},{default:r(()=>[c(p(D(e.type)),1)]),_:2},1032,["type"]),d("span",ia,p(C(e.createTime)),1)]),d("div",da,[d("div",ua,[u(f,null,{default:r(()=>[u(m(T))]),_:1}),d("span",null,"操作人："+p(e.operatorName),1),e.operatorDepartment?(n(),o("span",ca,"（"+p(e.operatorDepartment)+"）",1)):i("",!0)]),e.targetUserId?(n(),o("div",ma,[u(f,null,{default:r(()=>[u(m(N))]),_:1}),d("span",null,"目标："+p(e.targetUserName),1),e.targetUserDepartment?(n(),o("span",pa,"（"+p(e.targetUserDepartment)+"）",1)):i("",!0)])):i("",!0),e.reason?(n(),o("div",va,[d("span",null,"原因："+p(e.reason),1)])):i("",!0),e.remark?(n(),o("div",ga,[d("span",null,"备注："+p(e.remark),1)])):i("",!0)])]);var a}),128))])]),_:1})]),_:1},8,["modelValue"])])];var a}),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-e6f604de"]]),ha={class:"archive-dialog-content"},ya={class:"archive-info"},ba={key:0,class:"customer-info"},_a={class:"info-row"},wa={class:"value"},ka={class:"info-row"},Da={class:"value"},Ca={class:"info-row"},Ta={class:"value"},Va=k(e({__name:"ArchiveDialog",props:{modelValue:{type:Boolean},customerData:{}},emits:["update:modelValue","confirm"],setup(e,{emit:v}){const g=e,y=v,b=l(),_=l(!1),k=a({get:()=>g.modelValue,set:e=>y("update:modelValue",e)}),D=f({duration:"",reason:"",remark:""}),C={duration:[{required:!0,message:"请选择封存时长",trigger:"change"}],reason:[{required:!0,message:"请选择封存原因",trigger:"change"}],remark:[{required:!0,message:"请填写备注说明",trigger:"blur"},{min:10,message:"备注说明至少10个字符",trigger:"blur"}]},T=()=>{if(!D.duration)return"";const e=new Date;let a;switch(D.duration){case"1day":a=new Date(e.getTime()+864e5);break;case"7days":a=new Date(e.getTime()+6048e5);break;case"15days":a=new Date(e.getTime()+1296e6);break;case"30days":a=new Date(e.getTime()+2592e6);break;case"1year":a=new Date(e.getTime()+31536e6);break;default:return"永久封存"}return a.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},V=()=>{D.duration="",D.reason="",D.remark="",b.value?.clearValidate()},x=()=>{k.value=!1,V()},I=async()=>{if(b.value)try{await b.value.validate(),_.value=!0;const e={duration:D.duration,reason:D.reason,remark:D.remark,unarchiveTime:"permanent"!==D.duration?T():void 0};y("confirm",e),z.success("封存成功"),x()}catch(e){console.error("表单验证失败:",e)}finally{_.value=!1}};return h(()=>g.modelValue,e=>{e&&V()}),(a,l)=>{const v=t("el-alert"),g=t("el-option"),f=t("el-select"),h=t("el-form-item"),y=t("el-input"),V=t("el-text"),N=t("el-form"),S=t("el-divider"),A=t("el-button"),z=t("el-dialog");return n(),s(z,{modelValue:k.value,"onUpdate:modelValue":l[3]||(l[3]=e=>k.value=e),title:"封存客户资料",width:"500px","close-on-click-modal":!1,onClose:x},{footer:r(()=>[u(A,{onClick:x},{default:r(()=>[...l[9]||(l[9]=[c("取消",-1)])]),_:1}),u(A,{type:"danger",onClick:I,loading:_.value},{default:r(()=>[...l[10]||(l[10]=[c(" 确认封存 ",-1)])]),_:1},8,["loading"])]),default:r(()=>[d("div",ha,[d("div",ya,[u(v,{title:"封存说明",type:"warning",closable:!1,"show-icon":""},{default:r(()=>[...l[4]||(l[4]=[d("p",null,'封存后的客户资料将从当前列表中移除，在指定时间后自动重新出现在未分配列表中，并标记为"重新分配"状态。',-1)])]),_:1})]),u(N,{ref_key:"formRef",ref:b,model:D,rules:C,"label-width":"100px",class:"archive-form"},{default:r(()=>[u(h,{label:"封存时长",prop:"duration"},{default:r(()=>[u(f,{modelValue:D.duration,"onUpdate:modelValue":l[0]||(l[0]=e=>D.duration=e),placeholder:"请选择封存时长",style:{width:"100%"}},{default:r(()=>[u(g,{label:"1天",value:"1day"}),u(g,{label:"7天",value:"7days"}),u(g,{label:"15天",value:"15days"}),u(g,{label:"30天",value:"30days"}),u(g,{label:"1年",value:"1year"}),u(g,{label:"永久封存",value:"permanent"})]),_:1},8,["modelValue"])]),_:1}),u(h,{label:"封存原因",prop:"reason"},{default:r(()=>[u(f,{modelValue:D.reason,"onUpdate:modelValue":l[1]||(l[1]=e=>D.reason=e),placeholder:"请选择封存原因",style:{width:"100%"}},{default:r(()=>[u(g,{label:"客户暂时无需求",value:"no_demand"}),u(g,{label:"客户预算不足",value:"insufficient_budget"}),u(g,{label:"客户决策周期长",value:"long_decision_cycle"}),u(g,{label:"竞争对手已成交",value:"competitor_deal"}),u(g,{label:"客户信息不准确",value:"inaccurate_info"}),u(g,{label:"其他原因",value:"other"})]),_:1},8,["modelValue"])]),_:1}),u(h,{label:"备注说明",prop:"remark"},{default:r(()=>[u(y,{modelValue:D.remark,"onUpdate:modelValue":l[2]||(l[2]=e=>D.remark=e),type:"textarea",placeholder:"请详细说明封存原因，此信息将在客户重新分配时显示（必填）",rows:4,maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),"permanent"!==D.duration?(n(),s(h,{key:0,label:"预计解封时间"},{default:r(()=>[u(V,{type:"info"},{default:r(()=>[c(p(T()),1)]),_:1})]),_:1})):i("",!0)]),_:1},8,["model"]),e.customerData?(n(),o("div",ba,[u(S,{"content-position":"left"},{default:r(()=>[...l[5]||(l[5]=[c("客户信息",-1)])]),_:1}),d("div",_a,[l[6]||(l[6]=d("span",{class:"label"},"客户姓名：",-1)),d("span",wa,p(e.customerData.customerName),1)]),d("div",ka,[l[7]||(l[7]=d("span",{class:"label"},"联系电话：",-1)),d("span",Da,p(m(X)(e.customerData.phone,m(w).PHONE)),1)]),d("div",Ca,[l[8]||(l[8]=d("span",{class:"label"},"订单金额：",-1)),d("span",Ta,"¥"+p(e.customerData.orderAmount.toLocaleString()),1)])])):i("",!0)])]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-a3f54651"]]),xa={class:"assign-content"},Ia={class:"info-section"},Na={class:"assignment-section"},Sa={class:"preview-section"},Aa={class:"custom-assign-section"},za={class:"member-name"},Ua={class:"current-count"},La={class:"assign-summary"},$a={class:"data-list-section"},Oa={class:"dialog-footer"},Ma=k(e({__name:"LeaderAssignDialog",props:{modelValue:{type:Boolean},pendingData:{},departmentId:{},departmentName:{}},emits:["update:modelValue","assigned"],setup(e,{emit:b}){const _=e,k=b,C=K();Y();const T=D(),V=a({get:()=>_.modelValue,set:e=>k("update:modelValue",e)}),x=a(()=>_.pendingData||[]),I=l([]),N=l(!1),S=f({assignType:"leader_roundrobin",assignTo:"",remark:""}),A=l({}),U=l(!1),L=async()=>{try{N.value=!0;const e=T.currentUser;if(!e?.departmentId)return void z.error("无法获取当前用户部门信息");const a=await ee(e.departmentId),l=await W({departmentId:e.departmentId});I.value=a.map(e=>{const a=l.find(a=>a.userId===e.id);return{id:e.id,name:e.name,assignmentCount:a?.totalAssigned||0}}),$()}catch(e){console.error("加载部门成员失败:",e),z.error("加载部门成员失败")}finally{N.value=!1}},$=()=>{const e={};I.value.forEach(a=>{e[a.id]=0}),A.value=e},O=a(()=>{if("leader_roundrobin"!==S.assignType)return[];const e=[...I.value].sort((e,a)=>e.assignmentCount-a.assignmentCount),a=x.value.length,l=e.length;return e.map((e,t)=>{const s=Math.floor(a/l)+(t<a%l?1:0);return{memberName:e.name,currentCount:e.assignmentCount,willAssign:s,totalAfter:e.assignmentCount+s}})}),M=a(()=>Object.values(A.value).reduce((e,a)=>e+a,0)),j=a(()=>"leader_specific"===S.assignType?!!S.assignTo:"leader_custom"!==S.assignType||M.value===x.value.length),q=async()=>{try{U.value=!0;let e=[];if("leader_specific"===S.assignType){const a=I.value.find(e=>e.id===S.assignTo);if(!a)return void z.error("请选择有效的部门成员");e=x.value.map(e=>({dataId:e.id,assigneeId:a.id,assigneeName:a.name}))}else if("leader_roundrobin"===S.assignType){const a=[...I.value].sort((e,a)=>e.assignmentCount-a.assignmentCount);e=x.value.map((e,l)=>{const t=l%a.length,s=a[t];return{dataId:e.id,assigneeId:s.id,assigneeName:s.name}})}else{let a=0;for(const[l,t]of Object.entries(A.value)){const s=I.value.find(e=>e.id===l);if(s&&t>0)for(let l=0;l<t;l++)a<x.value.length&&(e.push({dataId:x.value[a].id,assigneeId:s.id,assigneeName:s.name}),a++)}}await C.batchAssignData({dataIds:e.map(e=>e.dataId),assigneeId:e[0].assigneeId,assigneeName:e[0].assigneeName,remark:S.remark}),z.success(`成功分配 ${e.length} 条资料`),k("assigned"),R()}catch(e){z.error("分配失败")}finally{U.value=!1}},R=()=>{V.value=!1,S.assignType="leader_roundrobin",S.assignTo="",S.remark="",$()};return h(V,e=>{e&&L()}),y(()=>{V.value&&L()}),(e,a)=>{const l=t("el-alert"),f=t("el-radio"),h=t("el-radio-group"),y=t("el-form-item"),b=t("el-option"),_=t("el-select"),k=t("el-table-column"),D=t("el-table"),C=t("el-input-number"),T=t("el-text"),N=t("el-input"),z=t("el-form"),L=t("el-divider"),$=t("el-button"),F=t("el-dialog");return n(),s(F,{modelValue:V.value,"onUpdate:modelValue":a[3]||(a[3]=e=>V.value=e),title:"部门负责人分配",width:"600px","close-on-click-modal":!1,onClose:R},{footer:r(()=>[d("div",Oa,[u($,{onClick:R},{default:r(()=>[...a[11]||(a[11]=[c("取消",-1)])]),_:1}),u($,{type:"primary",onClick:q,loading:U.value,disabled:!j.value},{default:r(()=>[...a[12]||(a[12]=[c(" 确认分配 ",-1)])]),_:1},8,["loading","disabled"])])]),default:r(()=>[d("div",xa,[d("div",Ia,[u(l,{title:"分配说明",type:"info",closable:!1,"show-icon":""},{default:r(()=>[d("p",null,[a[4]||(a[4]=c("您有 ",-1)),d("strong",null,p(x.value.length),1),a[5]||(a[5]=c(" 条待分配的客户资料",-1))]),a[6]||(a[6]=d("p",null,"请选择部门成员进行分配，系统将按轮流方式确保公平分配",-1))]),_:1})]),d("div",Na,[u(z,{model:S,"label-width":"100px"},{default:r(()=>[u(y,{label:"分配方式"},{default:r(()=>[u(h,{modelValue:S.assignType,"onUpdate:modelValue":a[0]||(a[0]=e=>S.assignType=e)},{default:r(()=>[u(f,{label:"leader_roundrobin"},{default:r(()=>[...a[7]||(a[7]=[c("轮流分配",-1)])]),_:1}),u(f,{label:"leader_specific"},{default:r(()=>[...a[8]||(a[8]=[c("指定成员",-1)])]),_:1}),u(f,{label:"leader_custom"},{default:r(()=>[...a[9]||(a[9]=[c("自定义分配",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"leader_specific"===S.assignType?(n(),s(y,{key:0,label:"选择成员"},{default:r(()=>[u(_,{modelValue:S.assignTo,"onUpdate:modelValue":a[1]||(a[1]=e=>S.assignTo=e),placeholder:"选择部门成员",style:{width:"100%"}},{default:r(()=>[(n(!0),o(v,null,g(I.value,e=>(n(),s(b,{key:e.id,label:`${e.name} (已分配: ${e.assignmentCount}条)`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):i("",!0),"leader_roundrobin"===S.assignType?(n(),s(y,{key:1,label:"分配说明"},{default:r(()=>[d("div",Sa,[u(D,{data:O.value,size:"small","max-height":"200px"},{default:r(()=>[u(k,{prop:"memberName",label:"成员",width:"120"}),u(k,{prop:"currentCount",label:"当前分配",width:"80"}),u(k,{prop:"willAssign",label:"将分配",width:"80"}),u(k,{prop:"totalAfter",label:"分配后总数",width:"100"})]),_:1},8,["data"])])]),_:1})):i("",!0),"leader_custom"===S.assignType?(n(),s(y,{key:2,label:"自定义分配"},{default:r(()=>[d("div",Aa,[(n(!0),o(v,null,g(I.value,e=>(n(),o("div",{key:e.id,class:"member-assign-item"},[d("span",za,p(e.name),1),u(C,{modelValue:A.value[e.id],"onUpdate:modelValue":a=>A.value[e.id]=a,min:0,max:x.value.length,size:"small",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue","max"]),d("span",Ua,"当前: "+p(e.assignmentCount)+"条",1)]))),128)),d("div",La,[u(T,{type:"info"},{default:r(()=>[c(" 总计分配: "+p(M.value)+" / "+p(x.value.length),1)]),_:1})])])]),_:1})):i("",!0),u(y,{label:"备注"},{default:r(()=>[u(N,{modelValue:S.remark,"onUpdate:modelValue":a[2]||(a[2]=e=>S.remark=e),type:"textarea",rows:3,placeholder:"请输入分配备注（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),d("div",$a,[u(L,{"content-position":"left"},{default:r(()=>[...a[10]||(a[10]=[c("待分配资料列表",-1)])]),_:1}),u(D,{data:x.value,size:"small","max-height":"300px"},{default:r(()=>[u(k,{prop:"customerName",label:"客户姓名",width:"120"}),u(k,{prop:"phone",label:"联系电话",width:"130"},{default:r(({row:e})=>[c(p(m(X)(e.phone,m(w).PHONE)),1)]),_:1}),u(k,{prop:"orderAmount",label:"订单金额",width:"100"},{default:r(({row:e})=>[c(" ¥"+p(e.orderAmount.toLocaleString()),1)]),_:1}),u(k,{prop:"orderDate",label:"下单时间",width:"100"},{default:r(({row:e})=>{return[c(p((a=e.orderDate,new Date(a).toLocaleDateString())),1)];var a}),_:1}),u(k,{prop:"source",label:"来源"})]),_:1},8,["data"])])])]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-374abd77"]]),ja={class:"data-list-container"},qa={class:"page-header"},Ra={class:"header-content"},Fa={class:"title-row"},Ea={class:"title-section"},Pa={class:"page-title"},Ba={key:0,class:"leader-assign-alert"},Ha={class:"alert-content"},Qa={class:"summary-cards"},Ja={class:"card-item"},Za={class:"card-icon total"},Ga={class:"card-content"},Ka={class:"card-number"},Wa={class:"card-item"},Ya={class:"card-icon pending"},Xa={class:"card-content"},el={class:"card-number"},al={class:"card-item"},ll={class:"card-icon assigned"},tl={class:"card-content"},sl={class:"card-number"},nl={class:"card-item"},rl={class:"card-icon amount"},ol={class:"card-content"},il={class:"card-number"},dl={class:"quick-filter-container"},ul={class:"quick-filters"},cl={class:"filter-buttons"},ml={class:"filter-content"},pl={class:"search-filters"},vl={class:"list-section"},gl={class:"list-header"},fl={class:"header-top-row"},hl={class:"nav-tabs"},yl=["onClick"],bl={class:"tab-label"},_l={class:"tab-count"},wl={class:"header-actions"},kl={class:"batch-operations"},Dl={class:"table-settings"},Cl={style:{display:"flex","align-items":"center",gap:"4px"}},Tl={class:"amount"},Vl={key:1,class:"self-created"},xl={class:"assign-dialog-content"},Il={class:"assign-info-section"},Nl={key:0},Sl={style:{color:"#E6A23C","margin-top":"5px"}},Al={key:1},zl={key:0,style:{"margin-top":"8px"}},Ul={style:{"margin-top":"8px"}},Ll={style:{"margin-top":"8px"}},$l={class:"member-info"},Ol={class:"member-main-info"},Ml={class:"member-name"},jl={class:"member-details"},ql={class:"member-department"},Rl={class:"member-phone"},Fl={class:"member-info"},El={class:"member-main-info"},Pl={class:"member-name"},Bl={class:"member-details"},Hl={class:"member-department"},Ql={class:"member-phone"},Jl={key:2,class:"selected-members-info",style:{"margin-top":"8px"}},Zl={key:0,class:"assign-preview-section"},Gl={class:"preview-header"},Kl={class:"header-content"},Wl={class:"target-info-compact"},Yl={class:"target-header-compact"},Xl={class:"target-title"},et={key:0,class:"target-detail-compact"},at={class:"detail-item"},lt={class:"detail-item"},tt={key:0,class:"customer-preview"},st={class:"preview-table-header"},nt={class:"table-title"},rt={class:"table-actions"},ot={key:0,class:"more-data-tip"},it={key:1,class:"remark-preview"},dt={class:"remark-header"},ut={class:"remark-content"},ct=k(e({__name:"List",setup(e){const k=K(),x=D(),I=Y(),W=b(),ee=C(W),te=a(()=>k.loading),se=l(!1),ne=l(!1),re=l(!1),oe=l(!1),ie=l(!1),de=l(null),ue=l(null),ce=l([]),me=l(),pe=a(()=>{const e=k.filteredDataList;return e&&Array.isArray(e)?{totalCount:e.length,pendingCount:e.filter(e=>"pending"===e.status).length,assignedCount:e.filter(e=>"assigned"===e.status).length,archivedCount:e.filter(e=>"archived"===e.status).length,recoveredCount:e.filter(e=>"recovered"===e.status).length,totalAmount:(e||[]).reduce((e,a)=>e+(a.orderAmount||0),0),todayCount:e.filter(e=>{const a=(new Date).toDateString();return new Date(e.orderDate).toDateString()===a}).length,weekCount:e.filter(e=>{const a=new Date;return a.setDate(a.getDate()-7),new Date(e.orderDate)>=a}).length,monthCount:e.filter(e=>{const a=new Date;return a.setMonth(a.getMonth()-1),new Date(e.orderDate)>=a}).length}:{totalCount:0,pendingCount:0,assignedCount:0,archivedCount:0,recoveredCount:0,totalAmount:0,todayCount:0,weekCount:0,monthCount:0}}),ve=a(()=>x.isSuperAdmin),ge=a(()=>x.isManager&&!ve.value),fe=a(()=>ge.value&&ce.value.length>0),he=l("today"),ye=l(null),be=l(""),_e=l(""),we=[{label:"今日",value:"today"},{label:"昨日",value:"yesterday"},{label:"本周",value:"thisWeek"},{label:"近30天",value:"last30Days"},{label:"本月",value:"thisMonth"},{label:"今年",value:"thisYear"},{label:"全部",value:"all"}],ke=l("pending"),De=a(()=>{const e=[{label:"待分配",value:"pending",count:pe.value.pendingCount},{label:"已分配",value:"assigned",count:pe.value.assignedCount}];return ge.value&&!ve.value?e:[...e,{label:"已封存",value:"archived",count:pe.value.archivedCount},{label:"已回收",value:"recovered",count:pe.value.recoveredCount}]});h(ke,e=>{k.setFilters({status:e}),Te.value=[]}),h(_e,e=>{Ve.value=1,k.setFilters({status:e})});const Ce=a(()=>k.filteredDataList),Te=l([]),Ve=l(1),xe=l(30),Ie=l([]),Ne=[{prop:"customerCode",label:"客户编码",width:140,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"customerName",label:"客户姓名",width:120,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"status",label:"状态",width:100,visible:!0,sortable:!0,showOverflowTooltip:!1},{prop:"phone",label:"手机号",width:130,visible:!0,sortable:!1,showOverflowTooltip:!0},{prop:"orderNo",label:"订单号",width:140,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"orderStatus",label:"订单状态",width:100,visible:!0,sortable:!0,showOverflowTooltip:!1},{prop:"orderAmount",label:"订单金额",width:120,visible:!0,sortable:!0,showOverflowTooltip:!1},{prop:"orderDate",label:"下单日期",width:120,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"signDate",label:"签收日期",width:120,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"allocationSource",label:"来源",width:80,visible:!0,sortable:!1,showOverflowTooltip:!1},{prop:"assigneeName",label:"归属人",width:120,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"operatorName",label:"操作人",width:120,visible:!0,sortable:!0,showOverflowTooltip:!0},{prop:"assignDate",label:"分配时间",width:120,visible:!0,sortable:!0,showOverflowTooltip:!0}],Se=a(()=>0===Ie.value.length?Ne.filter(e=>e.visible):Ne.filter(e=>Ie.value.includes(e.prop)));h([Ve,xe],([e,a])=>{k.setPagination(e,a)});const Ae=a(()=>k.total),ze=f({assignType:null,assignMode:"batch_direct",assignTo:"",assignToList:[],departmentId:"",crossDepartmentStrategy:"batch_workload",selectedDepartments:[],remark:""}),Ue=l(!1),Le=a(()=>1===Te.value.length&&"archived"===Te.value[0]?.status);a(()=>k.assigneeOptions);const $e=l([]),Oe=l(!1),Me=a(()=>I.departmentList),je=()=>{if("batch_roundrobin"===ze.assignType){const e=Me.value.find(e=>e.id===ze.departmentId);return e?e.name:"请选择部门"}if("batch_cross_department"===ze.assignType){if("batch_manual"===ze.crossDepartmentStrategy){const e=Me.value.filter(e=>ze.selectedDepartments.includes(e.id));return e.length>0?e.map(e=>e.name).join("、"):"请选择部门"}return"全部门智能分配"}if("batch_specific"===ze.assignType){const e=ga.value.find(e=>e.id===ze.assignTo);return e?`${e.name} (${e.department})`:"请选择成员"}return""},qe={batch_roundrobin:{text:"轮流分配",type:"primary"},batch_specific:{text:"指定成员",type:"success"},batch_cross_department:{text:"跨部门分配",type:"warning"}},Re=()=>ga.value.find(e=>e.id===ze.assignTo),Fe=e=>{if(!e)return"-";const a=new Date(e);return isNaN(a.getTime())?"-":`${a.getMonth()+1}/${a.getDate()}`},Ee=()=>{ie.value=!0},Pe=e=>{console.log("部门负责人分配确认:",e);const{assignments:a,assignType:l,customAssignments:t}=e;"roundrobin"===l?z.success(`已按轮流方式分配 ${a.length} 条资料`):"specific"===l?z.success(`已分配 ${a.length} 条资料给指定成员`):"custom"===l&&z.success(`已按自定义方式分配 ${t.length} 条资料`),ce.value=[],ie.value=!1,k.loadDataList()},Be=(e,a=null)=>{he.value=e||"",ye.value=a;const l={};e?l.dateFilter=e:a&&(l.dateRange=a.map(e=>e.toISOString().split("T")[0])),k.setFilters(l)},He=()=>Be(null,ye.value),Qe=()=>{Ve.value=1;const e={searchKeyword:be.value};ye.value&&(e.dateRange=ye.value.map(e=>e.toISOString().split("T")[0])),k.setFilters(e)},Je=e=>{Te.value=e},Ze=e=>{Ve.value=e},Ge=()=>{Ve.value=1},Ke=({prop:e,order:a})=>{console.log("排序变化:",e,a)},We=e=>{console.log("列设置变化:",e),Ie.value=e.filter(e=>e.visible).map(e=>e.prop)},Ye={pending:{text:"待分配",type:""},assigned:{text:"已分配",type:"success"},archived:{text:"已封存",type:"warning"},recovered:{text:"已回收",type:"info"}},Xe=e=>Ye[e]?.text||e,ea=e=>{const a=x.currentUser?.id;return e.createdBy&&e.createdBy!==a},aa=e=>(async(e,a="已复制到剪贴板")=>{try{await navigator.clipboard.writeText(e),z.success(a)}catch(l){console.error("复制失败:",l),z.error("复制失败")}})(e,"客户编码已复制到剪贴板"),la=(e,a=[])=>{try{const l=localStorage.getItem(e);return l?JSON.parse(l):a}catch(l){return console.error(`读取${e}失败:`,l),a}},ta=e=>{if(!e||"N/A"===e)return void z.warning("客户编码无效");const a=(e=>{const a=["customers","customer-store","crm_store_customer"];for(const l of a){const a=la(l,null);if(!a)continue;const t=(a.customers||a.data?.customers||(Array.isArray(a)?a:[])).find(a=>a.code===e);if(t?.id)return t}return null})(e);a?ee.push(`/customer/detail/${a.id}`):z.warning("未找到对应的客户信息")},sa={pending:{text:"待审核",type:"warning"},pending_audit:{text:"待审核",type:"warning"},approved:{text:"已审核",type:"success"},rejected:{text:"已拒绝",type:"danger"},shipped:{text:"已发货",type:"primary"},delivered:{text:"已签收",type:"success"},cancelled:{text:"已取消",type:"info"},pending_cancel:{text:"待取消",type:"warning"},refunded:{text:"已退款",type:"danger"},after_sales_created:{text:"已建售后",type:"warning"},package_exception:{text:"包裹异常",type:"danger"}},na=e=>sa[e]?.text||e||"未知",ra=e=>{if(!e||"N/A"===e)return void z.warning("订单号无效");const a=(e=>{const a=["orders","crm_store_order"];for(const l of a){const a=la(l,null);if(!a)continue;const t=(a.orders||a.data?.orders||(Array.isArray(a)?a:[])).find(a=>a.orderNo===e||a.orderNumber===e);if(t?.id)return t}return null})(e);a?ee.push(`/order/detail/${a.id}`):z.warning("未找到对应的订单信息")},oa=(e,a=!1)=>{Te.value=e,a&&(ze.assignType="batch_specific",ze.assignMode="batch_direct"),ha(),ne.value=!0},ia=()=>oa(Te.value),da=e=>oa([e]),ua=e=>{ze.assignType=null,ze.assignMode="batch_direct",ze.assignTo="",ze.assignToList=[],ze.departmentId="",ze.crossDepartmentStrategy="batch_workload",ze.selectedDepartments=[],ze.remark="",oa([e],!0)},ca=async(e,a,l,t="操作失败")=>{try{await G.confirm(e,"确认操作",{type:"warning"}),await a(),z.success(l)}catch(s){"cancel"!==s&&z.error(t)}},ma=e=>ca("确认要回收这条客户资料吗？",()=>k.recoverData(e.id),"回收成功","回收失败"),pa=e=>{ue.value=e,oe.value=!0},va=async e=>{if(ue.value)try{await k.archiveData({dataId:ue.value.id,duration:e.duration,reason:e.reason,remark:e.remark,unarchiveTime:e.unarchiveTime}),z.success("封存成功"),oe.value=!1,ue.value=null}catch(a){z.error("封存失败")}},ga=a(()=>{const e=x.users;return Array.isArray(e)&&0!==e.length?e.filter(e=>"active"===e.status).map(e=>({id:e.id,name:e.realName||e.name||e.username,account:e.username||e.id,department:e.departmentName||e.department||"未分配部门",phone:e.phone||"",status:e.status,role:e.role||"",isLeader:"department_manager"===e.role||"admin"===e.role})):(console.warn("[资料列表] 用户列表为空，请确保已加载用户数据"),[])}),ha=()=>{$e.value=ga.value.filter(e=>"active"===e.status),console.log("[资料列表] 初始化成员列表:",$e.value.length)},ya=e=>{if(console.log("[资料列表] 搜索成员:",e),!e)return void($e.value=ga.value.filter(e=>"active"===e.status));const a=e.toLowerCase();$e.value=ga.value.filter(e=>"active"===e.status&&(e.name.toLowerCase().includes(a)||e.account.toLowerCase().includes(a)||e.phone.includes(a)||e.department.toLowerCase().includes(a))),console.log("[资料列表] 搜索结果:",$e.value.length)},ba=e=>{re.value=!1,Te.value=[e],ha(),ne.value=!0},_a=e=>{re.value=!1,pa(e)},wa=async e=>{re.value=!1,await ma(e)},ka=async()=>{try{z.info("正在刷新数据..."),await k.fetchDataList(),Te.value=[],z.success("数据刷新成功")}catch(e){console.error("刷新数据失败:",e),z.error("刷新数据失败")}},Da=()=>(async(e,a)=>{const l=Te.value.length;try{await G.confirm(`确认要${e}选中的 ${l} 条资料吗？`,"确认操作",{type:"warning"});const t=Te.value.map(e=>e.id);await a(t),z.success(`${e}成功`),Te.value=[]}catch(t){"cancel"!==t&&z.error(`${e}失败`)}})("封存",e=>k.batchArchiveData({dataIds:e})),Ca=async()=>{if(Le.value){if(!ze.assignTo)return void z.warning("请选择新的负责人")}else{if(!ze.assignType)return void z.warning("请选择分配方式");if("batch_specific"===ze.assignType&&(!ze.assignToList||0===ze.assignToList.length))return void z.warning("请至少选择一位成员");if("batch_roundrobin"===ze.assignType&&!ze.departmentId)return void z.warning("请选择分配部门")}se.value=!0;try{const a=Te.value.map(e=>e.id);if(Le.value||"batch_specific"===ze.assignType)if(Le.value){const e=ga.value.find(e=>e.id===ze.assignTo);if(!e)return void z.error("分配人员信息错误");await k.batchAssignData({dataIds:a,assigneeId:ze.assignTo,assigneeName:e.name,remark:ze.remark}),z.success("成功将 "+Te.value.length+" 条资料重新分配给 "+e.name)}else{const e=ze.assignToList;if(!e||0===e.length)return void z.error("请选择分配成员");const l=ga.value.filter(a=>e.includes(a.id));if(0===l.length)return void z.error("分配人员信息错误");const t=Math.ceil(a.length/e.length);for(let s=0;s<e.length;s++){const n=s*t,r=Math.min(n+t,a.length),o=a.slice(n,r);o.length>0&&await k.batchAssignData({dataIds:o,assigneeId:e[s],assigneeName:l[s].name,remark:ze.remark})}z.success(`成功将 ${Te.value.length} 条资料分配给 ${l.length} 位成员`)}else if("batch_roundrobin"===ze.assignType){const l=Me.value.find(e=>e.id===ze.departmentId);if(!l)return void z.error("部门信息错误");try{console.log("[资料列表] 获取部门成员，部门ID:",ze.departmentId);const e=ga.value.filter(e=>e.department===l.name).map(e=>({id:e.id,name:e.name,account:e.account,department:e.department,phone:e.phone,isLeader:"department_manager"===e.role||"manager"===e.role}));if(console.log("[资料列表] 部门成员数量:",e.length),console.log("[资料列表] 部门成员:",e),0===e.length)return void z.error(`${l.name}暂无可分配成员`);const t=e.find(e=>e.isLeader)||e[0];console.log("[资料列表] 部门负责人:",t.name),await k.batchRoundRobinAssignData({dataIds:a,departmentId:ze.departmentId,departmentName:l.name,members:e,mode:ze.assignMode,leaderId:"batch_leader"===ze.assignMode?t.id:void 0,leaderName:"batch_leader"===ze.assignMode?t.name:void 0,remark:ze.remark}),"batch_leader"===ze.assignMode?z.success(`成功将 ${Te.value.length} 条资料分配给 ${l.name} 负责人 ${t.name}，请负责人进行二次分配`):z.success(`成功将 ${Te.value.length} 条资料轮流分配给 ${l.name} 的 ${e.length} 名成员`)}catch(e){return console.error("[资料列表] 获取部门成员失败:",e),void z.error("获取部门成员失败，无法进行分配")}}else if("batch_cross_department"===ze.assignType){if("batch_manual"===ze.crossDepartmentStrategy&&0===ze.selectedDepartments.length)return void z.warning("请选择参与分配的部门");let l=[];if(l="batch_manual"===ze.crossDepartmentStrategy?Me.value.filter(e=>ze.selectedDepartments.includes(e.id)):Me.value,0===l.length)return void z.error("没有可分配的部门");try{const e=[];for(const a of l){console.log("[资料列表] 获取部门成员:",a.name);const l=ga.value.filter(e=>e.department===a.name).map(e=>({id:e.id,name:e.name,account:e.account,department:e.department,phone:e.phone}));console.log("[资料列表] 部门成员数量:",l.length);const t=l.map(e=>({id:e.id,name:e.name,account:e.account,department:a.name,workload:memberStats?.totalAssigned||0,performance:memberStats?.conversionRate||0}));e.push(...t)}const t=e;if(0===t.length)return void z.error("目标部门暂无可分配成员");const s=[...t];"workload"===ze.crossDepartmentStrategy?s.sort((e,a)=>e.workload-a.workload):"performance"===ze.crossDepartmentStrategy&&s.sort((e,a)=>a.performance-e.performance);const n=[];a.forEach((e,a)=>{const l=a%s.length,t=s[l];n.push({dataId:e,assigneeId:t.id,assigneeName:t.name,department:t.department})}),await k.batchCrossDepartmentAssignData({assignments:n,strategy:ze.crossDepartmentStrategy,targetDepartments:l.map(e=>({id:e.id,name:e.name})),remark:ze.remark})}catch(e){return console.error("获取跨部门成员失败:",e),void z.error("获取跨部门成员失败，无法进行分配")}const t={workload:"工作负载均衡",performance:"业绩表现优先",manual:"手动选择部门"}[ze.crossDepartmentStrategy];z.success('成功使用"'+t+'"策略将 '+Te.value.length+" 条资料跨部门分配给 "+l.length+" 个部门的 "+sortedMembers.length+" 名成员")}ne.value=!1,Te.value=[],ze.assignType=null,ze.assignMode="batch_direct",ze.assignTo="",ze.departmentId="",ze.crossDepartmentStrategy="batch_workload",ze.selectedDepartments=[],ze.remark="",$e.value=[]}catch(e){z.error("分配失败")}finally{se.value=!1}};return y(async()=>{try{Ie.value=Ne.filter(e=>e.visible).map(e=>e.prop),await x.loadUsers(),k.setFilters({dateFilter:"today"}),await k.fetchAssigneeOptions(),I.initData(),await(async()=>{try{await k.fetchDataList()}catch(e){z.error("加载数据失败")}})(),(async()=>{if(ge.value&&!ve.value)try{const e=x.currentUser;if(!e?.id)return void(ce.value=[]);const a=(await k.getDataList({assigneeId:e.id,status:"assigned"})).list.filter(e=>"leader"===e.currentAssignment?.assignMode&&"assigned"===e.status);ce.value=a}catch(e){console.error("加载待分配数据失败:",e),ce.value=[]}else ce.value=[]})()}catch(e){z.error("初始化失败")}}),(e,a)=>{const l=t("el-icon"),f=t("el-button"),h=t("el-alert"),y=t("el-input"),b=t("el-date-picker"),D=t("el-option"),C=t("el-select"),x=t("el-card"),I=t("el-tag"),z=t("el-radio"),G=t("el-radio-group"),K=t("el-text"),W=t("el-form-item"),Y=t("el-form"),ee=t("el-table-column"),Ie=t("el-table"),la=t("el-dialog");return n(),o("div",ja,[d("div",qa,[d("div",Ra,[d("div",Fa,[d("div",Ea,[d("h1",Pa,[u(l,{class:"title-icon"},{default:r(()=>[u(m(U))]),_:1}),a[17]||(a[17]=c(" 资料列表 ",-1))]),a[18]||(a[18]=d("p",{class:"page-description"},"管理已签收客户资料，支持分配、封存和批量操作",-1))])])]),fe.value?(n(),o("div",Ba,[u(h,{title:"您有待分配的客户资料",type:"warning",closable:!1,"show-icon":""},{default:r(()=>[d("div",Ha,[d("span",null,[a[19]||(a[19]=c("您有 ",-1)),d("strong",null,p(ce.value.length),1),a[20]||(a[20]=c(" 条客户资料需要分配给部门成员",-1))]),u(f,{type:"primary",size:"small",onClick:Ee,style:{"margin-left":"15px"}},{default:r(()=>[...a[21]||(a[21]=[c(" 立即分配 ",-1)])]),_:1})])]),_:1})])):i("",!0)]),d("div",Qa,[d("div",Ja,[d("div",Za,[u(l,null,{default:r(()=>[u(m(U))]),_:1})]),d("div",Ga,[d("div",Ka,p(pe.value.totalCount),1),a[22]||(a[22]=d("div",{class:"card-label"},"资料总数",-1))])]),d("div",Wa,[d("div",Ya,[u(l,null,{default:r(()=>[u(m(L))]),_:1})]),d("div",Xa,[d("div",el,p(pe.value.pendingCount),1),a[23]||(a[23]=d("div",{class:"card-label"},"待分配",-1))])]),d("div",al,[d("div",ll,[u(l,null,{default:r(()=>[u(m(T))]),_:1})]),d("div",tl,[d("div",sl,p(pe.value.assignedCount),1),a[24]||(a[24]=d("div",{class:"card-label"},"已分配",-1))])]),d("div",nl,[d("div",rl,[u(l,null,{default:r(()=>[u(m($))]),_:1})]),d("div",ol,[d("div",il,"¥"+p(pe.value.totalAmount.toLocaleString()),1),a[25]||(a[25]=d("div",{class:"card-label"},"订单总额",-1))])])]),d("div",dl,[d("div",ul,[a[26]||(a[26]=d("span",{class:"filter-label"},"快速筛选：",-1)),d("div",cl,[(n(),o(v,null,g(we,e=>u(f,{key:e.value,type:he.value===e.value?"primary":"default",size:"small",onClick:a=>{return l=e.value,Be(l,null);var l}},{default:r(()=>[c(p(e.label),1)]),_:2},1032,["type","onClick"])),64))])])]),u(x,{class:"filter-card"},{default:r(()=>[d("div",ml,[d("div",pl,[u(y,{modelValue:be.value,"onUpdate:modelValue":a[0]||(a[0]=e=>be.value=e),placeholder:"搜索客户姓名、手机号、客户编码",onInput:Qe,class:"search-input",clearable:""},{prefix:r(()=>[u(l,null,{default:r(()=>[u(m(O))]),_:1})]),_:1},8,["modelValue"]),u(b,{modelValue:ye.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ye.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:He,class:"date-picker",size:"default"},null,8,["modelValue"]),u(C,{modelValue:_e.value,"onUpdate:modelValue":a[2]||(a[2]=e=>_e.value=e),placeholder:"状态筛选",clearable:"",class:"status-filter"},{default:r(()=>[u(D,{label:"待分配",value:"pending"}),u(D,{label:"已分配",value:"assigned"}),u(D,{label:"已封存",value:"archived"}),u(D,{label:"已回收",value:"recovered"})]),_:1},8,["modelValue"])])])]),_:1}),d("div",vl,[d("div",gl,[d("div",fl,[d("div",hl,[(n(!0),o(v,null,g(De.value,e=>(n(),o("div",{key:e.value,class:_(["nav-tab",{active:ke.value===e.value}]),onClick:a=>(e=>{ke.value=e,Ve.value=1,Te.value=[]})(e.value)},[d("span",bl,p(e.label),1),d("span",_l,p(e.count),1)],10,yl))),128))]),d("div",wl,[d("div",kl,[u(f,{type:"primary",disabled:0===Te.value.length,onClick:ia},{default:r(()=>[u(l,null,{default:r(()=>[u(m(N))]),_:1}),c(" 批量分配 ("+p(Te.value.length)+") ",1)]),_:1},8,["disabled"]),u(f,{type:"success",onClick:ka},{default:r(()=>[u(l,null,{default:r(()=>[u(m(M))]),_:1}),a[27]||(a[27]=c(" 刷新 ",-1))]),_:1}),ve.value||!ge.value?(n(),s(f,{key:0,type:"warning",disabled:0===Te.value.length,onClick:Da},{default:r(()=>[u(l,null,{default:r(()=>[u(m(V))]),_:1}),a[28]||(a[28]=c(" 批量封存 ",-1))]),_:1},8,["disabled"])):i("",!0)]),d("div",Dl,[u(le,{columns:Ne,"storage-key":"data-list-columns",onColumnsChange:We,ref_key:"columnSettingsRef",ref:me},null,512)])])])]),u(ae,{data:Ce.value,columns:Se.value,"storage-key":"data-list-columns",loading:te.value,"show-column-settings":!1,"show-selection":!0,"show-index":!1,pagination:{currentPage:Ve.value,pageSize:xe.value,total:Ae.value,pageSizes:[30,50,100]},onSelectionChange:Je,onSortChange:Ke,onSizeChange:Ge,onCurrentChange:Ze},{"column-customerCode":r(({row:e})=>[d("div",Cl,[u(f,{type:"primary",link:"",onClick:a=>ta(e.customerCode)},{default:r(()=>[c(p(e.customerCode||"N/A"),1)]),_:2},1032,["onClick"]),u(f,{type:"primary",link:"",size:"small",onClick:a=>aa(e.customerCode),title:"复制客户编码"},{default:r(()=>[u(l,null,{default:r(()=>[u(m(R))]),_:1})]),_:1},8,["onClick"])])]),"column-orderNo":r(({row:e})=>[u(f,{type:"primary",link:"",onClick:a=>ra(e.orderNo)},{default:r(()=>[c(p(e.orderNo||"N/A"),1)]),_:2},1032,["onClick"])]),"column-orderStatus":r(({row:e})=>{return[u(I,{type:(a=e.orderStatus||e.status,sa[a]?.type||"info")},{default:r(()=>[c(p(na(e.orderStatus||e.status)),1)]),_:2},1032,["type"])];var a}),"column-orderAmount":r(({row:e})=>[d("span",Tl,"¥"+p(e.orderAmount.toLocaleString()),1)]),"column-status":r(({row:e})=>{return[u(I,{type:(l=e.status,Ye[l]?.type||"")},{default:r(()=>[c(p(Xe(e.status)),1)]),_:2},1032,["type"]),e.isReassigned?(n(),s(I,{key:0,type:"warning",size:"small",style:{"margin-left":"4px"}},{default:r(()=>[...a[29]||(a[29]=[c(" 重分配 ",-1)])]),_:1})):i("",!0)];var l}),"column-allocationSource":r(({row:e})=>[ea(e)?(n(),s(I,{key:0,type:"info",size:"small"},{default:r(()=>[...a[30]||(a[30]=[c(" 分配 ",-1)])]),_:1})):(n(),o("span",Vl,"自建"))]),"column-phone":r(({row:e})=>[c(p(m(X)(e.phone,m(w).PHONE)),1)]),"column-assigneeName":r(({row:e})=>[c(p("assigned"===e.status&&e.assigneeName||"-"),1)]),"column-operatorName":r(({row:e})=>[c(p(("assigned"===e.status||"archived"===e.status)&&e.operatorName||"-"),1)]),"column-assignDate":r(({row:e})=>[c(p("pending"===e.status?e.orderDate:e.assignDate||"-"),1)]),"table-actions":r(({row:e})=>[u(f,{type:"primary",size:"small",onClick:a=>(e=>{de.value=e,re.value=!0})(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(j))]),_:1}),a[31]||(a[31]=c(" 查看 ",-1))]),_:1},8,["onClick"]),ge.value?(n(),o(v,{key:0},["pending"===e.status?(n(),s(f,{key:0,type:"success",size:"small",onClick:a=>da(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(N))]),_:1}),a[32]||(a[32]=c(" 分配 ",-1))]),_:1},8,["onClick"])):i("",!0),"assigned"===e.status?(n(),s(f,{key:1,type:"success",size:"small",onClick:a=>ua(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(N))]),_:1}),a[33]||(a[33]=c(" 重新分配 ",-1))]),_:1},8,["onClick"])):i("",!0)],64)):(n(),o(v,{key:1},["pending"===e.status?(n(),s(f,{key:0,type:"success",size:"small",onClick:a=>da(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(N))]),_:1}),a[34]||(a[34]=c(" 分配 ",-1))]),_:1},8,["onClick"])):i("",!0),"recovered"===e.status?(n(),s(f,{key:1,type:"success",size:"small",onClick:a=>ua(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(N))]),_:1}),a[35]||(a[35]=c(" 重新分配 ",-1))]),_:1},8,["onClick"])):i("",!0),"pending"!==e.status&&"recovered"!==e.status?(n(),s(f,{key:2,type:"warning",size:"small",onClick:a=>ma(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(A))]),_:1}),a[36]||(a[36]=c(" 回收 ",-1))]),_:1},8,["onClick"])):i("",!0),"recovered"===e.status?(n(),s(f,{key:3,type:"danger",size:"small",onClick:a=>(e=>ca("确认要删除这条客户资料吗？删除后将移至回收站，30天后永久删除。",()=>k.deleteData(e.id),"删除成功，已移至回收站","删除失败"))(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(q))]),_:1}),a[37]||(a[37]=c(" 删除 ",-1))]),_:1},8,["onClick"])):i("",!0),"archived"===e.status?(n(),s(f,{key:4,type:"success",size:"small",onClick:a=>ua(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(N))]),_:1}),a[39]||(a[39]=c(" 重新分配 ",-1)),e.isReassigned?(n(),s(I,{key:0,type:"info",size:"small",style:{"margin-left":"4px"}},{default:r(()=>[...a[38]||(a[38]=[c("重分",-1)])]),_:1})):i("",!0)]),_:2},1032,["onClick"])):i("",!0),"pending"===e.status||"assigned"===e.status?(n(),s(f,{key:5,type:"danger",size:"small",onClick:a=>pa(e)},{default:r(()=>[u(l,null,{default:r(()=>[u(m(S))]),_:1}),a[40]||(a[40]=c(" 封存 ",-1))]),_:1},8,["onClick"])):i("",!0)],64))]),_:1},8,["data","columns","loading","pagination"])]),u(la,{modelValue:ne.value,"onUpdate:modelValue":a[13]||(a[13]=e=>ne.value=e),title:Le.value?"重新分配资料":"部门负责人分配",width:"700px","close-on-click-modal":!1},{footer:r(()=>[u(f,{onClick:a[12]||(a[12]=e=>ne.value=!1)},{default:r(()=>[...a[64]||(a[64]=[c("取消",-1)])]),_:1}),u(f,{type:"primary",onClick:Ca,loading:se.value},{default:r(()=>[...a[65]||(a[65]=[c("确认分配",-1)])]),_:1},8,["loading"])]),default:r(()=>[d("div",xl,[d("div",Il,[u(h,{title:"分配说明",type:"info",closable:!1,"show-icon":""},{default:r(()=>[Le.value?(n(),o("div",Nl,[d("p",null,[a[41]||(a[41]=c("您有 ",-1)),d("strong",null,p(Te.value.length),1),a[42]||(a[42]=c(" 条待分配的客户资料",-1))]),d("p",Sl,[u(l,null,{default:r(()=>[u(m(F))]),_:1}),a[43]||(a[43]=c(" 重新分配后，原负责人将失去该客户的归属权 ",-1))])])):(n(),o("div",Al,[d("p",null,[a[44]||(a[44]=c("您有 ",-1)),d("strong",null,p(Te.value.length),1),a[45]||(a[45]=c(" 条待分配的客户资料",-1))]),a[46]||(a[46]=d("p",null,"请选择分配方式进行分配，系统将按轮流方式确保公平分配",-1))]))]),_:1})]),u(Y,{model:ze,"label-width":"100px"},{default:r(()=>[Le.value?i("",!0):(n(),s(W,{key:0,label:"分配方式"},{default:r(()=>[u(G,{modelValue:ze.assignType,"onUpdate:modelValue":a[3]||(a[3]=e=>ze.assignType=e)},{default:r(()=>[u(z,{label:"batch_roundrobin"},{default:r(()=>[...a[47]||(a[47]=[c("部门内轮流分配",-1)])]),_:1}),u(z,{label:"batch_specific"},{default:r(()=>[...a[48]||(a[48]=[c("指定成员分配",-1)])]),_:1}),ve.value?(n(),s(z,{key:0,label:"batch_cross_department"},{default:r(()=>[...a[49]||(a[49]=[c("跨部门智能分配",-1)])]),_:1})):i("",!0)]),_:1},8,["modelValue"]),"batch_cross_department"===ze.assignType?(n(),o("div",zl,[u(K,{type:"warning",size:"small"},{default:r(()=>[u(l,null,{default:r(()=>[u(m(F))]),_:1}),a[50]||(a[50]=c(" 超级管理员权限：可跨部门分配资料，系统将根据各部门工作负载智能分配 ",-1))]),_:1})])):i("",!0)]),_:1})),"batch_roundrobin"===ze.assignType?(n(),s(W,{key:1,label:"分配模式"},{default:r(()=>[u(G,{modelValue:ze.assignMode,"onUpdate:modelValue":a[4]||(a[4]=e=>ze.assignMode=e)},{default:r(()=>[u(z,{label:"batch_direct"},{default:r(()=>[...a[51]||(a[51]=[c("直接分配给成员",-1)])]),_:1}),u(z,{label:"batch_leader"},{default:r(()=>[...a[52]||(a[52]=[c("先分配给部门负责人",-1)])]),_:1})]),_:1},8,["modelValue"]),d("div",Ul,["batch_direct"===ze.assignMode?(n(),s(K,{key:0,type:"info",size:"small"},{default:r(()=>[...a[53]||(a[53]=[c(" 系统将按轮流顺序直接分配给部门成员，确保每个人都能轮流获得资料 ",-1)])]),_:1})):(n(),s(K,{key:1,type:"info",size:"small"},{default:r(()=>[...a[54]||(a[54]=[c(" 所有资料将先分配给部门负责人，由负责人再次分配给部门成员 ",-1)])]),_:1}))])]),_:1})):i("",!0),"batch_cross_department"===ze.assignType?(n(),s(W,{key:2,label:"分配策略"},{default:r(()=>[u(G,{modelValue:ze.crossDepartmentStrategy,"onUpdate:modelValue":a[5]||(a[5]=e=>ze.crossDepartmentStrategy=e)},{default:r(()=>[u(z,{label:"batch_workload"},{default:r(()=>[...a[55]||(a[55]=[c("按工作负载均衡",-1)])]),_:1}),u(z,{label:"batch_performance"},{default:r(()=>[...a[56]||(a[56]=[c("按业绩表现分配",-1)])]),_:1}),u(z,{label:"batch_manual"},{default:r(()=>[...a[57]||(a[57]=[c("手动选择部门",-1)])]),_:1})]),_:1},8,["modelValue"]),d("div",Ll,["batch_workload"===ze.crossDepartmentStrategy?(n(),s(K,{key:0,type:"info",size:"small"},{default:r(()=>[...a[58]||(a[58]=[c(" 系统将根据各部门当前工作负载自动分配，确保负载均衡 ",-1)])]),_:1})):"batch_performance"===ze.crossDepartmentStrategy?(n(),s(K,{key:1,type:"info",size:"small"},{default:r(()=>[...a[59]||(a[59]=[c(" 优先分配给业绩表现较好的部门，激励团队竞争 ",-1)])]),_:1})):(n(),s(K,{key:2,type:"info",size:"small"},{default:r(()=>[...a[60]||(a[60]=[c(" 手动选择要参与分配的部门，灵活控制分配范围 ",-1)])]),_:1}))])]),_:1})):i("",!0),"batch_cross_department"===ze.assignType&&"batch_manual"===ze.crossDepartmentStrategy?(n(),s(W,{key:3,label:"参与部门"},{default:r(()=>[u(C,{modelValue:ze.selectedDepartments,"onUpdate:modelValue":a[6]||(a[6]=e=>ze.selectedDepartments=e),multiple:"",placeholder:"选择参与分配的部门",style:{width:"100%"}},{default:r(()=>[(n(!0),o(v,null,g(Me.value,e=>(n(),s(D,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):i("",!0),"batch_roundrobin"===ze.assignType?(n(),s(W,{key:4,label:"选择部门"},{default:r(()=>[u(C,{modelValue:ze.departmentId,"onUpdate:modelValue":a[7]||(a[7]=e=>ze.departmentId=e),placeholder:"选择部门",style:{width:"100%"}},{default:r(()=>[(n(!0),o(v,null,g(Me.value,e=>(n(),s(D,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):i("",!0),Le.value||"batch_specific"===ze.assignType?(n(),s(W,{key:5,label:Le.value?"转移给":"指定成员"},{default:r(()=>[Le.value?(n(),s(C,{key:0,modelValue:ze.assignTo,"onUpdate:modelValue":a[8]||(a[8]=e=>ze.assignTo=e),placeholder:"选择新的负责人",style:{width:"100%"},filterable:"",remote:"","remote-method":ya,loading:Oe.value,onFocus:ha,clearable:""},{default:r(()=>[(n(!0),o(v,null,g($e.value,e=>(n(),s(D,{key:e.id,label:`${e.name} (${e.account}) - ${e.department}`,value:e.id},{default:r(()=>[d("div",$l,[d("div",Ol,[d("div",Ml,p(e.name)+" ("+p(e.account)+")",1),d("div",jl,[d("span",ql,p(e.department),1),d("span",Rl,p(e.phone),1)])])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])):(n(),s(C,{key:1,modelValue:ze.assignToList,"onUpdate:modelValue":a[9]||(a[9]=e=>ze.assignToList=e),placeholder:"搜索成员姓名、账号、手机号或部门",style:{width:"100%"},filterable:"",remote:"","remote-method":ya,loading:Oe.value,onFocus:ha,clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3},{default:r(()=>[(n(!0),o(v,null,g($e.value,e=>(n(),s(D,{key:e.id,label:`${e.name} (${e.account}) - ${e.department}`,value:e.id},{default:r(()=>[d("div",Fl,[d("div",El,[d("div",Pl,p(e.name)+" ("+p(e.account)+")",1),d("div",Bl,[d("span",Hl,p(e.department),1),d("span",Ql,p(e.phone),1)])])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])),!Le.value&&ze.assignToList.length>0?(n(),o("div",Jl,[u(K,{type:"info",size:"small"},{default:r(()=>[u(l,null,{default:r(()=>[u(m(T))]),_:1}),c(" 已选择 "+p(ze.assignToList.length)+" 位成员 ",1)]),_:1})])):i("",!0)]),_:1},8,["label"])):i("",!0),u(W,{label:"备注"},{default:r(()=>[u(y,{modelValue:ze.remark,"onUpdate:modelValue":a[10]||(a[10]=e=>ze.remark=e),type:"textarea",placeholder:"分配备注（可选）",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),ze.assignType?(n(),o("div",Zl,[d("div",Gl,[d("div",Kl,[u(l,{class:"preview-icon"},{default:r(()=>[u(m(U))]),_:1}),a[61]||(a[61]=d("h4",null,"分配预览",-1)),u(I,{type:qe[ze.assignType]?.type||"info",size:"small"},{default:r(()=>[c(p(qe[ze.assignType]?.text||"未选择"),1)]),_:1},8,["type"])]),d("div",Wl,[d("div",Yl,[u(l,{class:"target-icon"},{default:r(()=>[u(m(T))]),_:1}),d("span",Xl,p(je()),1)]),"batch_specific"===ze.assignType&&ze.assignTo?(n(),o("div",et,[d("span",at,[u(l,null,{default:r(()=>[u(m(E))]),_:1}),c(" "+p(Re()?.phone||""),1)]),d("span",lt,[u(l,null,{default:r(()=>[u(m(P))]),_:1}),c(" "+p(Re()?.department||""),1)])])):i("",!0)])]),Te.value.length>0?(n(),o("div",tt,[d("div",st,[d("div",nt,[u(l,null,{default:r(()=>[u(m(B))]),_:1}),a[62]||(a[62]=d("span",null,"客户详情预览",-1))]),d("div",rt,[u(f,{size:"small",text:"",onClick:a[11]||(a[11]=e=>Ue.value=!Ue.value)},{default:r(()=>[c(p(Ue.value?"收起":"展开")+" ",1),u(l,null,{default:r(()=>[Ue.value?(n(),s(m(Q),{key:1})):(n(),s(m(H),{key:0}))]),_:1})]),_:1})])]),d("div",{class:_(["preview-table-container",{expanded:Ue.value}])},[u(Ie,{data:Te.value.slice(0,Ue.value?Te.value.length:3),size:"small",stripe:"","max-height":Ue.value?400:200,class:"preview-table"},{default:r(()=>[u(ee,{prop:"customerName",label:"客户姓名",width:"100","show-overflow-tooltip":""}),u(ee,{prop:"phone",label:"联系电话",width:"120","show-overflow-tooltip":""}),u(ee,{prop:"orderAmount",label:"订单金额",width:"100",align:"right"},{default:r(e=>[d("span",{class:_(["amount-text",{"high-value":e.row.orderAmount>=5e4}])}," ¥"+p(e.row.orderAmount.toLocaleString()),3)]),_:1}),u(ee,{prop:"source",label:"来源",width:"80","show-overflow-tooltip":""}),u(ee,{prop:"status",label:"状态",width:"80"},{default:r(e=>{return[u(I,{size:"small",type:(a=e.row.status,Ye[a]?.type||"info")},{default:r(()=>[c(p(e.row.status),1)]),_:2},1032,["type"])];var a}),_:1}),u(ee,{prop:"createTime",label:"创建时间",width:"100","show-overflow-tooltip":""},{default:r(e=>[c(p(Fe(e.row.createTime)),1)]),_:1})]),_:1},8,["data","max-height"]),!Ue.value&&Te.value.length>3?(n(),o("div",ot,[u(K,{type:"info",size:"small"},{default:r(()=>[u(l,null,{default:r(()=>[u(m(J))]),_:1}),c(" 还有 "+p(Te.value.length-3)+" 条客户数据，点击展开查看全部 ",1)]),_:1})])):i("",!0)],2)])):i("",!0),ze.remark?(n(),o("div",it,[d("div",dt,[u(l,null,{default:r(()=>[u(m(Z))]),_:1}),a[63]||(a[63]=d("span",null,"分配备注",-1))]),d("div",ut,p(ze.remark),1)])):i("",!0)])):i("",!0)])]),_:1},8,["modelValue","title"]),u(fa,{modelValue:re.value,"onUpdate:modelValue":a[14]||(a[14]=e=>re.value=e),"customer-data":de.value,onQuickAssign:ba,onQuickArchive:_a,onQuickRecover:wa},null,8,["modelValue","customer-data"]),u(Va,{modelValue:oe.value,"onUpdate:modelValue":a[15]||(a[15]=e=>oe.value=e),"customer-data":ue.value,onConfirm:va},null,8,["modelValue","customer-data"]),u(Ma,{modelValue:ie.value,"onUpdate:modelValue":a[16]||(a[16]=e=>ie.value=e),"pending-assignments":ce.value,onConfirm:Pe},null,8,["modelValue","pending-assignments"])])}}}),[["__scopeId","data-v-1b8eb92f"]]);export{ct as default};
