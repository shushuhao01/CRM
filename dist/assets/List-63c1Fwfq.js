import{l as e,aA as a,e as l,r,Z as t,w as s,b as o,ag as i,m as n,q as d,p as u,U as c,O as m,u as p,S as v,M as b,Q as y,T as g,F as f,a9 as h,n as _}from"./vendor-BtukhyiH.js";import{F as w,r as N,C as T,G as k,aq as V,E as I,b as S}from"./elementPlus-DxaqjplL.js";import{u as C}from"./service-BjC45aOM.js";import{b as x,u as U,S as $,c as E,_ as D}from"./index-C4IdUW1A.js";import{useDepartmentStore as A}from"./department-CMDKNhTn.js";import{a as P}from"./sensitiveInfo-CTSC2tj2.js";import{D as z}from"./DynamicTable-DpwT2Ioj.js";import"./env-DLalhsF6.js";import"./utils-DfI7e5Rl.js";import"./TableColumnSettings-NQCH9NUW.js";const j={class:"service-list-container"},M={class:"tabs-action-bar"},R={class:"tab-label"},q={class:"tab-label"},L={class:"action-buttons"},O=D(e({name:"ServiceList",__name:"List",setup(e){const D=a(),O=E(D),F=C(),B=x(),G=U(),W=A(),H=l(()=>{const e=G.currentUser;if(!e)return!1;const a=e.role||e.roleId||"";return["super_admin","superadmin","admin","service","customer_service"].includes(a)}),Q=r(!1),Z=r(!1),J=r(!1),K=r(!1),X=r(!1),Y=r("pending"),ee=t({orderNumber:"",customerName:"",serviceType:"",status:"",dateRange:[]}),ae=t({currentPage:1,pageSize:20,total:0}),le=l(()=>{let e=F.services||[];return e=e.filter(e=>e.status===Y.value),ee.orderNumber&&(e=e.filter(e=>e.orderNumber.includes(ee.orderNumber))),ee.customerName&&(e=e.filter(e=>e.customerName.includes(ee.customerName))),ee.serviceType&&(e=e.filter(e=>e.serviceType===ee.serviceType)),e}),re=l(()=>({currentPage:ae.currentPage,pageSize:ae.pageSize,total:ae.total,pageSizes:[10,20,50,100]})),te=r([]),se=t({assignType:"user",userId:"",departmentId:"",filterDepartmentId:"",remark:""}),oe=t({priority:"",remark:""}),ie=r(null),ne=l(()=>(G.users||[]).map(e=>{const a=e.name||e.username||e.realName||`用户${e.id}`,l=e.departmentName||e.department||e.deptName||"未分配部门";return{id:e.id,name:a,department:l,roleId:e.roleId,role:e.role}})),de=l(()=>(W.departments||[]).map(e=>({id:e.id,name:e.name}))),ue=l(()=>{if(!se.filterDepartmentId)return ne.value;const e=de.value.find(e=>e.id===se.filterDepartmentId);return e?ne.value.filter(a=>a.department===e.name||a.department===e.id||a.department&&a.department.includes(e.name)):ne.value}),ce=l(()=>[{prop:"serviceNumber",label:"售后单号",width:160,visible:!0,sortable:!0},{prop:"orderNumber",label:"原订单号",width:160,visible:!0,slot:"orderNumber"},{prop:"customerName",label:"客户姓名",width:120,visible:!0,slot:"customerName"},{prop:"customerPhone",label:"联系电话",width:130,visible:!0,slot:"customerPhone"},{prop:"serviceType",label:"服务类型",width:100,visible:!0,slot:"serviceType"},{prop:"productName",label:"商品名称",minWidth:150,visible:!0,showOverflowTooltip:!0},{prop:"reason",label:"申请原因",minWidth:150,visible:!0,showOverflowTooltip:!0,slot:"reason"},{prop:"status",label:"处理状态",width:100,visible:!0,slot:"status"},{prop:"priority",label:"优先级",width:100,visible:!0,slot:"priority"},{prop:"assignedTo",label:"处理人",width:100,visible:!0},{prop:"createTime",label:"创建时间",width:160,visible:!0,sortable:!0},{prop:"updateTime",label:"更新时间",width:160,visible:!0,sortable:!0}]);l(()=>te.value.length>0);const me=l(()=>F.services.filter(e=>"pending"===e.status).length),pe=l(()=>F.services.filter(e=>"processing"===e.status).length);l(()=>F.services.filter(e=>"resolved"===e.status).length),l(()=>F.services.filter(e=>"closed"===e.status).length);const ve=e=>{Y.value=e,ee.status=e,ae.currentPage=1,Ue()},be=()=>{ae.currentPage=1,Ue()},ye=()=>{Object.assign(ee,{orderNumber:"",customerName:"",serviceType:"",status:"",dateRange:[]}),be()},ge=()=>{Ue()},fe=()=>{O.push("/service/add")},he=e=>{O.push(`/service/detail/${e.id}`)},_e=()=>{I.success("导出功能开发中...")},we=e=>{te.value=e},Ne=({column:e,prop:a,order:l})=>{console.log("排序变化:",{column:e,prop:a,order:l}),Ue()},Te=e=>{ae.pageSize=e,Ue()},ke=e=>{ae.currentPage=e,Ue()},Ve=()=>{se.userId=""},Ie=async()=>{let e="";if("user"===se.assignType){if(!se.userId)return void I.warning("请选择处理人");const a=ne.value.find(e=>e.id===se.userId);e=a?.name||""}else{if(!se.departmentId)return void I.warning("请选择部门");const a=de.value.find(e=>e.id===se.departmentId),l=ne.value.filter(e=>e.department===a?.name);if(0===l.length)return void I.warning("该部门下没有可分配的用户");e=l[Math.floor(Math.random()*l.length)].name}Z.value=!0;try{await F.assignService(ie.value.id,e,se.userId||void 0,se.remark||void 0),B.sendMessage(B.MessageType.AFTER_SALES_ASSIGNED,`售后申请 ${ie.value.serviceNumber} 已分配给 ${e}，客户：${ie.value.customerName}`,{relatedId:ie.value.serviceNumber,relatedType:"service",actionUrl:`/service/detail/${ie.value.serviceNumber}`,metadata:{customerName:ie.value.customerName,serviceType:ie.value.serviceType,assignedTo:e}}),I.success("分配成功"),K.value=!1,se.assignedTo="",se.remark=""}catch(a){console.error("分配失败:",a),I.error(`分配失败: ${a.message||a}`)}finally{Z.value=!1}},Se=async()=>{if(ie.value)if(oe.priority){J.value=!0;try{await F.setServicePriority(ie.value.id,oe.priority,oe.remark||void 0);const e=Ae(oe.priority);B.sendMessage(B.MessageType.AFTER_SALES_CREATED,`售后申请 ${ie.value.serviceNumber} 优先级已设置为${e}，客户：${ie.value.customerName}`,{relatedId:ie.value.serviceNumber,relatedType:"service",actionUrl:`/service/detail/${ie.value.serviceNumber}`}),I.success("优先级设置成功"),X.value=!1,await Ue()}catch(e){console.error("设置优先级失败:",e),I.error("设置优先级失败")}finally{J.value=!1}}else I.warning("请选择优先级");else I.error("请先选择售后记录")},Ce=async e=>{S.confirm("确定要关闭这个售后单吗？关闭后将无法继续处理。","确认关闭",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await F.updateServiceStatus(e.id,"closed","手动关闭"),B.sendMessage(B.MessageType.AFTER_SALES_CLOSED,`售后申请 ${e.serviceNumber} 已关闭，客户：${e.customerName}`,{relatedId:e.serviceNumber,relatedType:"service",actionUrl:`/service/detail/${e.serviceNumber}`,metadata:{customerName:e.customerName,serviceType:e.serviceType,closedAt:(new Date).toISOString()}}),I.success("售后单已关闭")}catch(a){I.error("关闭售后单失败"),console.error("关闭售后单失败:",a)}})},xe=async e=>{S.confirm("确定要删除这个售后单吗？删除后无法恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await F.deleteService(e.id),ae.total=F.afterSalesServices.length,B.sendMessage(B.MessageType.AFTER_SALES_DELETED,`售后申请 ${e.serviceNumber} 已删除，客户：${e.customerName}`,{relatedId:e.serviceNumber,relatedType:"service",actionUrl:"/service/list",metadata:{customerName:e.customerName,serviceType:e.serviceType,deletedAt:(new Date).toISOString()}}),I.success("删除成功")}catch(a){I.error("删除售后单失败"),console.error("删除售后单失败:",a)}})},Ue=async()=>{Q.value=!0;try{await F.loadAfterSalesServices(),await _(()=>{ae.total=le.value.length})}catch(e){console.error("加载数据失败:",e),I.error("加载数据失败")}finally{Q.value=!1}},$e=e=>{if(!e)return"未知原因";return{quality_issue:"质量问题",damaged:"商品损坏",not_as_described:"描述不符",wrong_item:"发错商品",logistics_damage:"物流损坏",not_satisfied:"不满意",size_issue:"尺寸问题",color_issue:"颜色问题",defective:"商品缺陷",expired:"商品过期",other:"其他原因",quality:"质量问题",damage:"商品损坏",wrong:"发错商品",size:"尺寸不符",description:"描述不符",logistics:"物流问题",complaint:"投诉",return:"退货",exchange:"换货",refund:"退款",repair:"维修",inquiry:"咨询",osmogd:"其他原因"}[e]||e},Ee=e=>({return:"退货",exchange:"换货",repair:"维修",complaint:"投诉",inquiry:"咨询",refund:"退款"}[e]||e),De=e=>{if(!e)return"未知状态";return{pending:"待处理",processing:"处理中",resolved:"已解决",completed:"已完成",closed:"已关闭",cancelled:"已取消"}[e]||e},Ae=e=>{if(!e)return"普通";return{low:"低",normal:"普通",medium:"中",high:"高",urgent:"紧急"}[e]||e};return s([()=>F.services,()=>Y.value,()=>ee.orderNumber,()=>ee.customerName,()=>ee.serviceType],()=>{_(()=>{ae.total=le.value.length,console.log("统计数量更新:",ae.total)})},{immediate:!0}),o(async()=>{await G.loadUsers(),Ue()}),(e,a)=>{const l=i("el-input"),r=i("el-form-item"),t=i("el-option"),s=i("el-select"),o=i("el-date-picker"),_=i("el-button"),S=i("el-form"),C=i("el-card"),x=i("el-badge"),U=i("el-tab-pane"),E=i("el-tabs"),D=i("el-link"),A=i("el-tag"),F=i("el-dropdown-item"),B=i("el-dropdown-menu"),G=i("el-dropdown"),W=i("el-radio"),ae=i("el-radio-group"),te=i("el-dialog");return d(),n("div",j,[a[41]||(a[41]=u("div",{class:"page-header"},[u("h2",null,"售后订单"),u("p",null,"管理和跟踪所有售后服务请求")],-1)),c(C,{class:"search-card",shadow:"never"},{default:m(()=>[c(S,{model:ee,inline:""},{default:m(()=>[c(r,{label:"订单号"},{default:m(()=>[c(l,{modelValue:ee.orderNumber,"onUpdate:modelValue":a[0]||(a[0]=e=>ee.orderNumber=e),placeholder:"请输入订单号",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),c(r,{label:"客户姓名"},{default:m(()=>[c(l,{modelValue:ee.customerName,"onUpdate:modelValue":a[1]||(a[1]=e=>ee.customerName=e),placeholder:"请输入客户姓名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),c(r,{label:"服务类型"},{default:m(()=>[c(s,{modelValue:ee.serviceType,"onUpdate:modelValue":a[2]||(a[2]=e=>ee.serviceType=e),placeholder:"请选择服务类型",clearable:"",style:{width:"150px"}},{default:m(()=>[c(t,{label:"退货",value:"return"}),c(t,{label:"换货",value:"exchange"}),c(t,{label:"维修",value:"repair"}),c(t,{label:"投诉",value:"complaint"}),c(t,{label:"咨询",value:"inquiry"})]),_:1},8,["modelValue"])]),_:1}),c(r,{label:"处理状态"},{default:m(()=>[c(s,{modelValue:ee.status,"onUpdate:modelValue":a[3]||(a[3]=e=>ee.status=e),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:m(()=>[c(t,{label:"待处理",value:"pending"}),c(t,{label:"处理中",value:"processing"}),c(t,{label:"已完成",value:"completed"}),c(t,{label:"已关闭",value:"closed"})]),_:1},8,["modelValue"])]),_:1}),c(r,{label:"创建时间"},{default:m(()=>[c(o,{modelValue:ee.dateRange,"onUpdate:modelValue":a[4]||(a[4]=e=>ee.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),c(r,null,{default:m(()=>[c(_,{type:"primary",icon:p(w),onClick:be},{default:m(()=>[...a[17]||(a[17]=[v(" 搜索 ",-1)])]),_:1},8,["icon"]),c(_,{icon:p(N),onClick:ye},{default:m(()=>[...a[18]||(a[18]=[v(" 重置 ",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),u("div",M,[c(E,{modelValue:Y.value,"onUpdate:modelValue":a[5]||(a[5]=e=>Y.value=e),onTabChange:ve,class:"service-tabs"},{default:m(()=>[c(U,{label:"待处理",name:"pending"},{label:m(()=>[u("span",R,[a[19]||(a[19]=v(" 待处理 ",-1)),me.value>0?(d(),b(x,{key:0,value:me.value,max:99,type:"danger"},null,8,["value"])):y("",!0)])]),_:1}),c(U,{label:"处理中",name:"processing"},{label:m(()=>[u("span",q,[a[20]||(a[20]=v(" 处理中 ",-1)),pe.value>0?(d(),b(x,{key:0,value:pe.value,max:99,type:"primary"},null,8,["value"])):y("",!0)])]),_:1}),c(U,{label:"已解决",name:"resolved"},{label:m(()=>[...a[21]||(a[21]=[u("span",{class:"tab-label"},"已解决",-1)])]),_:1}),c(U,{label:"已关闭",name:"closed"},{label:m(()=>[...a[22]||(a[22]=[u("span",{class:"tab-label"},"已关闭",-1)])]),_:1})]),_:1},8,["modelValue"]),u("div",L,[c(_,{type:"primary",icon:p(T),onClick:fe},{default:m(()=>[...a[23]||(a[23]=[v(" 新建售后 ",-1)])]),_:1},8,["icon"]),c(_,{icon:p(k),onClick:_e},{default:m(()=>[...a[24]||(a[24]=[v(" 导出数据 ",-1)])]),_:1},8,["icon"]),c(_,{icon:p(N),onClick:ge,style:{"margin-left":"12px"}},null,8,["icon"])])]),c(z,{data:le.value,columns:ce.value,"storage-key":"service-list-columns",title:"售后订单列表",loading:Q.value,"show-selection":!0,"show-index":!0,pagination:re.value,onSelectionChange:we,onSortChange:Ne,onSizeChange:Te,onCurrentChange:ke},{"column-serviceNumber":m(({row:e})=>[c(D,{type:"primary",onClick:a=>he(e)},{default:m(()=>[v(g(e.serviceNumber),1)]),_:2},1032,["onClick"])]),"column-orderNumber":m(({row:e})=>[c(D,{type:"primary",onClick:a=>(e=>{e.orderId?O.push(`/order/detail/${e.orderId}`):e.orderNumber?O.push(`/order/detail/${e.orderNumber}`):I.warning("订单信息不完整,无法跳转")})(e)},{default:m(()=>[v(g(e.orderNumber),1)]),_:2},1032,["onClick"])]),"column-customerName":m(({row:e})=>[c(D,{type:"primary",onClick:a=>(e=>{e.customerId?O.push(`/customer/detail/${e.customerId}`):I.warning("客户信息不完整,无法跳转")})(e)},{default:m(()=>[v(g(e.customerName),1)]),_:2},1032,["onClick"])]),"column-customerPhone":m(({row:e})=>[v(g(p(P)(e.customerPhone,p($).PHONE)),1)]),"column-serviceType":m(({row:e})=>{return[c(A,{type:(a=e.serviceType,{return:"danger",exchange:"warning",repair:"info",complaint:"danger",inquiry:"success"}[a]||"")},{default:m(()=>[v(g(Ee(e.serviceType)),1)]),_:2},1032,["type"])];var a}),"column-reason":m(({row:e})=>[v(g($e(e.reason)),1)]),"column-status":m(({row:e})=>{return[c(A,{type:(a=e.status,{pending:"warning",processing:"primary",resolved:"success",completed:"success",closed:"info",cancelled:"info"}[a]||"")},{default:m(()=>[v(g(De(e.status)),1)]),_:2},1032,["type"])];var a}),"column-priority":m(({row:e})=>{return[c(A,{type:(a=e.priority,{low:"info",normal:"",medium:"",high:"warning",urgent:"danger"}[a]||""),size:"small"},{default:m(()=>[v(g(Ae(e.priority)),1)]),_:2},1032,["type"])];var a}),"table-actions":m(({row:e})=>[c(_,{size:"small",type:"primary",onClick:a=>he(e)},{default:m(()=>[...a[25]||(a[25]=[v(" 查看 ",-1)])]),_:1},8,["onClick"]),H.value&&"completed"!==e.status?(d(),b(_,{key:0,size:"small",onClick:a=>(e=>{O.push(`/service/edit/${e.id}`)})(e)},{default:m(()=>[...a[26]||(a[26]=[v(" 编辑 ",-1)])]),_:1},8,["onClick"])):y("",!0),H.value?(d(),b(G,{key:1,onCommand:a=>((e,a)=>{switch(ie.value=a,e){case"assign":se.assignType="user",se.userId="",se.departmentId="",se.filterDepartmentId="",se.remark="",K.value=!0;break;case"priority":oe.priority=a.priority||"normal",oe.remark="",X.value=!0;break;case"close":Ce(a);break;case"delete":xe(a)}})(a,e)},{dropdown:m(()=>[c(B,null,{default:m(()=>[c(F,{command:"assign"},{default:m(()=>[...a[27]||(a[27]=[v("分配处理人",-1)])]),_:1}),c(F,{command:"priority"},{default:m(()=>[...a[28]||(a[28]=[v("设置优先级",-1)])]),_:1}),"closed"!==e.status?(d(),b(F,{key:0,command:"close"},{default:m(()=>[...a[29]||(a[29]=[v("关闭",-1)])]),_:1})):y("",!0),c(F,{command:"delete",divided:""},{default:m(()=>[...a[30]||(a[30]=[v("删除",-1)])]),_:1})]),_:2},1024)]),default:m(()=>[c(_,{size:"small",icon:p(V)},null,8,["icon"])]),_:2},1032,["onCommand"])):y("",!0)]),_:1},8,["data","columns","loading","pagination"]),c(te,{modelValue:K.value,"onUpdate:modelValue":a[12]||(a[12]=e=>K.value=e),title:"分配处理人",width:"500px"},{footer:m(()=>[c(_,{onClick:a[11]||(a[11]=e=>K.value=!1)},{default:m(()=>[...a[33]||(a[33]=[v("取消",-1)])]),_:1}),c(_,{type:"primary",onClick:Ie,loading:Z.value},{default:m(()=>[...a[34]||(a[34]=[v(" 确定分配 ",-1)])]),_:1},8,["loading"])]),default:m(()=>[c(S,{model:se,"label-width":"100px"},{default:m(()=>[c(r,{label:"分配方式"},{default:m(()=>[c(ae,{modelValue:se.assignType,"onUpdate:modelValue":a[6]||(a[6]=e=>se.assignType=e)},{default:m(()=>[c(W,{label:"user"},{default:m(()=>[...a[31]||(a[31]=[v("指定用户",-1)])]),_:1}),c(W,{label:"department"},{default:m(()=>[...a[32]||(a[32]=[v("部门随机",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"user"===se.assignType?(d(),b(r,{key:0,label:"筛选部门"},{default:m(()=>[c(s,{modelValue:se.filterDepartmentId,"onUpdate:modelValue":a[7]||(a[7]=e=>se.filterDepartmentId=e),placeholder:"全部部门",clearable:"",style:{width:"100%"},onChange:Ve},{default:m(()=>[c(t,{label:"全部部门",value:""}),(d(!0),n(f,null,h(de.value,e=>(d(),b(t,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):y("",!0),"user"===se.assignType?(d(),b(r,{key:1,label:"选择用户"},{default:m(()=>[c(s,{modelValue:se.userId,"onUpdate:modelValue":a[8]||(a[8]=e=>se.userId=e),placeholder:"请选择处理人",filterable:"",style:{width:"100%"}},{default:m(()=>[(d(!0),n(f,null,h(ue.value,e=>(d(),b(t,{key:e.id,label:`${e.name} (${e.department||"未分配部门"})`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):y("",!0),"department"===se.assignType?(d(),b(r,{key:2,label:"选择部门"},{default:m(()=>[c(s,{modelValue:se.departmentId,"onUpdate:modelValue":a[9]||(a[9]=e=>se.departmentId=e),placeholder:"请选择部门",style:{width:"100%"}},{default:m(()=>[(d(!0),n(f,null,h(de.value,e=>(d(),b(t,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):y("",!0),c(r,{label:"备注"},{default:m(()=>[c(l,{modelValue:se.remark,"onUpdate:modelValue":a[10]||(a[10]=e=>se.remark=e),type:"textarea",rows:3,placeholder:"请输入分配备注(可选)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),c(te,{modelValue:X.value,"onUpdate:modelValue":a[16]||(a[16]=e=>X.value=e),title:"设置优先级",width:"400px"},{footer:m(()=>[c(_,{onClick:a[15]||(a[15]=e=>X.value=!1)},{default:m(()=>[...a[39]||(a[39]=[v("取消",-1)])]),_:1}),c(_,{type:"primary",onClick:Se,loading:J.value},{default:m(()=>[...a[40]||(a[40]=[v(" 确定 ",-1)])]),_:1},8,["loading"])]),default:m(()=>[c(S,{model:oe,"label-width":"80px"},{default:m(()=>[c(r,{label:"优先级"},{default:m(()=>[c(ae,{modelValue:oe.priority,"onUpdate:modelValue":a[13]||(a[13]=e=>oe.priority=e)},{default:m(()=>[c(W,{label:"low"},{default:m(()=>[...a[35]||(a[35]=[v("低",-1)])]),_:1}),c(W,{label:"normal"},{default:m(()=>[...a[36]||(a[36]=[v("普通",-1)])]),_:1}),c(W,{label:"high"},{default:m(()=>[...a[37]||(a[37]=[v("高",-1)])]),_:1}),c(W,{label:"urgent"},{default:m(()=>[...a[38]||(a[38]=[v("紧急",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),c(r,{label:"备注"},{default:m(()=>[c(l,{modelValue:oe.remark,"onUpdate:modelValue":a[14]||(a[14]=e=>oe.remark=e),type:"textarea",rows:3,placeholder:"请输入设置原因(可选)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-ad910adc"]]);export{O as default};
