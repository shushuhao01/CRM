var B=(U,N,v)=>new Promise((C,b)=>{var x=u=>{try{f(v.next(u))}catch(_){b(_)}},i=u=>{try{f(v.throw(u))}catch(_){b(_)}},f=u=>u.done?C(u.value):Promise.resolve(u.value).then(x,i);f((v=v.apply(U,N)).next())});import{K as V,c as oe,a1 as ie,s as de,aB as I,ai as re,Q as ue,E as D,b as ce}from"./elementPlus-Bmwh7Rh8.js";import{u as ve}from"./data-D5rIftf7.js";import{a as pe}from"./sensitiveInfo-BWt1a88R.js";import{S as me,_ as fe}from"./settings-CuxbDWOu.js";import{l as _e,r as m,e as P,c as ge,ag as y,aq as he,m as F,p as S,q as l,U as t,S as d,O as s,u as c,T as r,F as we,a9 as ye,M,P as De,J as be}from"./vendor-D8Vxqhr-.js";import"./utils-ywHRn0uI.js";const Ce={class:"recycle-container"},xe={class:"page-header"},ke={class:"header-content"},Ae={class:"page-title"},Te={class:"summary-cards"},Be={class:"card-item"},Ve={class:"card-icon total"},Se={class:"card-content"},Ne={class:"card-number"},ze={class:"card-item"},Re={class:"card-icon recent"},Pe={class:"card-content"},Ue={class:"card-number"},Le={class:"card-item"},$e={class:"card-icon warning"},Ee={class:"card-content"},Ie={class:"card-number"},Fe={class:"filter-section"},Me={class:"filter-row"},qe={class:"search-group"},Ke={class:"filter-group"},Oe={class:"list-section"},je={class:"list-header"},He={class:"list-info"},Je={class:"total-count"},Qe={class:"list-actions"},Ye={class:"table-container"},Ge={class:"amount"},We={class:"delete-reason"},Xe={class:"pagination-container"},Ze={class:"delete-warning"},et={class:"warning-content"},tt=_e({__name:"Recycle",setup(U){const N=ve(),v=m(!1),C=m(""),b=m(""),x=m(""),i=m([]),f=m(1),u=m(20),_=m(!1),k=m(!1),p=m([{id:"1",customerName:"张三",phone:"13800138001",orderAmount:5e3,orderDate:"2024-01-15",deletedAt:"2024-01-20T10:30:00",deletedBy:"user1",deletedByName:"李经理",deleteReason:"重复资料",expiresAt:"2024-02-20T10:30:00"},{id:"2",customerName:"李四",phone:"13800138002",orderAmount:3e3,orderDate:"2024-01-10",deletedAt:"2024-01-18T14:20:00",deletedBy:"user2",deletedByName:"王主管",deleteReason:"客户要求删除",expiresAt:"2024-02-18T14:20:00"},{id:"3",customerName:"王五",phone:"13800138003",orderAmount:8e3,orderDate:"2024-01-05",deletedAt:"2024-01-25T09:15:00",deletedBy:"user1",deletedByName:"李经理",deleteReason:"无效订单",expiresAt:"2024-02-25T09:15:00"}]),q=m([{id:"user1",name:"李经理"},{id:"user2",name:"王主管"},{id:"user3",name:"张组长"}]),z=P(()=>{const a=new Date,e=new Date(a.getTime()-7*24*60*60*1e3),o=new Date(a.getTime()+3*24*60*60*1e3);return{totalCount:p.value.length,recentCount:p.value.filter(h=>new Date(h.deletedAt)>=e).length,expiringSoonCount:p.value.filter(h=>new Date(h.expiresAt)<=o).length}}),R=P(()=>{let a=p.value;if(C.value){const e=C.value.toLowerCase();a=a.filter(o=>o.customerName.toLowerCase().includes(e)||o.phone.includes(e))}if(b.value){const e=new Date;let o;switch(b.value){case"today":o=new Date(e.getFullYear(),e.getMonth(),e.getDate());break;case"week":o=new Date(e.getTime()-7*24*60*60*1e3);break;case"month":o=new Date(e.getTime()-30*24*60*60*1e3);break;default:o=new Date(0)}a=a.filter(h=>new Date(h.deletedAt)>=o)}return x.value&&(a=a.filter(e=>e.deletedBy===x.value)),a}),K=P(()=>{const a=(f.value-1)*u.value,e=a+u.value;return R.value.slice(a,e)}),O=()=>{f.value=1},j=a=>{i.value=a},H=a=>{u.value=a,f.value=1},J=a=>{f.value=a},Q=a=>a?new Date(a).toLocaleDateString("zh-CN"):"-",L=a=>a?new Date(a).toLocaleString("zh-CN"):"-",Y=a=>{const e=new Date,o=new Date(a),h=new Date(e.getTime()+3*24*60*60*1e3);return o<=e?"expired":o<=h?"expiring-soon":""},G=a=>{i.value=[a],_.value=!0},W=()=>{if(i.value.length===0){D.warning("请选择要恢复的记录");return}_.value=!0},X=()=>B(this,null,function*(){try{v.value=!0;for(const e of i.value)yield N.recoverData(e.id,"从回收站恢复");const a=i.value.map(e=>e.id);p.value=p.value.filter(e=>!a.includes(e.id)),D.success(`成功恢复 ${i.value.length} 条记录到已回收列表`),_.value=!1,i.value=[]}catch(a){D.error("恢复失败，请重试")}finally{v.value=!1}}),Z=a=>{i.value=[a],k.value=!0},ee=()=>{if(i.value.length===0){D.warning("请选择要删除的记录");return}k.value=!0},te=()=>B(this,null,function*(){try{v.value=!0,yield new Promise(e=>setTimeout(e,1e3));const a=i.value.map(e=>e.id);p.value=p.value.filter(e=>!a.includes(e.id)),D.success(`成功删除 ${i.value.length} 条记录`),k.value=!1,i.value=[]}catch(a){D.error("删除失败，请重试")}finally{v.value=!1}}),le=()=>B(this,null,function*(){const a=new Date,e=p.value.filter(o=>new Date(o.expiresAt)<=a);if(e.length===0){D.info("没有过期的记录");return}try{yield ce.confirm(`发现 ${e.length} 条过期记录，确定要清理吗？`,"清理过期记录",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),v.value=!0,yield new Promise(o=>setTimeout(o,1e3)),p.value=p.value.filter(o=>new Date(o.expiresAt)>a),D.success(`成功清理 ${e.length} 条过期记录`)}catch(o){}finally{v.value=!1}});return ge(()=>{}),(a,e)=>{const o=y("el-icon"),h=y("el-input"),A=y("el-option"),$=y("el-select"),w=y("el-button"),g=y("el-table-column"),ae=y("el-table"),ne=y("el-pagination"),E=y("el-dialog"),se=he("loading");return S(),F("div",Ce,[l("div",xe,[l("div",ke,[l("h1",Ae,[t(o,{class:"title-icon"},{default:s(()=>[t(c(V))]),_:1}),e[9]||(e[9]=d(" 回收站 ",-1))]),e[10]||(e[10]=l("p",{class:"page-description"},"管理已删除的客户资料，支持恢复和永久删除操作",-1))])]),l("div",Te,[l("div",Be,[l("div",Ve,[t(o,null,{default:s(()=>[t(c(V))]),_:1})]),l("div",Se,[l("div",Ne,r(z.value.totalCount),1),e[11]||(e[11]=l("div",{class:"card-label"},"回收总数",-1))])]),l("div",ze,[l("div",Re,[t(o,null,{default:s(()=>[t(c(oe))]),_:1})]),l("div",Pe,[l("div",Ue,r(z.value.recentCount),1),e[12]||(e[12]=l("div",{class:"card-label"},"近7天删除",-1))])]),l("div",Le,[l("div",$e,[t(o,null,{default:s(()=>[t(c(ie))]),_:1})]),l("div",Ee,[l("div",Ie,r(z.value.expiringSoonCount),1),e[13]||(e[13]=l("div",{class:"card-label"},"即将过期",-1))])])]),l("div",Fe,[l("div",Me,[l("div",qe,[t(h,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=n=>C.value=n),placeholder:"搜索客户姓名、电话...",clearable:"",onInput:O,class:"search-input"},{prefix:s(()=>[t(o,null,{default:s(()=>[t(c(de))]),_:1})]),_:1},8,["modelValue"])]),l("div",Ke,[t($,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=n=>b.value=n),placeholder:"删除时间",clearable:"",class:"filter-select"},{default:s(()=>[t(A,{label:"全部时间",value:""}),t(A,{label:"今天",value:"today"}),t(A,{label:"近7天",value:"week"}),t(A,{label:"近30天",value:"month"})]),_:1},8,["modelValue"]),t($,{modelValue:x.value,"onUpdate:modelValue":e[2]||(e[2]=n=>x.value=n),placeholder:"删除人",clearable:"",class:"filter-select"},{default:s(()=>[t(A,{label:"全部删除人",value:""}),(S(!0),F(we,null,ye(q.value,n=>(S(),M(A,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),l("div",Oe,[l("div",je,[l("div",He,[l("span",Je,"共 "+r(R.value.length)+" 条记录",1)]),l("div",Qe,[t(w,{type:"success",disabled:i.value.length===0,onClick:W},{default:s(()=>[t(o,null,{default:s(()=>[t(c(I))]),_:1}),d(" 批量恢复 ("+r(i.value.length)+") ",1)]),_:1},8,["disabled"]),t(w,{type:"danger",disabled:i.value.length===0,onClick:ee},{default:s(()=>[t(o,null,{default:s(()=>[t(c(V))]),_:1}),e[14]||(e[14]=d(" 永久删除 ",-1))]),_:1},8,["disabled"]),t(w,{type:"warning",onClick:le},{default:s(()=>[t(o,null,{default:s(()=>[t(c(re))]),_:1}),e[15]||(e[15]=d(" 清理过期 ",-1))]),_:1})])]),l("div",Ye,[De((S(),M(ae,{data:K.value,onSelectionChange:j,stripe:"",class:"data-table"},{default:s(()=>[t(g,{type:"selection",width:"55"}),t(g,{prop:"customerName",label:"客户姓名",width:"120"}),t(g,{prop:"phone",label:"联系电话",width:"130"},{default:s(({row:n})=>[d(r(c(pe)(n.phone,c(me).PHONE)),1)]),_:1}),t(g,{prop:"orderAmount",label:"订单金额",width:"120"},{default:s(({row:n})=>{var T;return[l("span",Ge,"¥"+r(((T=n.orderAmount)==null?void 0:T.toLocaleString())||0),1)]}),_:1}),t(g,{prop:"orderDate",label:"下单日期",width:"120"},{default:s(({row:n})=>[d(r(Q(n.orderDate)),1)]),_:1}),t(g,{prop:"deletedAt",label:"删除时间",width:"150"},{default:s(({row:n})=>[d(r(L(n.deletedAt)),1)]),_:1}),t(g,{prop:"deletedBy",label:"删除人",width:"100"},{default:s(({row:n})=>[d(r(n.deletedByName),1)]),_:1}),t(g,{prop:"deleteReason",label:"删除原因","min-width":"150"},{default:s(({row:n})=>[l("span",We,r(n.deleteReason||"无"),1)]),_:1}),t(g,{prop:"expiresAt",label:"过期时间",width:"150"},{default:s(({row:n})=>[l("span",{class:be(Y(n.expiresAt))},r(L(n.expiresAt)),3)]),_:1}),t(g,{label:"操作",width:"180",fixed:"right"},{default:s(({row:n})=>[t(w,{type:"success",size:"small",onClick:T=>G(n)},{default:s(()=>[t(o,null,{default:s(()=>[t(c(I))]),_:1}),e[16]||(e[16]=d(" 恢复 ",-1))]),_:1},8,["onClick"]),t(w,{type:"danger",size:"small",onClick:T=>Z(n)},{default:s(()=>[t(o,null,{default:s(()=>[t(c(V))]),_:1}),e[17]||(e[17]=d(" 永久删除 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,v.value]])]),l("div",Xe,[t(ne,{"current-page":f.value,"onUpdate:currentPage":e[3]||(e[3]=n=>f.value=n),"page-size":u.value,"onUpdate:pageSize":e[4]||(e[4]=n=>u.value=n),"page-sizes":[10,20,50,100],total:R.value.length,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:H,onCurrentChange:J},null,8,["current-page","page-size","total"])])]),t(E,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=n=>_.value=n),title:"确认恢复",width:"500px"},{footer:s(()=>[t(w,{onClick:e[5]||(e[5]=n=>_.value=!1)},{default:s(()=>[...e[18]||(e[18]=[d("取消",-1)])]),_:1}),t(w,{type:"primary",onClick:X},{default:s(()=>[...e[19]||(e[19]=[d("确认恢复",-1)])]),_:1})]),default:s(()=>[l("p",null,"确定要恢复选中的 "+r(i.value.length)+" 条记录吗？",1),e[20]||(e[20]=l("p",{class:"warning-text"},"恢复后，这些记录将重新出现在资料列表中。",-1))]),_:1},8,["modelValue"]),t(E,{modelValue:k.value,"onUpdate:modelValue":e[8]||(e[8]=n=>k.value=n),title:"永久删除确认",width:"500px"},{footer:s(()=>[t(w,{onClick:e[7]||(e[7]=n=>k.value=!1)},{default:s(()=>[...e[23]||(e[23]=[d("取消",-1)])]),_:1}),t(w,{type:"danger",onClick:te},{default:s(()=>[...e[24]||(e[24]=[d("永久删除",-1)])]),_:1})]),default:s(()=>[l("div",Ze,[t(o,{class:"warning-icon"},{default:s(()=>[t(c(ue))]),_:1}),l("div",et,[e[21]||(e[21]=l("p",null,[l("strong",null,"警告：此操作不可恢复！")],-1)),l("p",null,"确定要永久删除选中的 "+r(i.value.length)+" 条记录吗？",1),e[22]||(e[22]=l("p",null,"删除后将无法恢复这些数据。",-1))])])]),_:1},8,["modelValue"])])}}}),rt=fe(tt,[["__scopeId","data-v-b7a0ad4b"]]);export{rt as default};
