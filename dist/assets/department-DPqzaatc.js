const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/department-BolWvDJg.js","assets/index-DkAJPKqn.js","assets/vendor-BtukhyiH.js","assets/elementPlus-DxaqjplL.js","assets/utils-DfI7e5Rl.js","assets/index-Cj-RrGL6.css"])))=>i.map(i=>d[i]);
import{t as e,l as t}from"./index-DkAJPKqn.js";import{r as a,e as r}from"./vendor-BtukhyiH.js";import"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";const n=e("department",()=>{const e=a([]),n=a([]),s=a([]),o=a([]),l=a(!1),i=a({totalDepartments:0,activeDepartments:0,totalMembers:0,departmentsByType:{}}),m=r(()=>{if(i.value.totalDepartments>0)return i.value;const t=Array.isArray(e.value)?e.value:[],a=Array.isArray(n.value)?n.value:[];return{totalDepartments:t.length,activeDepartments:t.filter(e=>"active"===e.status).length,totalMembers:a.filter(e=>"active"===e.status).length,departmentsByType:t.reduce((e,t)=>{const a=t.parentId?"子部门":"主部门";return e[a]=(e[a]||0)+1,e},{})}}),u=r(()=>{if(!Array.isArray(e.value))return console.log("[DepartmentStore] departmentTree: departments不是数组"),[];console.log("[DepartmentStore] departmentTree: 开始构建树，部门数量:",e.value.length),e.value.length>0&&console.log("[DepartmentStore] 部门parentId列表:",e.value.map(e=>({id:e.id,name:e.name,parentId:e.parentId,parentIdType:typeof e.parentId})));const t=a=>e.value.filter(e=>{const t=e.parentId;return null===a?!t||"null"===t||"0"===t:t===a}).sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)).map(e=>({...e,children:t(e.id)})),a=t(null);return console.log("[DepartmentStore] departmentTree: 构建完成，根节点数量:",a.length),a}),d=r(()=>Array.isArray(e.value)?e.value.sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)):[]),p=t=>e.value.find(e=>e.id===t),c=e=>(console.log("[部门Store] getDepartmentMembers已废弃，请使用fetchDepartmentMembers"),n.value.filter(t=>t.departmentId===e)),v=e=>o.value.filter(t=>t.roleId===e),D=async()=>{l.value=!0;try{console.log("[DepartmentStore] 开始获取部门数据...");{const{getDepartmentList:a}=await t(async()=>{const{getDepartmentList:e}=await import("./department-BolWvDJg.js");return{getDepartmentList:e}},__vite__mapDeps([0,1,2,3,4,5]));console.log("[DepartmentStore] 生产环境：调用API获取部门数据");const r=await a();if(console.log("[DepartmentStore] API响应:",r),r&&r.data){const t=Array.isArray(r.data)?r.data:[];e.value=t,console.log("[DepartmentStore] 生产环境：部门数据已更新:",e.value.length,"个部门")}else e.value=[],console.log("[DepartmentStore] 生产环境：API响应无数据");return}}catch(a){return console.error("[DepartmentStore] 获取部门列表失败:",a),console.error("[DepartmentStore] 生产环境：API失败，无法获取部门数据"),void(e.value=[])}finally{l.value=!1}},y=async()=>{try{const{getDepartmentStats:e}=await t(async()=>{const{getDepartmentStats:e}=await import("./department-BolWvDJg.js");return{getDepartmentStats:e}},__vite__mapDeps([0,1,2,3,4,5])),a=await e();console.log("[DepartmentStore] 统计API响应:",a),a&&a.data?(i.value={totalDepartments:a.data.totalDepartments||0,activeDepartments:a.data.activeDepartments||0,totalMembers:a.data.totalMembers||0,departmentsByType:a.data.departmentsByType||{}},console.log("[DepartmentStore] 统计数据已更新:",i.value)):console.log("[DepartmentStore] 统计API无数据，使用计算属性")}catch(e){console.error("获取部门统计数据失败:",e),console.log("[DepartmentStore] 统计API失败，使用计算属性")}},f=()=>{console.log("[部门Store] 生产环境：跳过localStorage同步，使用API数据")};return{departments:e,members:n,roles:s,roleUsers:o,loading:l,stats:m,departmentTree:u,departmentList:d,getDepartmentById:p,getDepartmentMembers:c,addDepartment:async a=>{l.value=!0;try{const{createDepartment:r}=await t(async()=>{const{createDepartment:e}=await import("./department-BolWvDJg.js");return{createDepartment:e}},__vite__mapDeps([0,1,2,3,4,5])),n=(await r(a)).data;return e.value.push(n),n}catch(r){throw console.error("创建部门失败:",r),r}finally{l.value=!1}},updateDepartment:async(a,r)=>{l.value=!0;try{const{updateDepartment:n}=await t(async()=>{const{updateDepartment:e}=await import("./department-BolWvDJg.js");return{updateDepartment:e}},__vite__mapDeps([0,1,2,3,4,5])),s=(await n(a,r)).data,o=e.value.findIndex(e=>e.id===a);return-1!==o&&(e.value[o]=s),s}catch(n){throw console.error("更新部门失败:",n),n}finally{l.value=!1}},updateDepartmentStatus:async(a,r)=>{l.value=!0;try{const{updateDepartmentStatus:n}=await t(async()=>{const{updateDepartmentStatus:e}=await import("./department-BolWvDJg.js");return{updateDepartmentStatus:e}},__vite__mapDeps([0,1,2,3,4,5])),s=(await n(a,r)).data,o=e.value.findIndex(e=>e.id===a);return-1!==o&&(e.value[o]=s),s}catch(n){throw console.error("更新部门状态失败:",n),n}finally{l.value=!1}},deleteDepartment:async a=>{l.value=!0;try{const{deleteDepartment:r}=await t(async()=>{const{deleteDepartment:e}=await import("./department-BolWvDJg.js");return{deleteDepartment:e}},__vite__mapDeps([0,1,2,3,4,5]));await r(a);const s=e.value.findIndex(e=>e.id===a);return-1!==s&&(e.value.splice(s,1),n.value=n.value.filter(e=>e.departmentId!==a),!0)}catch(r){throw console.error("删除部门失败:",r),r}finally{l.value=!1}},moveDepartment:async(t,a,r)=>{l.value=!0;try{const n=e.value.find(e=>e.id===t);n&&(n.parentId=a,n.sort=r,n.level=a?(p(a)?.level||0)+1:1,n.updatedAt=(new Date).toISOString())}finally{l.value=!1}},addDepartmentMember:async a=>{l.value=!0;try{const{addDepartmentMember:r}=await t(async()=>{const{addDepartmentMember:e}=await import("./department-BolWvDJg.js");return{addDepartmentMember:e}},__vite__mapDeps([0,1,2,3,4,5])),s=(await r(a.departmentId,a.userId,a.role)).data;n.value.push(s);const o=e.value.find(e=>e.id===a.departmentId);return o&&(o.memberCount=(o.memberCount||0)+1),s}catch(r){throw console.error("添加部门成员失败:",r),r}finally{l.value=!1}},removeDepartmentMember:async(a,r)=>{l.value=!0;try{const{removeDepartmentMember:s}=await t(async()=>{const{removeDepartmentMember:e}=await import("./department-BolWvDJg.js");return{removeDepartmentMember:e}},__vite__mapDeps([0,1,2,3,4,5]));await s(a,r);const o=n.value.findIndex(e=>e.departmentId===a&&e.userId===r);if(-1!==o){n.value.splice(o,1);const t=e.value.find(e=>e.id===a);return t&&t.memberCount>0&&(t.memberCount-=1),!0}return!1}catch(s){throw console.error("移除部门成员失败:",s),s}finally{l.value=!1}},updateDepartmentPermissions:async(t,a)=>{l.value=!0;try{const r=e.value.find(e=>e.id===t);r&&(r.permissions=[...a],r.updatedAt=(new Date).toISOString())}finally{l.value=!1}},batchUpdatePermissions:async t=>{l.value=!0;try{t.forEach(t=>{const a=e.value.find(e=>e.id===t.id);a&&(a.permissions=[...t.permissions],a.updatedAt=(new Date).toISOString())})}finally{l.value=!1}},copyPermissions:async(t,a)=>{l.value=!0;try{const r=e.value.find(e=>e.id===t);if(r){const t=[...r.permissions];a.forEach(a=>{const r=e.value.find(e=>e.id===a);r&&(r.permissions=[...t],r.updatedAt=(new Date).toISOString())})}}finally{l.value=!1}},getPermissionStats:()=>{const t={totalPermissions:0,departmentPermissions:{},permissionUsage:{}};return e.value.forEach(e=>{t.totalPermissions+=e.permissions.length,t.departmentPermissions[e.id]=e.permissions.length,e.permissions.forEach(e=>{t.permissionUsage[e]=(t.permissionUsage[e]||0)+1})}),t},getRoleById:e=>s.value.find(t=>t.id===e),getRolesByDepartment:e=>s.value.filter(t=>t.departmentId===e),getRoleUsers:v,addRole:async e=>{l.value=!0;try{const t=p(e.departmentId),a={...e,id:Date.now().toString(),departmentName:t?.name||"",userCount:0,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};return s.value.push(a),a}finally{l.value=!1}},updateRole:async(e,t)=>{l.value=!0;try{const a=s.value.findIndex(t=>t.id===e);if(-1!==a)return s.value[a]={...s.value[a],...t,updatedAt:(new Date).toISOString()},s.value[a];throw new Error("角色不存在")}finally{l.value=!1}},deleteRole:async e=>{l.value=!0;try{const t=s.value.findIndex(t=>t.id===e);-1!==t&&(o.value=o.value.filter(t=>t.roleId!==e),s.value.splice(t,1))}finally{l.value=!1}},assignUserToRole:async(e,t,a,r="admin")=>{l.value=!0;try{if(o.value.find(a=>a.roleId===e&&a.userId===t))throw new Error("用户已分配到该角色");const n={id:Date.now().toString(),userId:t,userName:a,roleId:e,assignedAt:(new Date).toISOString(),assignedBy:r};o.value.push(n);const l=s.value.find(t=>t.id===e);return l&&(l.userCount=v(e).length),n}finally{l.value=!1}},removeUserFromRole:async(e,t)=>{l.value=!0;try{const a=o.value.findIndex(a=>a.roleId===e&&a.userId===t);if(-1!==a){o.value.splice(a,1);const t=s.value.find(t=>t.id===e);t&&(t.userCount=v(e).length)}}finally{l.value=!1}},batchUpdateRolePermissions:async(e,t)=>{l.value=!0;try{e.forEach(e=>{const a=s.value.find(t=>t.id===e);a&&(a.permissions=[...t],a.updatedAt=(new Date).toISOString())})}finally{l.value=!1}},fetchDepartments:D,fetchDepartmentMembers:async e=>{try{const{getDepartmentMembers:a}=await t(async()=>{const{getDepartmentMembers:e}=await import("./department-BolWvDJg.js");return{getDepartmentMembers:e}},__vite__mapDeps([0,1,2,3,4,5])),r=(await a(e)).data||[];return n.value=[...n.value.filter(t=>t.departmentId!==e),...r],console.log(`[部门Store] 从API获取部门${e}的成员:`,r.length,"个"),r}catch(a){return console.error("[部门Store] 从API获取部门成员失败:",a),[]}},fetchAllDepartmentMembers:async()=>{l.value=!0;try{const{getDepartmentMembers:r}=await t(async()=>{const{getDepartmentMembers:e}=await import("./department-BolWvDJg.js");return{getDepartmentMembers:e}},__vite__mapDeps([0,1,2,3,4,5])),s=[];for(const t of e.value)try{const e=await r(t.id);s.push(...e.data||[])}catch(a){console.warn(`获取部门 ${t.name} 成员失败:`,a)}n.value=s}catch(a){console.error("获取所有部门成员失败:",a),n.value=[]}finally{l.value=!1}},fetchDepartmentRoles:async e=>{if(e){l.value=!0;try{const{getDepartmentRoles:a}=await t(async()=>{const{getDepartmentRoles:e}=await import("./department-BolWvDJg.js");return{getDepartmentRoles:e}},__vite__mapDeps([0,1,2,3,4,5])),r=(await a(e)).data||[];s.value=[...s.value.filter(t=>t.departmentId!==e),...r]}catch(a){console.warn(`获取部门 ${e} 角色失败:`,a)}finally{l.value=!1}}else console.log("[部门Store] fetchDepartmentRoles: 跳过批量加载，改为按需加载")},fetchDepartmentStats:y,updateDepartmentMemberCount:async t=>{const a=e.value.find(e=>e.id===t);if(a){const e=c(t);a.memberCount=e.length,a.updatedAt=(new Date).toISOString(),console.log(`[部门Store] 更新部门${t}成员数:`,a.memberCount)}},syncAllDepartmentMemberCounts:f,initData:async()=>{await D(),await y(),f()},initMockData:()=>{}}});export{n as useDepartmentStore};
