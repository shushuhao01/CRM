var S=Object.defineProperty,y=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var h=Object.getOwnPropertySymbols;var v=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var u=(i,e,t)=>e in i?S(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,g=(i,e)=>{for(var t in e||(e={}))v.call(e,t)&&u(i,t,e[t]);if(h)for(var t of h(e))x.call(e,t)&&u(i,t,e[t]);return i},D=(i,e)=>y(i,F(e));var f=(i,e,t)=>u(i,typeof e!="symbol"?e+"":e,t);var p=(i,e,t)=>new Promise((s,n)=>{var r=m=>{try{o(t.next(m))}catch(c){n(c)}},a=m=>{try{o(t.throw(m))}catch(c){n(c)}},o=m=>m.done?s(m.value):Promise.resolve(m.value).then(r,a);o((t=t.apply(i,e)).next())});import{W as C}from"./settings-CuxbDWOu.js";import"./elementPlus-Bmwh7Rh8.js";import"./vendor-D8Vxqhr-.js";import"./utils-ywHRn0uI.js";class A{constructor(){f(this,"departmentPermissions");f(this,"userDepartmentCache");this.departmentPermissions=new Map,this.userDepartmentCache=new Map}setDepartmentPermissions(e,t){return p(this,null,function*(){const s={departmentId:e,permissions:t.permissions||[],inheritFromParent:t.inheritFromParent||!1,managerExtraPermissions:t.managerExtraPermissions||["data.department.view_all","performance.department.view_all","customer.department.view_all"],dataScope:t.dataScope||"department",createdAt:new Date,updatedAt:new Date};return this.departmentPermissions.set(e,s),s})}getDepartmentPermissions(e){return this.departmentPermissions.get(e)||{departmentId:e,permissions:[],inheritFromParent:!1,managerExtraPermissions:[],dataScope:"self",createdAt:new Date,updatedAt:new Date}}calculateDepartmentFullPermissions(e,t){return p(this,null,function*(){const s=this.getDepartmentPermissions(e);let n=[...s.permissions];if(s.inheritFromParent){const r=this.findDepartmentInTree(t,e);if(r&&r.parentId){const a=yield this.calculateDepartmentFullPermissions(r.parentId,t);n=[...new Set([...n,...a])]}}return n})}calculateUserFinalPermissions(e,t,s){return p(this,null,function*(){const{departmentId:n,roleId:r,isManager:a}=t,o=(yield C.getRolePermissions(r))||[],m=yield this.calculateDepartmentFullPermissions(n,s),c=(yield C.getUserPersonalPermissions(e))||[];let l=[];a&&(l=this.getDepartmentPermissions(n).managerExtraPermissions);const w=[...new Set([...o,...m,...l,...c])];let d="self";return a?d=this.getDepartmentPermissions(n).dataScope==="all"?"all":"department":this.getDepartmentPermissions(n).dataScope==="department"&&m.length>0&&(d="department"),{userId:e,departmentId:n,roleId:r,finalPermissions:w,permissionSources:{role:o,department:m,personal:c,manager:l},dataScope:d,isDepartmentManager:a}})}findDepartmentInTree(e,t){for(const s of e){if(s.id===t)return s;if(s.children){const n=this.findDepartmentInTree(s.children,t);if(n)return n}}return null}hasPermission(e,t,s,n){return p(this,null,function*(){return(yield this.calculateUserFinalPermissions(e,s,n)).finalPermissions.includes(t)})}canAccessData(e,t,s,n){return p(this,null,function*(){const{departmentId:r,isManager:a}=n;if(e===t||a&&r===s)return!0;const o=this.getDepartmentPermissions(r);return o.dataScope==="all"||o.dataScope==="department"&&r===s})}getDataScopeFilter(e,t){return p(this,null,function*(){const{departmentId:s,isManager:n}=t;return n?this.getDepartmentPermissions(s).dataScope==="all"?{type:"all"}:{type:"department",value:s}:this.getDepartmentPermissions(s).dataScope==="department"?{type:"department",value:s}:{type:"self",value:e}})}batchSetDepartmentPermissions(e){return p(this,null,function*(){const t=[];for(const{departmentId:s,config:n}of e){const r=yield this.setDepartmentPermissions(s,n);t.push(r)}return t})}getDepartmentPermissionChain(e,t){return p(this,null,function*(){const s=[],n=this.findDepartmentInTree(t,e);if(!n)return s;const r=this.getDepartmentPermissions(e);if(s.push({departmentId:e,permissions:r.permissions,inherited:!1}),r.inheritFromParent&&n.parentId){const a=yield this.getDepartmentPermissionChain(n.parentId,t);s.push(...a.map(o=>D(g({},o),{inherited:!0})))}return s})}clearCache(){this.userDepartmentCache.clear()}exportDepartmentPermissions(){return Array.from(this.departmentPermissions.values())}importDepartmentPermissions(e){return p(this,null,function*(){for(const t of e)this.departmentPermissions.set(t.departmentId,t)})}}const T=new A;export{T as default};
