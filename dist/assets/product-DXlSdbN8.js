import{g as t,v as e,w as a,t as r}from"./index-C4IdUW1A.js";import{isProduction as o}from"./env-DLalhsF6.js";import{r as s,e as c}from"./vendor-BtukhyiH.js";const n={async getList(e={}){try{return(await t.get("/products",{params:e})).data}catch(a){return console.error("获取产品列表失败:",a),this.getMockProductList(e)}},async getActiveList(t={}){return this.getList({...t,status:"active"})},async getDetail(e){try{return(await t.get(`/products/${e}`)).data}catch(a){throw console.error("获取产品详情失败:",a),a}},async create(e){try{return(await t.post("/products",e)).data}catch(a){throw console.error("创建产品失败:",a),a}},async update(e,a){try{return(await t.put(`/products/${e}`,a)).data}catch(r){throw console.error("更新产品失败:",r),r}},async delete(e){try{await t.delete(`/products/${e}`)}catch(a){throw console.error("删除产品失败:",a),a}},async getProductStats(e){try{const a=await t.get(`/products/${e}/stats`);return a.data?.data||a.data}catch(a){return console.error("获取商品统计数据失败:",a),{pendingOrders:0,monthlySales:0,turnoverRate:0,avgRating:0,returnRate:0,dataScope:"personal"}}},async getStockStatistics(){try{return(await t.get("/products/stock/statistics")).data}catch(e){throw console.error("获取库存统计失败:",e),e}},async adjustStock(e){try{return(await t.post("/products/stock/adjust",e)).data}catch(a){throw console.error("库存调整失败:",a),a}},async getStockAdjustments(e){try{return(await t.get("/products/stock/adjustments",{params:e})).data}catch(a){throw console.error("获取库存调整记录失败:",a),a}},async batchImport(e){try{return(await t.post("/products/batch-import",e)).data}catch(a){throw console.error("批量导入产品失败:",a),a}},async exportProducts(e){try{return(await t.get("/products/export",{params:e})).data}catch(a){throw console.error("导出产品数据失败:",a),a}},async getCategoryList(){if(o()){const e=await t.get("/products/categories");return e.data?.data||e.data||[]}if(e()){const t=await a.getCategoryList();return t?.data||[]}try{const e=await t.get("/products/categories");return e.data?.data||e.data||[]}catch(r){return console.error("获取产品分类列表失败:",r),[]}},async getCategoryTree(){if(o()){const e=await t.get("/products/categories/tree");return e.data?.data||e.data||[]}if(e()){const t=await a.getCategoryTree();return t?.data||[]}try{const e=await t.get("/products/categories/tree");return e.data?.data||e.data||[]}catch(r){return console.error("获取产品分类树形结构失败:",r),[]}},async createCategory(r){if(o()){return(await t.post("/products/categories",r)).data}if(e())return a.createCategory(r);try{return(await t.post("/products/categories",r)).data}catch(s){throw console.error("创建产品分类失败:",s),s}},async updateCategory(r,s){if(o()){return(await t.put(`/products/categories/${r}`,s)).data}if(e())return a.updateCategory(r,s);try{return(await t.put(`/products/categories/${r}`,s)).data}catch(c){throw console.error("更新产品分类失败:",c),c}},async deleteCategory(r){if(o())await t.delete(`/products/categories/${r}`);else{if(e())return a.deleteCategory(r);try{await t.delete(`/products/categories/${r}`)}catch(s){throw console.error("删除产品分类失败:",s),s}}},async getCategoryDetail(r){if(o()){return(await t.get(`/products/categories/${r}`)).data}if(e())return a.getCategoryDetail(r);try{return(await t.get(`/products/categories/${r}`)).data}catch(s){throw console.error("获取产品分类详情失败:",s),s}},async getSalesStatistics(e){try{return(await t.get("/products/sales/statistics",{params:e})).data}catch(a){console.error("获取销售统计失败:",a);const t=this.getMockProductList().list||[];return{totalRevenue:t.reduce((t,e)=>t+(e.salesCount||0)*e.price,0),totalSales:t.reduce((t,e)=>t+(e.salesCount||0),0),totalProducts:t.length,lowStockWarning:t.filter(t=>t.stock<=(t.minStock||10)&&t.stock>0).length,revenueChange:"+12.5%",salesChange:"+8.3%",productsChange:"+2.1%",warningChange:"-5.2%"}}},async getSalesTrend(e){try{return(await t.get("/products/sales/trend",{params:e})).data}catch(a){console.error("获取销售趋势失败:",a);const{period:t}=e,r=[],o=[],s=[];if("7days"===t)for(let e=6;e>=0;e--){const t=new Date;t.setDate(t.getDate()-e),r.push(`${t.getMonth()+1}/${t.getDate()}`),o.push(Math.floor(100*Math.random())+50),s.push(Math.floor(5e4*Math.random())+2e4)}else if("30days"===t)for(let e=3;e>=0;e--)r.push(`第${4-e}周`),o.push(Math.floor(500*Math.random())+200),s.push(Math.floor(2e5*Math.random())+1e5);else if("90days"===t)for(let e=2;e>=0;e--){const t=new Date;t.setMonth(t.getMonth()-e),r.push(`${t.getMonth()+1}月`),o.push(Math.floor(2e3*Math.random())+1e3),s.push(Math.floor(8e5*Math.random())+4e5)}return{timeLabels:r,salesData:o,revenueData:s}}},async getCategorySales(e){try{return(await t.get("/products/sales/category",{params:e})).data}catch(a){console.error("获取分类销售占比失败:",a);const t=this.getMockProductList().list||[],e=new Map;t.forEach(t=>{const a=t.categoryName||"未分类",r=(t.salesCount||0)*t.price;e.has(a)?e.set(a,e.get(a)+r):e.set(a,r)});const r=Array.from(e.values()).reduce((t,e)=>t+e,0);return Array.from(e.entries()).map(([t,e])=>({name:t,value:Math.round(e),percentage:r>0?Math.round(e/r*100):0})).sort((t,e)=>e.value-t.value)}},async getTopProducts(e){try{return(await t.get("/products/sales/top",{params:e})).data}catch(a){console.error("获取热销商品排行失败:",a);const t=this.getMockProductList().list||[],r=e.limit||5;return t.map(t=>({id:t.id,name:t.name,sales:t.salesCount||0,revenue:(t.salesCount||0)*t.price,image:t.image,categoryName:t.categoryName||"未分类"})).sort((t,e)=>e.sales-t.sales).slice(0,r)}},async getInventoryWarning(e){try{return(await t.get("/products/inventory/warning",{params:e})).data}catch(a){console.error("获取库存预警失败:",a);const t=this.getMockProductList().list||[],e=t.filter(t=>t.stock<=(t.minStock||10)&&t.stock>0),r=t.filter(t=>0===t.stock),o=new Map;return t.forEach(t=>{const e=t.categoryName||"未分类";o.has(e)||o.set(e,{name:e,lowStock:0,outOfStock:0,totalStock:0});const a=o.get(e);a.totalStock+=t.stock,0===t.stock?a.outOfStock++:t.stock<=(t.minStock||10)&&a.lowStock++}),{lowStockCount:e.length,outOfStockCount:r.length,totalWarning:e.length+r.length,categories:Array.from(o.values())}}},getMockProductList(t={}){const e=localStorage.getItem("products");let a=e?JSON.parse(e):[];if(t.status&&(a=a.filter(e=>e.status===t.status)),t.categoryId&&(a=a.filter(e=>e.categoryId===t.categoryId)),t.keyword){const e=t.keyword.toLowerCase();a=a.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e)||t.brand&&t.brand.toLowerCase().includes(e))}const r=t.page||1,o=t.pageSize||10,s=(r-1)*o,c=s+o;return{list:a.slice(s,c),total:a.length,page:r,pageSize:o}}},u=r("product",()=>{const t=s([]),e=s([]),a=s(!1),r=()=>{Array.isArray(e.value)||(e.value=[])},o=s({currentPage:1,pageSize:20,total:0}),u=s({name:"",code:"",categoryId:"",status:"",stockStatus:"",minPrice:null,maxPrice:null,showDeleted:!1,onlyDeleted:!1}),l=c(()=>({totalProducts:(t.value||[]).length,lowStockCount:(t.value||[]).filter(t=>t.stock<=t.minStock&&t.stock>0).length,outOfStockCount:(t.value||[]).filter(t=>0===t.stock).length})),i=async()=>{try{a.value=!0;const t=await n.getCategoryTree();e.value=Array.isArray(t)?t:t?.data||[],r()}catch(t){console.error("加载分类失败:",t),e.value=[]}finally{a.value=!1,r()}},d=async(e={})=>{try{a.value=!0;const r=await n.getList(e);t.value=r?.list||[],o.value.total=r?.total||0,o.value.currentPage=r?.page||1,o.value.pageSize=r?.pageSize||10}catch(r){console.error("加载商品失败:",r)}finally{a.value=!1}},g=async(a=!1)=>{(a||0===e.value.length)&&await i(),(a||0===t.value.length)&&await d()},h=()=>{let e=Date.now()+Math.floor(1e3*Math.random());for(;t.value.some(t=>t.id===e);)e=Date.now()+Math.floor(1e3*Math.random());return e},y=c(()=>{let e=[...t.value||[]];if(u.value.onlyDeleted?e=e.filter(t=>!0===t.deleted):u.value.showDeleted||(e=e.filter(t=>!t.deleted)),u.value.name&&(e=e.filter(t=>t.name.toLowerCase().includes(u.value.name.toLowerCase()))),u.value.code&&(e=e.filter(t=>t.code.toLowerCase().includes(u.value.code.toLowerCase()))),u.value.categoryId&&(e=e.filter(t=>t.categoryId===u.value.categoryId)),u.value.status&&(e="active"===u.value.status?e.filter(t=>"active"===t.status&&!t.deleted):e.filter(t=>t.status===u.value.status)),u.value.stockStatus)switch(u.value.stockStatus){case"normal":e=e.filter(t=>t.stock>t.minStock);break;case"warning":e=e.filter(t=>t.stock<=t.minStock&&t.stock>0);break;case"out_of_stock":e=e.filter(t=>0===t.stock)}return null!==u.value.minPrice&&(e=e.filter(t=>t.price>=u.value.minPrice)),null!==u.value.maxPrice&&(e=e.filter(t=>t.price<=u.value.maxPrice)),e});return setTimeout(()=>{g()},0),{products:t,categories:c(()=>Array.isArray(e.value)?e.value:[]),loading:a,pagination:o,searchForm:u,stats:l,getFilteredProducts:y,addProduct:async e=>{try{const a=await n.create(e);if(a&&a.id)return t.value.unshift(a),console.log("[ProductStore] 服务器创建商品成功:",a.name,"ID:",a.id),a}catch(r){console.error("[ProductStore] 服务器创建商品失败，回退到本地存储:",r)}const a={...e,id:h(),createTime:(new Date).toLocaleString("zh-CN")};return t.value.unshift(a),console.log("[ProductStore] 本地添加新商品:",a.name,"ID:",a.id),a},updateProduct:async(e,a)=>{const r=(t.value||[]).findIndex(t=>t.id===e);if(-1!==r){try{const o=await n.update(String(e),a);if(o)return t.value[r]=o,console.log("[ProductStore] 服务器更新商品成功:",o.name,"ID:",e),o}catch(o){console.error("[ProductStore] 服务器更新商品失败，回退到本地存储:",o)}const s={...t.value[r],...a,updateTime:(new Date).toLocaleString("zh-CN")};return t.value[r]=s,console.log("[ProductStore] 本地更新商品:",s.name,"ID:",e),s}return console.warn("[ProductStore] 未找到要更新的商品 ID:",e),null},deleteProduct:async e=>{const a=(t.value||[]).find(t=>t.id===e);if(a){try{await n.delete(String(e)),console.log("[ProductStore] 服务器删除商品成功:",a.name,"ID:",e)}catch(r){console.error("[ProductStore] 服务器删除商品失败，回退到本地存储:",r)}return a.deleted=!0,a.status="inactive",a.updateTime=(new Date).toISOString(),console.log("[ProductStore] 商品已删除:",a.name,"ID:",e),!0}return console.warn("[ProductStore] 未找到要删除的商品 ID:",e),!1},restoreProduct:e=>{const a=t.value.find(t=>t.id===e);return!(!a||!a.deleted)&&(a.deleted=!1,a.status="active",a.updateTime=(new Date).toISOString(),!0)},permanentDeleteProduct:e=>{const a=t.value.findIndex(t=>t.id===e);return-1!==a&&(t.value.splice(a,1),!0)},getProductById:e=>(t.value||[]).find(t=>t.id==e||t.id===Number(e)||String(t.id)===String(e)),setSearchForm:t=>{Object.assign(u.value,t)},resetSearchForm:()=>{u.value={name:"",code:"",categoryId:"",status:"",stockStatus:"",minPrice:null,maxPrice:null,showDeleted:!1,onlyDeleted:!1}},setPagination:t=>{Object.assign(o.value,t)},updateProductStock:(e,a)=>{const r=t.value.find(t=>t.id===e);if(r){const t=r.stock+a;r.stock=Math.max(0,t),r.updateTime=(new Date).toLocaleString(),0===r.stock?r.status="out_of_stock":"out_of_stock"===r.status&&r.stock>0&&(r.status="active")}},fetchProducts:async(e={})=>{try{a.value=!0;const r=await n.getActiveList(e);return t.value=r?.list||[],o.value={...o.value,total:r?.total||0,current:r?.page||1,pageSize:r?.pageSize||10},r}catch(r){throw console.error("获取产品列表失败:",r),r}finally{a.value=!1}},refreshProducts:async()=>{try{a.value=!0;const e={page:o.value.current,pageSize:o.value.pageSize,status:"active"};u.value.name&&(e.name=u.value.name),u.value.categoryId&&(e.categoryId=u.value.categoryId),u.value.stockStatus&&(e.stockStatus=u.value.stockStatus);const r=await n.getActiveList(e);return t.value=r?.list||[],o.value={...o.value,total:r?.total||0,current:r?.page||1,pageSize:r?.pageSize||10},r}catch(e){throw console.error("刷新产品列表失败:",e),e}finally{a.value=!1}},searchProducts:async e=>{if(!e.trim())return[];const a=e.toLowerCase().trim(),r=(t.value||[]).filter(t=>!t.deleted&&(t.name.toLowerCase().includes(a)||t.code.toLowerCase().includes(a)||t.brand.toLowerCase().includes(a)||t.specification.toLowerCase().includes(a)||t.description.toLowerCase().includes(a)));return r.sort((t,e)=>{const r=t.name.toLowerCase().includes(a),o=e.name.toLowerCase().includes(a),s=t.code.toLowerCase().includes(a),c=e.code.toLowerCase().includes(a);return r&&!o?-1:!r&&o?1:s&&!c?-1:!s&&c?1:0}),r.slice(0,50)},initData:g,loadCategories:i,loadProducts:d,addCategory:async t=>{try{a.value=!0;const e=await n.createCategory(t);return await i(),e}catch(e){throw console.error("添加分类失败:",e),e}finally{a.value=!1}},updateCategory:async(t,e)=>{try{a.value=!0;const r=await n.updateCategory(t,e);return await i(),r}catch(r){throw console.error("更新分类失败:",r),r}finally{a.value=!1}},deleteCategory:async t=>{try{a.value=!0,await n.deleteCategory(t),await i()}catch(e){throw console.error("删除分类失败:",e),e}finally{a.value=!1}},findCategoryById:t=>{const a=e=>{for(const r of e){if(r.id===t)return r;if(r.children){const t=a(r.children);if(t)return t}}return null};return a(e.value)},getCategoryPath:t=>{const a=[],r=(t,e,o)=>{for(const s of t){const t=[...o,s];if(s.id===e)return a.push(...t),!0;if(s.children&&r(s.children,e,t))return!0}return!1};return r(e.value,t,[]),a},getFlatCategories:()=>{const t=[],a=e=>{for(const r of e)t.push(r),r.children&&a(r.children)};return a(e.value),t}}});export{n as p,u};
