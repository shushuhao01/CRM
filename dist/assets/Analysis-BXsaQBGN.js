var Ae=Object.defineProperty,Ce=Object.defineProperties;var Re=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var ee=(A,_,h)=>_ in A?Ae(A,_,{enumerable:!0,configurable:!0,writable:!0,value:h}):A[_]=h,te=(A,_)=>{for(var h in _||(_={}))ke.call(_,h)&&ee(A,h,_[h]);if(K)for(var h of K(_))Se.call(_,h)&&ee(A,h,_[h]);return A},ae=(A,_)=>Ce(A,Re(_));var I=(A,_,h)=>new Promise((l,P)=>{var j=b=>{try{y(h.next(b))}catch(F){P(F)}},O=b=>{try{y(h.throw(b))}catch(F){P(F)}},y=b=>b.done?l(b.value):Promise.resolve(b.value).then(j,O);y((h=h.apply(A,_)).next())});import{l as Me,aC as xe,az as Ue,r as D,e as se,c as Ye,Y as Fe,ag as M,m as L,p as Y,q as t,Q as W,U as a,O as d,S as k,u as w,T as p,F as re,a9 as ne,M as q,n as Ie}from"./vendor-D8Vxqhr-.js";import{u as Pe,y as je,B as Oe,D as Te,E as oe,F as Ve,c as ze,_ as Le}from"./settings-CuxbDWOu.js";import{useDepartmentStore as qe}from"./department-CTOju6hT.js";import{i as le,L as Be}from"./utils-ywHRn0uI.js";import{E as x,a3 as Ee,s as Ne,n as We,t as $e,C as Qe,d as Ge,ao as Xe,ap as He,aq as Je}from"./elementPlus-Bmwh7Rh8.js";const Ze={class:"analysis-container"},Ke={class:"page-header"},et={class:"header-left"},tt={class:"page-title"},at={key:0,class:"member-info-card"},st={class:"member-avatar"},rt={class:"member-details"},nt={class:"quick-filter-section"},ot={class:"quick-filter-buttons"},lt={class:"filter-section"},it={class:"filter-left"},dt={class:"filter-right"},ct={class:"metrics-grid"},ut={class:"metrics-row"},mt={class:"metric-card"},pt={class:"metric-icon total-performance"},ft={class:"metric-content"},gt={class:"metric-value"},vt={class:"metric-card"},_t={class:"metric-icon total-orders"},ht={class:"metric-content"},yt={class:"metric-value"},Dt={class:"metric-card"},bt={class:"metric-icon avg-performance"},wt={class:"metric-content"},At={class:"metric-value"},Ct={class:"metrics-row"},Rt={class:"metric-card"},kt={class:"metric-icon sign-orders"},St={class:"metric-content"},Mt={class:"metric-value"},xt={class:"metric-card"},Ut={class:"metric-icon sign-rate"},Yt={class:"metric-content"},Ft={class:"metric-value"},It={class:"metric-card"},Pt={class:"metric-icon sign-performance"},jt={class:"metric-content"},Ot={class:"metric-value"},Tt={class:"charts-section"},Vt={class:"chart-row"},zt={class:"chart-card"},Lt={class:"chart-card"},qt={class:"table-section"},Bt={class:"table-header"},Et={class:"amount"},Nt={class:"amount"},Wt={class:"amount"},$t={class:"amount"},Qt={class:"amount"},Gt={class:"amount"},Xt=Me({__name:"Analysis",setup(A){var J;xe();const _=Ue(),h=ze(_),l=Pe(),P=qe();je();const j=D(),O=D(),y=D(["2025-01-01","2025-01-31"]),b=D(l.isAdmin?"":((J=l.currentUser)==null?void 0:J.departmentId)||""),F=D("performance");D(1),D(20),D(100);const T=D({id:"",name:"张三",department:"销售一部",joinDate:"2023-01-15",avatar:""}),v=D({totalPerformance:0,totalOrders:0,avgPerformance:0,signOrders:0,signRate:0,signPerformance:0}),B=D([]),ie=D(""),de=D([{key:"today",label:"今日"},{key:"yesterday",label:"昨日"},{key:"thisWeek",label:"本周"},{key:"lastWeek",label:"上周"},{key:"last7Days",label:"近7天"},{key:"thisMonth",label:"本月"},{key:"thisYear",label:"今年"}]),ce=se(()=>!l.isAdmin&&!l.isManager),ue=se(()=>l.isAdmin?P.departmentList:l.isManager?P.departmentList.filter(s=>{var e;return s.id===((e=l.currentUser)==null?void 0:e.departmentId)}):[]),S=s=>s.toLocaleString(),me=()=>{h.push("/performance/team")},pe=()=>I(this,null,function*(){console.log("查询数据",{dateRange:y.value,selectedDepartment:b.value,sortBy:F.value}),yield V()}),fe=()=>{console.log("导出数据")},E=s=>s>=90?"success":s>=80?"warning":s>=70?"info":"danger",ge=s=>s<=3?"success":s<=5?"warning":s<=8?"info":"danger",ve=s=>s<=2?"success":s<=4?"warning":s<=6?"info":"danger",_e=s=>{ie.value=s;const e=new Date;let i,m;switch(s){case"today":i=new Date(e.getFullYear(),e.getMonth(),e.getDate()),m=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);break;case"yesterday":const u=new Date(e);u.setDate(e.getDate()-1),i=new Date(u.getFullYear(),u.getMonth(),u.getDate()),m=new Date(u.getFullYear(),u.getMonth(),u.getDate(),23,59,59);break;case"thisWeek":const f=new Date(e);f.setDate(e.getDate()-e.getDay()+1),i=new Date(f.getFullYear(),f.getMonth(),f.getDate()),m=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);break;case"lastWeek":const c=new Date(e);c.setDate(e.getDate()-e.getDay()-6);const r=new Date(c);r.setDate(c.getDate()+6),i=new Date(c.getFullYear(),c.getMonth(),c.getDate()),m=new Date(r.getFullYear(),r.getMonth(),r.getDate(),23,59,59);break;case"last7Days":const g=new Date(e);g.setDate(e.getDate()-6),i=new Date(g.getFullYear(),g.getMonth(),g.getDate()),m=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);break;case"thisMonth":i=new Date(e.getFullYear(),e.getMonth(),1),m=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);break;case"thisYear":i=new Date(e.getFullYear(),0,1),m=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);break;default:return}const o=u=>u.toISOString().split("T")[0];y.value=[o(i),o(m)],console.log(`快速筛选: ${s}`,{startDate:i,endDate:m}),V()},C=D({performanceTrend:{xAxis:[],data:[]},orderStatus:[]}),he=()=>I(this,null,function*(){var s,e,i,m,o,u,f,c,r;try{const g={period:"7d"};l.isAdmin?g.type="company":l.isManager?(g.type="department",g.departmentId=(s=l.currentUser)==null?void 0:s.departmentId):(g.type="personal",g.userId=(e=l.currentUser)==null?void 0:e.id);const U={period:"7d"};((i=l.currentUser)==null?void 0:i.role)==="admin"?U.type="company":((m=l.currentUser)==null?void 0:m.role)==="manager"||((o=l.currentUser)==null?void 0:o.role)==="department_manager"?(U.type="department",U.departmentId=l.currentUser.departmentId):(U.type="personal",U.userId=(u=l.currentUser)==null?void 0:u.id);const n=yield Ve(U);(f=n.data)!=null&&f.success&&((r=(c=n.data)==null?void 0:c.data)==null?void 0:r.length)>0?C.value.performanceTrend={xAxis:n.data.data.map(R=>{const z=new Date(R.date);return`${z.getMonth()+1}/${z.getDate()}`}),data:n.data.data.map(R=>R.sales)}:C.value.performanceTrend={xAxis:[],data:[]};const Z=ae(te({},g),{type:"status"}),N=yield oe(Z);if(N.data.success&&N.data.data){const R=N.data.data,z=[{value:R.signCount||0,name:"已签收"},{value:R.transitCount||0,name:"配送中"},{value:R.shipCount-R.signCount-R.transitCount||0,name:"已发货"},{value:R.orderCount-R.shipCount||0,name:"待发货"}],be=z.some(we=>we.value>0);C.value.orderStatus=be?z:[]}else C.value.orderStatus=[];$()}catch(g){console.error("加载图表数据失败:",g),C.value.performanceTrend={xAxis:[],data:[]},C.value.orderStatus=[],$()}}),$=()=>{Ie(()=>{if(j.value){const s=le(j.value);C.value.performanceTrend.data.length>0?s.setOption({tooltip:{trigger:"axis",formatter:i=>{const m=i[0].value;return`${i[0].axisValue}<br/>业绩: ¥${(m/1e4).toFixed(1)}万`}},xAxis:{type:"category",data:C.value.performanceTrend.xAxis},yAxis:{type:"value",axisLabel:{formatter:i=>`¥${(i/1e4).toFixed(0)}万`}},series:[{data:C.value.performanceTrend.data,type:"line",smooth:!0,itemStyle:{color:"#409eff"},areaStyle:{color:new Be(0,0,0,1,[{offset:0,color:"rgba(64, 158, 255, 0.3)"},{offset:1,color:"rgba(64, 158, 255, 0.1)"}])}}]}):s.setOption({title:{text:"暂无数据",left:"center",top:"middle",textStyle:{color:"#999",fontSize:14}}})}if(O.value){const s=le(O.value);C.value.orderStatus.length>0?s.setOption({tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},series:[{name:"订单状态",type:"pie",radius:"60%",data:C.value.orderStatus,emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}):s.setOption({title:{text:"暂无数据",left:"center",top:"middle",textStyle:{color:"#999",fontSize:14}}})}})},Q=()=>!l.isManager&&!l.isAdmin?(x.error("您没有权限查看业绩分析数据"),_.push("/performance"),!1):!0,V=()=>I(this,null,function*(){if(Q())try{l.isAdmin?yield ye():l.isManager&&(yield G()),yield De(),yield he()}catch(s){console.error("加载业绩分析数据失败:",s),x.error("加载数据失败，请稍后重试")}}),G=()=>I(this,null,function*(){var s,e,i,m,o,u;console.log("加载部门数据");try{const f={departmentId:b.value||((s=l.currentUser)==null?void 0:s.departmentId),startDate:(e=y.value)==null?void 0:e[0],endDate:(i=y.value)==null?void 0:i[1]};!l.isAdmin&&f.departmentId!==((m=l.currentUser)==null?void 0:m.departmentId)&&(x.error("您只能查看自己部门的数据"),f.departmentId=(o=l.currentUser)==null?void 0:o.departmentId,b.value=(u=l.currentUser)==null?void 0:u.departmentId);const c=yield Oe(f);if(c.data.success){const r=c.data.data;B.value=[{id:r.name||"部门数据",name:r.name||"部门数据",orderCount:r.orderCount||0,orderAmount:r.orderAmount||0,shipCount:r.shipCount||0,shipAmount:r.shipAmount||0,shipRate:r.shipRate||0,signCount:r.signCount||0,signAmount:r.signAmount||0,signRate:r.signRate||0,transitCount:r.transitCount||0,transitAmount:r.transitAmount||0,transitRate:r.transitRate||0,rejectCount:r.rejectCount||0,rejectAmount:r.rejectAmount||0,rejectRate:r.rejectRate||0,returnCount:r.returnCount||0,returnAmount:r.returnAmount||0,returnRate:r.returnRate||0}]}}catch(f){console.error("加载部门业绩数据失败:",f),x.error("加载部门业绩数据失败")}}),ye=()=>I(this,null,function*(){var s,e;console.log("加载公司数据");try{if(!l.isAdmin){x.error("您没有权限查看全公司数据"),yield G();return}const i={startDate:(s=y.value)==null?void 0:s[0],endDate:(e=y.value)==null?void 0:e[1]},m=yield Te(i);if(m.data.success){const o=m.data.data;B.value=[{id:o.name||"公司总体",name:o.name||"公司总体",orderCount:o.orderCount||0,orderAmount:o.orderAmount||0,shipCount:o.shipCount||0,shipAmount:o.shipAmount||0,shipRate:o.shipRate||0,signCount:o.signCount||0,signAmount:o.signAmount||0,signRate:o.signRate||0,transitCount:o.transitCount||0,transitAmount:o.transitAmount||0,transitRate:o.transitRate||0,rejectCount:o.rejectCount||0,rejectAmount:o.rejectAmount||0,rejectRate:o.rejectRate||0,returnCount:o.returnCount||0,returnAmount:o.returnAmount||0,returnRate:o.returnRate||0}]}}catch(i){console.error("加载公司业绩数据失败:",i),x.error("加载公司业绩数据失败")}}),De=()=>I(this,null,function*(){var s,e,i,m;try{let o="personal";const u={startDate:(s=y.value)==null?void 0:s[0],endDate:(e=y.value)==null?void 0:e[1]};l.isAdmin?o="company":l.isManager?(o="department",u.departmentId=(i=l.currentUser)==null?void 0:i.departmentId):(o="personal",u.userId=(m=l.currentUser)==null?void 0:m.id),u.type=o;const f=yield oe(u);if(f.data.success){const c=f.data.data;v.value.totalPerformance=c.totalPerformance||0,v.value.totalOrders=c.totalOrders||0,v.value.avgPerformance=c.avgPerformance||0,v.value.signOrders=c.signOrders||0,v.value.signRate=c.signRate||0,v.value.signPerformance=c.signPerformance||0}}catch(o){console.error("加载统计指标失败:",o),x.error("加载统计指标失败"),v.value.totalPerformance=0,v.value.totalOrders=0,v.value.avgPerformance=0,v.value.signOrders=0,v.value.signRate=0,v.value.signPerformance=0}});Ye(()=>{Q()&&(P.initData(),V(),window.addEventListener("orderStatusUpdated",X),window.addEventListener("todoStatusUpdated",H))});const X=s=>{console.log("订单状态已更新，刷新业绩数据",s.detail),V(),x.success("业绩数据已同步更新")},H=s=>{console.log("待办状态已更新，刷新业绩数据",s.detail),V(),x.success("业绩数据已同步更新")};return Fe(()=>{window.removeEventListener("orderStatusUpdated",X),window.removeEventListener("todoStatusUpdated",H)}),(s,e)=>{const i=M("el-button"),m=M("el-avatar"),o=M("el-date-picker"),u=M("el-option"),f=M("el-select"),c=M("el-icon"),r=M("el-table-column"),g=M("el-tag"),U=M("el-table");return Y(),L("div",Ze,[t("div",Ke,[t("div",et,[a(i,{type:"primary",icon:w(Ee),onClick:me,class:"back-btn"},{default:d(()=>[...e[3]||(e[3]=[k(" 返回团队业绩 ",-1)])]),_:1},8,["icon"]),t("h1",tt,p(s.pageTitle),1)])]),ce.value?(Y(),L("div",at,[t("div",st,[a(m,{size:60,src:T.value.avatar},{default:d(()=>[k(p(T.value.name.charAt(0)),1)]),_:1},8,["src"])]),t("div",rt,[t("h3",null,p(T.value.name),1),t("p",null,p(T.value.department)+" | 入职时间："+p(T.value.joinDate),1)])])):W("",!0),t("div",nt,[e[4]||(e[4]=t("div",{class:"quick-filter-label"},"快速筛选：",-1)),t("div",ot,[(Y(!0),L(re,null,ne(de.value,n=>(Y(),q(i,{key:n.key,type:s.selectedQuickFilter===n.key?"primary":"default",size:"small",onClick:Z=>_e(n.key),class:"quick-filter-btn"},{default:d(()=>[k(p(n.label),1)]),_:2},1032,["type","onClick"]))),128))])]),t("div",lt,[t("div",it,[a(o,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=n=>y.value=n),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"date-picker"},null,8,["modelValue"]),w(l).isAdmin||w(l).isManager?(Y(),q(f,{key:0,modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=n=>b.value=n),placeholder:"选择部门",class:"department-select",size:"default",disabled:!w(l).isAdmin},{default:d(()=>[w(l).isAdmin?(Y(),q(u,{key:0,label:"全部部门",value:""})):W("",!0),(Y(!0),L(re,null,ne(ue.value,n=>(Y(),q(u,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])):W("",!0),a(f,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=n=>F.value=n),placeholder:"排序方式",class:"sort-select",size:"default"},{default:d(()=>[a(u,{label:"按业绩排序",value:"performance"}),a(u,{label:"按订单数排序",value:"orders"}),a(u,{label:"按签收率排序",value:"signRate"})]),_:1},8,["modelValue"])]),t("div",dt,[a(i,{type:"primary",onClick:pe,class:"query-btn"},{default:d(()=>[a(c,null,{default:d(()=>[a(w(Ne))]),_:1}),e[5]||(e[5]=k(" 查询 ",-1))]),_:1}),a(i,{onClick:fe,class:"export-btn"},{default:d(()=>[a(c,null,{default:d(()=>[a(w(We))]),_:1}),e[6]||(e[6]=k(" 导出数据 ",-1))]),_:1})])]),t("div",ct,[t("div",ut,[t("div",mt,[t("div",pt,[a(c,null,{default:d(()=>[a(w($e))]),_:1})]),t("div",ft,[t("div",gt,"¥"+p(S(v.value.totalPerformance)),1),e[7]||(e[7]=t("div",{class:"metric-label"},"总业绩",-1))])]),t("div",vt,[t("div",_t,[a(c,null,{default:d(()=>[a(w(Qe))]),_:1})]),t("div",ht,[t("div",yt,p(v.value.totalOrders),1),e[8]||(e[8]=t("div",{class:"metric-label"},"总订单",-1))])]),t("div",Dt,[t("div",bt,[a(c,null,{default:d(()=>[a(w(Ge))]),_:1})]),t("div",wt,[t("div",At,"¥"+p(S(v.value.avgPerformance)),1),e[9]||(e[9]=t("div",{class:"metric-label"},"平均业绩",-1))])])]),t("div",Ct,[t("div",Rt,[t("div",kt,[a(c,null,{default:d(()=>[a(w(Xe))]),_:1})]),t("div",St,[t("div",Mt,p(v.value.signOrders),1),e[10]||(e[10]=t("div",{class:"metric-label"},"签收单数",-1))])]),t("div",xt,[t("div",Ut,[a(c,null,{default:d(()=>[a(w(He))]),_:1})]),t("div",Yt,[t("div",Ft,p(v.value.signRate)+"%",1),e[11]||(e[11]=t("div",{class:"metric-label"},"签收率",-1))])]),t("div",It,[t("div",Pt,[a(c,null,{default:d(()=>[a(w(Je))]),_:1})]),t("div",jt,[t("div",Ot,"¥"+p(S(v.value.signPerformance)),1),e[12]||(e[12]=t("div",{class:"metric-label"},"签收业绩",-1))])])])]),t("div",Tt,[t("div",Vt,[t("div",zt,[e[13]||(e[13]=t("div",{class:"chart-header"},[t("h3",null,"业绩趋势")],-1)),t("div",{class:"chart-content",ref_key:"performanceChartRef",ref:j},null,512)]),t("div",Lt,[e[14]||(e[14]=t("div",{class:"chart-header"},[t("h3",null,"订单状态分布")],-1)),t("div",{class:"chart-content",ref_key:"orderStatusChartRef",ref:O},null,512)])])]),t("div",qt,[t("div",Bt,[t("h3",null,p(s.tableTitle),1)]),a(U,{data:B.value,stripe:"",class:"data-table",border:""},{default:d(()=>[a(r,{type:"index",label:"序号",width:"60",align:"center"}),a(r,{prop:"name",label:"部门（或成员）",width:"120",align:"center"}),a(r,{prop:"orderCount",label:"下单单数",width:"100",align:"center"}),a(r,{prop:"orderAmount",label:"下单业绩",width:"120",align:"center"},{default:d(({row:n})=>[t("span",Et,"¥"+p(S(n.orderAmount)),1)]),_:1}),a(r,{prop:"shipCount",label:"发货单数",width:"100",align:"center"}),a(r,{prop:"shipAmount",label:"发货业绩",width:"120",align:"center"},{default:d(({row:n})=>[t("span",Nt,"¥"+p(S(n.shipAmount)),1)]),_:1}),a(r,{prop:"shipRate",label:"发货率",width:"100",align:"center"},{default:d(({row:n})=>[a(g,{type:E(n.shipRate),size:"small"},{default:d(()=>[k(p(n.shipRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),a(r,{prop:"signCount",label:"签收单数",width:"100",align:"center"}),a(r,{prop:"signAmount",label:"签收业绩",width:"120",align:"center"},{default:d(({row:n})=>[t("span",Wt,"¥"+p(S(n.signAmount)),1)]),_:1}),a(r,{prop:"signRate",label:"签收率",width:"100",align:"center"},{default:d(({row:n})=>[a(g,{type:E(n.signRate),size:"small"},{default:d(()=>[k(p(n.signRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),a(r,{prop:"transitCount",label:"在途单数",width:"100",align:"center"}),a(r,{prop:"transitAmount",label:"在途业绩",width:"120",align:"center"},{default:d(({row:n})=>[t("span",$t,"¥"+p(S(n.transitAmount)),1)]),_:1}),a(r,{prop:"transitRate",label:"在途率",width:"100",align:"center"},{default:d(({row:n})=>[a(g,{type:E(n.transitRate),size:"small"},{default:d(()=>[k(p(n.transitRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),a(r,{prop:"rejectCount",label:"拒收单数",width:"100",align:"center"}),a(r,{prop:"rejectAmount",label:"拒收业绩",width:"120",align:"center"},{default:d(({row:n})=>[t("span",Qt,"¥"+p(S(n.rejectAmount)),1)]),_:1}),a(r,{prop:"rejectRate",label:"拒收率",width:"100",align:"center"},{default:d(({row:n})=>[a(g,{type:ge(n.rejectRate),size:"small"},{default:d(()=>[k(p(n.rejectRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),a(r,{prop:"returnCount",label:"退货单数",width:"100",align:"center"}),a(r,{prop:"returnAmount",label:"退货业绩",width:"120",align:"center"},{default:d(({row:n})=>[t("span",Gt,"¥"+p(S(n.returnAmount)),1)]),_:1}),a(r,{prop:"returnRate",label:"退货率",width:"100",align:"center"},{default:d(({row:n})=>[a(g,{type:ve(n.returnRate),size:"small"},{default:d(()=>[k(p(n.returnRate)+"% ",1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])])}}}),aa=Le(Xt,[["__scopeId","data-v-04f8253f"]]);export{aa as default};
