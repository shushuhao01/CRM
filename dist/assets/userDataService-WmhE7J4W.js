const e=new class{config;cache=[];cacheTime=0;cacheDuration=3e5;constructor(){this.config=this.detectEnvironment(),console.log("[UserDataService] 初始化完成:",this.config.useAPI?"API模式":"localStorage模式")}detectEnvironment(){return{useAPI:true,apiBaseURL:"/api/v1",localStorageKey:"crm_mock_users"}}async getUsers(){if(this.isCacheValid())return console.log("[UserDataService] 使用缓存数据"),this.cache;try{let e;return e=this.config.useAPI?await this.getUsersFromAPI():await this.getUsersFromLocalStorage(),this.cache=e,this.cacheTime=Date.now(),console.log("[UserDataService] 获取用户成功:",e.length,"个用户"),e}catch(e){return console.error("[UserDataService] 获取用户失败:",e),this.config.useAPI,console.error("[UserDataService] 生产环境：API失败，无法获取用户数据"),[]}}async getUsersFromLocalStorage(){return console.warn("[UserDataService] 生产环境不支持从localStorage获取数据"),[]}async getUsersFromAPI(){try{const e=await fetch(`${this.config.apiBaseURL}/users?limit=100`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getToken()}`}});if(!e.ok)throw new Error(`API请求失败: ${e.status}`);const t=await e.json();if(console.log("[UserDataService] API返回数据:",t),t.success&&t.data){const e=t.data.users||t.data.items||[];return console.log("[UserDataService] 解析到用户数量:",e.length),e.map(e=>({id:e.id,name:e.realName||e.name||e.username,username:e.username,realName:e.realName||e.name,email:e.email||"",phone:e.phone||"",role:e.role||"user",department:e.departmentName||"未分配",departmentId:e.departmentId,departmentName:e.departmentName||"未分配",position:e.position||"员工",avatar:e.avatar||"",status:e.status||"active",createTime:e.createdAt||(new Date).toISOString(),createdAt:e.createdAt,employmentStatus:"active"===e.status?"active":"resigned"}))}return[]}catch(e){throw console.error("[UserDataService] 从API获取用户失败:",e),e}}async getUserById(e){return(await this.getUsers()).find(t=>String(t.id)===String(e))||null}async getUsersByRole(e){const t=await this.getUsers(),a=Array.isArray(e)?e:[e];return t.filter(e=>a.includes(e.role))}async getSalesUsers(){return this.getUsersByRole(["sales_staff","department_manager","admin","super_admin"])}async getDepartmentUsers(e){return(await this.getUsers()).filter(t=>t.departmentId===e||t.department===e)}async searchUsers(e){if(!e)return this.getUsers();const t=await this.getUsers(),a=e.toLowerCase();return t.filter(e=>e.name.toLowerCase().includes(a)||e.id.toLowerCase().includes(a)||e.email&&e.email.toLowerCase().includes(a)||e.department&&e.department.toLowerCase().includes(a))}async refreshCache(){this.cache=[],this.cacheTime=0,await this.getUsers()}isCacheValid(){return 0!==this.cache.length&&(0!==this.cacheTime&&Date.now()-this.cacheTime<this.cacheDuration)}getToken(){return localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token")||""}switchToAPI(e){this.config.useAPI=!0,this.config.apiBaseURL=e,this.refreshCache(),console.log("[UserDataService] 已切换到API模式:",e)}switchToLocalStorage(){this.config.useAPI=!1,this.refreshCache(),console.log("[UserDataService] 已切换到localStorage模式")}getCurrentMode(){return this.config.useAPI?"API":"localStorage"}};export{e as default,e as userDataService};
