var we=Object.getOwnPropertySymbols;var Ze=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable;var be=(I,L)=>{var y={};for(var u in I)Ze.call(I,u)&&L.indexOf(u)<0&&(y[u]=I[u]);if(I!=null&&we)for(var u of we(I))L.indexOf(u)<0&&Ge.call(I,u)&&(y[u]=I[u]);return y};var C=(I,L,y)=>new Promise((u,Z)=>{var p=x=>{try{A(y.next(x))}catch(Y){Z(Y)}},G=x=>{try{A(y.throw(x))}catch(Y){Z(Y)}},A=x=>x.done?u(x.value):Promise.resolve(x.value).then(p,G);A((y=y.apply(I,L)).next())});import{l as Je,az as Xe,aC as et,r as N,Z as ne,e as E,w as Q,c as tt,n as $,aF as lt,Y as at,ag as b,m as O,p as S,q as d,U as l,O as s,u as g,T as v,F as ce,a9 as me,S as c,a7 as st,M as q,Q as F}from"./vendor-D8Vxqhr-.js";import{F as ot,a0 as nt,p as ke,I as rt,s as it,r as Se,n as Ce,E as h,b as Te}from"./elementPlus-Bmwh7Rh8.js";import{u as ut,h as dt,t as ct,g as mt,S as pe,c as pt,_ as ft}from"./settings-CuxbDWOu.js";import{d as fe}from"./sensitiveInfo-BWt1a88R.js";import{e as Ie}from"./export-CTEZNzGJ.js";import{D as gt}from"./DynamicTable-CiyMIP8-.js";import"./utils-ywHRn0uI.js";const vt={class:"customer-list"},ht={class:"summary-cards-row"},yt={class:"card-content"},_t={class:"card-icon"},wt={class:"card-info"},bt={class:"card-value"},kt={class:"card-content"},St={class:"card-icon active"},Ct={class:"card-info"},Tt={class:"card-value"},It={class:"card-content"},xt={class:"card-icon new"},Dt={class:"card-info"},Lt={class:"card-value"},Ut={class:"card-content"},Vt={class:"card-icon high-value"},Rt={class:"card-info"},$t={class:"card-value"},Ot={class:"quick-filters-row"},At={class:"quick-filter-buttons"},Mt={key:0,class:"allocated"},Bt={key:1,class:"self-created"},Nt={key:0},Pt={key:0,class:"expire-time"},zt={key:0,class:"share-dialog-content"},Et={class:"customer-info"},qt={class:"share-settings"},Ft={class:"time-limit-tip"},Yt={class:"dialog-footer"},Wt=Je({__name:"List",setup(I){const L=Xe(),y=et(),u=ut(),Z=dt(),p=ct(),G=mt(),A=pt(L),x=N(!1),Y=()=>C(this,null,function*(){return console.log("=== 检查用户登录状态 ==="),console.log("当前用户:",u.currentUser),console.log("是否已登录:",u.isLoggedIn),!u.isLoggedIn||!u.currentUser?(console.log("用户未登录，跳转到登录页面..."),h.warning("请先登录"),L.push("/login"),!1):(console.log("用户已登录，角色:",u.currentUser.role),!0)}),T=N(!1),U=N([]),i=ne({keyword:"",level:"",status:"",source:"",dateRange:[]}),V=ne({totalCustomers:0,activeCustomers:0,newCustomers:0,highValueCustomers:0}),P=N("all"),xe=[{value:"today",label:"今日"},{value:"yesterday",label:"昨日"},{value:"week",label:"7天"},{value:"month",label:"30天"},{value:"year",label:"年度"},{value:"all",label:"全部"}],_=ne({page:1,size:10,total:0}),W=N([{id:"sales1",name:"张销售",department:"销售一部"},{id:"sales2",name:"李销售",department:"销售二部"},{id:"sales3",name:"王销售",department:"销售一部"},{id:"admin",name:"管理员",department:"管理部"}]),re=E(()=>u.isSuperAdmin?!0:u.permissions.includes("customer.export")),J=E(()=>u.isSuperAdmin||re.value),De=E(()=>[{prop:"code",label:"客户编码",minWidth:130,visible:!0},{prop:"name",label:"客户姓名",minWidth:100,visible:!0},{prop:"phone",label:"手机号",width:130,visible:!0},{prop:"age",label:"年龄",width:70,visible:!0},{prop:"address",label:"地址",minWidth:180,showOverflowTooltip:!0,visible:!0},{prop:"level",label:"客户等级",width:90,visible:!0},{prop:"allocationSource",label:"来源",width:70,visible:!0},{prop:"status",label:"客户状态",width:90,visible:u.isManager||u.isSuperAdmin},{prop:"salesPerson",label:"负责销售",minWidth:100,visible:!0},{prop:"shareStatus",label:"分享状态",width:120,visible:u.isAdmin},{prop:"orderCount",label:"订单数",width:70,visible:!0},{prop:"createTime",label:"添加时间",width:160,visible:!0}]),z=E(()=>{console.log("=== searchResults computed 被调用 ==="),console.log("customerStore.customers.length:",p.customers.length);let t=p.customers;if(i.keyword){const e=i.keyword.toLowerCase().trim();t=t.filter(n=>!!(n.name.toLowerCase().includes(e)||n.phone.includes(i.keyword)||n.code&&n.code.toLowerCase().includes(e)||n.wechatId&&n.wechatId.toLowerCase().includes(e)||n.email&&n.email.toLowerCase().includes(e)||n.company&&n.company.toLowerCase().includes(e)))}if(i.level&&(t=t.filter(e=>e.level===i.level)),i.status&&(t=t.filter(e=>e.status===i.status)),i.dateRange&&i.dateRange.length===2){const[e,n]=i.dateRange;t=t.filter(a=>{if(!a.createTime)return!1;let r;try{if(r=new Date(a.createTime),isNaN(r.getTime()))return console.warn("无效的createTime格式:",a.createTime),!1}catch(B){return console.warn("解析createTime失败:",a.createTime,B),!1}const f=new Date(e+"T00:00:00"),w=new Date(n+"T23:59:59");return r>=f&&r<=w})}return t.sort((e,n)=>{const a=new Date(e.createTime||0).getTime();return new Date(n.createTime||0).getTime()-a}),t}),H=E(()=>z.value.length),ge=E(()=>{const t=(_.page-1)*_.size,e=t+_.size;return z.value.slice(t,e)}),ve=t=>({normal:"",silver:"info",gold:"warning"})[t]||"",X=t=>({normal:"普通",silver:"白银",gold:"黄金"})[t]||"普通",Le=t=>({active:"success",inactive:"info",potential:"warning",lost:"danger",blacklist:"danger"})[t]||"",ie=t=>({active:"活跃",inactive:"非活跃",potential:"潜在客户",lost:"流失客户",blacklist:"黑名单"})[t]||"未知",Ue=t=>{var e;return t.createdBy&&t.createdBy!==((e=u.currentUser)==null?void 0:e.id)},Ve=()=>{console.log("手动刷新，强制重新加载数据"),M(!0)},Re=t=>{P.value=t;const e=new Date,n=new Date(e);n.setDate(n.getDate()-1);const a=new Date(e);a.setDate(a.getDate()-7);const r=new Date(e);r.setDate(r.getDate()-30);const f=new Date(e.getFullYear(),0,1);switch(t){case"today":i.dateRange=[e.toISOString().split("T")[0],e.toISOString().split("T")[0]];break;case"yesterday":i.dateRange=[n.toISOString().split("T")[0],n.toISOString().split("T")[0]];break;case"week":i.dateRange=[a.toISOString().split("T")[0],e.toISOString().split("T")[0]];break;case"month":i.dateRange=[r.toISOString().split("T")[0],e.toISOString().split("T")[0]];break;case"year":i.dateRange=[f.toISOString().split("T")[0],e.toISOString().split("T")[0]];break;case"all":i.dateRange=[];break}le()},$e=()=>{A.push("/customer/add")},ee=t=>{A.push(`/customer/detail/${t.id}`)},Oe=t=>{const e=new URLSearchParams({customerId:t.id,customerName:t.name,customerPhone:t.phone,customerAddress:t.address||""});A.push(`/order/add?${e.toString()}`)},Ae=t=>C(this,null,function*(){try{h.info("正在发起外呼..."),setTimeout(()=>{var e;h.success("外呼已发起"),G.sendMessage(G.MessageType.CUSTOMER_CALL,`客户 ${t.name}（${fe(t.phone,pe.PHONE,((e=u.currentUser)==null?void 0:e.id)||"")}）外呼已发起`,{relatedId:t.id,relatedType:"customer",actionUrl:`/customer/detail/${t.id}?tab=followup`}),A.push({name:"CustomerDetail",params:{id:t.id},query:{tab:"followup"}})},1e3)}catch(e){h.error("外呼失败，请重试"),console.error("外呼失败:",e)}}),Me=t=>{U.value=t},Be=()=>C(this,null,function*(){if(!J.value){h.warning("您没有客户导出权限");return}try{const t=u.isSuperAdmin?"确定要导出所有客户数据吗？导出的数据将包含完整的客户信息。":"确定要导出所有客户数据吗？敏感信息将进行脱敏处理。";yield Te.confirm(t,"批量导出确认",{confirmButtonText:"确定导出",cancelButtonText:"取消",type:"warning"}),T.value=!0;try{const e=z.value.map(a=>({code:a.code||"",name:a.name,phone:a.phone,age:a.age,address:a.address,level:X(a.level),status:ie(a.status),salesPersonId:a.salesPersonId,salesPersonName:te(a.salesPersonId),orderCount:a.orderCount,createTime:a.createTime,createdBy:a.createdBy||"",wechatId:a.wechatId,email:a.email,company:a.company,position:a.position,source:a.allocationSource,tags:a.tags,remarks:a.remarks})),n=Ie(e,re.value);h.success(`客户数据导出成功：${n}`)}catch(e){console.error("导出失败:",e),h.error("导出失败，请重试")}finally{T.value=!1}}catch(t){t!=="cancel"&&h.error("操作取消")}}),Ne=()=>C(this,null,function*(){if(U.value.length===0){h.warning("请先选择要导出的客户");return}if(!J.value){h.warning("您没有客户导出权限");return}try{const t=u.isSuperAdmin?`确定要导出选中的 ${U.value.length} 个客户数据吗？导出的数据将包含完整的客户信息。`:`确定要导出选中的 ${U.value.length} 个客户数据吗？敏感信息将进行脱敏处理。`;yield Te.confirm(t,"导出选中客户",{confirmButtonText:"确定导出",cancelButtonText:"取消",type:"info"}),T.value=!0;try{const e=U.value.map(a=>({code:a.code||"",name:a.name,phone:a.phone,age:a.age,address:a.address,level:X(a.level),status:ie(a.status),salesPersonId:a.salesPersonId,salesPersonName:te(a.salesPersonId),orderCount:a.orderCount,createTime:a.createTime,createdBy:a.createdBy||"",wechatId:a.wechatId,email:a.email,company:a.company,position:a.position,source:a.allocationSource,tags:a.tags,remarks:a.remarks})),n=Ie(e,re.value);h.success(`选中客户数据导出成功：${n}`),U.value=[]}catch(e){console.error("导出失败:",e),h.error("导出失败，请重试")}finally{T.value=!1}}catch(t){t!=="cancel"&&h.error("操作取消")}}),j=N(!1),m=ne({targetUserId:"",timeLimit:7,remark:""}),R=N(null),Pe=[{label:"1天",value:1},{label:"3天",value:3},{label:"7天",value:7},{label:"15天",value:15},{label:"30天",value:30},{label:"永久",value:0}],ze=t=>C(this,null,function*(){if(!u.isAdmin){h.warning("只有管理员可以分享客户");return}R.value=t,m.targetUserId="",m.timeLimit=7,m.remark="",j.value=!0}),Ee=()=>C(this,null,function*(){if(!m.targetUserId){h.warning("请选择要分享给的销售人员");return}try{T.value=!0;const t=m.timeLimit===0?null:new Date(Date.now()+m.timeLimit*24*60*60*1e3);yield new Promise(f=>setTimeout(f,1e3));const e=R.value,n=e.salesPersonId;e.salesPersonId=m.targetUserId,e.shareInfo={originalOwner:n,sharedBy:u.currentUser.id,sharedAt:new Date().toISOString(),expireTime:t?t.toISOString():null,timeLimit:m.timeLimit,remark:m.remark,status:"active"};const a=W.value.find(f=>f.id===m.targetUserId),r=m.timeLimit===0?"永久":`${m.timeLimit}天`;h.success(`客户 ${e.name} 已成功分享给 ${a.name}，时间限制：${r}`),j.value=!1}catch(t){h.error("分享失败，请重试")}finally{T.value=!1}}),te=t=>{const e=W.value.find(n=>n.id===t);return e?e.name:"未分配"},he=()=>{const t=new Date;let e=0;p.customers.forEach(n=>{if(n.shareInfo&&n.shareInfo.status==="active"&&n.shareInfo.expireTime){const a=new Date(n.shareInfo.expireTime);if(t>=a){n.salesPersonId=n.shareInfo.originalOwner,n.shareInfo.status="expired",n.shareInfo.expiredAt=t.toISOString(),e++;const r=W.value.find(w=>w.id===n.shareInfo.originalOwner),f=W.value.find(w=>w.id===n.shareInfo.sharedBy);r&&f&&h.info(`客户 ${n.name} 的分享已到期，已自动回收到 ${r.name}`)}}}),e>0&&loadCustomers()},qe=t=>{const e=new Date,a=new Date(t).getTime()-e.getTime();if(a<=0)return"已过期";const r=Math.floor(a/(1e3*60*60*24)),f=Math.floor(a%(1e3*60*60*24)/(1e3*60*60));return r>0?`${r}天${f}小时`:f>0?`${f}小时`:`${Math.floor(a%36e5/6e4)}分钟`},Fe=t=>{if(!t||t.status!=="active")return"";if(!t.expireTime)return"success";const e=new Date,a=new Date(t.expireTime).getTime()-e.getTime(),r=Math.floor(a/(1e3*60*60*24));return r<=1?"danger":r<=3?"warning":"info"},le=()=>{_.page=1,_.total=H.value,ue()},Ye=()=>{Object.assign(i,{keyword:"",level:"",status:"",source:"",dateRange:[]}),le()},We=t=>{_.size=t,_.total=H.value},He=t=>{_.page=t},M=(t=!1)=>C(this,null,function*(){try{T.value=!0,console.log("=== loadCustomerList 开始 ==="),console.log("forceReload:",t),console.log("customerStore.customers.length:",p.customers.length),t?(console.log("强制刷新：重新从API加载客户数据"),yield p.forceRefreshCustomers(),yield $(),console.log("强制刷新完成，当前客户数量:",p.customers.length)):p.customers.length===0?(console.log("初始化：客户数据为空，从API加载"),yield p.loadCustomers(),yield $(),console.log("初始化加载完成，当前客户数量:",p.customers.length)):console.log("使用现有客户数据，保持本地新增的客户"),yield $(),console.log("当前客户数量:",p.customers.length),console.log("搜索结果数量:",z.value.length),_.total=z.value.length,console.log("分页总数:",_.total),yield ue(),console.log("=== loadCustomerList 完成 ===")}catch(e){console.error("loadCustomerList 错误:",e),Z.showError("加载客户列表失败",e)}finally{T.value=!1}}),ue=()=>{try{const t=z.value,n=new Date().toISOString().split("T")[0];V.totalCustomers=t.length,V.activeCustomers=t.filter(a=>a.status==="active").length,V.newCustomers=t.filter(a=>{if(!a.createTime)return!1;try{const r=new Date(a.createTime);return isNaN(r.getTime())?!1:r.toISOString().split("T")[0]===n}catch(r){return console.warn("解析客户创建时间失败:",a.createTime,r),!1}}).length,V.highValueCustomers=t.filter(a=>a.level==="gold").length,console.log("统计数据已更新:",V)}catch(t){console.error("加载统计数据失败:",t)}};Q(H,t=>{_.total=t}),Q(()=>p.customers,t=>{console.log("检测到customerStore客户数据变化，客户数量:",t.length),$(()=>{console.log("客户列表页面数据已更新，当前显示客户数量:",ge.value.length)})},{deep:!0,immediate:!0}),Q(z,()=>{ue()},{immediate:!0}),Q(()=>y.path,(t,e)=>C(this,null,function*(){t==="/customer/list"&&(console.log("路由切换到客户列表页面，从:",e,"到:",t),e==="/customer/add"?(console.log("从添加页面返回，执行强化数据同步流程"),_.page=1,i.keyword="",i.level="",i.status="",i.dateRange=null,P.value="all",yield $(),yield M(!0),console.log("强化数据同步完成，新客户应该已显示，当前客户数量:",p.customers.length)):e!=null&&e.startsWith("/customer/edit/")?(console.log("从编辑页面返回，重新加载数据"),yield M(!0)):!e||p.customers.length===0?(console.log("首次进入或列表为空，加载数据"),yield M(!0)):(console.log("其他情况，重新加载数据确保同步"),yield M(!1)))}),{immediate:!0}),Q(()=>y.query,t=>C(this,null,function*(){if(y.path==="/customer/list"&&t.refresh==="true"&&!x.value){x.value=!0,console.log("接收到刷新参数，强制重新加载客户列表"),_.page=1,i.keyword="",i.level="",i.dateRange=null,P.value="all",yield $(),M(!0);const e=t,{refresh:n,timestamp:a}=e,r=be(e,["refresh","timestamp"]),f=L.resolve({path:y.path,query:r}).href;window.history.replaceState(null,"",f)}}),{flush:"post"});const ae=N(null);return tt(()=>C(this,null,function*(){if(!(yield Y()))return;console.log("onMounted - customerStore:",p),console.log("onMounted - customerStore.customers:",p.customers),console.log("onMounted - customerStore.customers.length:",p.customers.length);const e=y.query.refresh==="true",n=!!y.query.timestamp;console.log("onMounted: 检查refresh参数:",e,"时间戳:",n),console.log("onMounted: 使用自动持久化的客户数据"),yield $();const a=e||n||p.customers.length===0;console.log("onMounted: 是否需要强制刷新:",a,"原因:",{shouldRefresh:e,hasTimestamp:n,isEmpty:p.customers.length===0}),(e||n)&&(console.log("onMounted: 检测到refresh参数或时间戳，重置分页和搜索条件"),_.currentPage=1,i.keyword="",i.level="",i.status="",i.dateRange=null,P.value="all",yield $()),console.log("onMounted: 加载客户数据，强制刷新:",a),yield M(a),ae.value=setInterval(()=>{he()},6e4),he()})),lt(()=>C(this,null,function*(){console.log("组件激活，检查是否需要刷新客户数据");const t=y.query.refresh==="true";console.log("onActivated: 检查refresh参数:",t),t?(console.log("onActivated: 检测到refresh参数，重新加载客户数据"),_.currentPage=1,i.keyword="",i.level="",i.status="",i.dateRange=null,P.value="all",yield $(),yield M(!0),yield L.replace({path:"/customer/list"})):_.total=H.value})),at(()=>{ae.value&&(clearInterval(ae.value),ae.value=null),document.querySelectorAll('a[href^="blob:"]').forEach(e=>{const n=e.getAttribute("href");n&&n.startsWith("blob:")&&(URL.revokeObjectURL(n),e.parentNode&&e.parentNode.removeChild(e))})}),(t,e)=>{const n=b("el-icon"),a=b("el-card"),r=b("el-button"),f=b("el-input"),w=b("el-form-item"),B=b("el-col"),je=b("el-date-picker"),k=b("el-option"),K=b("el-select"),ye=b("el-row"),_e=b("el-form"),se=b("el-tag"),de=b("el-text"),oe=b("el-descriptions-item"),Ke=b("el-descriptions"),Qe=b("el-dialog");return S(),O("div",vt,[d("div",ht,[l(a,{class:"summary-card"},{default:s(()=>[d("div",yt,[d("div",_t,[l(n,null,{default:s(()=>[l(g(ot))]),_:1})]),d("div",wt,[d("div",bt,v(V.totalCustomers),1),e[10]||(e[10]=d("div",{class:"card-label"},"总客户数",-1))])])]),_:1}),l(a,{class:"summary-card"},{default:s(()=>[d("div",kt,[d("div",St,[l(n,null,{default:s(()=>[l(g(nt))]),_:1})]),d("div",Ct,[d("div",Tt,v(V.activeCustomers),1),e[11]||(e[11]=d("div",{class:"card-label"},"活跃客户",-1))])])]),_:1}),l(a,{class:"summary-card"},{default:s(()=>[d("div",It,[d("div",xt,[l(n,null,{default:s(()=>[l(g(ke))]),_:1})]),d("div",Dt,[d("div",Lt,v(V.newCustomers),1),e[12]||(e[12]=d("div",{class:"card-label"},"新增客户",-1))])])]),_:1}),l(a,{class:"summary-card"},{default:s(()=>[d("div",Ut,[d("div",Vt,[l(n,null,{default:s(()=>[l(g(rt))]),_:1})]),d("div",Rt,[d("div",$t,v(V.highValueCustomers),1),e[13]||(e[13]=d("div",{class:"card-label"},"高价值客户",-1))])])]),_:1})]),d("div",Ot,[d("div",At,[(S(),O(ce,null,me(xe,o=>l(r,{key:o.value,type:P.value===o.value?"primary":"",plain:P.value!==o.value,round:"",size:"small",onClick:D=>Re(o.value)},{default:s(()=>[c(v(o.label),1)]),_:2},1032,["type","plain","onClick"])),64))])]),l(a,{class:"search-card",shadow:"never"},{default:s(()=>[l(_e,{model:i,"label-width":"80px",class:"search-form"},{default:s(()=>[l(ye,{gutter:20},{default:s(()=>[l(B,{span:6},{default:s(()=>[l(w,{label:"关键词"},{default:s(()=>[l(f,{modelValue:i.keyword,"onUpdate:modelValue":e[0]||(e[0]=o=>i.keyword=o),placeholder:"客户姓名、电话或编码",clearable:"",onKeyup:st(le,["enter"])},null,8,["modelValue"])]),_:1})]),_:1}),l(B,{span:6},{default:s(()=>[l(w,{label:"选择日期"},{default:s(()=>[l(je,{modelValue:i.dateRange,"onUpdate:modelValue":e[1]||(e[1]=o=>i.dateRange=o),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(B,{span:4},{default:s(()=>[l(w,{label:"客户等级"},{default:s(()=>[l(K,{modelValue:i.level,"onUpdate:modelValue":e[2]||(e[2]=o=>i.level=o),placeholder:"请选择",clearable:"",style:{width:"100%"}},{default:s(()=>[l(k,{label:"普通",value:"normal"}),l(k,{label:"白银",value:"silver"}),l(k,{label:"黄金",value:"gold"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(B,{span:4},{default:s(()=>[l(w,{label:"客户状态"},{default:s(()=>[l(K,{modelValue:i.status,"onUpdate:modelValue":e[3]||(e[3]=o=>i.status=o),placeholder:"请选择",clearable:"",style:{width:"100%"}},{default:s(()=>[l(k,{label:"活跃",value:"active"}),l(k,{label:"非活跃",value:"inactive"}),l(k,{label:"潜在客户",value:"potential"}),l(k,{label:"流失客户",value:"lost"}),l(k,{label:"黑名单",value:"blacklist"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(B,{span:4},{default:s(()=>[l(w,{label:"客户来源"},{default:s(()=>[l(K,{modelValue:i.source,"onUpdate:modelValue":e[4]||(e[4]=o=>i.source=o),placeholder:"请选择",clearable:"",style:{width:"100%"}},{default:s(()=>[l(k,{label:"线上推广",value:"online"}),l(k,{label:"线下活动",value:"offline"}),l(k,{label:"客户推荐",value:"referral"}),l(k,{label:"电话营销",value:"telemarketing"}),l(k,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(ye,{gutter:20},{default:s(()=>[l(B,{span:24},{default:s(()=>[l(w,null,{default:s(()=>[l(r,{type:"primary",onClick:le,icon:g(it)},{default:s(()=>[...e[14]||(e[14]=[c("搜索",-1)])]),_:1},8,["icon"]),l(r,{onClick:Ye,icon:g(Se)},{default:s(()=>[...e[15]||(e[15]=[c("重置",-1)])]),_:1},8,["icon"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(gt,{data:ge.value,columns:De.value,"storage-key":"customer-list-columns",title:"客户列表",loading:T.value,"show-selection":!0,"show-actions":!0,total:H.value,"page-sizes":[10,20,50,100],onSelectionChange:Me,onSizeChange:We,onCurrentChange:He,class:"customer-table"},{"header-actions":s(()=>{var o;return[g(u).isAdmin||((o=g(u).currentUser)==null?void 0:o.role)==="manager"?(S(),q(r,{key:0,type:"primary",onClick:$e},{default:s(()=>[l(n,null,{default:s(()=>[l(g(ke))]),_:1}),e[16]||(e[16]=c(" 新建客户 ",-1))]),_:1})):F("",!0),J.value?(S(),q(r,{key:1,type:"success",onClick:Be},{default:s(()=>[l(n,null,{default:s(()=>[l(g(Ce))]),_:1}),e[17]||(e[17]=c(" 批量导出 ",-1))]),_:1})):F("",!0),J.value&&U.value.length>0?(S(),q(r,{key:2,type:"warning",onClick:Ne,disabled:U.value.length===0},{default:s(()=>[l(n,null,{default:s(()=>[l(g(Ce))]),_:1}),c(" 导出选中 ("+v(U.value.length)+") ",1)]),_:1},8,["disabled"])):F("",!0),l(r,{onClick:Ve,loading:T.value},{default:s(()=>[l(n,null,{default:s(()=>[l(g(Se))]),_:1}),e[18]||(e[18]=c(" 刷新 ",-1))]),_:1},8,["loading"])]}),"column-code":s(({row:o})=>[l(r,{type:"text",onClick:D=>ee(o),class:"code-link"},{default:s(()=>[c(v(o.code||"N/A"),1)]),_:2},1032,["onClick"])]),"column-name":s(({row:o})=>[l(r,{type:"text",onClick:D=>ee(o),class:"name-link"},{default:s(()=>[c(v(o.name),1)]),_:2},1032,["onClick"])]),"column-phone":s(({row:o})=>[l(r,{type:"text",onClick:D=>ee(o),class:"phone-link"},{default:s(()=>{var D;return[c(v(g(fe)(o.phone,g(pe).PHONE,((D=g(u).currentUser)==null?void 0:D.id)||"")),1)]}),_:2},1032,["onClick"])]),"column-level":s(({row:o})=>[l(se,{type:ve(o.level)},{default:s(()=>[c(v(X(o.level)),1)]),_:2},1032,["type"])]),"column-allocationSource":s(({row:o})=>[Ue(o)?(S(),O("span",Mt,"分配")):(S(),O("span",Bt,"自建"))]),"column-status":s(({row:o})=>[l(se,{type:Le(o.status)},{default:s(()=>[c(v(ie(o.status)),1)]),_:2},1032,["type"])]),"column-salesPerson":s(({row:o})=>[c(v(te(o.salesPersonId)),1)]),"column-shareStatus":s(({row:o})=>[o.shareInfo&&o.shareInfo.status==="active"?(S(),O("div",Nt,[l(se,{type:Fe(o.shareInfo),size:"small"},{default:s(()=>[c(v(o.shareInfo.expireTime?"限时分享":"永久分享"),1)]),_:2},1032,["type"]),o.shareInfo.expireTime?(S(),O("div",Pt,[l(de,{size:"small",type:"info"},{default:s(()=>[c(" 剩余: "+v(qe(o.shareInfo.expireTime)),1)]),_:2},1024)])):F("",!0)])):(S(),q(de,{key:1,size:"small",type:"info"},{default:s(()=>[...e[19]||(e[19]=[c("未分享",-1)])]),_:1}))]),"table-actions":s(({row:o})=>[l(r,{type:"text",size:"small",onClick:D=>ee(o)},{default:s(()=>[...e[20]||(e[20]=[c("详情",-1)])]),_:1},8,["onClick"]),l(r,{type:"text",size:"small",onClick:D=>Oe(o)},{default:s(()=>[...e[21]||(e[21]=[c("下单",-1)])]),_:1},8,["onClick"]),l(r,{type:"text",size:"small",onClick:D=>Ae(o)},{default:s(()=>[...e[22]||(e[22]=[c("外呼",-1)])]),_:1},8,["onClick"]),g(u).isAdmin?(S(),q(r,{key:0,type:"text",size:"small",onClick:D=>ze(o)},{default:s(()=>[...e[23]||(e[23]=[c("分享",-1)])]),_:1},8,["onClick"])):F("",!0)]),_:1},8,["data","columns","loading","total"]),l(Qe,{modelValue:j.value,"onUpdate:modelValue":e[9]||(e[9]=o=>j.value=o),title:"分享客户",width:"500px","close-on-click-modal":!1},{footer:s(()=>[d("div",Yt,[l(r,{onClick:e[8]||(e[8]=o=>j.value=!1)},{default:s(()=>[...e[26]||(e[26]=[c("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:Ee,loading:T.value},{default:s(()=>[...e[27]||(e[27]=[c(" 确认分享 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[R.value?(S(),O("div",zt,[d("div",Et,[e[24]||(e[24]=d("h4",null,"客户信息",-1)),l(Ke,{column:2,border:"",size:"small"},{default:s(()=>[l(oe,{label:"客户姓名"},{default:s(()=>[c(v(R.value.name),1)]),_:1}),l(oe,{label:"联系电话"},{default:s(()=>{var o;return[c(v(g(fe)(R.value.phone,g(pe).PHONE,((o=g(u).currentUser)==null?void 0:o.id)||"")),1)]}),_:1}),l(oe,{label:"客户等级"},{default:s(()=>[l(se,{type:ve(R.value.level),size:"small"},{default:s(()=>[c(v(X(R.value.level)),1)]),_:1},8,["type"])]),_:1}),l(oe,{label:"当前归属"},{default:s(()=>[c(v(te(R.value.salesPersonId)),1)]),_:1})]),_:1})]),d("div",qt,[e[25]||(e[25]=d("h4",null,"分享设置",-1)),l(_e,{model:m,"label-width":"100px"},{default:s(()=>[l(w,{label:"分享给",required:""},{default:s(()=>[l(K,{modelValue:m.targetUserId,"onUpdate:modelValue":e[5]||(e[5]=o=>m.targetUserId=o),placeholder:"请选择销售人员",style:{width:"100%"},filterable:""},{default:s(()=>[(S(!0),O(ce,null,me(W.value.filter(o=>o.id!==R.value.salesPersonId),o=>(S(),q(k,{key:o.id,label:`${o.name} (${o.department})`,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(w,{label:"时间限制",required:""},{default:s(()=>[l(K,{modelValue:m.timeLimit,"onUpdate:modelValue":e[6]||(e[6]=o=>m.timeLimit=o),style:{width:"100%"}},{default:s(()=>[(S(),O(ce,null,me(Pe,o=>l(k,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),d("div",Ft,[l(de,{size:"small",type:"info"},{default:s(()=>[c(v(m.timeLimit===0?"永久分享，不会自动回收":`${m.timeLimit}天后自动回收到原归属人`),1)]),_:1})])]),_:1}),l(w,{label:"分享备注"},{default:s(()=>[l(f,{modelValue:m.remark,"onUpdate:modelValue":e[7]||(e[7]=o=>m.remark=o),type:"textarea",rows:3,placeholder:"请输入分享原因或备注信息（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])])):F("",!0)]),_:1},8,["modelValue"])])}}}),el=ft(Wt,[["__scopeId","data-v-1c20225c"]]);export{el as default};
