const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/userApiService-C9CF7lV2.js","assets/settings-CuxbDWOu.js","assets/elementPlus-Bmwh7Rh8.js","assets/vendor-D8Vxqhr-.js","assets/utils-ywHRn0uI.js","assets/settings-B8JH4JCn.css"])))=>i.map(i=>d[i]);
var ze=Object.defineProperty,Be=Object.defineProperties;var Re=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var qe=Object.prototype.hasOwnProperty,Me=Object.prototype.propertyIsEnumerable;var se=(u,p,i)=>p in u?ze(u,p,{enumerable:!0,configurable:!0,writable:!0,value:i}):u[p]=i,ne=(u,p)=>{for(var i in p||(p={}))qe.call(p,i)&&se(u,i,p[i]);if(te)for(var i of te(p))Me.call(p,i)&&se(u,i,p[i]);return u},oe=(u,p)=>Be(u,Re(p));var O=(u,p,i)=>new Promise((z,x)=>{var I=g=>{try{C(i.next(g))}catch(k){x(k)}},U=g=>{try{C(i.throw(g))}catch(k){x(k)}},C=g=>g.done?z(g.value):Promise.resolve(g.value).then(I,U);C((i=i.apply(u,p)).next())});import{W as Ne,a as $e,u as je,_ as Le}from"./settings-CuxbDWOu.js";import{l as Ze,r as T,e as F,Z as Je,w as L,ag as m,M as A,p as b,O as l,q as t,U as o,u as y,m as D,F as q,a9 as M,S as w,T as v,R as Z,P as We,J as Ge,a2 as He,V as Qe,n as ae}from"./vendor-D8Vxqhr-.js";import{aC as le,e as ie,f as re,i as J,r as Xe,I as de,a0 as Ye,aj as Ke,E as ce}from"./elementPlus-Bmwh7Rh8.js";import{useDepartmentStore as et}from"./department-CTOju6hT.js";import me from"./departmentPermissionService--eajZN4h.js";const tt={class:"dialog-content"},st={class:"form-section"},nt={class:"section-header"},ot={class:"form-grid"},at={class:"form-section"},lt={class:"section-header"},it={class:"header-content"},rt={class:"header-icon"},dt={class:"header-actions"},ct={class:"permission-stats"},mt={class:"stat-item"},ut={class:"stat-number"},pt={class:"stat-item"},ft={class:"stat-number"},vt={class:"permission-section"},_t={class:"action-bar"},gt={class:"action-left"},ht={class:"section-title"},bt={class:"action-right"},wt={class:"template-section"},yt={class:"template-header"},kt={class:"template-grid"},xt=["onClick"],Vt={class:"template-icon"},Pt={class:"template-content"},It={class:"template-name"},Ct={class:"template-desc"},Et={class:"template-badge"},St={class:"department-permission-config"},Dt={class:"config-header"},Ut={class:"config-content"},Ot={class:"config-item"},Tt={class:"config-item"},Ft={class:"config-item"},At={class:"permission-content"},zt={class:"permission-grid"},Bt={class:"category-header"},Rt={class:"category-title"},qt={class:"category-info"},Mt={class:"category-icon"},Nt={class:"category-text"},$t={class:"category-name"},jt={class:"category-count"},Lt={class:"permission-list"},Zt={class:"permission-info"},Jt={class:"permission-main"},Wt={class:"permission-name"},Gt={class:"permission-desc"},Ht={class:"form-section"},Qt={class:"dialog-footer"},Xt=Ze({__name:"DepartmentDialog",props:{modelValue:{type:Boolean},department:{default:null},isEdit:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup(u,{emit:p}){const i=u,z=p,x=et(),I=T(),U=T(!1),C=F(()=>Ne.getAllPermissions()),g=F(()=>{const a=(e,s="")=>{const d=[];return e.forEach(c=>{if(c.type==="action"&&d.push({id:c.id,code:c.code,name:c.name,parentPath:s,level:B(c.code)}),c.children&&c.children.length>0){const f=s?`${s} > ${c.name}`:c.name;d.push(...a(c.children,f))}}),d};return a(C.value)}),k=F(()=>{const a=[];return C.value.forEach(e=>{const s=[],d=c=>{c.forEach(f=>{f.type==="action"&&s.push({id:f.id,code:f.code,name:f.name,level:B(f.code)}),f.children&&d(f.children)})};e.children&&d(e.children),a.push({id:e.id,name:e.name,icon:e.icon||"Setting",permissions:s})}),a}),N=[{key:"basic",name:"基础权限",description:"适合普通员工的基础操作权限",icon:Ye,count:8,permissions:["customer.list.view","customer.follow","order.list.view","order.create","product.list","service.ticket.view","service.ticket.create","service.chat.view","service.chat.reply","service.knowledge.view","data.list.view","data.search.basic","performance.personal.view"]},{key:"advanced",name:"高级权限",description:"适合主管级别的进阶操作权限",icon:de,count:15,permissions:["customer.list.view","customer.list.export","customer.add.create","customer.edit","customer.follow","order.list.view","order.create","order.edit","order.status","product.list","product.add","product.edit","product.category","service.ticket.view","service.ticket.create","service.ticket.edit","service.ticket.assign","service.chat.view","service.chat.reply","service.chat.transfer","service.chat.history","service.knowledge.view","service.knowledge.create","service.knowledge.edit","data.list.view","data.search.basic","data.search.advanced","performance.personal.view","performance.team.view"]},{key:"manager",name:"管理员权限",description:"拥有所有操作权限，适合管理员",icon:Ke,count:25,permissions:[]},{key:"custom",name:"自定义权限",description:"根据需要自由选择权限组合",icon:J,count:0,permissions:[]}],B=a=>{const e={basic:{text:"基础",type:"info",color:"#0ea5e9"},advanced:{text:"高级",type:"warning",color:"#f59e0b"},admin:{text:"管理员",type:"danger",color:"#ef4444"}};return e[a]||e.basic},ue=a=>({"customer:read":"查看客户列表和详细信息","customer:write":"创建和编辑客户信息","customer:delete":"删除客户记录","order:read":"查看订单列表和详情","order:write":"创建和编辑订单","order:audit":"审核和确认订单","order:delete":"删除订单记录","finance:read":"查看财务报表和数据","finance:write":"编辑财务信息","logistics:read":"查看物流信息","logistics:write":"管理物流配送","service:read":"查看客服记录","service:write":"处理客服工单","performance:read":"查看绩效数据","performance:write":"编辑绩效考核","system:read":"查看系统配置","system:write":"管理系统设置"})[a]||"暂无描述",n=Je({name:"",code:"",parentId:null,managerId:null,sortOrder:1,status:"active",permissions:[],description:"",inheritFromParent:!1,dataScope:"department",managerExtraPermissions:[]}),E=T(!1),_=T(""),pe=F(()=>g.value.length),fe=a=>{const e=k.value.find(s=>s.id===a);return e?e.permissions.filter(s=>n.permissions.includes(s.code)).length:0},ve=()=>{E.value=!E.value},W=()=>{const a=g.value.map(e=>e.code);n.permissions=[...a],_.value="manager"},_e=()=>{n.permissions=[],_.value=""},ge=()=>{i.department?n.permissions=[...i.department.permissions||[]]:n.permissions=[],_.value=""},he=a=>{const e=N.find(s=>s.key===a);e&&(a==="manager"?W():a==="custom"?_.value="custom":(n.permissions=[...e.permissions],_.value=a))},be=a=>{const e=k.value.find(s=>s.id===a);return e?e.permissions.every(s=>n.permissions.includes(s.code)):!1},we=a=>{const e=k.value.find(d=>d.id===a);if(!e)return!1;const s=e.permissions.filter(d=>n.permissions.includes(d.code)).length;return s>0&&s<e.permissions.length},ye=(a,e)=>{const s=k.value.find(d=>d.id===a);s&&(e?s.permissions.forEach(d=>{n.permissions.includes(d.code)||n.permissions.push(d.code)}):s.permissions.forEach(d=>{const c=n.permissions.indexOf(d.code);c>-1&&n.permissions.splice(c,1)}))},ke={name:[{required:!0,message:"请输入部门名称",trigger:"blur"},{min:2,max:50,message:"部门名称长度在 2 到 50 个字符",trigger:"blur"}],code:[{required:!0,message:"请输入部门编码",trigger:"blur"},{min:2,max:20,message:"部门编码长度在 2 到 20 个字符",trigger:"blur"},{pattern:/^[A-Z0-9_]+$/,message:"部门编码只能包含大写字母、数字和下划线",trigger:"blur"}],sort:[{required:!0,message:"请输入排序号",trigger:"blur"}],status:[{required:!0,message:"请选择部门状态",trigger:"change"}]},xe={value:"id",label:"name",children:"children"},Ve=F(()=>{const a=e=>e.filter(s=>i.isEdit&&i.department?s.id!==i.department.id&&!Pe(s.id,i.department.id):!0).map(s=>oe(ne({},s),{children:s.children?a(s.children):[]}));return a(x.departmentTree)}),Pe=(a,e)=>{const s=(f,V)=>{for(const P of f){if(P.id===V)return P;if(P.children){const R=s(P.children,V);if(R)return R}}return null},d=s(x.departmentTree,a);if(!d)return!1;let c=d;for(;c.parentId;){if(c.parentId===e)return!0;if(c=s(x.departmentTree,c.parentId)||c,!c.parentId)break}return!1},$=T([]),Ie=()=>O(this,null,function*(){try{const{userApiService:a}=yield $e(()=>O(this,null,function*(){const{userApiService:s}=yield import("./userApiService-C9CF7lV2.js");return{userApiService:s}}),__vite__mapDeps([0,1,2,3,4,5])),e=yield a.getUsers({status:"active"});$.value=e.data.map(s=>{var d;return{id:s.id.toString(),name:s.realName||s.username,role:s.role,department:(d=s.department)==null?void 0:d.name}})}catch(a){console.error("加载用户列表失败:",a);const e=je();yield e.loadUsers(),$.value=e.users.map(s=>({id:s.id,name:s.name,role:s.role,department:s.department}))}}),G=()=>{Object.assign(n,{name:"",code:"",parentId:null,managerId:null,sortOrder:1,status:"active",permissions:[],description:""}),_.value="",E.value=!1,ae(()=>{var a;(a=I.value)==null||a.clearValidate()})},H=()=>{const a=n.permissions;for(const e of N)if(e.key!=="custom"){if(e.key==="manager"){if(g.value.map(d=>d.code).every(d=>a.includes(d)))return"manager"}else if(e.permissions.length===a.length&&e.permissions.every(s=>a.includes(s)))return e.key}return a.length>0?"custom":""},Q=()=>O(this,null,function*(){if(i.isEdit&&i.department){Object.assign(n,{name:i.department.name,code:i.department.code,parentId:i.department.parentId,managerId:null,sortOrder:i.department.sortOrder||1,status:i.department.status,permissions:[],description:i.department.description||""});try{const a=me.getDepartmentPermissions(i.department.id);n.inheritFromParent=a.inheritFromParent,n.dataScope=a.dataScope,n.managerExtraPermissions=[...a.managerExtraPermissions]}catch(a){console.warn("加载部门权限配置失败:",a),n.inheritFromParent=!1,n.dataScope="department",n.managerExtraPermissions=[]}ae(()=>{_.value=H()})}else G(),_.value=""});L(()=>i.modelValue,a=>{a&&(Q(),Ie())}),L(()=>i.department,()=>{i.modelValue&&Q()}),L(()=>n.permissions,()=>{if(n.permissions.length===0)_.value="";else{const a=H();a!==_.value&&(_.value=a)}},{deep:!0});const X=()=>{z("update:modelValue",!1),G()},Ce=()=>O(this,null,function*(){if(I.value)try{if(!(yield I.value.validate()))return;U.value=!0;let e;i.isEdit&&i.department?(yield x.updateDepartment(i.department.id,{name:n.name,code:n.code,parentId:n.parentId,sortOrder:n.sortOrder,status:n.status,description:n.description}),e=i.department.id):e=(yield x.addDepartment({name:n.name,code:n.code,parentId:n.parentId,sortOrder:n.sortOrder,status:n.status,description:n.description})).id,yield me.setDepartmentPermissions(e,{permissions:n.permissions,inheritFromParent:n.inheritFromParent,dataScope:n.dataScope,managerExtraPermissions:n.managerExtraPermissions}),ce.success(i.isEdit?"部门更新成功":"部门创建成功"),z("success")}catch(a){ce.error(a instanceof Error?a.message:"操作失败")}finally{U.value=!1}});return(a,e)=>{const s=m("el-icon"),d=m("el-input"),c=m("el-form-item"),f=m("el-tree-select"),V=m("el-option"),P=m("el-select"),R=m("el-input-number"),Y=m("el-radio"),Ee=m("el-radio-group"),S=m("el-button"),Se=m("el-button-group"),De=m("el-switch"),j=m("el-col"),K=m("el-tag"),Ue=m("el-row"),ee=m("el-checkbox"),Oe=m("el-checkbox-group"),Te=m("el-collapse-transition"),Fe=m("el-form"),Ae=m("el-dialog");return b(),A(Ae,{"model-value":u.modelValue,title:u.isEdit?"编辑部门":"新建部门",width:"900px","before-close":X,class:"department-dialog","align-center":"","destroy-on-close":""},{footer:l(()=>[t("div",Qt,[o(S,{onClick:X,class:"cancel-btn"},{default:l(()=>[...e[34]||(e[34]=[w(" 取消 ",-1)])]),_:1}),o(S,{type:"primary",onClick:Ce,loading:U.value,class:"submit-btn"},{default:l(()=>[w(v(u.isEdit?"保存":"创建"),1)]),_:1},8,["loading"])])]),default:l(()=>[t("div",tt,[o(Fe,{ref_key:"formRef",ref:I,model:n,rules:ke,"label-width":"100px",class:"department-form","label-position":"left"},{default:l(()=>[t("div",st,[t("div",nt,[o(s,{class:"section-icon"},{default:l(()=>[o(y(le))]),_:1}),e[11]||(e[11]=t("span",{class:"section-title"},"基本信息",-1))]),t("div",ot,[o(c,{label:"部门名称",prop:"name",class:"form-item"},{default:l(()=>[o(d,{modelValue:n.name,"onUpdate:modelValue":e[0]||(e[0]=r=>n.name=r),placeholder:"请输入部门名称",maxlength:"50","show-word-limit":"",class:"compact-input"},null,8,["modelValue"])]),_:1}),o(c,{label:"部门编码",prop:"code",class:"form-item"},{default:l(()=>[o(d,{modelValue:n.code,"onUpdate:modelValue":e[1]||(e[1]=r=>n.code=r),placeholder:"请输入部门编码",maxlength:"20","show-word-limit":"",class:"compact-input"},null,8,["modelValue"])]),_:1}),o(c,{label:"上级部门",prop:"parentId",class:"form-item"},{default:l(()=>[o(f,{modelValue:n.parentId,"onUpdate:modelValue":e[2]||(e[2]=r=>n.parentId=r),data:Ve.value,props:xe,placeholder:"请选择上级部门（可选）",clearable:"","check-strictly":"","render-after-expand":!1,class:"compact-select"},null,8,["modelValue","data"])]),_:1}),o(c,{label:"部门负责人",prop:"managerId",class:"form-item"},{default:l(()=>[o(P,{modelValue:n.managerId,"onUpdate:modelValue":e[3]||(e[3]=r=>n.managerId=r),placeholder:"请选择部门负责人（可选）",clearable:"",filterable:"",class:"compact-select"},{default:l(()=>[(b(!0),D(q,null,M($.value,r=>(b(),A(V,{key:r.id,label:r.name,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(c,{label:"排序",prop:"sort",class:"form-item"},{default:l(()=>[o(R,{modelValue:n.sortOrder,"onUpdate:modelValue":e[4]||(e[4]=r=>n.sortOrder=r),min:1,max:999,placeholder:"排序号",class:"compact-number","controls-position":"right"},null,8,["modelValue"])]),_:1}),o(c,{label:"状态",prop:"status",class:"form-item"},{default:l(()=>[o(Ee,{modelValue:n.status,"onUpdate:modelValue":e[5]||(e[5]=r=>n.status=r),class:"compact-radio"},{default:l(()=>[o(Y,{value:"active"},{default:l(()=>[o(s,null,{default:l(()=>[o(y(ie))]),_:1}),e[12]||(e[12]=w(" 启用 ",-1))]),_:1}),o(Y,{value:"inactive"},{default:l(()=>[o(s,null,{default:l(()=>[o(y(re))]),_:1}),e[13]||(e[13]=w(" 停用 ",-1))]),_:1})]),_:1},8,["modelValue"])]),_:1})])]),t("div",at,[t("div",lt,[t("div",it,[t("div",rt,[o(s,{class:"section-icon"},{default:l(()=>[o(y(J))]),_:1})]),e[14]||(e[14]=t("div",{class:"header-text"},[t("span",{class:"section-title"},"权限配置"),t("span",{class:"header-subtitle"},"配置部门成员的系统访问权限")],-1))]),t("div",dt,[t("div",ct,[t("div",mt,[t("span",ut,v(n.permissions.length),1),e[15]||(e[15]=t("span",{class:"stat-label"},"已选权限",-1))]),e[17]||(e[17]=t("div",{class:"stat-divider"},null,-1)),t("div",pt,[t("span",ft,v(pe.value),1),e[16]||(e[16]=t("span",{class:"stat-label"},"总权限数",-1))])]),o(S,{type:"text",size:"small",onClick:ve,class:"expand-btn toggle-button"},{default:l(()=>[w(v(E.value?"收起":"展开")+" ",1),o(s,null,{default:l(()=>[(b(),A(Z(E.value?"ArrowUp":"ArrowDown")))]),_:1})]),_:1})])]),o(Te,null,{default:l(()=>[We(t("div",vt,[t("div",_t,[t("div",gt,[t("h4",ht,[o(s,null,{default:l(()=>[o(y(J))]),_:1}),e[18]||(e[18]=w(" 权限配置 ",-1))])]),t("div",bt,[o(Se,{size:"small"},{default:l(()=>[o(S,{onClick:W,size:"small"},{default:l(()=>[o(s,null,{default:l(()=>[o(y(ie))]),_:1}),e[19]||(e[19]=w(" 全选 ",-1))]),_:1}),o(S,{onClick:_e,size:"small"},{default:l(()=>[o(s,null,{default:l(()=>[o(y(re))]),_:1}),e[20]||(e[20]=w(" 清空 ",-1))]),_:1}),o(S,{onClick:ge,size:"small"},{default:l(()=>[o(s,null,{default:l(()=>[o(y(Xe))]),_:1}),e[21]||(e[21]=w(" 重置 ",-1))]),_:1})]),_:1})])]),t("div",wt,[t("div",yt,[o(s,null,{default:l(()=>[o(y(de))]),_:1}),e[22]||(e[22]=t("span",null,"快捷模板",-1))]),t("div",kt,[(b(),D(q,null,M(N,r=>t("div",{key:r.key,onClick:h=>he(r.key),class:Ge(["template-card",{active:_.value===r.key}])},[t("div",Vt,[o(s,null,{default:l(()=>[(b(),A(Z(r.icon)))]),_:2},1024)]),t("div",Pt,[t("h5",It,v(r.name),1),t("p",Ct,v(r.description),1)]),t("div",Et,[t("span",null,v(r.count)+"项",1)])],10,xt)),64))])]),t("div",St,[t("div",Dt,[o(s,null,{default:l(()=>[o(y(le))]),_:1}),e[23]||(e[23]=t("span",null,"部门权限配置",-1))]),t("div",Ut,[o(Ue,{gutter:20},{default:l(()=>[o(j,{span:8},{default:l(()=>[t("div",Ot,[e[24]||(e[24]=t("label",{class:"config-label"},"权限继承",-1)),o(De,{modelValue:n.inheritFromParent,"onUpdate:modelValue":e[6]||(e[6]=r=>n.inheritFromParent=r),"active-text":"继承父部门权限","inactive-text":"独立权限配置",disabled:!n.parentId},null,8,["modelValue","disabled"]),e[25]||(e[25]=t("p",{class:"config-desc"},"启用后，该部门将自动继承父部门的所有权限",-1))])]),_:1}),o(j,{span:8},{default:l(()=>[t("div",Tt,[e[29]||(e[29]=t("label",{class:"config-label"},"数据范围",-1)),o(P,{modelValue:n.dataScope,"onUpdate:modelValue":e[7]||(e[7]=r=>n.dataScope=r),placeholder:"选择数据访问范围"},{default:l(()=>[o(V,{label:"仅个人数据",value:"self"},{default:l(()=>[...e[26]||(e[26]=[t("div",{class:"option-content"},[t("span",null,"仅个人数据"),t("small",null,"只能查看自己的数据")],-1)])]),_:1}),o(V,{label:"部门数据",value:"department"},{default:l(()=>[...e[27]||(e[27]=[t("div",{class:"option-content"},[t("span",null,"部门数据"),t("small",null,"可查看本部门所有数据")],-1)])]),_:1}),o(V,{label:"全部数据",value:"all"},{default:l(()=>[...e[28]||(e[28]=[t("div",{class:"option-content"},[t("span",null,"全部数据"),t("small",null,"可查看所有部门数据")],-1)])]),_:1})]),_:1},8,["modelValue"]),e[30]||(e[30]=t("p",{class:"config-desc"},"设置部门成员可访问的数据范围",-1))])]),_:1}),o(j,{span:8},{default:l(()=>[t("div",Ft,[e[32]||(e[32]=t("label",{class:"config-label"},"负责人权限",-1)),o(K,{type:"info",size:"small"},{default:l(()=>[...e[31]||(e[31]=[w("自动配置",-1)])]),_:1}),e[33]||(e[33]=t("p",{class:"config-desc"},"部门负责人将自动获得查看部门全部数据的权限",-1))])]),_:1})]),_:1})])]),t("div",At,[t("div",zt,[(b(!0),D(q,null,M(k.value,r=>(b(),D("div",{key:r.id,class:"permission-category"},[t("div",Bt,[t("div",Rt,[o(ee,{"model-value":be(r.id),indeterminate:we(r.id),onChange:h=>ye(r.id,h),onClick:e[8]||(e[8]=He(()=>{},["stop"])),class:"category-checkbox"},{default:l(()=>[t("div",qt,[t("div",Mt,[o(s,null,{default:l(()=>[(b(),A(Z(r.icon)))]),_:2},1024)]),t("div",Nt,[t("span",$t,v(r.name),1),t("span",jt,v(fe(r.id))+"/"+v(r.permissions.length),1)])])]),_:2},1032,["model-value","indeterminate","onChange"])])]),t("div",Lt,[o(Oe,{modelValue:n.permissions,"onUpdate:modelValue":e[9]||(e[9]=h=>n.permissions=h)},{default:l(()=>[(b(!0),D(q,null,M(r.permissions,h=>(b(),D("div",{key:h.code,class:"permission-item"},[o(ee,{value:h.code,class:"permission-checkbox"},{default:l(()=>[t("div",Zt,[t("div",Jt,[t("span",Wt,v(h.name),1),o(K,{type:B(h.level).type,size:"small",class:"permission-level"},{default:l(()=>[w(v(B(h.level).text),1)]),_:2},1032,["type"])]),t("p",Gt,v(ue(h.code)),1)])]),_:2},1032,["value"])]))),128))]),_:2},1032,["modelValue"])])]))),128))])])],512),[[Qe,E.value]])]),_:1})]),t("div",Ht,[o(c,{label:"部门描述",prop:"description",class:"description-item"},{default:l(()=>[o(d,{modelValue:n.description,"onUpdate:modelValue":e[10]||(e[10]=r=>n.description=r),type:"textarea",rows:2,placeholder:"请输入部门描述（可选）",maxlength:"200","show-word-limit":"",class:"compact-textarea"},null,8,["modelValue"])]),_:1})])]),_:1},8,["model"])])]),_:1},8,["model-value","title"])}}}),os=Le(Xt,[["__scopeId","data-v-585925ad"]]);export{os as D};
