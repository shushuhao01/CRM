var kl=Object.defineProperty,Sl=Object.defineProperties;var xl=Object.getOwnPropertyDescriptors;var nt=Object.getOwnPropertySymbols;var Nl=Object.prototype.hasOwnProperty,Cl=Object.prototype.propertyIsEnumerable;var rt=(B,n,p)=>n in B?kl(B,n,{enumerable:!0,configurable:!0,writable:!0,value:p}):B[n]=p,it=(B,n)=>{for(var p in n||(n={}))Nl.call(n,p)&&rt(B,p,n[p]);if(nt)for(var p of nt(n))Cl.call(n,p)&&rt(B,p,n[p]);return B},dt=(B,n)=>Sl(B,xl(n));var S=(B,n,p)=>new Promise((h,A)=>{var Q=$=>{try{w(p.next($))}catch(u){A(u)}},Z=$=>{try{w(p.throw($))}catch(u){A(u)}},w=$=>$.done?h($.value):Promise.resolve($.value).then(Q,Z);w((p=p.apply(B,n)).next())});import{t as ut,j as ct,y as mt,u as Il,S as Me,W as K,X as pt,_ as Vl}from"./settings-CuxbDWOu.js";import{useDepartmentStore as De}from"./department-CTOju6hT.js";import{m as ft}from"./phone-DsAzMHsn.js";import{a as Ae}from"./sensitiveInfo-BWt1a88R.js";import{p as Ul}from"./index-BwmIV1hk.js";import{userApiService as X}from"./userApiService-C9CF7lV2.js";import{r as Pl}from"./roleApiService-BtjPyNo7.js";import{u as vt}from"./service-CXxf5jtg.js";import{u as $l}from"./data-D5rIftf7.js";import{k as se,w as gt,r as El}from"./utils-ywHRn0uI.js";import{D as zl}from"./DynamicTable-CiyMIP8-.js";import{p as Ml,u as ht,n as Te,a0 as Al,F as _t,c as Tl,t as Ll,s as Dl,r as yt,T as Rl,K as Bl,e as Ol,f as Fl,a2 as bt,Q as jl,J as ql,aJ as Kl,E as f,b as pe}from"./elementPlus-Bmwh7Rh8.js";import{l as Zl,r as x,Z as ye,e as G,c as Wl,ag as k,m as V,p as m,q as r,U as l,M as N,Q as C,O as a,S as c,u as y,T as b,F as fe,a9 as ve,I as Yl}from"./vendor-D8Vxqhr-.js";class Le{static syncUserData(n){return S(this,null,function*(){console.log("开始同步用户数据:",n);try{yield this.syncCustomerModule(n),yield this.syncOrderModule(n),yield this.syncPerformanceModule(n),yield this.syncServiceModule(n),yield this.syncDepartmentModule(n),yield this.syncDataModule(n),console.log("用户数据同步完成:",n.id)}catch(p){throw console.error("用户数据同步失败:",p),p}})}static syncCustomerModule(n){return S(this,null,function*(){ut().customers.forEach(h=>{h.salesPersonId===n.id&&console.log(`更新客户 ${h.name} 的销售人员信息`),h.createdBy===n.id&&console.log(`更新客户 ${h.name} 的创建者信息`)})})}static syncOrderModule(n){return S(this,null,function*(){ct().orders.forEach(h=>{h.salesPersonId===n.id&&console.log(`更新订单 ${h.orderNumber} 的销售人员信息`),h.createdBy===n.id&&console.log(`更新订单 ${h.orderNumber} 的创建者信息`)})})}static syncPerformanceModule(n){return S(this,null,function*(){const p=mt();p.teamMembers.forEach(h=>{h.id===n.id&&(n.realName&&(h.name=n.realName),n.departmentName&&(h.department=n.departmentName),console.log(`更新团队成员 ${h.name} 的信息`))}),p.performanceShares.forEach(h=>{h.createdById===n.id&&(n.realName&&(h.createdBy=n.realName),console.log(`更新业绩分享 ${h.id} 的创建者信息`)),h.shareMembers.forEach(A=>{A.userId===n.id&&(n.realName&&(A.userName=n.realName),console.log(`更新业绩分享成员 ${A.userName} 的信息`))})})})}static syncServiceModule(n){return S(this,null,function*(){vt().services.forEach(h=>{h.createdBy===n.id&&console.log(`更新服务记录 ${h.id} 的创建者信息`),h.assignedTo===n.id&&console.log(`更新服务记录 ${h.id} 的分配者信息`)})})}static syncDepartmentModule(n){return S(this,null,function*(){const p=De();p.departmentMembers.forEach(h=>{h.userId===n.id&&(n.realName&&(h.userName=n.realName),n.departmentId&&(h.departmentId=n.departmentId),console.log(`更新部门成员 ${h.userName} 的信息`))}),p.roleUsers.forEach(h=>{h.userId===n.id&&(n.realName&&(h.userName=n.realName),console.log(`更新角色用户 ${h.userName} 的信息`))})})}static syncDataModule(n){return S(this,null,function*(){$l(),console.log("同步数据模块中的用户信息")})}static batchSyncUserData(n){return S(this,null,function*(){console.log("开始批量同步用户数据:",n.length,"个用户");for(const p of n)yield this.syncUserData(p);console.log("批量用户数据同步完成")})}static cleanupUserData(n){return S(this,null,function*(){console.log("开始清理用户关联数据:",n);try{const p=ut(),h=ct(),A=mt(),Q=vt(),Z=De();p.customers.forEach(w=>{w.salesPersonId===n&&(w.salesPersonId=""),w.createdBy===n&&(w.createdBy="deleted_user")}),h.orders.forEach(w=>{w.salesPersonId===n&&(w.salesPersonId=""),w.createdBy===n&&(w.createdBy="deleted_user")}),A.teamMembers=A.teamMembers.filter(w=>w.id!==n),A.performanceShares.forEach(w=>{w.createdById===n&&(w.createdBy="deleted_user",w.createdById="deleted_user"),w.shareMembers=w.shareMembers.filter($=>$.userId!==n)}),Q.services.forEach(w=>{w.createdBy===n&&(w.createdBy="deleted_user"),w.assignedTo===n&&(w.assignedTo="")}),Z.departmentMembers=Z.departmentMembers.filter(w=>w.userId!==n),Z.roleUsers=Z.roleUsers.filter(w=>w.userId!==n),console.log("用户关联数据清理完成:",n)}catch(p){throw console.error("清理用户关联数据失败:",p),p}})}static batchCleanupUserData(n){return S(this,null,function*(){console.log("开始批量清理用户关联数据:",n);try{yield Promise.all(n.map(p=>this.cleanupUserData(p))),console.log("批量清理用户关联数据完成")}catch(p){throw console.error("批量清理用户关联数据失败:",p),p}})}}const Hl={class:"user-management"},Jl={class:"page-header"},Ql={class:"header-actions"},Xl={class:"stats-section"},Gl={class:"stat-content"},ea={class:"stat-icon primary-icon"},ta={class:"stat-info"},la={class:"stat-number primary-number"},aa={class:"stat-content"},sa={class:"stat-icon success-icon"},oa={class:"stat-info"},na={class:"stat-number success-number"},ra={class:"stat-content"},ia={class:"stat-icon warning-icon"},da={class:"stat-info"},ua={class:"stat-number warning-number"},ca={class:"stat-content"},ma={class:"stat-icon info-icon"},pa={class:"stat-info"},fa={class:"stat-number info-number"},va={class:"table-section"},ga={class:"batch-actions"},ha={key:1,class:"text-gray-400"},_a={class:"dialog-footer"},ya={key:0,class:"user-detail"},ba={key:1,class:"text-gray-400"},wa={key:0,class:"permission-setting"},ka={class:"user-info"},Sa={class:"permission-content"},xa={key:0},Na={key:1},Ca={class:"role-permissions"},Ia={class:"permission-note"},Va={class:"personal-permissions"},Ua={class:"permission-note"},Pa={key:0},$a={key:1},Ea={class:"permission-actions"},za={key:0,class:"logs-content"},Ma={class:"logs-header"},Aa={class:"user-info"},Ta={class:"logs-actions"},La={class:"logs-pagination"},Da={class:"batch-import-container"},Ra={key:0,class:"import-step"},Ba={class:"step-content"},Oa={key:1,class:"import-step"},Fa={class:"step-content"},ja={key:2,class:"import-step"},qa={class:"step-content"},Ka={class:"upload-area"},Za={key:0,class:"file-info"},Wa={key:3,class:"import-step"},Ya={class:"step-content"},Ha={class:"preview-info"},Ja={class:"preview-table"},Qa={key:0},Xa={key:0,class:"error-container"},Ga={class:"error-text"},es={key:1,class:"success-container"},ts={class:"validation-summary"},ls={class:"summary-item valid"},as={class:"summary-number"},ss={class:"summary-item invalid"},os={class:"summary-number"},ns={class:"dialog-footer"},rs={class:"footer-left"},is={key:0},ds={class:"footer-right"},us=Zl({__name:"User",setup(B){const n=Il(),p=De(),h=x(!1),A=x(!1),Q=x(!1),Z=x(!1),w=x(!1),$=x([]),u=x(null),oe=x({total:0,online:0,todayNew:0,monthNew:0}),E=ye({username:"",realName:"",roleId:"",departmentId:"",status:"",createTimeRange:[]}),v=ye({id:"",username:"",realName:"",email:"",phone:"",roleId:"",departmentId:"",status:"active",password:"",remark:""}),j=x([]),W=x([]),ee=ye({page:1,size:20,total:0}),wt={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"}],realName:[{required:!0,message:"请输入姓名",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}],roleId:[{required:!0,message:"请选择角色",trigger:"change"}],departmentId:[{required:!0,message:"请选择部门",trigger:"change"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:20,message:"密码长度在 6 到 20 个字符",trigger:"blur"}]},be=x(),ie=x(!1),D=x(0),kt=x(),le=x(null),ne=x(!1),ge=x(!1),de=x([]),te=x([]),we=x([]),ue=x(!1),ke=x(!1),Se=x("role"),xe=x([]),he=x([]),re=x([]),Ne=x(!1),Ce=x(!1),Ie=x([]),ae=x([]),O=ye({page:1,size:20,total:0}),St=G(()=>w.value?"编辑用户":"新增用户"),Re=G(()=>n.isAdmin||n.isManager),Be=G(()=>n.isAdmin||n.isManager),Ve=G(()=>n.isAdmin),xt=G(()=>n.isAdmin||n.isManager),Oe=G(()=>n.isAdmin),Fe=G(()=>n.isAdmin||n.isManager),je=G(()=>n.isAdmin||n.isManager),Nt=G(()=>[{prop:"enableStatus",label:"启用状态",width:100,visible:!0,slot:!0},{prop:"avatar",label:"头像",width:80,visible:!0,slot:!0},{prop:"username",label:"用户名",width:120,visible:!0,sortable:!0},{prop:"department",label:"部门",width:120,visible:!0,slot:!0},{prop:"realName",label:"姓名",width:100,visible:!0,sortable:!0},{prop:"email",label:"邮箱",width:180,visible:!0,showOverflowTooltip:!0},{prop:"phone",label:"手机号",width:120,visible:!0,slot:!0},{prop:"role",label:"角色",width:120,visible:!0,slot:!0},{prop:"isOnline",label:"在线状态",width:100,visible:!0,slot:!0},{prop:"lastLoginTime",label:"最后登录",width:160,visible:!0,sortable:!0},{prop:"createTime",label:"创建时间",width:160,visible:!0,sortable:!0}]),Ue=t=>{const e=W.value.find(s=>s.id===t);return(e==null?void 0:e.name)||"未知"},Ct=t=>{if(!t)return;const e=W.value.find(s=>s.id===t);e&&(console.log(`角色变更为: ${e.name} (${e.code})`),ue.value&&u.value&&(u.value.role=e.code,u.value.roleId=t,Promise.all([Ke(t),Ze(),Pe(u.value.id)]).then(()=>{console.log("权限数据已根据新角色重新加载"),f.success(`已切换到${e.name}角色的预设权限`)}).catch(s=>{console.error("重新加载权限数据失败:",s)})))},qe=t=>{const e=W.value.find(s=>s.id===t);return(e==null?void 0:e.color)||""},It=()=>{w.value=!1,He(),Q.value=!0},Vt=t=>{w.value=!0,Object.assign(v,{id:t.id,username:t.username,realName:t.realName,email:t.email,phone:t.phone,roleId:t.roleId,departmentId:t.departmentId||"",status:t.status,remark:t.remark}),Q.value=!0},Ut=t=>{u.value=t,Z.value=!0},Pt=t=>S(this,null,function*(){var e;try{yield pe.confirm(`确定要重置用户"${t.realName}"的密码吗？重置后将生成新的临时密码。`,"确认重置",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=yield Ul.resetPasswordByAdmin(t.id,((e=n.currentUser)==null?void 0:e.id)||"");s.success?(yield pe.alert(`用户"${t.realName}"的密码已重置成功！

新的临时密码：${s.tempPassword}

请将此密码安全地告知用户，用户首次登录时将被要求修改密码。`,"密码重置成功",{confirmButtonText:"我已记录",type:"success",showClose:!1,closeOnClickModal:!1,closeOnPressEscape:!1}),f.success("密码重置成功"),yield Y()):f.error(s.message||"密码重置失败")}catch(s){s!=="cancel"&&f.error("密码重置失败，请稍后重试")}}),$t=(t,e)=>{switch(t){case"permissions":Et(e);break;case"logs":zt(e);break;case"delete":Kt(e);break}},Et=t=>S(this,null,function*(){u.value=t,Se.value="role";try{yield Promise.all([Ke(t.roleId),Ze(),Pe(t.id)]),ue.value=!0}catch(e){console.error("加载权限数据失败:",e),f.error("加载权限数据失败")}}),zt=t=>S(this,null,function*(){u.value=t,ae.value=[],O.page=1,O.size=20;try{yield ce(t.id),Ne.value=!0}catch(e){console.error("加载操作日志失败:",e),f.error("加载操作日志失败")}}),Ke=t=>S(this,null,function*(){try{const e=yield K.getRolePermissions(t),s=new Map;e.permissions.forEach(i=>{i.parentId?(s.has(i.parentId)||s.set(i.parentId,{id:i.parentId,name:i.module,children:[]}),s.get(i.parentId).children.push({id:i.id,name:i.name})):s.has(i.id)||s.set(i.id,{id:i.id,name:i.name,children:[]})}),xe.value=Array.from(s.values()),console.log("角色权限加载成功:",e.roleName)}catch(e){console.error("加载角色权限失败:",e);const s=K.getAllPermissions();xe.value=s}}),Ze=()=>S(this,null,function*(){try{const t=K.getAllPermissions();if(u.value&&u.value.role){const e=K.getRoleDefaultPermissions(u.value.role);he.value=Mt(t,e)}else he.value=t;console.log("个人权限选项加载成功")}catch(t){console.error("加载个人权限选项失败:",t);const e=K.getAllPermissions();he.value=e}}),Pe=t=>S(this,null,function*(){try{const e=yield K.getUserPersonalPermissions(parseInt(t));re.value=e.permissions.map(s=>s.id),console.log("用户个人权限加载成功:",t)}catch(e){console.error("加载用户个人权限失败:",e);const s=users.value.find(i=>i.id===parseInt(t));if(s&&s.role){const i=K.getRoleDefaultPermissions(s.role);re.value=i,console.log(`为角色 ${s.role} 设置预设权限:`,i)}else re.value=[]}}),Mt=(t,e)=>{const s=i=>{const _=e.includes(i.id),I=dt(it({},i),{disabled:_});return i.children&&i.children.length>0&&(I.children=i.children.map(s)),I};return t.map(s)},ce=t=>S(this,null,function*(){var e,s;Ce.value=!0;try{const i=yield pt.getUserOperationLogs(parseInt(t),{page:O.page,pageSize:O.size,startDate:(e=ae.value)==null?void 0:e[0],endDate:(s=ae.value)==null?void 0:s[1]});Ie.value=i.data.map(_=>({time:_.createdAt,action:_.action,module:_.module,description:_.description,ip:_.ip,userAgent:_.userAgent,result:"success"})),O.total=i.total,console.log("用户操作日志加载成功:",t)}catch(i){console.error("加载操作日志失败:",i);const _=[{time:"2024-01-15 14:30:25",action:"login",module:"系统登录",description:"用户登录系统",ip:"192.168.1.100",userAgent:"Chrome 120.0.0.0",result:"success"},{time:"2024-01-15 14:25:10",action:"create",module:"客户管理",description:"新增客户：张三",ip:"192.168.1.100",userAgent:"Chrome 120.0.0.0",result:"success"},{time:"2024-01-15 14:20:05",action:"update",module:"订单管理",description:"修改订单：ORD20240115001",ip:"192.168.1.100",userAgent:"Chrome 120.0.0.0",result:"success"},{time:"2024-01-15 14:15:30",action:"delete",module:"产品管理",description:"删除产品：PRD001",ip:"192.168.1.100",userAgent:"Chrome 120.0.0.0",result:"failed"}];Ie.value=_,O.total=_.length}finally{Ce.value=!1}}),At=(t,e)=>{if(!n.isSuperAdmin){f.warning("只有超级管理员可以修改个人权限设置");return}console.log("权限选择变化:",t,e);const s=e.checkedKeys||[],i=e.halfCheckedKeys||[];u.value&&u.value.role&&K.getRoleDefaultPermissions(u.value.role).filter(z=>!s.includes(z)&&!i.includes(z)).length>0&&(f.warning("不能移除角色默认权限，这些权限将自动保留"),setTimeout(()=>{Pe(u.value.id)},100)),re.value=[...s]},Tt=()=>{if(!n.isSuperAdmin){f.warning("只有超级管理员可以修改个人权限设置");return}if(u.value){const t=K.getRoleDefaultPermissions(u.value.role);re.value=[...t],f.success("权限已重置为角色默认权限"),console.log(`用户 ${u.value.realName} 权限已重置为角色 ${u.value.role} 的默认权限`)}},Lt=()=>S(this,null,function*(){var t;if(u.value){if(!n.isSuperAdmin){f.warning("只有超级管理员可以修改个人权限设置");return}ke.value=!0;try{const e=((t=document.querySelector(".personal-permissions .el-tree"))==null?void 0:t.getCheckedKeys())||[],s=K.getRoleDefaultPermissions(u.value.role),i=[...new Set([...s,...e])];yield K.saveUserPersonalPermissions(parseInt(u.value.id),i),f.success("权限保存成功"),ue.value=!1,console.log("用户权限保存成功:",u.value.id,"最终权限:",i),yield loadUsers()}catch(e){console.error("保存权限失败:",e),f.error("保存权限失败")}finally{ke.value=!1}}}),Dt=t=>({login:"success",logout:"info",create:"primary",update:"warning",delete:"danger",view:"info"})[t]||"info",Rt=t=>({login:"登录",logout:"登出",create:"新增",update:"修改",delete:"删除",view:"查看"})[t]||t,Bt=t=>{u.value&&ce(u.value.id)},Ot=()=>{u.value&&ce(u.value.id)},Ft=()=>S(this,null,function*(){var t,e;if(u.value)try{f.info("正在导出日志，请稍候...");const s=yield pt.exportUserOperationLogs(parseInt(u.value.id),{startDate:(t=ae.value)==null?void 0:t[0],endDate:(e=ae.value)==null?void 0:e[1],format:"excel"}),i=window.URL.createObjectURL(s),_=document.createElement("a");_.href=i,_.download=`用户操作日志_${u.value.username}_${new Date().toISOString().split("T")[0]}.xlsx`,document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(i),f.success("日志导出成功"),console.log("用户操作日志导出成功:",u.value.id)}catch(s){console.error("导出日志失败:",s),f.error("导出日志失败，请稍后重试")}}),jt=t=>{O.size=t,u.value&&ce(u.value.id)},qt=t=>{O.page=t,u.value&&ce(u.value.id)},Kt=t=>S(this,null,function*(){try{yield pe.confirm(`确定要删除用户"${t.realName}"吗？删除后不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});try{yield X.deleteUser(t.id),yield Le.cleanupUserData(t.id.toString()),f.success("删除成功")}catch(e){console.error("删除用户失败:",e),f.error("删除用户失败，请稍后重试");return}yield Y()}catch(e){}}),Zt=()=>S(this,null,function*(){try{yield pe.confirm(`确定要删除选中的 ${$.value.length} 个用户吗？删除后不可恢复！`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=$.value.map(e=>e.id);try{yield X.batchDeleteUsers(t),yield Le.batchCleanupUserData(t.map(e=>e.toString())),f.success("批量删除成功")}catch(e){console.error("批量删除用户失败:",e),f.error("批量删除用户失败，请稍后重试");return}$.value=[],yield Y()}catch(t){}}),Wt=t=>S(this,null,function*(){const e=t.status==="active"?"禁用":"启用",s=t.status==="active"?"inactive":"active",i=t.status;try{t.statusLoading=!0,t.status=s;try{yield X.updateUserStatus(t.id,s),f.success(`${e}用户成功`)}catch(_){console.error("更新用户状态失败:",_),t.status=i,f.error(`${e}用户失败，请稍后重试`)}yield Ee()}catch(_){t.status=i,f.error(`${e}用户失败`)}finally{t.statusLoading=!1}}),We=t=>S(this,null,function*(){const e=t==="active"?"启用":"禁用";try{yield pe.confirm(`确定要${e}选中的 ${$.value.length} 个用户吗？`,`确认批量${e}`,{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=$.value.map(i=>i.id);try{yield X.batchUpdateUserStatus(s,t),f.success(`批量${e}成功`)}catch(i){console.error("批量更新用户状态失败:",i),f.error(`批量${e}失败，请稍后重试`);return}$.value=[],yield Y()}catch(s){}}),Yt=()=>S(this,null,function*(){try{f.info("正在导出用户数据...");const t=j.value.map(d=>({用户名:d.username,姓名:d.realName,邮箱:d.email,手机号:d.phone,部门:d.departmentName||"未分配",角色:d.roleName,状态:d.status==="active"?"启用":"禁用",在线状态:d.isOnline?"在线":"离线",最后登录时间:d.lastLoginTime||"从未登录",登录次数:d.loginCount||0,创建时间:d.createTime,备注:d.remark||""})),e=se.json_to_sheet(t),s=se.book_new();se.book_append_sheet(s,e,"用户列表");const i=[{wch:15},{wch:12},{wch:25},{wch:15},{wch:15},{wch:12},{wch:8},{wch:10},{wch:20},{wch:10},{wch:20},{wch:20}];e["!cols"]=i;const z=`用户列表_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"").replace("T","_")}.xlsx`;gt(s,z),f.success("用户数据导出成功")}catch(t){console.error("导出失败:",t),f.error("导出失败，请稍后重试")}}),Ye=()=>{ee.page=1,Y()},Ht=()=>{Object.assign(E,{username:"",realName:"",roleId:"",departmentId:"",status:"",createTimeRange:[]}),Ye()},Jt=t=>{$.value=t},Qt=t=>{ee.size=t,Y()},Xt=t=>{ee.page=t,Y()},Gt=()=>S(this,null,function*(){var t,e;try{if(yield(t=be.value)==null?void 0:t.validate(),A.value=!0,w.value){const s={realName:v.realName,email:v.email,phone:v.phone,roleId:v.roleId,departmentId:v.departmentId,status:v.status,remark:v.remark};try{yield X.updateUser(v.id,s),f.success("用户更新成功"),yield Le.syncUserData({id:v.id,realName:v.realName,username:v.username,email:v.email,phone:v.phone,departmentId:v.departmentId,departmentName:(e=p.departmentList.find(i=>i.id===v.departmentId))==null?void 0:e.name,roleId:v.roleId,status:v.status})}catch(i){console.error("更新用户失败:",i),f.error("更新用户失败，请检查输入信息"),A.value=!1;return}}else{const s={username:v.username,password:v.password,realName:v.realName,email:v.email,phone:v.phone,role:v.roleId,departmentId:v.departmentId?parseInt(v.departmentId):void 0};try{yield X.createUser(s),f.success("用户创建成功")}catch(i){console.error("创建用户失败:",i),f.error("创建用户失败，请检查输入信息"),A.value=!1;return}}$e(),yield Y()}catch(s){console.error("表单验证失败:",s)}finally{A.value=!1}}),$e=()=>{var t;Q.value=!1,(t=be.value)==null||t.clearValidate(),He()},He=()=>{Object.assign(v,{id:"",username:"",realName:"",email:"",phone:"",roleId:"",departmentId:"",status:"active",password:"123456",remark:""})},el=()=>S(this,null,function*(){try{const t=yield Pl.getRoles();W.value=t.filter(e=>e.status==="active"),console.log("角色数据加载成功:",W.value.length)}catch(t){console.error("加载角色数据失败:",t),f.error("加载角色数据失败，请稍后重试")}}),Ee=()=>S(this,null,function*(){try{const t=yield X.getUserStatistics();oe.value={total:t.total,online:t.active,todayNew:0,monthNew:0}}catch(t){console.warn("获取用户统计数据失败，使用本地计算:",t);const e=new Date,s=e.toDateString(),i=e.getMonth(),_=e.getFullYear(),I=j.value.length,z=j.value.filter(g=>g.status==="active").length,d=j.value.filter(g=>g.createTime?new Date(g.createTime).toDateString()===s:!1).length,U=j.value.filter(g=>{if(!g.createTime)return!1;const F=new Date(g.createTime);return F.getMonth()===i&&F.getFullYear()===_}).length;oe.value={total:I,online:z,todayNew:d,monthNew:U}}}),Y=()=>S(this,null,function*(){try{h.value=!0;const t={page:ee.page,limit:ee.size,search:E.username||E.realName||void 0,departmentId:E.departmentId||void 0,role:E.roleId||void 0,status:E.status||void 0},e=yield X.getUsers(t);j.value=e.data.map(s=>{var _,I;const i=p.getDepartmentById(s.departmentId);return{id:s.id.toString(),username:s.username,realName:s.realName,email:s.email,phone:s.phone,roleId:s.role,departmentId:(_=s.departmentId)==null?void 0:_.toString(),departmentName:((I=s.department)==null?void 0:I.name)||(i==null?void 0:i.name)||"",status:s.status,createTime:s.createdAt,lastLoginTime:s.lastLoginAt,avatar:s.avatar,remark:s.remark||"",statusLoading:!1}}),ee.total=e.total,yield Ee()}catch(t){console.error("加载用户列表失败:",t),f.error("加载用户列表失败，请检查网络连接"),j.value=[],ee.total=0}finally{h.value=!1}}),tl=()=>{ie.value=!0,D.value=0,Je()},Je=()=>{le.value=null,de.value=[],te.value=[],we.value=[],ne.value=!1,ge.value=!1},Qe=t=>t.includes("用户名不能为空")?"请在Excel中填写用户名，建议使用字母、数字和下划线组合":t.includes("用户名长度应在3-20个字符之间")?"用户名长度需要在3-20个字符之间，请调整用户名长度":t.includes("用户名只能包含字母、数字和下划线")?"用户名格式错误，只能使用a-z、A-Z、0-9和下划线(_)，不能包含空格或特殊字符":t.includes("用户名已存在于系统中")?"该用户名已被使用，请更换一个新的用户名":t.includes("用户名在导入数据中重复")?"在Excel中发现重复的用户名，请检查并修改重复的行":t.includes("姓名不能为空")?"请在Excel中填写真实姓名":t.includes("姓名长度不能超过50个字符")?"姓名过长，请缩短至50个字符以内":t.includes("姓名只能包含中文、英文字母和空格")?"姓名格式错误，只能包含中文、英文字母和空格，不能包含数字或特殊字符":t.includes("邮箱不能为空")?"请在Excel中填写邮箱地址":t.includes("邮箱格式不正确")?"邮箱格式错误，请使用正确格式，如：zhangsan@example.com":t.includes("邮箱已存在于系统中")?"该邮箱已被使用，请更换一个新的邮箱地址":t.includes("邮箱在导入数据中重复")?"在Excel中发现重复的邮箱，请检查并修改重复的行":t.includes("手机号不能为空")?"请在Excel中填写手机号码":t.includes("手机号格式不正确")?"手机号格式错误，请输入11位中国大陆手机号，如：13812345678":t.includes("手机号已存在于系统中")?"该手机号已被使用，请更换一个新的手机号":t.includes("手机号在导入数据中重复")?"在Excel中发现重复的手机号，请检查并修改重复的行":t.includes("角色不能为空")?"请在Excel中选择用户角色":t.includes("角色")&&t.includes("不存在")?"角色名称错误，请使用系统中已存在的角色名称":t.includes("部门")&&t.includes("不存在")?"部门名称错误，请使用系统中已存在的部门名称，或留空使用默认部门":t.includes("密码长度不能少于6位")?"密码太短，请设置至少6位密码，或留空使用默认密码123456":t.includes("密码长度不能超过20位")?"密码太长，请设置不超过20位的密码":t.includes("备注长度不能超过200个字符")?"备注内容过长，请缩短至200个字符以内":"",Xe=()=>{D.value<3&&D.value++},ll=()=>{D.value>0&&D.value--},al=()=>{const t=[["用户名","姓名","邮箱","手机号","角色","部门","密码","备注"],["zhangsan","张三","zhangsan@example.com","13800138001","销售员","销售部","123456","示例用户1"],["lisi","李四","lisi@example.com","13800138002","客服","客服部","123456","示例用户2"]],e=se.aoa_to_sheet(t),s=se.book_new();se.book_append_sheet(s,e,"用户导入模板");const i=[{wch:15},{wch:12},{wch:25},{wch:15},{wch:12},{wch:12},{wch:12},{wch:20}];e["!cols"]=i,gt(s,"用户导入模板.xlsx"),f.success("模板下载成功")},sl=t=>{le.value=t.raw},ol=t=>{const e=t.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t.type==="application/vnd.ms-excel",s=t.size/1024/1024<10;return e?(s||f.error("文件大小不能超过10MB!"),!1):(f.error("只能上传Excel文件!"),!1)},nl=()=>{f.warning("只能上传一个文件")},rl=()=>S(this,null,function*(){if(!le.value){f.error("请先选择文件");return}ne.value=!0;try{const t=new FileReader;t.onload=e=>{var s;try{const i=new Uint8Array((s=e.target)==null?void 0:s.result),_=El(i,{type:"array",cellDates:!0,cellNF:!1,cellText:!1});if(!_.SheetNames||_.SheetNames.length===0)throw new Error("Excel文件中没有找到工作表");const I=_.SheetNames[0],z=_.Sheets[I];if(!z)throw new Error("无法读取工作表内容");const d=se.sheet_to_json(z,{header:1,defval:"",blankrows:!1});if(!d||d.length<2)throw new Error("Excel文件内容为空或格式不正确，请确保至少有标题行和一行数据");const U=d[0],g=["用户名","姓名","邮箱","手机号","角色","部门","密码","备注"];if(!g.every((R,J)=>{const T=U[J];return T&&T.toString().trim()===R}))throw new Error(`Excel文件标题行不正确。期望的标题行为：${g.join("、")}`);const P=d.slice(1);if(P.length===0)throw new Error("Excel文件中没有数据行");const H=P.filter(R=>R&&R.some(J=>J!=null&&J.toString().trim()!=="")).map((R,J)=>({rowIndex:J+2,username:(R[0]||"").toString().trim(),realName:(R[1]||"").toString().trim(),email:(R[2]||"").toString().trim(),phone:(R[3]||"").toString().trim(),role:(R[4]||"").toString().trim(),department:(R[5]||"").toString().trim(),password:(R[6]||"").toString().trim(),remark:(R[7]||"").toString().trim(),errors:[]}));if(H.length===0)throw new Error("Excel文件中没有有效的数据行");il(H),f.success(`解析完成，共${H.length}条数据`),Xe()}catch(i){console.error("Excel解析错误:",i),f.error(i.message||"文件解析失败，请检查文件格式")}finally{ne.value=!1}},t.onerror=()=>{f.error("文件读取失败，请重新选择文件"),ne.value=!1},t.readAsArrayBuffer(le.value)}catch(t){console.error("文件读取错误:",t),f.error("文件读取失败，请重新选择文件"),ne.value=!1}}),il=t=>{const e=[],s=[],i=new Map,_=new Set(j.value.map(d=>d.username)),I=new Set(j.value.map(d=>d.email)),z=new Set(j.value.map(d=>d.phone));t.forEach((d,U)=>{const g=[];if(d.username.trim()?d.username.length<3||d.username.length>20?g.push("用户名长度应在3-20个字符之间"):/^[a-zA-Z0-9_]+$/.test(d.username)?_.has(d.username)?g.push("用户名已存在于系统中"):i.has(`username:${d.username}`)?g.push(`用户名在导入数据中重复（第${i.get(`username:${d.username}`)}行）`):i.set(`username:${d.username}`,U+1):g.push("用户名只能包含字母、数字和下划线"):g.push("用户名不能为空"),d.realName.trim()?d.realName.length>50?g.push("姓名长度不能超过50个字符"):/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(d.realName)||g.push("姓名只能包含中文、英文字母和空格"):g.push("姓名不能为空"),d.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.email)?I.has(d.email)?g.push("邮箱已存在于系统中"):i.has(`email:${d.email}`)?g.push(`邮箱在导入数据中重复（第${i.get(`email:${d.email}`)}行）`):i.set(`email:${d.email}`,U+1):g.push("邮箱格式不正确，请检查格式（如：user@example.com）"):g.push("邮箱不能为空"),d.phone.trim()?/^1[3-9]\d{9}$/.test(d.phone)?z.has(d.phone)?g.push("手机号已存在于系统中"):i.has(`phone:${d.phone}`)?g.push(`手机号在导入数据中重复（第${i.get(`phone:${d.phone}`)}行）`):i.set(`phone:${d.phone}`,U+1):g.push("手机号格式不正确，请输入11位有效的中国大陆手机号"):g.push("手机号不能为空"),!d.role.trim())g.push("角色不能为空");else if(!W.value.some(P=>P.name===d.role))g.push(`角色"${d.role}"不存在。可选角色：${W.value.map(P=>P.name).join("、")}`);else{const P=W.value.find(H=>H.name===d.role);d.roleId=P==null?void 0:P.id}if(d.department&&d.department.trim())if(!p.departmentList.some(P=>P.name===d.department))g.push(`部门"${d.department}"不存在。可选部门：${p.departmentList.map(P=>P.name).join("、")}`);else{const P=p.departmentList.find(H=>H.name===d.department);d.departmentId=P==null?void 0:P.id}d.password.trim()?d.password.length<6?g.push("密码长度不能少于6位"):d.password.length>20?g.push("密码长度不能超过20位"):d.needChangePassword=!1:(d.password="123456",d.needChangePassword=!0),d.remark&&d.remark.length>200&&g.push("备注长度不能超过200个字符"),d.errors=g,g.length===0?e.push(d):s.push(d)}),de.value=t,te.value=e,we.value=s,s.length>0?f.warning(`数据验证完成：${e.length}条有效，${s.length}条无效。请修复错误后重新导入。`):f.success(`数据验证通过：共${e.length}条有效数据`)},dl=()=>S(this,null,function*(){if(te.value.length===0){f.error("没有有效数据可导入");return}ge.value=!0;try{const t=te.value.map(s=>({username:s.username,password:s.password,realName:s.realName,email:s.email,phone:s.phone,role:s.roleId,departmentId:s.departmentId?parseInt(s.departmentId):void 0})),e=yield X.importUsers(t);f.success(`导入成功：共${e.successCount||te.value.length}条用户数据`),ie.value=!1,Y()}catch(t){console.error("导入失败:",t),f.error("导入失败，请检查数据格式或稍后重试")}finally{ge.value=!1}}),Ge=()=>{ie.value=!1,Je()},ul=({prop:t,order:e})=>{console.log("排序变化:",t,e)},cl=t=>{console.log("列设置变化:",t)};return Wl(()=>S(this,null,function*(){try{Ee(),Y(),el(),yield p.initData()}catch(t){console.error("初始化数据失败:",t)}})),(t,e)=>{const s=k("el-button"),i=k("el-icon"),_=k("el-card"),I=k("el-col"),z=k("el-row"),d=k("el-input"),U=k("el-form-item"),g=k("el-option"),F=k("el-select"),P=k("el-date-picker"),H=k("el-form"),R=k("el-switch"),J=k("el-avatar"),T=k("el-tag"),ze=k("el-dropdown-item"),ml=k("el-dropdown-menu"),pl=k("el-dropdown"),et=k("el-radio"),fl=k("el-radio-group"),me=k("el-dialog"),L=k("el-descriptions-item"),tt=k("el-descriptions"),vl=k("el-divider"),lt=k("el-alert"),at=k("el-tree"),st=k("el-tab-pane"),gl=k("el-tabs"),M=k("el-table-column"),ot=k("el-table"),hl=k("el-pagination"),_e=k("el-step"),_l=k("el-steps"),yl=k("el-upload"),bl=k("el-tooltip");return m(),V("div",Hl,[r("div",Jl,[e[29]||(e[29]=r("div",{class:"header-left"},[r("h2",null,"用户管理")],-1)),r("div",Ql,[Re.value?(m(),N(s,{key:0,onClick:It,type:"primary",icon:y(Ml)},{default:a(()=>[...e[26]||(e[26]=[c(" 新增用户 ",-1)])]),_:1},8,["icon"])):C("",!0),Re.value?(m(),N(s,{key:1,onClick:tl,type:"success",icon:y(ht)},{default:a(()=>[...e[27]||(e[27]=[c(" 批量导入 ",-1)])]),_:1},8,["icon"])):C("",!0),l(s,{onClick:Yt,icon:y(Te)},{default:a(()=>[...e[28]||(e[28]=[c(" 导出用户 ",-1)])]),_:1},8,["icon"])])]),r("div",Xl,[l(z,{gutter:20},{default:a(()=>[l(I,{span:6},{default:a(()=>[l(_,{class:"stat-card"},{default:a(()=>[r("div",Gl,[r("div",ea,[l(i,null,{default:a(()=>[l(y(Al))]),_:1})]),r("div",ta,[r("div",la,b(oe.value.total),1),e[30]||(e[30]=r("div",{class:"stat-title"},"总用户数",-1)),e[31]||(e[31]=r("div",{class:"stat-desc"},"系统中的用户总数量",-1))])])]),_:1})]),_:1}),l(I,{span:6},{default:a(()=>[l(_,{class:"stat-card"},{default:a(()=>[r("div",aa,[r("div",sa,[l(i,null,{default:a(()=>[l(y(_t))]),_:1})]),r("div",oa,[r("div",na,b(oe.value.online),1),e[32]||(e[32]=r("div",{class:"stat-title"},"在线用户",-1)),e[33]||(e[33]=r("div",{class:"stat-desc"},"当前在线用户数量",-1))])])]),_:1})]),_:1}),l(I,{span:6},{default:a(()=>[l(_,{class:"stat-card"},{default:a(()=>[r("div",ra,[r("div",ia,[l(i,null,{default:a(()=>[l(y(Tl))]),_:1})]),r("div",da,[r("div",ua,b(oe.value.todayNew),1),e[34]||(e[34]=r("div",{class:"stat-title"},"今日新增",-1)),e[35]||(e[35]=r("div",{class:"stat-desc"},"今天新增用户数量",-1))])])]),_:1})]),_:1}),l(I,{span:6},{default:a(()=>[l(_,{class:"stat-card"},{default:a(()=>[r("div",ca,[r("div",ma,[l(i,null,{default:a(()=>[l(y(Ll))]),_:1})]),r("div",pa,[r("div",fa,b(oe.value.monthNew),1),e[36]||(e[36]=r("div",{class:"stat-title"},"本月新增",-1)),e[37]||(e[37]=r("div",{class:"stat-desc"},"本月新增用户数量",-1))])])]),_:1})]),_:1})]),_:1})]),l(_,{class:"search-card"},{default:a(()=>[l(H,{model:E,inline:""},{default:a(()=>[l(U,{label:"用户名"},{default:a(()=>[l(d,{modelValue:E.username,"onUpdate:modelValue":e[0]||(e[0]=o=>E.username=o),placeholder:"请输入用户名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(U,{label:"姓名"},{default:a(()=>[l(d,{modelValue:E.realName,"onUpdate:modelValue":e[1]||(e[1]=o=>E.realName=o),placeholder:"请输入姓名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(U,{label:"角色"},{default:a(()=>[l(F,{modelValue:E.roleId,"onUpdate:modelValue":e[2]||(e[2]=o=>E.roleId=o),placeholder:"请选择角色",clearable:"",style:{width:"150px"}},{default:a(()=>[(m(!0),V(fe,null,ve(W.value,o=>(m(),N(g,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(U,{label:"部门"},{default:a(()=>[l(F,{modelValue:E.departmentId,"onUpdate:modelValue":e[3]||(e[3]=o=>E.departmentId=o),placeholder:"请选择部门",clearable:"",style:{width:"150px"}},{default:a(()=>[(m(!0),V(fe,null,ve(y(p).departmentList,o=>(m(),N(g,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(U,{label:"状态"},{default:a(()=>[l(F,{modelValue:E.status,"onUpdate:modelValue":e[4]||(e[4]=o=>E.status=o),placeholder:"请选择状态",clearable:"",style:{width:"120px"}},{default:a(()=>[l(g,{label:"启用",value:"active"}),l(g,{label:"禁用",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),l(U,{label:"创建时间"},{default:a(()=>[l(P,{modelValue:E.createTimeRange,"onUpdate:modelValue":e[5]||(e[5]=o=>E.createTimeRange=o),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),l(U,null,{default:a(()=>[l(s,{onClick:Ye,type:"primary",icon:y(Dl)},{default:a(()=>[...e[38]||(e[38]=[c(" 搜索 ",-1)])]),_:1},8,["icon"]),l(s,{onClick:Ht,icon:y(yt)},{default:a(()=>[...e[39]||(e[39]=[c(" 重置 ",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),r("div",va,[l(zl,{data:j.value,columns:Nt.value,loading:h.value,"storage-key":"user-management-columns",title:"用户列表","show-selection":!0,"show-pagination":!0,total:ee.total,onSelectionChange:Jt,onSortChange:ul,onSizeChange:Qt,onCurrentChange:Xt,onColumnSettingsChange:cl},{"table-header-actions":a(()=>[r("div",ga,[Ve.value?(m(),N(s,{key:0,onClick:Zt,disabled:!$.value.length,type:"danger",size:"small",icon:y(Bl)},{default:a(()=>[...e[40]||(e[40]=[c(" 批量删除 ",-1)])]),_:1},8,["disabled","icon"])):C("",!0),je.value?(m(),N(s,{key:1,onClick:e[6]||(e[6]=o=>We("active")),disabled:!$.value.length,size:"small",icon:y(Ol)},{default:a(()=>[...e[41]||(e[41]=[c(" 批量启用 ",-1)])]),_:1},8,["disabled","icon"])):C("",!0),je.value?(m(),N(s,{key:2,onClick:e[7]||(e[7]=o=>We("inactive")),disabled:!$.value.length,size:"small",icon:y(Fl)},{default:a(()=>[...e[42]||(e[42]=[c(" 批量禁用 ",-1)])]),_:1},8,["disabled","icon"])):C("",!0)])]),"column-enableStatus":a(({row:o})=>[l(R,{modelValue:o.status,"onUpdate:modelValue":q=>o.status=q,"active-value":"active","inactive-value":"inactive",loading:o.statusLoading,onChange:q=>Wt(o)},null,8,["modelValue","onUpdate:modelValue","loading","onChange"])]),"column-avatar":a(({row:o})=>[l(J,{src:o.avatar||"/src/assets/images/default-avatar.svg",size:40,style:Yl({backgroundColor:o.avatar?"transparent":"#409eff"})},{default:a(()=>[o.avatar?C("",!0):(m(),N(i,{key:0},{default:a(()=>[l(y(_t))]),_:1}))]),_:2},1032,["src","style"])]),"column-department":a(({row:o})=>[o.departmentName?(m(),N(T,{key:0,type:"info",size:"small"},{default:a(()=>[c(b(o.departmentName),1)]),_:2},1024)):(m(),V("span",ha,"未分配"))]),"column-phone":a(({row:o})=>[c(b(y(ft)(o.phone)),1)]),"column-role":a(({row:o})=>[l(T,{type:qe(o.roleId),size:"small"},{default:a(()=>[c(b(Ue(o.roleId)),1)]),_:2},1032,["type"])]),"column-isOnline":a(({row:o})=>[l(T,{type:o.isOnline?"success":"info",size:"small"},{default:a(()=>[c(b(o.isOnline?"在线":"离线"),1)]),_:2},1032,["type"])]),"table-actions":a(({row:o})=>[l(s,{onClick:q=>Ut(o),type:"primary",size:"small",link:""},{default:a(()=>[...e[43]||(e[43]=[c(" 查看 ",-1)])]),_:1},8,["onClick"]),Be.value?(m(),N(s,{key:0,onClick:q=>Vt(o),type:"primary",size:"small",link:""},{default:a(()=>[...e[44]||(e[44]=[c(" 编辑 ",-1)])]),_:1},8,["onClick"])):C("",!0),xt.value?(m(),N(s,{key:1,onClick:q=>Pt(o),type:"warning",size:"small",link:""},{default:a(()=>[...e[45]||(e[45]=[c(" 重置密码 ",-1)])]),_:1},8,["onClick"])):C("",!0),Be.value||Oe.value||Fe.value||Ve.value?(m(),N(pl,{key:2,onCommand:q=>$t(q,o)},{dropdown:a(()=>[l(ml,null,{default:a(()=>[Oe.value?(m(),N(ze,{key:0,command:"permissions"},{default:a(()=>[...e[47]||(e[47]=[c(" 权限设置 ",-1)])]),_:1})):C("",!0),Fe.value?(m(),N(ze,{key:1,command:"logs"},{default:a(()=>[...e[48]||(e[48]=[c(" 操作日志 ",-1)])]),_:1})):C("",!0),Ve.value?(m(),N(ze,{key:2,command:"delete",divided:"",class:"danger-item"},{default:a(()=>[...e[49]||(e[49]=[c(" 删除 ",-1)])]),_:1})):C("",!0)]),_:1})]),default:a(()=>[l(s,{type:"primary",size:"small",link:""},{default:a(()=>[e[46]||(e[46]=c(" 更多",-1)),l(i,{class:"el-icon--right"},{default:a(()=>[l(y(Rl))]),_:1})]),_:1})]),_:1},8,["onCommand"])):C("",!0)]),_:1},8,["data","columns","loading","total"])]),l(me,{modelValue:Q.value,"onUpdate:modelValue":e[17]||(e[17]=o=>Q.value=o),title:St.value,width:"600px","before-close":$e},{footer:a(()=>[r("span",_a,[l(s,{onClick:$e},{default:a(()=>[...e[52]||(e[52]=[c("取消",-1)])]),_:1}),l(s,{onClick:Gt,type:"primary",loading:A.value},{default:a(()=>[...e[53]||(e[53]=[c(" 确定 ",-1)])]),_:1},8,["loading"])])]),default:a(()=>[l(H,{ref_key:"userFormRef",ref:be,model:v,rules:wt,"label-width":"100px"},{default:a(()=>[l(z,{gutter:20},{default:a(()=>[l(I,{span:12},{default:a(()=>[l(U,{label:"用户名",prop:"username"},{default:a(()=>[l(d,{modelValue:v.username,"onUpdate:modelValue":e[8]||(e[8]=o=>v.username=o),placeholder:"请输入用户名",disabled:w.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),l(I,{span:12},{default:a(()=>[l(U,{label:"姓名",prop:"realName"},{default:a(()=>[l(d,{modelValue:v.realName,"onUpdate:modelValue":e[9]||(e[9]=o=>v.realName=o),placeholder:"请输入姓名"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(z,{gutter:20},{default:a(()=>[l(I,{span:12},{default:a(()=>[l(U,{label:"邮箱",prop:"email"},{default:a(()=>[l(d,{modelValue:v.email,"onUpdate:modelValue":e[10]||(e[10]=o=>v.email=o),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1}),l(I,{span:12},{default:a(()=>[l(U,{label:"手机号",prop:"phone"},{default:a(()=>[l(d,{modelValue:v.phone,"onUpdate:modelValue":e[11]||(e[11]=o=>v.phone=o),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(z,{gutter:20},{default:a(()=>[l(I,{span:12},{default:a(()=>[l(U,{label:"角色",prop:"roleId"},{default:a(()=>[l(F,{modelValue:v.roleId,"onUpdate:modelValue":e[12]||(e[12]=o=>v.roleId=o),placeholder:"请选择角色",style:{width:"100%"},onChange:Ct},{default:a(()=>[(m(!0),V(fe,null,ve(W.value,o=>(m(),N(g,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(I,{span:12},{default:a(()=>[l(U,{label:"部门",prop:"departmentId"},{default:a(()=>[l(F,{modelValue:v.departmentId,"onUpdate:modelValue":e[13]||(e[13]=o=>v.departmentId=o),placeholder:"请选择部门",style:{width:"100%"},clearable:""},{default:a(()=>[(m(!0),V(fe,null,ve(y(p).departmentList,o=>(m(),N(g,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(z,{gutter:20},{default:a(()=>[l(I,{span:12},{default:a(()=>[l(U,{label:"状态",prop:"status"},{default:a(()=>[l(fl,{modelValue:v.status,"onUpdate:modelValue":e[14]||(e[14]=o=>v.status=o)},{default:a(()=>[l(et,{value:"active"},{default:a(()=>[...e[50]||(e[50]=[c("启用",-1)])]),_:1}),l(et,{value:"inactive"},{default:a(()=>[...e[51]||(e[51]=[c("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),w.value?C("",!0):(m(),N(U,{key:0,label:"密码",prop:"password"},{default:a(()=>[l(d,{modelValue:v.password,"onUpdate:modelValue":e[15]||(e[15]=o=>v.password=o),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1})),l(U,{label:"备注",prop:"remark"},{default:a(()=>[l(d,{modelValue:v.remark,"onUpdate:modelValue":e[16]||(e[16]=o=>v.remark=o),type:"textarea",rows:3,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(me,{modelValue:Z.value,"onUpdate:modelValue":e[18]||(e[18]=o=>Z.value=o),title:"用户详情",width:"800px"},{default:a(()=>[u.value?(m(),V("div",ya,[l(tt,{column:2,border:""},{default:a(()=>[l(L,{label:"头像"},{default:a(()=>[l(J,{src:u.value.avatar,size:60},{default:a(()=>{var o;return[c(b((o=u.value.realName)==null?void 0:o.charAt(0)),1)]}),_:1},8,["src"])]),_:1}),l(L,{label:"用户名"},{default:a(()=>[c(b(u.value.username),1)]),_:1}),l(L,{label:"姓名"},{default:a(()=>[c(b(u.value.realName),1)]),_:1}),l(L,{label:"邮箱"},{default:a(()=>[c(b(y(Ae)(u.value.email,y(Me).EMAIL)),1)]),_:1}),l(L,{label:"手机号"},{default:a(()=>[c(b(y(ft)(u.value.phone)),1)]),_:1}),l(L,{label:"部门"},{default:a(()=>[u.value.departmentName?(m(),N(T,{key:0,type:"primary"},{default:a(()=>[c(b(u.value.departmentName),1)]),_:1})):(m(),V("span",ba,"未分配"))]),_:1}),l(L,{label:"角色"},{default:a(()=>[l(T,{type:qe(u.value.roleId)},{default:a(()=>[c(b(Ue(u.value.roleId)),1)]),_:1},8,["type"])]),_:1}),l(L,{label:"状态"},{default:a(()=>[l(T,{type:u.value.status==="active"?"success":"danger"},{default:a(()=>[c(b(u.value.status==="active"?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),l(L,{label:"在线状态"},{default:a(()=>[l(T,{type:u.value.isOnline?"success":"info"},{default:a(()=>[c(b(u.value.isOnline?"在线":"离线"),1)]),_:1},8,["type"])]),_:1}),l(L,{label:"创建时间"},{default:a(()=>[c(b(u.value.createTime),1)]),_:1}),l(L,{label:"最后登录"},{default:a(()=>[c(b(u.value.lastLoginTime),1)]),_:1}),l(L,{label:"登录次数"},{default:a(()=>[c(b(u.value.loginCount),1)]),_:1}),l(L,{label:"备注",span:2},{default:a(()=>[c(b(u.value.remark||"无"),1)]),_:1})]),_:1})])):C("",!0)]),_:1},8,["modelValue"]),l(me,{modelValue:ue.value,"onUpdate:modelValue":e[20]||(e[20]=o=>ue.value=o),title:"权限设置",width:"800px"},{default:a(()=>[u.value?(m(),V("div",wa,[r("div",ka,[l(tt,{column:3,size:"small"},{default:a(()=>[l(L,{label:"用户"},{default:a(()=>[c(b(u.value.realName),1)]),_:1}),l(L,{label:"角色"},{default:a(()=>[c(b(Ue(u.value.roleId)),1)]),_:1}),l(L,{label:"状态"},{default:a(()=>[l(T,{type:u.value.status==="active"?"success":"danger",size:"small"},{default:a(()=>[c(b(u.value.status==="active"?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1})]),_:1})]),l(vl),r("div",Sa,[l(lt,{title:"权限同步机制说明",type:"info",closable:!1,"show-icon":""},{default:a(()=>[e[54]||(e[54]=r("p",null,"• 用户权限由角色权限和个人权限组成",-1)),e[55]||(e[55]=r("p",null,"• 角色权限是基础权限，不能被移除，与系统管理中的角色权限保持同步",-1)),e[56]||(e[56]=r("p",null,"• 个人权限可以在角色权限基础上进行额外授权",-1)),y(n).isSuperAdmin?(m(),V("p",xa,"• 作为超级管理员，您可以为用户授予任何额外权限")):(m(),V("p",Na,"• 只有超级管理员可以修改个人权限设置")),e[57]||(e[57]=r("p",null,"• 保存时会自动合并角色权限和个人权限，确保权限一致性",-1))]),_:1}),l(gl,{modelValue:Se.value,"onUpdate:modelValue":e[19]||(e[19]=o=>Se.value=o),class:"permission-tabs"},{default:a(()=>[l(st,{label:"角色权限",name:"role"},{default:a(()=>[r("div",Ca,[l(at,{data:xe.value,"show-checkbox":"","node-key":"id","default-checked-keys":[],props:{children:"children",label:"name"},"check-strictly":!1,disabled:""},null,8,["data"]),r("div",Ia,[l(i,null,{default:a(()=>[l(y(bt))]),_:1}),e[58]||(e[58]=c(" 角色权限由系统管理员在角色管理中配置，此处仅供查看 ",-1))])])]),_:1}),l(st,{label:"个人权限",name:"personal"},{default:a(()=>[r("div",Va,[r("div",Ua,[l(i,null,{default:a(()=>[l(y(bt))]),_:1}),y(n).isSuperAdmin?(m(),V("span",Pa,"灰色选项为角色默认权限，不可取消；可额外勾选其他权限进行授权")):(m(),V("span",$a,"只有超级管理员可以修改个人权限设置"))]),l(at,{ref:"personalPermissionTree",data:he.value,"show-checkbox":"","node-key":"id","default-checked-keys":re.value,props:{children:"children",label:"name",disabled:"disabled"},"check-strictly":!1,disabled:!y(n).isSuperAdmin,onCheck:At},null,8,["data","default-checked-keys","disabled"]),r("div",Ea,[l(s,{onClick:Tt,disabled:!y(n).isSuperAdmin},{default:a(()=>[...e[59]||(e[59]=[c(" 重置到角色默认权限 ",-1)])]),_:1},8,["disabled"]),l(s,{type:"primary",onClick:Lt,loading:ke.value,disabled:!y(n).isSuperAdmin},{default:a(()=>[...e[60]||(e[60]=[c(" 保存权限 ",-1)])]),_:1},8,["loading","disabled"])])])]),_:1})]),_:1},8,["modelValue"])])])):C("",!0)]),_:1},8,["modelValue"]),l(me,{modelValue:Ne.value,"onUpdate:modelValue":e[24]||(e[24]=o=>Ne.value=o),title:"操作日志",width:"1000px"},{default:a(()=>[u.value?(m(),V("div",za,[r("div",Ma,[r("div",Aa,[r("span",null,"用户："+b(u.value.realName)+"（"+b(u.value.username)+"）",1)]),r("div",Ta,[l(P,{modelValue:ae.value,"onUpdate:modelValue":e[21]||(e[21]=o=>ae.value=o),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small",onChange:Bt},null,8,["modelValue"]),l(s,{size:"small",onClick:Ot,icon:y(yt)},{default:a(()=>[...e[61]||(e[61]=[c("刷新",-1)])]),_:1},8,["icon"]),l(s,{size:"small",onClick:Ft,icon:y(Te)},{default:a(()=>[...e[62]||(e[62]=[c("导出",-1)])]),_:1},8,["icon"])])]),l(ot,{data:Ie.value,loading:Ce.value,stripe:"",height:"400"},{default:a(()=>[l(M,{prop:"time",label:"操作时间",width:"160"}),l(M,{prop:"action",label:"操作类型",width:"120"},{default:a(({row:o})=>[l(T,{type:Dt(o.action),size:"small"},{default:a(()=>[c(b(Rt(o.action)),1)]),_:2},1032,["type"])]),_:1}),l(M,{prop:"module",label:"操作模块",width:"120"}),l(M,{prop:"description",label:"操作描述","show-overflow-tooltip":""}),l(M,{prop:"ip",label:"IP地址",width:"120"}),l(M,{prop:"userAgent",label:"设备信息",width:"200","show-overflow-tooltip":""}),l(M,{prop:"result",label:"操作结果",width:"100"},{default:a(({row:o})=>[l(T,{type:o.result==="success"?"success":"danger",size:"small"},{default:a(()=>[c(b(o.result==="success"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data","loading"]),r("div",La,[l(hl,{"current-page":O.page,"onUpdate:currentPage":e[22]||(e[22]=o=>O.page=o),"page-size":O.size,"onUpdate:pageSize":e[23]||(e[23]=o=>O.size=o),"page-sizes":[10,20,50,100],total:O.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:jt,onCurrentChange:qt},null,8,["current-page","page-size","total"])])])):C("",!0)]),_:1},8,["modelValue"]),l(me,{modelValue:ie.value,"onUpdate:modelValue":e[25]||(e[25]=o=>ie.value=o),title:"批量导入用户",width:"800px","before-close":Ge,class:"batch-import-dialog"},{footer:a(()=>[r("div",ns,[r("div",rs,[D.value===3?(m(),V("span",is," 共 "+b(de.value.length)+" 条数据，其中 "+b(te.value.length)+" 条有效 ",1)):C("",!0)]),r("div",ds,[l(s,{onClick:Ge},{default:a(()=>[...e[82]||(e[82]=[c("取消",-1)])]),_:1}),D.value>0?(m(),N(s,{key:0,onClick:ll},{default:a(()=>[...e[83]||(e[83]=[c("上一步",-1)])]),_:1})):C("",!0),D.value<3?(m(),N(s,{key:1,type:"primary",onClick:Xe,disabled:D.value===2&&!le.value},{default:a(()=>[...e[84]||(e[84]=[c(" 下一步 ",-1)])]),_:1},8,["disabled"])):C("",!0),D.value===3?(m(),N(s,{key:2,type:"primary",onClick:dl,loading:ge.value,disabled:te.value.length===0},{default:a(()=>[...e[85]||(e[85]=[c(" 确认导入 ",-1)])]),_:1},8,["loading","disabled"])):C("",!0)])])]),default:a(()=>[r("div",Da,[l(_l,{active:D.value,"finish-status":"success","align-center":""},{default:a(()=>[l(_e,{title:"下载模板",description:"下载Excel模板文件"}),l(_e,{title:"填写数据",description:"按模板格式填写用户数据"}),l(_e,{title:"上传文件",description:"上传填写好的Excel文件"}),l(_e,{title:"预览确认",description:"预览导入数据并确认"})]),_:1},8,["active"]),D.value===0?(m(),V("div",Ra,[r("div",Ba,[e[64]||(e[64]=r("div",{class:"step-title"},"下载导入模板",-1)),e[65]||(e[65]=r("div",{class:"step-description"}," 请先下载用户导入模板，按照模板格式填写用户数据。 ",-1)),e[66]||(e[66]=r("div",{class:"template-info"},[r("h4",null,"模板说明："),r("ul",null,[r("li",null,"用户名：3-20个字符，不能重复"),r("li",null,"姓名：真实姓名，不能为空"),r("li",null,"邮箱：有效的邮箱地址"),r("li",null,"手机号：11位手机号码"),r("li",null,"角色：超级管理员、管理员、销售员、客服"),r("li",null,"备注：可选，用户备注信息")])],-1)),l(s,{type:"primary",onClick:al},{default:a(()=>[l(i,null,{default:a(()=>[l(y(Te))]),_:1}),e[63]||(e[63]=c(" 下载模板 ",-1))]),_:1})])])):C("",!0),D.value===1?(m(),V("div",Oa,[r("div",Fa,[e[68]||(e[68]=r("div",{class:"step-title"},"填写用户数据",-1)),e[69]||(e[69]=r("div",{class:"step-description"}," 请在下载的模板中填写用户数据，注意以下要点： ",-1)),l(lt,{title:"重要提示",type:"warning",closable:!1,"show-icon":""},{default:a(()=>[...e[67]||(e[67]=[r("ul",null,[r("li",null,"请严格按照模板格式填写，不要修改表头"),r("li",null,"用户名不能重复，系统会自动检查"),r("li",null,"角色名称必须准确，区分大小写"),r("li",null,"手机号和邮箱格式必须正确"),r("li",null,"建议先少量测试，确认无误后再批量导入")],-1)])]),_:1})])])):C("",!0),D.value===2?(m(),V("div",ja,[r("div",qa,[r("div",Ka,[l(yl,{ref_key:"uploadRef",ref:kt,class:"upload-demo",drag:"","auto-upload":!1,"on-change":sl,"before-upload":ol,accept:".xlsx,.xls",limit:1,"on-exceed":nl},{tip:a(()=>[...e[70]||(e[70]=[r("div",{class:"el-upload__tip"}," 只能上传xlsx/xls文件，且不超过10MB ",-1)])]),default:a(()=>[l(i,{class:"el-icon--upload"},{default:a(()=>[l(y(ht))]),_:1}),e[71]||(e[71]=r("div",{class:"el-upload__text"},[c(" 将Excel文件拖到此处，或"),r("em",null,"点击上传")],-1))]),_:1},512)]),le.value?(m(),V("div",Za,[r("p",null,"已选择文件："+b(le.value.name),1),l(s,{type:"primary",onClick:rl,loading:ne.value},{default:a(()=>[...e[72]||(e[72]=[c(" 解析文件 ",-1)])]),_:1},8,["loading"])])):C("",!0)])])):C("",!0),D.value===3?(m(),V("div",Wa,[r("div",Ya,[r("div",Ha,[e[75]||(e[75]=r("h4",null,"数据预览",-1)),r("p",null,[e[73]||(e[73]=c("共解析到 ",-1)),r("strong",null,b(de.value.length),1),e[74]||(e[74]=c(" 条用户数据，请确认后导入：",-1))])]),r("div",Ja,[l(ot,{data:de.value,border:"","max-height":"400"},{default:a(()=>[l(M,{prop:"username",label:"用户名",width:"120"}),l(M,{prop:"realName",label:"姓名",width:"100"}),l(M,{label:"邮箱",width:"180"},{default:a(({row:o})=>[c(b(y(Ae)(o.email,y(Me).EMAIL)),1)]),_:1}),l(M,{label:"手机号",width:"120"},{default:a(({row:o})=>[c(b(y(Ae)(o.phone,y(Me).PHONE)),1)]),_:1}),l(M,{prop:"role",label:"角色",width:"80"}),l(M,{prop:"department",label:"部门",width:"100"}),l(M,{label:"密码",width:"100"},{default:a(({row:o})=>[o.password?(m(),V("span",Qa,b(o.password.replace(/./g,"*")),1)):(m(),N(T,{key:1,type:"info",size:"small"},{default:a(()=>[...e[76]||(e[76]=[c("默认密码",-1)])]),_:1}))]),_:1}),l(M,{prop:"remark",label:"备注","show-overflow-tooltip":""}),l(M,{label:"验证结果",width:"100"},{default:a(({row:o})=>[o.errors&&o.errors.length===0?(m(),N(T,{key:0,type:"success"},{default:a(()=>[...e[77]||(e[77]=[c("有效",-1)])]),_:1})):(m(),N(T,{key:1,type:"danger"},{default:a(()=>[...e[78]||(e[78]=[c("无效",-1)])]),_:1}))]),_:1}),l(M,{label:"错误信息","min-width":"300"},{default:a(({row:o})=>[o.errors&&o.errors.length>0?(m(),V("div",Xa,[(m(!0),V(fe,null,ve(o.errors,(q,wl)=>(m(),V("div",{key:wl,class:"error-item"},[l(i,{class:"error-icon"},{default:a(()=>[l(y(jl))]),_:1}),r("span",Ga,b(q),1),Qe(q)?(m(),N(bl,{key:0,placement:"top",content:Qe(q)},{default:a(()=>[l(i,{class:"suggestion-icon"},{default:a(()=>[l(y(ql))]),_:1})]),_:1},8,["content"])):C("",!0)]))),128))])):(m(),V("div",es,[l(i,{class:"success-icon"},{default:a(()=>[l(y(Kl))]),_:1}),e[79]||(e[79]=r("span",{class:"success-text"},"数据有效",-1))]))]),_:1})]),_:1},8,["data"])]),r("div",ts,[r("div",ls,[r("div",as,b(te.value.length),1),e[80]||(e[80]=r("div",{class:"summary-label"},"有效数据",-1))]),r("div",ss,[r("div",os,b(we.value.length),1),e[81]||(e[81]=r("div",{class:"summary-label"},"无效数据",-1))])])])])):C("",!0)])]),_:1},8,["modelValue"])])}}}),Ns=Vl(us,[["__scopeId","data-v-4d532609"]]);export{Ns as default};
