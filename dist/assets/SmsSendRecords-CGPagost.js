var De=Object.defineProperty,Ie=Object.defineProperties;var ze=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var Me=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable;var te=(g,r,i)=>r in g?De(g,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):g[r]=i,le=(g,r)=>{for(var i in r||(r={}))Me.call(r,i)&&te(g,i,r[i]);if(ee)for(var i of ee(r))Re.call(r,i)&&te(g,i,r[i]);return g},ae=(g,r)=>Ie(g,ze(r));var M=(g,r,i)=>new Promise((F,Y)=>{var B=y=>{try{S(i.next(y))}catch(u){Y(u)}},I=y=>{try{S(i.throw(y))}catch(u){Y(u)}},S=y=>y.done?F(y.value):Promise.resolve(y.value).then(B,I);S((i=i.apply(g,r)).next())});import{s as Ue,r as $e,m as Ne,n as Ee,K as Te,aa as Fe,E as f,b as P}from"./elementPlus-Bmwh7Rh8.js";import{g as Ye,$ as ne,_ as Be}from"./settings-CuxbDWOu.js";import{l as je,r as D,Z as A,e as K,c as qe,ag as p,aq as Oe,m as R,p as _,q as o,U as t,O as l,S as s,u as E,P as Le,M as T,T as m,Q as q,F as Q,a9 as Z}from"./vendor-D8Vxqhr-.js";import"./utils-ywHRn0uI.js";const Pe={class:"sms-send-records"},Ae={class:"search-section"},Ke={class:"action-section"},Qe={class:"table-section"},Ze={class:"content-preview"},Ge={class:"send-result"},He={key:0,style:{"margin-top":"4px"}},Je={class:"cost-text"},We={class:"pagination-section"},Xe={class:"template-select-wrapper"},et={class:"variables-section"},tt={key:0,class:"detail-content"},lt={class:"detail-section"},at={class:"detail-section"},nt={class:"recipients-list"},st=je({__name:"SmsSendRecords",setup(g){const r=Ye(),i=D(!1),F=D(!1),Y=D([]),B=D([]),I=D([]),S=D(!1),y=D(!1),u=D(null),V=A({templateName:"",status:"",dateRange:[]}),v=A({page:1,pageSize:10,total:0}),d=A({templateId:null,recipients:"",variables:{}}),se={templateId:[{required:!0,message:"请选择短信模板",trigger:"change"}],recipients:[{required:!0,message:"请输入接收人手机号",trigger:"blur"}]},O=D(),U=K(()=>d.templateId?I.value.find(n=>n.id===d.templateId):null),L=K(()=>{if(!U.value)return[];const e=U.value.content.match(/\{(\w+)\}/g);return e?e.map(c=>c.slice(1,-1)):[]}),G=K(()=>{if(!U.value)return"";let n=U.value.content;return Object.entries(d.variables).forEach(([e,c])=>{n=n.replace(new RegExp(`\\{${e}\\}`,"g"),c)}),n}),k=()=>M(this,null,function*(){i.value=!0;try{const e=yield(void 0)(ae(le({},V),{page:v.page,pageSize:v.pageSize}));Y.value=e.list,v.total=e.total}catch(n){f.error("加载数据失败")}finally{i.value=!1}}),oe=()=>M(this,null,function*(){try{const n=yield(void 0)({status:"active"});I.value=n.list}catch(n){f.error("加载模板失败")}}),ie=()=>{v.page=1,k()},de=()=>{Object.assign(V,{templateName:"",status:"",dateRange:[]}),v.page=1,k()},re=n=>{B.value=n},ue=n=>{v.pageSize=n,k()},pe=n=>{v.page=n,k()},ce=()=>{d.variables={},L.value.forEach(n=>{d.variables[n]=""})},me=()=>M(this,null,function*(){if(O.value)try{yield O.value.validate(),F.value=!0;const n=d.recipients.split(/[,\n]/).map(C=>C.trim()).filter(C=>C);if(n.length===0){f.error("请输入有效的手机号");return}const e=/^1[3-9]\d{9}$/,c=n.filter(C=>!e.test(C));if(c.length>0){f.error(`以下手机号格式不正确：${c.join(", ")}`);return}const b=yield(void 0)({templateId:d.templateId,recipients:n,variables:d.variables});f.success("短信发送成功");const x=I.value.find(C=>C.id===d.templateId);r.sendMessage(ne.SMS_SEND_SUCCESS,`短信发送成功！使用模板"${x==null?void 0:x.name}"，成功发送给${n.length}个接收人。`,{relatedId:b.id,relatedType:"sms_send",actionUrl:"/system/sms-send-records"}),S.value=!1,k()}catch(n){f.error("短信发送失败");const e=I.value.find(c=>c.id===d.templateId);r.sendMessage(ne.SMS_SEND_FAILED,`短信发送失败！模板"${e==null?void 0:e.name}"发送给${recipients.length}个接收人时出现错误，请检查配置后重试。`,{relatedId:d.templateId,relatedType:"sms_send",actionUrl:"/system/sms-send-records"})}finally{F.value=!1}}),fe=()=>{var n;(n=O.value)==null||n.resetFields(),Object.assign(d,{templateId:null,recipients:"",variables:{}})},_e=()=>{window.open("/system/sms-templates?action=apply","_blank")},ge=n=>{u.value=n,y.value=!0},ve=n=>M(this,null,function*(){try{yield P.confirm("确定要重新发送这条短信吗？","确认重发",{type:"warning"}),yield(void 0)({templateId:n.templateId,recipients:n.recipients}),f.success("重新发送成功"),k()}catch(e){e!=="cancel"&&f.error("重新发送失败")}}),ye=n=>M(this,null,function*(){try{yield P.confirm("确定要删除这条发送记录吗？","确认删除",{type:"warning"}),f.success("删除成功"),k()}catch(e){e!=="cancel"&&f.error("删除失败")}}),be=()=>M(this,null,function*(){try{yield P.confirm(`确定要删除选中的 ${B.value.length} 条记录吗？`,"批量删除",{type:"warning"}),f.success("批量删除成功"),k()}catch(n){n!=="cancel"&&f.error("批量删除失败")}}),he=()=>{f.info("导出功能开发中...")},H=n=>({success:"success",failed:"danger",partial:"warning"})[n]||"info",J=n=>({success:"发送成功",failed:"发送失败",partial:"部分成功"})[n]||"未知状态";return qe(()=>{k(),oe()}),(n,e)=>{const c=p("el-input"),b=p("el-form-item"),x=p("el-option"),C=p("el-select"),we=p("el-date-picker"),j=p("el-icon"),h=p("el-button"),W=p("el-form"),w=p("el-table-column"),Ce=p("el-tooltip"),$=p("el-tag"),Se=p("el-table"),Ve=p("el-pagination"),X=p("el-dialog"),N=p("el-descriptions-item"),ke=p("el-descriptions"),xe=Oe("loading");return _(),R("div",Pe,[e[24]||(e[24]=o("div",{class:"page-header"},[o("h2",null,"短信发送记录"),o("p",null,"查看和管理所有短信发送历史记录")],-1)),o("div",Ae,[t(W,{model:V,inline:""},{default:l(()=>[t(b,{label:"模板名称"},{default:l(()=>[t(c,{modelValue:V.templateName,"onUpdate:modelValue":e[0]||(e[0]=a=>V.templateName=a),placeholder:"请输入模板名称",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(b,{label:"发送状态"},{default:l(()=>[t(C,{modelValue:V.status,"onUpdate:modelValue":e[1]||(e[1]=a=>V.status=a),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:l(()=>[t(x,{label:"全部",value:""}),t(x,{label:"发送成功",value:"success"}),t(x,{label:"发送失败",value:"failed"}),t(x,{label:"部分成功",value:"partial"})]),_:1},8,["modelValue"])]),_:1}),t(b,{label:"发送时间"},{default:l(()=>[t(we,{modelValue:V.dateRange,"onUpdate:modelValue":e[2]||(e[2]=a=>V.dateRange=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),t(b,null,{default:l(()=>[t(h,{type:"primary",onClick:ie},{default:l(()=>[t(j,null,{default:l(()=>[t(E(Ue))]),_:1}),e[11]||(e[11]=s(" 搜索 ",-1))]),_:1}),t(h,{onClick:de},{default:l(()=>[t(j,null,{default:l(()=>[t(E($e))]),_:1}),e[12]||(e[12]=s(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),o("div",Ke,[t(h,{type:"primary",onClick:e[3]||(e[3]=a=>S.value=!0)},{default:l(()=>[t(j,null,{default:l(()=>[t(E(Ne))]),_:1}),e[13]||(e[13]=s(" 发送短信 ",-1))]),_:1}),t(h,{type:"success",onClick:he},{default:l(()=>[t(j,null,{default:l(()=>[t(E(Ee))]),_:1}),e[14]||(e[14]=s(" 导出记录 ",-1))]),_:1}),t(h,{type:"danger",disabled:B.value.length===0,onClick:be},{default:l(()=>[t(j,null,{default:l(()=>[t(E(Te))]),_:1}),e[15]||(e[15]=s(" 批量删除 ",-1))]),_:1},8,["disabled"])]),o("div",Qe,[Le((_(),T(Se,{data:Y.value,onSelectionChange:re,stripe:"",border:""},{default:l(()=>[t(w,{type:"selection",width:"55"}),t(w,{prop:"id",label:"记录ID",width:"80"}),t(w,{prop:"templateName",label:"模板名称",width:"150"}),t(w,{prop:"content",label:"发送内容","min-width":"200"},{default:l(({row:a})=>[t(Ce,{content:a.content,placement:"top"},{default:l(()=>[o("span",Ze,m(a.content.length>50?a.content.substring(0,50)+"...":a.content),1)]),_:2},1032,["content"])]),_:1}),t(w,{prop:"recipientCount",label:"接收人数",width:"100",align:"center"},{default:l(({row:a})=>[t($,{type:"info"},{default:l(()=>[s(m(a.recipients.length),1)]),_:2},1024)]),_:1}),t(w,{label:"发送结果",width:"120",align:"center"},{default:l(({row:a})=>[o("div",Ge,[o("div",null,[t($,{type:"success",size:"small"},{default:l(()=>[s("成功: "+m(a.successCount),1)]),_:2},1024)]),a.failCount>0?(_(),R("div",He,[t($,{type:"danger",size:"small"},{default:l(()=>[s("失败: "+m(a.failCount),1)]),_:2},1024)])):q("",!0)])]),_:1}),t(w,{prop:"status",label:"状态",width:"100",align:"center"},{default:l(({row:a})=>[t($,{type:H(a.status),size:"small"},{default:l(()=>[s(m(J(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(w,{prop:"cost",label:"费用(元)",width:"100",align:"center"},{default:l(({row:a})=>[o("span",Je,"¥"+m(a.cost.toFixed(2)),1)]),_:1}),t(w,{prop:"operator",label:"操作人",width:"100"}),t(w,{prop:"sendTime",label:"发送时间",width:"160"}),t(w,{label:"操作",width:"180",fixed:"right"},{default:l(({row:a})=>[t(h,{type:"primary",size:"small",onClick:z=>ge(a)},{default:l(()=>[...e[16]||(e[16]=[s(" 查看详情 ",-1)])]),_:1},8,["onClick"]),t(h,{type:"warning",size:"small",onClick:z=>ve(a),disabled:a.status==="success"},{default:l(()=>[...e[17]||(e[17]=[s(" 重新发送 ",-1)])]),_:1},8,["onClick","disabled"]),t(h,{type:"danger",size:"small",onClick:z=>ye(a)},{default:l(()=>[...e[18]||(e[18]=[s(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[xe,i.value]])]),o("div",We,[t(Ve,{"current-page":v.page,"onUpdate:currentPage":e[4]||(e[4]=a=>v.page=a),"page-size":v.pageSize,"onUpdate:pageSize":e[5]||(e[5]=a=>v.pageSize=a),"page-sizes":[10,20,50,100],total:v.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ue,onCurrentChange:pe},null,8,["current-page","page-size","total"])]),t(X,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=a=>S.value=a),title:"发送短信",width:"600px","before-close":fe},{footer:l(()=>[t(h,{onClick:e[8]||(e[8]=a=>S.value=!1)},{default:l(()=>[...e[21]||(e[21]=[s("取消",-1)])]),_:1}),t(h,{type:"primary",onClick:me,loading:F.value},{default:l(()=>[...e[22]||(e[22]=[s(" 发送短信 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(W,{model:d,rules:se,ref_key:"sendFormRef",ref:O,"label-width":"100px"},{default:l(()=>[t(b,{label:"选择模板",prop:"templateId"},{default:l(()=>[o("div",Xe,[t(C,{modelValue:d.templateId,"onUpdate:modelValue":e[6]||(e[6]=a=>d.templateId=a),placeholder:"请选择短信模板",style:{flex:"1"},onChange:ce},{default:l(()=>[(_(!0),R(Q,null,Z(I.value,a=>(_(),T(x,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(h,{type:"primary",icon:E(Fe),onClick:_e,class:"apply-template-btn",title:"申请新模板"},{default:l(()=>[...e[19]||(e[19]=[s(" 申请模板 ",-1)])]),_:1},8,["icon"])])]),_:1}),U.value?(_(),T(b,{key:0,label:"模板内容"},{default:l(()=>[t(c,{value:U.value.content,type:"textarea",rows:3,readonly:"",style:{width:"100%"}},null,8,["value"])]),_:1})):q("",!0),t(b,{label:"接收人",prop:"recipients"},{default:l(()=>[t(c,{modelValue:d.recipients,"onUpdate:modelValue":e[7]||(e[7]=a=>d.recipients=a),type:"textarea",rows:4,placeholder:"请输入手机号，多个号码用换行或逗号分隔",style:{width:"100%"}},null,8,["modelValue"]),e[20]||(e[20]=o("div",{class:"form-tip"}," 支持批量输入，每行一个手机号或用逗号分隔 ",-1))]),_:1}),L.value.length>0?(_(),T(b,{key:1,label:"模板变量"},{default:l(()=>[o("div",et,[(_(!0),R(Q,null,Z(L.value,a=>(_(),R("div",{key:a,class:"variable-item"},[o("label",null,m(a)+":",1),t(c,{modelValue:d.variables[a],"onUpdate:modelValue":z=>d.variables[a]=z,placeholder:"请输入变量值",style:{width:"200px","margin-left":"10px"}},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1})):q("",!0),G.value?(_(),T(b,{key:2,label:"预览内容"},{default:l(()=>[t(c,{value:G.value,type:"textarea",rows:3,readonly:"",style:{width:"100%"}},null,8,["value"])]),_:1})):q("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(X,{modelValue:y.value,"onUpdate:modelValue":e[10]||(e[10]=a=>y.value=a),title:"发送记录详情",width:"800px"},{default:l(()=>[u.value?(_(),R("div",tt,[t(ke,{column:2,border:""},{default:l(()=>[t(N,{label:"记录ID"},{default:l(()=>[s(m(u.value.id),1)]),_:1}),t(N,{label:"模板名称"},{default:l(()=>[s(m(u.value.templateName),1)]),_:1}),t(N,{label:"发送状态"},{default:l(()=>[t($,{type:H(u.value.status)},{default:l(()=>[s(m(J(u.value.status)),1)]),_:1},8,["type"])]),_:1}),t(N,{label:"发送时间"},{default:l(()=>[s(m(u.value.sendTime),1)]),_:1}),t(N,{label:"操作人"},{default:l(()=>[s(m(u.value.operator),1)]),_:1}),t(N,{label:"费用"},{default:l(()=>[s("¥"+m(u.value.cost.toFixed(2)),1)]),_:1})]),_:1}),o("div",lt,[e[23]||(e[23]=o("h4",null,"发送内容",-1)),t(c,{value:u.value.content,type:"textarea",rows:4,readonly:""},null,8,["value"])]),o("div",at,[o("h4",null,"接收人列表 ("+m(u.value.recipients.length)+"人)",1),o("div",nt,[(_(!0),R(Q,null,Z(u.value.recipients,(a,z)=>(_(),T($,{key:z,class:"recipient-tag",type:z<u.value.successCount?"success":"danger"},{default:l(()=>[s(m(a),1)]),_:2},1032,["type"]))),128))])])])):q("",!0)]),_:1},8,["modelValue"])])}}}),pt=Be(st,[["__scopeId","data-v-2e10fadf"]]);export{pt as default};
