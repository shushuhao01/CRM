import{F as e,r as a,m as t,G as l,A as s,W as r,E as n,b as i}from"./elementPlus-DxaqjplL.js";import{r as o,b as p,M as d,_ as c}from"./index-C4IdUW1A.js";import{isProduction as u}from"./env-DLalhsF6.js";import{l as m,r as v,Z as y,e as g,b as f,ag as b,aq as _,m as h,q as w,p as N,U as S,O as C,S as k,u as I,P as V,M as x,T as A,Q as D,F as z,a9 as U}from"./vendor-BtukhyiH.js";import"./utils-DfI7e5Rl.js";const O=[{id:"preset-1",name:"订单确认通知",category:"order",content:"尊敬的{customerName}，您的订单{orderNo}已确认，订单金额{amount}元，预计{deliveryTime}送达。如有疑问请联系客服。",variables:["{customerName}","{orderNo}","{amount}","{deliveryTime}"],description:"订单创建后自动发送确认通知",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-2",name:"发货通知",category:"logistics",content:"您的订单{orderNo}已发货，快递公司：{expressCompany}，快递单号：{trackingNo}，请注意查收。",variables:["{orderNo}","{expressCompany}","{trackingNo}"],description:"订单发货后通知客户",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-3",name:"签收提醒",category:"logistics",content:"您的订单{orderNo}已签收，感谢您的购买！如有问题请及时联系我们，祝您生活愉快！",variables:["{orderNo}"],description:"订单签收后发送感谢短信",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-4",name:"付款提醒",category:"reminder",content:"尊敬的{customerName}，您的订单{orderNo}还有{amount}元未付款，请及时处理以免影响发货。",variables:["{customerName}","{orderNo}","{amount}"],description:"订单未付款提醒",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-5",name:"客户生日祝福",category:"marketing",content:"亲爱的{customerName}，祝您生日快乐！感谢一直以来的支持，专属生日礼品等您领取，祝您生活幸福美满！",variables:["{customerName}"],description:"会员生日当天发送祝福",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-6",name:"促销活动通知",category:"marketing",content:"{activityName}火热进行中！{activityContent}，活动时间：{startTime}至{endTime}，机会难得，不容错过！",variables:["{activityName}","{activityContent}","{startTime}","{endTime}"],description:"促销活动推广通知",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-7",name:"订单状态更新",category:"order",content:"您的订单{orderNo}状态已更新为：{status}。如有疑问请联系客服，我们将竭诚为您服务。",variables:["{orderNo}","{status}"],description:"订单状态变更通知",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-8",name:"售后服务提醒",category:"service",content:"尊敬的{customerName}，您的售后工单{ticketNo}已处理完成，处理结果：{result}。感谢您的理解与支持！",variables:["{customerName}","{ticketNo}","{result}"],description:"售后工单处理完成通知",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-9",name:"客户回访邀请",category:"service",content:"尊敬的{customerName}，感谢您购买我们的产品。为了提供更好的服务，诚邀您参与满意度调查，您的意见对我们很重要！",variables:["{customerName}"],description:"购买后回访邀请",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0},{id:"preset-10",name:"账户余额提醒",category:"reminder",content:"尊敬的{customerName}，您的账户余额不足{balance}元，为避免影响正常使用，请及时充值。",variables:["{customerName}","{balance}"],description:"账户余额不足提醒",applicant:"system",applicantName:"系统",applicantDept:"系统",createdAt:"2024-01-01 00:00:00",status:"approved",approvedBy:"系统管理员",approvedAt:"2024-01-01 00:00:00",isSystem:!0}];function T(e){if((()=>{if(u())return!1;return"true"===localStorage.getItem("erp_mock_enabled")})()){const a=function(){const e=localStorage.getItem("crm_send_records");return e?JSON.parse(e):[]}(),t=function(){const e=localStorage.getItem("crm_sms_templates");if(e){const a=JSON.parse(e);if(!O.map(e=>e.id).every(e=>a.some(a=>a.id===e))){const e=a.filter(e=>!e.isSystem),t=[...O,...e];return localStorage.setItem("crm_sms_templates",JSON.stringify(t)),t}return a}return localStorage.setItem("crm_sms_templates",JSON.stringify(O)),O}().find(a=>a.id===e.templateId),l={id:`record-${Date.now()}`,templateName:t?.name||"未知模板",content:e.content,recipientCount:e.recipients.length,successCount:e.recipients.length,failCount:0,status:"completed",sentAt:(new Date).toISOString(),sendDetails:e.recipients.map(e=>({phone:e,status:"success",sentAt:(new Date).toISOString()}))};return a.unshift(l),localStorage.setItem("crm_send_records",JSON.stringify(a)),Promise.resolve({code:200,data:l,message:"发送成功"})}return o({url:"/api/sms/send",method:"post",data:e})}const j={class:"sms-send-records"},B={class:"search-section"},M={class:"action-section"},$={class:"table-section"},E={class:"content-preview"},Y={class:"send-result"},F={key:0,style:{"margin-top":"4px"}},R={class:"cost-text"},J={class:"pagination-section"},q={class:"template-select-wrapper"},P={class:"variables-section"},G={key:0,class:"detail-content"},L={class:"detail-section"},Q={class:"detail-section"},W={class:"recipients-list"},Z=c(m({__name:"SmsSendRecords",setup(o){const c=p(),u=v(!1),m=v(!1),O=v([]),Z=v([]),H=v([]),K=v(!1),X=v(!1),ee=v(null),ae=y({templateName:"",status:"",dateRange:[]}),te=y({page:1,pageSize:10,total:0}),le=y({templateId:null,recipients:"",variables:{}}),se={templateId:[{required:!0,message:"请选择短信模板",trigger:"change"}],recipients:[{required:!0,message:"请输入接收人手机号",trigger:"blur"}]},re=v(),ne=g(()=>le.templateId?H.value.find(e=>e.id===le.templateId):null),ie=g(()=>{if(!ne.value)return[];const e=ne.value.content.match(/\{(\w+)\}/g);return e?e.map(e=>e.slice(1,-1)):[]}),oe=g(()=>{if(!ne.value)return"";let e=ne.value.content;return Object.entries(le.variables).forEach(([a,t])=>{e=e.replace(new RegExp(`\\{${a}\\}`,"g"),t)}),e}),pe=async()=>{u.value=!0;try{const e={...ae,page:te.page,pageSize:te.pageSize},a=await(void 0)(e);O.value=a?.list||[],te.total=a?.total||0}catch(e){n.error("加载数据失败")}finally{u.value=!1}},de=()=>{te.page=1,pe()},ce=()=>{Object.assign(ae,{templateName:"",status:"",dateRange:[]}),te.page=1,pe()},ue=e=>{Z.value=e},me=e=>{te.pageSize=e,pe()},ve=e=>{te.page=e,pe()},ye=()=>{le.variables={},ie.value.forEach(e=>{le.variables[e]=""})},ge=async()=>{if(re.value)try{await re.value.validate(),m.value=!0;const e=le.recipients.split(/[,\n]/).map(e=>e.trim()).filter(e=>e);if(0===e.length)return void n.error("请输入有效的手机号");const a=/^1[3-9]\d{9}$/,t=e.filter(e=>!a.test(e));if(t.length>0)return void n.error(`以下手机号格式不正确：${t.join(", ")}`);const l=await T({templateId:le.templateId,recipients:e,variables:le.variables});n.success("短信发送成功");const s=H.value.find(e=>e.id===le.templateId);c.sendMessage(d.SMS_SEND_SUCCESS,`短信发送成功！使用模板"${s?.name}"，成功发送给${e.length}个接收人。`,{relatedId:l.id,relatedType:"sms_send",actionUrl:"/system/sms-send-records"}),K.value=!1,pe()}catch(e){n.error("短信发送失败");const a=H.value.find(e=>e.id===le.templateId);c.sendMessage(d.SMS_SEND_FAILED,`短信发送失败！模板"${a?.name}"发送给${recipients.length}个接收人时出现错误，请检查配置后重试。`,{relatedId:le.templateId,relatedType:"sms_send",actionUrl:"/system/sms-send-records"})}finally{m.value=!1}},fe=()=>{re.value?.resetFields(),Object.assign(le,{templateId:null,recipients:"",variables:{}})},be=()=>{window.open("/system/sms-templates?action=apply","_blank")},_e=async()=>{try{await i.confirm(`确定要删除选中的 ${Z.value.length} 条记录吗？`,"批量删除",{type:"warning"}),n.success("批量删除成功"),pe()}catch(e){"cancel"!==e&&n.error("批量删除失败")}},he=()=>{n.info("导出功能开发中...")},we=e=>({success:"success",failed:"danger",partial:"warning"}[e]||"info"),Ne=e=>({success:"发送成功",failed:"发送失败",partial:"部分成功"}[e]||"未知状态");return f(()=>{pe(),(async()=>{try{const e=await(void 0)({status:"active"});H.value=e?.list||[]}catch(e){n.error("加载模板失败")}})()}),(o,p)=>{const d=b("el-input"),c=b("el-form-item"),v=b("el-option"),y=b("el-select"),g=b("el-date-picker"),f=b("el-icon"),Se=b("el-button"),Ce=b("el-form"),ke=b("el-table-column"),Ie=b("el-tooltip"),Ve=b("el-tag"),xe=b("el-table"),Ae=b("el-pagination"),De=b("el-dialog"),ze=b("el-descriptions-item"),Ue=b("el-descriptions"),Oe=_("loading");return w(),h("div",j,[p[24]||(p[24]=N("div",{class:"page-header"},[N("h2",null,"短信发送记录"),N("p",null,"查看和管理所有短信发送历史记录")],-1)),N("div",B,[S(Ce,{model:ae,inline:""},{default:C(()=>[S(c,{label:"模板名称"},{default:C(()=>[S(d,{modelValue:ae.templateName,"onUpdate:modelValue":p[0]||(p[0]=e=>ae.templateName=e),placeholder:"请输入模板名称",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),S(c,{label:"发送状态"},{default:C(()=>[S(y,{modelValue:ae.status,"onUpdate:modelValue":p[1]||(p[1]=e=>ae.status=e),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:C(()=>[S(v,{label:"全部",value:""}),S(v,{label:"发送成功",value:"success"}),S(v,{label:"发送失败",value:"failed"}),S(v,{label:"部分成功",value:"partial"})]),_:1},8,["modelValue"])]),_:1}),S(c,{label:"发送时间"},{default:C(()=>[S(g,{modelValue:ae.dateRange,"onUpdate:modelValue":p[2]||(p[2]=e=>ae.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),S(c,null,{default:C(()=>[S(Se,{type:"primary",onClick:de},{default:C(()=>[S(f,null,{default:C(()=>[S(I(e))]),_:1}),p[11]||(p[11]=k(" 搜索 ",-1))]),_:1}),S(Se,{onClick:ce},{default:C(()=>[S(f,null,{default:C(()=>[S(I(a))]),_:1}),p[12]||(p[12]=k(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),N("div",M,[S(Se,{type:"primary",onClick:p[3]||(p[3]=e=>K.value=!0)},{default:C(()=>[S(f,null,{default:C(()=>[S(I(t))]),_:1}),p[13]||(p[13]=k(" 发送短信 ",-1))]),_:1}),S(Se,{type:"success",onClick:he},{default:C(()=>[S(f,null,{default:C(()=>[S(I(l))]),_:1}),p[14]||(p[14]=k(" 导出记录 ",-1))]),_:1}),S(Se,{type:"danger",disabled:0===Z.value.length,onClick:_e},{default:C(()=>[S(f,null,{default:C(()=>[S(I(s))]),_:1}),p[15]||(p[15]=k(" 批量删除 ",-1))]),_:1},8,["disabled"])]),N("div",$,[V((w(),x(xe,{data:O.value,onSelectionChange:ue,stripe:"",border:""},{default:C(()=>[S(ke,{type:"selection",width:"55"}),S(ke,{prop:"id",label:"记录ID",width:"80"}),S(ke,{prop:"templateName",label:"模板名称",width:"150"}),S(ke,{prop:"content",label:"发送内容","min-width":"200"},{default:C(({row:e})=>[S(Ie,{content:e.content,placement:"top"},{default:C(()=>[N("span",E,A(e.content.length>50?e.content.substring(0,50)+"...":e.content),1)]),_:2},1032,["content"])]),_:1}),S(ke,{prop:"recipientCount",label:"接收人数",width:"100",align:"center"},{default:C(({row:e})=>[S(Ve,{type:"info"},{default:C(()=>[k(A(e.recipients.length),1)]),_:2},1024)]),_:1}),S(ke,{label:"发送结果",width:"120",align:"center"},{default:C(({row:e})=>[N("div",Y,[N("div",null,[S(Ve,{type:"success",size:"small"},{default:C(()=>[k("成功: "+A(e.successCount),1)]),_:2},1024)]),e.failCount>0?(w(),h("div",F,[S(Ve,{type:"danger",size:"small"},{default:C(()=>[k("失败: "+A(e.failCount),1)]),_:2},1024)])):D("",!0)])]),_:1}),S(ke,{prop:"status",label:"状态",width:"100",align:"center"},{default:C(({row:e})=>[S(Ve,{type:we(e.status),size:"small"},{default:C(()=>[k(A(Ne(e.status)),1)]),_:2},1032,["type"])]),_:1}),S(ke,{prop:"cost",label:"费用(元)",width:"100",align:"center"},{default:C(({row:e})=>[N("span",R,"¥"+A(e.cost.toFixed(2)),1)]),_:1}),S(ke,{prop:"operator",label:"操作人",width:"100"}),S(ke,{prop:"sendTime",label:"发送时间",width:"160"}),S(ke,{label:"操作",width:"180",fixed:"right"},{default:C(({row:e})=>[S(Se,{type:"primary",size:"small",onClick:a=>{return t=e,ee.value=t,void(X.value=!0);var t}},{default:C(()=>[...p[16]||(p[16]=[k(" 查看详情 ",-1)])]),_:1},8,["onClick"]),S(Se,{type:"warning",size:"small",onClick:a=>(async e=>{try{await i.confirm("确定要重新发送这条短信吗？","确认重发",{type:"warning"}),await T({templateId:e.templateId,recipients:e.recipients}),n.success("重新发送成功"),pe()}catch(a){"cancel"!==a&&n.error("重新发送失败")}})(e),disabled:"success"===e.status},{default:C(()=>[...p[17]||(p[17]=[k(" 重新发送 ",-1)])]),_:1},8,["onClick","disabled"]),S(Se,{type:"danger",size:"small",onClick:e=>(async()=>{try{await i.confirm("确定要删除这条发送记录吗？","确认删除",{type:"warning"}),n.success("删除成功"),pe()}catch(e){"cancel"!==e&&n.error("删除失败")}})()},{default:C(()=>[...p[18]||(p[18]=[k(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Oe,u.value]])]),N("div",J,[S(Ae,{"current-page":te.page,"onUpdate:currentPage":p[4]||(p[4]=e=>te.page=e),"page-size":te.pageSize,"onUpdate:pageSize":p[5]||(p[5]=e=>te.pageSize=e),"page-sizes":[10,20,50,100],total:te.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:me,onCurrentChange:ve},null,8,["current-page","page-size","total"])]),S(De,{modelValue:K.value,"onUpdate:modelValue":p[9]||(p[9]=e=>K.value=e),title:"发送短信",width:"600px","before-close":fe},{footer:C(()=>[S(Se,{onClick:p[8]||(p[8]=e=>K.value=!1)},{default:C(()=>[...p[21]||(p[21]=[k("取消",-1)])]),_:1}),S(Se,{type:"primary",onClick:ge,loading:m.value},{default:C(()=>[...p[22]||(p[22]=[k(" 发送短信 ",-1)])]),_:1},8,["loading"])]),default:C(()=>[S(Ce,{model:le,rules:se,ref_key:"sendFormRef",ref:re,"label-width":"100px"},{default:C(()=>[S(c,{label:"选择模板",prop:"templateId"},{default:C(()=>[N("div",q,[S(y,{modelValue:le.templateId,"onUpdate:modelValue":p[6]||(p[6]=e=>le.templateId=e),placeholder:"请选择短信模板",style:{flex:"1"},onChange:ye},{default:C(()=>[(w(!0),h(z,null,U(H.value,e=>(w(),x(v,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),S(Se,{type:"primary",icon:I(r),onClick:be,class:"apply-template-btn",title:"申请新模板"},{default:C(()=>[...p[19]||(p[19]=[k(" 申请模板 ",-1)])]),_:1},8,["icon"])])]),_:1}),ne.value?(w(),x(c,{key:0,label:"模板内容"},{default:C(()=>[S(d,{value:ne.value.content,type:"textarea",rows:3,readonly:"",style:{width:"100%"}},null,8,["value"])]),_:1})):D("",!0),S(c,{label:"接收人",prop:"recipients"},{default:C(()=>[S(d,{modelValue:le.recipients,"onUpdate:modelValue":p[7]||(p[7]=e=>le.recipients=e),type:"textarea",rows:4,placeholder:"请输入手机号，多个号码用换行或逗号分隔",style:{width:"100%"}},null,8,["modelValue"]),p[20]||(p[20]=N("div",{class:"form-tip"}," 支持批量输入，每行一个手机号或用逗号分隔 ",-1))]),_:1}),ie.value.length>0?(w(),x(c,{key:1,label:"模板变量"},{default:C(()=>[N("div",P,[(w(!0),h(z,null,U(ie.value,e=>(w(),h("div",{key:e,class:"variable-item"},[N("label",null,A(e)+":",1),S(d,{modelValue:le.variables[e],"onUpdate:modelValue":a=>le.variables[e]=a,placeholder:"请输入变量值",style:{width:"200px","margin-left":"10px"}},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1})):D("",!0),oe.value?(w(),x(c,{key:2,label:"预览内容"},{default:C(()=>[S(d,{value:oe.value,type:"textarea",rows:3,readonly:"",style:{width:"100%"}},null,8,["value"])]),_:1})):D("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),S(De,{modelValue:X.value,"onUpdate:modelValue":p[10]||(p[10]=e=>X.value=e),title:"发送记录详情",width:"800px"},{default:C(()=>[ee.value?(w(),h("div",G,[S(Ue,{column:2,border:""},{default:C(()=>[S(ze,{label:"记录ID"},{default:C(()=>[k(A(ee.value.id),1)]),_:1}),S(ze,{label:"模板名称"},{default:C(()=>[k(A(ee.value.templateName),1)]),_:1}),S(ze,{label:"发送状态"},{default:C(()=>[S(Ve,{type:we(ee.value.status)},{default:C(()=>[k(A(Ne(ee.value.status)),1)]),_:1},8,["type"])]),_:1}),S(ze,{label:"发送时间"},{default:C(()=>[k(A(ee.value.sendTime),1)]),_:1}),S(ze,{label:"操作人"},{default:C(()=>[k(A(ee.value.operator),1)]),_:1}),S(ze,{label:"费用"},{default:C(()=>[k("¥"+A(ee.value.cost.toFixed(2)),1)]),_:1})]),_:1}),N("div",L,[p[23]||(p[23]=N("h4",null,"发送内容",-1)),S(d,{value:ee.value.content,type:"textarea",rows:4,readonly:""},null,8,["value"])]),N("div",Q,[N("h4",null,"接收人列表 ("+A(ee.value.recipients.length)+"人)",1),N("div",W,[(w(!0),h(z,null,U(ee.value.recipients,(e,a)=>(w(),x(Ve,{key:a,class:"recipient-tag",type:a<ee.value.successCount?"success":"danger"},{default:C(()=>[k(A(e),1)]),_:2},1032,["type"]))),128))])])])):D("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-e44d8ed7"]]);export{Z as default};
