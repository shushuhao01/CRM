import{l as e,aA as a,r as t,Z as l,e as o,b as s,Y as i,ag as n,m as r,q as c,p as d,U as u,O as p,S as m,u as g,T as f,a2 as y}from"./vendor-BtukhyiH.js";import{r as _,F as b,S as h,ac as v,E as k,b as C}from"./elementPlus-DxaqjplL.js";import{D as N}from"./DynamicTable-BXyvPHDr.js";import{d as w,u as x,e as E,E as D,c as S,_ as R}from"./index-BGtT17ll.js";import"./TableColumnSettings-CpY_V997.js";import"./utils-DfI7e5Rl.js";const T={class:"logistics-list"},I={class:"page-header"},L={class:"header-actions"},O={key:0,class:"tracking-no-wrapper"},z={key:1,class:"no-data"},j=R(e({__name:"List",setup(e){const R=a(),j=S(R),V=w();x();const A=t(!1),U=t(0),W=t([]),P=l({trackingNo:"",orderNo:"",status:"",company:""}),H=l({page:1,size:20}),$=t([]),G=o(()=>[{prop:"trackingNo",label:"物流单号",minWidth:160,visible:!0,slot:!0},{prop:"orderNo",label:"订单号",minWidth:140,visible:!0,slot:!0},{prop:"customerName",label:"客户姓名",minWidth:100,visible:!0,slot:!0},{prop:"company",label:"物流公司",minWidth:100,visible:!0},{prop:"status",label:"状态",minWidth:90,visible:!0},{prop:"destination",label:"目的地",minWidth:120,visible:!0},{prop:"shipDate",label:"发货时间",minWidth:150,visible:!0},{prop:"estimatedDate",label:"预计送达",minWidth:150,visible:!0}]),F=e=>({pending_transfer:"待流转",pending_audit:"待审核",audit_rejected:"审核拒绝",pending_shipment:"待发货",shipped:"已发货",delivered:"已签收",logistics_returned:"物流部退回",logistics_cancelled:"物流部取消",package_exception:"包裹异常",rejected:"拒收",rejected_returned:"拒收已退回",after_sales_created:"已建售后",cancelled:"已取消",pending:"待发货",picked_up:"已揽收",in_transit:"运输中",out_for_delivery:"派送中",exception:"异常",returned:"已退回",refunded:"退货退款",abnormal:"状态异常"}[e]||e),B=()=>{H.page=1,Z()},q=()=>{Object.assign(P,{trackingNo:"",orderNo:"",status:"",company:""}),H.page=1,Z()},Y=()=>{Z()},Z=async()=>{A.value=!0;try{await new Promise(e=>setTimeout(e,500));const e=V.getOrders();let a=e.filter(e=>("shipped"===e.status||"delivered"===e.status)&&(e.trackingNumber||e.expressNo)&&e.expressCompany).map(e=>({id:parseInt(e.id),orderId:e.id,customerId:e.customerId,trackingNo:e.trackingNumber||"",orderNo:e.orderNumber,customerName:e.customerName,company:e.expressCompany||"",status:"shipped",destination:e.receiverAddress||"",shipDate:e.shippingTime||(new Date).toISOString(),estimatedDate:""}));P.trackingNo&&(a=a.filter(e=>e.trackingNo.includes(P.trackingNo))),P.orderNo&&(a=a.filter(e=>e.orderNo.includes(P.orderNo))),P.status&&(a=a.filter(e=>e.status===P.status)),P.company&&(a=a.filter(e=>e.company===P.company)),a.sort((e,a)=>{const t=new Date(e.shipDate||0).getTime();return new Date(a.shipDate||0).getTime()-t});const t=(H.page-1)*H.size,l=t+H.size;$.value=a.slice(t,l),U.value=a.length}catch(e){k.error("加载数据失败"),console.error("Load data error:",e)}finally{A.value=!1}},J=e=>{W.value=e},K=e=>{H.size=e,H.page=1,Z()},M=e=>{H.page=e,Z()},Q=()=>{console.log("[物流列表] 收到订单发货事件"),Z()},X=()=>{console.log("[物流列表] 收到订单取消事件"),Z()},ee=()=>{console.log("[物流列表] 收到订单退回事件"),Z()},ae=()=>{console.log("[物流列表] 收到刷新列表事件"),Z()};return s(()=>{Z(),V.setupLogisticsEventListener(),V.startLogisticsAutoSync(),V.$subscribe((e,a)=>{e.events.some(e=>"status"===e.key||"expressNo"===e.key||"expressCompany"===e.key)&&Z()}),E.on(D.ORDER_SHIPPED,Q),E.on(D.ORDER_CANCELLED,X),E.on(D.ORDER_RETURNED,ee),E.on(D.REFRESH_LOGISTICS_LIST,ae),E.on(D.ORDER_STATUS_CHANGED,ae),console.log("[物流列表] 事件监听器已注册")}),i(()=>{V.stopLogisticsAutoSync(),E.off(D.ORDER_SHIPPED,Q),E.off(D.ORDER_CANCELLED,X),E.off(D.ORDER_RETURNED,ee),E.off(D.REFRESH_LOGISTICS_LIST,ae),E.off(D.ORDER_STATUS_CHANGED,ae),console.log("[物流列表] 事件监听器已清理")}),(e,a)=>{const t=n("el-icon"),l=n("el-button"),o=n("el-input"),s=n("el-form-item"),i=n("el-option"),w=n("el-select"),x=n("el-form"),E=n("el-card"),D=n("el-link"),S=n("el-tag");return c(),r("div",T,[d("div",I,[a[5]||(a[5]=d("div",{class:"header-left"},[d("h1",null,"物流列表"),d("p",null,"管理和跟踪所有物流订单")],-1)),d("div",L,[u(l,{type:"primary",onClick:Y},{default:p(()=>[u(t,null,{default:p(()=>[u(g(_))]),_:1}),a[4]||(a[4]=m(" 刷新 ",-1))]),_:1})])]),u(E,{class:"search-card"},{default:p(()=>[u(x,{model:P,inline:"",class:"search-form"},{default:p(()=>[u(s,{label:"物流单号"},{default:p(()=>[u(o,{modelValue:P.trackingNo,"onUpdate:modelValue":a[0]||(a[0]=e=>P.trackingNo=e),placeholder:"请输入物流单号",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),u(s,{label:"订单号"},{default:p(()=>[u(o,{modelValue:P.orderNo,"onUpdate:modelValue":a[1]||(a[1]=e=>P.orderNo=e),placeholder:"请输入订单号",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),u(s,{label:"物流状态"},{default:p(()=>[u(w,{modelValue:P.status,"onUpdate:modelValue":a[2]||(a[2]=e=>P.status=e),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:p(()=>[u(i,{label:"待发货",value:"pending"}),u(i,{label:"已发货",value:"shipped"}),u(i,{label:"运输中",value:"in_transit"}),u(i,{label:"已送达",value:"delivered"}),u(i,{label:"异常",value:"exception"})]),_:1},8,["modelValue"])]),_:1}),u(s,{label:"物流公司"},{default:p(()=>[u(w,{modelValue:P.company,"onUpdate:modelValue":a[3]||(a[3]=e=>P.company=e),placeholder:"请选择物流公司",clearable:"",style:{width:"150px"}},{default:p(()=>[u(i,{label:"顺丰速运",value:"sf"}),u(i,{label:"圆通速递",value:"yt"}),u(i,{label:"中通快递",value:"zt"}),u(i,{label:"申通快递",value:"st"}),u(i,{label:"韵达速递",value:"yd"})]),_:1},8,["modelValue"])]),_:1}),u(s,null,{default:p(()=>[u(l,{type:"primary",onClick:B},{default:p(()=>[u(t,null,{default:p(()=>[u(g(b))]),_:1}),a[6]||(a[6]=m(" 搜索 ",-1))]),_:1}),u(l,{onClick:q},{default:p(()=>[u(t,null,{default:p(()=>[u(g(h))]),_:1}),a[7]||(a[7]=m(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),u(N,{data:$.value,columns:G.value,"storage-key":"logistics-list-columns",title:"物流列表",loading:A.value,"show-selection":!0,"show-index":!1,pagination:{currentPage:H.page,pageSize:H.size,total:U.value},onSelectionChange:J,onSizeChange:K,onCurrentChange:M},{"column-trackingNo":p(({row:e})=>[e.trackingNo?(c(),r("div",O,[u(D,{type:"primary",onClick:a=>(async e=>{try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(e),k.success("物流单号已复制到剪贴板");else{const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.left="-999999px",a.style.top="-999999px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");if(document.body.removeChild(a),!t)return void k.error("复制失败，请手动复制");k.success("物流单号已复制到剪贴板")}}catch(a){return console.error("复制失败:",a),void k.error("复制失败，请手动复制")}C.confirm("请选择要跳转的查询网站","选择查询网站",{confirmButtonText:"顺丰官网",cancelButtonText:"快递100",distinguishCancelAndClose:!0,type:"info"}).then(()=>{window.open("https://www.sf-express.com/chn/sc/waybill/list","_blank")}).catch(e=>{"cancel"===e&&window.open("https://www.kuaidi100.com/","_blank")})})(e.trackingNo)},{default:p(()=>[m(f(e.trackingNo),1)]),_:2},1032,["onClick"]),u(l,{size:"small",type:"text",onClick:y(a=>(async e=>{try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(e),k.success("物流单号已复制到剪贴板");else{const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.left="-999999px",a.style.top="-999999px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");document.body.removeChild(a),t?k.success("物流单号已复制到剪贴板"):k.error("复制失败，请手动复制")}}catch(a){console.error("复制失败:",a),k.error("复制失败，请手动复制")}})(e.trackingNo),["stop"]),class:"copy-btn"},{default:p(()=>[u(t,null,{default:p(()=>[u(g(v))]),_:1})]),_:1},8,["onClick"])])):(c(),r("span",z,"未发货"))]),"column-orderNo":p(({row:e})=>[u(D,{type:"primary",onClick:a=>{var t;(t=e.orderId)&&R.push(`/order/detail/${t}`)}},{default:p(()=>[m(f(e.orderNo),1)]),_:2},1032,["onClick"])]),"column-customerName":p(({row:e})=>[u(D,{type:"primary",onClick:a=>{var t;(t=e.customerId)&&R.push(`/customer/detail/${t}`)}},{default:p(()=>[m(f(e.customerName),1)]),_:2},1032,["onClick"])]),"column-company":p(({row:e})=>[u(S,null,{default:p(()=>{return[m(f((a=e.company,{sf:"顺丰速运",yt:"圆通速递",zt:"中通快递",st:"申通快递",yd:"韵达速递"}[a]||a)),1)];var a}),_:2},1024)]),"column-status":p(({row:e})=>{return[u(S,{type:(a=e.status,{pending:"info",shipped:"success",picked_up:"primary",in_transit:"warning",out_for_delivery:"warning",delivered:"success",rejected:"danger",rejected_returned:"warning",exception:"danger",abnormal:"danger",package_exception:"danger"}[a]||"info")},{default:p(()=>[m(f(F(e.status)),1)]),_:2},1032,["type"])];var a}),"table-actions":p(({row:e})=>[u(l,{type:"primary",size:"small",onClick:a=>(e=>{j.push(`/logistics/track/detail/${e.trackingNo}`)})(e)},{default:p(()=>[...a[8]||(a[8]=[m(" 跟踪 ",-1)])]),_:1},8,["onClick"]),u(l,{type:"success",size:"small",onClick:a=>(e=>{j.push(`/logistics/edit/${e.id}`)})(e)},{default:p(()=>[...a[9]||(a[9]=[m(" 编辑 ",-1)])]),_:1},8,["onClick"]),u(l,{type:"info",size:"small",onClick:a=>(e=>{j.push(`/logistics/detail/${e.id}`)})(e)},{default:p(()=>[...a[10]||(a[10]=[m(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1},8,["data","columns","loading","pagination"])])}}}),[["__scopeId","data-v-b668a9e3"]]);export{j as default};
