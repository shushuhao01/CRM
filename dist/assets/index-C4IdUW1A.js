const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/order-DOc9fodO.js","assets/vendor-BtukhyiH.js","assets/elementPlus-DxaqjplL.js","assets/utils-DfI7e5Rl.js","assets/Login-CTg6nU-C.js","assets/appInitService-CgPClnry.js","assets/product-DXlSdbN8.js","assets/env-DLalhsF6.js","assets/Login-DiVT1op5.css","assets/ChangePassword-DusGHIQT.js","assets/ChangePassword-CvYbrfOT.css","assets/Dashboard-wz3-eYei.js","assets/Dashboard-CSeufYFm.css","assets/List-DOLJnmri.js","assets/sensitiveInfo-CTSC2tj2.js","assets/export-D-SEmR7Z.js","assets/DynamicTable-DpwT2Ioj.js","assets/TableColumnSettings-NQCH9NUW.js","assets/TableColumnSettings-k3gC0NUe.css","assets/DynamicTable-ChsHgcYu.css","assets/List-Cx8YYhIN.css","assets/Add-nqMVPQzR.js","assets/customerTags-Dj1o1Lex.js","assets/addressData-BYEdhjmU.js","assets/Add-DCUfPTMi.css","assets/Edit-D4qL9RKY.js","assets/Edit-DWJPPDys.css","assets/Detail-IWGXEUUH.js","assets/service-BjC45aOM.js","assets/call-x2JnX9hE.js","assets/CreateTemplateDialog-CZTTpnIk.js","assets/CreateTemplateDialog-94i599mp.css","assets/Detail-DzDunxWE.css","assets/Tags-C2Pdma7Q.js","assets/Tags-BmsFCE5M.css","assets/Groups-UAKqHSTj.js","assets/Groups-_mzcVb3l.css","assets/List-KY7zd2J-.js","assets/List-6WYCaoOc.css","assets/Add-D8-Yi-cz.js","assets/orderFieldConfig-CmLjo1wL.js","assets/phone-DDyrO_Xv.js","assets/Add-DE_FAPvh.css","assets/Edit-DIIm8DQi.js","assets/Edit-GxBi_6u-.css","assets/Detail-DU0Q5iQ7.js","assets/Detail-DByu9Hhl.css","assets/Audit-DoS-ULEh.js","assets/Audit-BmdY3xFP.css","assets/Personal-CUGqGXZE.js","assets/Personal-DdjOCaX6.css","assets/Team-DtEC_5V4.js","assets/department-CMDKNhTn.js","assets/Team-BqQo9P_Q.css","assets/Analysis-4uteuhL8.js","assets/Analysis-BBNDQ8qX.css","assets/Share-BHDAPv4x.js","assets/Share-DGhsQmTk.css","assets/PerformanceShare-DeKGaAWV.js","assets/PerformanceShare-BmoAWFhj.css","assets/List-BSjQQHQ7.js","assets/List-DybN5TMA.css","assets/Detail-D-YLrf2D.js","assets/Detail-Cbsvl5vq.css","assets/Edit-CbRgJ3q7.js","assets/Edit-25l732_1.css","assets/Track-wn5kjJyF.js","assets/Track-BzMus7pX.css","assets/Companies-DrzBkRiJ.js","assets/Companies-DwPl_CAa.css","assets/TrackDetail-Bdu4KxdI.js","assets/TrackDetail-C2sVFKzP.css","assets/CompanyDetail-DCR-yoM-.js","assets/CompanyDetail-5tSxV_Bd.css","assets/Shipping-DTPcTODG.js","assets/OrderDetailDialog-Db643ssE.js","assets/OrderDetailDialog-DzBTXvFq.css","assets/Shipping-ShccfojN.css","assets/StatusUpdate-DPrvn2oi.js","assets/StatusUpdate-DO_WmtIO.css","assets/List-63c1Fwfq.js","assets/List-mxM-KkHF.css","assets/Add-CeLPmfBQ.js","assets/phoneSync-DnGy6hcf.js","assets/Add-CiSznWEP.css","assets/Detail-B-Snpzic.js","assets/Detail-DjucE-kr.css","assets/Edit-B0QCA1Rd.js","assets/Edit-DOfY-j73.css","assets/Data-B3uPXcjb.js","assets/Data-D5Q371ax.css","assets/List-D1ZDBCmm.js","assets/data-BOmuxtb8.js","assets/department-BD2tZLj3.js","assets/List-CsFF4B4j.css","assets/SearchNew-CP02nU1a.js","assets/SearchNew-cSuAxFSQ.css","assets/SearchDebug-DT-EsRUg.js","assets/SearchDebug-BllNvIO-.css","assets/Recycle-3GYdUylO.js","assets/Recycle-BgQr2SQt.css","assets/List-sI6x4UL8.js","assets/List-BRpGqnIY.css","assets/Add-CR_OagTI.js","assets/Edit-CELSlrJW.js","assets/Edit-huNENmBj.css","assets/Detail-DEi7Lrk2.js","assets/Detail-CV0lNuR5.css","assets/Category-Cd1-aiwG.js","assets/Category-DWcdVzwn.css","assets/Stock-B6V7f0fw.js","assets/Stock-D4WgErfv.css","assets/Analytics-BgWsBhjd.js","assets/Analytics-CajlLs00.css","assets/SmsManagement-C_A9yeSQ.js","assets/SmsManagement-D9Z9FZWZ.css","assets/CallManagement-BUMU9Sc7.js","assets/qr-connection-C28yXtL2.js","assets/alternative-connection-BVqgabiQ.js","assets/browser-BKsVyEpb.js","assets/CallManagement-C2wT498u.css","assets/Dashboard-hzex-mU9.js","assets/Dashboard-CpfDLUc1.css","assets/OutboundList-Cnsg-HuB.js","assets/OutboundList-CUkNMNXy.css","assets/CallRecords-5QWXxcp2.js","assets/CallRecords-gJEEcsyN.css","assets/FollowUpRecords-BpJa-TEU.js","assets/FollowUpRecords-D-N5ttl9.css","assets/RecordingManagement-DFn-V3si.js","assets/RecordingManagement-CJwZ7NzW.css","assets/PhoneConfig-DCYgyIpw.js","assets/PhoneConfig-CMyVCiRR.css","assets/Storage-Bl8jfKmI.js","assets/Storage-DEGsQP_b.css","assets/UserPermissions-Bn8y-_YB.js","assets/UserPermissions-CQ1Dm1GW.css","assets/User-DrbZ9Xwp.js","assets/userApiService-Cw6X63cB.js","assets/roleApiService-DnA6aaKV.js","assets/User-By39t1Pu.css","assets/Role-CwD-Hm3A.js","assets/userDataService-WmhE7J4W.js","assets/Role-DALRqiEP.css","assets/Departments-t035R3B4.js","assets/DepartmentDialog-D0ZC7SnL.js","assets/departmentPermissionService-DXn8dAdX.js","assets/DepartmentDialog-ArDgEvlF.css","assets/Departments-aB3_kbTy.css","assets/DepartmentDetail-imDpQjTP.js","assets/DepartmentDetail-DBMk5x5t.css","assets/DepartmentMembers-j-yb5xfV.js","assets/DepartmentMembers-BeynAeEa.css","assets/DepartmentRoles-o7f_iJW2.js","assets/DepartmentRoles-bR-lRtY8.css","assets/Settings-B_hk99pz.js","assets/aliyun-oss-sdk-DCJ43jeS.js","assets/style-BM3euvlk.js","assets/style-BHtaHxM4.css","assets/Settings-wpslDwwQ.css","assets/About-I-jDDWM3.js","assets/About-DRfDbyS1.css","assets/SmsTemplates-CXR9VyUE.js","assets/SmsTemplates-CyZipD4g.css","assets/SmsApproval-brh60lDY.js","assets/SmsApproval-DhmY7Aqt.css","assets/SmsSendRecords-BNHKVlDx.js","assets/SmsSendRecords-Hq0CBCtG.css","assets/SmsStatistics-B6FUFgjN.js","assets/SmsStatistics-CqBsBu94.css","assets/SmsConfig-DsVFnzdR.js","assets/SmsConfig-C4wBshWL.css","assets/PermissionManagement-ClcTGtGV.js","assets/PermissionManagement-1uqcL04Z.css","assets/SuperAdminPermissionPanel-Bt_ntX--.js","assets/SuperAdminPermissionPanel-fKXAh3F3.css","assets/CustomerServicePermissionManager-CvAiWxXB.js","assets/CustomerServicePermissionManager-Ck3-UnCK.css","assets/SensitiveInfoPermissionManager-BQ2-0_Ja.js","assets/SensitiveInfoPermissionManager-DFQZ8LB4.css","assets/PermissionManagementGuide-DxSEXD7V.js","assets/PermissionManagementGuide-UtauZ4xj.css","assets/CallTest-BHCXlsDk.js","assets/CallTest-BtCFu3hh.css","assets/MobileSDK-CnPnt9hZ.js","assets/MobileSDK-ClHMccz9.css","assets/MessageManagement-CEma2GBO.js","assets/MessageManagement-BCnr-BgB.css","assets/MobileSDKInstall-Do9fGkWi.js","assets/MobileSDKInstall-BfhAkanb.css","assets/HelpCenter-BZkz-eKN.js","assets/HelpCenter-6csOVxjI.css","assets/NotFound-C2fea354.js","assets/NotFound-CcfFlR5d.css"])))=>i.map(i=>d[i]);
import{aw as e,w as t,r as s,e as a,Z as r,ax as o,ay as n,l as i,ag as c,m as l,Q as d,q as u,J as m,p,az as g,M as h,T as v,I as y,O as f,S as _,aA as S,aB as w,H as A,U as I,u as P,a2 as E,P as T,aj as C,ad as D,b as k,F as b,a9 as R,R as O,Y as N,aC as M,aD as L,n as U,as as x,aE as $}from"./vendor-BtukhyiH.js";import{E as V,a as j,w as F,r as q,h as H,u as B,l as J,c as z,b as G,s as K,d as Y,f as W,e as Q,g as X,m as Z,i as ee,j as te,k as se,n as ae,v as re,t as oe,o as ne,p as ie,q as ce,x as le,y as de}from"./elementPlus-DxaqjplL.js";import{a as ue}from"./utils-DfI7e5Rl.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();
/*! Element Plus v2.3.14 */
var me={name:"zh-cn",el:{colorpicker:{confirm:"确定",clear:"清空"},datepicker:{now:"此刻",today:"今天",cancel:"取消",clear:"清空",confirm:"确定",selectDate:"选择日期",selectTime:"选择时间",startDate:"开始日期",startTime:"开始时间",endDate:"结束日期",endTime:"结束时间",prevYear:"前一年",nextYear:"后一年",prevMonth:"上个月",nextMonth:"下个月",year:"年",month1:"1 月",month2:"2 月",month3:"3 月",month4:"4 月",month5:"5 月",month6:"6 月",month7:"7 月",month8:"8 月",month9:"9 月",month10:"10 月",month11:"11 月",month12:"12 月",weeks:{sun:"日",mon:"一",tue:"二",wed:"三",thu:"四",fri:"五",sat:"六"},months:{jan:"一月",feb:"二月",mar:"三月",apr:"四月",may:"五月",jun:"六月",jul:"七月",aug:"八月",sep:"九月",oct:"十月",nov:"十一月",dec:"十二月"}},select:{loading:"加载中",noMatch:"无匹配数据",noData:"无数据",placeholder:"请选择"},cascader:{noMatch:"无匹配数据",loading:"加载中",placeholder:"请选择",noData:"暂无数据"},pagination:{goto:"前往",pagesize:"条/页",total:"共 {total} 条",pageClassifier:"页",page:"页",prev:"上一页",next:"下一页",currentPage:"第 {pager} 页",prevPages:"向前 {pager} 页",nextPages:"向后 {pager} 页",deprecationWarning:"你使用了一些已被废弃的用法，请参考 el-pagination 的官方文档"},messagebox:{title:"提示",confirm:"确定",cancel:"取消",error:"输入的数据不合法!"},upload:{deleteTip:"按 delete 键可删除",delete:"删除",preview:"查看图片",continue:"继续上传"},table:{emptyText:"暂无数据",confirmFilter:"筛选",resetFilter:"重置",clearFilter:"全部",sumText:"合计"},tree:{emptyText:"暂无数据"},transfer:{noMatch:"无匹配数据",noData:"无数据",titles:["列表 1","列表 2"],filterPlaceholder:"请输入搜索内容",noCheckedFormat:"共 {total} 项",hasCheckedFormat:"已选 {checked}/{total} 项"},image:{error:"加载失败"},pageHeader:{title:"返回"},popconfirm:{confirmButtonText:"确定",cancelButtonText:"取消"}}};const pe={},ge=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),s=e?.nonce||e?.getAttribute("nonce");a=Promise.allSettled(t.map(e=>{if((e=function(e){return"/"+e}(e))in pe)return;pe[e]=!0;const t=e.endsWith(".css"),a=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${a}`))return;const r=document.createElement("link");return r.rel=t?"stylesheet":"modulepreload",t||(r.as="script"),r.crossOrigin="",r.href=e,s&&r.setAttribute("nonce",s),document.head.appendChild(r),t?new Promise((t,s)=>{r.addEventListener("load",t),r.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})};var he=(e=>(e.SUPER_ADMIN="super_admin",e.DEPARTMENT_MANAGER="department_manager",e.SALES_STAFF="sales_staff",e.CUSTOMER_SERVICE="customer_service",e.WHITELIST_MEMBER="whitelist",e.REGULAR_USER="regular",e))(he||{}),ve=(e=>(e.FULL_ACCESS="full",e.PARTIAL_ACCESS="partial",e.RESTRICTED="restricted",e))(ve||{}),ye=(e=>(e.PHONE="phone",e.ID_CARD="id_card",e.EMAIL="email",e.WECHAT="wechat",e.ADDRESS="address",e.BANK_ACCOUNT="bank",e.FINANCIAL="financial",e))(ye||{}),fe=(e=>(e.MAKE_CALL="make_call",e.VIEW_RECORDS="view_records",e.PLAY_RECORDING="play_recording",e.DOWNLOAD_RECORDING="download_recording",e.EDIT_RECORDS="edit_records",e.DELETE_RECORDS="delete_records",e.MANAGE_CONFIG="manage_config",e.VIEW_STATISTICS="view_statistics",e))(fe||{}),_e=(e=>(e.ALL="all",e.DEPARTMENT="department",e.SELF="self",e.CUSTOM="custom",e))(_e||{}),Se=(e=>(e.AFTER_SALES="after_sales",e.AUDIT="audit",e.LOGISTICS="logistics",e.PRODUCT="product",e.GENERAL="general",e))(Se||{});const we=class e{static instance;userPermissions=new Map;static getInstance(){return e.instance||(e.instance=new e),e.instance}constructor(){this.initializeDefaultPermissions()}initializeDefaultPermissions(){this.userPermissions.set("admin",{userId:"admin",role:"super_admin",permissions:["full"],dataScope:"all",whitelistTypes:Object.values(ye),callPermissions:Object.values(fe)}),this.userPermissions.set("manager",{userId:"manager",role:"department_manager",permissions:["partial"],dataScope:"department",departmentId:"dept_001",departmentIds:["dept_001","dept_002"],whitelistTypes:["phone","email","wechat"],callPermissions:["make_call","view_records","play_recording","download_recording","edit_records","view_statistics"]}),this.userPermissions.set("sales001",{userId:"sales001",role:"sales_staff",permissions:["restricted"],dataScope:"self",departmentId:"dept_001",callPermissions:["make_call","view_records","play_recording"]}),this.userPermissions.set("service_aftersales",{userId:"service_aftersales",role:"customer_service",permissions:["partial"],dataScope:"custom",customerServiceType:"after_sales",customPermissions:["service:view","service:process","service:edit"],callPermissions:["make_call","view_records","play_recording","edit_records"]}),this.userPermissions.set("service_audit",{userId:"service_audit",role:"customer_service",permissions:["partial"],dataScope:"custom",customerServiceType:"audit",customPermissions:["order:audit:view","order:audit:approve","order:audit:reject"],callPermissions:["make_call","view_records","play_recording"]}),this.userPermissions.set("service_logistics",{userId:"service_logistics",role:"customer_service",permissions:["partial"],dataScope:"custom",customerServiceType:"logistics",customPermissions:["logistics:view","logistics:shipping:manage","logistics:tracking:update"],callPermissions:["make_call","view_records","play_recording"]}),this.userPermissions.set("service_product",{userId:"service_product",role:"customer_service",permissions:["partial"],dataScope:"custom",customerServiceType:"product",customPermissions:["product:view","product:edit","product:inventory:manage"],callPermissions:["make_call","view_records","play_recording"]}),this.userPermissions.set("service_general",{userId:"service_general",role:"customer_service",permissions:["partial"],dataScope:"custom",customerServiceType:"general",customPermissions:[],callPermissions:["make_call","view_records","play_recording"]})}getUserPermission(e){return this.userPermissions.get(e)||null}checkSensitiveInfoAccess(e,t){const s=this.getUserPermission(e);if(!s)return{hasAccess:!1,level:"restricted",reason:"用户权限信息不存在"};if(s.expiresAt&&s.expiresAt<new Date)return{hasAccess:!1,level:"restricted",reason:"用户权限已过期"};if("super_admin"===s.role)return{hasAccess:!0,level:"full"};if("whitelist"===s.role){const e=s.whitelistTypes?.includes(t)||!1;return{hasAccess:e,level:e?"partial":"restricted",reason:e?void 0:"该类型敏感信息不在白名单权限范围内"}}if("customer_service"===s.role){const e=s.whitelistTypes?.includes(t)||!1;return{hasAccess:e,level:e?"partial":"restricted",reason:e?void 0:"该类型敏感信息不在客服权限范围内"}}return{hasAccess:!1,level:"restricted",reason:"普通用户无权访问敏感信息"}}isSuperAdmin(e){const t=this.getUserPermission(e);return"super_admin"===t?.role}isWhitelistMember(e){const t=this.getUserPermission(e);return"whitelist"===t?.role}checkCallPermission(e,t){const s=this.getUserPermission(e);if(!s)return{hasAccess:!1,level:"restricted",reason:"用户权限信息不存在"};if("super_admin"===s.role)return{hasAccess:!0,level:"full"};const a=s.callPermissions?.includes(t)||!1;return{hasAccess:a,level:a?"partial":"restricted",reason:a?void 0:`缺少${t}权限`}}batchCheckCallPermissions(e,t){const s=new Map;for(const a of t)s.set(a,this.checkCallPermission(e,a));return s}setUserPermission(e){this.userPermissions.set(e.userId,e)}removeUserPermission(e){return this.userPermissions.delete(e)}getAllUserPermissions(e){return this.isSuperAdmin(e)?Array.from(this.userPermissions.values()):null}batchSetCustomerServicePermissions(e,t,s,a=[],r=[]){e.forEach(e=>{const o={userId:e,role:"customer_service",permissions:["partial"],dataScope:s,departmentId:r[0]||"",departmentIds:r,customerServiceType:t,customPermissions:a,callPermissions:["make_call","view_records","play_recording"]};this.setUserPermission(o)})}getCustomerServicesByType(e){const t=[];return this.userPermissions.forEach((s,a)=>{"customer_service"===s.role&&(e&&s.customerServiceType!==e||t.push({userId:a,permission:s}))}),t}checkCustomerServicePermission(e,t){const s=this.getUserPermission(e);if(!s||"customer_service"!==s.role)return!1;if(s.customPermissions&&s.customPermissions.length>0)return s.customPermissions.includes(t);switch(s.customerServiceType){case"after_sales":return this.checkAfterSalesPermission(t);case"audit":return this.checkAuditPermission(t);case"logistics":return this.checkLogisticsPermission(t);case"product":return this.checkProductPermission(t);default:return this.checkGeneralCustomerServicePermission(t)}}checkAfterSalesPermission(e){return["service:afterSales:view","service:afterSales:edit","order:list:view","customer:list:view"].includes(e)}checkAuditPermission(e){return["order:audit:view","order:audit:approve","order:list:view","customer:list:view"].includes(e)}checkLogisticsPermission(e){return["logistics:shipping:view","logistics:shipping:edit","logistics:shipping:batchExport","order:list:view"].includes(e)}checkProductPermission(e){return["product:list:view","product:list:edit","product:add:create","product:inventory:manage","order:list:view","customer:list:view"].includes(e)}checkGeneralCustomerServicePermission(e){return["customer:list:view","order:list:view","service:basic:view"].includes(e)}updateCustomerServicePermission(e,t,s,a=[],r=[]){const o=this.getUserPermission(e);if(!o||"customer_service"!==o.role)return!1;const n={...o,customerServiceType:t,dataScope:s,customPermissions:a,departmentIds:r,departmentId:r[0]||o.departmentId};return this.setUserPermission(n),!0}getCustomerServiceDataScope(e){const t=this.getUserPermission(e);return t&&"customer_service"===t.role?{canAccessAll:"all"===t.dataScope,canAccessDepartments:t.departmentIds||[],canAccessSelf:"self"===t.dataScope,customPermissions:t.customPermissions||[]}:{canAccessAll:!1,canAccessDepartments:[],canAccessSelf:!1,customPermissions:[]}}batchSetUserPermissions(e,t){if(!this.isSuperAdmin(e))return console.warn("Only super admin can batch set user permissions"),!1;try{return t.forEach(({userId:e,...t})=>{const s={userId:e,role:t.role,permissions:[this.getPermissionLevelByRole(t.role)],dataScope:t.dataScope,departmentId:t.departmentId,departmentIds:t.departmentIds,customerServiceType:t.customerServiceType,customPermissions:t.customPermissions||[]};this.setUserPermission(s)}),this.logPermissionAudit(e,"batch_assign","",`批量设置${t.length}个用户权限`),!0}catch(s){return console.error("Batch set user permissions error:",s),!1}}createRoleTemplate(e,t){if(!this.isSuperAdmin(e))return console.warn("Only super admin can create role templates"),!1;try{const s=`template_${Date.now()}`,a=this.getRoleTemplates();return a[s]={id:s,name:t.name,role:t.role,dataScope:t.dataScope,permissions:t.permissions,description:t.description||"",createdBy:e,createdAt:(new Date).toISOString()},localStorage.setItem("crm_role_templates",JSON.stringify(a)),this.logPermissionAudit(e,"create_template","",`创建角色模板: ${t.name}`),!0}catch(s){return console.error("Create role template error:",s),!1}}applyRoleTemplate(e,t,s){if(!this.isSuperAdmin(e))return console.warn("Only super admin can apply role templates"),!1;try{const a=this.getRoleTemplates()[t];return a?(s.forEach(e=>{const t={userId:e,role:a.role,permissions:[this.getPermissionLevelByRole(a.role)],dataScope:a.dataScope,customPermissions:a.permissions};this.setUserPermission(t)}),this.logPermissionAudit(e,"apply_template","",`应用模板 ${a.name} 到 ${s.length} 个用户`),!0):(console.warn("Role template not found:",t),!1)}catch(a){return console.error("Apply role template error:",a),!1}}getPermissionAuditLogs(e,t){if(!this.isSuperAdmin(e))return console.warn("Only super admin can get audit logs"),[];try{const e=JSON.parse(localStorage.getItem("crm_permission_audit_logs")||"[]");return t?e.filter(e=>!(t.startDate&&e.timestamp<t.startDate)&&(!(t.endDate&&e.timestamp>t.endDate)&&((!t.action||e.action===t.action)&&(!(t.targetUser&&!e.targetUser.includes(t.targetUser))&&!(t.operator&&!e.operator.includes(t.operator)))))):e}catch(s){return console.error("Get audit logs error:",s),[]}}exportPermissionConfig(e){if(!this.isSuperAdmin(e))return console.warn("Only super admin can export permission config"),null;try{const t={users:this.getAllUserPermissions(e),templates:this.getRoleTemplates(),auditLogs:this.getPermissionAuditLogs(e),exportedAt:(new Date).toISOString(),exportedBy:e};return this.logPermissionAudit(e,"export_config","","导出权限配置"),t}catch(t){return console.error("Export permission config error:",t),null}}importPermissionConfig(e,t,s){if(!this.isSuperAdmin(e))return console.warn("Only super admin can import permission config"),!1;try{const{overwriteExisting:a=!1,importUsers:r=!0,importTemplates:o=!0}=s||{};if(r&&t.users&&t.users.forEach(e=>{!a&&this.getUserPermission(e.userId)||this.setUserPermission(e)}),o&&t.templates){const e=this.getRoleTemplates(),s=a?{...e,...t.templates}:{...t.templates,...e};localStorage.setItem("crm_role_templates",JSON.stringify(s))}return this.logPermissionAudit(e,"import_config","","导入权限配置"),!0}catch(a){return console.error("Import permission config error:",a),!1}}getPermissionLevelByRole(e){switch(e){case"super_admin":return"full";case"department_manager":case"sales_staff":case"customer_service":case"whitelist":return"partial";default:return"restricted"}}getRoleTemplates(){try{return JSON.parse(localStorage.getItem("crm_role_templates")||"{}")}catch(e){return console.error("Get role templates error:",e),{}}}logPermissionAudit(e,t,s,a){try{const r=JSON.parse(localStorage.getItem("crm_permission_audit_logs")||"[]");r.push({id:`audit_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:(new Date).toISOString(),operator:e,action:t,targetUser:s,description:a,ipAddress:"127.0.0.1"}),r.length>1e3&&r.splice(0,r.length-1e3),localStorage.setItem("crm_permission_audit_logs",JSON.stringify(r))}catch(r){console.error("Log permission audit error:",r)}}batchCheckAccess(e,t){const s=new Map;for(const a of t)s.set(a,this.checkSensitiveInfoAccess(e,a));return s}checkDataAccess(e,t,s){const a=this.getUserPermission(e);if(!a)return{hasAccess:!1,level:"restricted",reason:"用户权限信息不存在"};if("all"===a.dataScope)return{hasAccess:!0,level:"full"};if(t===e)return{hasAccess:!0,level:"partial",reason:"访问个人数据"};if(t){const s=this.getUserManagedDepartments(e);if(s.length>0){const e=this.getUserDepartment(t);if(e)for(const t of s){if(this.getSubDepartmentIds(t).includes(e))return{hasAccess:!0,level:"partial",reason:"部门负责人权限：可查看部门成员数据"}}}}if("department"===a.dataScope){if(!s)return{hasAccess:!1,level:"restricted",reason:"数据缺少部门信息"};const e=a.departmentId===s||a.departmentIds?.includes(s)||!1;return{hasAccess:e,level:e?"partial":"restricted",reason:e?void 0:"无权访问其他部门的数据"}}if("self"===a.dataScope){if(!t)return{hasAccess:!1,level:"restricted",reason:"数据缺少创建者信息"};const s=e===t;return{hasAccess:s,level:s?"partial":"restricted",reason:s?void 0:"只能访问自己创建的数据"}}return"custom"===a.dataScope?a.customerServiceType?this.checkCustomerServiceAccess(a.customerServiceType):{hasAccess:!1,level:"restricted",reason:"自定义权限范围未配置"}:{hasAccess:!1,level:"restricted",reason:"未知的数据范围类型"}}getUserDepartment(e){const t=this.getUserPermission(e);return t?.departmentId||null}checkCustomerServiceAccess(e){switch(e){case"after_sales":return{hasAccess:!0,level:"partial",reason:"售后客服权限：可查看和处理所有售后订单"};case"audit":return{hasAccess:!0,level:"partial",reason:"审核客服权限：可查看和处理所有审核订单"};case"logistics":return{hasAccess:!0,level:"partial",reason:"物流客服权限：可查看和处理所有物流订单"};case"product":return{hasAccess:!0,level:"partial",reason:"商品客服权限：可查看和处理所有商品列表"};case"general":return{hasAccess:!0,level:"partial",reason:"通用客服权限：由超级管理员配置"};default:return{hasAccess:!1,level:"restricted",reason:"未知的客服类型"}}}isDepartmentManager(e){const t=this.getUserPermission(e);return"department_manager"===t?.role}isDepartmentManagerOf(e,t){const s=this.getDepartmentStore();if(!s)return!1;if(t){const a=s.getDepartmentById(t);return a?.managerId===e}return s.departments.some(t=>t.managerId===e)}canAccessDepartmentData(e,t){const s=this.getUserPermission(e);if(!s)return!1;if("super_admin"===s.role)return!0;if(this.isDepartmentManagerOf(e,t))return!0;const a=this.getUserManagedDepartments(e);for(const r of a){if(this.getSubDepartmentIds(r).includes(t))return!0}if("department_manager"===s.role&&s.departmentId){return this.getSubDepartmentIds(s.departmentId).includes(t)}return s.departmentId===t}getUserManagedDepartments(e){const t=this.getDepartmentStore();if(!t)return[];return t.departments.filter(t=>t.managerId===e).map(e=>e.id)}getDepartmentStore(){try{const{useDepartmentStore:e}=require("@/stores/department");return e()}catch(e){return console.warn("[Permission] 无法获取部门存储:",e),null}}getSubDepartmentIds(e){const t=this.getDepartmentStore();if(!t)return[e];const s=t.departments,a=[e],r=e=>{s.filter(t=>t.parentId===e).forEach(e=>{a.push(e.id),r(e.id)})};return r(e),a}getUserDataScope(e){const t=this.getUserPermission(e);if(!t)return{scope:"self",departmentIds:[],description:"仅限个人数据"};if("super_admin"===t.role)return{scope:"all",departmentIds:[],description:"全部数据"};const s=this.getUserManagedDepartments(e);if(s.length>0){const e=s.reduce((e,t)=>(e.push(t),e.push(...this.getSubDepartmentIds(t)),e),[]);return{scope:"department",departmentIds:[...new Set(e)],description:`管理部门及子部门数据 (${e.length}个部门)`}}if("department_manager"===t.role&&t.departmentId){const e=this.getSubDepartmentIds(t.departmentId);return{scope:"department",departmentIds:e,description:`本部门及子部门数据 (${e.length}个部门)`}}return{scope:"self",departmentIds:t.departmentId?[t.departmentId]:[],description:"仅限个人数据"}}isSalesStaff(e){const t=this.getUserPermission(e);return"sales_staff"===t?.role}isCustomerService(e){const t=this.getUserPermission(e);return"customer_service"===t?.role}getAccessibleDepartments(e){const t=this.getUserPermission(e);if(!t)return[];if("all"===t.dataScope)return["*"];if("department"===t.dataScope){const e=[];return t.departmentId&&e.push(t.departmentId),t.departmentIds&&e.push(...t.departmentIds),e}return[]}logAccess(e,t,s,a){const r={timestamp:(new Date).toISOString(),userId:e,infoType:t,action:s,result:a,userAgent:navigator.userAgent};console.log("权限访问日志:",r)}}.getInstance();class Ae{static instance;axiosInstance;baseURL;constructor(e="/api/v1"){this.baseURL=e,this.axiosInstance=ue.create({baseURL:e,timeout:3e4,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}static getInstance(e){return Ae.instance||(Ae.instance=new Ae(e)),Ae.instance}setupInterceptors(){this.axiosInstance.interceptors.request.use(e=>{const t=this.getAuthToken();return t&&(e.headers.Authorization=`Bearer ${t}`),e.headers["X-Request-ID"]=this.generateRequestId(),console.log(`[API] ${e.method?.toUpperCase()} ${e.url}`,{params:e.params,data:e.data}),e},e=>(console.error("[API] 请求错误:",e),Promise.reject(e))),this.axiosInstance.interceptors.response.use(e=>{const{data:t}=e;if(console.log("[API] 响应成功:",{url:e.config.url,status:e.status,data:t}),!t.success){const e=t.message||"请求失败";return V.error(e),Promise.reject(new Error(e))}return e},e=>{console.error("[API] 响应错误:",e);const t=e.config?.metadata?.isHealthCheck,s=e.config?.metadata?.isTokenValidation;if(t||s)s&&401===e.response?.status&&console.log("[API] ⚠️ Token验证失败，已忽略（保持登录状态）");else if(e.response){const{status:t,data:s}=e.response;switch(t){case 401:console.log("[API] ⚠️ 收到401错误，已忽略（保持登录状态）");break;case 403:V.error("没有权限访问该资源");break;case 404:V.error("请求的资源不存在");break;case 422:V.error(s.message||"请求参数验证失败");break;case 429:throw V.error("请求过于频繁，请稍后再试"),new Error("RATE_LIMITED");case 500:V.error("服务器内部错误");break;default:V.error(s.message||`请求失败 (${t})`)}}else e.request?V.error("网络连接失败，请检查网络设置"):V.error("请求配置错误");return Promise.reject(e)})}getAuthToken(){return localStorage.getItem("auth_token")}async handleUnauthorized(e=!0){console.log("[API] 收到401错误，尝试刷新token");if(localStorage.getItem("refresh_token"))try{const{authApiService:e}=await ge(async()=>{const{authApiService:e}=await Promise.resolve().then(()=>it);return{authApiService:e}},void 0);return await e.refreshToken(),void console.log("[API] Token刷新成功，继续请求")}catch(s){console.error("[API] Token刷新失败:",s)}const{shouldUseMockApi:t}=await ge(async()=>{const{shouldUseMockApi:e}=await Promise.resolve().then(()=>rt);return{shouldUseMockApi:e}},void 0);t()?console.log("[API] Mock API模式下，忽略401错误，保持登录状态"):(console.log("[API] 清除认证信息"),localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),localStorage.removeItem("user_info"),localStorage.removeItem("userPermissions"),localStorage.removeItem("token_expiry"),e&&V.error("登录已过期，请重新登录"),console.log("[API] Token已清除，等待路由守卫处理导航"))}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async get(e,t,s){return(await this.axiosInstance.get(e,{params:t,...s})).data.data}async post(e,t,s){return(await this.axiosInstance.post(e,t,s)).data.data}async put(e,t,s){return(await this.axiosInstance.put(e,t,s)).data.data}async delete(e,t){return(await this.axiosInstance.delete(e,t)).data.data}async patch(e,t,s){return(await this.axiosInstance.patch(e,t,s)).data.data}async paginate(e,t={},s){const a={page:t.page||1,limit:t.limit||20,search:t.search||"",sortBy:t.sortBy||"id",sortOrder:t.sortOrder||"desc",...t};return this.get(e,a,s)}async upload(e,t,s){const a=new FormData;a.append("file",t);const r={headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{if(s&&e.total){const t=Math.round(100*e.loaded/e.total);s(t)}}};return this.post(e,a,r)}async batch(e,t){return this.post(e,{operations:t})}async download(e,t,s){return(await this.axiosInstance.get(e,{...s,params:t,responseType:"blob"})).data}async healthCheck(){try{return await this.get("/health",void 0,{metadata:{isHealthCheck:!0}}),!0}catch(e){return console.error("[API] 健康检查失败:",e),!1}}setAuthToken(e){localStorage.setItem("auth_token",e)}clearAuthToken(){localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token")}getBaseURL(){return this.baseURL}updateBaseURL(e){this.baseURL=e,this.axiosInstance.defaults.baseURL=e}}const Ie=Ae.getInstance(),Pe=Object.freeze(Object.defineProperty({__proto__:null,ApiService:Ae,apiService:Ie},Symbol.toStringTag,{value:"Module"}));class Ee{static instance;storageKey="crm_customers_unified";static getInstance(){return Ee.instance||(Ee.instance=new Ee),Ee.instance}constructor(){console.log("CustomerStorageService 初始化，存储键:",this.storageKey)}getAllCustomers(){try{const e=localStorage.getItem(this.storageKey);if(!e)return console.log("没有找到存储的客户数据，返回空数组"),[];const t=JSON.parse(e);return t&&Array.isArray(t.customers)?(console.log(`从存储中读取到 ${t.customers.length} 个客户`),t.customers):(console.warn("存储的数据结构不正确，清除并返回空数组"),localStorage.removeItem(this.storageKey),[])}catch(e){return console.error("读取客户数据失败:",e),localStorage.removeItem(this.storageKey),[]}}saveAllCustomers(e){try{const t={customers:e,lastUpdated:Date.now(),version:"1.0.0"};localStorage.setItem(this.storageKey,JSON.stringify(t)),console.log(`成功保存 ${e.length} 个客户到存储`)}catch(t){throw console.error("保存客户数据失败:",t),new Error("保存客户数据失败")}}addCustomer(e){try{const t=this.getAllCustomers();if(-1!==t.findIndex(t=>t.phone===e.phone))throw new Error(`手机号 ${e.phone} 已存在`);return t.unshift(e),this.saveAllCustomers(t),console.log(`成功添加客户: ${e.name} (${e.phone})`),e}catch(t){throw console.error("添加客户失败:",t),t}}updateCustomer(e,t){try{const s=this.getAllCustomers(),a=s.findIndex(t=>t.id===e);if(-1===a)throw new Error(`客户 ${e} 不存在`);return s[a]={...s[a],...t},this.saveAllCustomers(s),console.log(`成功更新客户: ${s[a].name} (${s[a].phone})`),s[a]}catch(s){throw console.error("更新客户失败:",s),s}}deleteCustomer(e){try{const t=this.getAllCustomers(),s=t.findIndex(t=>t.id===e);if(-1===s)throw new Error(`客户 ${e} 不存在`);const a=t[s];return t.splice(s,1),this.saveAllCustomers(t),console.log(`成功删除客户: ${a.name} (${a.phone})`),!0}catch(t){throw console.error("删除客户失败:",t),t}}getCustomerById(e){try{const t=this.getAllCustomers();return t.find(t=>t.id===e)||null}catch(t){return console.error("获取客户失败:",t),null}}getCustomerByPhone(e){try{const t=this.getAllCustomers();return t.find(t=>t.phone===e)||null}catch(t){return console.error("根据手机号获取客户失败:",t),null}}checkPhoneExists(e){try{return null!==this.getCustomerByPhone(e)}catch(t){return console.error("检查手机号失败:",t),!1}}clearAllCustomers(){try{localStorage.removeItem(this.storageKey),console.log("已清空所有客户数据")}catch(e){throw console.error("清空客户数据失败:",e),e}}getStorageStats(){try{const e=localStorage.getItem(this.storageKey);if(!e)return{totalCustomers:0,storageSize:0,lastUpdated:null,version:null};const t=JSON.parse(e);return{totalCustomers:t.customers.length,storageSize:e.length,lastUpdated:t.lastUpdated,version:t.version}}catch(e){return console.error("获取存储统计失败:",e),{totalCustomers:0,storageSize:0,lastUpdated:null,version:null}}}forceMigrateFromOldStorage(){try{console.log("开始强制数据迁移...");const t=this.getAllCustomers();console.log(`当前已有 ${t.length} 个客户`);const s=["crm_store_customer","crm_customers","customers","customer_data","mock_customers"];let a=[];for(const r of s){const t=localStorage.getItem(r);if(t)try{const e=JSON.parse(t);let s=[];if(e.data&&e.data.customers?s=e.data.customers:e.customers?s=e.customers:Array.isArray(e)&&(s=e),s.length>0){a=s,console.log(`从 ${r} 找到了 ${s.length} 个客户`);break}}catch(e){console.warn(`解析旧数据 ${r} 失败:`,e)}}if(a.length>0){const e=new Set(t.map(e=>e.phone)),r=a.filter(t=>!e.has(t.phone));if(r.length>0){const e=[...t,...r];this.saveAllCustomers(e),console.log(`数据迁移完成，合并了 ${r.length} 个旧客户，总计 ${e.length} 个客户`),s.forEach(e=>{localStorage.getItem(e)&&(localStorage.removeItem(e),console.log(`已清理旧存储键: ${e}`))})}else console.log("旧数据中没有新的客户需要迁移")}else console.log("没有找到可迁移的旧数据");return!0}catch(e){return console.error("强制数据迁移失败:",e),!1}}migrateFromOldStorage(){try{console.log("开始数据迁移...");if(localStorage.getItem(this.storageKey))return console.log("新格式数据已存在，跳过迁移"),!0;const t=["crm_store_customer","crm_customers","customers","customer_data","mock_customers"];let s=[];for(const a of t){const t=localStorage.getItem(a);if(t)try{const e=JSON.parse(t);let r=[];if(e.data&&e.data.customers?r=e.data.customers:e.customers?r=e.customers:Array.isArray(e)&&(r=e),r.length>0){s=r,console.log(`从 ${a} 迁移了 ${r.length} 个客户`);break}}catch(e){console.warn(`解析旧数据 ${a} 失败:`,e)}}return s.length>0?(this.saveAllCustomers(s),console.log(`数据迁移完成，共迁移 ${s.length} 个客户`),t.forEach(e=>{localStorage.getItem(e)&&(localStorage.removeItem(e),console.log(`已清理旧存储键: ${e}`))}),!0):(console.log("没有找到可迁移的旧数据"),!1)}catch(e){return console.error("数据迁移失败:",e),!1}}}const Te=Ee.getInstance();"undefined"!=typeof window&&Te.migrateFromOldStorage();const Ce="crm_store_orders",De=[{id:"1",code:"XH202401151030",name:"张三",phone:"13800138001",age:28,address:"北京市朝阳区建国门外大街1号",level:"gold",status:"active",salesPersonId:"sales1",orderCount:5,createTime:"2024-01-15 10:30:00",createdBy:"admin",wechatId:"zhangsan_wx",email:"zhangsan@example.com",company:"北京科技有限公司",position:"技术总监",source:"网络推广",tags:["VIP","技术"],remarks:"重要客户，技术需求较高"},{id:"2",code:"LM202401201420",name:"李四",phone:"13900139002",age:35,address:"上海市浦东新区陆家嘴环路1000号",level:"silver",status:"active",salesPersonId:"sales2",orderCount:3,createTime:"2024-01-20 14:20:00",createdBy:"sales1",wechatId:"lisi_wx",email:"lisi@example.com",company:"上海贸易公司",position:"采购经理",source:"朋友介绍",tags:["稳定"],remarks:"采购量稳定，付款及时"},{id:"3",code:"WF202402010915",name:"王五",phone:"13700137003",age:42,address:"广州市天河区珠江新城花城大道1号",level:"normal",status:"inactive",salesPersonId:"sales1",orderCount:1,createTime:"2024-02-01 09:15:00",createdBy:"sales2",email:"wangwu@example.com",company:"广州制造有限公司",position:"生产经理",source:"展会",tags:["制造业"],remarks:"最近联系较少，需要跟进"},{id:"4",code:"ZL202402101645",name:"赵六",phone:"13600136004",age:29,address:"深圳市南山区科技园南区深南大道1号",level:"gold",status:"potential",salesPersonId:"sales3",orderCount:0,createTime:"2024-02-10 16:45:00",createdBy:"sales3",email:"zhaoliu@example.com",company:"深圳创新科技",position:"CTO",source:"线上咨询",tags:["科技","潜在"],remarks:"有合作意向，正在评估中"},{id:"5",code:"SQ202312151530",name:"孙七",phone:"13500135005",age:38,address:"杭州市西湖区文三路1号",level:"silver",status:"lost",salesPersonId:"sales2",orderCount:2,createTime:"2023-12-15 11:30:00",createdBy:"sales1",email:"sunqi@example.com",company:"杭州电商公司",position:"运营总监",source:"老客户介绍",tags:["电商"],remarks:"因价格问题流失，已转向竞争对手"}],ke=()=>{try{const e=Te.getAllCustomers();return 0===e.length?(console.log("Mock API: 没有客户数据，初始化默认数据"),Te.saveAllCustomers([...De]),[...De]):(console.log(`Mock API: 通过统一存储服务读取到 ${e.length} 个客户`),e)}catch(e){return console.warn("Mock API: 读取客户数据失败:",e),console.log("Mock API: 使用初始数据，共",De.length,"个客户"),[...De]}},be=e=>{try{Te.saveAllCustomers(e),console.log(`Mock API: 通过统一存储服务保存了 ${e.length} 个客户`)}catch(t){console.warn("Mock API: 保存客户数据失败:",t)}},Re=[{id:"1",orderNumber:"ORD202401001",customerId:"1",customerName:"张三",customerPhone:"13800138001",products:[{id:"1",name:"产品A",price:1e3,quantity:2}],totalAmount:2e3,status:"pending_shipment",paymentStatus:"unpaid",paymentMethod:"alipay",shippingAddress:"北京市朝阳区建国门外大街1号",createTime:"2024-01-15 10:30:00",updateTime:"2024-01-15 10:30:00",createdBy:"admin",cancelStatus:null,cancelReason:null,cancelDescription:null,cancelRequestTime:null,auditStatus:null,auditRemark:null,auditTime:null,auditorId:null},{id:"2",orderNumber:"ORD202401002",customerId:"2",customerName:"李四",customerPhone:"13900139002",products:[{id:"2",name:"产品B",price:1500,quantity:1}],totalAmount:1500,status:"pending_cancel",paymentStatus:"paid",paymentMethod:"wechat",shippingAddress:"上海市浦东新区陆家嘴环路1000号",createTime:"2024-01-16 14:20:00",updateTime:"2024-01-17 09:15:00",createdBy:"sales1",cancelStatus:"pending",cancelReason:"customer_cancel",cancelDescription:"客户临时改变主意，不需要此产品",cancelRequestTime:"2024-01-17 09:15:00",auditStatus:null,auditRemark:null,auditTime:null,auditorId:null,auditHistory:[{action:"request",time:"2024-01-17 09:15:00",auditor:"销售员-李明",remark:"客户临时改变主意，不需要此产品"}]},{id:"3",orderNumber:"ORD202401003",customerId:"3",customerName:"王五",customerPhone:"13700137003",products:[{id:"3",name:"产品C",price:800,quantity:3}],totalAmount:2400,status:"shipped",paymentStatus:"paid",paymentMethod:"bank",shippingAddress:"广州市天河区珠江新城花城大道1号",createTime:"2024-01-14 09:15:00",updateTime:"2024-01-18 16:30:00",createdBy:"sales2",cancelStatus:null,cancelReason:null,cancelDescription:null,cancelRequestTime:null,auditStatus:null,auditRemark:null,auditTime:null,auditorId:null},{id:"5",orderNumber:"ORD202401005",customerId:"5",customerName:"孙七",customerPhone:"13500135005",products:[{id:"5",name:"产品E",price:2e3,quantity:2}],totalAmount:4e3,status:"pending_cancel",paymentStatus:"paid",paymentMethod:"bank",shippingAddress:"杭州市西湖区文三路1号",createTime:"2024-01-18 11:30:00",updateTime:"2024-01-19 14:20:00",createdBy:"sales2",cancelStatus:"pending",cancelReason:"out_of_stock",cancelDescription:"商品库存不足，无法按时发货，客户要求取消订单",cancelRequestTime:"2024-01-19 14:20:00",auditStatus:null,auditRemark:null,auditTime:null,auditorId:null,auditHistory:[{action:"request",time:"2024-01-19 14:20:00",auditor:"销售员-刘强",remark:"商品库存不足，无法按时发货，客户要求取消订单"}]},{id:"4",orderNumber:"ORD202401004",customerId:"4",customerName:"赵六",customerPhone:"13600136004",products:[{id:"4",name:"产品D",price:1200,quantity:1}],totalAmount:1200,status:"cancelled",paymentStatus:"refunded",paymentMethod:"alipay",shippingAddress:"深圳市南山区科技园南区深南大道1号",createTime:"2024-01-15 16:45:00",updateTime:"2024-01-16 10:30:00",createdBy:"sales3",cancelStatus:"approved",cancelReason:"quality_issue",cancelDescription:"产品质量问题，客户要求退款",cancelRequestTime:"2024-01-16 08:20:00",auditStatus:"approved",auditRemark:"同意取消，质量问题属实",auditTime:"2024-01-16 10:30:00",auditorId:"admin",auditHistory:[{action:"request",time:"2024-01-16 08:20:00",auditor:"销售员-张华",remark:"产品质量问题，客户要求退款"},{action:"approved",time:"2024-01-16 10:30:00",auditor:"管理员-王总",remark:"同意取消，质量问题属实"}]}],Oe=()=>{try{const e=localStorage.getItem(Ce);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load orders from localStorage:",e)}return[...Re]},Ne=e=>{try{localStorage.setItem(Ce,JSON.stringify(e))}catch(t){console.warn("Failed to save orders to localStorage:",t)}},Me="crm_mock_sms_templates",Le="crm_mock_sms_approvals",Ue="crm_mock_sms_sends",xe="crm_mock_categories",$e="crm_mock_departments",Ve="erp_users_list",je=[{id:1,name:"客户回访模板",content:"尊敬的{customerName}，感谢您对我们产品的支持，我们将为您提供更好的服务。如有任何问题，请联系我们：{phone}",type:"service",variables:["customerName","phone"],status:"active",createTime:"2024-01-10 09:00:00",updateTime:"2024-01-10 09:00:00",creator:"张三",usage:156},{id:2,name:"促销活动模板",content:"【{companyName}】新年大促销！全场商品{discount}折起，活动时间：{startDate}至{endDate}，详情咨询客服。",type:"marketing",variables:["companyName","discount","startDate","endDate"],status:"active",createTime:"2024-01-12 14:30:00",updateTime:"2024-01-15 10:20:00",creator:"李四",usage:89},{id:3,name:"验证码模板",content:"您的验证码是：{code}，请在{minutes}分钟内使用，请勿泄露给他人。",type:"verification",variables:["code","minutes"],status:"active",createTime:"2024-01-08 16:45:00",updateTime:"2024-01-08 16:45:00",creator:"王五",usage:1234},{id:4,name:"订单确认通知",content:"【{companyName}】您的订单{orderNo}已确认，商品：{productName}，金额：{amount}元，预计{deliveryDate}发货。",type:"notification",variables:["companyName","orderNo","productName","amount","deliveryDate"],status:"active",createTime:"2024-01-05 10:30:00",updateTime:"2024-01-05 10:30:00",creator:"系统管理员",usage:892},{id:5,name:"发货通知模板",content:"【{companyName}】您的订单{orderNo}已发货，快递单号：{trackingNo}，请注意查收。物流查询：{trackingUrl}",type:"notification",variables:["companyName","orderNo","trackingNo","trackingUrl"],status:"active",createTime:"2024-01-06 14:20:00",updateTime:"2024-01-06 14:20:00",creator:"系统管理员",usage:756},{id:6,name:"付款提醒模板",content:"尊敬的{customerName}，您的订单{orderNo}待付款，金额{amount}元，请及时完成支付。如有疑问请联系客服。",type:"notification",variables:["customerName","orderNo","amount"],status:"active",createTime:"2024-01-07 09:15:00",updateTime:"2024-01-07 09:15:00",creator:"系统管理员",usage:423},{id:7,name:"会议通知模板",content:"【会议通知】{meetingTitle}将于{meetingDate} {meetingTime}在{location}举行，请准时参加。联系人：{contact}",type:"notification",variables:["meetingTitle","meetingDate","meetingTime","location","contact"],status:"active",createTime:"2024-01-09 11:45:00",updateTime:"2024-01-09 11:45:00",creator:"人事部",usage:234},{id:8,name:"生日祝福模板",content:"亲爱的{customerName}，今天是您的生日，{companyName}全体员工祝您生日快乐！特为您准备了生日礼品，请到店领取。",type:"marketing",variables:["customerName","companyName"],status:"active",createTime:"2024-01-11 16:30:00",updateTime:"2024-01-11 16:30:00",creator:"市场部",usage:67},{id:9,name:"服务预约确认",content:"【{companyName}】您预约的{serviceName}服务已确认，时间：{appointmentDate} {appointmentTime}，地址：{address}，联系电话：{phone}",type:"service",variables:["companyName","serviceName","appointmentDate","appointmentTime","address","phone"],status:"active",createTime:"2024-01-13 13:20:00",updateTime:"2024-01-13 13:20:00",creator:"客服部",usage:345},{id:10,name:"账户余额提醒",content:"【{companyName}】您的账户余额为{balance}元，余额不足可能影响服务使用，请及时充值。充值热线：{phone}",type:"notification",variables:["companyName","balance","phone"],status:"active",createTime:"2024-01-14 08:45:00",updateTime:"2024-01-14 08:45:00",creator:"财务部",usage:178},{id:11,name:"密码重置通知",content:"【{companyName}】您的账户密码已重置，新密码：{newPassword}，请及时登录修改。如非本人操作，请联系客服：{phone}",type:"notification",variables:["companyName","newPassword","phone"],status:"active",createTime:"2024-01-15 12:10:00",updateTime:"2024-01-15 12:10:00",creator:"技术部",usage:89},{id:12,name:"活动邀请模板",content:"【{companyName}】诚邀您参加{eventName}，时间：{eventDate}，地点：{venue}。精彩活动，丰厚奖品等您来！报名电话：{phone}",type:"marketing",variables:["companyName","eventName","eventDate","venue","phone"],status:"active",createTime:"2024-01-16 15:30:00",updateTime:"2024-01-16 15:30:00",creator:"市场部",usage:123}],Fe=[{id:1,applicant:"张三",department:"销售部",templateId:1,templateName:"客户回访模板",recipientCount:50,content:"尊敬的客户，感谢您对我们产品的支持，我们将为您提供更好的服务。如有任何问题，请联系我们：400-123-4567",reason:"月度客户回访活动",status:"pending",applyTime:"2024-01-15 10:30:00",recipients:["13800138001","13800138002","13800138003"]},{id:2,applicant:"李四",department:"市场部",templateId:2,templateName:"促销活动模板",recipientCount:200,content:"【科技公司】新年大促销！全场商品8折起，活动时间：1月20日至1月31日，详情咨询客服。",reason:"新年促销活动推广",status:"approved",applyTime:"2024-01-14 14:20:00",approveTime:"2024-01-14 16:45:00",approver:"王经理",approveRemark:"活动内容合规，批准发送",recipients:["13800138004","13800138005"]}],qe=[{id:1,templateId:2,templateName:"促销活动模板",content:"【科技公司】新年大促销！全场商品8折起，活动时间：1月20日至1月31日，详情咨询客服。",recipients:["13800138004","13800138005","13800138006"],successCount:3,failCount:0,status:"success",sendTime:"2024-01-14 17:00:00",operator:"李四",cost:.15}],He=()=>{try{const e=localStorage.getItem(Me);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load SMS templates from localStorage:",e)}return[...je]},Be=e=>{try{localStorage.setItem(Me,JSON.stringify(e))}catch(t){console.warn("Failed to save SMS templates to localStorage:",t)}},Je=()=>{try{const e=localStorage.getItem(Le);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load SMS approvals from localStorage:",e)}return[...Fe]},ze=e=>{try{localStorage.setItem(Le,JSON.stringify(e))}catch(t){console.warn("Failed to save SMS approvals to localStorage:",t)}},Ge=()=>{try{const e=localStorage.getItem(Ue);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load SMS sends from localStorage:",e)}return[...qe]},Ke=()=>{try{const e=localStorage.getItem(xe);return e?JSON.parse(e):[]}catch(e){return console.error("读取分类数据失败:",e),[]}},Ye=e=>{try{localStorage.setItem(xe,JSON.stringify(e))}catch(t){console.error("保存分类数据失败:",t)}},We=()=>{try{const e=localStorage.getItem($e);if(e){const t=JSON.parse(e);return console.log("[Mock API] 从存储读取到部门数据:",t.length,"个部门"),t}}catch(e){console.error("读取部门数据失败:",e)}return console.log("[Mock API] 初始化空的部门数据"),[]},Qe=e=>{try{localStorage.setItem($e,JSON.stringify(e))}catch(t){console.error("保存部门数据失败:",t)}},Xe=()=>{try{const e=localStorage.getItem(Ve);if(e){const t=JSON.parse(e);return console.log("[Mock API] 从存储读取到用户数据:",t.length,"个用户"),t}}catch(e){console.error("读取用户数据失败:",e)}return console.log("[Mock API] 初始化空的用户数据"),[]},Ze=e=>{try{localStorage.setItem(Ve,JSON.stringify(e)),console.log("[Mock API] 已保存用户数据:",e.length,"个用户")}catch(t){console.error("保存用户数据失败:",t)}};let et=ke();const tt=(e=500)=>new Promise(t=>setTimeout(t,e)),st={getUserById:e=>[{id:"admin",username:"admin",realName:"系统管理员",email:"admin@example.com",phone:"13800138000",roleId:"admin",status:"active"},{id:"manager",username:"manager",realName:"部门经理",email:"manager@example.com",phone:"13800138001",roleId:"manager",status:"active"},{id:"sales1",username:"sales1",realName:"张销售",email:"sales1@example.com",phone:"13800138002",roleId:"employee",status:"active"},{id:"sales2",username:"sales2",realName:"李销售",email:"sales2@example.com",phone:"13800138003",roleId:"employee",status:"active"},{id:"sales3",username:"sales3",realName:"王销售",email:"sales3@example.com",phone:"13800138004",roleId:"employee",status:"active"}].find(t=>t.id===e),async getCustomerList(e){await tt(),et=ke(),console.log("Mock API: 获取客户列表，当前客户总数",et.length);let t=[...et];e?.name&&(t=t.filter(t=>t.name.includes(e.name))),e?.phone&&(t=t.filter(t=>t.phone.includes(e.phone))),e?.level&&(t=t.filter(t=>t.level===e.level));const s=e?.page||1,a=e?.pageSize||50,r=(s-1)*a,o=r+a;return{list:t.slice(r,o),total:t.length,page:s,pageSize:a}},async checkCustomerExists(e){try{if(console.log("Mock API: checkCustomerExists 开始调用，手机号:",e),!e||"string"!=typeof e)return console.error("Mock API: 无效的手机号参数:",e),null;await tt(200),et=ke(),Array.isArray(et)||(console.error("Mock API: mockCustomers is not an array:",et),et=[...De]),console.log("Mock API: 当前客户总数:",et.length),console.log("Mock API: 所有客户手机号:",et.map(e=>e.phone));const s=et.find(t=>t.phone===e);if(console.log("Mock API: 检查客户是否存在",e,s?"存在":"不存在"),s){console.log("Mock API: 找到的客户:",s);try{const e=this.getUserById(s.createdBy),t={...s,creatorName:e?.realName||"未知用户"};return console.log("Mock API: 返回客户信息（含创建者）:",t),t}catch(t){return console.warn("Mock API: 获取创建者信息失败，使用默认值:",t),{...s,creatorName:"未知用户"}}}return console.log("Mock API: 客户不存在，返回null"),null}catch(s){return console.error("Mock API: checkCustomerExists 执行失败:",s),null}},async createCustomer(e){await tt();try{const t={...e,id:`customer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,createTime:(new Date).toISOString(),orderCount:0},s=Te.addCustomer(t);return et=ke(),console.log("Mock API: 创建客户成功",s),console.log("Mock API: 当前客户总数",et.length),s}catch(t){throw console.error("Mock API: 创建客户失败",t),t}},async updateCustomer(e,t){await tt(),et=ke(),Array.isArray(et)||(console.error("Mock API: mockCustomers is not an array:",et),et=[...De]);const s=et.findIndex(t=>t.id===e);if(-1!==s)return et[s]={...et[s],...t},be(et),et[s];throw new Error("客户不存在")},async deleteCustomer(e){await tt(),et=ke(),Array.isArray(et)||(console.error("Mock API: mockCustomers is not an array:",et),et=[...De]);const t=et.findIndex(t=>t.id===e);if(-1===t)throw new Error("客户不存在");et.splice(t,1),be(et)},async getCustomerDetail(e){await tt(),Array.isArray(et)||(console.error("Mock API: mockCustomers is not an array:",et),et=[...De]);const t=et.find(t=>t.id===e);if(t)return t;throw new Error("客户不存在")},async getOrderList(e){await tt();let t=Oe();e?.orderNumber&&(t=t.filter(t=>t.orderNumber.includes(e.orderNumber))),e?.customerName&&(t=t.filter(t=>t.customerName.includes(e.customerName))),e?.status&&(t=t.filter(t=>t.status===e.status)),e?.paymentStatus&&(t=t.filter(t=>t.paymentStatus===e.paymentStatus));const s=e?.page||1,a=e?.pageSize||10,r=(s-1)*a,o=r+a;return{list:t.slice(r,o),total:t.length,page:s,pageSize:a}},async submitCancelRequest(e){await tt();const t=Oe(),s=t.findIndex(t=>t.id===e.orderId);if(-1===s)throw new Error("订单不存在");const a=t[s];if(["shipped","delivered","completed","cancelled"].includes(a.status))throw new Error("当前订单状态不允许取消");return t[s]={...a,status:"pending_cancel",cancelStatus:"pending",cancelReason:e.reason,cancelDescription:e.description,cancelRequestTime:(new Date).toLocaleString("zh-CN"),updateTime:(new Date).toLocaleString("zh-CN")},Ne(t),console.log("Mock API: 提交取消订单申请成功",e.orderId),{success:!0,message:"取消申请已提交，等待审核"}},async getPendingCancelOrderList(){await tt();const e=Oe().filter(e=>"pending_cancel"===e.status&&"pending"===e.cancelStatus);return console.log("Mock API: 获取待审核取消订单列表",e.length),e},async getAuditedCancelOrderList(){await tt();const e=Oe().filter(e=>e.cancelStatus&&["approved","rejected"].includes(e.cancelStatus));return console.log("Mock API: 获取已审核取消订单列表",e.length),e},async auditCancelRequest(e,t){await tt();const s=Oe(),a=s.findIndex(t=>t.id===e);if(-1===a)throw new Error("订单不存在");const r=s[a];if("pending_cancel"!==r.status||"pending"!==r.cancelStatus)throw new Error("订单不在待审核状态");return"approve"===t.action?s[a]={...r,status:"cancelled",cancelStatus:"approved",auditStatus:"approved",auditRemark:t.remark,auditTime:(new Date).toLocaleString("zh-CN"),auditorId:t.auditorId,updateTime:(new Date).toLocaleString("zh-CN")}:s[a]={...r,status:"cancel_failed",cancelStatus:"rejected",auditStatus:"rejected",auditRemark:t.remark,auditTime:(new Date).toLocaleString("zh-CN"),auditorId:t.auditorId,updateTime:(new Date).toLocaleString("zh-CN")},Ne(s),console.log("Mock API: 审核取消订单申请成功",e,t.action),{success:!0,message:"approve"===t.action?"取消申请已通过":"取消申请已拒绝"}},async updateOrder(e,t){await tt();const s=Oe(),a=s.findIndex(t=>t.id===e);if(-1===a)throw new Error("订单不存在");const r=s[a],o={...r,...t,id:e,orderNumber:r.orderNumber,createTime:r.createTime,updateTime:(new Date).toLocaleString("zh-CN"),status:t.status||r.status,auditStatus:t.auditStatus||r.auditStatus};return s[a]=o,Ne(s),console.log("Mock API: 更新订单成功",e,t),o},async getOrderStatistics(){await tt();const e=Oe().filter(e=>"pending"===e.auditStatus),t=e.length,s=e.reduce((e,t)=>e+t.totalAmount,0),a=(new Date).toISOString().split("T")[0],r=e.filter(e=>new Date(e.createTime).toISOString().split("T")[0]===a).length,o=new Date,n=e.filter(e=>{const t=new Date(e.createTime);return(o.getTime()-t.getTime())/36e5>24}).length;return console.log("Mock API: 获取订单统计数据成功",{pendingCount:t,pendingAmount:s,todayCount:r,urgentCount:n}),{pendingCount:t,pendingAmount:s,todayCount:r,urgentCount:n}},async submitOrderAudit(e,t){await tt();const s=Oe(),a=s.findIndex(t=>t.id===e);if(-1===a)throw new Error("订单不存在");const r=s[a];if("pending"!==r.status&&"draft"!==r.status)throw new Error("订单状态不允许提审");return s[a]={...r,auditStatus:"pending",status:(t.markType,"pending"),updateTime:(new Date).toLocaleString("zh-CN")},Ne(s),console.log("Mock API: 提交订单审核成功",e,t),{success:!0,message:"订单已提交审核"}},async getSmsTemplateList(e){await tt();let t=He();e?.name&&(t=t.filter(t=>t.name.includes(e.name))),e?.type&&(t=t.filter(t=>t.type===e.type)),e?.status&&(t=t.filter(t=>t.status===e.status));const s=e?.page||1,a=e?.pageSize||10,r=(s-1)*a,o=r+a;return{list:t.slice(r,o),total:t.length,page:s,pageSize:a}},async getSmsTemplateDetail(e){await tt();const t=He().find(t=>t.id===e);if(t)return t;throw new Error("模板不存在")},async createSmsTemplate(e){await tt();const t=He(),s={...e,id:Math.max(...t.map(e=>e.id),0)+1,createTime:(new Date).toLocaleString(),updateTime:(new Date).toLocaleString(),usage:0};return t.push(s),Be(t),s},async updateSmsTemplate(e,t){await tt();const s=He(),a=s.findIndex(t=>t.id===e);if(-1!==a)return s[a]={...s[a],...t,updateTime:(new Date).toLocaleString()},Be(s),s[a];throw new Error("模板不存在")},async deleteSmsTemplate(e){await tt();const t=He(),s=t.findIndex(t=>t.id===e);if(-1===s)throw new Error("模板不存在");t.splice(s,1),Be(t)},async previewSmsTemplate(e,t){await tt();let s=e;return Object.entries(t).forEach(([e,t])=>{s=s.replace(new RegExp(`\\{${e}\\}`,"g"),t)}),s},async getSmsApprovalList(e){await tt();let t=Je();if(e?.applicant&&(t=t.filter(t=>t.applicant.includes(e.applicant))),e?.status&&(t=t.filter(t=>t.status===e.status)),e?.dateRange&&2===e.dateRange.length){const[s,a]=e.dateRange;t=t.filter(e=>{const t=e.applyTime.split(" ")[0];return t>=s&&t<=a})}const s=e?.page||1,a=e?.pageSize||10,r=(s-1)*a,o=r+a;return{list:t.slice(r,o),total:t.length,page:s,pageSize:a}},async getSmsApprovalDetail(e){await tt();const t=Je().find(t=>t.id===e);if(t)return t;throw new Error("审核记录不存在")},async submitSmsApproval(e){await tt();const t=He().find(t=>t.id===e.templateId);if(!t)throw new Error("模板不存在");const s=Je(),a={id:Math.max(...s.map(e=>e.id),0)+1,applicant:"当前用户",department:"销售部",templateId:e.templateId,templateName:t.name,recipientCount:e.recipients.length,content:t.content,reason:e.reason,status:"pending",applyTime:(new Date).toLocaleString(),recipients:e.recipients};return s.push(a),ze(s),a},async approveSms(e,t){await tt();const s=Je(),a=s.findIndex(t=>t.id===e);if(-1!==a)return s[a]={...s[a],status:"approved",approveTime:(new Date).toLocaleString(),approver:"当前用户",approveRemark:t},ze(s),s[a];throw new Error("审核记录不存在")},async rejectSms(e,t){await tt();const s=Je(),a=s.findIndex(t=>t.id===e);if(-1!==a)return s[a]={...s[a],status:"rejected",approveTime:(new Date).toLocaleString(),approver:"当前用户",approveRemark:t},ze(s),s[a];throw new Error("审核记录不存在")},async batchApproveSms(e,t,s){await tt();const a=Je(),r=[];return e.forEach(e=>{const o=a.findIndex(t=>t.id===e);-1!==o&&(a[o]={...a[o],status:"approve"===t?"approved":"rejected",approveTime:(new Date).toLocaleString(),approver:"当前用户",approveRemark:s},r.push(a[o]))}),ze(a),r},async getSmsSendList(e){await tt();let t=Ge();if(e?.templateName&&(t=t.filter(t=>t.templateName.includes(e.templateName))),e?.status&&(t=t.filter(t=>t.status===e.status)),e?.dateRange&&2===e.dateRange.length){const[s,a]=e.dateRange;t=t.filter(e=>{const t=e.sendTime.split(" ")[0];return t>=s&&t<=a})}const s=e?.page||1,a=e?.pageSize||10,r=(s-1)*a,o=r+a;return{list:t.slice(r,o),total:t.length,page:s,pageSize:a}},async getSmsSendDetail(e){await tt();const t=Ge().find(t=>t.id===e);if(t)return t;throw new Error("发送记录不存在")},async sendSms(e){await tt();const t=He(),s=t.find(t=>t.id===e.templateId);if(!s)throw new Error("模板不存在");const a=Ge(),r={id:Math.max(...a.map(e=>e.id),0)+1,templateId:e.templateId,templateName:s.name,content:s.content,recipients:e.recipients,successCount:e.recipients.length,failCount:0,status:"success",sendTime:(new Date).toLocaleString(),operator:"当前用户",cost:.05*e.recipients.length};a.push(r),(e=>{try{localStorage.setItem(Ue,JSON.stringify(e))}catch(t){console.warn("Failed to save SMS sends to localStorage:",t)}})(a);const o=t.findIndex(t=>t.id===e.templateId);return-1!==o&&(t[o].usage+=e.recipients.length,Be(t)),r},async testSms(e,t){await tt();return/^1[3-9]\d{9}$/.test(e)?{success:!0,message:"测试短信发送成功"}:{success:!1,message:"手机号格式不正确"}},async getSmsStatistics(e){await tt();const t=Ge(),s=He(),a=t.reduce((e,t)=>e+t.successCount,0),r=t.reduce((e,t)=>e+t.failCount,0),o=a+r>0?a/(a+r)*100:0,n=t.reduce((e,t)=>e+t.cost,0),i=s.map(e=>({templateName:e.name,count:e.usage}));return{totalSent:a,successRate:Math.round(100*o)/100,totalCost:Math.round(100*n)/100,monthlyUsage:a,dailyUsage:Math.round(a/30),templateUsage:i,trendData:[{date:"2024-01-10",count:45,cost:2.25},{date:"2024-01-11",count:67,cost:3.35},{date:"2024-01-12",count:89,cost:4.45},{date:"2024-01-13",count:123,cost:6.15},{date:"2024-01-14",count:156,cost:7.8},{date:"2024-01-15",count:134,cost:6.7}]}},async getSmsTrend(e,t="daily"){await tt();return[{date:"2024-01-10",count:45,cost:2.25},{date:"2024-01-11",count:67,cost:3.35},{date:"2024-01-12",count:89,cost:4.45},{date:"2024-01-13",count:123,cost:6.15},{date:"2024-01-14",count:156,cost:7.8},{date:"2024-01-15",count:134,cost:6.7}]},async getLogisticsStatusList(e){await tt();const t=localStorage.getItem(Ce);let s=[];if(t)try{s=JSON.parse(t)}catch(m){console.error("解析订单数据失败:",m)}const a=s.filter(e=>("shipped"===e.status||"delivered"===e.status)&&(e.trackingNumber||e.expressNo)&&e.expressCompany).map(e=>({id:e.id,orderNo:e.orderNumber,customerName:e.customerName,customerPhone:e.receiverPhone,productName:e.products?.map(e=>e.name).join("、")||"商品",quantity:e.products?.reduce((e,t)=>e+t.quantity,0)||1,amount:e.totalAmount,status:e.logisticsStatus||"shipped",trackingNo:e.trackingNumber||e.expressNo,logisticsCompany:e.expressCompany,createTime:e.createTime,updateTime:e.shippingTime||e.createTime,shippingTime:e.shippingTime,remark:e.remark||"已发货"})),r=new Date,o=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(Math.floor(12*Math.random())+9).padStart(2,"0")}:${String(Math.floor(60*Math.random())).padStart(2,"0")}:00`,n=[...a,...[{id:"test1",orderNo:"ORD202401005",customerName:"张三",customerPhone:"13800138005",productName:"蓝牙耳机",quantity:2,amount:599,status:"shipped",trackingNo:"SF1234567890",logisticsCompany:"顺丰速运",createTime:o(r),updateTime:o(r),shippingTime:o(r),remark:"今日发货"},{id:"test2",orderNo:"ORD202401006",customerName:"李四",customerPhone:"13800138006",productName:"手机壳",quantity:1,amount:89,status:"shipped",trackingNo:"YTO9876543210",logisticsCompany:"圆通速递",createTime:o(new Date(r.getTime()-2592e5)),updateTime:o(new Date(r.getTime()-2592e5)),shippingTime:o(new Date(r.getTime()-2592e5)),remark:"3天前发货"},{id:"test3",orderNo:"ORD202401007",customerName:"王五",customerPhone:"13800138007",productName:"数据线",quantity:3,amount:150,status:"delivered",trackingNo:"ZTO1122334455",logisticsCompany:"中通快递",createTime:o(new Date(r.getTime()-432e6)),updateTime:o(new Date(r.getTime()-1728e5)),shippingTime:o(new Date(r.getTime()-432e6)),remark:"5天前发货，已签收"},{id:"test4",orderNo:"ORD202401008",customerName:"赵六",customerPhone:"13800138008",productName:"充电宝",quantity:1,amount:299,status:"delivered",trackingNo:"EMS6677889900",logisticsCompany:"邮政EMS",createTime:o(new Date(r.getTime()-864e6)),updateTime:o(new Date(r.getTime()-6048e5)),shippingTime:o(new Date(r.getTime()-864e6)),remark:"10天前发货，已签收"},{id:"todo1",orderNo:"ORD202401004",customerName:"钱七",customerPhone:"13800138004",productName:"智能手表",quantity:1,amount:1299,status:"todo",trackingNo:"ZTO5555666677",logisticsCompany:"中通快递",createTime:o(new Date(r.getTime()-1728e5)),updateTime:o(new Date),shippingTime:o(new Date(r.getTime()-1728e5)),remark:"需要跟进"}]];let i=n;if(e?.tab&&("pending"===e.tab?i=n.filter(e=>"shipped"===e.status):"updated"===e.tab?i=n.filter(e=>["delivered","rejected","returned","abnormal"].includes(e.status)):"todo"===e.tab&&(i=n.filter(e=>"todo"===e.status))),e?.dateRange&&2===e.dateRange.length){const[t,s]=e.dateRange;i=i.filter(e=>{const a=(e.shippingTime||e.createTime).split(" ")[0];return!t&&s?a<=s:t&&s?a>=t&&a<=s:!(t&&!s)||a>=t})}if(e?.keyword){const t=e.keyword.toLowerCase();i=i.filter(e=>e.orderNo.toLowerCase().includes(t)||e.customerName.toLowerCase().includes(t)||e.trackingNo.toLowerCase().includes(t))}const c=e?.page||1,l=e?.pageSize||20,d=(c-1)*l,u=d+l;return{list:i.slice(d,u),total:i.length,page:c,pageSize:l}},async getLogisticsStatusSummary(e){await tt();const t=localStorage.getItem(Ce);let s=[];if(t)try{s=JSON.parse(t)}catch(l){console.error("解析订单数据失败:",l)}const a=s.filter(e=>("shipped"===e.status||"delivered"===e.status)&&(e.trackingNumber||e.expressNo)&&e.expressCompany).map(e=>({status:e.logisticsStatus||"shipped",shippingTime:e.shippingTime,createTime:e.createTime})),r=[...a,{status:"todo",shippingTime:"2024-01-12 15:30:00",createTime:"2024-01-12 11:20:00"}];let o=r;if(e?.dateRange&&2===e.dateRange.length){const[t,s]=e.dateRange;o=r.filter(e=>{const a=e.shippingTime||e.createTime;return a>=t&&a<=s})}const n=o.filter(e=>"shipped"===e.status).length,i=o.filter(e=>["delivered","rejected","returned","abnormal"].includes(e.status)).length,c=o.filter(e=>"todo"===e.status).length;return{pending:n,updated:i,todo:c,total:o.length}},updateOrderLogisticsStatus:async e=>(await tt(),console.log("Mock API: 更新订单物流状态",e),{success:!0,message:"状态更新成功"}),batchUpdateOrderLogisticsStatus:async e=>(await tt(),console.log("Mock API: 批量更新订单物流状态",e),{success:!0,message:"批量更新成功"}),setOrderTodo:async e=>(await tt(),console.log("Mock API: 设置订单待办",e),{success:!0,message:"待办设置成功"}),getLogisticsTracking:async e=>(await tt(),{trackingNo:e,company:"顺丰速运",status:"in_transit",tracks:[{time:"2024-01-16 10:30:00",location:"北京分拣中心",status:"已发出",description:"快件已从北京分拣中心发出"},{time:"2024-01-15 18:20:00",location:"北京收件点",status:"已收件",description:"快件已在北京收件点收件"}]}),getUserLogisticsPermission:async()=>(await tt(),{canAccess:!0,canUpdate:!0,canSetTodo:!0,canAutoUpdate:!1}),async getLogisticsStatusLog(e){await tt();const t=[{id:"1",orderNo:"ORD202401002",oldStatus:"pending",newStatus:"shipped",operator:"张销售",operateTime:"2024-01-15 14:30:00",remark:"已发货，快递单号：SF1234567890"}];return{list:t,total:t.length,page:e?.page||1,pageSize:e?.pageSize||20}},exportLogisticsStatusData:async e=>(await tt(),console.log("Mock API: 导出物流状态数据",e),{success:!0,downloadUrl:"/mock/logistics-export.xlsx"}),async getSystemLogs(e){await tt(),console.log("Mock API: 获取系统日志",e);const t=[{id:"1",timestamp:"2024-01-15 10:30:00",level:"INFO",module:"客户管理",message:"新增客户成功",details:"客户编号: XH202401151030, 客户姓名: 张三"},{id:"2",timestamp:"2024-01-15 10:25:00",level:"INFO",module:"订单管理",message:"订单状态更新",details:"订单号: ORD202401151025, 状态: 已发货"},{id:"3",timestamp:"2024-01-15 10:20:00",level:"WARN",module:"系统监控",message:"内存使用率较高",details:"当前内存使用率: 85%"},{id:"4",timestamp:"2024-01-15 10:15:00",level:"INFO",module:"用户管理",message:"用户登录",details:"用户: admin, IP: 192.168.1.100"},{id:"5",timestamp:"2024-01-15 10:10:00",level:"ERROR",module:"短信服务",message:"短信发送失败",details:"目标号码: 13800138001, 错误: 余额不足"}];let s=t;return e?.level&&"ALL"!==e.level&&(s=t.filter(t=>t.level===e.level)),e?.limit&&(s=s.slice(0,e.limit)),{success:!0,data:s,total:s.length}},clearSystemLogs:async()=>(await tt(),console.log("Mock API: 清空系统日志"),{success:!0,message:"系统日志已清空",clearedFiles:5}),async getMessageSubscriptions(){await tt(),console.log("Mock API: 获取消息订阅列表");const e=[{id:"1",messageType:"order_created",name:"新建订单",description:"当有新订单创建时发送通知",isSubscribed:!0,notificationMethods:["system_message","email"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"2",messageType:"order_signed",name:"订单签收",description:"当订单签收成功时发送通知",isSubscribed:!0,notificationMethods:["dingtalk","system_message"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"3",messageType:"order_audit_rejected",name:"订单审核拒绝",description:"当订单审核被拒绝时发送通知",isSubscribed:!1,notificationMethods:["email"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"4",messageType:"order_audit_approved",name:"订单审核通过",description:"当订单审核通过时发送通知",isSubscribed:!0,notificationMethods:["wechat_work","system_message"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"5",messageType:"customer_created",name:"新增客户",description:"当有新客户创建时发送通知",isSubscribed:!0,notificationMethods:["system_message"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"6",messageType:"payment_received",name:"收款确认",description:"当收到客户付款时发送通知",isSubscribed:!0,notificationMethods:["dingtalk","wechat_work","system_message"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"7",messageType:"payment_overdue",name:"付款逾期",description:"当客户付款逾期时发送通知",isSubscribed:!0,notificationMethods:["email","system_message"],createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"}];return{data:e,total:e.length}},updateMessageSubscription:async(e,t)=>(await tt(),console.log("Mock API: 更新消息订阅",e,t),{success:!0,message:"订阅设置更新成功"}),async getAnnouncements(e){await tt(),console.log("Mock API: 获取公告列表",e);const t=[{id:"1",title:"系统维护通知",content:"系统将于本周六晚上22:00-24:00进行维护升级，期间可能影响正常使用，请提前做好相关准备。",type:"company",targetDepartments:[],isPopup:!0,isMarquee:!0,publishedAt:"2024-01-15 09:00:00",status:"published",createdBy:"admin",createdAt:"2024-01-15 08:30:00",updatedAt:"2024-01-15 09:00:00"},{id:"2",title:"销售部门会议通知",content:"销售部门月度总结会议将于明天下午2点在会议室A举行，请相关人员准时参加。",type:"department",targetDepartments:["sales"],isPopup:!1,isMarquee:!0,publishedAt:"2024-01-14 16:00:00",status:"published",createdBy:"sales_manager",createdAt:"2024-01-14 15:30:00",updatedAt:"2024-01-14 16:00:00"},{id:"3",title:"新功能上线通知",content:"客户管理系统新增了消息管理功能，支持消息订阅和公告发布，欢迎大家使用。",type:"company",targetDepartments:[],isPopup:!1,isMarquee:!1,scheduledAt:"2024-01-16 10:00:00",status:"scheduled",createdBy:"admin",createdAt:"2024-01-15 14:00:00",updatedAt:"2024-01-15 14:00:00"}];return{data:t,total:t.length}},async createAnnouncement(e){await tt(),console.log("Mock API: 创建公告",e);return{data:{id:Date.now().toString(),...e,createdAt:(new Date).toISOString().replace("T"," ").substring(0,19),updatedAt:(new Date).toISOString().replace("T"," ").substring(0,19)},message:"公告创建成功"}},updateAnnouncement:async(e,t)=>(await tt(),console.log("Mock API: 更新公告",e,t),{success:!0,message:"公告更新成功"}),deleteAnnouncement:async e=>(await tt(),console.log("Mock API: 删除公告",e),{success:!0,message:"公告删除成功"}),async getMessageConfigs(){await tt(),console.log("Mock API: 获取消息配置列表");const e=[{id:"1",type:"dingtalk",name:"钉钉机器人",config:{webhook:"https://oapi.dingtalk.com/robot/send?access_token=xxx",secret:"SEC***"},isEnabled:!0,createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"2",type:"wechat_work",name:"企业微信群机器人",config:{webhook:"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx",groupName:"技术部通知群",mentionAll:!1,mentionedList:"13800138001,13800138002"},isEnabled:!0,createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"3",type:"email",name:"邮件通知",config:{smtpHost:"smtp.qq.com",smtpPort:587,username:"service@company.com",password:"***"},isEnabled:!1,createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"},{id:"4",type:"wechat_official",name:"微信公众号",config:{appId:"wx***",appSecret:"***"},isEnabled:!1,createdAt:"2024-01-01 10:00:00",updatedAt:"2024-01-15 14:30:00"}];return{data:e,total:e.length}},updateMessageConfig:async(e,t)=>(await tt(),console.log("Mock API: 更新消息配置",e,t),{success:!0,message:"配置更新成功"}),testMessageConfig:async e=>(await tt(),console.log("Mock API: 测试消息配置",e),{success:!0,message:"配置测试成功"}),async getSystemMessages(e){await tt(),console.log("Mock API: 获取系统消息列表",e);const t=[];return{success:!0,data:{messages:t,total:t.length}}},markMessageAsRead:async e=>(await tt(),console.log("Mock API: 标记消息已读",e),{success:!0,message:"消息已标记为已读"}),markAllMessagesAsRead:async()=>(await tt(),console.log("Mock API: 标记所有消息已读"),{success:!0,message:"所有消息已标记为已读"}),getMessageStats:async()=>(await tt(),console.log("Mock API: 获取消息统计"),{data:{totalSubscriptions:7,activeSubscriptions:5,totalAnnouncements:3,publishedAnnouncements:2,unreadMessages:2,totalMessages:4,configuredChannels:2,totalChannels:4}}),async getCategoryList(){await tt(),console.log("Mock API: 获取产品分类列表");return{success:!0,data:Ke(),message:"获取分类列表成功"}},async getCategoryTree(){await tt(),console.log("Mock API: 获取产品分类树形结构");const e=Ke();return{success:!0,data:this.buildCategoryTree(e),message:"获取分类树成功"}},buildCategoryTree(e){const t=new Map,s=[];return e.forEach(e=>{t.set(e.id,{...e,children:[]})}),e.forEach(e=>{const a=t.get(e.id);if(e.parentId){const s=t.get(e.parentId);s&&(s.children=s.children||[],s.children.push(a))}else s.push(a)}),s},async createCategory(e){await tt(),console.log("Mock API: 创建产品分类",e);const t=Ke(),s={id:Date.now().toString(),name:e.name,code:e.code,parentId:e.parentId||null,level:e.level||1,sort:e.sort||1,status:e.status||"active",productCount:0,createTime:(new Date).toISOString().replace("T"," ").substring(0,19)};return t.push(s),Ye(t),{success:!0,data:s,message:"创建分类成功"}},async updateCategory(e,t){await tt(),console.log("Mock API: 更新产品分类",e,t);const s=Ke(),a=s.findIndex(t=>t.id===e);if(-1===a)return{success:!1,message:"分类不存在"};const r={...s[a],...t,id:e,updateTime:(new Date).toISOString().replace("T"," ").substring(0,19)};return s[a]=r,Ye(s),{success:!0,data:r,message:"更新分类成功"}},async deleteCategory(e){await tt(),console.log("Mock API: 删除产品分类",e);const t=Ke(),s=t.findIndex(t=>t.id===e);if(-1===s)return{success:!1,message:"分类不存在"};return t.some(t=>t.parentId===e)?{success:!1,message:"该分类下还有子分类，无法删除"}:(t.splice(s,1),Ye(t),{success:!0,message:"删除分类成功"})},async getCategoryDetail(e){await tt(),console.log("Mock API: 获取产品分类详情",e);const t=Ke().find(t=>t.id===e);return t?{success:!0,data:t,message:"获取分类详情成功"}:{success:!1,message:"分类不存在"}},async getDepartmentList(){await tt(),console.log("[Mock API] 获取部门列表开始...");!localStorage.getItem("departments_cleared")&&(console.log("[Mock API] 首次访问，清除旧的部门数据"),(()=>{try{localStorage.removeItem($e),console.log("[Mock API] 已清除所有部门数据")}catch(e){console.error("清除部门数据失败:",e)}})(),localStorage.setItem("departments_cleared","true"));const e=We();console.log("[Mock API] 从存储获取的部门数据:",e),console.log("[Mock API] 部门数据数量:",e.length);const t={success:!0,data:e,message:"获取部门列表成功"};return console.log("[Mock API] 返回结果:",t),t},async getDepartmentTree(){await tt(),console.log("Mock API: 获取部门树形结构");return await this.getDepartmentList()},async createDepartment(e){await tt(),console.log("Mock API: 创建部门",e);const t=We(),s={id:Date.now().toString(),name:e.name,code:e.code,description:e.description||"",parentId:e.parentId||null,sortOrder:e.sortOrder||1,status:e.status||"active",memberCount:0,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};return t.push(s),Qe(t),console.log("Mock API: 部门创建成功，已保存到本地存储",s),{success:!0,data:s,message:"部门创建成功"}},async updateDepartment(e,t){await tt(),console.log("Mock API: 更新部门",e,t);const s=We(),a=s.findIndex(t=>t.id===e);if(-1===a)return{success:!1,message:"部门不存在"};const r={...s[a],...t,id:e,updatedAt:(new Date).toISOString()};return s[a]=r,Qe(s),{success:!0,data:r,message:"部门更新成功"}},async deleteDepartment(e){await tt(),console.log("Mock API: 删除部门",e);const t=We(),s=t.findIndex(t=>t.id===e);if(-1===s)return{success:!1,message:"部门不存在"};return t.some(t=>t.parentId===e)?{success:!1,message:"该部门下还有子部门，无法删除"}:(t.splice(s,1),Qe(t),{success:!0,message:"部门删除成功"})},async getDepartmentDetail(e){await tt(),console.log("Mock API: 获取部门详情",e);return{success:!0,data:{id:e,name:"技术部",code:"TECH",description:"负责技术开发和维护",parentId:null,sortOrder:1,status:"active",memberCount:15,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"},message:"获取部门详情成功"}},async updateDepartmentStatus(e,t){await tt(),console.log("Mock API: 更新部门状态",e,t);const s=We(),a=s.findIndex(t=>t.id===e);if(-1===a)return{success:!1,message:"部门不存在"};s[a].status=t.status||t,s[a].updatedAt=(new Date).toISOString(),Qe(s);return{success:!0,data:s[a],message:"部门状态更新成功"}},async getDepartmentStats(){await tt(),console.log("[Mock API] 获取部门统计数据，基于真实数据计算");const e=We();console.log("[Mock API] 统计计算基于的部门数据:",e.length,"个部门");const t=e.length,s=e.filter(e=>"active"===e.status).length,a=e.reduce((e,t)=>e+(t.memberCount||0),0),r={};e.forEach(e=>{let t="其他部门";t=e.parentId?"子部门":"主部门",r[t]=(r[t]||0)+1});const o={totalDepartments:t,activeDepartments:s,totalMembers:a,departmentsByType:r};return console.log("[Mock API] 计算得出的统计数据:",o),{success:!0,data:o,message:"获取部门统计成功"}},async getUserList(e){await tt(),console.log("[Mock API] 获取用户列表",e);!localStorage.getItem("users_cleared")&&(console.log("[Mock API] 首次访问，清除旧的用户数据"),(()=>{try{localStorage.removeItem(Ve),console.log("[Mock API] 已清除所有用户数据")}catch(e){console.error("清除用户数据失败:",e)}})(),localStorage.setItem("users_cleared","true"));let t=Xe();if(console.log("[Mock API] 从存储获取的用户数据:",t),console.log("[Mock API] 用户数据数量:",t.length),e){if(e.search){const s=e.search.toLowerCase();t=t.filter(e=>{const t=(e.username||"").toLowerCase(),a=(e.realName||e.name||"").toLowerCase();return t.includes(s)||a.includes(s)}),console.log("[Mock API] 应用搜索筛选:",e.search,"结果数量:",t.length)}e.departmentId&&(t=t.filter(t=>String(t.departmentId)===String(e.departmentId)),console.log("[Mock API] 应用部门筛选:",e.departmentId,"结果数量:",t.length)),e.role&&(t=t.filter(t=>t.role===e.role||t.roleId===e.role),console.log("[Mock API] 应用角色筛选:",e.role,"结果数量:",t.length)),e.status&&(t=t.filter(t=>t.status===e.status),console.log("[Mock API] 应用状态筛选:",e.status,"结果数量:",t.length)),e.employmentStatus&&(t=t.filter(t=>(t.employmentStatus||"active")===e.employmentStatus),console.log("[Mock API] 应用在职状态筛选:",e.employmentStatus,"结果数量:",t.length))}const s={success:!0,data:{items:t,total:t.length,page:e?.page||1,limit:e?.limit||20,totalPages:Math.ceil(t.length/(e?.limit||20))},message:"获取用户列表成功"};return console.log("[Mock API] 返回用户列表结果，筛选后数量:",t.length),s},async createUser(e){await tt(),console.log("[Mock API] 创建用户",e);const t=Xe(),s=`${(a=new Date).getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}`;var a;let r;if(t.length>0){if("string"==typeof t[0].id)r=Date.now().toString();else{r=(Math.max(...t.map(e=>parseInt(e.id)||0))+1).toString()}}else r=Date.now().toString();const o={id:r,username:e.username,realName:e.realName,email:e.email,phone:e.phone,role:e.role,roleName:e.roleName||"",departmentId:e.departmentId,departmentName:e.department||"",position:e.position||"",employeeNumber:e.employeeNumber||"",status:e.status||"active",employmentStatus:e.employmentStatus||"active",avatar:e.avatar||"",remark:e.remark||"",createTime:s,createdAt:s,lastLoginTime:null,lastLoginAt:null,loginCount:0,isOnline:!1};t.push(o),Ze(t);try{const t=JSON.parse(localStorage.getItem("userDatabase")||"[]");t.push({id:r,name:e.realName,email:e.email,phone:e.phone,role:e.role,department:e.department||"",departmentId:e.departmentId,position:e.position||"",employeeNumber:e.employeeNumber||"",avatar:e.avatar||"",status:e.status||"active",createTime:s,createdAt:s}),localStorage.setItem("userDatabase",JSON.stringify(t)),console.log("[Mock API] 用户同时保存到userDatabase")}catch(n){console.error("[Mock API] 保存到userDatabase失败:",n)}return console.log("[Mock API] 用户创建成功，已保存到本地存储",o),{success:!0,data:o,message:"用户创建成功"}},async updateUser(e,t){await tt(),console.log("[Mock API] 更新用户",e,t);const s=Xe(),a=s.findIndex(t=>String(t.id)===String(e));if(-1!==a){const o={...s[a],...t,id:s[a].id,username:s[a].username,name:t.realName||s[a].name,realName:t.realName||s[a].realName,updateTime:(new Date).toLocaleString(),updatedAt:(new Date).toISOString()};s[a]=o,Ze(s),console.log("[Mock API] 用户数据已更新到localStorage:",o);try{const s=JSON.parse(localStorage.getItem("userDatabase")||"[]"),a=s.findIndex(t=>String(t.id)===String(e));-1!==a&&(s[a]={...s[a],name:t.realName||s[a].name,email:t.email||s[a].email,phone:t.phone||s[a].phone,role:t.role||t.roleId||s[a].role,roleId:t.roleId||s[a].roleId,department:t.department||s[a].department,departmentId:void 0!==t.departmentId?t.departmentId:s[a].departmentId,position:t.position||s[a].position,employeeNumber:t.employeeNumber||s[a].employeeNumber,status:t.status||s[a].status},localStorage.setItem("userDatabase",JSON.stringify(s)),console.log("[Mock API] 用户同步更新到userDatabase"))}catch(r){console.error("[Mock API] 同步更新userDatabase失败:",r)}return{success:!0,data:o,message:"用户更新成功"}}throw console.error("[Mock API] 未找到用户，ID:",e),new Error("用户不存在")},async deleteUser(e){await tt(),console.log("[Mock API] 删除用户",e);const t=Xe(),s=t.findIndex(t=>String(t.id)===String(e));if(-1!==s){const r=t[s];t.splice(s,1),Ze(t),console.log("[Mock API] 用户已从localStorage删除:",r.username||r.name);try{const t=JSON.parse(localStorage.getItem("userDatabase")||"[]"),s=t.findIndex(t=>String(t.id)===String(e));-1!==s&&(t.splice(s,1),localStorage.setItem("userDatabase",JSON.stringify(t)),console.log("[Mock API] 用户同步从userDatabase删除"))}catch(a){console.error("[Mock API] 同步删除userDatabase失败:",a)}return{success:!0,data:null,message:"用户删除成功"}}throw console.error("[Mock API] 未找到用户，ID:",e),new Error("用户不存在")},async updateUserStatus(e,t){await tt(),console.log("[Mock API] 更新用户状态",e,t);const s=Xe(),a=s.findIndex(t=>t.id.toString()===e);return-1===a?{success:!1,message:"用户不存在"}:(s[a].status=t.status,s[a].updatedAt=(new Date).toISOString(),Ze(s),console.log("[Mock API] 用户状态更新成功",s[a]),{success:!0,data:s[a],message:"用户状态更新成功"})},async updateEmploymentStatus(e,t){await tt(),console.log("[Mock API] 更新用户在职状态",e,t);const s=Xe(),a=s.findIndex(t=>t.id.toString()===e);return-1===a?{success:!1,message:"用户不存在"}:(s[a].employmentStatus=t.employmentStatus,"resigned"===t.employmentStatus?s[a].resignedDate=(new Date).toISOString().split("T")[0]:s[a].resignedDate=void 0,s[a].updatedAt=(new Date).toISOString(),Ze(s),console.log("[Mock API] 用户在职状态更新成功",s[a]),{success:!0,data:s[a],message:"用户在职状态更新成功"})},async getUserStatistics(){await tt(),console.log("[Mock API] 获取用户统计");const e=Xe(),t=new Date,s=t.getMonth(),a=t.getFullYear(),r=e.length,o=e.filter(e=>"active"===(e.employmentStatus||"active")).length,n=e.filter(e=>"resigned"===e.employmentStatus).length,i=e.filter(e=>{if(!e.createTime&&!e.createdAt)return!1;const t=new Date(e.createTime||e.createdAt);return t.getMonth()===s&&t.getFullYear()===a}).length;return console.log("[Mock API] 用户统计:",{"总用户数":r,"在职人数":o,"离职人数":n,"本月新增":i}),{success:!0,data:{total:r,active:o,resigned:n,monthNew:i,inactive:e.filter(e=>"inactive"===e.status).length,locked:e.filter(e=>"locked"===e.status).length,byRole:{admin:e.filter(e=>"admin"===e.role).length,manager:e.filter(e=>"manager"===e.role).length,sales:e.filter(e=>"sales"===e.role).length,service:e.filter(e=>"service"===e.role).length},byDepartment:[]},message:"获取用户统计成功"}}},at=()=>(console.log("[Mock API] 生产环境，强制使用真实API"),!1),rt=Object.freeze(Object.defineProperty({__proto__:null,mockApi:st,shouldUseMockApi:at},Symbol.toStringTag,{value:"Module"}));class ot{static instance;api;constructor(){this.api=Ie}static getInstance(){return ot.instance||(ot.instance=new ot),ot.instance}async login(e){try{if(at()){const{username:s,password:a}=e;console.log("[Auth] Mock模式登录尝试:",s);try{const e=localStorage.getItem("crm_mock_users");if(e){const r=JSON.parse(e),o=r.find(e=>e.username===s);if(o){if(console.log("[Auth] 在localStorage中找到用户:",o.username),o.password===a){console.log("[Auth] 密码验证成功");let e=o.roleId||o.role||"sales_staff",a=[];try{const t=JSON.parse(localStorage.getItem("crm_roles")||"[]");let n=t.find(t=>t.code===e);if(!n&&(n=t.find(t=>t.name===e),n)){console.log(`[Auth] 角色名称转换: ${e} → ${n.code}`),e=n.code,o.role=n.code,o.roleId=n.code;const t=r.findIndex(e=>e.username===s);-1!==t&&(r[t].role=n.code,r[t].roleId=n.code,localStorage.setItem("crm_mock_users",JSON.stringify(r)),console.log("[Auth] 已自动修复用户角色字段"))}n&&n.permissions&&n.permissions.length>0?(a=n.permissions,console.log("[Auth] 从角色配置加载权限:",a.length,"个")):(console.warn("[Auth] 未找到角色权限配置或权限为空:",e),a=this.getDefaultPermissions(e),console.log("[Auth] 使用默认权限:",a.length,"个"))}catch(t){console.warn("[Auth] 获取角色权限失败:",t),a=this.getDefaultPermissions(e),console.log("[Auth] 使用默认权限:",a.length,"个")}const n={...o,role:e,permissions:a,lastLoginAt:(new Date).toLocaleString("zh-CN"),updatedAt:(new Date).toISOString()},i={user:n,tokens:{accessToken:`mock-token-${Date.now()}`,refreshToken:`mock-refresh-${Date.now()}`},expiresIn:3600};o.lastLoginTime=(new Date).toLocaleString("zh-CN"),o.loginCount=(o.loginCount||0)+1,localStorage.setItem("crm_mock_users",JSON.stringify(r)),this.api.setAuthToken(i.tokens.accessToken),localStorage.setItem("refresh_token",i.tokens.refreshToken),localStorage.setItem("user_info",JSON.stringify(n)),localStorage.setItem("user",JSON.stringify(n)),localStorage.setItem("userPermissions",JSON.stringify(a)),console.log("[Auth] 已保存用户信息和权限:"),console.log("  - 用户:",n.username),console.log("  - 角色:",n.role),console.log("  - 权限数量:",a.length),console.log("  - Token:",i.tokens.accessToken.substring(0,30)+"...");const c=Date.now()+2592e6;return localStorage.setItem("token_expiry",c.toString()),console.log("[Auth] localStorage用户登录成功:",o.realName),i}console.log("[Auth] 密码验证失败")}}}catch(t){console.warn("[Auth] 从localStorage读取用户失败:",t)}console.log("[Auth] localStorage中未找到用户,尝试源代码预设账号");const{validatePresetAccount:r}=await ge(async()=>{const{validatePresetAccount:e}=await import("./presetAccounts-CPy7ljEq.js");return{validatePresetAccount:e}},[]),o=r(s,a);if(o){console.log("[Auth] 使用源代码预设账号登录:",o.name);const e=this.getDefaultPermissions(o.roleId),t={...o,permissions:e,lastLoginAt:(new Date).toLocaleString("zh-CN"),updatedAt:(new Date).toISOString()},s={user:t,tokens:{accessToken:`mock-token-${Date.now()}`,refreshToken:`mock-refresh-${Date.now()}`},expiresIn:3600};this.api.setAuthToken(s.tokens.accessToken),localStorage.setItem("refresh_token",s.tokens.refreshToken),localStorage.setItem("user_info",JSON.stringify(t)),localStorage.setItem("user",JSON.stringify(t)),localStorage.setItem("userPermissions",JSON.stringify(e));const a=Date.now()+2592e6;return localStorage.setItem("token_expiry",a.toString()),console.log("[Auth] 源代码预设账号登录成功:",o.name),console.log("  - Token:",s.tokens.accessToken.substring(0,30)+"..."),s}const n={}[s];if(n&&n.password===a){const e={user:n.user,tokens:{accessToken:`mock-token-${Date.now()}`,refreshToken:`mock-refresh-${Date.now()}`},expiresIn:3600};this.api.setAuthToken(e.tokens.accessToken),localStorage.setItem("refresh_token",e.tokens.refreshToken),localStorage.setItem("user_info",JSON.stringify(e.user));const t=Date.now()+2592e6;return localStorage.setItem("token_expiry",t.toString()),console.log("[Auth] Mock API模式 - 登录成功:",e.user.username),console.log("  - Token:",e.tokens.accessToken.substring(0,30)+"..."),e}throw new Error("用户名或密码错误。请使用用户管理中的真实账号登录。")}console.log("[Auth] 使用真实后端API登录:",e.username);const s=await this.api.post("/auth/login",e);return console.log("[Auth] 真实API登录成功，TOKEN已获取"),console.log("[Auth] 用户:",s.user?.realName||s.user?.username),console.log("[Auth] TOKEN:",s.tokens?.accessToken?.substring(0,30)+"..."),s}catch(t){throw console.error("[Auth] 登录失败:",t),t}}async logout(){try{await this.api.post("/auth/logout")}catch(e){console.warn("[Auth] 登出请求失败:",e)}finally{this.clearAuthData(),console.log("[Auth] 已清除本地认证数据")}}async refreshToken(){try{const e=localStorage.getItem("refresh_token");if(!e)throw new Error("没有刷新token");if(at()){const e=localStorage.getItem("user_info"),t={user:e?JSON.parse(e):{id:1,username:"admin",email:"admin@example.com",realName:"系统管理员",phone:"13800138000",avatar:"",role:"admin",status:"active",permissions:["*"],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},tokens:{accessToken:`mock-token-${Date.now()}`,refreshToken:`mock-refresh-${Date.now()}`},expiresIn:3600};this.api.setAuthToken(t.tokens.accessToken),localStorage.setItem("refresh_token",t.tokens.refreshToken),localStorage.setItem("user_info",JSON.stringify(t.user));const s=Date.now()+2592e6;return localStorage.setItem("token_expiry",s.toString()),console.log("[Auth] Mock API模式 - Token刷新成功"),t}const t=await this.api.post("/auth/refresh",{refreshToken:e});return t.tokens?.accessToken&&(this.api.setAuthToken(t.tokens.accessToken),localStorage.setItem("refresh_token",t.tokens.refreshToken),localStorage.setItem("user_info",JSON.stringify(t.user))),console.log("[Auth] Token刷新成功"),t}catch(e){throw console.error("[Auth] Token刷新失败:",e),this.clearAuthData(),e}}async getCurrentUser(e=!1){try{if(at()){const e=localStorage.getItem("user_info");if(e)try{const t=JSON.parse(e);return console.log("[Auth] Mock API模式 - 从本地存储返回用户数据:",t.username),t}catch(t){console.warn("[Auth] 解析本地用户信息失败，使用默认用户")}const s={id:1,username:"admin",email:"admin@example.com",realName:"系统管理员",phone:"13800138000",avatar:"",role:"admin",status:"active",permissions:["*"],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};return localStorage.setItem("user_info",JSON.stringify(s)),console.log("[Auth] Mock API模式 - 返回默认模拟用户数据"),s}const s=e?{metadata:{isTokenValidation:!0}}:void 0,a=await this.api.get("/auth/me",void 0,s);return localStorage.setItem("user_info",JSON.stringify(a)),a}catch(t){throw e||console.error("[Auth] 获取用户信息失败:",t),t}}async updateCurrentUser(e){try{const t=await this.api.put("/auth/me",e);return localStorage.setItem("user_info",JSON.stringify(t)),console.log("[Auth] 用户信息更新成功"),t}catch(t){throw console.error("[Auth] 更新用户信息失败:",t),t}}async changePassword(e){try{await this.api.put("/auth/password",e),console.log("[Auth] 密码修改成功")}catch(t){throw console.error("[Auth] 密码修改失败:",t),t}}async validateToken(){try{return!!localStorage.getItem("auth_token")&&(at()?(console.log("[Auth] Mock API模式 - Token验证通过"),!0):(await this.getCurrentUser(!0),!0))}catch(e){return!1}}isAuthenticated(){const e=localStorage.getItem("auth_token"),t=localStorage.getItem("user_info");return!(!e||!t)}getLocalUserInfo(){try{const e=localStorage.getItem("user_info");return e?JSON.parse(e):null}catch(e){return console.error("[Auth] 解析本地用户信息失败:",e),null}}getUserPermissions(){const e=this.getLocalUserInfo();return e?.permissions||[]}hasPermission(e){const t=this.getUserPermissions();return t.includes(e)||t.includes("*")}hasRole(e){const t=this.getLocalUserInfo();if(!t)return!1;return(Array.isArray(e)?e:[e]).includes(t.role)}isAdmin(){return this.hasRole(["admin","super_admin"])}isManagerOrAdmin(){return this.hasRole(["admin","super_admin","manager"])}getDefaultPermissions(e){const t={super_admin:["*"],admin:["*"],department_manager:["dashboard","dashboard:personal","dashboard:department","customer","customer:list","customer:view:personal","customer:view:department","customer:add","customer:edit","customer:import","customer:export","order","order:list","order:view:personal","order:view:department","order:add","order:edit","order:audit","performance","performance:personal","performance:team","logistics","logistics:list","logistics:view","data","data:customer","data:list"],manager:["dashboard","dashboard:personal","dashboard:department","customer","customer:list","customer:view:personal","customer:view:department","customer:add","customer:edit","customer:import","customer:export","order","order:list","order:view:personal","order:view:department","order:add","order:edit","order:audit","performance","performance:personal","performance:team","logistics","logistics:list","logistics:view","data","data:customer","data:list"],sales_staff:["dashboard","dashboard:personal","customer","customer:list","customer:view:personal","customer:add","order","order:list","order:view:personal","order:add","performance","performance:personal","logistics","logistics:list","logistics:view","data","data:customer","data:list"],customer_service:["customer","customer:list","customer:view:personal","service","service:call","service:sms","data","data:customer","data:list"]};return t[e]||t.sales_staff}clearAuthData(){this.api.clearAuthToken(),localStorage.removeItem("user_info"),localStorage.removeItem("token_expiry")}async autoRefreshToken(){try{const e=localStorage.getItem("auth_token"),t=localStorage.getItem("refresh_token");if(!e||!t)return;if(at())return void console.log("[Auth] Mock API模式 - 跳过token过期检查");const s=localStorage.getItem("token_expiry");if(s){const e=parseInt(s),t=Date.now();t>=e-3e5&&(console.log("[Auth] Token即将过期，自动刷新"),await this.refreshToken())}}catch(e){console.error("[Auth] 自动刷新token失败:",e)}}startAutoRefresh(){setInterval(()=>{this.autoRefreshToken()},3e5)}}const nt=ot.getInstance();"undefined"!=typeof window&&nt.startAutoRefresh();const it=Object.freeze(Object.defineProperty({__proto__:null,AuthApiService:ot,authApiService:nt},Symbol.toStringTag,{value:"Module"})),ct={BASE_URL:"/api/v1",TIMEOUT:1e4,HEADERS:{"Content-Type":"application/json",Accept:"application/json"}},lt={CUSTOMERS:{LIST:"/customers",CREATE:"/customers",UPDATE:e=>`/customers/${e}`,DELETE:e=>`/customers/${e}`,DETAIL:e=>`/customers/${e}`,SEARCH:"/customers/search",GROUPS:{LIST:"/customers/groups",CREATE:"/customers/groups",UPDATE:e=>`/customers/groups/${e}`,DELETE:e=>`/customers/groups/${e}`,DETAIL:e=>`/customers/groups/${e}`},TAGS:{LIST:"/customers/tags",CREATE:"/customers/tags",UPDATE:e=>`/customers/tags/${e}`,DELETE:e=>`/customers/tags/${e}`,DETAIL:e=>`/customers/tags/${e}`}},ORDERS:{LIST:"/orders",CREATE:"/orders",UPDATE:e=>`/orders/${e}`,DELETE:e=>`/orders/${e}`,DETAIL:e=>`/orders/${e}`,AUDIT:e=>`/orders/${e}/audit`,SUBMIT_AUDIT:e=>`/orders/${e}/submit-audit`,CANCEL_REQUEST:"/orders/cancel-request",PENDING_CANCEL:"/orders/pending-cancel",CANCEL_AUDIT:e=>`/orders/${e}/cancel-audit`,AUDITED_CANCEL:"/orders/audited-cancel",STATISTICS:"/orders/statistics",CHECK_TRANSFER:"/orders/check-transfer",UPDATE_MARK_TYPE:e=>`/orders/${e}/mark-type`},PRODUCTS:{LIST:"/products",CREATE:"/products",UPDATE:e=>`/products/${e}`,DELETE:e=>`/products/${e}`,DETAIL:e=>`/products/${e}`,CATEGORIES:{LIST:"/products/categories",CREATE:"/products/categories",UPDATE:e=>`/products/categories/${e}`,DELETE:e=>`/products/categories/${e}`,DETAIL:e=>`/products/categories/${e}`,TREE:"/products/categories/tree"}},USERS:{LOGIN:"/auth/login",LOGOUT:"/auth/logout",PROFILE:"/auth/profile",LIST:"/users",CREATE:"/users",UPDATE:e=>`/users/${e}`,DELETE:e=>`/users/${e}`},SYSTEM:{SETTINGS:"/system/settings",ROLES:"/system/roles",PERMISSIONS:"/system/permissions"},SMS:{TEMPLATES:"/sms/templates",APPROVALS:"/sms/approvals",SENDS:"/sms/sends",STATISTICS:"/sms/statistics",CONFIG:"/sms/config"},LOGISTICS:{LIST:"/logistics/list",COMPANIES:"/logistics/companies",TRACKING:"/logistics/tracking",TRACE:"/logistics/trace",BATCH_SYNC:"/logistics/batch-sync",UPDATE:e=>`/logistics/tracking/${e}`},CUSTOMER_SHARE:{HISTORY:"/customer-share/history",SHARE:"/customer-share/share",RECALL:"/customer-share/recall",MY_SHARED:"/customer-share/my-shared",SHARED_TO_ME:"/customer-share/shared-to-me",SHAREABLE_USERS:"/customer-share/shareable-users"},SMS:{TEMPLATES:"/sms/templates",APPROVALS:"/sms/approvals",SENDS:"/sms/sends",STATISTICS:"/sms/statistics",CONFIG:"/sms/config"}},dt=async(e,t={})=>{const{method:s="GET",headers:a={},params:r,data:o,timeout:n=ct.TIMEOUT}=t;console.log(`[API] ${s} ${e}`);const i={...ct.HEADERS,...a},c=localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token");c&&(i.Authorization=`Bearer ${c}`);const l={method:s,headers:i,signal:AbortSignal.timeout(n)};o&&["POST","PUT","PATCH"].includes(s)&&(l.body=JSON.stringify(o));try{const t=((e,t)=>{let s=`${ct.BASE_URL.replace(/\/+$/,"")}/${String(e||"").replace(/^\/+/,"")}`;if(t&&Object.keys(t).length>0){const e=new URLSearchParams;Object.keys(t).forEach(s=>{void 0!==t[s]&&null!==t[s]&&e.append(s,String(t[s]))});const a=e.toString();a&&(s+=`?${a}`)}return s})(e,r),s=await fetch(t,l);return await(async e=>{const t=e.headers.get("content-type");let s;if(s=t&&t.includes("application/json")?await e.json():await e.text(),!e.ok){const t=new Error(s?.message||`HTTP Error: ${e.status}`);throw t.status=e.status,t.data=s,t}return s})(s)}catch(d){if("AbortError"===d?.name)throw new Error("请求超时");throw d}},ut={get:(e,t)=>dt(e,{method:"GET",params:t}),post:(e,t)=>dt(e,{method:"POST",data:t}),put:(e,t)=>dt(e,{method:"PUT",data:t}),patch:(e,t)=>dt(e,{method:"PATCH",data:t}),delete:e=>dt(e,{method:"DELETE"})},mt=Object.freeze(Object.defineProperty({__proto__:null,api:ut,request:dt},Symbol.toStringTag,{value:"Module"}));var pt=(e=>(e.PENDING="pending",e.PICKED_UP="picked_up",e.IN_TRANSIT="in_transit",e.OUT_FOR_DELIVERY="out_for_delivery",e.DELIVERED="delivered",e.EXCEPTION="exception",e.REJECTED="rejected",e.RETURNED="returned",e))(pt||{});const gt=e=>ut.get("/logistics/trace",e),ht=e=>ut.post("/logistics/batch-sync",e),vt=gt,yt=e=>(e=>ut.get("/logistics/list",e))({page:e.page,pageSize:e.pageSize,trackingNo:e.keyword,status:e.status,startDate:e.dateRange?.[0],endDate:e.dateRange?.[1]}),ft=e=>{if(!e)return;const{dateRange:t,...s}=e,a={...s};return t&&(a.startDate=t[0],a.endDate=t[1]),a},_t={getList:async e=>(console.log("[customerApi.getList] 直接调用真实API"),ut.get(lt.CUSTOMERS.LIST,ft(e))),checkExists:async e=>{try{console.log("[customerApi.checkExists] 直接调用真实API验证"),console.log("验证手机号:",e);const t=await ut.get("/customers/check-exists",{phone:e});return console.log("后端API响应:",t),t.data?(console.log("后端返回：客户已存在:",t.data.name),{data:t.data,code:200,message:"该手机号已存在客户记录",success:!0}):(console.log("后端返回：客户不存在，可以创建"),{data:null,code:200,message:"该手机号不存在，可以创建",success:!0})}catch(t){return console.error("[customerApi.checkExists] 执行失败:",t),{data:null,code:500,message:"检查客户存在性失败",success:!1}}},create:async e=>{console.log("[customerApi.create] 直接调用真实API"),console.log("请求数据:",e),console.log("API端点:",lt.CUSTOMERS.CREATE);const t=await ut.post(lt.CUSTOMERS.CREATE,e);return console.log("API响应结果:",t),t},update:async(e,t)=>(console.log("[customerApi.update] 直接调用真实API"),ut.put(lt.CUSTOMERS.UPDATE(e),t)),delete:async e=>(console.log("[customerApi.delete] 直接调用真实API"),ut.delete(lt.CUSTOMERS.DELETE(e))),getDetail:async e=>(console.log("[customerApi.getDetail] 直接调用真实API"),ut.get(lt.CUSTOMERS.DETAIL(e))),search:async e=>(console.log("[customerApi.search] 直接调用真实API"),ut.get(lt.CUSTOMERS.SEARCH,ft(e)))},St=Object.freeze(Object.defineProperty({__proto__:null,customerApi:_t},Symbol.toStringTag,{value:"Module"}));function wt(){const e=function(){try{const e=JSON.parse(localStorage.getItem("crm_store_customer")||"[]");return new Set(e.map(e=>e.code).filter(Boolean))}catch{return new Set}}();let t="",s=0;do{const e=new Date,a=e.getFullYear().toString(),r=(e.getMonth()+1).toString().padStart(2,"0"),o=e.getDate().toString().padStart(2,"0"),n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let i="";for(let t=0;t<2;t++)i+=n.charAt(Math.floor(Math.random()*n.length));t=`${i}${a}${r}${o}${Math.floor(1e3+9e3*Math.random()).toString()}`,s++}while(e.has(t)&&s<100);if(e.has(t)){const e=Date.now().toString().slice(-3);t=t.slice(0,-3)+e}return t}async function At(e){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();const s=document.execCommand("copy");return document.body.removeChild(t),s}}catch(t){return console.error("复制到剪贴板失败:",t),!1}}const It={VERSION:"1.0.0",TTL:6048e5,SAVE_INTERVAL:3e5,MAX_STORAGE_SIZE:6291456,EXCLUDE_FIELDS:["password","token","secret","privateKey","sessionId"]};function Pt(){try{let e=0;for(let s=0;s<localStorage.length;s++){const t=localStorage.key(s);if(t){const s=localStorage.getItem(t);s&&(e+=t.length+s.length)}}const t=10485760;return{used:e,available:t-e,percentage:e/t*100}}catch(e){return console.error("获取存储使用情况失败:",e),{used:0,available:0,percentage:0}}}class Et{static instance;storageKeys=new Set;isStorageAvailable;static getInstance(){return Et.instance||(Et.instance=new Et),Et.instance}constructor(){this.isStorageAvailable=this.checkStorageAvailability()}checkStorageAvailability(){try{if("undefined"==typeof Storage||!window.localStorage)return console.warn("[Storage] localStorage不可用"),!1;const e="__storage_test__",t="test";localStorage.setItem(e,t);const s=localStorage.getItem(e);return localStorage.removeItem(e),s===t||(console.warn("[Storage] localStorage功能异常"),!1)}catch(e){return console.warn("[Storage] localStorage不可用:",e),!1}}checkStorageQuota(e){try{let t=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);if(s){const e=localStorage.getItem(s);e&&(t+=s.length+e.length)}}const s=It.MAX_STORAGE_SIZE;return!(t+2*e.length>s)}catch(t){return!0}}save(e,t){if(!this.isStorageAvailable)return console.warn(`[Storage] localStorage不可用，跳过保存 ${e.key}`),!1;try{const s={data:t,timestamp:Date.now(),version:e.version||"1.0.0",ttl:e.ttl},a=JSON.stringify(s);return this.checkStorageQuota(a)||(console.warn("[Storage] 存储空间不足，尝试清理过期数据"),this.cleanupExpiredData(),this.checkStorageQuota(a))?(localStorage.setItem(e.key,a),this.storageKeys.add(e.key),console.log(`[Storage] 已保存数据到 ${e.key}`),!0):(console.error(`[Storage] 存储空间仍然不足，无法保存 ${e.key}`),!1)}catch(s){if(console.error(`[Storage] 保存数据失败 ${e.key}:`,s),s instanceof DOMException&&22===s.code){console.warn("[Storage] 存储空间不足，尝试清理数据"),this.cleanupExpiredData();try{return localStorage.setItem(e.key,JSON.stringify({data:t,timestamp:Date.now(),version:e.version||"1.0.0",ttl:e.ttl})),this.storageKeys.add(e.key),console.log(`[Storage] 重试保存成功 ${e.key}`),!0}catch(a){console.error(`[Storage] 重试保存仍然失败 ${e.key}:`,a)}}return!1}}cleanupExpiredData(){try{const t=[];for(let s=0;s<localStorage.length;s++){const a=localStorage.key(s);if(a&&a.startsWith("crm_store_"))try{const e=localStorage.getItem(a);if(e){const s=JSON.parse(e);s.ttl&&Date.now()-s.timestamp>s.ttl&&t.push(a)}}catch(e){t.push(a)}}t.forEach(e=>{localStorage.removeItem(e),this.storageKeys.delete(e)}),t.length>0&&console.log(`[Storage] 已清理 ${t.length} 个过期数据`)}catch(e){console.error("[Storage] 清理过期数据失败:",e)}}load(e){if(!this.isStorageAvailable)return console.warn(`[Storage] localStorage不可用，跳过加载 ${e.key}`),null;try{const s=localStorage.getItem(e.key);if(!s)return null;let a;try{a=JSON.parse(s)}catch(t){return console.error(`[Storage] 数据格式错误，清除损坏数据 ${e.key}:`,t),this.remove(e.key),null}return a&&"object"==typeof a&&a.hasOwnProperty("data")?e.version&&a.version!==e.version?(console.warn(`[Storage] 版本不匹配，清除旧数据 ${e.key}`),this.remove(e.key),null):a.ttl&&Date.now()-a.timestamp>a.ttl?(console.warn(`[Storage] 数据已过期，清除 ${e.key}`),this.remove(e.key),null):(console.log(`[Storage] 已加载数据从 ${e.key}`),a.data):(console.warn(`[Storage] 数据结构无效，清除 ${e.key}`),this.remove(e.key),null)}catch(s){return console.error(`[Storage] 加载数据失败 ${e.key}:`,s),this.remove(e.key),null}}remove(e){localStorage.removeItem(e),this.storageKeys.delete(e),console.log(`[Storage] 已删除数据 ${e}`)}clear(){this.storageKeys.forEach(e=>{localStorage.removeItem(e)}),this.storageKeys.clear(),console.log("[Storage] 已清除所有数据")}getStats(){let e=0;const t=Array.from(this.storageKeys);return t.forEach(t=>{const s=localStorage.getItem(t);s&&(e+=s.length)}),{keys:t,totalSize:e}}}const Tt=new Map;function Ct(s,a,r={}){if(Tt.has(s))return console.log(`[Storage] 返回已存在的store实例: ${s}`),Tt.get(s);console.log(`[Storage] 创建新的store实例: ${s}`);const o=e(s,()=>{const e={key:`crm_store_${s}`,version:r.version||"1.0.0",ttl:r.ttl},o=Et.getInstance(),n=a(),i=o.load(e);if(console.log(`[Store] ${s} 尝试恢复数据:`,i?`找到数据，字段: ${Object.keys(i).join(", ")}`:"未找到数据"),i&&"object"==typeof i)try{Object.keys(i).forEach(e=>{if(n[e]&&"object"==typeof n[e]&&"value"in n[e])try{const t=typeof n[e].value,a=typeof i[e];if(t===a||Array.isArray(n[e].value)&&Array.isArray(i[e])){n[e].value=i[e];const t=Array.isArray(i[e])?i[e].length:"N/A";console.log(`[Store] ${s}.${e} 数据恢复成功，长度: ${t}`)}else console.warn(`[Store] ${s}.${e} 数据类型不匹配，跳过恢复`),console.warn(`[Store] 期望类型: ${t}, 实际类型: ${a}`),console.warn(`[Store] 期望数组: ${Array.isArray(n[e].value)}, 实际数组: ${Array.isArray(i[e])}`)}catch(t){console.warn(`[Store] 恢复字段 ${e} 失败:`,t)}}),console.log(`[Store] ✅ 已恢复 ${s} 的数据`)}catch(m){console.error(`[Store] ${s} 数据恢复过程中发生错误:`,m)}else console.log(`[Store] ${s} 没有找到持久化数据`);const c=()=>{try{const t={};Object.keys(n).forEach(e=>{if(n[e]&&"object"==typeof n[e]&&"value"in n[e])try{t[e]=JSON.parse(JSON.stringify(n[e].value))}catch(s){console.warn(`[Store] 序列化字段 ${e} 失败，跳过保存:`,s)}}),r.exclude&&r.exclude.length>0&&r.exclude.forEach(e=>{delete t[e]});o.save(e,t)?console.log(`[Store] ${s} 数据保存成功`,Object.keys(t).map(e=>`${e}: ${Array.isArray(t[e])?t[e].length:"N/A"}`).join(", ")):console.warn(`[Store] ${s} 数据保存失败`)}catch(m){console.error(`[Store] ${s} 保存过程中发生错误:`,m)}};let l=null,d=!1;const u=()=>{l&&(clearTimeout(l),l=null),d||(d=!0,c(),setTimeout(()=>{d=!1},100))};return Object.keys(n).forEach(e=>{n[e]&&"object"==typeof n[e]&&"value"in n[e]&&t(n[e],()=>{console.log(`[Store] ${s}.${e} 数据变化，触发保存`),l&&clearTimeout(l),l=setTimeout(()=>{d||(d=!0,c(),setTimeout(()=>{d=!1},100)),l=null},50)},{deep:!0,immediate:!1})}),setTimeout(()=>{console.log(`[Store] ${s} 初始保存检查（延迟200ms）`),c()},200),"undefined"!=typeof window&&(window.addEventListener("beforeunload",()=>{l&&(clearTimeout(l),l=null);try{const a={};Object.keys(n).forEach(e=>{if(n[e]&&"object"==typeof n[e]&&"value"in n[e])try{a[e]=JSON.parse(JSON.stringify(n[e].value))}catch(t){console.warn(`[Store] 序列化字段 ${e} 失败，跳过保存:`,t)}}),r.exclude&&r.exclude.length>0&&r.exclude.forEach(e=>{delete a[e]});try{o.save(e,a),console.log(`[Store] ${s} 页面卸载前立即保存完成`)}catch(t){if("QuotaExceededError"!==t.name&&!t.message?.includes("quota")&&!t.message?.includes("storage"))throw t;console.warn(`[Store] ${s} localStorage 容量不足，跳过保存`)}}catch(m){console.error(`[Store] ${s} 页面卸载前保存失败:`,m)}}),document.addEventListener("visibilitychange",()=>{document.hidden&&u()})),n&&"object"==typeof n&&(n.saveImmediately=u),r.saveInterval&&r.saveInterval>0?setInterval(()=>{c()},r.saveInterval):setInterval(()=>{c()},3e4),n});return Tt.set(s,o),console.log(`[Storage] 创建并缓存新的store实例: ${s}`),o}Et.getInstance();const Dt=Ct("customer",()=>{const e=s([]),t=`customer_store_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;console.log("=== CustomerStore 初始化（使用createPersistentStore） ==="),console.log("实例ID:",t),console.log("初始客户数量:",e.value.length);const r=()=>{console.log("initMockData 被调用 - 生产环境不初始化模拟数据"),console.log("当前客户数量:",e.value.length)},o=s(!1),n=s(null),i=a(()=>e.value.length),c=a(()=>e.value.filter(e=>"gold"===e.level)),l=a(()=>e.value.filter(e=>"silver"===e.level)),d=a(()=>e.value.filter(e=>"normal"===e.level)),u=a(()=>(console.log("Customer Store: 返回所有客户，避免循环依赖",e.value.length),e.value)),m=a(()=>u.value.length),p=a(()=>u.value.filter(e=>"gold"===e.level)),g=a(()=>u.value.filter(e=>"silver"===e.level)),h=a(()=>u.value.filter(e=>"normal"===e.level)),v=t=>e.value.find(e=>e.id===t),y=(t,s)=>{const a=e.value.find(e=>e.id===t);a&&void 0!==s.orderCount&&(a.orderCount=s.orderCount)},f=async t=>{try{o.value=!0,n.value=null,console.log("loadCustomers 被调用，参数:",t);const s=window.location.hostname,a=!("localhost"===s||"127.0.0.1"===s||s.includes("192.168")||s.includes("dev.")||s.includes("test."));if(console.log("[loadCustomers] hostname:",s,", isProdEnv:",a),!a)return console.log("开发环境：使用本地客户数据，不调用API"),console.log("当前本地客户数量:",e.value.length),e.value=e.value.sort((e,t)=>{const s=new Date(e.createTime).getTime();return new Date(t.createTime).getTime()-s}),console.log("loadCustomers 完成（开发环境），客户数量:",e.value.length),e.value;console.log("🌐 生产环境：强制调用真实API获取客户数据");const r=await _t.getList(t);if(!r||!r.data)throw new Error("API响应数据为空");if(!Array.isArray(r.data.list))return console.warn("API响应中list不是数组，保留现有数据:",r.data),void console.warn("当前客户数量:",e.value.length);{const t=[...e.value],s=r.data.list;console.log("loadCustomers - API返回客户数量:",s.length),console.log("loadCustomers - 当前内存客户数量:",t.length);const a=[...t];s.forEach(e=>{t.some(t=>t.id===e.id||t.phone===e.phone)||a.push(e)}),e.value=a.sort((e,t)=>{const s=new Date(e.createTime).getTime();return new Date(t.createTime).getTime()-s}),console.log("loadCustomers - 合并后客户数量:",e.value.length)}return console.log("loadCustomers 完成，客户数量:",e.value.length),console.log("当前客户列表:",e.value.map(e=>({id:e.id,name:e.name,phone:e.phone}))),e.value}catch(s){return n.value=s instanceof Error?s.message:"加载客户列表失败",console.error("加载客户列表失败:",s),console.log("API调用失败，保持当前客户数据不变，客户数量:",e.value.length),e.value}finally{o.value=!1}};r();const _={customers:e,loading:o,error:n,customerCount:i,goldCustomers:c,silverCustomers:l,normalCustomers:d,filteredCustomers:u,filteredCustomerCount:m,filteredGoldCustomers:p,filteredSilverCustomers:g,filteredNormalCustomers:h,addCustomer:t=>{console.log("addCustomer 开始，当前客户数量:",e.value.length);const s=ys().currentUser,a={...t,id:`customer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,code:wt(),createTime:(new Date).toISOString(),orderCount:0,status:"active",createdBy:s?.id||"admin",salesPersonId:t.salesPersonId||s?.id||"admin"};return console.log("准备添加新客户:",a),e.value.unshift(a),console.log("addCustomer 完成，客户数量:",e.value.length),a},updateCustomer:async(t,s)=>{const{isProduction:a}=await ge(async()=>{const{isProduction:e}=await import("./env-DLalhsF6.js");return{isProduction:e}},[]),{shouldUseMockApi:r}=await ge(async()=>{const{shouldUseMockApi:e}=await Promise.resolve().then(()=>rt);return{shouldUseMockApi:e}},void 0);if(a()||!r()){console.log("[CustomerStore] 🌐 生产环境：调用真实API更新客户");try{const{customerApi:a}=await ge(async()=>{const{customerApi:e}=await Promise.resolve().then(()=>St);return{customerApi:e}},void 0),r=await a.update(t,s);if(r.data){const s=e.value.findIndex(e=>e.id===t);return-1!==s&&(e.value[s]=r.data),console.log("[CustomerStore] ✅ API更新成功"),r.data}throw new Error(r.message||"更新客户失败")}catch(n){throw console.error("[CustomerStore] ❌ API更新失败:",n),n}}const o=e.value.findIndex(e=>e.id===t);return-1!==o?(e.value[o]={...e.value[o],...s},e.value[o]):null},deleteCustomer:async t=>{const{isProduction:s}=await ge(async()=>{const{isProduction:e}=await import("./env-DLalhsF6.js");return{isProduction:e}},[]),{shouldUseMockApi:a}=await ge(async()=>{const{shouldUseMockApi:e}=await Promise.resolve().then(()=>rt);return{shouldUseMockApi:e}},void 0);if(s()||!a()){console.log("[CustomerStore] 🌐 生产环境：调用真实API删除客户");try{const{customerApi:s}=await ge(async()=>{const{customerApi:e}=await Promise.resolve().then(()=>St);return{customerApi:e}},void 0);await s.delete(t);const a=e.value.findIndex(e=>e.id===t);return-1!==a&&e.value.splice(a,1),console.log("[CustomerStore] ✅ API删除成功"),!0}catch(o){throw console.error("[CustomerStore] ❌ API删除失败:",o),o}}const r=e.value.findIndex(e=>e.id===t);return-1!==r&&(e.value.splice(r,1),!0)},getCustomerById:v,getCustomerByCode:t=>e.value.find(e=>e.code===t),searchCustomers:async e=>{try{o.value=!0,n.value=null;return(await _t.search(e)).data.list}catch(t){return n.value=t instanceof Error?t.message:"搜索客户失败",console.error("搜索客户失败:",t),[]}finally{o.value=!1}},incrementOrderCount:t=>{const s=e.value.find(e=>e.id===t);s&&s.orderCount++},decrementOrderCount:t=>{const s=e.value.find(e=>e.id===t);s&&s.orderCount>0&&s.orderCount--},updateCustomerStats:y,batchUpdateCustomerStats:e=>{e.forEach(({customerId:e,stats:t})=>{y(e,t)})},loadCustomers:f,forceRefreshCustomers:async t=>(console.log("=== forceRefreshCustomers 被调用 ==="),console.log("当前客户数量:",e.value.length),console.log("刷新参数:",t),await f(t)),createCustomer:async s=>{console.log("🔥 createCustomer方法被调用！实例ID:",t),console.log("🔥 传入的客户数据:",s);const a=window.location.hostname,r=!("localhost"===a||"127.0.0.1"===a||a.includes("192.168")||a.includes("dev.")||a.includes("test."));if(console.log("[CustomerStore] 环境检测: hostname=",a,", isProdEnv=",r),r){console.log("[CustomerStore] 🌐 生产环境：调用真实API保存客户到数据库");try{const{customerApi:t}=await ge(async()=>{const{customerApi:e}=await Promise.resolve().then(()=>St);return{customerApi:e}},void 0),a={...s,code:wt()};console.log("[CustomerStore] 准备发送到API的数据:",a);const r=await t.create(a);if(console.log("[CustomerStore] API响应:",r),console.log("[CustomerStore] API响应类型:",typeof r),console.log("[CustomerStore] API响应.data:",r.data),console.log("[CustomerStore] API响应.success:",r.success),r.success&&r.data){const t={...r.data,code:a.code};return console.log("[CustomerStore] ✅ API保存成功，客户ID:",t.id,"客户编码:",t.code),e.value.unshift(t),console.log("[CustomerStore] 本地缓存已更新，客户总数:",e.value.length),t}if(r.success&&!r.data){console.warn("[CustomerStore] API成功但没有返回客户数据，尝试从响应中提取");const t=r;if(t.id||t.name)return e.value.unshift(t),t;throw new Error("API返回成功但没有客户数据")}throw console.error("[CustomerStore] API响应失败:",r),new Error(r.message||"创建客户失败")}catch(i){throw console.error("[CustomerStore] ❌ API保存失败:",i),i}}console.log("[CustomerStore] 💻 开发环境：使用本地存储");const o=new Date,n={...s,id:`customer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,code:wt(),createTime:o.toISOString(),orderCount:0};return console.log("[CustomerStore] 准备添加新客户:",n.name,"ID:",n.id),console.log("[CustomerStore] 保存前客户总数:",e.value.length),e.value.unshift(n),console.log("[CustomerStore] 添加后客户总数:",e.value.length),console.log("[CustomerStore] 客户创建时间:",n.createTime),setTimeout(()=>{const e=Dt();e&&"function"==typeof e.saveImmediately&&(e.saveImmediately(),console.log("[CustomerStore] ✅ 创建客户后立即保存完成"))},10),n},forceSyncData:async()=>{try{console.log("=== 强制数据同步开始 ===");const t=e.value.length;return console.log(`当前内存中客户数量: ${t}`),0===e.value.length&&(console.log("本地无数据，从API加载..."),await f()),console.log("=== 强制数据同步完成 ==="),console.log("最终客户数量:",e.value.length),e.value}catch(t){throw console.error("强制数据同步失败:",t),t}},getCustomerPhones:e=>{const t=v(e);return t?t.phones&&Array.isArray(t.phones)?t.phones:t.phone?[{id:"main",phone:t.phone,remark:"主电话",isDefault:!0}]:[]:(console.warn("未找到客户:",e),[])},addCustomerPhone:(e,t,s)=>{const a=v(e);if(!a)return console.warn("未找到客户:",e),!1;a.phones||(a.phones=[]);if(a.phones.find(e=>e.phone===t))return console.warn("电话号码已存在:",t),!1;const r={id:Date.now().toString(),phone:t,remark:s||"",isDefault:0===a.phones.length};return a.phones.push(r),1===a.phones.length&&(a.phone=t),console.log("已为客户添加电话号码:",a.name,t),!0},initMockData:r,instanceId:t};return _}),kt={SF:{name:"顺丰速运",code:"SF",apiCode:"shunfeng"},JD:{name:"京东物流",code:"JD",apiCode:"jd"},YTO:{name:"圆通速递",code:"YTO",apiCode:"yuantong"},ZTO:{name:"中通快递",code:"ZTO",apiCode:"zhongtong"},STO:{name:"申通快递",code:"STO",apiCode:"shentong"},YD:{name:"韵达速递",code:"YD",apiCode:"yunda"},HTKY:{name:"百世快递",code:"HTKY",apiCode:"huitongkuaidi"},EMS:{name:"中国邮政",code:"EMS",apiCode:"ems"},DBKD:{name:"德邦快递",code:"DBKD",apiCode:"debangkuaidi"},UC:{name:"优速快递",code:"UC",apiCode:"youshuwuliu"}},bt={customer:"demo_customer",key:"demo_key"};class Rt{static instance;cache=new Map;CACHE_DURATION=3e5;static getInstance(){return Rt.instance||(Rt.instance=new Rt),Rt.instance}async queryLogistics(e,t){const s=`${t}_${e}`,a=this.cache.get(s);if(a&&Date.now()-a.timestamp<this.CACHE_DURATION)return a.data;try{const a=await gt({trackingNo:e,companyCode:t});if(200===a.code&&a.data){const e=this.transformApiResponse(a.data);return this.cache.set(s,{data:e,timestamp:Date.now()}),e}throw new Error(a.message||"查询失败")}catch(r){console.error("物流查询失败:",r);try{return await this.mockApiCall(e,t)}catch(o){throw new Error("物流信息查询失败，请稍后重试")}}}transformApiResponse(e){if(e.traces&&Array.isArray(e.traces)){const t=e;return{trackingNumber:t.trackingNo,expressCompany:t.companyName||t.companyCode,currentStatus:t.status,tracks:t.traces?.map(e=>({time:new Date(e.traceTime).toISOString(),location:e.location,description:e.description,status:e.status,statusText:this.getDescriptionByStatus(e.status,t.companyName)}))||[],lastUpdateTime:t.lastUpdateTime?new Date(t.lastUpdateTime).toISOString():(new Date).toISOString(),estimatedDeliveryTime:t.estimatedDeliveryTime?new Date(t.estimatedDeliveryTime).toISOString():void 0}}return{trackingNumber:e.trackingNumber||"",expressCompany:e.expressCompany||"",currentStatus:e.status||pt.PENDING,tracks:e.traces?.map(e=>({time:e.time,location:e.location,description:e.description,status:e.status,statusText:e.statusText}))||[],lastUpdateTime:e.lastUpdateTime||(new Date).toISOString(),estimatedDeliveryTime:e.estimatedDeliveryTime}}async batchQueryLogistics(e){const t=e.map(e=>this.queryLogistics(e.trackingNumber,e.expressCompany).catch(t=>(console.error(`查询 ${e.trackingNumber} 失败:`,t),null)));return(await Promise.all(t)).filter(e=>null!==e)}async createLogisticsTracking(e,t,s,a=!0){try{const o=await(r={orderId:e,trackingNo:t,companyCode:s,autoSyncEnabled:a},ut.post("/logistics/tracking",r));if(200===o.code&&o.data)return V.success("物流跟踪创建成功"),o.data;throw new Error(o.message||"创建失败")}catch(o){return console.error("创建物流跟踪失败:",o),V.error("创建物流跟踪失败"),null}var r}async getSupportedCompanies(){try{const e=await ut.get("/logistics/companies");return 200===e.code&&e.data?e.data.companies||[]:Object.values(kt).map(e=>({code:e.apiCode,name:e.name,phone:"400-000-0000"}))}catch(e){return console.error("获取快递公司列表失败:",e),Object.values(kt).map(e=>({code:e.apiCode,name:e.name,phone:"400-000-0000"}))}}async syncLogisticsStatus(e,t){try{const s=`${t}_${e}`;this.cache.delete(s);const a=await this.queryLogistics(e,t);return this.emitStatusUpdate(a),a}catch(s){return console.error("物流状态同步失败:",s),null}}async batchSyncLogistics(e){try{const t=await ht({trackingIds:e});if(200===t.code)return V.success("批量同步成功"),this.cache.clear(),!0;throw new Error(t.message||"同步失败")}catch(t){return console.error("批量同步物流状态失败:",t),V.error("批量同步失败"),!1}}async mockApiCall(e,t){const s=kt[t];if(!s)throw new Error("不支持的物流公司");try{const t=await this.callKuaidi100API(e,s.apiCode);if(t&&t.data&&t.data.length>0){const a=t.data.map(e=>({time:e.time,location:e.context||"未知位置",description:e.context||"状态更新",status:this.mapApiStatusToLogisticsStatus(e.status)})),r=a.length>0?a[0].status:pt.PENDING;return{trackingNumber:e,expressCompany:s.name,currentStatus:r,tracks:a,lastUpdateTime:(new Date).toLocaleString("zh-CN"),estimatedDeliveryTime:r===pt.DELIVERED?void 0:new Date(Date.now()+864e5).toLocaleString("zh-CN")}}return this.generateMockData(e,s)}catch(a){return console.warn("调用快递API失败，使用模拟数据:",a),this.generateMockData(e,s)}}async callKuaidi100API(e,t){const s={customer:bt.customer,sign:this.generateSign(e,t),param:JSON.stringify({com:t,num:e,phone:"",from:"",to:"",resultv2:"1"})},a=await fetch("https://poll.kuaidi100.com/poll/query.do",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(s)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=await a.json();if("200"!==r.returnCode)throw new Error(r.message||"查询失败");return r}generateSign(e,t){const s=JSON.stringify({com:t,num:e});return btoa(s+bt.key+bt.customer)}mapApiStatusToLogisticsStatus(e){return{0:pt.PENDING,1:pt.PICKED_UP,2:pt.IN_TRANSIT,3:pt.DELIVERED,4:pt.REJECTED,5:pt.OUT_FOR_DELIVERY,6:pt.RETURNED,7:pt.EXCEPTION}[e]||pt.PENDING}generateMockData(e,t){const s=[pt.PENDING,pt.PICKED_UP,pt.IN_TRANSIT,pt.OUT_FOR_DELIVERY,pt.DELIVERED],a=Math.floor(Math.random()*s.length),r=s[a],o=[],n=new Date;for(let i=0;i<=a;i++){const e=s[i],r=new Date(n.getTime()-24*(a-i)*60*60*1e3);o.push({time:r.toLocaleString("zh-CN"),location:this.getLocationByStatus(e),description:this.getDescriptionByStatus(e,t.name),status:e,statusText:Nt(e)})}return{trackingNumber:e,expressCompany:t.name,currentStatus:r,tracks:o.reverse(),lastUpdateTime:(new Date).toLocaleString("zh-CN"),estimatedDeliveryTime:r===pt.DELIVERED?void 0:new Date(Date.now()+864e5).toLocaleString("zh-CN")}}getLocationByStatus(e){return{[pt.PENDING]:"发货地",[pt.PICKED_UP]:"分拨中心",[pt.IN_TRANSIT]:"转运中心",[pt.OUT_FOR_DELIVERY]:"派送网点",[pt.DELIVERED]:"收货地址",[pt.EXCEPTION]:"中转站",[pt.REJECTED]:"收货地址",[pt.RETURNED]:"退货仓库"}[e]||"未知位置"}getDescriptionByStatus(e,t){return{[pt.PENDING]:`${t}已接单，等待揽收`,[pt.PICKED_UP]:"快件已被揽收",[pt.IN_TRANSIT]:"快件正在运输途中",[pt.OUT_FOR_DELIVERY]:"快件已到达派送网点，正在安排派送",[pt.DELIVERED]:"快件已签收，感谢使用",[pt.EXCEPTION]:"快件运输异常，正在处理",[pt.REJECTED]:"客户拒绝签收",[pt.RETURNED]:"快件已退回发货地"}[e]||"状态更新"}emitStatusUpdate(e){window.dispatchEvent(new CustomEvent("logistics-status-update",{detail:e}))}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}const Ot=Rt.getInstance(),Nt=e=>({[pt.PENDING]:"待揽收",[pt.PICKED_UP]:"已揽收",[pt.IN_TRANSIT]:"运输中",[pt.OUT_FOR_DELIVERY]:"派送中",[pt.DELIVERED]:"已签收",[pt.EXCEPTION]:"异常",[pt.REJECTED]:"拒收",[pt.RETURNED]:"已退回"}[e]||"未知状态"),Mt=Object.freeze(Object.defineProperty({__proto__:null,LOGISTICS_COMPANIES:kt,LogisticsStatus:pt,getLogisticsStatusText:Nt,logisticsService:Ot},Symbol.toStringTag,{value:"Module"}));const Lt=new class{events={};on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(t?this.events[e]=this.events[e].filter(e=>e!==t):delete this.events[e])}emit(e,...t){this.events[e]&&this.events[e].forEach(s=>{try{s(...t)}catch(a){console.error(`[EventBus] 事件 "${e}" 回调执行出错:`,a)}})}once(e,t){const s=(...a)=>{t(...a),this.off(e,s)};this.on(e,s)}clear(){this.events={}}},Ut={ORDER_STATUS_CHANGED:"order:status:changed",ORDER_CREATED:"order:created",ORDER_UPDATED:"order:updated",ORDER_DELETED:"order:deleted",ORDER_TRANSFERRED:"order:transferred",ORDER_AUDITED:"order:audited",ORDER_SHIPPED:"order:shipped",ORDER_CANCELLED:"order:cancelled",ORDER_RETURNED:"order:returned",REFRESH_ORDER_LIST:"refresh:order:list",REFRESH_AUDIT_LIST:"refresh:audit:list",REFRESH_SHIPPING_LIST:"refresh:shipping:list",REFRESH_LOGISTICS_LIST:"refresh:logistics:list"},xt=Ct("order",()=>{const e=ys(),t=t=>{const s=e.currentUser;if(!s)return[];if(console.log("[数据权限] getVisibleOrders - 当前用户:",{id:s.id,name:s.name,role:s.role}),"admin"===s.role||"manager"===s.role||"department_manager"===s.role)return console.log("[数据权限] 管理员/经理角色，可查看全部订单:",t.length),t;if("sales_staff"===s.role||"employee"===s.role){const e=t.filter(e=>{const t=e.salesPersonId===s.id||e.createdBy===s.name;return t&&console.log("[数据权限] 销售员订单匹配:",e.orderNumber,e.salesPersonId,s.id,e.createdBy,s.name),t});return console.log("[数据权限] 销售员，可查看自己的订单:",e.length),e}if("customer_service"===s.role){const e=t.filter(e=>e.servicePersonId===s.id);return console.log("[数据权限] 客服，可查看自己处理的订单:",e.length),e}const a=t.filter(e=>e.salesPersonId===s.id||e.createdBy===s.name);return console.log("[数据权限] 其他角色，可查看自己的订单:",a.length),a},r=s([]),o=s(3);let n=null,i=null;const c=a(()=>r.value.length),l=a(()=>r.value.filter(e=>"pending_transfer"===e.status).length),d=e=>r.value.find(t=>t.id===e),u=e=>{r.value.push(e)},m=(e,t)=>{const s=r.value.findIndex(t=>t.id===e);if(-1!==s){const a={...r.value[s],...t};r.value[s]=a,console.log(`[订单Store] 更新订单 ${e}，新状态:`,{status:a.status,auditStatus:a.auditStatus,hasBeenAudited:a.hasBeenAudited})}else console.warn(`[订单Store] 未找到订单 ${e}`)},p=()=>{const e=new Date;return`ORD${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${e.getTime().toString().slice(-6)}`},g=async e=>{try{const t=await Ot.queryLogistics(e),s=r.value.find(t=>t.trackingNumber===e);return s&&t&&m(s.id,{logisticsStatus:t.status,logisticsHistory:t.traces}),t}catch(t){return console.error("更新物流状态失败:",t),null}},h=async()=>{const e=r.value.filter(e=>"shipped"===e.status&&e.trackingNumber&&"delivered"!==e.logisticsStatus),t=await Promise.allSettled(e.map(e=>g(e.trackingNumber)));return t},v=async()=>{const e=new Date,t=window.location.hostname;if(t.includes("abc789.cn")||t.includes("vercel.app")||t.includes("netlify.app")||t.includes("railway.app")||!t.includes("localhost")&&!t.includes("127.0.0.1")){try{console.log("[订单流转] 🌐 生产环境：调用后端API检查流转");const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3])),t=await e.checkTransfer();t.success&&t.data?.transferredCount>0?(console.log(`[订单流转] ✅ 后端流转成功: ${t.data.transferredCount} 个订单`),await f(),Lt.emit(Ut.ORDER_TRANSFERRED,t.data.orders||[]),Lt.emit(Ut.REFRESH_ORDER_LIST),Lt.emit(Ut.REFRESH_AUDIT_LIST)):console.log("[订单流转] 没有需要流转的订单")}catch(n){console.error("[订单流转] ❌ 后端API调用失败:",n)}return}console.log("[订单流转] 💻 开发环境：本地执行流转检查");let s=!1;const a=[];r.value.forEach(t=>{if("pending_transfer"===t.status&&t.auditTransferTime){const r=new Date(t.auditTransferTime);e>=r&&!t.isAuditTransferred&&(m(t.id,{status:"pending_audit",auditStatus:"pending",isAuditTransferred:!0}),t.statusHistory&&t.statusHistory.push({status:"pending_audit",time:e.toISOString().slice(0,19).replace("T"," "),operator:"system",description:"订单自动流转到审核状态",remark:`${o.value}分钟后自动流转`}),t.operationLogs&&t.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:e.toISOString().slice(0,19).replace("T"," "),operator:"system",action:"自动流转",description:"订单自动流转到审核状态",remark:"系统自动执行"}),s=!0,a.push(t))}}),s&&(console.log(`[订单流转] 共有 ${a.length} 个订单自动流转到审核状态`),Lt.emit(Ut.ORDER_TRANSFERRED,a),Lt.emit(Ut.REFRESH_ORDER_LIST),Lt.emit(Ut.REFRESH_AUDIT_LIST))};let y=0;const f=async(e=!1)=>{const t=window.location.hostname,s=t.includes("abc789.cn")||t.includes("vercel.app")||t.includes("netlify.app")||t.includes("railway.app")||!t.includes("localhost")&&!t.includes("127.0.0.1"),a=Date.now();if(!e&&r.value.length>0&&a-y<2e3)return console.log("[OrderStore] 使用缓存数据，跳过API请求"),r.value;try{const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3]));console.log("[OrderStore] 正在从API加载订单列表...");const t=await e.getList({page:1,pageSize:100});if(t&&t.data&&t.data.list)return r.value=t.data.list,y=a,console.log(`[OrderStore] ✅ 从API加载了 ${t.data.list.length} 个订单`),t.data.list;if(t&&!1===t.success)throw console.error("[OrderStore] API返回失败:",t),new Error("API返回失败");return s?(console.log("[OrderStore] 生产环境：API返回空数据，订单列表为空"),r.value=[],[]):[]}catch(o){return console.error("[OrderStore] ❌ 从API加载订单失败:",o),s?(console.warn("[OrderStore] 生产环境：API失败，不使用本地数据"),r.value=[],[]):(console.warn("[OrderStore] 开发环境：使用本地数据"),[])}},_=async(e,t,s)=>{try{const{orderApi:a}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3])),r=ys(),o=await a.cancelAudit(e,{action:t,remark:s,auditorId:r.currentUser?.id||""});if(o&&o.success){return m(e,{status:"approve"===t?"cancelled":"cancel_failed",cancelStatus:"approve"===t?"approved":"rejected"}),{success:!0,message:o.message}}return{success:!1,message:"审核失败"}}catch(a){return console.error("Order Store: 审核取消订单失败:",a),{success:!1,message:"审核失败"}}};return{orders:r,totalOrders:c,pendingOrders:l,transferDelayMinutes:o,getOrders:()=>t(r.value),getOrderById:d,getOrderByNumber:e=>r.value.find(t=>t.orderNumber===e),addOrder:u,createOrder:async t=>{const s=new Date,a=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`,n={orderNumber:p(),customerId:t.customerId,customerName:t.customerName||"",customerPhone:t.customerPhone||"",products:t.products||[],subtotal:Number(t.subtotal)||0,discount:Number(t.discount)||0,totalAmount:Number(t.totalAmount)||0,collectAmount:Number(t.collectAmount)||0,depositAmount:Number(t.depositAmount)||0,depositScreenshot:t.depositScreenshot,depositScreenshots:t.depositScreenshots,receiverName:t.receiverName||"",receiverPhone:t.receiverPhone||"",receiverAddress:t.receiverAddress||"",remark:t.remark||"",status:"pending_transfer",auditStatus:"pending",markType:t.markType||"normal",createdBy:t.createdBy||e.currentUser?.name||"system",salesPersonId:t.salesPersonId||e.currentUser?.id||"1",expressCompany:t.expressCompany,serviceWechat:t.serviceWechat||"",orderSource:t.orderSource||""},i=window.location.hostname,c=i.includes("abc789.cn")||i.includes("vercel.app")||i.includes("netlify.app")||i.includes("railway.app")||!i.includes("localhost")&&!i.includes("127.0.0.1");if(console.log("[OrderStore] 环境检测: hostname=",i,", isProdEnv=",c),c){console.log("[OrderStore] 🌐 生产环境：调用真实API保存订单到数据库");try{const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3]));console.log("[OrderStore] 准备发送到API的数据:",n);const t=await e.create(n);if(console.log("[OrderStore] API响应:",t),t.success&&t.data){const e=t.data;return console.log("[OrderStore] ✅ API保存成功，订单ID:",e.id),r.value.unshift(e),console.log("[OrderStore] 本地缓存已更新，订单总数:",r.value.length),e}throw console.error("[OrderStore] API响应失败:",t),new Error(t.message||"创建订单失败")}catch(h){throw console.error("[OrderStore] ❌ API保存失败:",h),h}}console.log("[OrderStore] 💻 开发环境：使用本地存储");const l=`order_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,d={...n,id:l,createTime:a(s)},m=60*o.value*1e3,g=new Date(s.getTime()+m);return d.auditTransferTime=a(g),d.isAuditTransferred=!1,console.log("[订单创建] 流转时间设置:",{"当前时间":a(s),"流转时间":d.auditTransferTime,"延迟分钟":o.value,"剩余毫秒":g.getTime()-s.getTime()}),d.statusHistory=[{status:"pending_transfer",time:a(s),operator:d.createdBy,description:"订单创建成功",remark:t.remark||"客户下单"}],d.operationLogs=[{id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:a(s),operator:d.createdBy,action:"创建订单",description:"订单创建成功",remark:t.remark||""}],u(d),d},updateOrder:m,deleteOrder:e=>{const t=r.value.findIndex(t=>t.id===e);-1!==t&&r.value.splice(t,1)},generateOrderNumber:p,auditOrder:async(t,s,a)=>{const r=d(t);if(r){const n=e.currentUser,i=(new Date).toISOString().slice(0,19).replace("T"," "),c=window.location.hostname;if(c.includes("abc789.cn")||c.includes("vercel.app")||c.includes("netlify.app")||c.includes("railway.app")||!c.includes("localhost")&&!c.includes("127.0.0.1"))try{console.log("[OrderStore] 生产环境：调用API审核订单");const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3]));await e.audit(t,{auditStatus:s?"approved":"rejected",auditRemark:a}),console.log("[OrderStore] API审核成功")}catch(o){console.error("[OrderStore] API审核失败:",o)}m(t,{auditStatus:s?"approved":"rejected",auditTime:i,auditBy:n?.name||"unknown",auditRemark:a,status:s?"pending_shipment":"audit_rejected",hasBeenAudited:!0}),r.statusHistory&&r.statusHistory.push({status:s?"pending_shipment":"audit_rejected",time:i,operator:n?.name||"unknown",description:s?"订单审核通过，等待发货":"订单审核被拒绝",remark:a}),r.operationLogs&&r.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:i,operator:n?.name||"unknown",action:s?"审核通过":"审核拒绝",description:s?"订单审核通过，等待发货":"订单审核被拒绝",remark:a}),console.log(`[订单审核] 订单 ${r.orderNumber} 审核${s?"通过":"拒绝"}`),Lt.emit(Ut.ORDER_AUDITED,{order:r,approved:s,remark:a}),Lt.emit(Ut.ORDER_STATUS_CHANGED,r),s?(Lt.emit(Ut.REFRESH_SHIPPING_LIST),console.log(`[订单流转] 订单 ${r.orderNumber} 已流转到发货列表`)):(Lt.emit(Ut.REFRESH_ORDER_LIST),console.log(`[订单退回] 订单 ${r.orderNumber} 已退回订单列表`)),Lt.emit(Ut.REFRESH_AUDIT_LIST)}},shipOrder:async(t,s,a)=>{const r=d(t);if(r){const n=e.currentUser,i=(new Date).toISOString().slice(0,19).replace("T"," "),c=window.location.hostname;if(c.includes("abc789.cn")||c.includes("vercel.app")||c.includes("netlify.app")||c.includes("railway.app")||!c.includes("localhost")&&!c.includes("127.0.0.1"))try{console.log("[OrderStore] 生产环境：调用API更新发货信息");const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3]));await e.update(t,{status:"shipped",shippingTime:i,expressCompany:s,trackingNumber:a,logisticsStatus:"picked_up"}),console.log("[OrderStore] API发货更新成功")}catch(o){console.error("[OrderStore] API发货更新失败:",o)}m(t,{status:"shipped",shippingTime:i,expressCompany:s,trackingNumber:a,logisticsStatus:"picked_up"}),r.statusHistory&&r.statusHistory.push({status:"shipped",time:i,operator:n?.name||"unknown",description:"订单已发货",remark:`${s}，单号：${a}`}),r.operationLogs&&r.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:i,operator:n?.name||"unknown",action:"订单发货",description:`订单已通过${s}发货，快递单号：${a}`,remark:"正常发货"}),console.log(`[订单发货] 订单 ${r.orderNumber} 已发货，快递单号：${a}`),Lt.emit(Ut.ORDER_SHIPPED,{order:r,expressCompany:s,trackingNumber:a}),Lt.emit(Ut.ORDER_STATUS_CHANGED,r),Lt.emit(Ut.REFRESH_SHIPPING_LIST),Lt.emit(Ut.REFRESH_LOGISTICS_LIST),console.log(`[订单流转] 订单 ${r.orderNumber} 已流转到物流列表`)}},returnOrder:(t,s)=>{const a=d(t);if(a){const r=e.currentUser,o=(new Date).toISOString().slice(0,19).replace("T"," ");let n="rejected_returned";return"shipped"!==a.status&&"pending_shipment"!==a.status||(n="logistics_returned"),m(t,{status:n,returnReason:s,returnTime:o}),a.statusHistory&&a.statusHistory.push({status:n,time:o,operator:r?.name||"unknown",description:"订单已退回",remark:s}),a.operationLogs&&a.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:o,operator:r?.name||"unknown",action:"退回订单",description:"订单已退回",remark:s}),console.log(`[订单退回] 订单 ${a.orderNumber} 已退回，原因：${s}`),Lt.emit(Ut.ORDER_RETURNED,{order:a,reason:s}),Lt.emit(Ut.ORDER_STATUS_CHANGED,a),Lt.emit(Ut.REFRESH_ORDER_LIST),Lt.emit(Ut.REFRESH_SHIPPING_LIST),Lt.emit(Ut.REFRESH_LOGISTICS_LIST),a}return null},cancelOrder:(t,s)=>{const a=d(t);if(a){const r=e.currentUser,o=(new Date).toISOString().slice(0,19).replace("T"," ");m(t,{status:"cancelled",cancelReason:s,cancelTime:o}),a.statusHistory&&a.statusHistory.push({status:"cancelled",time:o,operator:r?.name||"unknown",description:"订单已取消",remark:s}),a.operationLogs&&a.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:o,operator:r?.name||"unknown",action:"取消订单",description:"订单已取消",remark:s}),console.log(`[订单取消] 订单 ${a.orderNumber} 已取消，原因：${s}`),Lt.emit(Ut.ORDER_CANCELLED,{order:a,reason:s}),Lt.emit(Ut.ORDER_STATUS_CHANGED,a),Lt.emit(Ut.REFRESH_ORDER_LIST),Lt.emit(Ut.REFRESH_SHIPPING_LIST),Lt.emit(Ut.REFRESH_LOGISTICS_LIST)}},approveCancelOrders:async t=>{try{const a=e.currentUser,r=(new Date).toISOString().slice(0,19).replace("T"," ");let o=0,n=0;for(const e of t){try{const t=await _(e,"approve","审核通过");t.success?(n++,console.log(`[订单取消审核] API审核通过成功: ${e}`)):console.warn(`[订单取消审核] API调用失败: ${t.message}`)}catch(s){console.warn("[订单取消审核] API调用异常:",s)}const t=d(e);t&&(m(e,{status:"cancelled",cancelStatus:"approved",cancelTime:r}),t.statusHistory&&t.statusHistory.push({status:"cancelled",time:r,operator:a?.name||"unknown",description:"取消订单审核通过",remark:t.cancelReason||"审核通过"}),t.operationLogs&&t.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:r,operator:a?.name||"unknown",action:"审核通过取消订单",description:"取消订单审核通过",remark:t.cancelReason||"审核通过"}),Lt.emit(Ut.ORDER_STATUS_CHANGED,t),console.log(`[订单取消审核] 本地订单 ${t.orderNumber} 更新成功`)),o++}return o>0||n>0?(Lt.emit(Ut.REFRESH_ORDER_LIST),!0):(console.warn("[订单取消审核] 没有成功处理任何订单"),!1)}catch(a){return console.error("[订单取消审核] 审核通过失败:",a),!1}},rejectCancelOrders:async t=>{try{const a=e.currentUser,r=(new Date).toISOString().slice(0,19).replace("T"," ");let o=0,n=0;for(const e of t){try{const t=await _(e,"reject","审核拒绝");t.success?(n++,console.log(`[订单取消审核] API审核拒绝成功: ${e}`)):console.warn(`[订单取消审核] API调用失败: ${t.message}`)}catch(s){console.warn("[订单取消审核] API调用异常:",s)}const t=d(e);if(t){let s="pending_shipment";s="approved"===t.auditStatus?"pending_shipment":"pending"===t.auditStatus?"pending_audit":"pending_transfer",m(e,{status:s,cancelStatus:"rejected",cancelTime:r}),t.statusHistory&&t.statusHistory.push({status:s,time:r,operator:a?.name||"unknown",description:"取消订单审核拒绝，订单已恢复",remark:t.cancelReason||"审核拒绝"}),t.operationLogs&&t.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:r,operator:a?.name||"unknown",action:"审核拒绝取消订单",description:"取消订单审核拒绝，订单已恢复",remark:t.cancelReason||"审核拒绝"}),Lt.emit(Ut.ORDER_STATUS_CHANGED,t),console.log(`[订单取消审核] 本地订单 ${t.orderNumber} 更新成功`)}o++}return o>0||n>0?(Lt.emit(Ut.REFRESH_ORDER_LIST),!0):(console.warn("[订单取消审核] 没有成功处理任何订单"),!1)}catch(a){return console.error("[订单取消审核] 审核拒绝失败:",a),!1}},updateLogisticsStatus:g,batchUpdateLogisticsStatus:h,getOrderStats:()=>{const e=t(r.value);return{total:e.length,pending:e.filter(e=>"pending_transfer"===e.status).length,pendingAudit:e.filter(e=>"pending_audit"===e.status).length,pendingShipment:e.filter(e=>"pending_shipment"===e.status).length,shipped:e.filter(e=>"shipped"===e.status).length,delivered:e.filter(e=>"delivered"===e.status).length,cancelled:e.filter(e=>"cancelled"===e.status).length}},searchOrders:e=>{const s=t(r.value);return e?s.filter(t=>t.orderNumber.toLowerCase().includes(e.toLowerCase())||t.customerName.toLowerCase().includes(e.toLowerCase())||t.customerPhone.includes(e)||t.receiverName.toLowerCase().includes(e.toLowerCase())||t.receiverPhone.includes(e)):s},filterOrdersByStatus:e=>{const s=t(r.value);return"all"===e?s:s.filter(t=>t.status===e)},filterOrdersByDateRange:(e,s)=>t(r.value).filter(t=>{const a=t.createTime.split(" ")[0];return a>=e&&a<=s}),getOrdersByShippingStatus:s=>{const a=e.currentUser;if(!a)return[];console.log("[发货列表] 获取订单，标签页:",s,"总订单数:",r.value.length);let o=[];"admin"===a.role||"manager"===a.role||"department_manager"===a.role?(o=r.value,console.log("[发货列表] 管理员/经理角色，可查看全部订单")):(o=t(r.value),console.log("[发货列表] 其他角色，权限过滤后的订单数:",o.length));let n=[];switch(s){case"pending":n=o.filter(e=>{const t="pending_shipment"===e.status;return t&&console.log("[发货列表] ✅ 待发货订单:",e.orderNumber,e.status,e.auditStatus),t}),console.log("[发货列表] 待发货订单数量:",n.length);break;case"shipped":n=o.filter(e=>"shipped"===e.status||"delivered"===e.status),console.log("[发货列表] 已发货订单数量:",n.length);break;case"returned":n=o.filter(e=>"logistics_returned"===e.status||"rejected_returned"===e.status||"audit_rejected"===e.status),console.log("[发货列表] 退回订单数量:",n.length);break;case"cancelled":n=o.filter(e=>"cancelled"===e.status||"logistics_cancelled"===e.status),console.log("[发货列表] 取消订单数量:",n.length);break;case"draft":n=o.filter(e=>"draft"===e.status),console.log("[发货列表] 草稿订单数量:",n.length);break;default:n=o}return n},checkAndTransferOrders:v,startAutoTransferTask:()=>{i&&clearInterval(i),console.log("[订单流转] 定时任务已启动，每分钟检查一次"),i=setInterval(()=>{console.log("[订单流转] 执行定时检查..."),v()},6e4)},stopAutoTransferTask:()=>{i&&(clearInterval(i),i=null,console.log("[订单流转] 定时任务已停止"))},loadTransferDelayConfig:async()=>{try{const e=localStorage.getItem("auth_token"),t=await fetch("/api/v1/system/order-transfer-config",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),s=await t.json();s.success&&s.data&&(o.value=s.data.delayMinutes??3,console.log("[订单Store] 流转延迟时间配置:",o.value,"分钟"))}catch(e){console.warn("[订单Store] 获取流转延迟配置失败，使用默认值:",o.value,"分钟")}},setupLogisticsEventListener:()=>{console.log("物流事件监听器已设置")},startLogisticsAutoSync:()=>{n&&clearInterval(n),console.log("物流自动同步已启动"),n=setInterval(()=>{h()},18e5)},stopLogisticsAutoSync:()=>{n&&(clearInterval(n),n=null,console.log("物流自动同步已停止"))},getOperationLogs:e=>{const t=d(e);return t?.operationLogs||[]},getOrderStatusHistory:e=>{const t=d(e);return t?.statusHistory||[]},syncOrderStatus:(e,t,s,a)=>{const r=d(e);if(r){const o=(new Date).toISOString().slice(0,19).replace("T"," ");m(e,{status:t}),r.statusHistory||(r.statusHistory=[]),r.statusHistory.push({status:t,time:o,operator:s,description:a,remark:""}),r.operationLogs||(r.operationLogs=[]),r.operationLogs.push({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,time:o,operator:s,action:"状态变更",description:a,remark:""})}},queryLogisticsTrack:async e=>{const t=d(e);if(!t)return null;const s=t.trackingNumber||t.expressNo,a=t.expressCompany;if(!s||!a)return null;try{const{logisticsService:r}=await ge(async()=>{const{logisticsService:e}=await Promise.resolve().then(()=>Mt);return{logisticsService:e}},void 0),o=await r.queryLogistics(s,a);return o&&o.tracks&&o.tracks.length>0?(t.logisticsStatus!==o.currentStatus&&m(e,{logisticsStatus:o.currentStatus}),t.logisticsHistory||(t.logisticsHistory=[]),o.tracks.forEach(e=>{const s=t.logisticsHistory?.some(t=>t.time===e.time&&t.description===e.description);s||t.logisticsHistory?.push({time:e.time,location:e.location,description:e.description,status:e.status})}),t.logisticsHistory?.sort((e,t)=>new Date(t.time).getTime()-new Date(e.time).getTime()),{tracks:o.tracks.map(e=>({time:e.time,status:e.status,statusText:e.statusText||e.description,description:e.description,location:e.location})),currentStatus:o.currentStatus,lastUpdateTime:o.lastUpdateTime,estimatedDeliveryTime:o.estimatedDeliveryTime}):{tracks:[],currentStatus:t.logisticsStatus||"pending",lastUpdateTime:(new Date).toISOString(),estimatedDeliveryTime:void 0}}catch(r){return console.error("查询物流信息失败:",r),t.logisticsHistory&&t.logisticsHistory.length>0?{tracks:t.logisticsHistory.map(e=>({time:e.time,status:e.status,statusText:e.description,description:e.description,location:e.location||""})),currentStatus:t.logisticsStatus||"pending",lastUpdateTime:t.logisticsHistory[0].time,estimatedDeliveryTime:void 0}:null}},initializeWithMockData:()=>{const e=window.location.hostname;if(e.includes("abc789.cn")||e.includes("vercel.app")||e.includes("netlify.app")||e.includes("railway.app")||!e.includes("localhost")&&!e.includes("127.0.0.1"))return void console.log("[OrderStore] 生产环境：不使用模拟数据，订单数据从API获取");if(r.value.length>0)return void console.log("Order Store: 订单数据已存在，跳过初始化");try{const e=localStorage.getItem("crm_mock_orders");if(e){const t=JSON.parse(e),s=t[0];if(!s||s.receiverName&&s.subtotal)return r.value=t,void console.log(`Order Store: 从localStorage加载了 ${t.length} 个订单`);console.log("Order Store: 检测到旧版本数据结构，重新初始化"),localStorage.removeItem("crm_mock_orders")}}catch(s){console.warn("Order Store: 从localStorage加载订单数据失败:",s)}const t=[{id:"1",orderNumber:"ORD202401001",customerId:"1",customerName:"张三",customerPhone:"13800138001",products:[{id:"1",name:"产品A",price:1e3,quantity:2,total:2e3}],subtotal:2e3,discount:0,totalAmount:2e3,collectAmount:1500,depositAmount:500,receiverName:"张三",receiverPhone:"13800138001",receiverAddress:"北京市朝阳区建国门外大街1号",remark:"请尽快发货",status:"pending_shipment",auditStatus:"approved",markType:"normal",createTime:"2024-01-15 10:30:00",createdBy:"admin",salesPersonId:"admin",serviceWechat:"service001",orderSource:"online_store",expectedShipDate:"2024-01-16",expectedDeliveryDate:"2024-01-18",expressCompany:"sf",trackingNumber:"SF1234567890",logisticsStatus:"picked_up",statusHistory:[{status:"pending_transfer",time:"2024-01-15 10:30:00",operator:"admin",description:"订单创建成功",remark:"客户下单"},{status:"pending_audit",time:"2024-01-15 10:33:00",operator:"admin",description:"订单流转到审核",remark:"自动流转"},{status:"pending_shipment",time:"2024-01-15 11:00:00",operator:"审核员",description:"订单审核通过，等待发货",remark:"审核通过"}],operationLogs:[{id:"op_1",time:"2024-01-15 10:30:00",operator:"admin",action:"创建订单",description:"订单创建成功",remark:"客户下单"},{id:"op_2",time:"2024-01-15 11:00:00",operator:"审核员",action:"审核通过",description:"订单审核通过，等待发货",remark:"审核通过"}]},{id:"2",orderNumber:"ORD202401002",customerId:"2",customerName:"李四",customerPhone:"13900139002",products:[{id:"2",name:"产品B",price:1500,quantity:1,total:1500}],subtotal:1500,discount:100,totalAmount:1400,collectAmount:900,depositAmount:500,receiverName:"李四",receiverPhone:"13900139002",receiverAddress:"上海市浦东新区陆家嘴环路1000号",remark:"客户要求包装精美",status:"pending_cancel",auditStatus:"pending",markType:"normal",createTime:"2024-01-16 14:20:00",createdBy:"sales1",salesPersonId:"sales1",cancelStatus:"pending",cancelReason:"customer_cancel",cancelDescription:"客户临时改变主意，不需要此产品",cancelRequestTime:"2024-01-17 09:15:00",serviceWechat:"service002",orderSource:"wechat_mini",statusHistory:[{status:"pending_transfer",time:"2024-01-16 14:20:00",operator:"sales1",description:"订单创建成功",remark:"客户下单"},{status:"pending_cancel",time:"2024-01-17 09:15:00",operator:"sales1",description:"申请取消订单",remark:"客户要求取消"}],operationLogs:[{id:"op_3",time:"2024-01-16 14:20:00",operator:"sales1",action:"创建订单",description:"订单创建成功",remark:"客户下单"},{id:"op_4",time:"2024-01-17 09:15:00",operator:"sales1",action:"申请取消",description:"申请取消订单",remark:"客户要求取消"}]},{id:"3",orderNumber:"ORD202401003",customerId:"3",customerName:"王五",customerPhone:"13700137003",products:[{id:"3",name:"产品C",price:800,quantity:3,total:2400}],subtotal:2400,discount:0,totalAmount:2400,collectAmount:2400,depositAmount:0,receiverName:"王五",receiverPhone:"13700137003",receiverAddress:"广州市天河区珠江新城花城大道1号",remark:"货到付款",status:"shipped",auditStatus:"approved",markType:"normal",createTime:"2024-01-18 09:15:00",createdBy:"sales2",salesPersonId:"sales2",auditRemark:"审核通过",auditTime:"2024-01-18 14:20:00",auditorId:"admin",serviceWechat:"service003",orderSource:"phone_call",expectedShipDate:"2024-01-19",expectedDeliveryDate:"2024-01-21",expressCompany:"yt",trackingNumber:"YT9876543210",logisticsStatus:"in_transit",statusHistory:[{status:"pending_transfer",time:"2024-01-18 09:15:00",operator:"sales2",description:"订单创建成功",remark:"客户下单"},{status:"pending_audit",time:"2024-01-18 09:18:00",operator:"sales2",description:"订单流转到审核",remark:"自动流转"},{status:"pending_shipment",time:"2024-01-18 14:20:00",operator:"admin",description:"订单审核通过，等待发货",remark:"审核通过"},{status:"shipped",time:"2024-01-19 10:30:00",operator:"物流员",description:"订单已发货",remark:"圆通快递"}],operationLogs:[{id:"op_5",time:"2024-01-18 09:15:00",operator:"sales2",action:"创建订单",description:"订单创建成功",remark:"客户下单"},{id:"op_6",time:"2024-01-18 14:20:00",operator:"admin",action:"审核通过",description:"订单审核通过，等待发货",remark:"审核通过"},{id:"op_7",time:"2024-01-19 10:30:00",operator:"物流员",action:"订单发货",description:"订单已通过圆通快递发货",remark:"正常发货"}]}];r.value=t;try{localStorage.setItem("crm_mock_orders",JSON.stringify(t)),console.log(`Order Store: 初始化了 ${t.length} 个模拟订单`)}catch(s){console.warn("Order Store: 保存订单数据到localStorage失败:",s)}},getStatusText:e=>({pending_transfer:"待流转",pending_audit:"待审核",audit_rejected:"审核拒绝",pending_shipment:"待发货",shipped:"已发货",delivered:"已签收",logistics_returned:"物流退回",logistics_cancelled:"物流取消",package_exception:"包裹异常",rejected:"拒收",rejected_returned:"拒收已退回",after_sales_created:"已建售后",pending_cancel:"待取消",cancel_failed:"取消失败",cancelled:"已取消",draft:"草稿"}[e]||e),loadOrdersFromAPI:f,loadPendingCancelOrdersFromAPI:async()=>{try{const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3])),t=await e.getPendingCancelOrders();return t&&t.data?t.data:[]}catch(e){return console.warn("Order Store: 从API加载待审核取消订单失败:",e),[]}},loadAuditedCancelOrdersFromAPI:async()=>{try{const{orderApi:e}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3])),t=await e.getAuditedCancelOrders();return t&&t.data?t.data:[]}catch(e){return console.warn("Order Store: 从API加载已审核取消订单失败:",e),[]}},submitCancelRequestToAPI:async(e,t,s)=>{try{const{orderApi:a}=await ge(async()=>{const{orderApi:e}=await import("./order-DOc9fodO.js");return{orderApi:e}},__vite__mapDeps([0,1,2,3])),r=ys(),o=await a.cancelRequest({orderId:e,reason:t,description:s,operatorId:r.currentUser?.id||""});return o&&o.success?(m(e,{status:"pending_cancel",cancelReason:t,cancelDescription:s,cancelRequestTime:(new Date).toISOString()}),{success:!0,message:o.message}):{success:!1,message:"提交失败"}}catch(a){return console.error("Order Store: 提交取消申请失败:",a),{success:!1,message:"提交失败"}}},auditCancelOrderToAPI:_}},{exclude:["orders"]}),$t=Object.freeze(Object.defineProperty({__proto__:null,useOrderStore:xt},Symbol.toStringTag,{value:"Module"})),Vt=e("logisticsStatus",()=>{const e=s(!1),t=s([]),a=r({pending:0,updated:0,todo:0,total:0}),o=r({canAccess:!1,canUpdate:!1,canSetTodo:!1,canAutoUpdate:!1}),n=r({currentPage:1,pageSize:20,total:0}),i=r({tab:"pending",dateRange:[],keyword:"",status:""}),c=async()=>{e.value=!0;try{const e={tab:i.tab,dateRange:2===i.dateRange.length?i.dateRange:void 0,keyword:i.keyword||void 0,status:i.status||void 0,page:n.currentPage,pageSize:n.pageSize},s=await yt(e);return t.value=s.data.list||[],n.total=s.data.total||0,s}catch(s){throw console.error("获取订单列表失败:",s),s}finally{e.value=!1}},l=async()=>{try{const e={dateRange:2===i.dateRange.length?i.dateRange:void 0},t=await(e=>ut.get("/logistics/summary",{startDate:e?.dateRange?.[0],endDate:e?.dateRange?.[1]}))(e);return Object.assign(a,t.data),t}catch(e){throw console.error("获取汇总数据失败:",e),e}};return{loading:e,orderList:t,summary:a,userPermission:o,pagination:n,filters:i,fetchOrderList:c,fetchSummary:l,updateOrderStatus:async(e,s,a)=>{try{await(r={orderNo:e,newStatus:s,remark:a},ut.post("/logistics/order/status",r));const o=t.value.find(t=>t.orderNo===e);o&&(o.status=s);const n=xt(),i=n.getOrderByNumber(e);if(i){console.log(`[物流状态Store] 同步更新订单 ${e} 的物流状态: ${s}`);const t={logisticsStatus:s},a={delivered:"delivered",rejected:"rejected",rejected_returned:"rejected_returned",refunded:"refunded",after_sales_created:"after_sales_created",abnormal:"package_exception"};a[s]&&(t.status=a[s],console.log(`[物流状态Store] 同时更新订单状态为: ${a[s]}`)),n.updateOrder(i.id,t),"delivered"===s&&(console.log(`[物流状态Store] 订单已签收，创建资料记录: ${e}`),await(async e=>{try{let s=[];if(dataListStr)try{s=JSON.parse(dataListStr)}catch(t){console.error("解析dataList失败:",t),s=[]}s.some(t=>t.customerCode&&t.customerCode===e.customerCode||t.customerName&&t.customerName===e.customerName)&&console.log(`客户已存在资料记录，跳过创建: ${e.customerName} (${e.customerCode})`),console.log(`首次签收客户，创建资料记录: ${e.customerName} (${e.customerCode})`);const a={id:`data_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,customerCode:e.customerCode||`C${Date.now()}`,customerName:e.customerName,phone:e.phone,orderNo:e.orderNo,orderStatus:"delivered",orderAmount:e.totalAmount||0,orderDate:e.createTime||(new Date).toISOString(),signDate:(new Date).toISOString(),status:"pending",source:"订单签收",createdBy:"system",createdByName:"系统",createTime:(new Date).toISOString(),updateTime:(new Date).toISOString()};s.unshift(a),console.log("成功创建资料记录:",a)}catch(t){console.error("创建资料记录失败:",t)}})(i))}await l()}catch(o){throw console.error("更新订单状态失败:",o),o}var r},batchUpdateOrderStatus:async(e,s,a)=>{try{const o=await(r={orderNos:e,newStatus:s,remark:a},ut.post("/logistics/order/batch-status",r));e.forEach(e=>{const a=t.value.find(t=>t.orderNo===e);a&&(a.status=s)});const n=xt();return e.forEach(e=>{const t=n.getOrderByNumber(e);if(t){console.log(`[物流状态Store] 批量同步更新订单 ${e} 的物流状态: ${s}`);const a={logisticsStatus:s},r={delivered:"delivered",rejected:"rejected",rejected_returned:"rejected_returned",refunded:"refunded",after_sales_created:"after_sales_created",abnormal:"package_exception"};r[s]&&(a.status=r[s],console.log(`[物流状态Store] 同时更新订单状态为: ${r[s]}`)),n.updateOrder(t.id,a)}}),await l(),o}catch(o){throw console.error("批量更新订单状态失败:",o),o}var r},setTodoOrder:async(e,s,a)=>{try{const o=await(r={orderNo:e,days:s,remark:a},ut.post("/logistics/order/todo",r)),n=t.value.find(t=>t.orderNo===e);if(n){const e=new Date;e.setDate(e.getDate()+s),n.todoDate=e.toISOString().split("T")[0],n.todoRemark=a}const i=xt(),c=i.getOrderByNumber(e);if(c){const t=new Date;t.setDate(t.getDate()+s),console.log(`[物流状态Store] 设置订单 ${e} 为待办，${s}天后处理`),i.updateOrder(c.id,{isTodo:!0,todoDate:t.toISOString().split("T")[0],todoRemark:a})}return await l(),o}catch(o){throw console.error("设置待办失败:",o),o}var r},fetchTrackingInfo:async e=>{try{return(await vt(e)).data||[]}catch(t){throw console.error("获取物流轨迹失败:",t),t}},autoUpdateStatus:async()=>{try{const e=await ht({trackingIds:[]});return await Promise.all([c(),l()]),e}catch(e){throw console.error("自动更新物流状态失败:",e),e}},fetchUserPermission:async()=>{try{const e=await ut.get("/logistics/permission");return Object.assign(o,e.data),e}catch(e){throw console.error("获取用户权限失败:",e),e}},setFilters:e=>{Object.assign(i,e)},setPagination:e=>{Object.assign(n,e)},resetFilters:()=>{i.tab="pending",i.dateRange=[],i.keyword="",i.status="",n.currentPage=1},refreshData:async()=>{await Promise.all([c(),l()])},getStatusText:e=>({picked_up:"已揽收",in_transit:"运输中",out_for_delivery:"派送中",delivered:"已签收",exception:"异常",rejected:"拒收",returned:"已退回",refunded:"退货退款",abnormal:"状态异常",shipped:"已发货"}[e]||e),getStatusType:e=>({shipped:"info",delivered:"success",rejected:"warning",returned:"danger",refunded:"danger",abnormal:"danger"}[e]||"info")}});var jt=(e=>(e.ORDER_CREATED="order_created",e.ORDER_SUBMITTED="order_submitted",e.ORDER_PAID="order_paid",e.ORDER_PENDING_SHIPMENT="order_pending_shipment",e.ORDER_SHIPPED="order_shipped",e.ORDER_DELIVERED="order_delivered",e.ORDER_SIGNED="order_signed",e.ORDER_CANCELLED="order_cancelled",e.ORDER_CANCEL_REQUEST="order_cancel_request",e.ORDER_CANCEL_APPROVED="order_cancel_approved",e.ORDER_MODIFY_APPROVED="order_modify_approved",e.ORDER_REFUNDED="order_refunded",e.AFTER_SALES_CREATED="after_sales_created",e.AFTER_SALES_ASSIGNED="after_sales_assigned",e.AFTER_SALES_PROCESSING="after_sales_processing",e.AFTER_SALES_URGENT="after_sales_urgent",e.AFTER_SALES_COMPLETED="after_sales_completed",e.AFTER_SALES_CLOSED="after_sales_closed",e.AFTER_SALES_DELETED="after_sales_deleted",e.CUSTOMER_CREATED="customer_created",e.CUSTOMER_UPDATED="customer_updated",e.CUSTOMER_CALL="customer_call",e.CUSTOMER_SHARE="customer_share",e.CUSTOMER_COMPLAINT="customer_complaint",e.CUSTOMER_REJECTED="customer_rejected",e.PRODUCT_CREATED="product_created",e.PRODUCT_UPDATED="product_updated",e.PRODUCT_OUT_OF_STOCK="product_out_of_stock",e.SYSTEM_MAINTENANCE="system_maintenance",e.SYSTEM_UPDATE="system_update",e.USER_LOGIN="user_login",e.USER_CREATED="user_created",e.PERMISSION_CONFIGURED="permission_configured",e.DATA_EXPORT_SUCCESS="data_export_success",e.DATA_IMPORT_COMPLETED="data_import_completed",e.LOGISTICS_PICKUP="logistics_pickup",e.LOGISTICS_IN_TRANSIT="logistics_in_transit",e.LOGISTICS_DELIVERED="logistics_delivered",e.PACKAGE_ANOMALY="package_anomaly",e.AUDIT_PENDING="audit_pending",e.AUDIT_APPROVED="audit_approved",e.AUDIT_REJECTED="audit_rejected",e.PERFORMANCE_SHARE_CREATED="performance_share_created",e.PERFORMANCE_SHARE_RECEIVED="performance_share_received",e.PERFORMANCE_SHARE_CONFIRMED="performance_share_confirmed",e.PERFORMANCE_SHARE_REJECTED="performance_share_rejected",e.PERFORMANCE_SHARE_CANCELLED="performance_share_cancelled",e.SMS_TEMPLATE_APPLIED="sms_template_applied",e.SMS_TEMPLATE_APPROVED="sms_template_approved",e.SMS_TEMPLATE_REJECTED="sms_template_rejected",e.SMS_SEND_APPLIED="sms_send_applied",e.SMS_SEND_APPROVED="sms_send_approved",e.SMS_SEND_REJECTED="sms_send_rejected",e.SMS_SEND_SUCCESS="sms_send_success",e.SMS_SEND_FAILED="sms_send_failed",e))(jt||{}),Ft=(e=>(e.LOW="low",e.NORMAL="normal",e.HIGH="high",e.URGENT="urgent",e))(Ft||{});const qt={order_created:{title:"新订单创建",icon:"Plus",color:"#409EFF",category:"订单通知",priority:"normal"},order_submitted:{title:"订单提交成功",icon:"DocumentAdd",color:"#67C23A",category:"订单通知",priority:"high"},order_paid:{title:"订单已支付",icon:"Money",color:"#67C23A",category:"订单通知",priority:"high"},order_pending_shipment:{title:"订单待发货",icon:"Box",color:"#E6A23C",category:"订单通知",priority:"normal"},order_shipped:{title:"订单已发货",icon:"Van",color:"#409EFF",category:"物流通知",priority:"normal"},order_delivered:{title:"订单已送达",icon:"Check",color:"#67C23A",category:"物流通知",priority:"normal"},order_signed:{title:"订单已签收",icon:"CircleCheck",color:"#67C23A",category:"订单通知",priority:"high"},order_cancelled:{title:"订单已取消",icon:"Close",color:"#F56C6C",category:"订单通知",priority:"normal"},order_cancel_request:{title:"订单取消申请",icon:"Document",color:"#E6A23C",category:"审核通知",priority:"high"},order_cancel_approved:{title:"订单取消通过",icon:"CircleCheck",color:"#67C23A",category:"审核通知",priority:"high"},order_modify_approved:{title:"订单修改申请通过",icon:"CircleCheck",color:"#67C23A",category:"审核通知",priority:"high"},order_refunded:{title:"订单已退款",icon:"RefreshLeft",color:"#E6A23C",category:"订单通知",priority:"high"},after_sales_created:{title:"新售后申请",icon:"Service",color:"#E6A23C",category:"售后通知",priority:"high"},after_sales_assigned:{title:"售后分配",icon:"User",color:"#409EFF",category:"售后通知",priority:"normal"},after_sales_processing:{title:"售后处理",icon:"Loading",color:"#409EFF",category:"售后通知",priority:"normal"},after_sales_urgent:{title:"紧急售后",icon:"Warning",color:"#F56C6C",category:"售后通知",priority:"urgent"},after_sales_completed:{title:"售后完成",icon:"CircleCheck",color:"#67C23A",category:"售后通知",priority:"normal"},after_sales_closed:{title:"售后关闭",icon:"CircleClose",color:"#909399",category:"售后通知",priority:"low"},after_sales_deleted:{title:"售后删除",icon:"Delete",color:"#F56C6C",category:"售后通知",priority:"low"},customer_created:{title:"客户添加成功",icon:"User",color:"#13C2C2",category:"客户通知",priority:"normal"},customer_updated:{title:"客户信息更新",icon:"Edit",color:"#409EFF",category:"客户通知",priority:"low"},customer_call:{title:"客户外呼",icon:"Phone",color:"#722ED1",category:"客服通知",priority:"high"},customer_share:{title:"客户分享",icon:"Share",color:"#409EFF",category:"客户通知",priority:"normal"},customer_complaint:{title:"客户投诉",icon:"Warning",color:"#F56C6C",category:"客服通知",priority:"high"},customer_rejected:{title:"客户拒收",icon:"Close",color:"#F56C6C",category:"客户通知",priority:"high"},product_created:{title:"商品添加成功",icon:"Goods",color:"#67C23A",category:"商品通知",priority:"normal"},product_updated:{title:"商品信息更新",icon:"Edit",color:"#409EFF",category:"商品通知",priority:"low"},product_out_of_stock:{title:"商品缺货",icon:"Warning",color:"#E6A23C",category:"商品通知",priority:"high"},system_maintenance:{title:"系统维护",icon:"Tools",color:"#909399",category:"系统通知",priority:"normal"},system_update:{title:"系统更新",icon:"Refresh",color:"#409EFF",category:"系统通知",priority:"low"},user_login:{title:"用户登录",icon:"User",color:"#67C23A",category:"系统通知",priority:"low"},user_created:{title:"系统用户添加成功",icon:"UserFilled",color:"#67C23A",category:"系统通知",priority:"normal"},permission_configured:{title:"权限配置成功",icon:"Key",color:"#67C23A",category:"系统通知",priority:"normal"},data_export_success:{title:"导出成功",icon:"Download",color:"#67C23A",category:"系统通知",priority:"normal"},data_import_completed:{title:"导入完成",icon:"Upload",color:"#67C23A",category:"系统通知",priority:"normal"},logistics_pickup:{title:"快递已揽收",icon:"Box",color:"#409EFF",category:"物流通知",priority:"normal"},logistics_in_transit:{title:"快递运输中",icon:"Van",color:"#409EFF",category:"物流通知",priority:"low"},logistics_delivered:{title:"快递已送达",icon:"Check",color:"#67C23A",category:"物流通知",priority:"normal"},package_anomaly:{title:"包裹异常",icon:"Warning",color:"#E6A23C",category:"异常通知",priority:"high"},audit_pending:{title:"待审核",icon:"Clock",color:"#E6A23C",category:"审核通知",priority:"normal"},audit_approved:{title:"审核通过",icon:"CircleCheck",color:"#67C23A",category:"审核通知",priority:"normal"},audit_rejected:{title:"审核拒绝",icon:"Close",color:"#F56C6C",category:"审核通知",priority:"high"},performance_share_created:{title:"业绩分享创建",icon:"Share",color:"#409EFF",category:"业绩通知",priority:"normal"},performance_share_received:{title:"收到业绩分享",icon:"Gift",color:"#722ED1",category:"业绩通知",priority:"high"},performance_share_confirmed:{title:"业绩分享确认",icon:"CircleCheck",color:"#67C23A",category:"业绩通知",priority:"high"},performance_share_rejected:{title:"业绩分享拒绝",icon:"Close",color:"#F56C6C",category:"业绩通知",priority:"high"},performance_share_cancelled:{title:"业绩分享取消",icon:"CircleClose",color:"#E6A23C",category:"业绩通知",priority:"normal"},sms_template_applied:{title:"短信模板申请",icon:"DocumentAdd",color:"#409EFF",category:"短信通知",priority:"high"},sms_template_approved:{title:"短信模板审核通过",icon:"CircleCheck",color:"#67C23A",category:"短信通知",priority:"high"},sms_template_rejected:{title:"短信模板审核拒绝",icon:"CircleClose",color:"#F56C6C",category:"短信通知",priority:"high"},sms_send_applied:{title:"短信发送申请",icon:"Message",color:"#409EFF",category:"短信通知",priority:"high"},sms_send_approved:{title:"短信发送审核通过",icon:"CircleCheck",color:"#67C23A",category:"短信通知",priority:"high"},sms_send_rejected:{title:"短信发送审核拒绝",icon:"CircleClose",color:"#F56C6C",category:"短信通知",priority:"high"},sms_send_success:{title:"短信发送成功",icon:"SuccessFilled",color:"#67C23A",category:"短信通知",priority:"normal"},sms_send_failed:{title:"短信发送失败",icon:"CircleClose",color:"#F56C6C",category:"短信通知",priority:"high"}},Ht=e("notification",()=>{const e=e=>{try{localStorage.setItem("notification-messages",JSON.stringify(e))}catch(t){console.error("保存消息失败:",t)}},t=s((()=>{try{(()=>{const e="notification-mock-cleaned-v2";localStorage.getItem(e)||(localStorage.removeItem("notification-messages"),localStorage.setItem(e,"true"),console.log("[Notification] 已清理旧的模拟消息数据"))})();const e=localStorage.getItem("notification-messages");if(e)return JSON.parse(e)}catch(e){console.error("加载消息失败:",e)}return[]})()),r=a(()=>t.value.filter(e=>!e.read).length),o=a(()=>t.value.sort((e,t)=>new Date(t.time).getTime()-new Date(e.time).getTime()).slice(0,10)),n=a(()=>{const e={};return t.value.forEach(t=>{e[t.category]||(e[t.category]=[]),e[t.category].push(t)}),e}),i=(s,a,r)=>{const o=qt[s],n={id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:s,title:o.title,content:a,priority:o.priority,time:(new Date).toLocaleString("zh-CN"),read:!1,icon:o.icon,color:o.color,category:o.category,relatedId:r?.relatedId,relatedType:r?.relatedType,actionUrl:r?.actionUrl};return t.value.unshift(n),e(t.value),n};return{messages:t,unreadCount:r,recentMessages:o,messagesByCategory:n,sendMessage:i,markAsRead:s=>{const a=t.value.find(e=>e.id===s);a&&(a.read=!0,e(t.value))},markAllAsRead:()=>{t.value.forEach(e=>{e.read=!0}),e(t.value)},deleteMessage:s=>{const a=t.value.findIndex(e=>e.id===s);a>-1&&(t.value.splice(a,1),e(t.value))},clearAllMessages:()=>{t.value=[],e(t.value)},batchSendMessages:e=>e.map(e=>i(e.type,e.content,e.options)),loadMessagesFromAPI:async(s={})=>{try{const{messageApi:a}=await ge(async()=>{const{messageApi:e}=await Promise.resolve().then(()=>vr);return{messageApi:e}},void 0),r=await a.getSystemMessages({limit:50,...s});if(r.success&&r.data){const s=new Set(t.value.map(e=>e.id)),a=r.data.messages||[];return a.forEach(e=>{if(s.has(e.id))return;const a={id:e.id||`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:e.type||"system_update",title:e.title||"系统通知",content:e.content||"",priority:e.priority||"normal",time:e.createdAt||(new Date).toLocaleString("zh-CN"),read:e.read||!1,icon:e.icon||"Bell",color:e.color||"#409EFF",category:e.category||"系统通知",relatedId:e.relatedId,relatedType:e.relatedType,actionUrl:e.actionUrl};t.value.push(a)}),e(t.value),a}return[]}catch(a){return console.log("[Notification] 从API加载消息失败（非关键功能）:",a),[]}},MessageType:jt,MessagePriority:Ft}}),Bt=e("app",()=>{const e=s(new Map),t=s(!1),r=s("加载中..."),o=s(-1),n=s(new Map),i=s(navigator.onLine),c=a(()=>e.value.size>0||t.value),l=a(()=>n.value.size>0),d=a(()=>e.value.size),u=(s={})=>{const a=s.id||`loading_${Date.now()}_${Math.random()}`;return"global"===s.id?(t.value=!0,r.value=s.text||"加载中...",o.value=s.progress||-1,a):(e.value.set(a,{id:a,text:s.text||"加载中...",progress:s.progress,cancelable:s.cancelable,onCancel:s.onCancel}),a)},m=s=>s?"global"===s?(t.value=!1,r.value="加载中...",void(o.value=-1)):void e.value.delete(s):(e.value.clear(),void(t.value=!1)),p=e=>{const t=e.id||`error_${Date.now()}_${Math.random()}`,s={id:t,title:e.title||"错误",message:e.message,type:e.type||"error",duration:e.duration,showClose:e.showClose,onClose:e.onClose};return n.value.set(t,s),"error"===e.type?j.error({title:s.title,message:s.message,duration:e.duration||4500,showClose:!1!==e.showClose,onClose:()=>{g(t),e.onClose?.()}}):"warning"===e.type?j.warning({title:s.title,message:s.message,duration:e.duration||4500,showClose:!1!==e.showClose,onClose:()=>{g(t),e.onClose?.()}}):j.info({title:s.title,message:s.message,duration:e.duration||4500,showClose:!1!==e.showClose,onClose:()=>{g(t),e.onClose?.()}}),t},g=e=>{n.value.delete(e)},h=e=>{const t=!i.value;i.value=e,e&&t?V.success("网络连接已恢复"):e||V.warning("网络连接已断开")};return{loadingStates:e,globalLoading:t,globalLoadingText:r,globalLoadingProgress:o,errors:n,isOnline:i,hasLoading:c,hasErrors:l,loadingCount:d,showLoading:u,hideLoading:m,updateLoadingProgress:(t,s)=>{if("global"===t)return void(o.value=s);const a=e.value.get(t);a&&(a.progress=s,e.value.set(t,a))},showError:p,hideError:g,clearErrors:()=>{n.value.clear()},setOnlineStatus:h,withLoading:async(e,t={})=>{const s=u({id:t.loadingId,text:t.loadingText});try{return await e}catch(a){if(!1!==t.showError){const e=a instanceof Error?a.message:"未知错误";p({title:t.errorTitle||"操作失败",message:e,type:"error"})}throw a}finally{m(s)}},withRetry:async(e,t={})=>{const s=t.maxRetries||3,a=t.delay||1e3;let r;for(let n=1;n<=s;n++)try{return await e()}catch(o){if(r=o,n===s)break;t.onRetry?.(n,o),await new Promise(e=>setTimeout(e,a*n))}throw r},initNetworkListener:()=>{window.addEventListener("online",()=>h(!0)),window.addEventListener("offline",()=>h(!1))},cleanup:()=>{e.value.clear(),n.value.clear(),t.value=!1}}}),Jt=o({history:n("/"),routes:[{path:"/",redirect:"/dashboard"},{path:"/login",name:"Login",component:()=>ge(()=>import("./Login-CTg6nU-C.js"),__vite__mapDeps([4,1,5,6,7,2,3,8])),meta:{title:"登录",requiresAuth:!1}},{path:"/change-password",name:"ChangePassword",component:()=>ge(()=>import("./ChangePassword-DusGHIQT.js"),__vite__mapDeps([9,1,2,3,10])),meta:{title:"修改密码",requiresAuth:!0}},{path:"/dashboard",name:"Dashboard",component:()=>ge(()=>import("./Dashboard-wz3-eYei.js"),__vite__mapDeps([11,1,2,3,12])),meta:{title:"数据看板",requiresAuth:!0}},{path:"/customer/list",name:"CustomerList",component:()=>ge(()=>import("./List-DOLJnmri.js"),__vite__mapDeps([13,1,2,14,15,3,16,17,18,19,7,20])),meta:{title:"客户列表",requiresAuth:!0}},{path:"/customer/add",name:"CustomerAdd",component:()=>ge(()=>import("./Add-nqMVPQzR.js"),__vite__mapDeps([21,1,2,22,23,3,24])),meta:{title:"新增客户",requiresAuth:!0}},{path:"/customer/edit/:id",name:"CustomerEdit",component:()=>ge(()=>import("./Edit-D4qL9RKY.js"),__vite__mapDeps([25,1,2,23,14,22,3,26])),meta:{title:"编辑客户",requiresAuth:!0}},{path:"/customer/detail/:id",name:"CustomerDetail",component:()=>ge(()=>import("./Detail-IWGXEUUH.js"),__vite__mapDeps([27,1,2,28,7,29,14,30,31,3,32])),meta:{title:"客户详情",requiresAuth:!0}},{path:"/customer/tags",name:"CustomerTags",component:()=>ge(()=>import("./Tags-C2Pdma7Q.js"),__vite__mapDeps([33,2,1,14,22,3,34])),meta:{title:"客户标签",requiresAuth:!0}},{path:"/customer/groups",name:"CustomerGroups",component:()=>ge(()=>import("./Groups-UAKqHSTj.js"),__vite__mapDeps([35,2,1,14,3,36])),meta:{title:"客户分组",requiresAuth:!0}},{path:"/order/list",name:"OrderList",component:()=>ge(()=>import("./List-KY7zd2J-.js"),__vite__mapDeps([37,1,2,15,3,0,14,38])),meta:{title:"订单列表",requiresAuth:!0}},{path:"/order/add",name:"OrderAdd",component:()=>ge(()=>import("./Add-D8-Yi-cz.js"),__vite__mapDeps([39,1,2,6,7,40,41,14,3,42])),meta:{title:"新增订单",requiresAuth:!0}},{path:"/order/edit/:id",name:"OrderEdit",component:()=>ge(()=>import("./Edit-DIIm8DQi.js"),__vite__mapDeps([43,1,2,6,7,3,44])),meta:{title:"编辑订单",requiresAuth:!0}},{path:"/order/detail/:id",name:"OrderDetail",component:()=>ge(()=>import("./Detail-DU0Q5iQ7.js"),__vite__mapDeps([45,1,2,0,3,28,7,14,46])),meta:{title:"订单详情",requiresAuth:!0}},{path:"/order/audit",name:"OrderAudit",component:()=>ge(()=>import("./Audit-DoS-ULEh.js"),__vite__mapDeps([47,1,2,0,3,14,16,17,18,19,48])),meta:{title:"订单审核",requiresAuth:!0}},{path:"/performance/personal",name:"PerformancePersonal",component:()=>ge(()=>import("./Personal-CUGqGXZE.js"),__vite__mapDeps([49,1,2,3,50])),meta:{title:"个人业绩",requiresAuth:!0}},{path:"/performance/team",name:"PerformanceTeam",component:()=>ge(()=>import("./Team-DtEC_5V4.js"),__vite__mapDeps([51,1,52,2,3,17,18,53])),meta:{title:"团队业绩",requiresAuth:!0}},{path:"/performance/analysis",name:"PerformanceAnalysis",component:()=>ge(()=>import("./Analysis-4uteuhL8.js"),__vite__mapDeps([54,1,52,2,3,55])),meta:{title:"业绩分析",requiresAuth:!0}},{path:"/performance/share",name:"PerformanceShare",component:()=>ge(()=>import("./Share-BHDAPv4x.js"),__vite__mapDeps([56,1,2,3,57])),meta:{title:"业绩分享",requiresAuth:!0}},{path:"/settings/performance-share",name:"SettingsPerformanceShare",component:()=>ge(()=>import("./PerformanceShare-DeKGaAWV.js"),__vite__mapDeps([58,1,2,3,59])),meta:{title:"业绩分享设置",requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/logistics/list",name:"LogisticsList",component:()=>ge(()=>import("./List-BSjQQHQ7.js"),__vite__mapDeps([60,1,2,16,17,18,19,3,61])),meta:{title:"物流列表",requiresAuth:!0}},{path:"/logistics/detail/:id",name:"LogisticsDetail",component:()=>ge(()=>import("./Detail-D-YLrf2D.js"),__vite__mapDeps([62,1,2,14,3,63])),meta:{title:"物流详情",requiresAuth:!0}},{path:"/logistics/edit/:id",name:"LogisticsEdit",component:()=>ge(()=>import("./Edit-CbRgJ3q7.js"),__vite__mapDeps([64,1,2,3,65])),meta:{title:"编辑物流",requiresAuth:!0}},{path:"/logistics/track",name:"LogisticsTrack",component:()=>ge(()=>import("./Track-wn5kjJyF.js"),__vite__mapDeps([66,1,2,3,67])),meta:{title:"物流跟踪",requiresAuth:!0}},{path:"/logistics/companies",name:"LogisticsCompanies",component:()=>ge(()=>import("./Companies-DrzBkRiJ.js"),__vite__mapDeps([68,1,2,3,69])),meta:{title:"物流公司",requiresAuth:!0}},{path:"/logistics/track/detail/:trackingNo",name:"LogisticsTrackDetail",component:()=>ge(()=>import("./TrackDetail-Bdu4KxdI.js"),__vite__mapDeps([70,1,2,3,71])),meta:{title:"物流跟踪详情",requiresAuth:!0}},{path:"/logistics/company/detail/:id",name:"LogisticsCompanyDetail",component:()=>ge(()=>import("./CompanyDetail-DCR-yoM-.js"),__vite__mapDeps([72,1,2,14,3,73])),meta:{title:"物流公司详情",requiresAuth:!0}},{path:"/logistics/shipping",name:"LogisticsShipping",component:()=>ge(()=>import("./Shipping-DTPcTODG.js"),__vite__mapDeps([74,1,2,52,3,40,7,15,14,75,76,16,17,18,19,77])),meta:{title:"发货列表",requiresAuth:!0}},{path:"/logistics/status-update",name:"LogisticsStatusUpdate",component:()=>ge(()=>import("./StatusUpdate-DPrvn2oi.js"),__vite__mapDeps([78,2,1,75,14,76,3,79])),meta:{title:"状态更新",requiresAuth:!0,requiresSpecialPermission:!0}},{path:"/service/list",name:"ServiceList",component:()=>ge(()=>import("./List-63c1Fwfq.js"),__vite__mapDeps([80,1,2,28,7,52,3,14,16,17,18,19,81])),meta:{title:"售后订单",requiresAuth:!0,roles:["admin","manager","sales","customer_service"],permissions:["service:list:view"]}},{path:"/service/add",name:"ServiceAdd",component:()=>ge(()=>import("./Add-CeLPmfBQ.js"),__vite__mapDeps([82,1,2,28,7,41,83,3,84])),meta:{title:"新建售后",requiresAuth:!0,roles:["admin","manager","sales","customer_service"],permissions:["service:add"]}},{path:"/service/detail/:id",name:"ServiceDetail",component:()=>ge(()=>import("./Detail-B-Snpzic.js"),__vite__mapDeps([85,1,2,28,7,52,3,14,86])),meta:{title:"售后详情",requiresAuth:!0,roles:["admin","manager","sales","customer_service"],permissions:["service:detail:view"]}},{path:"/service/edit/:id",name:"ServiceEdit",component:()=>ge(()=>import("./Edit-B0QCA1Rd.js"),__vite__mapDeps([87,1,2,41,83,28,7,3,88])),meta:{title:"编辑售后",requiresAuth:!0,roles:["admin","manager","customer_service"],permissions:["service:edit"]}},{path:"/service/data",name:"ServiceData",component:()=>ge(()=>import("./Data-B3uPXcjb.js"),__vite__mapDeps([89,1,2,28,7,3,90])),meta:{title:"售后数据",requiresAuth:!0,roles:["admin","manager"],permissions:["service:data:view"]}},{path:"/data/list",name:"DataList",component:()=>ge(()=>import("./List-D1ZDBCmm.js"),__vite__mapDeps([91,1,2,92,7,52,3,14,93,16,17,18,19,94])),meta:{title:"资料列表",requiresAuth:!0}},{path:"/data/search",name:"DataSearch",component:()=>ge(()=>import("./SearchNew-CP02nU1a.js"),__vite__mapDeps([95,1,2,14,3,96])),meta:{title:"客户查询",requiresAuth:!0}},{path:"/data/search-debug",name:"SearchDebug",component:()=>ge(()=>import("./SearchDebug-DT-EsRUg.js"),__vite__mapDeps([97,92,7,1,2,3,98])),meta:{title:"搜索调试工具",requiresAuth:!0}},{path:"/data/recycle",name:"DataRecycle",component:()=>ge(()=>import("./Recycle-3GYdUylO.js"),__vite__mapDeps([99,2,1,92,7,14,3,100])),meta:{title:"回收站",requiresAuth:!0}},{path:"/product/list",name:"ProductList",component:()=>ge(()=>import("./List-sI6x4UL8.js"),__vite__mapDeps([101,1,2,6,7,16,17,18,19,3,102])),meta:{title:"商品列表",requiresAuth:!0}},{path:"/product/add",name:"ProductAdd",component:()=>ge(()=>import("./Add-CR_OagTI.js"),__vite__mapDeps([103,104,1,2,6,7,3,105])),meta:{title:"新增商品",requiresAuth:!0,requiresManager:!0}},{path:"/product/edit/:id",name:"ProductEdit",component:()=>ge(()=>import("./Edit-CELSlrJW.js"),__vite__mapDeps([104,1,2,6,7,3,105])),meta:{title:"编辑商品",requiresAuth:!0,requiresManager:!0}},{path:"/product/detail/:id",name:"ProductDetail",component:()=>ge(()=>import("./Detail-DEi7Lrk2.js"),__vite__mapDeps([106,1,2,6,7,3,107])),meta:{title:"商品详情",requiresAuth:!0}},{path:"/product/category",name:"ProductCategory",component:()=>ge(()=>import("./Category-Cd1-aiwG.js"),__vite__mapDeps([108,1,2,6,7,3,109])),meta:{title:"商品分类",requiresAuth:!0}},{path:"/product/inventory",name:"ProductInventory",component:()=>ge(()=>import("./Stock-B6V7f0fw.js"),__vite__mapDeps([110,1,2,6,7,3,111])),meta:{title:"库存管理",requiresAuth:!0,requiresManager:!0}},{path:"/product/analytics",name:"ProductAnalytics",component:()=>ge(()=>import("./Analytics-BgWsBhjd.js"),__vite__mapDeps([112,2,1,3,6,7,113])),meta:{title:"商品分析",requiresAuth:!0}},{path:"/service-management/sms",name:"ServiceSmsManagement",component:()=>ge(()=>import("./SmsManagement-C_A9yeSQ.js"),__vite__mapDeps([114,1,2,30,31,3,115])),meta:{title:"短信管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/service-management/call",name:"ServiceCallManagement",component:()=>ge(()=>import("./CallManagement-BUMU9Sc7.js"),__vite__mapDeps([116,1,29,2,117,3,118,119,14,120])),meta:{title:"通话管理",requiresAuth:!0}},{path:"/service-management/call/dashboard",name:"CallDashboard",component:()=>ge(()=>import("./Dashboard-hzex-mU9.js"),__vite__mapDeps([121,29,1,2,3,122])),meta:{title:"通话数据汇总",requiresAuth:!0}},{path:"/service-management/call/outbound",name:"CallOutbound",component:()=>ge(()=>import("./OutboundList-Cnsg-HuB.js"),__vite__mapDeps([123,29,1,2,14,3,124])),meta:{title:"呼出列表",requiresAuth:!0}},{path:"/service-management/call/records",name:"CallRecords",component:()=>ge(()=>import("./CallRecords-5QWXxcp2.js"),__vite__mapDeps([125,29,1,2,14,3,126])),meta:{title:"通话记录",requiresAuth:!0}},{path:"/service-management/call/followup",name:"CallFollowUp",component:()=>ge(()=>import("./FollowUpRecords-BpJa-TEU.js"),__vite__mapDeps([127,29,1,2,14,3,128])),meta:{title:"跟进记录",requiresAuth:!0}},{path:"/service-management/call/recordings",name:"CallRecordings",component:()=>ge(()=>import("./RecordingManagement-DFn-V3si.js"),__vite__mapDeps([129,29,1,2,14,3,130])),meta:{title:"录音管理",requiresAuth:!0}},{path:"/service-management/call/config",name:"CallConfig",component:()=>ge(()=>import("./PhoneConfig-DCYgyIpw.js"),__vite__mapDeps([131,29,1,2,3,132])),meta:{title:"电话配置",requiresAuth:!0}},{path:"/debug/storage",name:"DebugStorage",component:()=>ge(()=>import("./Storage-Bl8jfKmI.js"),__vite__mapDeps([133,1,2,3,134])),meta:{title:"存储调试",requiresAuth:!0}},{path:"/debug/user-permissions",name:"DebugUserPermissions",component:()=>ge(()=>import("./UserPermissions-Bn8y-_YB.js"),__vite__mapDeps([135,1,2,3,136])),meta:{title:"用户权限调试",requiresAuth:!0}},{path:"/system/users",name:"SystemUsers",component:()=>ge(()=>import("./User-DrbZ9Xwp.js"),__vite__mapDeps([137,52,1,2,3,14,138,139,28,7,92,16,17,18,19,140])),meta:{title:"用户管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/roles",name:"SystemRoles",component:()=>ge(()=>import("./Role-CwD-Hm3A.js"),__vite__mapDeps([141,139,142,2,1,3,143])),meta:{title:"角色权限",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/departments",name:"SystemDepartments",component:()=>ge(()=>import("./Departments-t035R3B4.js"),__vite__mapDeps([144,1,2,52,3,145,146,147,16,17,18,19,148])),meta:{title:"部门管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/department/detail/:id",name:"DepartmentDetail",component:()=>ge(()=>import("./DepartmentDetail-imDpQjTP.js"),__vite__mapDeps([149,1,2,52,3,145,146,147,150])),meta:{title:"部门详情",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/department/members/:id",name:"DepartmentMembers",component:()=>ge(()=>import("./DepartmentMembers-j-yb5xfV.js"),__vite__mapDeps([151,1,2,52,3,152])),meta:{title:"部门成员配置",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/department-roles",name:"DepartmentRoles",component:()=>ge(()=>import("./DepartmentRoles-o7f_iJW2.js"),__vite__mapDeps([153,1,2,52,3,154])),meta:{title:"部门角色管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/settings",name:"SystemSettings",component:()=>ge(()=>import("./Settings-B_hk99pz.js"),__vite__mapDeps([155,2,1,156,40,7,157,158,118,3,159])),meta:{title:"系统设置",requiresAuth:!0}},{path:"/about",name:"About",component:()=>ge(()=>import("./About-I-jDDWM3.js"),__vite__mapDeps([160,2,1,3,161])),meta:{title:"关于我们",requiresAuth:!0}},{path:"/system/sms-templates",name:"SmsTemplates",component:()=>ge(()=>import("./SmsTemplates-CXR9VyUE.js"),__vite__mapDeps([162,1,2,3,163])),meta:{title:"短信模板管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/sms-approval",name:"SmsApproval",component:()=>ge(()=>import("./SmsApproval-brh60lDY.js"),__vite__mapDeps([164,52,1,2,3,14,165])),meta:{title:"短信审核管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/sms-send-records",name:"SmsSendRecords",component:()=>ge(()=>import("./SmsSendRecords-BNHKVlDx.js"),__vite__mapDeps([166,2,1,7,3,167])),meta:{title:"短信发送记录",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/sms-statistics",name:"SmsStatistics",component:()=>ge(()=>import("./SmsStatistics-B6FUFgjN.js"),__vite__mapDeps([168,2,1,3,169])),meta:{title:"短信统计分析",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/sms-config",name:"SmsConfig",component:()=>ge(()=>import("./SmsConfig-DsVFnzdR.js"),__vite__mapDeps([170,2,1,3,171])),meta:{title:"短信配置管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/permissions",name:"SystemPermissions",component:()=>ge(()=>import("./PermissionManagement-ClcTGtGV.js"),__vite__mapDeps([172,1,2,3,173])),meta:{title:"权限管理",requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/system/super-admin-panel",name:"SuperAdminPanel",component:()=>ge(()=>import("./SuperAdminPermissionPanel-Bt_ntX--.js"),__vite__mapDeps([174,2,1,14,138,3,139,146,175])),meta:{title:"超级管理员权限面板",requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/system/customer-service-permissions",name:"CustomerServicePermissions",component:()=>ge(()=>import("./CustomerServicePermissionManager-CvAiWxXB.js"),__vite__mapDeps([176,2,1,14,138,3,93,177])),meta:{title:"客服权限管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/sensitive-info-permissions",name:"SensitiveInfoPermissions",component:()=>ge(()=>import("./SensitiveInfoPermissionManager-BQ2-0_Ja.js"),__vite__mapDeps([178,2,1,3,179])),meta:{title:"敏感信息权限管理",requiresAuth:!0,requiresSuperAdmin:!0}},{path:"/system/permission-guide",name:"PermissionGuide",component:()=>ge(()=>import("./PermissionManagementGuide-DxSEXD7V.js"),__vite__mapDeps([180,1,2,3,181])),meta:{title:"权限管理指南",requiresAuth:!0}},{path:"/system/call-test",name:"SystemCallTest",component:()=>ge(()=>import("./CallTest-BHCXlsDk.js"),__vite__mapDeps([182,29,1,2,3,183])),meta:{title:"通话功能测试",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/mobile-sdk",name:"SystemMobileSDK",component:()=>ge(()=>import("./MobileSDK-CnPnt9hZ.js"),__vite__mapDeps([184,2,1,3,185])),meta:{title:"移动SDK管理",requiresAuth:!0,requiresAdmin:!0}},{path:"/system/message-management",name:"MessageManagement",component:()=>ge(()=>import("./MessageManagement-CEma2GBO.js"),__vite__mapDeps([186,2,1,157,158,3,187])),meta:{title:"消息管理",requiresAuth:!0}},{path:"/mobile-sdk-install",name:"MobileSDKInstall",component:()=>ge(()=>import("./MobileSDKInstall-Do9fGkWi.js"),__vite__mapDeps([188,1,2,3,189])),meta:{title:"移动SDK安装指南",requiresAuth:!1}},{path:"/help-center",name:"HelpCenter",component:()=>ge(()=>import("./HelpCenter-BZkz-eKN.js"),__vite__mapDeps([190,2,1,3,191])),meta:{title:"帮助中心",requiresAuth:!0}},{path:"/:pathMatch(.*)*",name:"NotFound",component:()=>ge(()=>import("./NotFound-C2fea354.js"),__vite__mapDeps([192,1,2,3,193])),meta:{title:"页面未找到",requiresAuth:!1}}]});function zt(e,t,s={}){const a=e.currentRoute.value;if("string"==typeof t){if(t===a.path&&!s.force)return Promise.resolve();return(s.replace?e.replace:e.push)(t).catch(e=>{const t=e.message||e.toString()||"";if(t.includes("Avoided redundant navigation")||t.includes("Navigation cancelled")||t.includes("NavigationDuplicated")||t.includes("with a new navigation")||"NavigationDuplicated"===e.name)return Promise.resolve();throw console.error("导航失败:",t),e})}const r=t.path,o=a.path,n=a.query,i=t.query||{},c=r===o,l=JSON.stringify(n)===JSON.stringify(i);if(c&&l&&!s.force)return Promise.resolve();return(s.replace?e.replace:e.push)(t).catch(e=>{const t=e.message||e.toString()||"";if(t.includes("Avoided redundant navigation")||t.includes("Navigation cancelled")||t.includes("NavigationDuplicated")||t.includes("with a new navigation")||"NavigationDuplicated"===e.name)return Promise.resolve();throw console.error("导航失败:",t),e})}function Gt(e){return{push:(t,s)=>zt(e,t,{...s,replace:!1}),replace:(t,s)=>zt(e,t,{...s,replace:!0})}}Jt.beforeEach(async(e,t,s)=>{const a=ys();if(console.log("[Router] 路由守卫检查:"),console.log("  - 目标路径:",e.path),console.log("  - 来源路径:",t.path),console.log("  - token:",a.token?"已设置":"未设置"),console.log("  - isLoggedIn:",a.isLoggedIn),console.log("  - localStorage token:",localStorage.getItem("auth_token")?"已设置":"未设置"),e.meta.title&&(document.title=`${e.meta.title} - CRM系统`),"/login"===e.path&&a.token)s("/dashboard");else{if(e.meta.requiresAuth&&!a.token){if(localStorage.getItem("auth_token")){console.log("[Router] ⚠️ Store中token为空但localStorage有token，尝试恢复...");try{if(await a.initUser(),a.token)return console.log("[Router] ✅ Token恢复成功，继续导航"),void s()}catch(r){console.error("[Router] Token恢复失败:",r)}}return V.error("请先登录"),void s("/login")}if(e.meta.requiresAdmin&&!a.isAdmin)return V.error("需要管理员权限"),void s("/dashboard");if(e.meta.requiresManager&&!a.isManager&&!a.isAdmin)return V.error("需要经理权限"),void s("/dashboard");if(e.meta.requiresSuperAdmin&&!a.isSuperAdmin)return V.error("需要超级管理员权限"),void s("/dashboard");if(e.meta.requiresSpecialPermission){if(!(a.isSuperAdmin||a.isWhitelistMember||a.permissions?.includes("logistics:status")||"manager"===a.currentUser?.role||"department_head"===a.currentUser?.role||"logistics"===a.currentUser?.department&&"supervisor"===a.currentUser?.position))return V.error("您没有访问该功能的权限，请联系管理员"),void s("/dashboard")}s()}}),Jt.onError(e=>{e.message&&(e.message.includes("Avoided redundant navigation")||e.message.includes("Navigation cancelled")||e.message.includes("with a new navigation")||e.message.includes("NavigationDuplicated"))||(console.error("路由错误:",e),V.error("页面加载失败，请刷新重试"))}),Jt.afterEach((e,t,s)=>{s&&console.debug("[Router] 导航状态:",s.message||s)});const Kt=ue.create({baseURL:"/api/v1",timeout:3e4,headers:{"Content-Type":"application/json"}});let Yt=0;const Wt=new Map,Qt=e=>`${e.method}_${e.url}_${JSON.stringify(e.params)}_${JSON.stringify(e.data)}`;Kt.interceptors.request.use(e=>{const t=ys(),s=Bt();t.token&&(e.headers=e.headers||{},e.headers.Authorization=`Bearer ${t.token}`),e.headers=e.headers||{},e.headers["X-Request-ID"]=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;const a=Qt(e);Wt.has(a)&&Wt.get(a)?.abort();const r=new AbortController;return e.signal=r.signal,Wt.set(a,r),!1!==e.showLoading&&(Yt++,1===Yt&&s.showLoading({id:"global",text:e.loadingText||"加载中..."})),"get"===e.method?.toLowerCase()&&(e.params={...e.params,_t:Date.now()}),console.log(`[API Request] ${e.method?.toUpperCase()} ${e.url}`,{params:e.params,data:e.data,headers:e.headers}),e},e=>{const t=Bt();return Yt=Math.max(0,Yt-1),0===Yt&&t.hideLoading("global"),console.error("[API Request Error]",e),Promise.reject(e)}),Kt.interceptors.response.use(e=>{const t=Bt(),s=e.config;Yt=Math.max(0,Yt-1),0===Yt&&t.hideLoading("global");const a=Qt(s);Wt.delete(a),console.log(`[API Response] ${s.method?.toUpperCase()} ${s.url}`,{status:e.status,data:e.data});const{code:r,message:o,data:n,success:i}=e.data;if(!i||200!==r){const e=o||"请求失败";switch(r){case 401:console.log("[Request] ⚠️ 收到401错误，已忽略（保持登录状态）");break;case 403:V.error("没有权限访问此资源");break;case 404:V.error("请求的资源不存在");break;case 429:V.warning("请求过于频繁，请稍后重试");break;default:!1!==s.showError&&t.showError({title:s.errorTitle||"请求失败",message:e,type:"error"})}return Promise.reject(new Error(e))}return n},async e=>{const t=Bt(),s=e.config;if(Yt=Math.max(0,Yt-1),0===Yt&&t.hideLoading("global"),s){const e=Qt(s);Wt.delete(e)}if(console.error(`[API Error] ${s?.method?.toUpperCase()} ${s?.url}`,e),ue.isCancel(e))return console.log("Request canceled:",e.message),Promise.reject(e);let a="网络错误，请稍后重试";if(e.response){const{status:t,data:s}=e.response;switch(t){case 400:a=s?.message||"请求参数错误";break;case 401:return console.log("[Request] ⚠️ 收到401错误，已忽略（保持登录状态）"),Promise.reject(e);case 403:a="没有权限访问此资源";break;case 404:a="请求的资源不存在";break;case 408:a="请求超时，请重试";break;case 429:a="请求过于频繁，请稍后重试";break;case 500:a="服务器内部错误";break;case 502:a="网关错误";break;case 503:a="服务暂时不可用";break;case 504:a="网关超时";break;default:a=s?.message||`服务器错误 (${t})`}}else e.request&&(navigator.onLine?a="网络连接失败，请检查网络设置":(a="网络连接已断开，请检查网络设置",t.setOnlineStatus(!1)));return s?.retry&&(s.maxRetries||3)>0?(s.maxRetries=(s.maxRetries||3)-1,await new Promise(e=>setTimeout(e,1e3)),console.log(`[API Retry] ${s.method?.toUpperCase()} ${s.url}, remaining retries: ${s.maxRetries}`),Kt(s)):(!1!==s?.showError&&t.showError({title:s?.errorTitle||"请求失败",message:a,type:"error"}),Promise.reject(new Error(a)))});const Xt={get:(e,t)=>Kt.get(e,t),post:(e,t,s)=>Kt.post(e,t,s),put:(e,t,s)=>Kt.put(e,t,s),delete:(e,t)=>Kt.delete(e,t),patch:(e,t,s)=>Kt.patch(e,t,s),upload(e,t,s){const a=new FormData;return a.append("file",t),Kt.post(e,a,{...s,headers:{"Content-Type":"multipart/form-data",...s?.headers},onUploadProgress:e=>{if(e.total&&s?.onProgress){const t=Math.round(100*e.loaded/e.total);s.onProgress(t)}}})}},Zt=Ct("performance",()=>{const e=xt(),r=()=>Dt(),o=ys(),n=s(null),i=s([]),c=s([{id:"1",name:"产品A",salesAmount:35200,orderCount:28,trend:12.5},{id:"2",name:"产品B",salesAmount:28900,orderCount:22,trend:8.3},{id:"3",name:"产品C",salesAmount:22300,orderCount:18,trend:-2.1}]),l=s([]),d=a(()=>{let e=l.value;const t=o.currentUser;t&&("super_admin"===t.role||"admin"===t.role||(e=(t.role,e.filter(e=>e.createdById===t.id||e.createdBy===t.name))));return{totalShares:e.length,totalAmount:e.reduce((e,t)=>e+t.orderAmount,0),involvedMembers:new Set(e.flatMap(e=>e.shareMembers.map(e=>e.userId))).size,sharedOrders:e.length,pendingShares:e.filter(e=>"active"===e.status).length,completedShares:e.filter(e=>"completed"===e.status).length}}),u=a(()=>{const t=o.currentUser?.id;if(!t)return{totalSales:0,salesTrend:0,totalOrders:0,ordersTrend:0,newCustomers:0,customersTrend:0,conversionRate:0,conversionTrend:0};const s=e.orders.filter(e=>e.salesPersonId===t&&"approved"===e.auditStatus),a=r().customers.filter(e=>e.salesPersonId===t);let n=0;const i=new Map;l.value.filter(e=>"active"===e.status||"completed"===e.status).forEach(e=>{const t=e.shareMembers.filter(e=>"confirmed"===e.status||"pending"===e.status).map(e=>({userId:e.userId,percentage:e.percentage,shareAmount:e.shareAmount}));i.set(e.orderId,t)}),s.forEach(e=>{const t=i.get(e.id);if(t&&t.length>0){const s=100-t.reduce((e,t)=>e+t.percentage,0),a=e.totalAmount*s/100;n+=a}else n+=e.totalAmount}),l.value.filter(e=>"active"===e.status||"completed"===e.status).forEach(e=>{const s=e.shareMembers.find(e=>e.userId===t&&("confirmed"===e.status||"pending"===e.status));s&&(n+=s.shareAmount)});const c=s.length,d=a.length;return{totalSales:n,salesTrend:12.5,totalOrders:c,ordersTrend:8.3,newCustomers:d,customersTrend:-2.1,conversionRate:d>0?c/d*100:0,conversionTrend:5.2}}),m=a(()=>{const e=i.value.reduce((e,t)=>e+t.salesAmount,0),t=i.value.reduce((e,t)=>e+t.orderCount,0),s=i.value.length;return{totalSales:e,salesTrend:15.8,memberCount:s,activeMemberCount:i.value.filter(e=>e.orderCount>0).length,totalOrders:t,ordersTrend:12.3,avgPerformance:s>0?e/s:0,avgTrend:8.7}}),p=a(()=>[...i.value].sort((e,t)=>t.salesAmount-e.salesAmount).map((e,t)=>({...e,rank:t+1}))),g=()=>{const e=new Date;return`SH${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${String(l.value.length+1).padStart(4,"0")}`},h=async e=>{for(const t of e.shareMembers){const e=i.value.find(e=>e.id===t.userId);e&&(e.salesAmount+=t.shareAmount,e.commission+=.1*t.shareAmount)}},v=async e=>{for(const t of e.shareMembers){const e=i.value.find(e=>e.id===t.userId);e&&(e.salesAmount-=t.shareAmount,e.commission-=.1*t.shareAmount)}},y=async()=>{console.log("[Performance Store] 开始同步业绩数据");const e=xt();ys(),i.value.forEach(e=>{e.salesAmount=0,e.orderCount=0,e.commission=0});const t=(e=>{const t=o.currentUser;return t?"admin"===t.role?e:"department_manager"===t.role?e.filter(e=>e.salesPersonId===t.id||e.createdBy===t.name):"sales_staff"===t.role?e.filter(e=>e.salesPersonId===t.id):"customer_service"===t.role?e.filter(e=>e.customerServiceId===t.id):e.filter(e=>e.salesPersonId===t.id||e.customerServiceId===t.id):[]})(e.orders),s=new Map;l.value.filter(e=>"active"===e.status||"completed"===e.status).forEach(e=>{const t=e.shareMembers.filter(e=>"confirmed"===e.status||"pending"===e.status).map(e=>({userId:e.userId,percentage:e.percentage,shareAmount:e.shareAmount}));s.set(e.orderId,t)}),t.forEach(e=>{if("shipped"===e.status||"delivered"===e.status||"approved"===e.auditStatus){const t=s.get(e.id);if(t&&t.length>0){const s=t.reduce((e,t)=>e+t.percentage,0),a=100-s,r=e.totalAmount*a/100,o=i.value.find(t=>t.id===e.salesPersonId);o&&(o.salesAmount+=r,o.orderCount+=1,o.commission+=.1*r,console.log(`[Performance Store] 订单 ${e.orderNumber} (有分享):`,{"下单员":o.name,"订单金额":e.totalAmount,"分享总比例":s+"%","保留比例":a+"%","保留金额":r.toFixed(2)})),t.forEach(e=>{const t=i.value.find(t=>t.id===e.userId);t&&(t.salesAmount+=e.shareAmount,t.commission+=.1*e.shareAmount,console.log(`[Performance Store] 分享给 ${t.name}:`,{"分享金额":e.shareAmount.toFixed(2),"分享比例":e.percentage+"%"}))})}else{const t=i.value.find(t=>t.id===e.salesPersonId);t&&(t.salesAmount+=e.totalAmount,t.orderCount+=1,t.commission+=.1*e.totalAmount,console.log(`[Performance Store] 订单 ${e.orderNumber} (无分享):`,{"下单员":t.name,"订单金额":e.totalAmount}))}}}),i.value.forEach(e=>{e.targetCompletion=Math.round(e.salesAmount/8e4*100),e.targetCompletion>=120?e.performance="excellent":e.targetCompletion>=100?e.performance="good":e.targetCompletion>=80?e.performance="normal":e.performance="poor"}),console.log("[Performance Store] 业绩数据同步完成"),console.log("[Performance Store] 团队成员业绩:",i.value.map(e=>({"姓名":e.name,"业绩":e.salesAmount.toFixed(2),"订单数":e.orderCount,"目标完成率":e.targetCompletion+"%"})))};return t(()=>l.value,()=>{y()},{deep:!0}),{dateRange:n,teamMembers:i,productPerformance:c,performanceShares:l,personalPerformance:u,teamPerformance:m,salesRanking:p,shareStats:d,updateDateRange:e=>{n.value=e},getUserPerformance:t=>{const s=e.orders.filter(e=>e.salesPersonId===t&&"approved"===e.auditStatus),a=r().customers.filter(e=>e.salesPersonId===t),o=s.reduce((e,t)=>e+t.totalAmount,0),n=s.length,i=a.length;return{totalSales:o,salesTrend:12.5,totalOrders:n,ordersTrend:8.3,newCustomers:i,customersTrend:-2.1,conversionRate:n>0?n/i*100:0,conversionTrend:5.2}},updateTeamMember:(e,t)=>{const s=i.value.findIndex(t=>t.id===e);-1!==s&&(i.value[s]={...i.value[s],...t})},addTeamMember:e=>{i.value.push(e)},removeTeamMember:e=>{const t=i.value.findIndex(t=>t.id===e);-1!==t&&i.value.splice(t,1)},getProductRanking:()=>[...c.value].sort((e,t)=>t.salesAmount-e.salesAmount),refreshPerformanceData:async()=>{await new Promise(e=>setTimeout(e,1e3)),console.log("业绩数据已刷新")},syncPerformanceData:y,loadTeamMembersFromUserStore:async()=>{try{const{useUserStore:e}=await ge(async()=>{const{useUserStore:e}=await Promise.resolve().then(()=>fs);return{useUserStore:e}},void 0),t=e();0===t.users.length&&await t.loadUsers(),i.value=t.users.filter(e=>["sales_staff","department_manager","admin","super_admin"].includes(e.role)).map(e=>({id:e.id,name:e.realName||e.name||e.username,position:e.position||"销售专员",avatar:e.avatar||"",salesAmount:0,orderCount:0,customerCount:0,targetCompletion:0,performance:"good",commission:0})),console.log("[Performance Store] 从userStore加载团队成员:",i.value.length)}catch(e){console.error("[Performance Store] 加载团队成员失败:",e)}},createPerformanceShare:async e=>{try{console.log("[Performance Store] 创建业绩分享:",e);try{const t=await(void 0)({orderId:e.orderId,orderNumber:e.orderNumber,orderAmount:e.orderAmount,shareMembers:e.shareMembers.map(e=>({userId:e.userId,userName:e.userName,percentage:e.percentage})),description:e.description});if(t.data.success){const e=t.data.data;return l.value.unshift(e),await h(e),await y(),console.log("[Performance Store] API创建业绩分享成功"),e}}catch(t){console.warn("[Performance Store] API调用失败，使用本地存储:",t)}const s={id:`share_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,shareNumber:g(),orderId:e.orderId,orderNumber:e.orderNumber,orderAmount:e.orderAmount,shareMembers:e.shareMembers.map(t=>({...t,shareAmount:e.orderAmount*t.percentage/100,status:"confirmed"})),status:"active",createTime:(new Date).toLocaleString(),createdBy:e.createdBy,createdById:e.createdById,description:e.description};return console.log("[Performance Store] 新分享记录:",s),l.value.unshift(s),await h(s),await y(),console.log("[Performance Store] 本地创建业绩分享成功"),s}catch(s){throw console.error("[Performance Store] 创建业绩分享失败:",s),s}},updatePerformanceShare:async(e,t)=>{const s=l.value.findIndex(t=>t.id===e);return-1!==s?(l.value[s],l.value[s]={...l.value[s],...t},t.shareMembers&&(l.value[s].shareMembers=t.shareMembers.map(e=>({...e,shareAmount:l.value[s].orderAmount*e.percentage/100}))),l.value[s]):null},cancelPerformanceShare:async e=>{const t=Ht(),s=l.value.find(t=>t.id===e);return!(!s||"active"!==s.status)&&(s.status="cancelled",await v(s),s.shareMembers.forEach(a=>{a.userId!==o.currentUser?.id&&t.sendMessage(jt.PERFORMANCE_SHARE_CANCELLED,`${o.currentUser?.name} 取消了业绩分享，订单 ${s.orderNumber}`,{relatedId:e,relatedType:"performance_share",actionUrl:`/performance/share?id=${e}`})}),!0)},confirmShareMember:async(e,t)=>{const s=Ht(),a=l.value.find(t=>t.id===e);if(a){const r=a.shareMembers.find(e=>e.userId===t);if(r&&"pending"===r.status){r.status="confirmed",r.confirmTime=(new Date).toLocaleString();return a.shareMembers.every(e=>"confirmed"===e.status)&&(a.status="completed",a.completedTime=(new Date).toLocaleString()),s.sendMessage(jt.PERFORMANCE_SHARE_CONFIRMED,`${r.userName} 已确认业绩分享，订单 ${a.orderNumber}，分成金额 ¥${r.shareAmount.toFixed(2)}`,{relatedId:e,relatedType:"performance_share",actionUrl:`/performance/share?id=${e}`}),!0}}return!1},rejectShareMember:async(e,t,s)=>{const a=Ht(),r=l.value.find(t=>t.id===e);if(r){const o=r.shareMembers.find(e=>e.userId===t);if(o&&"pending"===o.status)return o.status="rejected",o.confirmTime=(new Date).toLocaleString(),a.sendMessage(jt.PERFORMANCE_SHARE_REJECTED,`${o.userName} 拒绝了业绩分享，订单 ${r.orderNumber}${s?`，原因：${s}`:""}`,{relatedId:e,relatedType:"performance_share",actionUrl:`/performance/share?id=${e}`}),!0}return!1},getUserShares:e=>l.value.filter(t=>t.shareMembers.some(t=>t.userId===e)||t.createdById===e),loadPerformanceShares:async e=>{try{const t=await(void 0)(e);if(t.data.success)return l.value=t.data.data.shares,t.data.data;throw new Error(t.data.message||"加载业绩分享数据失败")}catch(t){throw console.error("加载业绩分享数据失败:",t),t}},loadShareStats:async()=>{try{const e=await(void 0)();if(e.data.success)return e.data.data;throw new Error(e.data.message||"加载统计数据失败")}catch(e){throw console.error("加载统计数据失败:",e),e}},getOrderShares:e=>l.value.filter(t=>t.orderId===e),getPersonalAnalysisData:async e=>{try{const t=await(void 0)(e);if(t.data.success)return t.data.data;throw new Error(t.data.message||"获取个人业绩分析数据失败")}catch(t){throw console.error("获取个人业绩分析数据失败:",t),t}},getDepartmentAnalysisData:async e=>{try{const t=await(void 0)(e);if(t.data.success)return t.data.data;throw new Error(t.data.message||"获取部门业绩分析数据失败")}catch(t){throw console.error("获取部门业绩分析数据失败:",t),t}},getCompanyAnalysisData:async e=>{try{const t=await(void 0)(e);if(t.data.success)return t.data.data;throw new Error(t.data.message||"获取公司业绩分析数据失败")}catch(t){throw console.error("获取公司业绩分析数据失败:",t),t}},getAnalysisMetrics:async e=>{try{const t=await(void 0)(e);if(t.data.success)return t.data.data;throw new Error(t.data.message||"获取业绩统计指标失败")}catch(t){throw console.error("获取业绩统计指标失败:",t),t}}}});const es=new class{config={enabled:!1,interval:30,batchSize:50,retryCount:3,syncToPerformance:!0,syncToOrderList:!0};syncTimer=null;isRunning=!1;lastSyncTime="";constructor(){this.loadConfig()}loadConfig(){const e=localStorage.getItem("autoStatusSyncConfig");if(e)try{this.config={...this.config,...JSON.parse(e)}}catch(t){console.error("加载自动同步配置失败:",t)}}saveConfig(){try{localStorage.setItem("autoStatusSyncConfig",JSON.stringify(this.config))}catch(e){console.error("保存自动同步配置失败:",e)}}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},this.saveConfig(),void 0!==e.enabled?e.enabled?this.start():this.stop():this.config.enabled&&e.interval&&this.restart()}start(){!this.isRunning&&this.config.enabled&&(this.isRunning=!0,this.syncTimer=setInterval(()=>{this.performAutoSync()},60*this.config.interval*1e3),console.log(`自动状态同步服务已启动，检测间隔: ${this.config.interval}分钟`),V.success("自动状态同步服务已启动"))}stop(){this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null),this.isRunning=!1,console.log("自动状态同步服务已停止")}restart(){this.stop(),this.config.enabled&&this.start()}async performAutoSync(){const e={success:!1,updatedCount:0,errorCount:0,errors:[],lastSyncTime:(new Date).toISOString()};try{console.log("开始执行自动状态同步...");Vt();const s=await this.getPendingOrders();if(0===s.length)return console.log("没有需要同步的订单"),e.success=!0,this.lastSyncTime=e.lastSyncTime,e;const a=this.chunkArray(s,this.config.batchSize);for(const r of a)try{const t=await this.processBatch(r);e.updatedCount+=t.updatedCount,e.errorCount+=t.errorCount,e.errors.push(...t.errors)}catch(t){console.error("批次处理失败:",t),e.errorCount+=r.length,e.errors.push(`批次处理失败: ${t}`)}e.updatedCount>0&&await this.syncToOtherModules(e.updatedCount),e.success=0===e.errorCount,this.lastSyncTime=e.lastSyncTime,console.log(`自动同步完成: 更新${e.updatedCount}个订单, 错误${e.errorCount}个`),e.updatedCount>0&&V.success(`自动同步完成，更新了${e.updatedCount}个订单状态`)}catch(t){console.error("自动同步执行失败:",t),e.errors.push(`同步执行失败: ${t}`),e.errorCount++}return e}async getPendingOrders(){const e=Vt(),t=["shipping","delivering","picked"],s=[];for(const r of t)try{const t=await e.fetchOrderList({status:r,pageSize:this.config.batchSize});s.push(...t.filter(e=>e.trackingNo))}catch(a){console.error(`获取${r}状态订单失败:`,a)}return s}async processBatch(e){const t={updatedCount:0,errorCount:0,errors:[]},s=Vt();for(const r of e){let e=0,o=!1;for(;e<this.config.retryCount&&!o;)try{const e=await s.fetchTrackingInfo(r.trackingNo);if(e.length>0){const a=e[0],o=this.determineStatusFromTracking(a.description);o&&o!==r.status&&(await s.updateOrderStatus(r.id,{status:o,remark:`自动同步: ${a.description}`,autoUpdated:!0}),t.updatedCount++,console.log(`订单${r.orderNo}状态已更新: ${r.status} -> ${o}`))}o=!0}catch(a){e++,console.error(`处理订单${r.orderNo}失败 (重试${e}/${this.config.retryCount}):`,a),e>=this.config.retryCount?(t.errorCount++,t.errors.push(`订单${r.orderNo}处理失败: ${a}`)):await new Promise(t=>setTimeout(t,1e3*e))}}return t}determineStatusFromTracking(e){const t=e.toLowerCase();return t.includes("签收")||t.includes("已收货")?"delivered":t.includes("拒收")||t.includes("拒绝")?"rejected":t.includes("派送")||t.includes("配送")?"delivering":t.includes("运输")||t.includes("转运")?"shipping":t.includes("揽收")||t.includes("收件")?"picked":null}async syncToOtherModules(e){try{if(this.config.syncToPerformance){const e=Zt();e.refreshData&&await e.refreshData()}if(this.config.syncToOrderList){const e=xt();e.refreshData&&await e.refreshData()}}catch(t){console.error("同步到其他模块失败:",t)}}chunkArray(e,t){const s=[];for(let a=0;a<e.length;a+=t)s.push(e.slice(a,a+t));return s}async manualSync(){if(this.isRunning)throw new Error("自动同步正在运行中，请稍后再试");return await this.performAutoSync()}getStatus(){return{isRunning:this.isRunning,lastSyncTime:this.lastSyncTime,config:this.getConfig()}}},ts=[{id:"dashboard",name:"数据看板",code:"dashboard",type:"menu",icon:"Odometer",sort:1,children:[{id:"dashboard_view",name:"查看数据看板",code:"dashboard:view",type:"action",parentId:"dashboard"}]},{id:"customer",name:"客户管理",code:"customer",type:"menu",icon:"User",sort:2,children:[{id:"customer_list",name:"客户列表",code:"customer:list",type:"page",parentId:"customer",children:[{id:"customer_list_view",name:"查看客户",code:"customer:list:view",type:"action",parentId:"customer_list"},{id:"customer_list_create",name:"新增客户",code:"customer:list:create",type:"action",parentId:"customer_list"},{id:"customer_list_edit",name:"编辑客户",code:"customer:list:edit",type:"action",parentId:"customer_list"},{id:"customer_list_delete",name:"删除客户",code:"customer:list:delete",type:"action",parentId:"customer_list"},{id:"customer_list_export",name:"导出客户",code:"customer:list:export",type:"action",parentId:"customer_list"},{id:"customer_list_assign",name:"分配客户",code:"customer:list:assign",type:"action",parentId:"customer_list"}]},{id:"customer_add",name:"新增客户",code:"customer:add",type:"page",parentId:"customer",children:[{id:"customer_add_create",name:"创建客户",code:"customer:add:create",type:"action",parentId:"customer_add"}]},{id:"customer_tags",name:"客户标签",code:"customer:tags",type:"page",parentId:"customer",children:[{id:"customer_tags_view",name:"查看标签",code:"customer:tags:view",type:"action",parentId:"customer_tags"},{id:"customer_tags_manage",name:"管理标签",code:"customer:tags:manage",type:"action",parentId:"customer_tags"}]},{id:"customer_groups",name:"客户分组",code:"customer:groups",type:"page",parentId:"customer",children:[{id:"customer_groups_view",name:"查看分组",code:"customer:groups:view",type:"action",parentId:"customer_groups"},{id:"customer_groups_manage",name:"管理分组",code:"customer:groups:manage",type:"action",parentId:"customer_groups"}]}]},{id:"order",name:"订单管理",code:"order",type:"menu",icon:"ShoppingCart",sort:3,children:[{id:"order_list",name:"订单列表",code:"order:list",type:"page",parentId:"order",children:[{id:"order_list_view",name:"查看订单",code:"order:list:view",type:"action",parentId:"order_list"},{id:"order_list_edit",name:"编辑订单",code:"order:list:edit",type:"action",parentId:"order_list"},{id:"order_list_delete",name:"删除订单",code:"order:list:delete",type:"action",parentId:"order_list"},{id:"order_list_export",name:"导出订单",code:"order:list:export",type:"action",parentId:"order_list"}]},{id:"order_add",name:"新增订单",code:"order:add",type:"page",parentId:"order",children:[{id:"order_add_create",name:"创建订单",code:"order:add:create",type:"action",parentId:"order_add"}]},{id:"order_audit",name:"订单审核",code:"order:audit",type:"page",parentId:"order",children:[{id:"order_audit_view",name:"查看审核",code:"order:audit:view",type:"action",parentId:"order_audit"},{id:"order_audit_approve",name:"通过审核",code:"order:audit:approve",type:"action",parentId:"order_audit"},{id:"order_audit_reject",name:"拒绝审核",code:"order:audit:reject",type:"action",parentId:"order_audit"}]}]},{id:"service_management",name:"服务管理",code:"service_management",type:"menu",icon:"Headset",sort:4,children:[{id:"service_call",name:"通话管理",code:"service:call",type:"page",parentId:"service_management",children:[{id:"service_call_view",name:"查看通话",code:"service:call:view",type:"action",parentId:"service_call"},{id:"service_call_record",name:"录音管理",code:"service:call:record",type:"action",parentId:"service_call"},{id:"service_call_config",name:"电话配置",code:"service:call:config",type:"action",parentId:"service_call"}]},{id:"service_sms",name:"短信管理",code:"service:sms",type:"page",parentId:"service_management",children:[{id:"service_sms_view",name:"查看短信",code:"service:sms:view",type:"action",parentId:"service_sms"},{id:"service_sms_send",name:"发送短信",code:"service:sms:send",type:"action",parentId:"service_sms"},{id:"service_sms_audit",name:"短信审核",code:"service:sms:audit",type:"action",parentId:"service_sms"},{id:"service_sms_analyze",name:"短信统计",code:"service:sms:analyze",type:"action",parentId:"service_sms"}]}]},{id:"performance",name:"业绩统计",code:"performance",type:"menu",icon:"TrendCharts",sort:5,children:[{id:"performance_personal",name:"个人业绩",code:"performance:personal",type:"page",parentId:"performance",children:[{id:"performance_personal_view",name:"查看个人业绩",code:"performance:personal:view",type:"action",parentId:"performance_personal"}]},{id:"performance_team",name:"团队业绩",code:"performance:team",type:"page",parentId:"performance",children:[{id:"performance_team_view",name:"查看团队业绩",code:"performance:team:view",type:"action",parentId:"performance_team"}]},{id:"performance_analysis",name:"业绩分析",code:"performance:analysis",type:"page",parentId:"performance",children:[{id:"performance_analysis_view",name:"查看业绩分析",code:"performance:analysis:view",type:"action",parentId:"performance_analysis"}]},{id:"performance_share",name:"业绩分享",code:"performance:share",type:"page",parentId:"performance",children:[{id:"performance_share_view",name:"查看分享",code:"performance:share:view",type:"action",parentId:"performance_share"},{id:"performance_share_create",name:"创建分享",code:"performance:share:create",type:"action",parentId:"performance_share"}]}]},{id:"logistics",name:"物流管理",code:"logistics",type:"menu",icon:"Van",sort:6,children:[{id:"logistics_shipping",name:"发货列表",code:"logistics:shipping",type:"page",parentId:"logistics",children:[{id:"logistics_shipping_view",name:"查看发货",code:"logistics:shipping:view",type:"action",parentId:"logistics_shipping"},{id:"logistics_shipping_edit",name:"编辑发货",code:"logistics:shipping:edit",type:"action",parentId:"logistics_shipping"},{id:"logistics_shipping_send",name:"确认发货",code:"logistics:shipping:send",type:"action",parentId:"logistics_shipping"}]},{id:"logistics_list",name:"物流列表",code:"logistics:list",type:"page",parentId:"logistics",children:[{id:"logistics_list_view",name:"查看物流",code:"logistics:list:view",type:"action",parentId:"logistics_list"}]},{id:"logistics_status_update",name:"状态更新",code:"logistics:status_update",type:"page",parentId:"logistics",children:[{id:"logistics_status_update_edit",name:"更新状态",code:"logistics:status_update:edit",type:"action",parentId:"logistics_status_update"}]},{id:"logistics_track",name:"物流跟踪",code:"logistics:track",type:"page",parentId:"logistics",children:[{id:"logistics_track_view",name:"查看跟踪",code:"logistics:track:view",type:"action",parentId:"logistics_track"}]},{id:"logistics_companies",name:"物流公司",code:"logistics:companies",type:"page",parentId:"logistics",children:[{id:"logistics_companies_view",name:"查看公司",code:"logistics:companies:view",type:"action",parentId:"logistics_companies"},{id:"logistics_companies_manage",name:"管理公司",code:"logistics:companies:manage",type:"action",parentId:"logistics_companies"}]}]},{id:"service",name:"售后管理",code:"service",type:"menu",icon:"CustomerService",sort:7,children:[{id:"service_list",name:"售后订单",code:"service:list",type:"page",parentId:"service",children:[{id:"service_list_view",name:"查看售后",code:"service:list:view",type:"action",parentId:"service_list"},{id:"service_list_edit",name:"处理售后",code:"service:list:edit",type:"action",parentId:"service_list"},{id:"service_list_close",name:"关闭售后",code:"service:list:close",type:"action",parentId:"service_list"}]},{id:"service_add",name:"新建售后",code:"service:add",type:"page",parentId:"service",children:[{id:"service_add_create",name:"创建售后",code:"service:add:create",type:"action",parentId:"service_add"}]},{id:"service_data",name:"售后数据",code:"service:data",type:"page",parentId:"service",children:[{id:"service_data_view",name:"查看数据",code:"service:data:view",type:"action",parentId:"service_data"}]}]},{id:"data",name:"资料管理",code:"data",type:"menu",icon:"Files",sort:8,children:[{id:"data_list",name:"资料列表",code:"data:list",type:"page",parentId:"data",children:[{id:"data_list_view",name:"查看资料",code:"data:list:view",type:"action",parentId:"data_list"},{id:"data_list_assign",name:"分配资料",code:"data:list:assign",type:"action",parentId:"data_list"},{id:"data_list_transfer",name:"转移资料",code:"data:list:transfer",type:"action",parentId:"data_list"}]},{id:"data_search",name:"客户查询",code:"data:search",type:"page",parentId:"data",children:[{id:"data_search_view",name:"查询客户",code:"data:search:view",type:"action",parentId:"data_search"}]},{id:"data_recycle",name:"回收站",code:"data:recycle",type:"page",parentId:"data",children:[{id:"data_recycle_view",name:"查看回收站",code:"data:recycle:view",type:"action",parentId:"data_recycle"},{id:"data_recycle_restore",name:"恢复数据",code:"data:recycle:restore",type:"action",parentId:"data_recycle"},{id:"data_recycle_delete",name:"永久删除",code:"data:recycle:delete",type:"action",parentId:"data_recycle"}]}]},{id:"product",name:"商品管理",code:"product",type:"menu",icon:"Box",sort:9,children:[{id:"product_list",name:"商品列表",code:"product:list",type:"page",parentId:"product",children:[{id:"product_list_view",name:"查看商品",code:"product:list:view",type:"action",parentId:"product_list"},{id:"product_list_edit",name:"编辑商品",code:"product:list:edit",type:"action",parentId:"product_list"}]},{id:"product_add",name:"新增商品",code:"product:add",type:"page",parentId:"product",children:[{id:"product_add_create",name:"创建商品",code:"product:add:create",type:"action",parentId:"product_add"}]},{id:"product_category",name:"商品分类",code:"product:category",type:"page",parentId:"product",children:[{id:"product_category_view",name:"查看分类",code:"product:category:view",type:"action",parentId:"product_category"},{id:"product_category_manage",name:"管理分类",code:"product:category:manage",type:"action",parentId:"product_category"}]},{id:"product_inventory",name:"库存管理",code:"product:inventory",type:"page",parentId:"product",children:[{id:"product_inventory_view",name:"查看库存",code:"product:inventory:view",type:"action",parentId:"product_inventory"},{id:"product_inventory_manage",name:"管理库存",code:"product:inventory:manage",type:"action",parentId:"product_inventory"}]},{id:"product_analytics",name:"商品分析",code:"product:analytics",type:"page",parentId:"product",children:[{id:"product_analytics_view",name:"查看分析",code:"product:analytics:view",type:"action",parentId:"product_analytics"}]}]},{id:"system",name:"系统管理",code:"system",type:"menu",icon:"Setting",sort:10,children:[{id:"system_departments",name:"部门管理",code:"system:departments",type:"page",parentId:"system",children:[{id:"system_departments_view",name:"查看部门",code:"system:departments:view",type:"action",parentId:"system_departments"},{id:"system_departments_manage",name:"管理部门",code:"system:departments:manage",type:"action",parentId:"system_departments"}]},{id:"system_users",name:"用户管理",code:"system:users",type:"page",parentId:"system",children:[{id:"system_users_view",name:"查看用户",code:"system:users:view",type:"action",parentId:"system_users"},{id:"system_users_create",name:"创建用户",code:"system:users:create",type:"action",parentId:"system_users"},{id:"system_users_edit",name:"编辑用户",code:"system:users:edit",type:"action",parentId:"system_users"},{id:"system_users_delete",name:"删除用户",code:"system:users:delete",type:"action",parentId:"system_users"}]},{id:"system_roles",name:"角色权限",code:"system:roles",type:"page",parentId:"system",children:[{id:"system_roles_view",name:"查看角色",code:"system:roles:view",type:"action",parentId:"system_roles"},{id:"system_roles_create",name:"创建角色",code:"system:roles:create",type:"action",parentId:"system_roles"},{id:"system_roles_edit",name:"编辑角色",code:"system:roles:edit",type:"action",parentId:"system_roles"},{id:"system_roles_delete",name:"删除角色",code:"system:roles:delete",type:"action",parentId:"system_roles"},{id:"system_roles_permission",name:"权限设置",code:"system:roles:permission",type:"action",parentId:"system_roles"}]},{id:"system_permissions",name:"权限管理",code:"system:permissions",type:"page",parentId:"system",children:[{id:"system_permissions_view",name:"查看权限",code:"system:permissions:view",type:"action",parentId:"system_permissions"},{id:"system_permissions_manage",name:"管理权限",code:"system:permissions:manage",type:"action",parentId:"system_permissions"}]},{id:"system_message",name:"消息管理",code:"system:message",type:"page",parentId:"system",children:[{id:"system_message_view",name:"查看消息",code:"system:message:view",type:"action",parentId:"system_message"},{id:"system_message_send",name:"发送消息",code:"system:message:send",type:"action",parentId:"system_message"}]},{id:"system_settings",name:"系统设置",code:"system:settings",type:"page",parentId:"system",children:[{id:"system_settings_view",name:"查看设置",code:"system:settings:view",type:"action",parentId:"system_settings"},{id:"system_settings_edit",name:"修改设置",code:"system:settings:edit",type:"action",parentId:"system_settings"}]}]}],ss={basic:{name:"基础权限",description:"基本的查看和操作权限",permissions:["dashboard:view","customer:list:view","order:list:view","performance:personal:view"]},advanced:{name:"高级权限",description:"包含编辑和管理权限",permissions:["dashboard:view","customer:list:view","customer:list:edit","customer:list:create","order:list:view","order:list:edit","order:add:create","performance:personal:view","performance:team:view"]},manager:{name:"经理权限",description:"部门经理级别权限",permissions:["dashboard:view","customer:list:view","customer:list:edit","customer:list:create","customer:list:assign","order:list:view","order:list:edit","order:add:create","order:audit:view","order:audit:approve","performance:personal:view","performance:team:view","performance:analysis:view","product:add:create","product:inventory:manage"]},admin:{name:"管理员权限",description:"系统管理员权限",permissions:["dashboard:view","customer","order","service_management","performance","logistics","service","data","product","system:departments","system:users","system:roles","system:message","system:settings"]}};let as=[];function rs(e){as=e}function os(e){if(!e)return!0;if(as.includes("*"))return!0;if(as.includes("admin")||as.includes("system"))return!0;if(as.includes(e))return!0;const t=function(e){function t(s){for(const a of s){if(a.code===e)return a;if(a.children){const e=t(a.children);if(e)return e}}return null}return t(ts)}(e);if(t&&t.parentId){const e=function(e){function t(s){for(const a of s){if(a.id===e)return a;if(a.children){const e=t(a.children);if(e)return e}}return null}return t(ts)}(t.parentId);if(e)return os(e.code)}return!1}function ns(e){return e.some(e=>os(e))}function is(e){return e.every(e=>os(e))}function cs(e,t){const{value:s}=t;if(s){let t=!1;t=Array.isArray(s)?ns(s):os(s),t||(e.style.display="none")}}const ls=[{id:"dashboard",name:"数据看板",code:"dashboard",type:"module",path:"/dashboard",icon:"Odometer",sort:1,status:"active",children:[{id:"dashboard.view",name:"查看看板",code:"dashboard.view",type:"action",sort:1,status:"active"},{id:"dashboard.export",name:"导出数据",code:"dashboard.export",type:"action",sort:2,status:"active"}]},{id:"customer",name:"客户管理",code:"customer",type:"module",path:"/customer",icon:"User",sort:2,status:"active",children:[{id:"customer.list",name:"客户列表",code:"customer.list",type:"menu",path:"/customer/list",icon:"List",sort:1,status:"active",children:[{id:"customer.list.view",name:"查看列表",code:"customer.list.view",type:"action",sort:1,status:"active"},{id:"customer.list.export",name:"导出客户",code:"customer.list.export",type:"action",sort:2,status:"active"},{id:"customer.list.import",name:"导入客户",code:"customer.list.import",type:"action",sort:3,status:"active"},{id:"customer.list.edit",name:"编辑客户",code:"customer.list.edit",type:"action",sort:4,status:"active"},{id:"customer.list.delete",name:"删除客户",code:"customer.list.delete",type:"action",sort:5,status:"active"},{id:"customer.list.assign",name:"分配客户",code:"customer.list.assign",type:"action",sort:6,status:"active"}]},{id:"customer.add",name:"新增客户",code:"customer.add",type:"menu",path:"/customer/add",icon:"Plus",sort:2,status:"active",children:[{id:"customer.add.create",name:"创建客户",code:"customer.add.create",type:"action",sort:1,status:"active"}]},{id:"customer.groups",name:"客户分组",code:"customer.groups",type:"menu",path:"/customer/groups",icon:"Collection",sort:3,status:"active",children:[{id:"customer.groups.view",name:"查看分组",code:"customer.groups.view",type:"action",sort:1,status:"active"},{id:"customer.groups.create",name:"新增分组",code:"customer.groups.create",type:"action",sort:2,status:"active"},{id:"customer.groups.edit",name:"编辑分组",code:"customer.groups.edit",type:"action",sort:3,status:"active"},{id:"customer.groups.delete",name:"删除分组",code:"customer.groups.delete",type:"action",sort:4,status:"active"}]},{id:"customer.tags",name:"客户标签",code:"customer.tags",type:"menu",path:"/customer/tags",icon:"PriceTag",sort:4,status:"active",children:[{id:"customer.tags.view",name:"查看标签",code:"customer.tags.view",type:"action",sort:1,status:"active"},{id:"customer.tags.create",name:"新增标签",code:"customer.tags.create",type:"action",sort:2,status:"active"},{id:"customer.tags.edit",name:"编辑标签",code:"customer.tags.edit",type:"action",sort:3,status:"active"},{id:"customer.tags.delete",name:"删除标签",code:"customer.tags.delete",type:"action",sort:4,status:"active"}]}]},{id:"order",name:"订单管理",code:"order",type:"module",path:"/order",icon:"ShoppingCart",sort:3,status:"active",children:[{id:"order.list",name:"订单列表",code:"order.list",type:"menu",path:"/order/list",icon:"List",sort:1,status:"active",children:[{id:"order.list.view",name:"查看订单",code:"order.list.view",type:"action",sort:1,status:"active"},{id:"order.list.export",name:"导出订单",code:"order.list.export",type:"action",sort:2,status:"active"},{id:"order.list.edit",name:"编辑订单",code:"order.list.edit",type:"action",sort:3,status:"active"},{id:"order.list.delete",name:"删除订单",code:"order.list.delete",type:"action",sort:4,status:"active"},{id:"order.list.cancel",name:"取消订单",code:"order.list.cancel",type:"action",sort:5,status:"active"}]},{id:"order.add",name:"新增订单",code:"order.add",type:"menu",path:"/order/add",icon:"Plus",sort:2,status:"active",children:[{id:"order.add.create",name:"创建订单",code:"order.add.create",type:"action",sort:1,status:"active"}]},{id:"order.audit",name:"订单审核",code:"order.audit",type:"menu",path:"/order/audit",icon:"CircleCheck",sort:3,status:"active",children:[{id:"order.audit.view",name:"查看审核",code:"order.audit.view",type:"action",sort:1,status:"active"},{id:"order.audit.approve",name:"通过审核",code:"order.audit.approve",type:"action",sort:2,status:"active"},{id:"order.audit.reject",name:"拒绝审核",code:"order.audit.reject",type:"action",sort:3,status:"active"},{id:"order.audit.batch",name:"批量审核",code:"order.audit.batch",type:"action",sort:4,status:"active"}]}]},{id:"communication",name:"服务管理",code:"communication",type:"module",path:"/service-management",icon:"Headset",sort:4,status:"active",children:[{id:"communication.call",name:"通话管理",code:"communication.call",type:"menu",path:"/service-management/call",icon:"Phone",sort:1,status:"active",children:[{id:"communication.call.view",name:"查看通话记录",code:"communication.call.view",type:"action",sort:1,status:"active"},{id:"communication.call.make",name:"发起通话",code:"communication.call.make",type:"action",sort:2,status:"active"},{id:"communication.call.record",name:"录音管理",code:"communication.call.record",type:"action",sort:3,status:"active"}]},{id:"communication.sms",name:"短信管理",code:"communication.sms",type:"menu",path:"/service-management/sms",icon:"Message",sort:2,status:"active",children:[{id:"communication.sms.view",name:"查看短信记录",code:"communication.sms.view",type:"action",sort:1,status:"active"},{id:"communication.sms.send",name:"发送短信",code:"communication.sms.send",type:"action",sort:2,status:"active"},{id:"communication.sms.template",name:"模板管理",code:"communication.sms.template",type:"action",sort:3,status:"active"}]}]},{id:"performance",name:"业绩统计",code:"performance",type:"module",path:"/performance",icon:"TrendCharts",sort:5,status:"active",children:[{id:"performance.personal",name:"个人业绩",code:"performance.personal",type:"menu",path:"/performance/personal",icon:"User",sort:1,status:"active",children:[{id:"performance.personal.view",name:"查看个人业绩",code:"performance.personal.view",type:"action",sort:1,status:"active"},{id:"performance.personal.export",name:"导出个人数据",code:"performance.personal.export",type:"action",sort:2,status:"active"}]},{id:"performance.team",name:"团队业绩",code:"performance.team",type:"menu",path:"/performance/team",icon:"UserFilled",sort:2,status:"active",children:[{id:"performance.team.view",name:"查看团队业绩",code:"performance.team.view",type:"action",sort:1,status:"active"},{id:"performance.team.export",name:"导出团队数据",code:"performance.team.export",type:"action",sort:2,status:"active"}]},{id:"performance.analysis",name:"业绩分析",code:"performance.analysis",type:"menu",path:"/performance/analysis",icon:"DataAnalysis",sort:3,status:"active",children:[{id:"performance.analysis.view",name:"查看分析",code:"performance.analysis.view",type:"action",sort:1,status:"active"},{id:"performance.analysis.export",name:"导出分析",code:"performance.analysis.export",type:"action",sort:2,status:"active"}]},{id:"performance.share",name:"业绩分享",code:"performance.share",type:"menu",path:"/performance/share",icon:"Share",sort:4,status:"active",children:[{id:"performance.share.view",name:"查看分享",code:"performance.share.view",type:"action",sort:1,status:"active"},{id:"performance.share.create",name:"创建分享",code:"performance.share.create",type:"action",sort:2,status:"active"},{id:"performance.share.manage",name:"管理分享",code:"performance.share.manage",type:"action",sort:3,status:"active"}]}]},{id:"logistics",name:"物流管理",code:"logistics",type:"module",path:"/logistics",icon:"Van",sort:6,status:"active",children:[{id:"logistics.shipping",name:"发货列表",code:"logistics.shipping",type:"menu",path:"/logistics/shipping",icon:"Box",sort:1,status:"active",children:[{id:"logistics.shipping.view",name:"查看发货",code:"logistics.shipping.view",type:"action",sort:1,status:"active"},{id:"logistics.shipping.create",name:"创建发货",code:"logistics.shipping.create",type:"action",sort:2,status:"active"},{id:"logistics.shipping.edit",name:"编辑发货",code:"logistics.shipping.edit",type:"action",sort:3,status:"active"},{id:"logistics.shipping.export",name:"导出发货",code:"logistics.shipping.export",type:"action",sort:4,status:"active"}]},{id:"logistics.list",name:"物流列表",code:"logistics.list",type:"menu",path:"/logistics/list",icon:"List",sort:2,status:"active",children:[{id:"logistics.list.view",name:"查看物流",code:"logistics.list.view",type:"action",sort:1,status:"active"},{id:"logistics.list.export",name:"导出物流",code:"logistics.list.export",type:"action",sort:2,status:"active"}]},{id:"logistics.track",name:"物流跟踪",code:"logistics.track",type:"menu",path:"/logistics/track",icon:"Position",sort:3,status:"active",children:[{id:"logistics.track.view",name:"查看跟踪",code:"logistics.track.view",type:"action",sort:1,status:"active"},{id:"logistics.track.update",name:"更新跟踪",code:"logistics.track.update",type:"action",sort:2,status:"active"}]},{id:"logistics.status",name:"状态更新",code:"logistics.status",type:"menu",path:"/logistics/status-update",icon:"Refresh",sort:4,status:"active",children:[{id:"logistics.status.view",name:"查看状态",code:"logistics.status.view",type:"action",sort:1,status:"active"},{id:"logistics.status.update",name:"更新状态",code:"logistics.status.update",type:"action",sort:2,status:"active"},{id:"logistics.status.batch",name:"批量更新",code:"logistics.status.batch",type:"action",sort:3,status:"active"}]},{id:"logistics.companies",name:"物流公司",code:"logistics.companies",type:"menu",path:"/logistics/companies",icon:"OfficeBuilding",sort:5,status:"active",children:[{id:"logistics.companies.view",name:"查看公司",code:"logistics.companies.view",type:"action",sort:1,status:"active"},{id:"logistics.companies.create",name:"新增公司",code:"logistics.companies.create",type:"action",sort:2,status:"active"},{id:"logistics.companies.edit",name:"编辑公司",code:"logistics.companies.edit",type:"action",sort:3,status:"active"}]}]},{id:"aftersale",name:"售后管理",code:"aftersale",type:"module",path:"/service",icon:"Tools",sort:7,status:"active",children:[{id:"aftersale.list",name:"售后订单",code:"aftersale.list",type:"menu",path:"/service/list",icon:"List",sort:1,status:"active",children:[{id:"aftersale.list.view",name:"查看售后",code:"aftersale.list.view",type:"action",sort:1,status:"active"},{id:"aftersale.list.export",name:"导出售后",code:"aftersale.list.export",type:"action",sort:2,status:"active"},{id:"aftersale.list.edit",name:"编辑售后",code:"aftersale.list.edit",type:"action",sort:3,status:"active"},{id:"aftersale.list.delete",name:"删除售后",code:"aftersale.list.delete",type:"action",sort:4,status:"active"}]},{id:"aftersale.add",name:"新建售后",code:"aftersale.add",type:"menu",path:"/service/add",icon:"Plus",sort:2,status:"active",children:[{id:"aftersale.add.create",name:"创建售后",code:"aftersale.add.create",type:"action",sort:1,status:"active"}]},{id:"aftersale.data",name:"售后数据",code:"aftersale.data",type:"menu",path:"/service/data",icon:"DataAnalysis",sort:3,status:"active",children:[{id:"aftersale.data.view",name:"查看数据",code:"aftersale.data.view",type:"action",sort:1,status:"active"},{id:"aftersale.data.export",name:"导出数据",code:"aftersale.data.export",type:"action",sort:2,status:"active"}]}]},{id:"data",name:"资料管理",code:"data",type:"module",path:"/data",icon:"Files",sort:8,status:"active",children:[{id:"data.list",name:"资料列表",code:"data.list",type:"menu",path:"/data/list",icon:"List",sort:1,status:"active",children:[{id:"data.list.view",name:"查看列表",code:"data.list.view",type:"action",sort:1,status:"active"},{id:"data.list.export",name:"导出资料",code:"data.list.export",type:"action",sort:2,status:"active"},{id:"data.list.import",name:"导入资料",code:"data.list.import",type:"action",sort:3,status:"active"},{id:"data.list.assign",name:"分配资料",code:"data.list.assign",type:"action",sort:4,status:"active"}]},{id:"data.search",name:"客户查询",code:"data.search",type:"menu",path:"/data/search",icon:"Search",sort:2,status:"active",children:[{id:"data.search.basic",name:"基础查询",code:"data.search.basic",type:"action",sort:1,status:"active"},{id:"data.search.advanced",name:"高级查询",code:"data.search.advanced",type:"action",sort:2,status:"active"},{id:"data.search.export",name:"导出结果",code:"data.search.export",type:"action",sort:3,status:"active"}]},{id:"data.recycle",name:"回收站",code:"data.recycle",type:"menu",path:"/data/recycle",icon:"Delete",sort:3,status:"active",children:[{id:"data.recycle.view",name:"查看回收站",code:"data.recycle.view",type:"action",sort:1,status:"active"},{id:"data.recycle.restore",name:"恢复数据",code:"data.recycle.restore",type:"action",sort:2,status:"active"},{id:"data.recycle.delete",name:"彻底删除",code:"data.recycle.delete",type:"action",sort:3,status:"active"}]}]},{id:"product",name:"商品管理",code:"product",type:"module",path:"/product",icon:"Box",sort:9,status:"active",children:[{id:"product.list",name:"商品列表",code:"product.list",type:"menu",path:"/product/list",icon:"List",sort:1,status:"active",children:[{id:"product.list.view",name:"查看商品",code:"product.list.view",type:"action",sort:1,status:"active"},{id:"product.list.export",name:"导出商品",code:"product.list.export",type:"action",sort:2,status:"active"},{id:"product.list.import",name:"导入商品",code:"product.list.import",type:"action",sort:3,status:"active"},{id:"product.list.edit",name:"编辑商品",code:"product.list.edit",type:"action",sort:4,status:"active"},{id:"product.list.delete",name:"删除商品",code:"product.list.delete",type:"action",sort:5,status:"active"}]},{id:"product.add",name:"新增商品",code:"product.add",type:"menu",path:"/product/add",icon:"Plus",sort:2,status:"active",children:[{id:"product.add.create",name:"创建商品",code:"product.add.create",type:"action",sort:1,status:"active"}]},{id:"product.inventory",name:"库存管理",code:"product.inventory",type:"menu",path:"/product/inventory",icon:"Box",sort:3,status:"active",children:[{id:"product.inventory.view",name:"查看库存",code:"product.inventory.view",type:"action",sort:1,status:"active"},{id:"product.inventory.adjust",name:"库存调整",code:"product.inventory.adjust",type:"action",sort:2,status:"active"},{id:"product.inventory.export",name:"导出库存",code:"product.inventory.export",type:"action",sort:3,status:"active"},{id:"product.inventory.import",name:"导入库存",code:"product.inventory.import",type:"action",sort:4,status:"active"}]},{id:"product.category",name:"商品分类",code:"product.category",type:"menu",path:"/product/category",icon:"Collection",sort:4,status:"active",children:[{id:"product.category.view",name:"查看分类",code:"product.category.view",type:"action",sort:1,status:"active"},{id:"product.category.create",name:"新增分类",code:"product.category.create",type:"action",sort:2,status:"active"},{id:"product.category.edit",name:"编辑分类",code:"product.category.edit",type:"action",sort:3,status:"active"},{id:"product.category.delete",name:"删除分类",code:"product.category.delete",type:"action",sort:4,status:"active"}]},{id:"product.analytics",name:"商品分析",code:"product.analytics",type:"menu",path:"/product/analytics",icon:"DataAnalysis",sort:5,status:"active",children:[{id:"product.analytics.view",name:"查看分析",code:"product.analytics.view",type:"action",sort:1,status:"active"},{id:"product.analytics.export",name:"导出分析",code:"product.analytics.export",type:"action",sort:2,status:"active"}]}]},{id:"system",name:"系统管理",code:"system",type:"module",path:"/system",icon:"Setting",sort:10,status:"active",children:[{id:"system.departments",name:"部门管理",code:"system.departments",type:"menu",path:"/system/departments",icon:"OfficeBuilding",sort:1,status:"active",children:[{id:"system.departments.view",name:"查看部门",code:"system.departments.view",type:"action",sort:1,status:"active"},{id:"system.departments.create",name:"创建部门",code:"system.departments.create",type:"action",sort:2,status:"active"},{id:"system.departments.edit",name:"编辑部门",code:"system.departments.edit",type:"action",sort:3,status:"active"},{id:"system.departments.delete",name:"删除部门",code:"system.departments.delete",type:"action",sort:4,status:"active"},{id:"system.departments.members",name:"管理成员",code:"system.departments.members",type:"action",sort:5,status:"active"}]},{id:"system.users",name:"用户管理",code:"system.users",type:"menu",path:"/system/users",icon:"User",sort:2,status:"active",children:[{id:"system.users.view",name:"查看用户",code:"system.users.view",type:"action",sort:1,status:"active"},{id:"system.users.create",name:"创建用户",code:"system.users.create",type:"action",sort:2,status:"active"},{id:"system.users.edit",name:"编辑用户",code:"system.users.edit",type:"action",sort:3,status:"active"},{id:"system.users.delete",name:"删除用户",code:"system.users.delete",type:"action",sort:4,status:"active"},{id:"system.users.reset_password",name:"重置密码",code:"system.users.reset_password",type:"action",sort:5,status:"active"},{id:"system.users.export",name:"导出用户",code:"system.users.export",type:"action",sort:6,status:"active"},{id:"system.users.import",name:"导入用户",code:"system.users.import",type:"action",sort:7,status:"active"}]},{id:"system.roles",name:"角色权限",code:"system.roles",type:"menu",path:"/system/roles",icon:"Key",sort:3,status:"active",children:[{id:"system.roles.view",name:"查看角色",code:"system.roles.view",type:"action",sort:1,status:"active"},{id:"system.roles.create",name:"创建角色",code:"system.roles.create",type:"action",sort:2,status:"active"},{id:"system.roles.edit",name:"编辑角色",code:"system.roles.edit",type:"action",sort:3,status:"active"},{id:"system.roles.delete",name:"删除角色",code:"system.roles.delete",type:"action",sort:4,status:"active"},{id:"system.roles.assign_permissions",name:"分配权限",code:"system.roles.assign_permissions",type:"action",sort:5,status:"active"}]},{id:"system.permissions",name:"权限管理",code:"system.permissions",type:"menu",path:"/system/permissions",icon:"Lock",sort:4,status:"active",children:[{id:"system.permissions.view",name:"查看权限",code:"system.permissions.view",type:"action",sort:1,status:"active"},{id:"system.permissions.edit",name:"编辑权限",code:"system.permissions.edit",type:"action",sort:2,status:"active"}]},{id:"system.super_admin_panel",name:"超管面板",code:"system.super_admin_panel",type:"menu",path:"/system/super-admin-panel",icon:"Monitor",sort:5,status:"active",children:[{id:"system.super_admin_panel.view",name:"查看面板",code:"system.super_admin_panel.view",type:"action",sort:1,status:"active"},{id:"system.super_admin_panel.manage",name:"管理系统",code:"system.super_admin_panel.manage",type:"action",sort:2,status:"active"}]},{id:"system.customer_service_permissions",name:"客服管理",code:"system.customer_service_permissions",type:"menu",path:"/system/customer-service-permissions",icon:"Service",sort:6,status:"active",children:[{id:"system.customer_service_permissions.view",name:"查看客服",code:"system.customer_service_permissions.view",type:"action",sort:1,status:"active"},{id:"system.customer_service_permissions.manage",name:"管理客服",code:"system.customer_service_permissions.manage",type:"action",sort:2,status:"active"}]},{id:"system.message_management",name:"消息管理",code:"system.message_management",type:"menu",path:"/system/message-management",icon:"Bell",sort:7,status:"active",children:[{id:"system.message_management.view",name:"查看消息",code:"system.message_management.view",type:"action",sort:1,status:"active"},{id:"system.message_management.send",name:"发送消息",code:"system.message_management.send",type:"action",sort:2,status:"active"},{id:"system.message_management.manage",name:"管理消息",code:"system.message_management.manage",type:"action",sort:3,status:"active"}]},{id:"system.settings",name:"系统设置",code:"system.settings",type:"menu",path:"/system/settings",icon:"Tools",sort:8,status:"active",children:[{id:"system.settings.view",name:"查看设置",code:"system.settings.view",type:"action",sort:1,status:"active"},{id:"system.settings.edit",name:"修改设置",code:"system.settings.edit",type:"action",sort:2,status:"active"}]}]}],ds={SUPER_ADMIN:[],ADMIN:["system.user.view","system.user.create","system.user.edit","system.user.permissions","system.user.reset_password","system.role.view","system.role.create","system.role.edit","system.role.assign_permissions","system.department.view","system.department.create","system.department.edit","system.department.members","system.permission.view","system.permission.assign","system.settings.view","system.settings.edit","system.settings.sms","system.settings.call","customer.list.view","customer.list.export","customer.add.create","customer.edit","customer.follow","order.list.view","order.create","order.edit","order.status","product.list","product.add","product.edit","product.category","product.inventory","product.analytics","service.ticket.view","service.ticket.create","service.ticket.edit","service.ticket.delete","service.ticket.assign","service.ticket.close","service.ticket.export","service.chat.view","service.chat.reply","service.chat.transfer","service.chat.history","service.chat.settings","service.knowledge.view","service.knowledge.create","service.knowledge.edit","service.knowledge.delete","service.knowledge.category","service.knowledge.publish","service.call.view","service.call.make","service.call.record","service.call.statistics","service.sms.view","service.sms.send","service.sms.template","service.sms.batch","service.sms.statistics","data.list.view","data.list.export","data.list.import","data.list.assign","data.search.basic","data.search.advanced","data.search.export","performance.personal.view","performance.team.view","performance.analysis.view"],MANAGER:["system.user.view","system.department.view","customer.list.view","customer.list.export","customer.add.create","customer.edit","customer.follow","order.list.view","order.create","order.edit","order.status","product.list","product.add","product.edit","product.category","product.analytics","service.ticket.view","service.ticket.create","service.ticket.edit","service.ticket.assign","service.ticket.close","service.ticket.export","service.chat.view","service.chat.reply","service.chat.transfer","service.chat.history","service.chat.settings","service.knowledge.view","service.knowledge.create","service.knowledge.edit","service.knowledge.category","service.knowledge.publish","service.call.view","service.call.make","service.call.record","service.call.statistics","service.sms.view","service.sms.send","service.sms.template","service.sms.batch","service.sms.statistics","data.list.view","data.search.basic","data.search.advanced","performance.personal.view","performance.team.view","performance.analysis.view"],EMPLOYEE:["customer.list.view","customer.follow","order.list.view","order.create","product.list","service.ticket.view","service.ticket.create","service.ticket.edit","service.chat.view","service.chat.reply","service.chat.history","service.knowledge.view","service.call.view","service.call.make","service.sms.view","service.sms.send","data.list.view","data.search.basic","performance.personal.view"],CUSTOMER_SERVICE:["customer.list.view","customer.follow","order.list.view","service.ticket.view","service.ticket.create","service.ticket.edit","service.ticket.assign","service.ticket.close","service.chat.view","service.chat.reply","service.chat.transfer","service.chat.history","service.chat.settings","service.knowledge.view","service.knowledge.create","service.knowledge.edit","service.knowledge.category","service.call.view","service.call.make","service.call.record","service.sms.view","service.sms.send","service.sms.template","data.list.view","data.search.basic"]};const us=new class{constructor(){this.permissionUpdateListeners=[]}addPermissionUpdateListener(e){this.permissionUpdateListeners.push(e)}removePermissionUpdateListener(e){const t=this.permissionUpdateListeners.indexOf(e);t>-1&&this.permissionUpdateListeners.splice(t,1)}notifyPermissionUpdate(e){console.log(`通知权限更新: 角色${e}`),this.permissionUpdateListeners.forEach(t=>{try{t(e)}catch(s){console.error("权限更新监听器执行失败:",s)}})}getAllPermissions(){return JSON.parse(JSON.stringify(ls))}getFlatPermissions(){const e=[],t=(s,a=null)=>{s.forEach(s=>{e.push({...s,parentId:a?.id||null,module:a?.name||s.name}),s.children&&s.children.length>0&&t(s.children,s)})};return t(ls),e}getRoleDefaultPermissions(e){return"SUPER_ADMIN"===e?this.getFlatPermissions().filter(e=>"action"===e.type).map(e=>e.id):ds[e]||[]}async getRolePermissions(e){try{const t=localStorage.getItem("role_permissions");if(t){const s=JSON.parse(t);if(s[e])return console.log(`从localStorage读取角色${e}的权限配置`),s[e]}}catch(r){console.warn("从localStorage读取角色权限失败:",r)}console.log(`使用角色${e}的默认权限配置`),await new Promise(e=>setTimeout(e,300));const t={1:{code:"SUPER_ADMIN",name:"超级管理员"},2:{code:"ADMIN",name:"管理员"},3:{code:"MANAGER",name:"经理"},4:{code:"EMPLOYEE",name:"员工"},5:{code:"CUSTOMER_SERVICE",name:"客服"}}[e]||{code:"EMPLOYEE",name:"员工"},s=this.getRoleDefaultPermissions(t.code),a=this.getFlatPermissions().filter(e=>s.includes(e.id));return{roleId:e,roleName:t.name,roleCode:t.code,permissions:a}}async getUserPersonalPermissions(e){await new Promise(e=>setTimeout(e,200));const t={1:["customer.list.import","order.list.export"],2:["customer.list.import"],3:["order.list.export"],4:[],5:["customer.list.export"]}[e]||[];return{userId:e,permissions:this.getFlatPermissions().filter(e=>t.includes(e.id))}}async saveUserPersonalPermissions(e,t){return await new Promise(e=>setTimeout(e,500)),console.log(`保存用户 ${e} 的个人权限:`,t),{success:!0,message:"个人权限保存成功"}}async getUserDepartmentPermissions(e){try{const t=await ge(()=>Promise.resolve().then(()=>fs),void 0),s=await ge(()=>import("./departmentPermissionService-DXn8dAdX.js"),__vite__mapDeps([146,1,2,3])),a=t.default.getUserById(e);if(!a||!a.departmentId)return{departmentId:null,departmentName:null,permissions:[],inheritedPermissions:[],managerExtraPermissions:[],isManager:!1};const r=await s.default.getDepartmentPermissions(a.departmentId),o=(await ge(()=>import("./department-CMDKNhTn.js"),__vite__mapDeps([52,1,2,3]))).default.getDepartmentById(a.departmentId),n=o?.managerId===e;let i=[...r.permissions||[]],c=[];if(r.inheritFromParent&&o?.parentId){c=(await s.default.getDepartmentPermissions(o.parentId)).permissions||[],i=[...i,...c]}let l=[];return n&&(l=r.managerExtraPermissions||["data.department.view_all","performance.department.view_all","customer.department.view_all"],i=[...i,...l]),i=[...new Set(i)],{departmentId:a.departmentId,departmentName:o?.name||"",permissions:i,inheritedPermissions:c,managerExtraPermissions:l,isManager:n,dataScope:r.dataScope||"department"}}catch(t){return console.error("获取用户部门权限失败:",t),{departmentId:null,departmentName:null,permissions:[],inheritedPermissions:[],managerExtraPermissions:[],isManager:!1}}}async getUserFullPermissions(e,t){const[s,a,r]=await Promise.all([this.getRolePermissions(t),this.getUserPersonalPermissions(e),this.getUserDepartmentPermissions(e)]),o=s.permissions.map(e=>e.id),n=a.permissions.map(e=>e.id),i=r.permissions||[],c=this.getFlatPermissions(),l=c.filter(e=>i.includes(e.code)||i.includes(e.id)),d=l.map(e=>e.id),u=[...new Set([...o,...n,...d])],m=c.filter(e=>u.includes(e.id));return{userId:e,roleId:t,roleName:s.roleName,rolePermissions:s.permissions,personalPermissions:a.permissions,departmentPermissions:{departmentId:r.departmentId,departmentName:r.departmentName,permissions:l,inheritedPermissions:r.inheritedPermissions,managerExtraPermissions:r.managerExtraPermissions,isManager:r.isManager,dataScope:r.dataScope},allPermissions:m}}async hasPermission(e,t,s,a={}){const r=await this.getUserFullPermissions(e,t);if(r.allPermissions.some(e=>e.code===s))return!0;if(r.departmentPermissions.isManager){if(["customer.list.view","order.list.view","data.list.view","performance.personal.view","performance.team.view","user.department.view"].includes(s))return!0;if(a.targetDepartmentId&&a.targetDepartmentId===r.departmentPermissions.departmentId){if(["data.department.view_all","performance.department.view_all","customer.department.view_all"].some(e=>s.includes(e.split(".")[0])))return!0}}return!1}async canAccessDepartmentData(e,t,s){const a=await this.getUserFullPermissions(e,t);return!!a.allPermissions.some(e=>"system"===e.code)||(a.departmentPermissions.departmentId===s||!(!a.departmentPermissions.isManager||a.departmentPermissions.departmentId!==s))}async getUserDataScope(e,t){const s=await this.getUserFullPermissions(e,t);return s.allPermissions.some(e=>"system"===e.code)?{scope:"all",departmentIds:[],userIds:[]}:s.departmentPermissions.isManager?{scope:"department",departmentIds:[s.departmentPermissions.departmentId],userIds:[]}:{scope:"self",departmentIds:[],userIds:[e]}}},ms=Object.freeze(Object.defineProperty({__proto__:null,default:us},Symbol.toStringTag,{value:"Module"}));class ps{static instance;api;constructor(){this.api=Ie}static getInstance(){return ps.instance||(ps.instance=new ps),ps.instance}getRoleNameById(e){return{1:"超级管理员",2:"管理员",3:"经理",4:"员工",5:"客服"}[e]||"未知角色"}async getRolePermissions(e){try{const s="crm_role_permissions",a=JSON.parse(localStorage.getItem(s)||"{}");if(a[e]){console.log(`[RolePermissionAPI] 从本地存储获取角色权限: ${e}`);const t=await this.getAllPermissions(),s=a[e].permissionIds,r=t.filter(e=>s.includes(e.id));return{roleId:e,roleName:this.getRoleNameById(e),permissions:r}}try{const t=await this.api.get(`/roles/${e}/permissions`);return console.log(`[RolePermissionAPI] 从API获取角色权限成功: ${e}`),t}catch(t){return console.warn(`[RolePermissionAPI] API获取失败，使用默认权限: ${e}`,t),{roleId:e,roleName:this.getRoleNameById(e),permissions:[]}}}catch(s){throw console.error(`[RolePermissionAPI] 获取角色权限失败 (Role: ${e}):`,s),s}}async saveRolePermissions(e,t){try{const a="crm_role_permissions",r=JSON.parse(localStorage.getItem(a)||"{}");r[e]={roleId:e,permissionIds:t,updatedAt:(new Date).toISOString()},localStorage.setItem(a,JSON.stringify(r));try{await this.api.put(`/roles/${e}/permissions`,{permissionIds:t})}catch(s){console.warn(`[RolePermissionAPI] 后端API调用失败，但本地存储已保存: ${e}`,s)}us.notifyPermissionUpdate(e),console.log(`[RolePermissionAPI] 保存角色权限成功: ${e}`,t)}catch(a){throw console.error(`[RolePermissionAPI] 保存角色权限失败 (Role: ${e}):`,a),a}}async getAllPermissions(){try{const e=await this.api.get("/permissions");return console.log("[RolePermissionAPI] 获取所有权限成功"),e}catch(e){throw console.error("[RolePermissionAPI] 获取所有权限失败:",e),e}}async getUserPersonalPermissions(e){try{const t=await this.api.get(`/users/${e}/personal-permissions`);return console.log(`[RolePermissionAPI] 获取用户个人权限成功: ${e}`),t}catch(t){throw console.error(`[RolePermissionAPI] 获取用户个人权限失败 (User: ${e}):`,t),t}}async saveUserPersonalPermissions(e,t){try{await this.api.put(`/users/${e}/personal-permissions`,{permissionIds:t}),console.log(`[RolePermissionAPI] 保存用户个人权限成功: ${e}`)}catch(s){throw console.error(`[RolePermissionAPI] 保存用户个人权限失败 (User: ${e}):`,s),s}}async getUserOperationLogs(e,t={}){try{const s=await this.api.paginate(`/users/${e}/operation-logs`,t);return console.log(`[RolePermissionAPI] 获取用户操作日志成功: ${e}`),s}catch(s){throw console.error(`[RolePermissionAPI] 获取用户操作日志失败 (User: ${e}):`,s),s}}async getOperationLogs(e={}){try{const t=await this.api.paginate("/operation-logs",e);return console.log("[RolePermissionAPI] 获取所有操作日志成功"),t}catch(t){throw console.error("[RolePermissionAPI] 获取所有操作日志失败:",t),t}}async exportUserOperationLogs(e,t={}){try{const s=await this.api.download(`/users/${e}/operation-logs/export`,t);return console.log(`[RolePermissionAPI] 导出用户操作日志成功: ${e}`),s}catch(s){throw console.error(`[RolePermissionAPI] 导出用户操作日志失败 (User: ${e}):`,s),s}}}const gs=ps.getInstance(),hs={super_admin:{roleId:"super_admin",roleName:"超级管理员",permissions:["*"],description:"拥有系统所有权限，可以管理所有功能和数据"},admin:{roleId:"admin",roleName:"管理员",permissions:["*"],description:"拥有系统所有权限，可以管理所有功能和数据"},department_manager:{roleId:"department_manager",roleName:"部门经理",permissions:["dashboard","dashboard:personal","dashboard:department","customer","customer:list","customer:view:personal","customer:view:department","customer:add","customer:edit","customer:import","customer:export","order","order:list","order:view:personal","order:view:department","order:add","order:edit","service","service:call","service:call:view","service:call:add","service:call:edit","performance","performance:personal","performance:personal:view","performance:team","performance:team:view","performance:analysis","performance:share","logistics","logistics:list","logistics:view","logistics:add","logistics:edit","logistics:tracking","logistics:tracking:view","aftersale","aftersale:order","aftersale:view:personal","aftersale:view:department","aftersale:add","aftersale:edit","aftersale:analysis","data","data:customer","data:customer:search"],description:"管理本部门业务和团队，查看部门数据"},sales_staff:{roleId:"sales_staff",roleName:"销售员",permissions:["dashboard","dashboard:personal","customer","customer:list","customer:view:personal","customer:add","order","order:list","order:view:personal","order:add","order:edit","service","service:call","service:call:view","service:call:add","service:call:edit","performance","performance:personal","performance:personal:view","performance:team","performance:team:view","logistics","logistics:list","logistics:view","logistics:tracking","logistics:tracking:view","aftersale","aftersale:order","aftersale:view:personal","aftersale:add","data","data:customer","data:customer:search"],description:"专注于客户开发和订单管理，查看个人数据"},customer_service:{roleId:"customer_service",roleName:"客服",permissions:["dashboard","dashboard:personal","order","order:audit","order:audit:view","logistics","logistics:list","logistics:list:view","logistics:shipping","logistics:shipping:view","logistics:tracking","logistics:tracking:view","logistics:status","logistics:status_update","aftersale","aftersale:order","aftersale:order:view","aftersale:add","aftersale:analysis","data","data:customer","data:customer:search","data:list"],description:"处理订单、物流和售后服务，查看全公司数据"}};function vs(e){const t=hs[e];return t?t.permissions:[]}const ys=e("user",()=>{const e=s(null),t=s(""),r=s([]),o=s(!1),n=s([]),i=s({enabled:!0,whitelist:[]}),c=t=>{if(console.log(`收到权限更新通知，角色ID: ${t}`),e.value){l(e.value.role)===t&&(console.log("当前用户角色权限已更新，重新加载权限"),d())}},l=e=>({admin:"2",manager:"3",employee:"4",customer_service:"5"}[e]||"4"),d=async()=>{if(e.value)try{const t=l(e.value.role),s=await gs.getRolePermissions(t);if(s&&s.permissions){const e=s.permissions.map(e=>e.code);r.value=e,rs(e),console.log("用户权限已刷新:",e)}}catch(t){console.error("刷新用户权限失败:",t)}};ge(()=>Promise.resolve().then(()=>ms),void 0).then(e=>{e.default.addPermissionUpdateListener(c),console.log("权限更新监听器已初始化")}).catch(e=>{console.error("初始化权限监听器失败:",e)});const u=a(()=>"super_admin"===e.value?.role||"admin"===e.value?.role),m=a(()=>"department_manager"===e.value?.role),p=a(()=>"sales_staff"===e.value?.role),g=a(()=>"customer_service"===e.value?.role),h=a(()=>m.value||u.value),v=a(()=>p.value),y=a(()=>u.value||m.value),f=a(()=>e.value),_=a(()=>!!e.value&&("super_admin"===e.value.role||"admin"===e.value.role||e.value.userRole===he.SUPER_ADMIN)),S=a(()=>!!e.value&&(e.value.userRole===he.WHITELIST_MEMBER||m.value||_.value)),w=a(()=>{if(!e.value)return ve.RESTRICTED;const t=we.getUserPermission(e.value.id);return t?.permissions[0]||ve.RESTRICTED}),A=a(()=>{if(!e.value)return!1;return we.checkSensitiveInfoAccess(e.value.id,ye.PHONE).hasAccess}),I=a(()=>t=>{if(!e.value)return!1;return we.checkSensitiveInfoAccess(e.value.id,t).hasAccess}),P=a(()=>(t,s)=>{if(!e.value)return!1;return we.checkDataAccess(e.value.id,t,s).hasAccess}),E=a(()=>{if(!e.value)return _e.SELF;const t=we.getUserPermission(e.value.id);return t?.dataScope||_e.SELF}),T=a(()=>e.value?we.getAccessibleDepartments(e.value.id):[]),C=a(()=>!!e.value&&(!!u.value||(r.value.includes("service:process")||r.value.includes("service:write")||m.value))),D=a(()=>!!e.value&&(!!u.value||(r.value.includes("service:edit")||r.value.includes("service:write")||m.value))),k=a(()=>!!e.value&&(!!u.value||(r.value.includes("service:close")||r.value.includes("service:write")||m.value))),b=a(()=>!!e.value&&(!!_.value||(!!S.value||(!!r.value.includes("logistics:status")||(!!m.value||"logistics"===e.value.department&&"supervisor"===e.value.position))))),R=async(s,a,n=!1)=>{try{const c=await nt.login({username:s,password:a,rememberMe:n});console.log("[Auth] ========== 开始提取Token =========="),console.log("[Auth] response完整对象:",JSON.stringify(c,null,2)),console.log("[Auth] response类型:",typeof c),console.log("[Auth] response的keys:",Object.keys(c||{})),console.log("[Auth] response.tokens:",c.tokens),console.log("[Auth] response.tokens的keys:",c.tokens?Object.keys(c.tokens):"undefined"),console.log("[Auth] response.user:",c.user);const l=c.tokens?.accessToken||c.tokens?.access_token;if(console.log("[Auth] 提取的accessToken:",l),console.log("[Auth] ========================================="),!l)throw console.error("[Auth] ❌ 登录响应中未找到Token!"),console.error("[Auth] 完整响应对象:",JSON.stringify(c,null,2)),new Error("登录响应格式错误：未找到Token");t.value=l,o.value=!0,localStorage.setItem("auth_token",l),console.log("[Auth] ✅ Token已设置:",l.substring(0,30)+"..."),console.log("[Auth] ✅ localStorage已保存:",localStorage.getItem("auth_token")?.substring(0,30)+"...");const d=c.user;e.value={id:d.id.toString(),name:d.realName||d.name,email:d.email,role:"admin"===d.role||"super_admin"===d.role?"super_admin":"department_manager"===d.role?"department_manager":"sales_staff"===d.role?"sales_staff":"customer_service"===d.role?"customer_service":d.role||"sales_staff",department:d.department?.name||d.departmentName||"未分配",avatar:d.avatar,userRole:"admin"===d.role||"super_admin"===d.role?he.SUPER_ADMIN:"department_manager"===d.role?he.DEPARTMENT_MANAGER:"sales_staff"===d.role?he.SALES_STAFF:"customer_service"===d.role?he.CUSTOMER_SERVICE:he.REGULAR_USER,permissionLevel:"admin"===d.role||"super_admin"===d.role?ve.FULL_ACCESS:"department_manager"===d.role?ve.PARTIAL_ACCESS:ve.RESTRICTED,dataScope:d.dataScope||("admin"===d.role||"super_admin"===d.role?_e.ALL:"department_manager"===d.role?_e.DEPARTMENT:_e.SELF),departmentId:d.departmentId,departmentIds:d.departmentIds,customerServiceType:d.customerServiceType,forcePasswordChange:!1};let u=[];const m=d.roleId||d.role;try{const e=JSON.parse(localStorage.getItem("crm_roles")||"[]").find(e=>e.code===m||e.code===d.role);e&&e.permissions&&e.permissions.length>0&&(u=e.permissions,console.log(`[Auth] ✅ 从动态配置加载权限: ${m}`,u.length,"个权限"))}catch(i){console.warn("[Auth] 读取动态权限配置失败:",i)}if(0===u.length&&(u=vs(m),console.log(`[Auth] ✅ 使用默认权限配置: ${m}`,u.length,"个权限")),0===u.length){const e={"销售员":"sales_staff","销售":"sales_staff","客服":"customer_service","客服人员":"customer_service","部门经理":"department_manager","经理":"department_manager","管理员":"admin","系统管理员":"admin","超级管理员":"super_admin",sales:"sales_staff",service:"customer_service",manager:"department_manager"}[m]||m;u=vs(e),console.log(`[Auth] 使用映射后的角色获取权限: ${e}`,u)}"admin"===d.role||"super_admin"===d.role?we.setUserPermission({userId:d.id.toString(),role:he.SUPER_ADMIN,permissions:[ve.FULL_ACCESS],dataScope:_e.ALL}):"department_manager"===d.role?we.setUserPermission({userId:d.id.toString(),role:he.DEPARTMENT_MANAGER,permissions:[ve.PARTIAL_ACCESS],dataScope:_e.DEPARTMENT,departmentId:d.departmentId||"dept_001",departmentIds:d.departmentIds||["dept_001"],whitelistTypes:[ye.PHONE,ye.EMAIL,ye.WECHAT]}):"sales_staff"===d.role?we.setUserPermission({userId:d.id.toString(),role:he.SALES_STAFF,permissions:[ve.RESTRICTED],dataScope:_e.SELF,departmentId:d.departmentId||"dept_001"}):"customer_service"===d.role?we.setUserPermission({userId:d.id.toString(),role:he.CUSTOMER_SERVICE,permissions:[ve.PARTIAL_ACCESS],dataScope:_e.ALL,customerServiceType:d.customerServiceType||Se.GENERAL,whitelistTypes:[ye.PHONE]}):we.setUserPermission({userId:d.id.toString(),role:he.REGULAR_USER,permissions:[ve.RESTRICTED],dataScope:_e.SELF}),r.value=u,rs(u);const p={...e.value,permissions:u};localStorage.setItem("auth_token",t.value),localStorage.setItem("user",JSON.stringify(p)),localStorage.setItem("user_info",JSON.stringify(p)),localStorage.setItem("userPermissions",JSON.stringify(u));const g=Date.now()+6048e5;return localStorage.setItem("token_expiry",g.toString()),console.log("[Auth] 已保存用户信息和权限:"),console.log("  - 用户:",p.name),console.log("  - 角色:",p.role),console.log("  - 权限数量:",u.length),o.value=!0,console.log("[Auth] ✅ 登录状态已设置"),setTimeout(async()=>{try{console.log("[Auth] 🔄 开始无痕刷新数据...");const{preloadAppData:e}=await ge(async()=>{const{preloadAppData:e}=await import("./appInitService-CgPClnry.js");return{preloadAppData:e}},__vite__mapDeps([5,6,7,1,2,3]));await e(),console.log("[Auth] ✅ 无痕刷新完成")}catch(i){console.warn("[Auth] ⚠️ 无痕刷新失败（不影响使用）:",i)}},300),!0}catch(c){throw console.error("API登录失败:",c),c}},O=()=>{console.trace("[Auth] ⚠️ logout 被调用！调用栈："),nt.logout().catch(console.error),e.value=null,t.value="",r.value=[],o.value=!1,n.value=[],localStorage.removeItem("auth_token"),localStorage.removeItem("user"),localStorage.removeItem("user_info"),localStorage.removeItem("userPermissions"),localStorage.removeItem("refresh_token"),localStorage.removeItem("token_expiry"),console.log("[Auth] 已清除所有认证数据")};return{currentUser:e,user:f,token:t,permissions:r,isLoggedIn:o,users:n,isAdmin:u,isManager:h,isEmployee:v,isDepartmentManager:m,isSalesStaff:p,isCustomerService:g,isDepartmentHead:y,isSuperAdmin:_,isWhitelistMember:S,userPermissionLevel:w,canViewPhone:A,canAccessSensitiveInfo:I,canAccessData:P,userDataScope:E,accessibleDepartments:T,canProcessAfterSales:C,canEditAfterSales:D,canCloseAfterSales:k,hasAfterSalesPermission:t=>!!e.value&&(!!u.value||r.value.includes(t)),canAccessLogisticsStatusUpdate:b,hasLogisticsPermission:t=>!!e.value&&(!!u.value||r.value.includes(t)),phoneViewSettings:i,login:async(s,a)=>new Promise((n,i)=>{setTimeout(()=>{const c=(()=>{const e=localStorage.getItem("userDatabase");if(e){const t=JSON.parse(e);if(!t.some(e=>"manager"===e.username&&"manager"===e.roleId||"sales001"===e.username&&"employee"===e.roleId||"service001"===e.username&&"employee"===e.roleId))return t;console.log("[Dev] 检测到旧的角色配置，清除缓存使用新配置"),localStorage.removeItem("userDatabase")}return[{id:"admin",username:"admin",realName:"系统管理员",email:"admin@example.com",phone:"13800138000",roleId:"admin",status:"active",isOnline:!1,avatar:"https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png",lastLoginTime:null,loginCount:0,createTime:"2024-01-01 00:00:00",remark:"系统管理员账户",password:"admin123",needChangePassword:!1},{id:"dept_manager",username:"dept_manager",realName:"部门管理员",email:"dept_manager@example.com",phone:"13800138001",roleId:"department_manager",status:"active",isOnline:!1,avatar:"https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png",lastLoginTime:null,loginCount:0,createTime:"2024-01-01 00:00:00",remark:"部门管理员账户",password:"dept123",needChangePassword:!1,departmentId:"dept_001",departmentIds:["dept_001"]},{id:"sales001",username:"sales001",realName:"销售员工",email:"sales001@example.com",phone:"13800138002",roleId:"sales_staff",status:"active",isOnline:!1,avatar:"https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png",lastLoginTime:null,loginCount:0,createTime:"2024-01-01 00:00:00",remark:"销售员工账户",password:"sales123",needChangePassword:!1,departmentId:"dept_001"},{id:"service001",username:"service001",realName:"客服员工",email:"service001@example.com",phone:"13800138003",roleId:"customer_service",status:"active",isOnline:!1,avatar:"https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png",lastLoginTime:null,loginCount:0,createTime:"2024-01-01 00:00:00",remark:"客服员工账户",password:"service123",needChangePassword:!1,customerServiceType:"general"}]})(),l=c.find(e=>e.username===s);if(!l)return void i(new Error("用户不存在"));if("active"!==l.status)return void i(new Error("用户已被禁用"));if(l.password!==a)return void i(new Error("密码错误"));t.value="token-"+l.id+"-"+Date.now(),o.value=!0,l.lastLoginTime=(new Date).toLocaleString(),l.loginCount=(l.loginCount||0)+1,l.isOnline=!0,localStorage.setItem("userDatabase",JSON.stringify(c)),e.value={id:l.id,name:l.realName,email:l.email,role:"admin"===l.roleId?"super_admin":"department_manager"===l.roleId?"department_manager":"sales_staff"===l.roleId?"sales_staff":"customer_service"===l.roleId?"customer_service":l.roleId||l.role||"sales_staff",department:l.department||"销售部",avatar:l.avatar,userRole:"admin"===l.roleId?he.SUPER_ADMIN:"department_manager"===l.roleId?he.DEPARTMENT_MANAGER:"sales_staff"===l.roleId?he.SALES_STAFF:"customer_service"===l.roleId?he.CUSTOMER_SERVICE:he.REGULAR_USER,permissionLevel:"admin"===l.roleId?ve.FULL_ACCESS:"department_manager"===l.roleId?ve.PARTIAL_ACCESS:ve.RESTRICTED,dataScope:l.dataScope||("admin"===l.roleId?_e.ALL:"department_manager"===l.roleId?_e.DEPARTMENT:_e.SELF),departmentId:l.departmentId,departmentIds:l.departmentIds,customerServiceType:l.customerServiceType,forcePasswordChange:l.needChangePassword};let d=[];d=vs(l.roleId),"admin"===l.roleId||"super_admin"===l.roleId?we.setUserPermission({userId:l.id,role:he.SUPER_ADMIN,permissions:[ve.FULL_ACCESS],dataScope:_e.ALL}):"department_manager"===l.roleId?we.setUserPermission({userId:l.id,role:he.DEPARTMENT_MANAGER,permissions:[ve.PARTIAL_ACCESS],dataScope:_e.DEPARTMENT,departmentId:l.departmentId||"dept_001",departmentIds:l.departmentIds||["dept_001"],whitelistTypes:[ye.PHONE,ye.EMAIL,ye.WECHAT]}):"sales_staff"===l.roleId?we.setUserPermission({userId:l.id,role:he.SALES_STAFF,permissions:[ve.RESTRICTED],dataScope:_e.SELF,departmentId:l.departmentId||"dept_001"}):"customer_service"===l.roleId?we.setUserPermission({userId:l.id,role:he.CUSTOMER_SERVICE,permissions:[ve.PARTIAL_ACCESS],dataScope:_e.ALL,customerServiceType:l.customerServiceType||Se.GENERAL,whitelistTypes:[ye.PHONE]}):we.setUserPermission({userId:l.id,role:he.REGULAR_USER,permissions:[ve.RESTRICTED],dataScope:_e.SELF}),r.value=d,rs(d),localStorage.setItem("auth_token",t.value),localStorage.setItem("user",JSON.stringify(e.value));es.getConfig().enabled&&es.start(),n(!0)},1e3)}),loginWithApi:R,loginWithRetry:async(e,s,a=!1,r=3)=>{let n;for(let c=1;c<=r;c++)try{console.log(`[Auth] 登录尝试 ${c}/${r}`);const n=await R(e,s,a);if(!0===n)return console.log("[Auth] ✅ 登录成功"),!0;if(t.value&&o.value)return console.log("[Auth] ✅ 登录成功（通过状态确认）"),!0;console.warn(`[Auth] 登录尝试 ${c}/${r} 返回值异常:`,n)}catch(i){n=i;const e=i instanceof Error?i.message:String(i);if(console.error(`[Auth] 登录尝试 ${c}/${r} 失败:`,e),(e.includes("频繁")||e.includes("429")||"RATE_LIMITED"===e)&&c<r){const e=Math.min(1e3*Math.pow(2,c-1),1e4);console.log(`[Auth] ${e}ms后重试...`),await new Promise(t=>setTimeout(t,e));continue}if(c===r)throw n}throw n||new Error("登录失败，请稍后重试")},logout:O,loadUsers:async()=>{console.log("[UserStore] 开始加载用户列表...");try{const{default:e}=await ge(async()=>{const{default:e}=await import("./userDataService-WmhE7J4W.js");return{default:e}},[]),t=await e.getUsers();t.length>0?(n.value=t.map(e=>({id:e.id,name:e.realName||e.name||e.username,username:e.username,realName:e.realName||e.name,employeeNumber:e.employeeNumber,email:e.email,role:e.role,department:e.departmentName||e.department||"未分配",departmentId:e.departmentId,departmentName:e.departmentName||e.department||"未分配",position:e.position||"员工",avatar:e.avatar,status:e.status||"active",createTime:e.createTime||e.createdAt,createdAt:e.createdAt,employmentStatus:e.employmentStatus||"active"})),console.log("[UserStore] ✅ 用户列表已加载:",n.value.length,"个用户"),console.log("[UserStore] 数据来源:",e.getCurrentMode()),console.log("[UserStore] 用户列表:",n.value.map(e=>({id:e.id,name:e.name,department:e.department})))):(console.warn("[UserStore] ⚠️ 未获取到用户数据，用户列表为空"),n.value=[])}catch(e){console.error("[UserStore] ❌ 加载用户列表失败:",e),n.value=[]}},getUserById:e=>n.value.find(t=>String(t.id)===String(e)),initUser:async()=>{const s=localStorage.getItem("auth_token"),a=localStorage.getItem("user");if(s&&a){console.log("[Auth] 🔧 开始恢复登录状态...");try{const i=JSON.parse(a);t.value=s,e.value=i,o.value=!0,console.log("[Auth] ✅ 登录状态已恢复:",i.name),console.log("[Auth] ✅ Token:",s.substring(0,30)+"..."),console.log("[Auth] ✅ isLoggedIn:",o.value);let c=[];try{const e=JSON.parse(localStorage.getItem("crm_roles")||"[]").find(e=>e.code===i.role);e&&e.permissions&&e.permissions.length>0&&(c=e.permissions,console.log("[Auth] ✅ 从动态配置恢复权限:",i.role,c.length,"个权限"))}catch(n){console.warn("[Auth] 读取动态权限配置失败:",n)}0===c.length&&(c=vs(i.role),console.log("[Auth] ✅ 使用默认角色权限:",i.role,c.length,"个权限")),c.length>0?(r.value=c,rs(c)):i.permissions&&Array.isArray(i.permissions)?(r.value=i.permissions,rs(i.permissions),console.log("[Auth] ⚠️ 使用保存的权限:",i.permissions.length,"个权限")):console.warn("[Auth] ⚠️ 无法获取权限配置，角色:",i.role),"admin"===i.role||"super_admin"===i.role?we.setUserPermission({userId:i.id,role:he.SUPER_ADMIN,permissions:[ve.FULL_ACCESS],dataScope:_e.ALL}):"department_manager"===i.role?we.setUserPermission({userId:i.id,role:he.DEPARTMENT_MANAGER,permissions:[ve.PARTIAL_ACCESS],dataScope:_e.DEPARTMENT,departmentId:i.departmentId||"dept_001",departmentIds:i.departmentIds||["dept_001"],whitelistTypes:[ye.PHONE,ye.EMAIL,ye.WECHAT]}):"sales_staff"===i.role?we.setUserPermission({userId:i.id,role:he.SALES_STAFF,permissions:[ve.RESTRICTED],dataScope:_e.SELF,departmentId:i.departmentId||"dept_001"}):"customer_service"===i.role&&we.setUserPermission({userId:i.id,role:he.CUSTOMER_SERVICE,permissions:[ve.PARTIAL_ACCESS],dataScope:_e.ALL,customerServiceType:i.customerServiceType||Se.GENERAL,whitelistTypes:[ye.PHONE]}),console.log("[Auth] ✅ 权限已恢复:",r.value.length,"个");return void(es.getConfig().enabled&&es.start())}catch(i){return console.error("[Auth] ❌ 恢复登录状态失败:",i),void O()}}else console.log("[Auth] 没有保存的登录信息，跳过初始化")},updateUser:t=>{e.value={...e.value,...t}},hasPermission:e=>!!r.value.includes("*")||(r.value.includes(e)||u.value),updatePhoneViewSettings:e=>{i.value={...i.value,...e},localStorage.setItem("phoneViewSettings",JSON.stringify(i.value))},addToPhoneWhitelist:e=>{i.value.whitelist.includes(e)||(i.value.whitelist.push(e),localStorage.setItem("phoneViewSettings",JSON.stringify(i.value)))},removeFromPhoneWhitelist:e=>{const t=i.value.whitelist.indexOf(e);t>-1&&(i.value.whitelist.splice(t,1),localStorage.setItem("phoneViewSettings",JSON.stringify(i.value)))},initPhoneViewSettings:()=>{const e=localStorage.getItem("phoneViewSettings");e&&(i.value=JSON.parse(e))},checkSensitiveInfoAccess:t=>{if(!e.value)return!1;return we.checkSensitiveInfoAccess(e.value.id,t)},getUserPermissionInfo:()=>e.value?we.getUserPermission(e.value.id):null,updateUserPermission:(t,s)=>{if(!e.value)return!1;const a={userId:e.value.id,role:t,permissions:t===he.SUPER_ADMIN?[ve.FULL_ACCESS]:t===he.WHITELIST_MEMBER?[ve.PARTIAL_ACCESS]:[ve.RESTRICTED],whitelistTypes:s};return we.setUserPermission(a),e.value.userRole=t,e.value.permissionLevel=a.permissions[0],e.value.sensitiveInfoAccess=s,!0},clearUserDatabaseCache:()=>{localStorage.removeItem("userDatabase"),console.log("[Dev] 用户数据库缓存已清除，将使用最新的默认数据")}}}),fs=Object.freeze(Object.defineProperty({__proto__:null,useUserStore:ys},Symbol.toStringTag,{value:"Module"})),_s=e("tabs",()=>{const e=s([{name:"/dashboard",title:"数据看板",component:"Dashboard",closable:!1}]),t=s("/dashboard"),r=s(["Dashboard"]),o=a(()=>e.value.find(e=>e.name===t.value)),n=s=>{const a=e.value.find(e=>e.name===s),o=e.value.find(e=>"/dashboard"===e.name);r.value=[],o?.component&&r.value.push(o.component),a?.component&&a.component!==o?.component&&r.value.push(a.component),e.value=e.value.filter(e=>"/dashboard"===e.name||e.name===s),t.value=s},i=()=>{e.value=e.value.filter(e=>"/dashboard"===e.name),r.value=["Dashboard"],t.value="/dashboard"};return{tabs:e,activeTab:t,cachedViews:r,currentTab:o,addTab:s=>{e.value.find(e=>e.name===s.name)||(e.value.push({...s,closable:"/dashboard"!==s.name}),s.component&&!r.value.includes(s.component)&&r.value.push(s.component)),t.value=s.name},removeTab:s=>{const a=e.value.findIndex(e=>e.name===s);if(-1===a)return;const o=e.value[a];if(e.value.splice(a,1),o.component){const e=r.value.indexOf(o.component);e>-1&&r.value.splice(e,1)}if(t.value===s&&e.value.length>0){const s=e.value[a]||e.value[a-1];t.value=s.name}},removeOtherTabs:n,removeAllTabs:i,closeOtherTabs:e=>{n(e)},closeAllTabs:()=>{i()},clearTabs:()=>{e.value=[{name:"/dashboard",title:"数据看板",component:"Dashboard",closable:!1}],r.value=["Dashboard"],t.value="/dashboard"},setActiveTab:e=>{t.value=e},refreshTab:t=>{const s=e.value.find(e=>e.name===t);if(s?.component){const e=r.value.indexOf(s.component);e>-1&&(r.value.splice(e,1),setTimeout(()=>{r.value.push(s.component)},0))}}}}),Ss=e("config",()=>{const e=s({systemName:"CRM客户管理系统",systemVersion:"1.0.0",companyName:"示例科技有限公司",contactPhone:"400-123-4567",contactEmail:"contact@example.com",websiteUrl:"https://www.example.com",companyAddress:"北京市朝阳区示例大厦",systemDescription:"专业的客户关系管理系统，帮助企业提升客户服务质量和销售效率。",systemLogo:""}),t=s({passwordMinLength:8,passwordComplexity:["lowercase","number"],passwordExpireDays:90,loginFailLock:!0,maxLoginFails:5,lockDuration:30,sessionTimeout:120,forceHttps:!1,ipWhitelist:""}),r=s({maxDiscountPercent:30,adminMaxDiscount:50,managerMaxDiscount:30,salesMaxDiscount:15,discountApprovalThreshold:20,allowPriceModification:!0,priceModificationRoles:["admin","department_manager"],enablePriceHistory:!0,pricePrecision:"2",enableInventory:!0,lowStockThreshold:10,allowNegativeStock:!1,defaultCategory:"未分类",maxCategoryLevel:3,enableCategoryCode:!0,enablePermissionControl:!0,costPriceViewRoles:["super_admin","admin","finance"],salesDataViewRoles:["super_admin","admin","department_manager"],stockInfoViewRoles:["super_admin","admin","department_manager","warehouse"],operationLogsViewRoles:["super_admin","admin","audit"],sensitiveInfoHideMethod:"eye_icon"}),o=s({primaryColor:"#409EFF",sidebarCollapsed:!1,language:"zh-CN",timezone:"Asia/Shanghai"}),n=s({provider:"aliyun",accessKey:"",secretKey:"",signName:"",dailyLimit:100,monthlyLimit:3e3,enabled:!1,requireApproval:!1,testPhone:""}),i=s({storageType:"local",localPath:"/uploads",localDomain:"http://localhost:3001",accessKey:"",secretKey:"",bucketName:"",region:"",customDomain:"",maxFileSize:10,allowedTypes:"jpg,png,gif,pdf,doc,docx,xls,xlsx",imageCompressEnabled:!0,imageCompressQuality:"medium",imageCompressMaxWidth:1200,imageCompressCustomQuality:60}),c=s({smtpHost:"",smtpPort:587,senderEmail:"",senderName:"",emailPassword:"",enableSsl:!0,enableTls:!1,testEmail:""}),l=s({sipServer:"",sipPort:5060,sipUsername:"",sipPassword:"",sipTransport:"UDP",autoAnswer:!1,autoRecord:!1,qualityMonitoring:!1,incomingCallPopup:!0,maxCallDuration:3600,recordFormat:"mp3",recordQuality:"standard",recordPath:"./recordings",recordRetentionDays:90,outboundPermission:["admin","manager","sales"],recordAccessPermission:["admin","manager"],statisticsPermission:["admin","manager"],numberRestriction:!1,allowedPrefixes:""}),d=s({enabled:!0,allowCopy:!0,allowDownload:!0,watermarkEnabled:!0,watermarkType:"account",watermarkText:""}),u=a(()=>t.value.passwordComplexity.length>0),m=a(()=>e=>r.value.allowPriceModification&&r.value.priceModificationRoles.includes(e)),p=a(()=>e=>{switch(e){case"admin":return r.value.adminMaxDiscount;case"department_manager":return r.value.managerMaxDiscount;case"sales":return r.value.salesMaxDiscount;default:return 0}}),g=e=>{Object.assign(o.value,e),h("theme",o.value),e.primaryColor&&document.documentElement.style.setProperty("--el-color-primary",e.primaryColor)},h=async(e,t)=>{try{const a=window.location.hostname,r=a.includes("abc789.cn")||a.includes("vercel.app")||a.includes("netlify.app")||a.includes("railway.app")||!a.includes("localhost")&&!a.includes("127.0.0.1"),o=localStorage.getItem("auth_token");if(r&&o){console.log(`[ConfigStore] 生产环境：保存${e}配置到数据库`);try{const{api:s}=await ge(async()=>{const{api:e}=await Promise.resolve().then(()=>mt);return{api:e}},void 0);await s.post("/system/settings",{type:e,config:t}),console.log(`[ConfigStore] ${e}配置保存到数据库成功`)}catch(s){localStorage.setItem(`crm_config_${e}`,JSON.stringify(t))}}else localStorage.setItem(`crm_config_${e}`,JSON.stringify(t))}catch(a){console.error("保存配置失败:",a)}},v=s=>{"system"!==s&&"all"!==s||(e.value={systemName:"CRM客户管理系统",systemVersion:"1.0.0",companyName:"示例科技有限公司",contactPhone:"400-123-4567",contactEmail:"contact@example.com",websiteUrl:"https://www.example.com",companyAddress:"北京市朝阳区示例大厦",systemDescription:"专业的客户关系管理系统，帮助企业提升客户服务质量和销售效率。",systemLogo:""},h("system",e.value)),"security"!==s&&"all"!==s||(t.value={passwordMinLength:8,passwordComplexity:["lowercase","number"],passwordExpireDays:90,loginFailLock:!0,maxLoginFails:5,lockDuration:30,sessionTimeout:120,forceHttps:!1,ipWhitelist:""},h("security",t.value)),"product"!==s&&"all"!==s||(r.value={maxDiscountPercent:30,adminMaxDiscount:50,managerMaxDiscount:30,salesMaxDiscount:15,discountApprovalThreshold:20,allowPriceModification:!0,priceModificationRoles:["admin","department_manager"],enablePriceHistory:!0,pricePrecision:"2",enableInventory:!0,lowStockThreshold:10,allowNegativeStock:!1,defaultCategory:"未分类",maxCategoryLevel:3,enableCategoryCode:!0,enablePermissionControl:!0,costPriceViewRoles:["super_admin","admin","finance"],salesDataViewRoles:["super_admin","admin","department_manager"],stockInfoViewRoles:["super_admin","admin","department_manager","warehouse"],operationLogsViewRoles:["super_admin","admin","audit"],sensitiveInfoHideMethod:"eye_icon"},h("product",r.value)),"theme"!==s&&"all"!==s||(o.value={primaryColor:"#409EFF",sidebarCollapsed:!1,language:"zh-CN",timezone:"Asia/Shanghai"},h("theme",o.value),g({})),"sms"!==s&&"all"!==s||(n.value={provider:"aliyun",accessKey:"",secretKey:"",signName:"",dailyLimit:100,monthlyLimit:3e3,enabled:!1,requireApproval:!0,testPhone:""},h("sms",n.value))},y=async()=>{try{const{apiService:t}=await ge(async()=>{const{apiService:e}=await Promise.resolve().then(()=>Pe);return{apiService:e}},void 0);console.log("[ConfigStore] 开始从API加载系统配置...");const s=await t.get("/system/basic-settings");console.log("[ConfigStore] API返回的配置数据:",s),s&&"object"==typeof s&&(Object.assign(e.value,s),h("system",e.value),console.log("[ConfigStore] 系统配置已从API更新"))}catch(t){console.warn("[ConfigStore] 从API加载系统配置失败，使用本地配置:",t)}},f=async()=>{try{const{apiService:e}=await ge(async()=>{const{apiService:e}=await Promise.resolve().then(()=>Pe);return{apiService:e}},void 0);console.log("[ConfigStore] 开始从API加载存储配置...");const t=await e.get("/system/storage-settings");console.log("[ConfigStore] 存储配置API返回:",t),t&&"object"==typeof t&&(Object.assign(i.value,t),h("storage",i.value),console.log("[ConfigStore] 存储配置已从API更新:",i.value))}catch(e){console.warn("[ConfigStore] 从API加载存储配置失败，使用本地配置:",e)}},_=async()=>{try{const{apiService:e}=await ge(async()=>{const{apiService:e}=await Promise.resolve().then(()=>Pe);return{apiService:e}},void 0);console.log("[ConfigStore] 开始从API加载商品优惠折扣配置...");const t=await e.get("/system/product-settings/public");console.log("[ConfigStore] 商品优惠配置API返回:",t),t&&"object"==typeof t&&(void 0!==t.maxDiscountPercent&&(r.value.maxDiscountPercent=t.maxDiscountPercent),void 0!==t.adminMaxDiscount&&(r.value.adminMaxDiscount=t.adminMaxDiscount),void 0!==t.managerMaxDiscount&&(r.value.managerMaxDiscount=t.managerMaxDiscount),void 0!==t.salesMaxDiscount&&(r.value.salesMaxDiscount=t.salesMaxDiscount),void 0!==t.discountApprovalThreshold&&(r.value.discountApprovalThreshold=t.discountApprovalThreshold),void 0!==t.allowPriceModification&&(r.value.allowPriceModification=t.allowPriceModification),localStorage.setItem("crm_config_product",JSON.stringify(r.value)),console.log("[ConfigStore] 商品优惠配置已从API更新:",{maxDiscountPercent:r.value.maxDiscountPercent,adminMaxDiscount:r.value.adminMaxDiscount,managerMaxDiscount:r.value.managerMaxDiscount,salesMaxDiscount:r.value.salesMaxDiscount}))}catch(e){console.log("[ConfigStore] 从API加载商品配置失败，使用本地配置")}};return{systemConfig:e,securityConfig:t,productConfig:r,themeConfig:o,smsConfig:n,storageConfig:i,emailConfig:c,callConfig:l,performanceShareConfig:d,isPasswordComplexityEnabled:u,canUserModifyPrice:m,getMaxDiscountForRole:p,updateSystemConfig:t=>{Object.assign(e.value,t),h("system",e.value)},updateSecurityConfig:e=>{Object.assign(t.value,e),h("security",t.value)},updateProductConfig:e=>{Object.assign(r.value,e),h("product",r.value)},updateThemeConfig:g,initTheme:()=>{try{if("undefined"==typeof localStorage)return console.warn("[Config] localStorage不可用，使用默认主题配置"),void g({});const t=localStorage.getItem("crm_config_theme");if(t)try{const e=JSON.parse(t);Object.assign(o.value,e),console.log("[Config] 主题配置已从本地存储加载")}catch(e){console.error("[Config] 解析主题配置失败:",e)}g({})}catch(e){console.error("[Config] 初始化主题失败:",e),g({})}},updateSmsConfig:e=>{Object.assign(n.value,e),h("sms",n.value)},updateStorageConfig:e=>{Object.assign(i.value,e),h("storage",i.value)},updateEmailConfig:e=>{Object.assign(c.value,e),h("email",c.value)},updateCallConfig:e=>{Object.assign(l.value,e),h("call",l.value)},updatePerformanceShareConfig:e=>{Object.assign(d.value,e),h("performanceShare",d.value)},resetConfig:v,resetSystemConfig:()=>{v("system")},resetSecurityConfig:()=>{v("security")},resetProductConfig:()=>{v("product")},resetThemeConfig:()=>{v("theme")},resetSmsConfig:()=>{v("sms")},loadSystemConfigFromAPI:y,loadStorageConfigFromAPI:f,loadProductConfigFromAPI:_,initConfig:async()=>{(()=>{try{const s=localStorage.getItem("crm_config_system");s?Object.assign(e.value,JSON.parse(s)):h("system",e.value);const a=localStorage.getItem("crm_config_security");a?Object.assign(t.value,JSON.parse(a)):h("security",t.value);const n=localStorage.getItem("crm_config_product");n?Object.assign(r.value,JSON.parse(n)):(console.log("[配置初始化] 商品配置不存在,保存默认配置:",r.value),h("product",r.value));const c=localStorage.getItem("crm_config_theme");c?(Object.assign(o.value,JSON.parse(c)),g({})):h("theme",o.value);const l=localStorage.getItem("crm_config_storage");l?Object.assign(i.value,JSON.parse(l)):h("storage",i.value);const u=localStorage.getItem("crm_config_performanceShare");u?Object.assign(d.value,JSON.parse(u)):h("performanceShare",d.value)}catch(s){console.error("加载配置失败:",s)}})(),await Promise.all([y(),f(),_()])}}}),ws={class:"loading-content"},As={key:0,class:"loading-text"},Is={key:1,class:"loading-progress"},Ps={class:"progress-container"},Es={class:"progress-bar"},Ts={class:"progress-text"},Cs=(e,t)=>{const s=e.__vccOpts||e;for(const[a,r]of t)s[a]=r;return s},Ds=Cs(i({__name:"GlobalLoading",props:{visible:{type:Boolean,default:!1},text:{default:"加载中..."},fullScreen:{type:Boolean,default:!0},size:{default:40},progress:{default:-1},showProgress:{type:Boolean,default:!1},showCancel:{type:Boolean,default:!1},cancelable:{type:Boolean,default:!1},onCancel:{}},emits:["cancel","backdropClick"],setup(e,{emit:t}){const s=e,a=t,r=()=>{s.cancelable&&a("backdropClick")},o=()=>{s.onCancel&&s.onCancel(),a("cancel")};return(t,s)=>{const a=c("el-button");return e.visible?(u(),l("div",{key:0,class:m(["global-loading",{"full-screen":e.fullScreen}])},[p("div",{class:"loading-backdrop",onClick:r}),p("div",ws,[s[1]||(s[1]=g('<div class="loading-spinner" data-v-7e11a068><div class="spinner-container" data-v-7e11a068><div class="spinner-ring" data-v-7e11a068></div><div class="spinner-ring" data-v-7e11a068></div><div class="spinner-ring" data-v-7e11a068></div><div class="spinner-dots" data-v-7e11a068><div class="dot" data-v-7e11a068></div><div class="dot" data-v-7e11a068></div><div class="dot" data-v-7e11a068></div></div></div></div>',1)),e.text?(u(),l("div",As,v(e.text),1)):d("",!0),e.showProgress&&e.progress>=0?(u(),l("div",Is,[p("div",Ps,[p("div",Es,[p("div",{class:"progress-fill",style:y({width:e.progress+"%"})},null,4)]),p("span",Ts,v(e.progress)+"%",1)])])):d("",!0),e.showCancel&&e.onCancel?(u(),h(a,{key:2,onClick:o,size:"small",type:"text",class:"cancel-btn"},{default:f(()=>[...s[0]||(s[0]=[_(" 取消 ",-1)])]),_:1})):d("",!0)])],2)):d("",!0)}}}),[["__scopeId","data-v-7e11a068"]]),ks={class:"error-boundary"},bs={key:1,class:"error-content"},Rs={class:"error-icon"},Os={class:"error-title"},Ns={class:"error-message"},Ms={class:"error-actions"},Ls=Cs(i({__name:"ErrorBoundary",props:{fallbackTitle:{default:"页面出现错误"},fallbackMessage:{default:"抱歉，页面遇到了一些问题，请稍后重试"},showRetry:{type:Boolean,default:!0},onRetry:{}},setup(e,{expose:t}){const a=e,r=Gt(S()),o=s(!1),n=s(""),i=s(""),m=s(""),g=s(!1);w((e,t,s)=>(console.error("ErrorBoundary captured error:",e,s),o.value=!0,n.value=a.fallbackTitle,i.value=y(e),m.value=`${e.stack}\n\nComponent Info: ${s}`,E(e,s),!1));const y=e=>e.message.includes("Network Error")?"网络连接失败，请检查网络设置后重试":e.message.includes("timeout")?"请求超时，请稍后重试":e.message.includes("401")?"登录已过期，请重新登录":e.message.includes("403")?"没有权限访问此资源":e.message.includes("404")?"请求的资源不存在":e.message.includes("500")?"服务器内部错误，请稍后重试":a.fallbackMessage,E=(e,t)=>{const s={message:e.message,stack:e.stack,componentInfo:t,userAgent:navigator.userAgent,url:window.location.href,timestamp:(new Date).toISOString()};console.error("Error Report:",s)},T=()=>{a.onRetry?a.onRetry():window.location.reload()},C=()=>{r.push("/dashboard"),V.success("已返回首页")};return t({resetError:()=>{o.value=!1,n.value="",i.value="",m.value="",g.value=!1}}),(e,t)=>{const s=c("el-icon"),a=c("el-button"),r=c("el-collapse-item"),y=c("el-collapse");return u(),l("div",ks,[o.value?(u(),l("div",bs,[p("div",Rs,[I(s,{size:"64",color:"#f56c6c"},{default:f(()=>[I(P(F))]),_:1})]),p("h3",Os,v(n.value),1),p("p",Ns,v(i.value),1),p("div",Ms,[I(a,{onClick:T,type:"primary"},{default:f(()=>[I(s,null,{default:f(()=>[I(P(q))]),_:1}),t[1]||(t[1]=_(" 重试 ",-1))]),_:1}),I(a,{onClick:C},{default:f(()=>[I(s,null,{default:f(()=>[I(P(H))]),_:1}),t[2]||(t[2]=_(" 返回首页 ",-1))]),_:1})]),g.value?(u(),h(y,{key:0,class:"error-details"},{default:f(()=>[I(r,{title:"错误详情",name:"details"},{default:f(()=>[p("pre",null,v(m.value),1)]),_:1})]),_:1})):d("",!0),g.value?d("",!0):(u(),h(a,{key:1,onClick:t[0]||(t[0]=e=>g.value=!0),type:"text",size:"small",class:"show-details-btn"},{default:f(()=>[...t[3]||(t[3]=[_(" 显示详细信息 ",-1)])]),_:1}))])):A(e.$slots,"default",{key:0},void 0,!0)])}}}),[["__scopeId","data-v-af8bd6d7"]]),Us="123456";const xs=new class{getPasswordPolicy(){const e=Ss().securityConfig;return{minLength:e.passwordMinLength,requireUppercase:e.passwordComplexity.includes("uppercase"),requireLowercase:e.passwordComplexity.includes("lowercase"),requireNumbers:e.passwordComplexity.includes("number"),requireSpecialChars:e.passwordComplexity.includes("special"),expirationDays:e.passwordExpireDays,reminderDays:7,defaultPassword:Us}}getCurrentPolicy(){return this.getPasswordPolicy()}validatePassword(e){const t=this.getPasswordPolicy(),s=[];return e.length<t.minLength&&s.push(`密码长度至少${t.minLength}位`),t.requireUppercase&&!/[A-Z]/.test(e)&&s.push("密码必须包含大写字母"),t.requireLowercase&&!/[a-z]/.test(e)&&s.push("密码必须包含小写字母"),t.requireNumbers&&!/\d/.test(e)&&s.push("密码必须包含数字"),t.requireSpecialChars&&!/[!@#$%^&*(),.?":{}|<>]/.test(e)&&s.push("密码必须包含特殊字符"),e===t.defaultPassword&&s.push("不能使用默认密码"),{isValid:0===s.length,errors:s}}isDefaultPassword(e){return e===Us}isPasswordExpired(e){const t=this.getPasswordPolicy();if(!e.passwordLastChanged)return!0;const s=new Date(e.passwordLastChanged);return s.setDate(s.getDate()+t.expirationDays),new Date>s}needsPasswordReminder(e){const t=this.getPasswordPolicy();if(!e.passwordLastChanged)return!0;const s=new Date(e.passwordLastChanged);return s.setDate(s.getDate()+t.expirationDays-t.reminderDays),new Date>s&&!this.isPasswordExpired(e)}getPasswordRemainingDays(e){const t=this.getPasswordPolicy();if(!e.passwordLastChanged)return 0;const s=new Date(e.passwordLastChanged);s.setDate(s.getDate()+t.expirationDays);const a=new Date,r=s.getTime()-a.getTime(),o=Math.ceil(r/864e5);return Math.max(0,o)}async changePassword(e){try{const s=this.validatePassword(e.newPassword);if(!s.isValid)return{success:!1,message:s.errors.join(", ")};if(e.newPassword!==e.confirmPassword)return{success:!1,message:"新密码和确认密码不匹配"};try{const{apiService:t}=await ge(async()=>{const{apiService:e}=await Promise.resolve().then(()=>Pe);return{apiService:e}},void 0),s=await t.put("/profile/password",{currentPassword:e.currentPassword,newPassword:e.newPassword,confirmPassword:e.confirmPassword});return this.updateUserPasswordInfo(e.userId||"current",{isDefaultPassword:!1,passwordLastChanged:new Date,forcePasswordChange:!1}),{success:!0,message:s.message||"密码修改成功"}}catch(t){return{success:!1,message:t.response?.data?.message||t.message||"密码修改失败"}}}catch(s){return{success:!1,message:"密码修改失败，请稍后重试"}}}async resetPassword(e){try{const t=this.validatePassword(e.newPassword);return t.isValid?(await this.simulateApiCall(),this.updateUserPasswordInfo(e.userId,{isDefaultPassword:!1,passwordLastChanged:new Date,forcePasswordChange:!0}),{success:!0,message:"密码重置成功，用户下次登录时需要修改密码"}):{success:!1,message:t.errors.join(", ")}}catch(t){return{success:!1,message:"密码重置失败，请稍后重试"}}}async resetPasswordByAdmin(e,t){try{const t=this.generateTemporaryPassword();return await this.simulateApiCall(),this.updateUserPasswordInfo(e,{isDefaultPassword:!1,passwordLastChanged:new Date,forcePasswordChange:!0}),{success:!0,message:"密码重置成功，用户下次登录时需要修改密码",tempPassword:t}}catch(s){return{success:!1,message:"密码重置失败，请稍后重试"}}}generateTemporaryPassword(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";let t="";t+="A",t+="a",t+="1",t+="!";for(let s=4;s<12;s++)t+=e.charAt(Math.floor(70*Math.random()));return t.split("").sort(()=>Math.random()-.5).join("")}initializeUserPasswordInfo(e){const t=this.getStoredUsers(),s=t.find(t=>t.id===e);s&&!s.passwordLastChanged&&(s.isDefaultPassword=!0,s.passwordLastChanged=new Date,s.forcePasswordChange=!0,localStorage.setItem("users",JSON.stringify(t)))}updateUserPasswordInfo(e,t){const s=this.getStoredUsers(),a=s.findIndex(t=>t.id===e);-1!==a&&(s[a]={...s[a],...t},localStorage.setItem("users",JSON.stringify(s)))}getStoredUsers(){const e=localStorage.getItem("users");return e?JSON.parse(e):[]}async simulateApiCall(){return new Promise(e=>{setTimeout(e,1e3)})}},$s={key:0,class:"modal-overlay"},Vs={class:"modal-container"},js={class:"modal-header"},Fs={class:"modal-body"},qs={key:0,class:"warning-message"},Hs={class:"warning-text"},Bs={key:0},Js={key:1},zs={key:2},Gs={class:"form-group"},Ks={key:0,class:"error-text"},Ys={class:"form-group"},Ws={key:0,class:"error-text"},Qs={class:"password-requirements"},Xs={class:"form-group"},Zs={key:0,class:"error-text"},ea={class:"form-actions"},ta=["disabled"],sa=i({__name:"PasswordChangeModal",props:{visible:{type:Boolean},isForced:{type:Boolean,default:!1},isDefaultPassword:{type:Boolean,default:!1},isExpired:{type:Boolean,default:!1}},emits:["close","success"],setup(e,{emit:r}){const o=e,n=r,i=ys(),c=s({currentPassword:"",newPassword:"",confirmPassword:""}),g=s({currentPassword:"",newPassword:"",confirmPassword:""}),h=s(!1),y=a(()=>c.value.newPassword.length>=8),f=a(()=>/[A-Z]/.test(c.value.newPassword)),_=a(()=>/[a-z]/.test(c.value.newPassword)),S=a(()=>/\d/.test(c.value.newPassword)),w=a(()=>/[!@#$%^&*(),.?":{}|<>]/.test(c.value.newPassword)),A=a(()=>c.value.currentPassword&&c.value.newPassword&&c.value.confirmPassword&&y.value&&f.value&&_.value&&S.value&&w.value&&c.value.newPassword===c.value.confirmPassword);t(()=>c.value.newPassword,e=>{if(e){const t=xs.validatePassword(e);g.value.newPassword=t.isValid?"":t.errors.join(", ")}else g.value.newPassword=""}),t(()=>c.value.confirmPassword,e=>{e&&c.value.newPassword?g.value.confirmPassword=e===c.value.newPassword?"":"两次输入的密码不一致":g.value.confirmPassword=""});const I=async()=>{if(A.value){h.value=!0,g.value={currentPassword:"",newPassword:"",confirmPassword:""};try{const e={userId:i.user?.id||"",currentPassword:c.value.currentPassword,newPassword:c.value.newPassword,confirmPassword:c.value.confirmPassword},t=await xs.changePassword(e);t.success?(i.user&&(i.user.isDefaultPassword=!1,i.user.passwordLastChanged=new Date,i.user.forcePasswordChange=!1),n("success"),P()):t.message.includes("当前密码")?g.value.currentPassword=t.message:g.value.newPassword=t.message}catch(e){g.value.newPassword="修改密码失败，请稍后重试"}finally{h.value=!1}}},P=()=>{o.isForced||(c.value={currentPassword:"",newPassword:"",confirmPassword:""},g.value={currentPassword:"",newPassword:"",confirmPassword:""},n("close"))};return(t,s)=>e.visible?(u(),l("div",$s,[p("div",Vs,[p("div",js,[p("h3",null,v(e.isForced?"强制修改密码":"修改密码"),1),e.isForced?d("",!0):(u(),l("button",{key:0,onClick:P,class:"close-btn"},"×"))]),p("div",Fs,[e.isForced?(u(),l("div",qs,[s[3]||(s[3]=p("div",{class:"warning-icon"},"⚠️",-1)),p("div",Hs,[e.isDefaultPassword?(u(),l("p",Bs,"检测到您正在使用默认密码，为了账户安全，请立即修改密码。")):e.isExpired?(u(),l("p",Js,"您的密码已过期，请立即修改密码。")):(u(),l("p",zs,"管理员要求您修改密码，请设置新密码。"))])])):d("",!0),p("form",{onSubmit:E(I,["prevent"]),class:"password-form"},[p("div",Gs,[s[4]||(s[4]=p("label",{for:"currentPassword"},"当前密码",-1)),T(p("input",{id:"currentPassword","onUpdate:modelValue":s[0]||(s[0]=e=>c.value.currentPassword=e),type:"password",class:m({error:g.value.currentPassword}),placeholder:"请输入当前密码",required:""},null,2),[[C,c.value.currentPassword]]),g.value.currentPassword?(u(),l("span",Ks,v(g.value.currentPassword),1)):d("",!0)]),p("div",Ys,[s[6]||(s[6]=p("label",{for:"newPassword"},"新密码",-1)),T(p("input",{id:"newPassword","onUpdate:modelValue":s[1]||(s[1]=e=>c.value.newPassword=e),type:"password",class:m({error:g.value.newPassword}),placeholder:"请输入新密码",required:""},null,2),[[C,c.value.newPassword]]),g.value.newPassword?(u(),l("span",Ws,v(g.value.newPassword),1)):d("",!0),p("div",Qs,[s[5]||(s[5]=p("p",null,"密码要求：",-1)),p("ul",null,[p("li",{class:m({valid:y.value})},"至少8位字符",2),p("li",{class:m({valid:f.value})},"包含大写字母",2),p("li",{class:m({valid:_.value})},"包含小写字母",2),p("li",{class:m({valid:S.value})},"包含数字",2),p("li",{class:m({valid:w.value})},"包含特殊字符",2)])])]),p("div",Xs,[s[7]||(s[7]=p("label",{for:"confirmPassword"},"确认新密码",-1)),T(p("input",{id:"confirmPassword","onUpdate:modelValue":s[2]||(s[2]=e=>c.value.confirmPassword=e),type:"password",class:m({error:g.value.confirmPassword}),placeholder:"请再次输入新密码",required:""},null,2),[[C,c.value.confirmPassword]]),g.value.confirmPassword?(u(),l("span",Zs,v(g.value.confirmPassword),1)):d("",!0)]),p("div",ea,[p("button",{type:"submit",disabled:!A.value||h.value,class:"submit-btn"},v(h.value?"修改中...":"确认修改"),9,ta),e.isForced?d("",!0):(u(),l("button",{key:0,type:"button",onClick:P,class:"cancel-btn"}," 取消 "))])],32)])])])):d("",!0)}}),aa=Cs(sa,[["__scopeId","data-v-e75547a4"]]),ra={key:0,class:"modal-overlay"},oa={class:"modal-container"},na={class:"modal-body"},ia={class:"reminder-message"},ca={class:"reminder-text"},la={key:0},da={key:1},ua={class:"last-changed"},ma={class:"reminder-actions"},pa={class:"reminder-options"},ga={class:"checkbox-label"},ha=["disabled"],va=Cs(i({__name:"PasswordReminderModal",props:{visible:{type:Boolean},remainingDays:{},lastChanged:{}},emits:["close","changePassword","remindLater"],setup(e,{emit:t}){const a=t,r=s(!1),o=()=>{a("changePassword"),i()},n=()=>{a("remindLater",r.value),i()},i=()=>{r.value=!1,a("close")};return(t,s)=>{return e.visible?(u(),l("div",ra,[p("div",oa,[p("div",{class:"modal-header"},[s[1]||(s[1]=p("h3",null,"密码过期提醒",-1)),p("button",{onClick:i,class:"close-btn"},"×")]),p("div",na,[p("div",ia,[s[4]||(s[4]=p("div",{class:"reminder-icon"},"🔔",-1)),p("div",ca,[e.remainingDays>0?(u(),l("p",la,[s[2]||(s[2]=_(" 您的密码将在 ",-1)),p("strong",null,v(e.remainingDays),1),s[3]||(s[3]=_(" 天后过期，建议您及时修改密码以确保账户安全。 ",-1))])):(u(),l("p",da," 您的密码已过期，请立即修改密码。 ")),p("p",ua," 上次修改时间："+v((a=e.lastChanged,a?new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(a):"未知")),1)])]),p("div",ma,[p("button",{onClick:o,class:"primary-btn"}," 立即修改密码 "),e.remainingDays>0?(u(),l("button",{key:0,onClick:n,class:"secondary-btn"}," 稍后提醒 ")):d("",!0)]),p("div",pa,[p("label",ga,[T(p("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>r.value=e),type:"checkbox",disabled:e.remainingDays<=0},null,8,ha),[[D,r.value]]),s[5]||(s[5]=_(" 今天不再提醒 ",-1))])])])])])):d("",!0);var a}}}),[["__scopeId","data-v-62e037f8"]]);class ya{static instance;api;constructor(){this.api=Ie}static getInstance(){return ya.instance||(ya.instance=new ya),ya.instance}async getProfile(){if(at())return console.log("[ProfileAPI] Mock API模式 - 使用模拟数据"),this.getMockProfile();try{const e=await this.api.get("/profile");return console.log("[ProfileAPI] 获取个人信息成功"),e}catch(e){return console.log("[ProfileAPI] API请求失败，使用模拟数据"),this.getMockProfile()}}async updateProfile(e){if(at()){console.log("[ProfileAPI] Mock API模式 - 更新个人信息到localStorage");try{const t=localStorage.getItem("user_info");if(t){const s=JSON.parse(t),a=s.id,r={realName:e.name||s.realName,name:e.name||s.name,email:e.email||s.email,phone:e.phone||s.phone,avatar:e.avatar||s.avatar,updatedAt:(new Date).toISOString()},o={...s,...r};localStorage.setItem("user_info",JSON.stringify(o)),console.log("[ProfileAPI] 已更新 user_info");["user","crm_mock_users","userDatabase","erp_users_list"].forEach(e=>{try{if("user"===e){const t=localStorage.getItem(e);if(t){const s=JSON.parse(t);if(String(s.id)===String(a)){const t={...s,...r};localStorage.setItem(e,JSON.stringify(t)),console.log(`[ProfileAPI] 已同步更新到 ${e}`)}}}else{const t=localStorage.getItem(e);if(t){const s=JSON.parse(t),o=s.findIndex(e=>String(e.id)===String(a));-1!==o&&(s[o]={...s[o],...r},localStorage.setItem(e,JSON.stringify(s)),console.log(`[ProfileAPI] 已同步更新到 ${e}`))}}}catch(t){console.warn(`[ProfileAPI] 同步到 ${e} 失败`)}}),console.log("[ProfileAPI] 个人信息更新成功，已同步到所有存储位置")}}catch(t){console.error("[ProfileAPI] 更新个人信息失败")}const s=this.getMockProfile();return{...s,name:e.name||s.name,email:e.email||s.email,phone:e.phone||s.phone,avatar:e.avatar||s.avatar}}try{const t=await this.api.put("/profile",e);return console.log("[ProfileAPI] 更新个人信息成功"),t}catch(t){console.log("[ProfileAPI] API请求失败，使用模拟数据");return{...this.getMockProfile(),...e}}}async uploadAvatar(e){if(at())return new Promise((t,s)=>{const a=new FileReader;a.onload=e=>{const s=e.target?.result;console.log("[ProfileAPI] 头像转换为base64成功");try{const e=localStorage.getItem("user_info");if(e){const t=JSON.parse(e);t.avatar=s,localStorage.setItem("user_info",JSON.stringify(t));["crm_mock_users","userDatabase","erp_users_list"].forEach(e=>{try{const a=localStorage.getItem(e);if(a){const r=JSON.parse(a),o=r.findIndex(e=>String(e.id)===String(t.id));-1!==o&&(r[o].avatar=s,localStorage.setItem(e,JSON.stringify(r)))}}catch(a){console.warn(`[ProfileAPI] 同步头像到 ${e} 失败`)}})}}catch(a){console.error("[ProfileAPI] 保存头像失败")}t(s)},a.onerror=()=>{s(new Error("读取文件失败"))},a.readAsDataURL(e)});try{const t=new FormData;t.append("avatar",e);const s=await this.api.post("/profile/avatar",t,{headers:{"Content-Type":"multipart/form-data"}});return console.log("[ProfileAPI] 头像上传成功"),s.url}catch(t){return console.error("[ProfileAPI] 头像上传失败"),URL.createObjectURL(e)}}async getPreferences(){try{const e=await this.api.get("/profile/preferences");return console.log("[ProfileAPI] 获取偏好设置成功"),e}catch(e){return console.error("[ProfileAPI] 获取偏好设置失败"),this.getDefaultPreferences()}}async updatePreferences(e){if(at()){try{const t=localStorage.getItem("user_info");if(t){const s=JSON.parse(t);localStorage.setItem(`user_preferences_${s.id}`,JSON.stringify(e)),console.log("[ProfileAPI] 偏好设置已保存到localStorage")}}catch(t){console.error("[ProfileAPI] 保存偏好设置失败")}return e}try{const t=await this.api.put("/profile/preferences",e);return console.log("[ProfileAPI] 更新偏好设置成功"),t}catch(t){return console.error("[ProfileAPI] 更新偏好设置失败"),e}}getMockProfile(){try{const e=localStorage.getItem("user_info");if(e){const t=JSON.parse(e);console.log("[ProfileAPI] 从localStorage读取用户信息:",t);let s={...t};0;const a=s.realName||s.name||s.username||"",r=s.email||"",o=s.phone||"";let n=s.departmentName||s.department||"";0;let i=s.roleName||"";if(!i){const e=JSON.parse(localStorage.getItem("crm_roles")||"[]").find(e=>e.code===s.role||e.code===s.roleId||String(e.id)===String(s.roleId));i=e?.name||s.role||""}const c=s.avatar||"",l=localStorage.getItem(`user_preferences_${s.id}`),d=l?JSON.parse(l):this.getDefaultPreferences();return console.log("[ProfileAPI] 字段映射结果:",{name:a,email:r,phone:o,departmentName:n,roleName:i,avatar:c?"有头像":"无头像"}),{id:String(s.id||""),username:s.username||"",name:a,email:r,phone:o,department:n,role:i,avatar:c,preferences:d,lastLoginTime:s.lastLoginAt||s.lastLoginTime||"",createTime:s.createdAt||s.createTime||""}}}catch(e){console.error("[ProfileAPI] 读取用户信息失败")}return{id:"1",username:"admin",name:"管理员",email:"admin@example.com",phone:"13800138000",department:"技术部",role:"管理员",avatar:"",preferences:this.getDefaultPreferences(),lastLoginTime:(new Date).toISOString(),createTime:(new Date).toISOString()}}getDefaultPreferences(){return{language:"zh-CN",timezone:"Asia/Shanghai",emailNotifications:!0,browserNotifications:!0,smsNotifications:!1,pageSize:20}}}const fa=ya.getInstance(),_a={class:"settings-container"},Sa={class:"settings-nav"},wa=["onClick"],Aa={class:"settings-content"},Ia={key:0,class:"content-section"},Pa={class:"profile-form"},Ea={class:"avatar-section"},Ta={class:"avatar-container"},Ca={class:"form-actions"},Da={key:1,class:"content-section"},ka={class:"password-strength"},ba={class:"strength-bar"},Ra={class:"strength-text"},Oa={class:"form-actions"},Na={key:2,class:"content-section"},Ma={class:"preferences-form"},La={class:"preference-group"},Ua={class:"preference-item"},xa={class:"preference-item"},$a={class:"preference-group"},Va={class:"preference-item"},ja={class:"preference-item"},Fa={class:"preference-item"},qa={class:"preference-group"},Ha={class:"preference-item"},Ba={class:"form-actions"},Ja=i({__name:"PersonalSettingsModal",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(e,{emit:o}){const n=e,i=o,g=ys(),S=s("profile"),w=s(!1),A=s(!1),E=s(!1),T=s(),C=s(),D=s(),N=[{key:"profile",label:"个人信息",icon:B},{key:"password",label:"密码修改",icon:J}],M=r({name:"",username:"",email:"",phone:"",department:"",role:"",avatar:""}),L=r({currentPassword:"",newPassword:"",confirmPassword:""}),U=r({language:"zh-CN",timezone:"Asia/Shanghai",emailNotifications:!0,browserNotifications:!0,smsNotifications:!1,pageSize:20}),x={name:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,max:20,message:"姓名长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{pattern:new RegExp("^1[3-9]\\d{9}$"),message:"请输入正确的手机号",trigger:"blur"}]},$={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度不能少于8位",trigger:"blur"},{validator:(e,t,s)=>{t&&t===L.currentPassword?s(new Error("新密码不能与当前密码相同")):s()},trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(e,t,s)=>{t!==L.newPassword?s(new Error("两次输入的密码不一致")):s()},trigger:"blur"}]},j=a(()=>{const e=L.newPassword;if(!e)return 0;let t=0;return e.length>=8&&(t+=1),new RegExp("[a-z]").test(e)&&(t+=1),new RegExp("[A-Z]").test(e)&&(t+=1),new RegExp("\\d").test(e)&&(t+=1),new RegExp('[!@#$%^&*(),.?":{}|<>]').test(e)&&(t+=1),t}),F=a(()=>{const e=j.value;return e<=2?"weak":e<=3?"medium":"strong"}),q=a(()=>j.value/5*100+"%"),H=a(()=>{const e=j.value;return e<=2?"弱":e<=3?"中等":"强"}),G=()=>{i("update:visible",!1)},K=async()=>{try{const e=await fa.getProfile();M.name=e.name||"",M.username=e.username||"",M.email=e.email||"",M.phone=e.phone||"",M.department=e.department||"",M.role=e.role||"",M.avatar=e.avatar||"",console.log("[PersonalSettings] 初始化表单数据:",{name:M.name,username:M.username,email:M.email,phone:M.phone,department:M.department,role:M.role,avatar:M.avatar?"有头像":"无头像"}),Object.assign(U,e.preferences)}catch(e){console.error("[PersonalSettings] 初始化个人信息失败:",e);const s=g.user;if(s)M.name=s.realName||s.name||s.username||"",M.username=s.username||"",M.email=s.email||"",M.phone=s.phone||"",M.department=s.departmentName||s.department||"",M.role=s.roleName||s.role||"",M.avatar=s.avatar||"",console.log("[PersonalSettings] 使用userStore数据:",{name:M.name,email:M.email,phone:M.phone,department:M.department});else try{const e=JSON.parse(localStorage.getItem("user_info")||"{}");e.id&&(M.name=e.realName||e.name||e.username||"",M.username=e.username||"",M.email=e.email||"",M.phone=e.phone||"",M.department=e.departmentName||e.department||"",M.role=e.roleName||e.role||"",M.avatar=e.avatar||"",console.log("[PersonalSettings] 使用localStorage数据:",{name:M.name,email:M.email,phone:M.phone,department:M.department}))}catch(t){console.error("[PersonalSettings] 读取localStorage失败:",t)}}},Y=()=>{D.value?.click()},W=async e=>{const t=e.target.files?.[0];if(t){if(!t.type.startsWith("image/"))return void V.error("请选择图片文件");if(t.size>2097152)return void V.error("图片大小不能超过2MB");try{const e=await fa.uploadAvatar(t);M.avatar=e,V.success("头像上传成功")}catch(s){console.error("头像上传失败:",s),V.error("头像上传失败，请重试")}}},Q=async()=>{try{await(T.value?.validate()),w.value=!0;const e={name:M.name,email:M.email,phone:M.phone,avatar:M.avatar};if(await fa.updateProfile(e),g.user){const e={...g.user,realName:M.name,name:M.name,email:M.email,phone:M.phone,avatar:M.avatar};Object.assign(g.user,e),localStorage.setItem("user",JSON.stringify(e)),localStorage.setItem("user_info",JSON.stringify(e)),console.log("[PersonalSettings] 已更新userStore和localStorage")}V.success("个人信息保存成功"),i("success")}catch(e){console.error("保存个人信息失败:",e),V.error("保存个人信息失败，请重试")}finally{w.value=!1}},X=()=>{K(),T.value?.clearValidate()},Z=async()=>{try{await(C.value?.validate()),A.value=!0;const e=await xs.changePassword({userId:g.user?.id||"current",currentPassword:L.currentPassword,newPassword:L.newPassword,confirmPassword:L.confirmPassword});e.success?(V.success("密码修改成功"),ee(),i("success")):V.error(e.message||"密码修改失败")}catch(e){console.error("密码修改失败:",e),V.error("密码修改失败，请稍后重试")}finally{A.value=!1}},ee=()=>{Object.assign(L,{currentPassword:"",newPassword:"",confirmPassword:""}),C.value?.clearValidate()},te=async()=>{try{E.value=!0;const e={language:U.language,timezone:U.timezone,emailNotifications:U.emailNotifications,browserNotifications:U.browserNotifications,smsNotifications:U.smsNotifications,pageSize:U.pageSize};await fa.updatePreferences(e),V.success("偏好设置保存成功"),i("success")}catch(e){console.error("保存偏好设置失败:",e),V.error("保存偏好设置失败，请重试")}finally{E.value=!1}},se=()=>{Object.assign(U,{language:"zh-CN",timezone:"Asia/Shanghai",emailNotifications:!0,browserNotifications:!0,smsNotifications:!1,pageSize:20})};return t(()=>n.visible,e=>{e&&(K(),S.value="profile")}),k(()=>{K()}),(t,s)=>{const a=c("el-icon"),r=c("el-avatar"),o=c("el-input"),n=c("el-form-item"),i=c("el-col"),g=c("el-row"),k=c("el-form"),V=c("el-button"),j=c("el-option"),J=c("el-select"),K=c("el-switch"),ae=c("el-dialog");return u(),h(ae,{"model-value":e.visible,"onUpdate:modelValue":G,title:"个人设置",width:"800px","before-close":G,class:"personal-settings-modal"},{default:f(()=>[p("div",_a,[p("div",Sa,[(u(),l(b,null,R(N,e=>p("div",{key:e.key,class:m(["nav-item",{active:S.value===e.key}]),onClick:t=>S.value=e.key},[I(a,null,{default:f(()=>[(u(),h(O(e.icon)))]),_:2},1024),p("span",null,v(e.label),1)],10,wa)),64))]),p("div",Aa,["profile"===S.value?(u(),l("div",Ia,[s[18]||(s[18]=p("div",{class:"section-header"},[p("h3",null,"个人信息"),p("p",null,"管理您的基本信息和头像")],-1)),p("div",Pa,[p("div",Ea,[p("div",Ta,[I(r,{src:M.avatar,size:80,class:"user-avatar"},{default:f(()=>[M.avatar?d("",!0):(u(),h(a,{key:0},{default:f(()=>[I(P(B))]),_:1}))]),_:1},8,["src"]),p("div",{class:"avatar-overlay",onClick:Y},[I(a,null,{default:f(()=>[I(P(z))]),_:1}),s[15]||(s[15]=p("span",null,"更换头像",-1))])]),p("input",{ref_key:"avatarInput",ref:D,type:"file",accept:"image/*",style:{display:"none"},onChange:W},null,544)]),I(k,{ref_key:"profileFormRef",ref:T,model:M,rules:x,"label-width":"100px",class:"profile-info-form"},{default:f(()=>[I(g,{gutter:20},{default:f(()=>[I(i,{span:12},{default:f(()=>[I(n,{label:"姓名",prop:"name"},{default:f(()=>[I(o,{modelValue:M.name,"onUpdate:modelValue":s[0]||(s[0]=e=>M.name=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),I(i,{span:12},{default:f(()=>[I(n,{label:"用户名",prop:"username"},{default:f(()=>[I(o,{modelValue:M.username,"onUpdate:modelValue":s[1]||(s[1]=e=>M.username=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),I(g,{gutter:20},{default:f(()=>[I(i,{span:12},{default:f(()=>[I(n,{label:"邮箱",prop:"email"},{default:f(()=>[I(o,{modelValue:M.email,"onUpdate:modelValue":s[2]||(s[2]=e=>M.email=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),I(i,{span:12},{default:f(()=>[I(n,{label:"手机号",prop:"phone"},{default:f(()=>[I(o,{modelValue:M.phone,"onUpdate:modelValue":s[3]||(s[3]=e=>M.phone=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),I(g,{gutter:20},{default:f(()=>[I(i,{span:12},{default:f(()=>[I(n,{label:"部门"},{default:f(()=>[I(o,{modelValue:M.department,"onUpdate:modelValue":s[4]||(s[4]=e=>M.department=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),I(i,{span:12},{default:f(()=>[I(n,{label:"角色"},{default:f(()=>[I(o,{modelValue:M.role,"onUpdate:modelValue":s[5]||(s[5]=e=>M.role=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),p("div",Ca,[I(V,{type:"primary",onClick:Q,loading:w.value},{default:f(()=>[...s[16]||(s[16]=[_(" 保存更改 ",-1)])]),_:1},8,["loading"]),I(V,{onClick:X},{default:f(()=>[...s[17]||(s[17]=[_("重置",-1)])]),_:1})])])])):d("",!0),"password"===S.value?(u(),l("div",Da,[s[21]||(s[21]=p("div",{class:"section-header"},[p("h3",null,"密码修改"),p("p",null,"定期修改密码以保护账户安全")],-1)),I(k,{ref_key:"passwordFormRef",ref:C,model:L,rules:$,"label-width":"120px",class:"password-form"},{default:f(()=>[I(n,{label:"当前密码",prop:"currentPassword"},{default:f(()=>[I(o,{modelValue:L.currentPassword,"onUpdate:modelValue":s[6]||(s[6]=e=>L.currentPassword=e),type:"password",placeholder:"请输入当前密码","show-password":""},null,8,["modelValue"])]),_:1}),I(n,{label:"新密码",prop:"newPassword"},{default:f(()=>[I(o,{modelValue:L.newPassword,"onUpdate:modelValue":s[7]||(s[7]=e=>L.newPassword=e),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"]),p("div",ka,[p("div",ba,[p("div",{class:m(["strength-fill",F.value]),style:y({width:q.value})},null,6)]),p("span",Ra,v(H.value),1)])]),_:1}),I(n,{label:"确认新密码",prop:"confirmPassword"},{default:f(()=>[I(o,{modelValue:L.confirmPassword,"onUpdate:modelValue":s[8]||(s[8]=e=>L.confirmPassword=e),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),p("div",Oa,[I(V,{type:"primary",onClick:Z,loading:A.value},{default:f(()=>[...s[19]||(s[19]=[_(" 修改密码 ",-1)])]),_:1},8,["loading"]),I(V,{onClick:ee},{default:f(()=>[...s[20]||(s[20]=[_("重置",-1)])]),_:1})])])):d("",!0),"preferences"===S.value?(u(),l("div",Na,[s[33]||(s[33]=p("div",{class:"section-header"},[p("h3",null,"偏好设置"),p("p",null,"个性化您的使用体验")],-1)),p("div",Ma,[p("div",La,[s[24]||(s[24]=p("h4",null,"界面设置",-1)),p("div",Ua,[s[22]||(s[22]=p("div",{class:"preference-label"},[p("span",null,"语言"),p("p",null,"选择界面显示语言")],-1)),I(J,{modelValue:U.language,"onUpdate:modelValue":s[9]||(s[9]=e=>U.language=e),placeholder:"选择语言"},{default:f(()=>[I(j,{label:"简体中文",value:"zh-CN"}),I(j,{label:"English",value:"en-US"})]),_:1},8,["modelValue"])]),p("div",xa,[s[23]||(s[23]=p("div",{class:"preference-label"},[p("span",null,"时区"),p("p",null,"设置您所在的时区")],-1)),I(J,{modelValue:U.timezone,"onUpdate:modelValue":s[10]||(s[10]=e=>U.timezone=e),placeholder:"选择时区"},{default:f(()=>[I(j,{label:"北京时间 (UTC+8)",value:"Asia/Shanghai"}),I(j,{label:"东京时间 (UTC+9)",value:"Asia/Tokyo"}),I(j,{label:"纽约时间 (UTC-5)",value:"America/New_York"})]),_:1},8,["modelValue"])])]),p("div",$a,[s[28]||(s[28]=p("h4",null,"通知设置",-1)),p("div",Va,[s[25]||(s[25]=p("div",{class:"preference-label"},[p("span",null,"邮件通知"),p("p",null,"接收重要事件的邮件通知")],-1)),I(K,{modelValue:U.emailNotifications,"onUpdate:modelValue":s[11]||(s[11]=e=>U.emailNotifications=e)},null,8,["modelValue"])]),p("div",ja,[s[26]||(s[26]=p("div",{class:"preference-label"},[p("span",null,"浏览器通知"),p("p",null,"在浏览器中显示通知")],-1)),I(K,{modelValue:U.browserNotifications,"onUpdate:modelValue":s[12]||(s[12]=e=>U.browserNotifications=e)},null,8,["modelValue"])]),p("div",Fa,[s[27]||(s[27]=p("div",{class:"preference-label"},[p("span",null,"短信通知"),p("p",null,"接收重要事件的短信通知")],-1)),I(K,{modelValue:U.smsNotifications,"onUpdate:modelValue":s[13]||(s[13]=e=>U.smsNotifications=e)},null,8,["modelValue"])])]),p("div",qa,[s[30]||(s[30]=p("h4",null,"数据设置",-1)),p("div",Ha,[s[29]||(s[29]=p("div",{class:"preference-label"},[p("span",null,"每页显示条数"),p("p",null,"设置表格默认每页显示的数据条数")],-1)),I(J,{modelValue:U.pageSize,"onUpdate:modelValue":s[14]||(s[14]=e=>U.pageSize=e),placeholder:"选择条数"},{default:f(()=>[I(j,{label:"10条",value:10}),I(j,{label:"20条",value:20}),I(j,{label:"50条",value:50}),I(j,{label:"100条",value:100})]),_:1},8,["modelValue"])])])]),p("div",Ba,[I(V,{type:"primary",onClick:te,loading:E.value},{default:f(()=>[...s[31]||(s[31]=[_(" 保存设置 ",-1)])]),_:1},8,["loading"]),I(V,{onClick:se},{default:f(()=>[...s[32]||(s[32]=[_("重置",-1)])]),_:1})])])):d("",!0)])])]),_:1},8,["model-value"])}}}),za=Cs(Ja,[["__scopeId","data-v-3d60923a"]]);class Ga{static instance;STORAGE_KEY="health_check_notification_preferences";preferences=s(new Map);constructor(){this.loadPreferences()}static getInstance(){return Ga.instance||(Ga.instance=new Ga),Ga.instance}shouldShowNotification(e){if(!ys().isSuperAdmin)return!1;const t=this.preferences.value.get(e);if(!t)return!0;const s=Date.now();return!(t.suppressUntil&&s<t.suppressUntil)&&(t.suppressUntil&&s>=t.suppressUntil&&this.resetSuppression(e),!0)}async showHealthCheckFailureNotification(e){const t=ys(),s=t.currentUser?.id;if(s&&this.shouldShowNotification(s))try{await G({title:"API健康检查失败",message:`\n          <div style="margin-bottom: 15px;">\n            <p style="color: #E6A23C; font-weight: bold;">⚠️ API服务连接失败</p>\n            <p style="color: #666; margin: 8px 0;">错误信息: ${e}</p>\n            <p style="color: #666; margin: 8px 0;">系统已自动切换到本地存储模式，数据功能不受影响。</p>\n            <p style="color: #909399; font-size: 12px;">注: 只有超级管理员才能看到此提醒</p>\n          </div>\n        `,dangerouslyUseHTMLString:!0,showCancelButton:!0,confirmButtonText:"我知道了",cancelButtonText:"提醒选项",distinguishCancelAndClose:!0,type:"warning"});this.updateLastNotificationTime(s)}catch(a){"cancel"===a&&await this.showNotificationPreferences(s)}}async showNotificationPreferences(e){try{await G({title:"通知偏好设置",message:'\n          <div style="margin-bottom: 15px;">\n            <p style="margin-bottom: 12px;">选择API健康检查失败通知的提醒频率:</p>\n          </div>\n        ',dangerouslyUseHTMLString:!0,showCancelButton:!0,confirmButtonText:"今天不再提醒",cancelButtonText:"一个月不再提醒",distinguishCancelAndClose:!0,type:"info"});this.setSuppression(e,"today"),V.success("已设置今天不再提醒API健康检查失败")}catch(t){"cancel"===t&&(this.setSuppression(e,"month"),V.success("已设置一个月内不再提醒API健康检查失败"))}}setSuppression(e,t){const s=Date.now();let a;if("today"===t){const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),a=e.getTime()}else a=s+2592e6;const r={userId:e,suppressUntil:a,suppressType:t,lastNotificationTime:s};this.preferences.value.set(e,r),this.savePreferences()}resetSuppression(e){const t=this.preferences.value.get(e);t&&(t.suppressUntil=null,t.suppressType="none",this.preferences.value.set(e,t),this.savePreferences())}updateLastNotificationTime(e){const t=this.preferences.value.get(e)||{userId:e,suppressUntil:null,suppressType:"none",lastNotificationTime:null};t.lastNotificationTime=Date.now(),this.preferences.value.set(e,t),this.savePreferences()}loadPreferences(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e),s=new Map;Object.entries(t).forEach(([e,t])=>{s.set(e,t)}),this.preferences.value=s,console.log("[HealthCheckNotification] 偏好设置已加载")}}catch(e){console.error("[HealthCheckNotification] 加载偏好设置失败:",e)}}savePreferences(){try{const e={};this.preferences.value.forEach((t,s)=>{e[s]=t}),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),console.log("[HealthCheckNotification] 偏好设置已保存")}catch(e){console.error("[HealthCheckNotification] 保存偏好设置失败:",e)}}getUserPreference(e){return this.preferences.value.get(e)||null}clearAllPreferences(){this.preferences.value.clear(),localStorage.removeItem(this.STORAGE_KEY),console.log("[HealthCheckNotification] 所有偏好设置已清除")}}const Ka=Ga.getInstance();class Ya{static instance;config=s({mode:"local",autoSync:!1,syncInterval:5,fallbackToLocal:!0,showModeIndicator:!0});status=s({currentMode:"local",apiAvailable:!1,lastSyncTime:null,syncInProgress:!1,errorCount:0,lastError:null});syncTimer=null;healthCheckTimer=null;constructor(){this.loadConfig(),this.initializeMode(),this.startHealthCheck(),this.setupWatchers()}static getInstance(){return Ya.instance||(Ya.instance=new Ya),Ya.instance}getConfig(){return a(()=>this.config.value)}getStatus(){return a(()=>this.status.value)}getCurrentMode(){return this.status.value.currentMode}isApiMode(){return"api"===this.status.value.currentMode}isLocalMode(){return"local"===this.status.value.currentMode}isApiAvailable(){return this.status.value.apiAvailable}async switchMode(e,t=!1){try{if(console.log(`[StorageMode] 尝试切换到 ${e} 模式`),"api"===e){if(!(await this.checkApiHealth()))return V.error("API服务不可用，无法切换到API模式"),!1;if(!nt.isAuthenticated())return V.error("用户未登录，无法切换到API模式"),!1}if(!t){if("confirm"!==await G.confirm(`确定要切换到${"api"===e?"API":"本地"}存储模式吗？`,"切换存储模式",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}))return!1}const s=this.status.value.currentMode;return this.status.value.currentMode=e,this.config.value.mode=e,this.saveConfig(),this.restartSyncTimer(),V.success(`已切换到${"api"===e?"API":"本地"}存储模式`),console.log(`[StorageMode] 模式切换成功: ${s} -> ${e}`),!0}catch(s){return console.error("[StorageMode] 模式切换失败:",s),V.error("模式切换失败"),!1}}async autoSelectMode(){try{return await this.checkApiHealth()&&nt.isAuthenticated()?(console.log("[StorageMode] API可用且已认证，选择API模式"),await this.switchMode("api",!0),"api"):(console.log("[StorageMode] API不可用或未认证，选择本地模式"),await this.switchMode("local",!0),"local")}catch(e){return console.error("[StorageMode] 自动选择模式失败:",e),await this.switchMode("local",!0),"local"}}async checkApiHealth(){try{const e=await Ie.healthCheck();return this.status.value.apiAvailable=e,e&&(this.status.value.errorCount=0,this.status.value.lastError=null),e}catch(e){console.warn("[StorageMode] API健康检查失败:",e),this.status.value.apiAvailable=!1,this.status.value.errorCount++;const t=e instanceof Error?e.message:"未知错误";return this.status.value.lastError=t,await Ka.showHealthCheckFailureNotification(t),!1}}async syncData(e="auto"){if(this.status.value.syncInProgress)return console.warn("[StorageMode] 同步正在进行中，跳过"),!1;try{this.status.value.syncInProgress=!0,console.log(`[StorageMode] 开始数据同步: ${e}`);let t=!1;return"auto"===e?this.isApiMode()&&this.isApiAvailable()?t=await this.syncLocalToApi():this.isLocalMode()&&(t=await this.syncApiToLocal()):"toApi"===e?t=await this.syncLocalToApi():"toLocal"===e&&(t=await this.syncApiToLocal()),t&&(this.status.value.lastSyncTime=Date.now(),V.success("数据同步成功")),t}catch(t){return console.error("[StorageMode] 数据同步失败:",t),V.error("数据同步失败"),!1}finally{this.status.value.syncInProgress=!1}}updateConfig(e){Object.assign(this.config.value,e),this.saveConfig(),this.restartSyncTimer(),console.log("[StorageMode] 配置已更新:",this.config.value)}getModeIndicator(){return a(()=>{const e=this.status.value.currentMode,t=this.status.value.apiAvailable;return{text:"api"===e?"API模式":"本地模式",color:"api"===e?t?"success":"warning":"info",icon:"api"===e?"CloudUpload":"Folder",status:this.status.value.syncInProgress?"同步中...":"api"!==e||t?"正常":"连接异常",showIndicator:this.config.value.showModeIndicator}})}async initializeMode(){try{if("api"===this.config.value.mode){await this.checkApiHealth()&&nt.isAuthenticated()?this.status.value.currentMode="api":(this.status.value.currentMode="local",this.config.value.fallbackToLocal&&console.log("[StorageMode] API不可用，回退到本地模式"))}else this.status.value.currentMode="local";this.restartSyncTimer(),console.log(`[StorageMode] 初始化完成，当前模式: ${this.status.value.currentMode}`)}catch(e){console.error("[StorageMode] 初始化失败:",e),this.status.value.currentMode="local"}}async syncLocalToApi(){return console.log("[StorageMode] 从本地同步到API"),!0}async syncApiToLocal(){return console.log("[StorageMode] 从API同步到本地"),!0}startHealthCheck(){this.healthCheckTimer=window.setInterval(()=>{this.checkApiHealth()},432e5)}restartSyncTimer(){if(this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null),this.config.value.autoSync&&this.config.value.syncInterval>0){const e=60*this.config.value.syncInterval*1e3;this.syncTimer=window.setInterval(()=>{this.syncData("auto")},e),console.log(`[StorageMode] 自动同步定时器已启动，间隔: ${this.config.value.syncInterval}分钟`)}}setupWatchers(){t(this.config,()=>{this.saveConfig()},{deep:!0})}loadConfig(){try{const e=localStorage.getItem("storage_mode_config");if(e){const t=JSON.parse(e);Object.assign(this.config.value,t)}}catch(e){console.error("[StorageMode] 加载配置失败:",e)}}saveConfig(){try{localStorage.setItem("storage_mode_config",JSON.stringify(this.config.value))}catch(e){console.error("[StorageMode] 保存配置失败:",e)}}destroy(){this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null),this.healthCheckTimer&&(clearInterval(this.healthCheckTimer),this.healthCheckTimer=null)}}const Wa=Ya.getInstance();"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{Wa.destroy()});class Qa{static instance;config=s({mode:"local",autoSync:!0,syncInterval:30,apiEndpoint:"/api/v1",lastUpdatedBy:"",lastUpdatedAt:"",version:1});status=r({loading:!1,syncing:!1,lastSyncAt:null,error:null});syncTimer=null;STORAGE_KEY="global_storage_config";SYNC_INTERVAL=6e4;constructor(){this.loadLocalConfig(),this.startPeriodicSync(),this.setupConfigWatcher()}static getInstance(){return Qa.instance||(Qa.instance=new Qa),Qa.instance}isSuperAdmin(){const e=nt.getLocalUserInfo();return"admin"===e?.role||nt.hasRole("super_admin")}loadLocalConfig(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.config.value={...this.config.value,...t},console.log("[GlobalConfig] 本地配置已加载:",this.config.value)}}catch(e){console.error("[GlobalConfig] 加载本地配置失败:",e)}}saveLocalConfig(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.config.value)),console.log("[GlobalConfig] 配置已保存到本地")}catch(e){console.error("[GlobalConfig] 保存本地配置失败:",e)}}async fetchGlobalConfig(){try{if(this.status.loading=!0,this.status.error=null,at())return console.log("[GlobalConfig] Mock API模式 - 使用本地配置"),this.status.lastSyncAt=(new Date).toISOString(),this.config.value;if(!(localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token")))return console.log("[GlobalConfig] 未登录，跳过配置同步"),this.config.value;const e=(await Ie.get("/system/global-config")).storageConfig;return e.version>this.config.value.version&&(this.config.value=e,this.saveLocalConfig(),console.log("[GlobalConfig] 全局配置已从服务器更新:",e),V.success("全局配置已更新")),this.status.lastSyncAt=(new Date).toISOString(),e}catch(e){return console.warn("[GlobalConfig] 获取全局配置失败:",e),this.status.error=e instanceof Error?e.message:"获取配置失败",null}finally{this.status.loading=!1}}async updateGlobalConfig(e){if(!this.isSuperAdmin())return V.error("只有超级管理员可以修改全局配置"),!1;try{this.status.syncing=!0,this.status.error=null;const t=nt.getLocalUserInfo(),s={...this.config.value,...e,lastUpdatedBy:t?.realName||t?.username||"未知用户",lastUpdatedAt:(new Date).toISOString(),version:this.config.value.version+1};return at()?(console.log("[GlobalConfig] Mock API模式 - 仅更新本地配置:",s),this.config.value=s,this.saveLocalConfig(),V.success("全局配置已更新（本地模式）"),!0):(await Ie.put("/system/global-config",{storageConfig:s}),this.config.value=s,this.saveLocalConfig(),console.log("[GlobalConfig] 全局配置已更新:",s),V.success("全局配置已更新并同步"),!0)}catch(t){return console.error("[GlobalConfig] 更新全局配置失败:",t),this.status.error=t instanceof Error?t.message:"更新配置失败",V.error("更新全局配置失败: "+this.status.error),!1}finally{this.status.syncing=!1}}startPeriodicSync(){this.fetchGlobalConfig(),this.syncTimer=window.setInterval(()=>{this.fetchGlobalConfig()},this.SYNC_INTERVAL),console.log("[GlobalConfig] 定期同步已启动")}stopPeriodicSync(){this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null,console.log("[GlobalConfig] 定期同步已停止"))}setupConfigWatcher(){t(()=>this.config.value,e=>{this.saveLocalConfig(),console.log("[GlobalConfig] 配置已更新:",e)},{deep:!0})}async syncConfig(){await this.fetchGlobalConfig()}async resetToDefault(){if(!this.isSuperAdmin())return V.error("只有超级管理员可以重置全局配置"),!1;return await this.updateGlobalConfig({mode:"local",autoSync:!0,syncInterval:30,apiEndpoint:"/api/v1"})}getConfigInfo(){return{lastUpdatedBy:this.config.value.lastUpdatedBy,lastUpdatedAt:this.config.value.lastUpdatedAt,version:this.config.value.version,canModify:this.isSuperAdmin()}}destroy(){this.stopPeriodicSync()}}const Xa=Qa.getInstance();"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{Xa.destroy()});const Za={key:0,class:"storage-mode-switch"},er={class:"mode-text"},tr={class:"mode-status"},sr={key:0,class:"api-unavailable"},ar={key:0},rr={key:0},or={class:"dialog-footer"},nr={class:"sync-progress"},ir={class:"sync-message"},cr=i({__name:"StorageModeSwitch",setup(e){const r=ys(),o=s(!1),n=s(null),i=a(()=>!(!r.isLoggedIn||!r.currentUser)&&(!!o.value&&r.isSuperAdmin));t(()=>[r.isLoggedIn,r.currentUser,r.isSuperAdmin],()=>{n.value&&clearTimeout(n.value),n.value=setTimeout(()=>{r.isLoggedIn&&r.currentUser?(o.value=!0,console.log("[StorageModeSwitch] 用户状态已稳定，isSuperAdmin:",r.isSuperAdmin)):o.value=!1},100)},{immediate:!0});const g=s(!1),y=s(!1),S=s(0),w=s(""),A=s(""),T=s(!1),C=Wa.getConfig(),D=Wa.getStatus(),b=Wa.getModeIndicator(),R=Xa.config;Xa.status;const M=s({mode:"local",autoSync:!1,syncInterval:5,fallbackToLocal:!0,showModeIndicator:!0}),L=async e=>{if(!T.value)try{switch(T.value=!0,e){case"switch-local":await U("local");break;case"switch-api":await U("api");break;case"sync-data":await $();break;case"settings":j()}}catch(t){console.error("操作失败:",t),V.error("操作失败，请稍后重试")}finally{T.value=!1}},U=async e=>{if(r.isSuperAdmin){await Xa.updateGlobalConfig({mode:e})&&(await Wa.switchMode(e),V.success(`已切换到${x(e)}模式并全局同步`))}else await Wa.switchMode(e),V.success(`已切换到${x(e)}模式`)},x=e=>({local:"本地存储",api:"API存储"}[e]||e),$=async()=>{if("local"!==D.value.currentMode){y.value=!0,S.value=0,w.value="",A.value="准备同步数据...";try{if(!(await Wa.checkApiStatus()))throw new Error("API服务不可用");const e=[{progress:20,message:"检查连接状态..."},{progress:40,message:"验证用户权限..."},{progress:60,message:"同步数据中..."},{progress:80,message:"验证数据完整性..."},{progress:100,message:"同步完成"}];for(const t of e)await new Promise(e=>setTimeout(e,500)),S.value=t.progress,A.value=t.message;await Wa.syncData()?(w.value="success",A.value="数据同步成功",V.success("数据同步完成")):(w.value="exception",A.value="数据同步失败",V.error("数据同步失败")),setTimeout(()=>{y.value=!1},1500)}catch(e){console.error("同步失败:",e),w.value="exception",A.value=e instanceof Error?e.message:"同步过程中发生错误",V.error("数据同步失败："+(e instanceof Error?e.message:"未知错误")),setTimeout(()=>{y.value=!1},2e3)}}else V.warning("本地存储模式无法进行数据同步")},j=()=>{Object.assign(M.value,C.value),g.value=!0},F=async()=>{try{if(r.isSuperAdmin){await Xa.updateGlobalConfig({mode:M.value.mode,autoSync:M.value.autoSync,syncInterval:M.value.syncInterval})&&(Wa.updateConfig(M.value),V.success("全局设置保存成功"),g.value=!1)}else Wa.updateConfig(M.value),V.success("本地设置保存成功"),g.value=!1}catch(e){console.error("保存设置失败:",e),V.error("设置保存失败")}};k(async()=>{if(Object.assign(M.value,C.value),r.isLoggedIn&&!r.isSuperAdmin){await Xa.syncConfig();const e=R.value;e.mode!==C.value.mode&&await Wa.switchMode(e.mode)}}),t(()=>R.value,async e=>{r.isSuperAdmin||e.mode===C.value.mode||(console.log("[StorageModeSwitch] 应用全局配置:",e.mode),await Wa.switchMode(e.mode),V.info(`存储模式已更新为：${x(e.mode)}`))},{deep:!0});const H=()=>{const e=D.value.currentMode;let t={local:"本地存储模式：数据保存在浏览器本地，离线可用，但不会同步到其他设备",api:"API存储模式：数据保存在服务器，可在多设备间同步，需要网络连接"}[e]||`${e}模式`;return D.value.apiAvailable||"api"!==e||(t+="（当前API不可用，已自动切换到本地模式）"),t};return N(()=>{n.value&&(clearTimeout(n.value),n.value=null)}),(e,t)=>{const s=c("el-icon"),a=c("el-tooltip"),o=c("el-button"),n=c("el-dropdown-item"),C=c("el-dropdown-menu"),k=c("el-dropdown"),N=c("el-alert"),U=c("el-radio"),$=c("el-radio-group"),V=c("el-form-item"),j=c("el-switch"),B=c("el-input-number"),J=c("el-form"),z=c("el-dialog"),G=c("el-progress");return i.value?(u(),l("div",Za,[P(b).showIndicator?(u(),h(a,{key:0,content:H(),placement:"bottom"},{default:f(()=>[p("div",{class:m(["mode-indicator",`mode-indicator--${P(b).color}`])},[I(s,{class:"mode-icon"},{default:f(()=>[(u(),h(O(P(b).icon)))]),_:1}),p("span",er,v(P(b).text),1),p("span",tr,v(P(b).status),1)],2)]),_:1},8,["content"])):d("",!0),I(k,{trigger:"click",placement:"bottom-end",onCommand:L},{dropdown:f(()=>[I(C,null,{default:f(()=>[I(n,{command:"switch-local",disabled:"local"===P(D).currentMode},{default:f(()=>[I(s,null,{default:f(()=>[I(P(W))]),_:1}),t[10]||(t[10]=_(" 切换到本地模式 ",-1))]),_:1},8,["disabled"]),I(n,{command:"switch-api",disabled:"api"===P(D).currentMode||!P(D).apiAvailable},{default:f(()=>[I(s,null,{default:f(()=>[I(P(Q))]),_:1}),t[11]||(t[11]=_(" 切换到API模式 ",-1)),P(D).apiAvailable?d("",!0):(u(),l("span",sr,"(不可用)"))]),_:1},8,["disabled"]),I(n,{command:"sync-data",disabled:P(D).syncInProgress},{default:f(()=>[I(s,null,{default:f(()=>[I(P(q))]),_:1}),t[12]||(t[12]=_(" 同步数据 ",-1))]),_:1},8,["disabled"]),I(n,{divided:"",command:"settings"},{default:f(()=>[I(s,null,{default:f(()=>[I(P(K))]),_:1}),t[13]||(t[13]=_(" 存储设置 ",-1))]),_:1})]),_:1})]),default:f(()=>[I(o,{type:"primary",loading:T.value||P(D).syncInProgress,size:"small",disabled:T.value},{default:f(()=>[I(s,null,{default:f(()=>[I(P(K))]),_:1}),t[9]||(t[9]=_(" 存储模式 ",-1)),I(s,{class:"el-icon--right"},{default:f(()=>[I(P(Y))]),_:1})]),_:1},8,["loading","disabled"])]),_:1}),I(z,{modelValue:g.value,"onUpdate:modelValue":t[7]||(t[7]=e=>g.value=e),title:"存储模式设置",width:"500px","close-on-click-modal":!1},{footer:f(()=>[p("div",or,[I(o,{onClick:t[6]||(t[6]=e=>g.value=!1)},{default:f(()=>[...t[23]||(t[23]=[_("取消",-1)])]),_:1}),I(o,{type:"primary",onClick:F},{default:f(()=>[...t[24]||(t[24]=[_("保存设置",-1)])]),_:1})])]),default:f(()=>[P(r).isSuperAdmin?(u(),h(N,{key:0,title:"超级管理员模式",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:f(()=>[_(" 您的配置将全局同步到所有用户。当前全局配置版本："+v(P(R).version)+" ",1),t[14]||(t[14]=p("br",null,null,-1)),P(R).lastUpdatedBy?(u(),l("span",ar," 最后更新："+v(P(R).lastUpdatedBy)+" ("+v(new Date(P(R).lastUpdatedAt).toLocaleString())+") ",1)):d("",!0)]),_:1})):(u(),h(N,{key:1,title:"普通用户模式",type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:f(()=>[t[15]||(t[15]=_(" 您的配置将跟随超级管理员的全局设置。 ",-1)),t[16]||(t[16]=p("br",null,null,-1)),_(" 当前全局模式："+v(x(P(R).mode))+" ",1),P(R).lastUpdatedBy?(u(),l("span",rr," (由 "+v(P(R).lastUpdatedBy)+" 配置) ",1)):d("",!0)]),_:1})),I(J,{model:M.value,"label-width":"120px",onSubmit:t[5]||(t[5]=E(()=>{},["prevent"]))},{default:f(()=>[I(V,{label:"默认模式"},{default:f(()=>[I($,{modelValue:M.value.mode,"onUpdate:modelValue":t[0]||(t[0]=e=>M.value.mode=e)},{default:f(()=>[I(U,{value:"local"},{default:f(()=>[...t[17]||(t[17]=[_("本地存储",-1)])]),_:1}),I(U,{value:"api",disabled:!P(D).apiAvailable},{default:f(()=>[...t[18]||(t[18]=[_("API存储",-1)])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),I(V,{label:"自动同步"},{default:f(()=>[I(j,{modelValue:M.value.autoSync,"onUpdate:modelValue":t[1]||(t[1]=e=>M.value.autoSync=e)},null,8,["modelValue"]),t[19]||(t[19]=p("div",{class:"form-help"},"启用后将定期自动同步数据",-1))]),_:1}),M.value.autoSync?(u(),h(V,{key:0,label:"同步间隔"},{default:f(()=>[I(B,{modelValue:M.value.syncInterval,"onUpdate:modelValue":t[2]||(t[2]=e=>M.value.syncInterval=e),min:1,max:60,"controls-position":"right"},null,8,["modelValue"]),t[20]||(t[20]=p("span",{class:"input-suffix"},"分钟",-1))]),_:1})):d("",!0),I(V,{label:"故障回退"},{default:f(()=>[I(j,{modelValue:M.value.fallbackToLocal,"onUpdate:modelValue":t[3]||(t[3]=e=>M.value.fallbackToLocal=e)},null,8,["modelValue"]),t[21]||(t[21]=p("div",{class:"form-help"},"API失败时自动回退到本地存储",-1))]),_:1}),I(V,{label:"显示指示器"},{default:f(()=>[I(j,{modelValue:M.value.showModeIndicator,"onUpdate:modelValue":t[4]||(t[4]=e=>M.value.showModeIndicator=e)},null,8,["modelValue"]),t[22]||(t[22]=p("div",{class:"form-help"},"在界面上显示当前存储模式",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),I(z,{modelValue:y.value,"onUpdate:modelValue":t[8]||(t[8]=e=>y.value=e),title:"数据同步",width:"400px","close-on-click-modal":!1,"show-close":!1},{default:f(()=>[p("div",nr,[I(G,{percentage:S.value,status:w.value,"stroke-width":8},null,8,["percentage","status"]),p("p",ir,v(A.value),1)])]),_:1},8,["modelValue"])])):d("",!0)}}}),lr=Cs(cr,[["__scopeId","data-v-986484a7"]]),dr={xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",fill:"currentColor"},ur=i({__name:"IconHelpCenter",setup:e=>(e,t)=>(u(),l("svg",dr,[...t[0]||(t[0]=[p("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"},null,-1)])]))}),mr={key:0,class:"help-center-container"},pr=i({__name:"HelpCenter",setup(e){const t=S(),s=ys(),r=a(()=>s.isAdmin||s.isSuperAdmin),o=()=>{t.push("/help-center")};return(e,t)=>{const s=c("el-tooltip");return r.value?(u(),l("div",mr,[I(s,{content:"帮助中心",placement:"bottom"},{default:f(()=>[p("div",{class:"help-center-button",onClick:o},[I(ur)])]),_:1})])):d("",!0)}}}),gr=Cs(pr,[["__scopeId","data-v-2fd152c7"]]),hr={getSubscriptions:()=>ut.get("/message/subscriptions"),updateSubscription:(e,t)=>ut.put(`/message/subscriptions/${e}`,t),getDepartmentSubscriptions:e=>ut.get("/message/subscriptions/departments",{params:e?{departmentId:e}:{}}),updateDepartmentSubscription:(e,t,s)=>ut.put(`/message/subscriptions/${e}/departments/${t}`,s),batchUpdateDepartmentSubscriptions:(e,t)=>ut.put(`/message/subscriptions/${e}/departments/batch`,{configs:t}),getAnnouncements:async e=>{try{return await ut.get("/message/announcements",{params:e})}catch(t){if(404===t?.status||502===t?.status||500===t?.status)return console.log("[Message API] 公告功能未启用或后端未实现"),{success:!0,data:{list:[],total:0}};throw t}},createAnnouncement:e=>ut.post("/message/announcements",e),updateAnnouncement:(e,t)=>ut.put(`/message/announcements/${e}`,t),deleteAnnouncement:e=>ut.delete(`/message/announcements/${e}`),publishAnnouncement:e=>ut.post(`/message/announcements/${e}/publish`),getConfigs:()=>ut.get("/message/configs"),updateConfig:(e,t)=>ut.put(`/message/configs/${e}`,t),testConfig:e=>ut.post(`/message/configs/${e}/test`),getSystemMessages:async e=>{try{return await ut.get("/message/system-messages",{params:e})}catch(t){if(404===t?.status||502===t?.status||500===t?.status)return console.log("[Message API] 系统消息功能未启用或后端未实现"),{success:!0,data:{messages:[],total:0}};throw t}},markMessageAsRead:e=>ut.put(`/message/system-messages/${e}/read`),markAllMessagesAsRead:()=>ut.put("/message/system-messages/read-all"),getMessageStats:()=>ut.get("/message/stats")},vr=Object.freeze(Object.defineProperty({__proto__:null,messageApi:hr},Symbol.toStringTag,{value:"Module"})),yr=e("message",()=>{const e=s([]),t=s([]),r=s([]),o=s([]),n=s(!1),i=a(()=>o.value.filter(e=>!e.isRead).length),c=a(()=>t.value.filter(e=>"published"===e.status&&e.isMarquee)),l=a(()=>t.value.filter(e=>"published"===e.status&&e.isPopup));return{subscriptions:e,announcements:t,configs:r,systemMessages:o,loading:n,unreadMessageCount:i,activeAnnouncements:c,popupAnnouncements:l,loadSubscriptions:async()=>{try{n.value=!0;const t=await hr.getSubscriptions();e.value=t.data.map(e=>({...e,isGlobalEnabled:e.isGlobalEnabled??e.isSubscribed??!1,globalNotificationMethods:e.globalNotificationMethods??e.notificationMethods??[],departmentConfigs:e.departmentConfigs??[]}))}catch(t){throw console.error("加载订阅设置失败:",t),t}finally{n.value=!1}},updateSubscription:async(t,s)=>{try{const a=await hr.updateSubscription(t,s),r=e.value.findIndex(e=>e.id===t);return-1!==r&&(e.value[r]={...e.value[r],...s}),a}catch(a){throw console.error("更新订阅设置失败:",a),a}},updateDepartmentSubscription:async(t,s,a)=>{try{const r=await hr.updateDepartmentSubscription(t,s,a),o=e.value.find(e=>e.id===t);if(o){const e=o.departmentConfigs.findIndex(e=>e.departmentId===s);-1!==e&&(o.departmentConfigs[e]={...o.departmentConfigs[e],...a})}return r}catch(r){throw console.error("更新部门订阅设置失败:",r),r}},loadAnnouncements:async e=>{try{n.value=!0;const s=await hr.getAnnouncements(e);return t.value=s.data||[],s}catch(s){console.error("加载公告失败:",s),V.error("加载公告失败"),t.value=[]}finally{n.value=!1}},createAnnouncement:async e=>{try{const s=await hr.createAnnouncement(e);return Array.isArray(t.value)||(t.value=[]),t.value.unshift(s.data),V.success("公告创建成功"),s.data}catch(s){throw console.error("创建公告失败:",s),V.error("创建公告失败"),s}},updateAnnouncement:async(e,s)=>{try{const a=await hr.updateAnnouncement(e,s);Array.isArray(t.value)||(t.value=[]);const r=t.value.findIndex(t=>t.id===e);return-1!==r&&(t.value[r]={...t.value[r],...s}),V.success("公告更新成功"),a.data}catch(a){throw console.error("更新公告失败:",a),V.error("更新公告失败"),a}},deleteAnnouncement:async e=>{try{if(await hr.deleteAnnouncement(e),!Array.isArray(t.value))return void(t.value=[]);const s=t.value.findIndex(t=>t.id===e);-1!==s&&t.value.splice(s,1),V.success("公告删除成功")}catch(s){console.error("删除公告失败:",s),V.error("删除公告失败")}},loadConfigs:async()=>{try{n.value=!0;const e=await hr.getConfigs();r.value=e.data}catch(e){console.error("加载配置失败:",e),V.error("加载配置失败")}finally{n.value=!1}},updateConfig:async(e,t)=>{try{await hr.updateConfig(e,t);const s=r.value.findIndex(t=>t.id===e);-1!==s&&(r.value[s]={...r.value[s],...t}),V.success("配置更新成功")}catch(s){console.error("更新配置失败:",s),V.error("更新配置失败")}},testConfig:async e=>{try{await hr.testConfig(e),V.success("配置测试成功")}catch(t){console.error("配置测试失败:",t),V.error("配置测试失败")}},loadSystemMessages:async e=>{try{const t=await hr.getSystemMessages(e);return o.value=t.data,t}catch(t){console.error("加载系统消息失败:",t),V.error("加载系统消息失败")}},markMessageAsRead:async e=>{try{await hr.markMessageAsRead(e);const t=o.value.find(t=>t.id===e);t&&(t.isRead=!0)}catch(t){console.error("标记消息已读失败:",t)}},markAllMessagesAsRead:async()=>{try{await hr.markAllMessagesAsRead(),o.value.forEach(e=>{e.isRead=!0}),V.success("所有消息已标记为已读")}catch(e){console.error("标记所有消息已读失败:",e),V.error("标记消息已读失败")}},markAnnouncementAsRead:async e=>{try{const s=t.value.find(t=>t.id===e);s&&(s.read=!0),V.success("已标记为已读")}catch(s){console.error("标记公告已读失败:",s),V.error("标记失败")}},messageApi:hr}}),fr={class:"message-bell-container"},_r={class:"message-header"},Sr={class:"header-stats"},wr={class:"header-actions"},Ar={class:"tab-label"},Ir={class:"message-list"},Pr=["onClick"],Er={class:"message-icon"},Tr={class:"message-content"},Cr={class:"message-title"},Dr={class:"message-text"},kr={class:"message-meta"},br={class:"message-category"},Rr={class:"message-time"},Or={class:"message-actions"},Nr={key:0,class:"empty-state"},Mr={class:"tab-label"},Lr={class:"announcement-list"},Ur=["onClick"],xr={class:"announcement-icon"},$r={class:"announcement-content"},Vr={class:"announcement-title"},jr={class:"announcement-text"},Fr={class:"announcement-meta"},qr={class:"announcement-time"},Hr={class:"announcement-author"},Br={class:"announcement-actions"},Jr={key:0,class:"empty-state"},zr=i({__name:"MessageBell",setup(e){const t=Ht(),r=yr(),o=ys(),n=s(!1),i=s("messages"),g=a(()=>t.messages),y=a(()=>r.announcements&&Array.isArray(r.announcements)?r.announcements.filter(e=>"published"===e.status):[]),S=a(()=>t.unreadCount),w=a(()=>y.value.filter(e=>!e.read).length),A=a(()=>S.value+w.value),T=a(()=>g.value.length+y.value.length),C=()=>{n.value=!1},D=async()=>{try{t.markAllAsRead();for(const e of y.value)e.read||await L(e.id);V.success("所有消息已标记为已读")}catch(e){console.error("标记已读失败:",e),V.error("操作失败")}},N=async()=>{try{await G.confirm("确认清空所有消息吗？此操作不可恢复。","确认清空",{type:"warning"}),t.clearAllMessages(),V.success("消息已清空")}catch(e){"cancel"!==e&&console.error("清空消息失败:",e)}},M=e=>{t.markAsRead(e)},L=async e=>{try{const t=y.value.find(t=>t.id===e);t&&(t.read=!0)}catch(t){console.error("标记公告已读失败:",t)}};return k(()=>{o.isLoggedIn&&r.loadAnnouncements()}),(e,s)=>{const a=c("el-icon"),r=c("el-badge"),o=c("el-tag"),k=c("el-button"),U=c("el-empty"),x=c("el-tab-pane"),$=c("el-tabs"),j=c("el-dialog");return u(),l("div",fr,[p("div",{class:"message-bell",onClick:s[0]||(s[0]=e=>n.value=!0)},[I(r,{value:A.value>99?"99+":A.value,hidden:0===A.value},{default:f(()=>[I(a,{size:20,class:"bell-icon"},{default:f(()=>[I(P(X))]),_:1})]),_:1},8,["value","hidden"])]),I(j,{modelValue:n.value,"onUpdate:modelValue":s[2]||(s[2]=e=>n.value=e),title:"消息中心",width:"700px","before-close":C,class:"message-dialog"},{default:f(()=>[p("div",_r,[p("div",Sr,[I(o,{type:"info",size:"small"},{default:f(()=>[_(" 共 "+v(T.value)+" 条 ",1)]),_:1}),A.value>0?(u(),h(o,{key:0,type:"danger",size:"small"},{default:f(()=>[_(v(A.value)+" 条未读 ",1)]),_:1})):d("",!0)]),p("div",wr,[A.value>0?(u(),h(k,{key:0,type:"primary",size:"small",onClick:D},{default:f(()=>[...s[3]||(s[3]=[_(" 全部已读 ",-1)])]),_:1})):d("",!0),I(k,{type:"danger",size:"small",onClick:N},{default:f(()=>[...s[4]||(s[4]=[_(" 清空消息 ",-1)])]),_:1})])]),I($,{modelValue:i.value,"onUpdate:modelValue":s[1]||(s[1]=e=>i.value=e),class:"message-tabs"},{default:f(()=>[I(x,{label:"系统消息",name:"messages"},{label:f(()=>[p("div",Ar,[I(a,null,{default:f(()=>[I(P(Z))]),_:1}),s[5]||(s[5]=p("span",null,"系统消息",-1)),S.value>0?(u(),h(r,{key:0,value:S.value>99?"99+":S.value,class:"tab-badge"},null,8,["value"])):d("",!0)])]),default:f(()=>[p("div",Ir,[(u(!0),l(b,null,R(g.value,e=>(u(),l("div",{key:e.id,class:m(["message-item",{unread:!e.read}]),onClick:t=>(e=>{e.read||M(e.id),e.actionUrl&&console.log("跳转到:",e.actionUrl)})(e)},[p("div",Er,[I(a,{color:e.color,size:20},{default:f(()=>[(u(),h(O(e.icon)))]),_:2},1032,["color"])]),p("div",Tr,[p("div",Cr,[_(v(e.title)+" ",1),e.read?d("",!0):(u(),h(o,{key:0,type:"danger",size:"small"},{default:f(()=>[...s[6]||(s[6]=[_("未读",-1)])]),_:1}))]),p("div",Dr,v(e.content),1),p("div",kr,[p("span",br,v(e.category),1),p("span",Rr,v(e.time),1)])]),p("div",Or,[e.read?d("",!0):(u(),h(k,{key:0,type:"primary",size:"small",onClick:E(t=>M(e.id),["stop"])},{default:f(()=>[...s[7]||(s[7]=[_(" 已读 ",-1)])]),_:1},8,["onClick"])),I(k,{type:"danger",size:"small",onClick:E(s=>(async e=>{try{await G.confirm("确认删除此消息吗？","确认删除",{type:"warning"}),t.deleteMessage(e),V.success("消息已删除")}catch(s){"cancel"!==s&&console.error("删除消息失败:",s)}})(e.id),["stop"])},{default:f(()=>[...s[8]||(s[8]=[_(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,Pr))),128)),0===g.value.length?(u(),l("div",Nr,[I(U,{description:"暂无系统消息"})])):d("",!0)])]),_:1}),I(x,{label:"系统公告",name:"announcements"},{label:f(()=>[p("div",Mr,[I(a,null,{default:f(()=>[I(P(ee))]),_:1}),s[9]||(s[9]=p("span",null,"系统公告",-1)),w.value>0?(u(),h(r,{key:0,value:w.value>99?"99+":w.value,class:"tab-badge"},null,8,["value"])):d("",!0)])]),default:f(()=>[p("div",Lr,[(u(!0),l(b,null,R(y.value,e=>(u(),l("div",{key:e.id,class:m(["announcement-item",{unread:!e.read}]),onClick:t=>(e=>{e.read||L(e.id),G.alert(e.content,e.title,{confirmButtonText:"确定",type:"info"})})(e)},[p("div",xr,[I(a,{color:"#409eff",size:20},{default:f(()=>[I(P(ee))]),_:1})]),p("div",$r,[p("div",Vr,[_(v(e.title)+" ",1),e.read?d("",!0):(u(),h(o,{key:0,type:"danger",size:"small"},{default:f(()=>[...s[10]||(s[10]=[_("未读",-1)])]),_:1})),I(o,{type:"company"===e.type?"primary":"success",size:"small"},{default:f(()=>[_(v("company"===e.type?"全公司":"部门"),1)]),_:2},1032,["type"])]),p("div",jr,v(e.content),1),p("div",Fr,[p("span",qr,v(e.publishedAt),1),p("span",Hr,v(e.createdBy),1)])]),p("div",Br,[e.read?d("",!0):(u(),h(k,{key:0,type:"primary",size:"small",onClick:E(t=>L(e.id),["stop"])},{default:f(()=>[...s[11]||(s[11]=[_(" 已读 ",-1)])]),_:1},8,["onClick"]))])],10,Ur))),128)),0===y.value.length?(u(),l("div",Jr,[I(U,{description:"暂无系统公告"})])):d("",!0)])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}}),Gr=Cs(zr,[["__scopeId","data-v-599f1f5a"]]),Kr={key:0,class:"announcement-carousel"},Yr={class:"carousel-container"},Wr={class:"announcement-icon"},Qr={class:"carousel-content"},Xr=["onClick"],Zr={class:"announcement-title"},eo={class:"announcement-time"},to={class:"carousel-actions"},so={key:0,class:"announcement-detail"},ao={class:"detail-meta"},ro={class:"publish-time"},oo=["innerHTML"],no={key:0,class:"target-departments"},io=i({__name:"AnnouncementCarousel",setup(e){const t=yr(),r=ys(),o=s(),n=s(!1),i=s(!1),m=s(null),g=s(new Set),y=a(()=>t.announcements&&Array.isArray(t.announcements)?t.announcements.filter(e=>"published"===e.status&&e.isMarquee&&!g.value.has(e.id)&&S(e)).sort((e,t)=>new Date(t.publishedAt||t.publishTime).getTime()-new Date(e.publishedAt||e.publishTime).getTime()).slice(0,5):[]),S=e=>{const t=new Date,s=new Date(e.publishedAt||e.publishTime);if("scheduled"===e.status&&e.scheduledAt){if(new Date(e.scheduledAt)>t)return!1}return t<=new Date(s.getTime()+2592e6)},w=()=>{o.value&&(n.value?o.value.play():o.value.pause(),n.value=!n.value)},A=()=>{y.value.forEach(e=>{g.value.add(e.id)}),localStorage.setItem("closedAnnouncementIds",JSON.stringify([...g.value]))},E=async()=>{if(m.value)try{await t.markAnnouncementAsRead(m.value.id),V.success("已标记为已读"),i.value=!1}catch(e){V.error("标记失败，请重试")}},T=e=>{const t=new Date(e),s=(new Date).getTime()-t.getTime();return s<6e4?"刚刚":s<36e5?`${Math.floor(s/6e4)}分钟前`:s<864e5?`${Math.floor(s/36e5)}小时前`:t.toLocaleDateString()},C=e=>({company:"全公司",department:"部门",system:"系统"}[e]||"未知");return k(()=>{const e=localStorage.getItem("closedAnnouncementIds");if(e)try{const t=JSON.parse(e);g.value=new Set(t)}catch(s){console.warn("Failed to parse closed announcement IDs:",s)}r.isLoggedIn&&t.loadAnnouncements()}),N(()=>{localStorage.setItem("closedAnnouncementIds",JSON.stringify([...g.value]))}),(e,t)=>{const s=c("el-icon"),a=c("el-carousel-item"),r=c("el-carousel"),g=c("el-button"),S=c("el-tag"),D=c("el-dialog");return y.value.length>0?(u(),l("div",Kr,[p("div",Yr,[p("div",Wr,[I(s,{size:16,color:"#f56c6c"},{default:f(()=>[I(P(X))]),_:1})]),p("div",Qr,[I(r,{ref_key:"carouselRef",ref:o,height:"32px",autoplay:!0,interval:5e3,loop:!0,"show-indicators":!1,arrow:y.value.length>1?"hover":"never",direction:"vertical",class:"announcement-slider"},{default:f(()=>[(u(!0),l(b,null,R(y.value,e=>(u(),h(a,{key:e.id,class:"carousel-item"},{default:f(()=>[p("div",{class:"announcement-item",onClick:t=>(e=>{m.value=e,i.value=!0})(e)},[p("span",Zr,v(e.title),1),p("span",eo,v(T(e.publishedAt||e.publishTime)),1)],8,Xr)]),_:2},1024))),128))]),_:1},8,["arrow"])]),p("div",to,[y.value.length>1?(u(),h(g,{key:0,type:"text",size:"small",onClick:w,class:"pause-btn"},{default:f(()=>[I(s,{size:12},{default:f(()=>[(u(),h(O(n.value?"VideoPlay":"VideoPause")))]),_:1})]),_:1})):d("",!0),I(g,{type:"text",size:"small",onClick:A,class:"close-btn"},{default:f(()=>[I(s,{size:12},{default:f(()=>[I(P(te))]),_:1})]),_:1})])]),I(D,{modelValue:i.value,"onUpdate:modelValue":t[1]||(t[1]=e=>i.value=e),title:m.value?.title,width:"600px",class:"announcement-dialog"},{footer:f(()=>[I(g,{onClick:t[0]||(t[0]=e=>i.value=!1)},{default:f(()=>[...t[3]||(t[3]=[_("关闭",-1)])]),_:1}),m.value&&!m.value.read?(u(),h(g,{key:0,type:"primary",onClick:E},{default:f(()=>[...t[4]||(t[4]=[_(" 标记已读 ",-1)])]),_:1})):d("",!0)]),default:f(()=>{return[m.value?(u(),l("div",so,[p("div",ao,[I(S,{type:(s=m.value.type,{company:"danger",department:"warning",system:"info"}[s]||"info")},{default:f(()=>[_(v(C(m.value.type)),1)]),_:1},8,["type"]),p("span",ro," 发布时间："+v((e=m.value.publishedAt||m.value.publishTime,new Date(e).toLocaleString())),1)]),p("div",{class:"detail-content",innerHTML:m.value.content},null,8,oo),m.value.targetDepartments?.length?(u(),l("div",no,[t[2]||(t[2]=p("span",{class:"label"},"目标部门：",-1)),(u(!0),l(b,null,R(m.value.targetDepartments,e=>(u(),h(S,{key:e,size:"small",class:"dept-tag"},{default:f(()=>[_(v(e),1)]),_:2},1024))),128))])):d("",!0)])):d("",!0)];var e,s}),_:1},8,["modelValue","title"])])):d("",!0)}}}),co=Cs(io,[["__scopeId","data-v-b05febc7"]]),lo=480,uo=768,mo=992,po=1200,go=1920,ho=e=>e<uo?"mobile":e<po?"tablet":"desktop",vo=e=>e<lo?"xs":e<uo?"sm":e<mo?"md":e<po?"lg":"xl",yo=()=>{const e=s(window.innerWidth),t=s(window.innerHeight),a=s(ho(e.value)),r=s(vo(e.value)),o=s("mobile"===a.value),n=s("tablet"===a.value),i=s("desktop"===a.value),c=()=>{e.value=window.innerWidth,t.value=window.innerHeight,a.value=ho(e.value),r.value=vo(e.value),o.value="mobile"===a.value,n.value="tablet"===a.value,i.value="desktop"===a.value};return k(()=>{window.addEventListener("resize",c),c()}),N(()=>{window.removeEventListener("resize",c)}),{windowWidth:e,windowHeight:t,deviceType:a,screenSize:r,isMobile:o,isTablet:n,isDesktop:i,isXs:()=>"xs"===r.value,isSm:()=>"sm"===r.value,isMd:()=>"md"===r.value,isLg:()=>"lg"===r.value,isXl:()=>"xl"===r.value,gtXs:()=>e.value>lo,gtSm:()=>e.value>uo,gtMd:()=>e.value>mo,gtLg:()=>e.value>po,ltSm:()=>e.value<uo,ltMd:()=>e.value<mo,ltLg:()=>e.value<po,ltXl:()=>e.value<go}},fo=(e,t)=>{let s=null;return(...a)=>{s&&clearTimeout(s),s=setTimeout(()=>{e(...a)},t)}};const _o=new class{timerId=null;reminderCount=0;lastReminderDate="";config={enabled:!0,minInterval:72e5,maxInterval:216e5,maxRemindersPerDay:3};onReminderCallback=null;startReminder(e,t){this.config.enabled&&e&&(this.onReminderCallback=t,this.resetDailyCountIfNeeded(),this.reminderCount>=this.config.maxRemindersPerDay||this.scheduleNextReminder(e))}stopReminder(){this.timerId&&(clearTimeout(this.timerId),this.timerId=null),this.onReminderCallback=null}scheduleNextReminder(e){if(!xs.needsPasswordReminder(e))return;const t=Math.floor(Math.random()*(this.config.maxInterval-this.config.minInterval)+this.config.minInterval);this.timerId=window.setTimeout(()=>{this.handleReminder(e)},t),console.log(`下次密码提醒将在 ${Math.round(t/1e3/60)} 分钟后触发`)}handleReminder(e){if(this.resetDailyCountIfNeeded(),this.reminderCount>=this.config.maxRemindersPerDay)return void console.log("今日密码提醒次数已达上限");if(!xs.needsPasswordReminder(e))return;const t=`password_reminder_${e.id}_${(new Date).toDateString()}`;"true"===localStorage.getItem(t)||this.onReminderCallback&&(this.onReminderCallback(),this.reminderCount++,this.saveReminderState()),this.scheduleNextReminder(e)}resetDailyCountIfNeeded(){const e=(new Date).toDateString();this.lastReminderDate!==e&&(this.reminderCount=0,this.lastReminderDate=e,this.saveReminderState())}saveReminderState(){const e={reminderCount:this.reminderCount,lastReminderDate:this.lastReminderDate};localStorage.setItem("passwordReminderState",JSON.stringify(e))}loadReminderState(){try{const e=localStorage.getItem("passwordReminderState");if(e){const t=JSON.parse(e);this.reminderCount=t.reminderCount||0,this.lastReminderDate=t.lastReminderDate||""}}catch(e){console.error("加载密码提醒状态失败:",e)}}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}getTodayReminderCount(){return this.resetDailyCountIfNeeded(),this.reminderCount}init(){this.loadReminderState(),this.resetDailyCountIfNeeded()}},So=[{id:"dashboard",title:"数据看板",icon:"Odometer",path:"/dashboard",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["dashboard"],dataScope:"department"},{id:"customer",title:"客户管理",icon:"User",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer"],children:[{id:"customer-list",title:"客户列表",path:"/customer/list",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer:list"],dataScope:"self"},{id:"customer-add",title:"新增客户",path:"/customer/add",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["customer:add"]},{id:"customer-groups",title:"客户分组",path:"/customer/groups",roles:["super_admin","admin","sales_staff"],permissions:["customer:groups"]},{id:"customer-tags",title:"客户标签",path:"/customer/tags",roles:["super_admin","admin","sales_staff"],permissions:["customer:tags"]}]},{id:"order",title:"订单管理",icon:"ShoppingCart",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["order"],children:[{id:"order-list",title:"订单列表",path:"/order/list",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["order:list"],dataScope:"all"},{id:"order-add",title:"新增订单",path:"/order/add",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["order:add"]},{id:"order-audit",title:"订单审核",path:"/order/audit",roles:["super_admin","admin","customer_service"],permissions:["order:audit"],dataScope:"all"}]},{id:"service-management",title:"服务管理",icon:"IconCustomerService",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["service"],children:[{id:"service-call",title:"通话管理",path:"/service-management/call",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["service:call"],dataScope:"self"},{id:"service-sms",title:"短信管理",path:"/service-management/sms",roles:["super_admin","admin","sales_staff","customer_service"],permissions:["service:sms"],dataScope:"self"}]},{id:"performance",title:"业绩统计",icon:"TrendCharts",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance"],children:[{id:"performance-personal",title:"个人业绩",path:"/performance/personal",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance:personal"],dataScope:"self"},{id:"performance-team",title:"团队业绩",path:"/performance/team",roles:["super_admin","admin","department_manager","sales_staff"],permissions:["performance:team"],dataScope:"department"},{id:"performance-analysis",title:"业绩分析",path:"/performance/analysis",roles:["super_admin","admin","department_manager"],permissions:["performance:analysis"],dataScope:"self"},{id:"performance-share",title:"业绩分享",path:"/performance/share",roles:["super_admin","admin","department_manager"],permissions:["performance:share"]}]},{id:"logistics",title:"物流管理",icon:"Van",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["logistics"],children:[{id:"logistics-shipping",title:"发货列表",path:"/logistics/shipping",roles:["super_admin","admin","sales_staff","customer_service"],permissions:["logistics:shipping"],dataScope:"all"},{id:"logistics-list",title:"物流列表",path:"/logistics/list",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["logistics:list"],dataScope:"all"},{id:"logistics-track",title:"物流跟踪",path:"/logistics/track",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["logistics:tracking"],dataScope:"all"},{id:"logistics-status-update",title:"状态更新",path:"/logistics/status-update",roles:["super_admin","admin","sales_staff","customer_service"],permissions:["logistics:status"],dataScope:"all"},{id:"logistics-companies",title:"物流公司",path:"/logistics/companies",roles:["super_admin","admin"],permissions:["logistics:companies"]}]},{id:"service",title:"售后管理",icon:"IconHeadset",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["aftersale"],children:[{id:"service-list",title:"售后订单",path:"/service/list",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["aftersale:order"],dataScope:"all"},{id:"service-add",title:"新建售后",path:"/service/add",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["aftersale:add"]},{id:"service-data",title:"售后数据",path:"/service/data",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["aftersale:analysis"],dataScope:"all"}]},{id:"data",title:"资料管理",icon:"Files",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["data"],children:[{id:"data-list",title:"资料列表",path:"/data/list",roles:["super_admin","admin","department_manager","customer_service"],permissions:["data:list"],dataScope:"all"},{id:"data-search",title:"客户查询",path:"/data/search",roles:["super_admin","admin","department_manager","sales_staff","customer_service"],permissions:["data:customer"],dataScope:"all"},{id:"data-recycle",title:"回收站",path:"/data/recycle",roles:["super_admin","admin","sales_staff"],permissions:["data:recycle"]}]},{id:"product",title:"商品管理",icon:"Box",roles:["super_admin","admin"],permissions:["sales:product"],children:[{id:"product-list",title:"商品列表",path:"/product/list",roles:["super_admin","admin"],permissions:["sales:product:view"]},{id:"product-add",title:"新增商品",path:"/product/add",roles:["super_admin","admin"],permissions:["sales:product:add"]},{id:"product-inventory",title:"库存管理",path:"/product/inventory",roles:["super_admin","admin"],permissions:["sales:product:edit"]},{id:"product-category",title:"商品分类",path:"/product/category",roles:["super_admin","admin"],permissions:["sales:product:view"]},{id:"product-analytics",title:"商品分析",path:"/product/analytics",roles:["super_admin","admin"],permissions:["product:analytics"]}]},{id:"system",title:"系统管理",icon:"Setting",roles:["super_admin","admin"],permissions:["system"],children:[{id:"system-departments",title:"部门管理",path:"/system/departments",roles:["super_admin","admin"],permissions:["system:department"]},{id:"system-users",title:"用户管理",path:"/system/users",roles:["super_admin","admin"],permissions:["system:user"]},{id:"system-roles",title:"角色权限",path:"/system/roles",roles:["super_admin","admin"],permissions:["system:role"]},{id:"system-permissions",title:"权限管理",path:"/system/permissions",roles:["super_admin","admin"],permissions:["system:permission"]},{id:"system-super-admin-panel",title:"超管面板",path:"/system/super-admin-panel",roles:["super_admin"],permissions:["system:admin"]},{id:"system-customer-service-permissions",title:"客服管理",path:"/system/customer-service-permissions",roles:["super_admin","admin"],permissions:["customer_service:manage"]},{id:"system-message-management",title:"消息管理",path:"/system/message-management",roles:["super_admin","admin"],permissions:["system:message"]},{id:"system-settings",title:"系统设置",path:"/system/settings",roles:["super_admin","admin"],permissions:["system:settings"]}]}];function wo(e,t,s){if(console.log(`[hasMenuPermission] 检查菜单权限: ${e.title}`),e.hidden)return console.log(`[hasMenuPermission] 菜单项被隐藏: ${e.title}`),!1;if("super_admin"===t||s.includes("*"))return console.log(`[hasMenuPermission] 超级管理员权限，允许访问: ${e.title}`),!0;if(e.roles&&e.roles.length>0){if(console.log("[hasMenuPermission] 检查角色权限 - 要求角色:",e.roles,"用户角色:",t),!e.roles.includes(t))return console.log(`[hasMenuPermission] 角色权限不匹配: ${e.title}`),!1;console.log(`[hasMenuPermission] 角色权限匹配: ${e.title}`)}if(e.permissions&&e.permissions.length>0){if(console.log("[hasMenuPermission] 检查具体权限 - 要求权限:",e.permissions,"用户权限:",s),e.requireAll){const t=e.permissions.every(e=>s.includes(e));return console.log(`[hasMenuPermission] 需要所有权限，检查结果: ${t}`),t}{const t=e.permissions.some(e=>s.includes(e));return console.log(`[hasMenuPermission] 需要任一权限，检查结果: ${t}`),t}}return console.log(`[hasMenuPermission] 无特殊权限要求，允许访问: ${e.title}`),!0}function Ao(e,t,s){console.log("[filterMenuItems] 开始过滤菜单项"),console.log("[filterMenuItems] 输入菜单项数量:",e.length),console.log("[filterMenuItems] 用户角色:",t),console.log("[filterMenuItems] 用户权限:",s);const a=[];for(const r of e){console.log(`[filterMenuItems] 检查菜单项: ${r.title} (${r.id})`),console.log("[filterMenuItems] 菜单项角色要求:",r.roles),console.log("[filterMenuItems] 菜单项权限要求:",r.permissions);const e=wo(r,t,s);if(console.log(`[filterMenuItems] 权限检查结果: ${e}`),e){const e={...r};if(r.children&&r.children.length>0){console.log(`[filterMenuItems] 菜单项 ${r.title} 有子菜单，递归过滤`);const o=Ao(r.children,t,s);console.log(`[filterMenuItems] 子菜单过滤结果数量: ${o.length}`),o.length>0?(e.children=o,a.push(e),console.log(`[filterMenuItems] 添加父菜单: ${r.title}`)):console.log(`[filterMenuItems] 子菜单为空，不添加父菜单: ${r.title}`)}else a.push(e),console.log(`[filterMenuItems] 添加菜单项: ${r.title}`)}else console.log(`[filterMenuItems] 跳过菜单项: ${r.title}`)}return console.log("[filterMenuItems] 过滤完成，结果数量:",a.length),a}function Io(e){const t=ys();if(console.log("[getUserAccessibleMenus] 开始获取用户可访问菜单"),console.log("[getUserAccessibleMenus] userStore.currentUser:",t.currentUser),console.log("[getUserAccessibleMenus] userStore.permissions:",t.permissions),!t.currentUser)return console.log("[getUserAccessibleMenus] 用户未登录，返回空菜单"),[];const s=t.currentUser.role,a=t.permissions;if(console.log("[getUserAccessibleMenus] 用户角色:",s),console.log("[getUserAccessibleMenus] 用户权限列表:",a),"super_admin"===s||"admin"===s||a.includes("*"))return console.log("[getUserAccessibleMenus] 超级管理员或管理员，返回所有菜单"),e;console.log("[getUserAccessibleMenus] 普通用户，开始过滤菜单");const r=Ao(e,s,a);return console.log("[getUserAccessibleMenus] 过滤后的菜单:",r),r}const Po=i({__name:"DynamicMenu",props:{collapse:{type:Boolean,default:!1},uniqueOpened:{type:Boolean,default:!0},router:{type:Boolean,default:!0}},emits:["select","open"],setup(e,{emit:r}){const o={Odometer:ie,User:B,ShoppingCart:ne,TrendCharts:oe,Van:re,Files:ae,Box:se,Setting:K,IconCustomerService:B,IconHeadset:B},n=r,i=M(),m=ys(),g=s(0),y=a(()=>i.path);t(()=>m.permissions,(e,t)=>{console.log("[DynamicMenu] 权限变化检测:",{"旧权限数量":t?.length||0,"新权限数量":e?.length||0,"新权限":e}),(!t||0===t.length)&&e&&e.length>0&&(g.value++,console.log("[DynamicMenu] 🔄 权限已加载，强制刷新菜单 (key:",g.value,")"))},{deep:!0,immediate:!0});const S=a(()=>{const e=g.value;console.log("[DynamicMenu] 开始计算可访问菜单 (刷新键:",e,")"),console.log("[DynamicMenu] 当前用户:",m.currentUser),console.log("[DynamicMenu] 用户权限:",m.permissions),console.log("[DynamicMenu] 菜单配置:",So);const t=Io(So);return console.log("[DynamicMenu] 过滤后的菜单:",t),t}),w=e=>"string"==typeof e?o[e]||B:e,A=e=>{n("select",e)},I=e=>{n("open",e)};return(t,s)=>{const a=c("el-icon"),r=c("el-menu-item"),o=c("el-sub-menu"),n=c("el-menu");return u(),h(n,{"default-active":y.value,class:"sidebar-menu",collapse:e.collapse,"unique-opened":e.uniqueOpened,router:e.router,onSelect:A,onOpen:I},{default:f(()=>[(u(!0),l(b,null,R(S.value,e=>(u(),l(b,{key:e.id},[e.children&&(e.children?.length||0)>0?(u(),h(o,{key:0,index:e.id},{title:f(()=>[e.icon?(u(),h(a,{key:0},{default:f(()=>[(u(),h(O(w(e.icon))))]),_:2},1024)):d("",!0),p("span",null,v(e.title),1)]),default:f(()=>[(u(!0),l(b,null,R(e.children,e=>(u(),l(b,{key:e.id},[e.path?(u(),h(r,{key:0,index:e.path},{default:f(()=>[_(v(e.title),1)]),_:2},1032,["index"])):d("",!0)],64))),128))]),_:2},1032,["index"])):e.path?(u(),h(r,{key:1,index:e.path},{title:f(()=>[_(v(e.title),1)]),default:f(()=>[e.icon?(u(),h(a,{key:0},{default:f(()=>[(u(),h(O(w(e.icon))))]),_:2},1024)):d("",!0)]),_:2},1032,["index"])):d("",!0)],64))),128))]),_:1},8,["default-active","collapse","unique-opened","router"])}}}),Eo=Cs(Po,[["__scopeId","data-v-0f20cb6d"]]),To={class:"app-container"},Co={key:0,class:"login-layout"},Do={class:"header-left"},ko={class:"logo"},bo={class:"header-right"},Ro={class:"user-info"},Oo={class:"tabs-container"},No={class:"tabs-actions"},Mo={class:"page-content"},Lo={class:"page-view-wrapper"},Uo={class:"app-footer"},xo={class:"footer-content"},$o={key:0,class:"separator"},Vo=["href"],jo={class:"contact-dialog-content"},Fo=["href"],qo=["href"],Ho=["href"],Bo={key:0,class:"qr-codes-section"},Jo={class:"qr-code-center"},zo={class:"qr-code-item"},Go=["src"],Ko=i({__name:"App",setup(e){const r=M(),o=S(),n=ys(),i=_s(),g=Bt(),y=Ss(),w=Ht(),A=xt(),E=Gt(o),T=s(!1),{isMobile:C}=yo(),D=s(!1),x=s(!1),$=s(!1),j=s(!1),F=s(!1),q=s(0),H=s(""),J=s(!1),z=s(!1),K=()=>{z.value=!0},W=a(()=>"/login"===r.path||!n.token),Q=a(()=>C.value?T.value?"0px":"240px":T.value?"64px":"260px"),X=a(()=>r.path),Z=a({get:()=>i.activeTab,set:e=>i.setActiveTab(e)}),ee=a(()=>i.tabs),te=a(()=>i.cachedViews),se=()=>{T.value=!T.value},ae=e=>{const t=Z.value;i.removeTab(e),t===e&&Z.value!==e&&E.push(Z.value)},re=fo(e=>{E.push(e.props.name)},300),ne=e=>{switch(e){case"profile":ie();break;case"password":le();break;case"logout":de()}},ie=()=>{J.value=!0},le=()=>{D.value=!0},de=async()=>{try{await G.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),n.logout(),i.clearTabs(),V.success("退出登录成功"),E.push("/login")}catch{}},ue=e=>{switch(e){case"closeOthers":i.closeOtherTabs(Z.value);break;case"closeAll":i.closeAllTabs(),E.push("/dashboard")}},me=fo(e=>{if(console.log("菜单选择:",e),console.log("当前路径:",r.path),console.log("用户权限:",n.isAdmin,n.isManager),(e.startsWith("/system/")||"system"===e)&&he(),e&&e.startsWith("/")){if(e.startsWith("/system/")){if("/system/super-admin-panel"===e&&!n.isSuperAdmin)return void V.warning("您没有超级管理员权限，无法访问此页面");if("/system/super-admin-panel"!==e&&!n.isAdmin)return void V.warning("您没有权限访问此页面，请联系管理员")}E.push(e).catch(()=>{})}},300),pe=e=>{console.log("子菜单展开:",e),ge(e)},ge=e=>{console.log("开始智能滚动定位:",e),U(()=>{const t=document.querySelector(".sidebar-menu"),s=document.querySelector(`.sidebar-menu .el-sub-menu[index="${e}"]`);if(!t||!s)return void console.log("未找到菜单元素:",{sidebarMenu:!!t,targetSubMenu:!!s});const a=(e=0)=>{setTimeout(()=>{const r=t.clientHeight,o=t.scrollTop,n=s.offsetTop,i=s.offsetHeight,c=t.scrollHeight-r;if(console.log("滚动计算参数:",{attempt:e,menuHeight:r,menuScrollTop:o,targetMenuTop:n,targetMenuHeight:i,maxScrollTop:c,scrollHeight:t.scrollHeight}),i<50&&e<5)return console.log("子菜单可能还在展开中，继续等待..."),void a(e+1);const l=n-o,d=l+i;console.log("视口位置:",{menuTopInViewport:l,menuBottomInViewport:d,viewportHeight:r});let u=o,m=!1;l<10?(u=n-10,m=!0,console.log("需要向上滚动")):d>r-20&&(u=n+i-r+20,m=!0,console.log("需要向下滚动")),u=Math.max(0,Math.min(u,c)),console.log("滚动决策:",{needScroll:m,currentScrollTop:o,targetScrollTop:u,scrollDiff:Math.abs(u-o)}),m&&Math.abs(u-o)>2?(console.log("执行滚动到:",u),t.scrollTo({top:u,behavior:"smooth"})):console.log("无需滚动或滚动距离太小")},0===e?100:200)};a()})},he=()=>{ge("system")},ve=e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget,s=t.scrollTop,a=t.scrollHeight-t.clientHeight;console.log("鼠标滚轮事件:",{deltaY:e.deltaY,currentScrollTop:s,maxScrollTop:a,scrollHeight:t.scrollHeight,clientHeight:t.clientHeight});const r=e.deltaY>0?s+80:s-80,o=Math.max(0,Math.min(r,a));console.log("滚动到:",o),t.scrollTo({top:o,behavior:"smooth"})},ye=e=>{e.preventDefault()},fe=()=>{const e=n.user;if(e&&!n.isSuperAdmin){if(xs.initializeUserPasswordInfo(e.id),j.value=e.isDefaultPassword||!1,F.value=xs.isPasswordExpired(e),$.value=e.forcePasswordChange||!1,q.value=xs.getPasswordRemainingDays(e),H.value=`password_reminder_${e.id}_${(new Date).toDateString()}`,j.value||F.value||$.value)return D.value=!0,void($.value=!1);if(xs.needsPasswordReminder(e)){"true"===localStorage.getItem(H.value)||(x.value=!0)}}},_e=()=>{V.success("密码修改成功"),D.value=!1,$.value=!1,setTimeout(()=>{fe()},1e3)},Se=()=>{J.value=!1},we=()=>{x.value=!1},Ae=()=>{x.value=!1,D.value=!0},Ie=e=>{e&&localStorage.setItem(H.value,"true"),x.value=!1};t(r,e=>{"/login"!==e.path&&e.meta?.title&&i.addTab({name:e.path,title:e.meta.title,component:e.name})},{immediate:!0});t(()=>n.isLoggedIn,e=>{e&&n.user?(fe(),(()=>{const e=n.user;e&&!n.isSuperAdmin&&_o.startReminder(e,()=>{if(xs.needsPasswordReminder(e)){const t=`password_reminder_${e.id}_${(new Date).toDateString()}`;"true"===localStorage.getItem(t)||(x.value=!0)}})})()):_o.stopReminder()},{immediate:!0}),k(async()=>{C.value&&!T.value&&(T.value=!0),await y.initConfig(),_o.init(),g.initNetworkListener(),w.loadMessagesFromAPI(),Ee(),U(()=>{const e=document.querySelector(".sidebar-menu");e?(console.log("初始化侧边栏滚轮事件"),e.addEventListener("wheel",ve,{passive:!1})):console.log("未找到侧边栏菜单元素")}),setTimeout(()=>{n.user&&!W.value&&fe()},1e3),setTimeout(()=>{console.log("=== 用户权限调试信息 ==="),console.log("当前用户:",n.user),console.log("用户角色:",n.user?.role),console.log("用户UserRole:",n.user?.userRole),console.log("isAdmin:",n.isAdmin),console.log("isSuperAdmin:",n.isSuperAdmin),console.log("isLoggedIn:",n.isLoggedIn),console.log("token:",n.token?"已设置":"未设置"),console.log("========================")},2e3)});let Pe=null;const Ee=()=>{A.checkAndTransferOrders(),Pe=window.setInterval(()=>{A.checkAndTransferOrders()},3e4)};return N(()=>{_o.stopReminder();const e=document.querySelector(".sidebar-menu");e&&e.removeEventListener("wheel",ve),Pe&&(clearInterval(Pe),Pe=null)}),t(C,e=>{e&&!T.value&&(T.value=!0)}),(e,t)=>{const s=c("router-view"),a=c("el-icon"),r=c("el-dropdown-item"),o=c("el-dropdown-menu"),i=c("el-dropdown"),S=c("el-header"),w=c("el-aside"),A=c("el-tab-pane"),E=c("el-tabs"),k=c("More"),N=c("el-button"),M=c("el-main"),U=c("el-container"),V=c("el-descriptions-item"),H=c("el-descriptions"),G=c("el-divider"),ie=c("el-dialog");return u(),l("div",To,[I(Ds,{visible:P(g).globalLoading,text:P(g).globalLoadingText,progress:P(g).globalLoadingProgress,"show-progress":P(g).globalLoadingProgress>=0},null,8,["visible","text","progress","show-progress"]),W.value?(u(),l("div",Co,[I(Ls,null,{default:f(()=>[I(s)]),_:1})])):(u(),h(U,{key:1,class:"layout-container"},{default:f(()=>[I(S,{class:"header"},{default:f(()=>[p("div",Do,[I(a,{class:"menu-toggle",onClick:se},{default:f(()=>[I(P(ce))]),_:1}),p("div",ko,[I(a,null,{default:f(()=>[I(P(oe))]),_:1}),t[5]||(t[5]=p("span",{class:"logo-text"},"智能销售CRM",-1))])]),p("div",bo,[I(lr),I(gr),I(Gr),I(i,{onCommand:ne},{dropdown:f(()=>[I(o,null,{default:f(()=>[I(r,{command:"profile"},{default:f(()=>[...t[6]||(t[6]=[_("个人设置",-1)])]),_:1}),I(r,{command:"password"},{default:f(()=>[...t[7]||(t[7]=[_("修改密码",-1)])]),_:1}),I(r,{divided:"",command:"logout"},{default:f(()=>[...t[8]||(t[8]=[_("退出登录",-1)])]),_:1})]),_:1})]),default:f(()=>[p("span",Ro,[I(a,null,{default:f(()=>[I(P(B))]),_:1}),_(" "+v(P(n).currentUser?.name||"管理员")+" ",1),I(a,null,{default:f(()=>[I(P(Y))]),_:1})])]),_:1})])]),_:1}),I(co),I(U,null,{default:f(()=>[I(w,{width:Q.value,class:m(["sidebar",{"sidebar-mobile":P(C),"sidebar-collapsed":T.value}])},{default:f(()=>[I(Eo,{"default-active":X.value,class:"sidebar-menu",collapse:T.value,"unique-opened":!0,router:"",onSelect:P(me),onOpen:pe},null,8,["default-active","collapse","onSelect"])]),_:1},8,["width","class"]),I(M,{class:"main-content"},{default:f(()=>[p("div",Oo,[I(E,{modelValue:Z.value,"onUpdate:modelValue":t[0]||(t[0]=e=>Z.value=e),type:"card",closable:"",onTabRemove:ae,onTabClick:P(re),onContextmenu:ye,class:"page-tabs"},{default:f(()=>[(u(!0),l(b,null,R(ee.value,e=>(u(),h(A,{key:e.name,label:e.title,name:e.name,closable:"/dashboard"!==e.name},null,8,["label","name","closable"]))),128))]),_:1},8,["modelValue","onTabClick"]),p("div",No,[I(i,{onCommand:ue},{dropdown:f(()=>[I(o,null,{default:f(()=>[I(r,{command:"closeOthers"},{default:f(()=>[...t[9]||(t[9]=[_("关闭其他",-1)])]),_:1}),I(r,{command:"closeAll"},{default:f(()=>[...t[10]||(t[10]=[_("关闭全部",-1)])]),_:1})]),_:1})]),default:f(()=>[I(N,{size:"small",text:""},{default:f(()=>[I(a,null,{default:f(()=>[I(k)]),_:1})]),_:1})]),_:1})])]),p("div",Mo,[p("div",Lo,[I(s,null,{default:f(({Component:e})=>[(u(),h(L,{include:te.value},[(u(),h(O(e)))],1032,["include"]))]),_:1})]),p("footer",Uo,[p("div",xo,[p("span",null,"版权归 "+v(P(y).systemConfig.companyName||"CRM系统")+" 所有",1),t[11]||(t[11]=p("span",{class:"separator"},"|",-1)),p("span",null,"v"+v(P(y).systemConfig.systemVersion||"1.0.0"),1),P(y).systemConfig.websiteUrl?(u(),l("span",$o,"|")):d("",!0),P(y).systemConfig.websiteUrl?(u(),l("a",{key:1,href:P(y).systemConfig.websiteUrl,target:"_blank",class:"footer-link"}," 官网 ",8,Vo)):d("",!0),t[12]||(t[12]=p("span",{class:"separator"},"|",-1)),p("a",{href:"javascript:void(0)",class:"footer-link",onClick:K}," 联系我们 ")])])])]),_:1})]),_:1})]),_:1})),P(C)&&!T.value?(u(),l("div",{key:2,class:"mobile-overlay",onClick:se})):d("",!0),I(aa,{visible:D.value,"is-forced":$.value,"is-default-password":j.value,"is-expired":F.value,onClose:t[1]||(t[1]=e=>D.value=!1),onSuccess:_e},null,8,["visible","is-forced","is-default-password","is-expired"]),I(va,{visible:x.value,"remaining-days":q.value,"last-changed":P(n).user?.passwordLastChanged,onClose:we,onChangePassword:Ae,onRemindLater:Ie},null,8,["visible","remaining-days","last-changed"]),I(za,{visible:J.value,"onUpdate:visible":t[2]||(t[2]=e=>J.value=e),onSuccess:Se},null,8,["visible"]),I(ie,{modelValue:z.value,"onUpdate:modelValue":t[4]||(t[4]=e=>z.value=e),title:"联系我们",width:"500px","show-close":!0},{footer:f(()=>[I(N,{onClick:t[3]||(t[3]=e=>z.value=!1)},{default:f(()=>[...t[14]||(t[14]=[_("关闭",-1)])]),_:1})]),default:f(()=>[p("div",jo,[I(H,{column:1,border:""},{default:f(()=>[I(V,{label:"公司名称"},{default:f(()=>[_(v(P(y).systemConfig.companyName||"CRM系统"),1)]),_:1}),P(y).systemConfig.contactPhone?(u(),h(V,{key:0,label:"联系电话"},{default:f(()=>[p("a",{href:`tel:${P(y).systemConfig.contactPhone}`,class:"contact-link"},v(P(y).systemConfig.contactPhone),9,Fo)]),_:1})):d("",!0),P(y).systemConfig.contactEmail?(u(),h(V,{key:1,label:"联系邮箱"},{default:f(()=>[p("a",{href:`mailto:${P(y).systemConfig.contactEmail}`,class:"contact-link"},v(P(y).systemConfig.contactEmail),9,qo)]),_:1})):d("",!0),P(y).systemConfig.websiteUrl?(u(),h(V,{key:2,label:"官方网站"},{default:f(()=>[p("a",{href:P(y).systemConfig.websiteUrl,target:"_blank",class:"contact-link"},v(P(y).systemConfig.websiteUrl),9,Ho)]),_:1})):d("",!0),P(y).systemConfig.companyAddress?(u(),h(V,{key:3,label:"公司地址"},{default:f(()=>[_(v(P(y).systemConfig.companyAddress),1)]),_:1})):d("",!0)]),_:1}),P(y).systemConfig.contactQRCode?(u(),l("div",Bo,[I(G,null,{default:f(()=>[...t[13]||(t[13]=[_("扫码联系",-1)])]),_:1}),p("div",Jo,[p("div",zo,[p("img",{src:P(y).systemConfig.contactQRCode,alt:"联系二维码",class:"qr-image"},null,8,Go),p("p",null,v(P(y).systemConfig.contactQRCodeLabel||"扫码联系"),1)])])])):d("",!0)])]),_:1},8,["modelValue"])])}}}),Yo=Cs(Ko,[["__scopeId","data-v-0b3139ac"]]);async function Wo(){try{const e=await async function(){const e={success:!0,errors:[],warnings:[],info:{browserCompatibility:{localStorage:"undefined"!=typeof Storage&&!!window.localStorage,sessionStorage:"undefined"!=typeof Storage&&!!window.sessionStorage,indexedDB:"undefined"!=typeof indexedDB,webSQL:"undefined"!=typeof openDatabase},storageUsage:Pt(),storageAvailable:!1}};try{e.info.browserCompatibility.localStorage||(e.errors.push("localStorage不可用，数据持久化功能将无法正常工作"),e.success=!1);const s=Et.getInstance();try{const t="__deployment_test__",a={test:!0,timestamp:Date.now()};if(s.save({key:t,version:"1.0.0"},a)){const a=s.load({key:t,version:"1.0.0"});a&&!0===a.test?e.info.storageAvailable=!0:(e.errors.push("localStorage加载测试失败"),e.success=!1),s.remove(t)}else e.errors.push("localStorage保存测试失败"),e.success=!1}catch(t){e.errors.push(`存储功能测试失败: ${t}`),e.success=!1}const a=e.info.storageUsage;a.percentage>80&&e.warnings.push(`存储空间使用率过高: ${a.percentage.toFixed(1)}%`),console.log("[Deployment] 生产环境检查通过");const r=["orders","customers","performance","departments","services"];for(const o of r)try{const e={key:`crm_store_${o}`,version:"1.0.0"};s.load(e)}catch(t){e.warnings.push(`Store ${o} 配置可能有问题`)}}catch(t){e.errors.push(`部署检查过程中发生错误: ${t}`),e.success=!1}return e}();e.success||function(e){console.log("\n=== 部署前检查结果 ==="),e.success?console.log("✅ 检查通过，可以部署"):console.log("❌ 检查失败，请修复以下问题后再部署"),e.errors.length>0&&(console.log("\n🚨 错误:"),e.errors.forEach(e=>console.log(`  - ${e}`)))}(e)}catch(e){}}const Qo={install(e){e.directive("permission",{mounted(e,t){cs(e,t)},updated(e,t){cs(e,t)}}),e.config.globalProperties.$hasPermission=os,e.config.globalProperties.$hasAnyPermission=ns,e.config.globalProperties.$hasAllPermissions=is}},Xo={mounted(e,t){Zo(e,t)},updated(e,t){Zo(e,t)}};function Zo(e,t){const s=ys();let a=!0,r={};"string"==typeof t.value||Array.isArray(t.value)?r.permission=t.value:"object"==typeof t.value&&(r={...t.value});const{permission:o,role:n,mode:i="any",invert:c=!1}=r;if(n){const e=Array.isArray(n)?n:[n],t=s.roles||[];a="all"===i?e.every(e=>t.includes(e)):e.some(e=>t.includes(e))}if(o&&a){const e=Array.isArray(o)?o:[o];a="all"===i?e.every(e=>s.hasPermission(e)):e.some(e=>s.hasPermission(e))}s.isAdmin&&(a=!0),c&&(a=!a),a?(e.style.display="",e.style.visibility="visible"):(e.style.display="none",e.style.visibility="hidden")}const en=(e,t,s)=>{console.error("全局错误:",e,s);try{V.error("应用出现错误，请刷新页面重试")}catch(a){console.error("错误处理器本身出错:",a)}};window.addEventListener("error",e=>{(e=>"ResizeObserver loop completed with undelivered notifications."!==e.message||(e.stopImmediatePropagation(),!1))(e)&&en(e.error||new Error(e.message))}),window.addEventListener("unhandledrejection",e=>{console.error("未处理的Promise拒绝:",e.reason),en(e.reason instanceof Error?e.reason:new Error(String(e.reason))),e.preventDefault()});const tn=x(Yo);tn.config.errorHandler=en;for(const[an,rn]of Object.entries(le))tn.component(an,rn);tn.use($());const sn=ys();(async()=>{console.log("[App] 开始初始化应用..."),"complete"!==document.readyState&&await new Promise(e=>{window.addEventListener("load",e)}),(()=>{try{const e="localStorage-test";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return console.error("[App] localStorage不可用:",e),!1}})()||console.warn("[App] localStorage不可用，使用默认配置");try{const t=Ss();try{t.initTheme(),console.log("[App] 主题配置初始化成功")}catch(e){console.error("[App] 主题配置初始化失败:",e)}try{await sn.initUser(),console.log("[App] 用户状态初始化成功")}catch(e){console.error("[App] 用户状态初始化失败:",e)}tn.use(Jt),tn.use(de,{locale:me}),tn.use(Qo),function(e){e.directive("permission",Xo)}(tn),tn.mount("#app"),console.log("[App] 应用挂载成功");try{Wo()}catch(e){console.error("[App] 部署检查失败:",e)}}catch(e){console.error("[App] 应用初始化失败:",e);try{tn.use(Jt),tn.use(de),tn.mount("#app"),console.log("[App] 应用已在错误恢复模式下挂载")}catch(t){console.error("[App] 应用挂载失败:",t)}}})();export{lt as A,gs as B,fe as C,Ie as D,Ut as E,vs as F,ts as G,ss as H,Wa as I,Ka as J,_e as K,Se as L,jt as M,Kt as N,yr as O,ve as P,Pe as Q,rt as R,ye as S,mt as T,he as U,St as V,$t as W,Cs as _,Ss as a,Ht as b,Gt as c,xt as d,Lt as e,Zt as f,ut as g,Bt as h,Dt as i,yo as j,_t as k,ge as l,hr as m,we as n,At as o,xs as p,Vt as q,dt as r,es as s,Ct as t,ys as u,at as v,st as w,_s as x,Xt as y,us as z};
