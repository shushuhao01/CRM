import{b as e,S as a,M as l,_ as t}from"./index-DkAJPKqn.js";import{useDepartmentStore as r}from"./department-DPqzaatc.js";import{a as p}from"./sensitiveInfo-DVfrBLrU.js";import{E as n}from"./elementPlus-DxaqjplL.js";import{l as d,r as o,Z as i,e as s,b as u,ag as c,aq as m,m as v,q as f,U as g,O as _,p as b,P as y,F as h,a9 as k,u as w,M as C,S as V,T as S,Q as T}from"./vendor-BtukhyiH.js";import"./utils-DfI7e5Rl.js";const z={class:"sms-approval-container"},j={class:"card-header"},R={class:"header-actions"},D={class:"search-section"},I={class:"pagination-container"},P={key:0,class:"detail-content"},U={class:"content-preview"},M={class:"recipients-list"},N={key:0,class:"approval-info"},x={key:0,class:"dialog-footer"},E={key:1,class:"dialog-footer"},Y=t(d({__name:"SmsApproval",setup(t){const d=e(),Y=r(),q=o(!1),O=o([]),$=o(!1),A=o(!1),F=o(null),L=i({applicant:"",department:"",status:"",dateRange:[]}),H=i({action:"approve",remark:"",recordIds:[]}),J=i({currentPage:1,pageSize:20,total:0}),Q=[{id:1,applicant:"张三",department:"销售部",templateName:"客户回访模板",recipientCount:50,content:"尊敬的客户，感谢您对我们产品的支持，我们将为您提供更好的服务。",reason:"月度客户回访活动",status:"pending",applyTime:"2024-01-15 10:30:00",recipients:["13800138001","13800138002","13800138003"]},{id:2,applicant:"李四",department:"市场部",templateName:"促销活动模板",recipientCount:200,content:"新年大促销！全场商品8折起，活动时间：1月20日-1月31日，详情咨询客服。",reason:"新年促销活动推广",status:"approved",applyTime:"2024-01-14 14:20:00",approveTime:"2024-01-14 16:45:00",approver:"王经理",approveRemark:"活动内容合规，批准发送",recipients:["13800138004","13800138005"]},{id:3,applicant:"王五",department:"客服部",templateName:"服务通知模板",recipientCount:30,content:"您的订单已发货，快递单号：SF123456789，预计3-5个工作日送达。",status:"rejected",applyTime:"2024-01-13 09:15:00",approveTime:"2024-01-13 11:30:00",approver:"张主管",approveRemark:"快递单号格式不正确，请修改后重新申请",recipients:["13800138006"]}],Z=o([]),B=s(()=>{let e=[...Q];if(L.applicant&&(e=e.filter(e=>e.applicant.includes(L.applicant))),L.department&&(e=e.filter(e=>e.department===L.department)),L.status&&(e=e.filter(e=>e.status===L.status)),L.dateRange&&2===L.dateRange.length){const[a,l]=L.dateRange;e=e.filter(e=>{const t=e.applyTime.split(" ")[0];return t>=a&&t<=l})}return e}),G=e=>({pending:"warning",approved:"success",rejected:"danger"}[e]||"info"),K=e=>({pending:"待审核",approved:"已通过",rejected:"已拒绝"}[e]||e),W=()=>{se()},X=()=>{L.applicant="",L.department="",L.status="",L.dateRange=[],se()},ee=e=>{O.value=e},ae=e=>{H.action="approve",H.recordIds=[e.id],H.remark="",A.value=!0},le=e=>{H.action="reject",H.recordIds=[e.id],H.remark="",A.value=!0},te=()=>{O.value.length&&(H.action="approve",H.recordIds=O.value.map(e=>e.id),H.remark="",A.value=!0)},re=()=>{O.value.length&&(H.action="reject",H.recordIds=O.value.map(e=>e.id),H.remark="",A.value=!0)},pe=()=>{F.value&&(ae(F.value),$.value=!1)},ne=()=>{F.value&&(le(F.value),$.value=!1)},de=async()=>{if(H.remark.trim())try{q.value=!0,await new Promise(e=>setTimeout(e,1e3)),H.recordIds.forEach(e=>{const a=Q.find(a=>a.id===e);a&&(a.status="approve"===H.action?"approved":"rejected",a.approveTime=(new Date).toLocaleString(),a.approver="当前用户",a.approveRemark=H.remark,"approve"===H.action?d.sendMessage(l.SMS_SEND_APPROVED,`您的短信发送申请"${a.templateName}"已审核通过，可以开始发送了。`,{relatedId:a.id,relatedType:"sms_send",actionUrl:"/system/sms-approval"}):d.sendMessage(l.SMS_SEND_REJECTED,`您的短信发送申请"${a.templateName}"审核未通过。拒绝原因：${H.remark}`,{relatedId:a.id,relatedType:"sms_send",actionUrl:"/system/sms-approval"}))}),n.success(("approve"===H.action?"通过":"拒绝")+"审核成功"),A.value=!1,se()}catch(e){n.error("操作失败，请重试")}finally{q.value=!1}else n.warning("请输入审核备注")},oe=e=>{J.pageSize=e,se()},ie=e=>{J.currentPage=e,se()},se=()=>{q.value=!0,setTimeout(()=>{const e=B.value;J.total=e.length;const a=(J.currentPage-1)*J.pageSize,l=a+J.pageSize;Z.value=e.slice(a,l),q.value=!1},500)};return u(async()=>{try{await Y.initData(),se()}catch(e){console.error("初始化部门数据失败:",e)}}),(e,l)=>{const t=c("el-button"),r=c("el-input"),n=c("el-form-item"),d=c("el-option"),o=c("el-select"),i=c("el-date-picker"),s=c("el-form"),u=c("el-table-column"),Q=c("el-tag"),B=c("el-table"),se=c("el-pagination"),ue=c("el-card"),ce=c("el-descriptions-item"),me=c("el-descriptions"),ve=c("el-dialog"),fe=m("loading");return f(),v("div",z,[g(ue,null,{header:_(()=>[b("div",j,[l[14]||(l[14]=b("span",null,"短信审核管理",-1)),b("div",R,[g(t,{type:"primary",onClick:te,disabled:!O.value.length},{default:_(()=>[...l[12]||(l[12]=[V(" 批量通过 ",-1)])]),_:1},8,["disabled"]),g(t,{type:"danger",onClick:re,disabled:!O.value.length},{default:_(()=>[...l[13]||(l[13]=[V(" 批量拒绝 ",-1)])]),_:1},8,["disabled"])])])]),default:_(()=>[b("div",D,[g(s,{model:L,inline:""},{default:_(()=>[g(n,{label:"申请人"},{default:_(()=>[g(r,{modelValue:L.applicant,"onUpdate:modelValue":l[0]||(l[0]=e=>L.applicant=e),placeholder:"请输入申请人姓名",clearable:""},null,8,["modelValue"])]),_:1}),g(n,{label:"部门"},{default:_(()=>[g(o,{modelValue:L.department,"onUpdate:modelValue":l[1]||(l[1]=e=>L.department=e),placeholder:"请选择部门",clearable:""},{default:_(()=>[(f(!0),v(h,null,k(w(Y).departmentList,e=>(f(),C(d,{key:e.id,label:e.name,value:e.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),g(n,{label:"审核状态"},{default:_(()=>[g(o,{modelValue:L.status,"onUpdate:modelValue":l[2]||(l[2]=e=>L.status=e),placeholder:"请选择状态",clearable:""},{default:_(()=>[g(d,{label:"待审核",value:"pending"}),g(d,{label:"已通过",value:"approved"}),g(d,{label:"已拒绝",value:"rejected"})]),_:1},8,["modelValue"])]),_:1}),g(n,{label:"申请时间"},{default:_(()=>[g(i,{modelValue:L.dateRange,"onUpdate:modelValue":l[3]||(l[3]=e=>L.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),g(n,null,{default:_(()=>[g(t,{type:"primary",onClick:W},{default:_(()=>[...l[15]||(l[15]=[V("搜索",-1)])]),_:1}),g(t,{onClick:X},{default:_(()=>[...l[16]||(l[16]=[V("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),y((f(),C(B,{data:Z.value,onSelectionChange:ee,style:{width:"100%"}},{default:_(()=>[g(u,{type:"selection",width:"55"}),g(u,{prop:"id",label:"申请ID",width:"80"}),g(u,{prop:"applicant",label:"申请人",width:"100"}),g(u,{prop:"department",label:"部门",width:"120"}),g(u,{prop:"templateName",label:"短信模板",width:"150"}),g(u,{prop:"recipientCount",label:"接收人数",width:"100"}),g(u,{prop:"content",label:"短信内容","min-width":"200","show-overflow-tooltip":""}),g(u,{prop:"reason",label:"申请原因",width:"150","show-overflow-tooltip":""}),g(u,{prop:"status",label:"状态",width:"100"},{default:_(({row:e})=>[g(Q,{type:G(e.status)},{default:_(()=>[V(S(K(e.status)),1)]),_:2},1032,["type"])]),_:1}),g(u,{prop:"applyTime",label:"申请时间",width:"160"}),g(u,{prop:"approveTime",label:"审核时间",width:"160"}),g(u,{label:"操作",width:"200",fixed:"right"},{default:_(({row:e})=>["pending"===e.status?(f(),C(t,{key:0,type:"primary",size:"small",onClick:a=>ae(e)},{default:_(()=>[...l[17]||(l[17]=[V(" 通过 ",-1)])]),_:1},8,["onClick"])):T("",!0),"pending"===e.status?(f(),C(t,{key:1,type:"danger",size:"small",onClick:a=>le(e)},{default:_(()=>[...l[18]||(l[18]=[V(" 拒绝 ",-1)])]),_:1},8,["onClick"])):T("",!0),g(t,{type:"info",size:"small",onClick:a=>{return l=e,F.value=l,void($.value=!0);var l}},{default:_(()=>[...l[19]||(l[19]=[V(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[fe,q.value]]),b("div",I,[g(se,{"current-page":J.currentPage,"onUpdate:currentPage":l[4]||(l[4]=e=>J.currentPage=e),"page-size":J.pageSize,"onUpdate:pageSize":l[5]||(l[5]=e=>J.pageSize=e),"page-sizes":[10,20,50,100],total:J.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:oe,onCurrentChange:ie},null,8,["current-page","page-size","total"])])]),_:1}),g(ve,{modelValue:$.value,"onUpdate:modelValue":l[8]||(l[8]=e=>$.value=e),title:"审核详情",width:"800px"},{footer:_(()=>["pending"===F.value?.status?(f(),v("div",x,[g(t,{onClick:l[6]||(l[6]=e=>$.value=!1)},{default:_(()=>[...l[21]||(l[21]=[V("取消",-1)])]),_:1}),g(t,{type:"danger",onClick:ne},{default:_(()=>[...l[22]||(l[22]=[V("拒绝",-1)])]),_:1}),g(t,{type:"primary",onClick:pe},{default:_(()=>[...l[23]||(l[23]=[V("通过",-1)])]),_:1})])):(f(),v("div",E,[g(t,{onClick:l[7]||(l[7]=e=>$.value=!1)},{default:_(()=>[...l[24]||(l[24]=[V("关闭",-1)])]),_:1})]))]),default:_(()=>[F.value?(f(),v("div",P,[g(me,{column:2,border:""},{default:_(()=>[g(ce,{label:"申请ID"},{default:_(()=>[V(S(F.value.id),1)]),_:1}),g(ce,{label:"申请人"},{default:_(()=>[V(S(F.value.applicant),1)]),_:1}),g(ce,{label:"部门"},{default:_(()=>[V(S(F.value.department),1)]),_:1}),g(ce,{label:"短信模板"},{default:_(()=>[V(S(F.value.templateName),1)]),_:1}),g(ce,{label:"接收人数"},{default:_(()=>[V(S(F.value.recipientCount),1)]),_:1}),g(ce,{label:"申请时间"},{default:_(()=>[V(S(F.value.applyTime),1)]),_:1}),g(ce,{label:"申请原因",span:2},{default:_(()=>[V(S(F.value.reason),1)]),_:1}),g(ce,{label:"短信内容",span:2},{default:_(()=>[b("div",U,S(F.value.content),1)]),_:1}),g(ce,{label:"接收人列表",span:2},{default:_(()=>[b("div",M,[(f(!0),v(h,null,k(F.value.recipients,e=>(f(),C(Q,{key:e,style:{margin:"2px"}},{default:_(()=>[V(S(w(p)(e,w(a).PHONE)),1)]),_:2},1024))),128))])]),_:1})]),_:1}),"pending"!==F.value.status?(f(),v("div",N,[l[20]||(l[20]=b("h4",null,"审核信息",-1)),g(me,{column:2,border:""},{default:_(()=>[g(ce,{label:"审核状态"},{default:_(()=>[g(Q,{type:G(F.value.status)},{default:_(()=>[V(S(K(F.value.status)),1)]),_:1},8,["type"])]),_:1}),g(ce,{label:"审核时间"},{default:_(()=>[V(S(F.value.approveTime),1)]),_:1}),g(ce,{label:"审核人"},{default:_(()=>[V(S(F.value.approver),1)]),_:1}),g(ce,{label:"审核备注",span:2},{default:_(()=>[V(S(F.value.approveRemark||"无"),1)]),_:1})]),_:1})])):T("",!0)])):T("",!0)]),_:1},8,["modelValue"]),g(ve,{modelValue:A.value,"onUpdate:modelValue":l[11]||(l[11]=e=>A.value=e),title:"审核备注",width:"500px"},{footer:_(()=>[g(t,{onClick:l[10]||(l[10]=e=>A.value=!1)},{default:_(()=>[...l[25]||(l[25]=[V("取消",-1)])]),_:1}),g(t,{type:"primary",onClick:de},{default:_(()=>[...l[26]||(l[26]=[V("确认",-1)])]),_:1})]),default:_(()=>[g(s,{model:H,"label-width":"80px"},{default:_(()=>[g(n,{label:"审核结果"},{default:_(()=>[g(Q,{type:"approve"===H.action?"success":"danger"},{default:_(()=>[V(S("approve"===H.action?"通过":"拒绝"),1)]),_:1},8,["type"])]),_:1}),g(n,{label:"备注",required:""},{default:_(()=>[g(r,{modelValue:H.remark,"onUpdate:modelValue":l[9]||(l[9]=e=>H.remark=e),type:"textarea",rows:4,placeholder:"请输入审核备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-54f9a5f3"]]);export{Y as default};
