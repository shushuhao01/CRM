import{v as e,g as t,t as a,u as s}from"./index-C4IdUW1A.js";import{isProduction as r}from"./env-DLalhsF6.js";import{r as n,e as o}from"./vendor-BtukhyiH.js";const i=a=>{if(e()){const e=[{userId:"user_1",userName:"张三",departmentId:"dept_1",departmentName:"销售一部",totalAssigned:25,todayAssigned:3,weekAssigned:12,monthAssigned:25,avgOrderAmount:3500,lastAssignedTime:"2024-01-15 10:30:00"},{userId:"user_2",userName:"李四",departmentId:"dept_1",departmentName:"销售一部",totalAssigned:18,todayAssigned:2,weekAssigned:8,monthAssigned:18,avgOrderAmount:4200,lastAssignedTime:"2024-01-15 11:00:00"}];return Promise.resolve(e)}return t.get("/assignment/stats",{params:a})},d=a("data",()=>{const a=n([]),d=n(0),u=n(!1),c=n(!1),m=n({totalCount:0,pendingCount:0,assignedCount:0,archivedCount:0,recoveredCount:0,totalAmount:0,todayCount:0,weekCount:0,monthCount:0}),l=n({page:1,pageSize:30}),g=n({status:"pending",dateRange:[],searchKeyword:"",assigneeId:"",orderAmountRange:[]}),p=n([]),h=n([]),v=n([]),w=n(null),I=n([]),y=n({}),D=n("direct"),f=n([]),N=n(0),A=n(!1),S=n({}),C=n([]),b=n(!1),_=o(()=>I.value.length>0),k=o(()=>I.value.length),T=o(()=>{const e=s();let t=a.value;if(e.currentUser){const a=e.currentUser.id;"super_admin"===e.currentUser.role||"admin"===e.currentUser.role||(t=t.filter(e=>e.createdBy===a||e.assigneeId===a))}if(g.value.status&&(t=t.filter(e=>e.status===g.value.status)),g.value.searchKeyword){const e=g.value.searchKeyword.toLowerCase();t=t.filter(t=>t.customerName.toLowerCase().includes(e)||t.phone.includes(e)||t.orderNo.toLowerCase().includes(e)||t.customerCode&&t.customerCode.toLowerCase().includes(e))}if(g.value.assigneeId&&(t=t.filter(e=>e.assigneeId===g.value.assigneeId)),g.value.orderAmountRange&&2===g.value.orderAmountRange.length){const[e,a]=g.value.orderAmountRange;t=t.filter(t=>t.orderAmount>=e&&t.orderAmount<=a)}if(g.value.dateRange&&2===g.value.dateRange.length){const[e,a]=g.value.dateRange;t=t.filter(t=>{const s=new Date(t.orderDate);return s>=new Date(e)&&s<=new Date(a)})}if(g.value.dateFilter&&"all"!==g.value.dateFilter){const e=new Date;let a;switch(g.value.dateFilter){case"today":a=new Date(e.getFullYear(),e.getMonth(),e.getDate()),t=t.filter(e=>{const t=new Date(e.orderDate);return t>=a&&t<new Date(a.getTime()+864e5)});break;case"yesterday":a=new Date(e.getFullYear(),e.getMonth(),e.getDate()-1),t=t.filter(e=>{const t=new Date(e.orderDate);return t>=a&&t<new Date(a.getTime()+864e5)});break;case"thisWeek":const s=new Date(e);s.setDate(e.getDate()-e.getDay()),s.setHours(0,0,0,0),t=t.filter(e=>new Date(e.orderDate)>=s);break;case"last30Days":a=new Date(e.getTime()-2592e6),t=t.filter(e=>new Date(e.orderDate)>=a);break;case"thisMonth":a=new Date(e.getFullYear(),e.getMonth(),1),t=t.filter(e=>new Date(e.orderDate)>=a);break;case"thisYear":a=new Date(e.getFullYear(),0,1),t=t.filter(e=>new Date(e.orderDate)>=a)}}return t}),R=async s=>{u.value=!0;try{const r={...l.value,...g.value,...s},n=await(a=>{if(e()){const e=localStorage.getItem("dataList");let t=[];if(e)try{t=JSON.parse(e)}catch(s){console.error("解析dataList失败:",s),t=[]}if(!t||0===t.length)return console.log("localStorage中没有dataList数据，返回空列表"),Promise.resolve({list:[],total:0,summary:{totalCount:0,pendingCount:0,assignedCount:0,archivedCount:0,totalAmount:0,todayCount:0,weekCount:0,monthCount:0}});const{page:r=1,pageSize:n=30}=a,o=(r-1)*n,i=o+n;return Promise.resolve({list:t.slice(o,i),total:t.length,summary:{totalCount:t.length,pendingCount:t.filter(e=>"pending"===e.status).length,assignedCount:t.filter(e=>"assigned"===e.status).length,archivedCount:t.filter(e=>"archived"===e.status).length,totalAmount:(t||[]).reduce((e,t)=>e+(t.orderAmount||0),0),todayCount:t.filter(e=>{const t=(new Date).toDateString();return new Date(e.orderDate).toDateString()===t}).length,weekCount:t.filter(e=>{const t=new Date;return t.setDate(t.getDate()-7),new Date(e.orderDate)>=t}).length,monthCount:t.filter(e=>{const t=new Date;return t.setMonth(t.getMonth()-1),new Date(e.orderDate)>=t}).length}})}return t.get("/api/data/list",a)})(r);return a.value=n?.list||[],d.value=n?.total||0,m.value=n?.summary||{},n}catch(r){throw console.error("获取资料列表失败:",r),r}finally{u.value=!1}},O=()=>R(),P=(e,t)=>{if(y.value[e]){const a=y.value[e],s=t.map(e=>a.members.find(t=>t.id===e.id)||{id:e.id,name:e.name,assignmentCount:0,lastAssignedAt:void 0});y.value[e].members=s}else y.value[e]={members:t.map(e=>({id:e.id,name:e.name,assignmentCount:0,lastAssignedAt:void 0})),currentIndex:0,lastRoundCompleted:!1}},U=(e,t)=>{const a=y.value[e];if(!a||0===a.members.length)return[];const s=[],r=[...a.members];r.sort((e,t)=>e.assignmentCount!==t.assignmentCount?e.assignmentCount-t.assignmentCount:e.lastAssignedAt||t.lastAssignedAt?e.lastAssignedAt?t.lastAssignedAt?new Date(e.lastAssignedAt).getTime()-new Date(t.lastAssignedAt).getTime():1:-1:0);for(let n=0;n<t;n++){const e=r[n%r.length];s.push({id:e.id,name:e.name});const t=a.members.findIndex(t=>t.id===e.id);-1!==t&&(a.members[t].assignmentCount++,a.members[t].lastAssignedAt=(new Date).toISOString())}return s},L=async e=>{try{P(e.departmentId,e.members);let t=[];if("leader"===e.mode&&e.leaderId&&e.leaderName)t=e.dataIds.map(t=>({dataId:t,assigneeId:e.leaderId,assigneeName:e.leaderName}));else{const a=U(e.departmentId,e.dataIds.length);t=e.dataIds.map((e,t)=>({dataId:e,assigneeId:a[t%a.length].id,assigneeName:a[t%a.length].name}))}const s={success:!0,message:"轮流分配成功"};return s.success&&(a.value=a.value.map(e=>{const a=t.find(t=>t.dataId===e.id);return a?{...e,status:"assigned",assigneeId:a.assigneeId,assigneeName:a.assigneeName,updateTime:(new Date).toISOString()}:e}),I.value=[],await O()),s}catch(t){throw console.error("轮流批量分配资料失败:",t),t}},$=e=>{const t=[];if(e.phone&&t.push(`手机号: ${e.phone}`),e.customerCode&&t.push(`客户编码: ${e.customerCode}`),e.orderNo&&t.push(`订单号: ${e.orderNo}`),e.trackingNo&&t.push(`物流单号: ${e.trackingNo}`),e.customerName&&t.push(`客户: ${e.customerName}`),t.length>0){const a={text:t.join(", "),time:(new Date).toLocaleString(),params:e},s=v.value.findIndex(e=>e.text===a.text);s>-1&&v.value.splice(s,1),v.value.unshift(a),v.value.length>10&&(v.value=v.value.slice(0,10))}},x=async a=>{try{A.value=!0;const s=await(a=>{if(e()){const e=[{id:"ah_1",dataId:"data_1",assignType:"roundrobin",assignMode:"direct",toUserId:"user_1",toUserName:"张三",departmentId:"dept_1",departmentName:"销售一部",operatorId:"admin_1",operatorName:"管理员",remark:"轮流分配",createTime:"2024-01-15 10:30:00"},{id:"ah_2",dataId:"data_2",assignType:"leader_assign",fromUserId:"leader_1",fromUserName:"部门负责人",toUserId:"user_2",toUserName:"李四",departmentId:"dept_1",departmentName:"销售一部",operatorId:"leader_1",operatorName:"部门负责人",remark:"部门负责人二次分配",createTime:"2024-01-15 11:00:00"}];return Promise.resolve({list:e,total:e.length})}return t.get("/assignment/history",{params:a})})(a);return f.value=s?.list||[],N.value=s?.total||0,s}catch(s){throw console.error("获取分配历史失败:",s),s}finally{A.value=!1}},M=async(a,s)=>{try{await((a,s)=>e()?Promise.resolve():t.put(`/department/${a}/roundrobin-state`,s))(a,s),S.value[a]=s}catch(r){throw console.error("更新部门轮流分配状态失败:",r),r}},H=async a=>{try{await(a=>e()?Promise.resolve():t.post("/assignment/history",a))(a),f.value.length>0&&await x({})}catch(s){throw console.error("记录分配历史失败:",s),s}};return{dataList:a,total:d,loading:u,searchLoading:c,summary:m,pagination:l,filters:g,assigneeOptions:p,searchResults:h,searchHistory:v,statistics:w,selectedDataIds:I,departmentAssignmentState:y,assignmentMode:D,assignmentHistory:f,assignmentHistoryTotal:N,assignmentHistoryLoading:A,departmentRoundRobinStates:S,assignmentStats:C,assignmentStatsLoading:b,hasSelectedData:_,selectedDataCount:k,filteredDataList:T,fetchDataList:R,refreshData:O,setFilters:e=>(g.value={...g.value,...e},l.value.page=1,R()),setPagination:(e,t)=>(l.value.page=e,t&&(l.value.pageSize=t),R()),resetFilters:()=>(g.value={status:"pending",dateRange:[],searchKeyword:"",assigneeId:"",orderAmountRange:[]},l.value.page=1,R()),fetchAssigneeOptions:async()=>{try{return p.value=await(()=>{if(e()){const e=[{id:"1",name:"李销售",department:"销售一部",status:"active"},{id:"2",name:"王经理",department:"销售二部",status:"active"},{id:"3",name:"张主管",department:"销售三部",status:"busy"},{id:"4",name:"赵专员",department:"销售一部",status:"active"},{id:"5",name:"刘顾问",department:"销售二部",status:"offline"}];return Promise.resolve(e)}return t.get("/api/data/assignee-options")})(),p.value}catch(a){throw console.error("获取分配成员列表失败:",a),a}},batchAssignData:async s=>{try{const r=await(a=>e()?Promise.resolve({success:!0,message:"批量分配成功"}):t.post("/api/data/batch-assign",a))(s);return r.success&&(a.value=a.value.map(e=>s.dataIds.includes(e.id)?{...e,status:"assigned",assigneeId:s.assigneeId,assigneeName:s.assigneeName,updateTime:(new Date).toISOString()}:e),I.value=[],await O()),r}catch(r){throw console.error("批量分配资料失败:",r),r}},batchRoundRobinAssignData:L,initializeDepartmentState:P,getNextAssignees:U,batchArchiveData:async s=>{try{const r=await(a=>e()?Promise.resolve({success:!0,message:"批量封存成功"}):t.post("/api/data/batch-archive",a))(s);return r.success&&(a.value=a.value.map(e=>s.dataIds.includes(e.id)?{...e,status:"archived",updateTime:(new Date).toISOString()}:e),I.value=[],await O()),r}catch(r){throw console.error("批量封存资料失败:",r),r}},archiveData:async e=>{try{const t={success:!0,message:"封存成功"};return t.success&&(a.value=a.value.map(t=>t.id===e.dataId?{...t,status:"archived",archiveInfo:{duration:e.duration,reason:e.reason,remark:e.remark,unarchiveTime:e.unarchiveTime,archiveTime:(new Date).toISOString()},updateTime:(new Date).toISOString()}:t),await O()),t}catch(t){throw console.error("封存资料失败:",t),t}},recoverData:async(s,r)=>{try{const o=await(n={dataId:s,reason:r},e()?Promise.resolve({success:!0,message:"回收成功"}):t.post("/api/data/recover",n));if(o.success){const e=a.value.findIndex(e=>e.id===s);e>-1&&(a.value[e]={...a.value[e],status:"recovered",assigneeId:void 0,assigneeName:void 0,assigneeDepartment:void 0,updateTime:(new Date).toISOString()}),await O()}return o}catch(o){throw console.error("回收资料失败:",o),o}var n},deleteData:async(s,r)=>{try{const o=await(n={dataId:s,reason:r},e()?Promise.resolve({success:!0,message:"删除成功"}):t.post("/api/data/delete",n));if(o.success){const e=a.value.findIndex(e=>e.id===s);e>-1&&a.value.splice(e,1),await O()}return o}catch(o){throw console.error("删除资料失败:",o),o}var n},searchCustomer:async e=>{c.value=!0;try{return h.value=await(async e=>{if(r()){console.log("[Data API] 生产环境：使用后端API搜索客户");const a=await t.get("/api/data/search-customer",e);return a.data||a}console.log("[Data API] 开发环境：使用localStorage搜索客户");try{const t=localStorage.getItem("customer-store"),s=localStorage.getItem("crm_store_order"),r=localStorage.getItem("userDatabase");if(!t||!s||!r)return[];let n=[];try{const e=JSON.parse(s);e.data&&e.data.orders?n=e.data.orders:e.orders?n=e.orders:Array.isArray(e)&&(n=e)}catch(a){return console.error("[Data API] 解析订单数据失败:",a),[]}const o=JSON.parse(t).customers||[],i=JSON.parse(r)||[],d=[],u=e.phone||e.orderNo||e.trackingNo||e.customerName||e.customerCode||"";for(const a of n){const t=o.find(e=>e.id===a.customerId);if(!t)continue;const s=i.find(e=>e.id===a.salesPersonId);let r=!1;e.phone&&t.phone===e.phone&&(r=!0),e.customerName&&t.name?.includes(e.customerName)&&(r=!0),e.customerCode&&t.code===e.customerCode&&(r=!0),e.orderNo&&a.orderNumber===e.orderNo&&(r=!0),e.trackingNo&&a.trackingNumber===e.trackingNo&&(r=!0),!r&&u&&(t.name?.includes(u)||t.phone===u||t.code===u||a.orderNumber===u||a.orderNumber?.includes(u)||a.trackingNumber===u||a.trackingNumber?.includes(u))&&(r=!0),r&&d.push({customerName:t.name||"未知",phone:t.phone||"",orderNo:a.orderNumber||"",orderAmount:a.totalAmount||0,orderDate:a.createTime?a.createTime.split(" ")[0]:"",trackingNo:a.trackingNumber||"",ownerName:s&&(s.realName||s.name)||"未知",ownerDepartment:s&&s.department||"未知部门",ownerPhone:s&&s.phone||"",ownerStatus:"active",customerId:t.id,ownerId:s?.id||""})}return d.reduce((e,t)=>(e.find(e=>e.customerName===t.customerName&&e.orderNo===t.orderNo)||e.push(t),e),[])}catch(s){return console.error("[Data API] 搜索客户失败:",s),[]}})(e),$(e),h.value}catch(a){throw console.error("客户搜索失败:",a),a}finally{c.value=!1}},addToSearchHistory:$,clearSearchHistory:()=>{v.value=[]},fetchStatistics:async e=>{try{return w.value=await(e=>t.get("/api/data/statistics",e?{startDate:e[0],endDate:e[1]}:{}))(e),w.value}catch(a){throw console.error("获取统计数据失败:",a),a}},toggleSelectData:e=>{const t=I.value.indexOf(e);t>-1?I.value.splice(t,1):I.value.push(e)},toggleSelectAll:e=>{I.value=e?T.value.map(e=>e.id):[]},clearSelection:()=>{I.value=[]},exportData:async e=>{try{const a=await(e=>t.get("/api/data/export",e))(e),s=window.URL.createObjectURL(a),r=document.createElement("a");return r.href=s,r.download=`资料列表_${(new Date).toISOString().split("T")[0]}.${e.format}`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(s),!0}catch(a){throw console.error("导出数据失败:",a),a}},getCustomerDetail:async e=>{try{return await(e=>t.get(`/api/data/customer/${e}`))(e)}catch(a){throw console.error("获取客户详情失败:",a),a}},fetchAssignmentHistory:x,fetchDepartmentRoundRobinState:async a=>{try{const s=await(a=>{if(e()){const e={departmentId:a,departmentName:"销售一部",members:[{userId:"user_1",userName:"张三",assignmentCount:5,lastAssignedTime:"2024-01-15 10:30:00"},{userId:"user_2",userName:"李四",assignmentCount:3,lastAssignedTime:"2024-01-14 15:20:00"},{userId:"user_3",userName:"王五",assignmentCount:4,lastAssignedTime:"2024-01-15 09:15:00"}],lastUpdated:"2024-01-15 11:00:00"};return Promise.resolve(e)}return t.get(`/department/${a}/roundrobin-state`)})(a);return S.value[a]=s,s}catch(s){throw console.error("获取部门轮流分配状态失败:",s),s}},updateDepartmentRoundRobinState:M,fetchAssignmentStats:async e=>{try{b.value=!0;const t=await i(e);return C.value=t,t}catch(t){throw console.error("获取分配统计失败:",t),t}finally{b.value=!1}},recordAssignmentHistory:H,batchRoundRobinAssignDataWithHistory:async e=>{try{await L(e);(new Date).toISOString();const t={id:"current_user",name:"当前用户"};for(const s of e.dataIds)await H({dataId:s,assignType:"roundrobin",assignMode:e.assignMode,toUserId:"assigned_user_id",toUserName:"assigned_user_name",departmentId:e.departmentId,departmentName:"department_name",operatorId:t.id,operatorName:t.name,remark:e.remark});const a=S.value[e.departmentId];a&&await M(e.departmentId,a)}catch(t){throw console.error("轮流分配（含历史记录）失败:",t),t}},batchCrossDepartmentAssignData:async e=>{try{u.value=!0,await new Promise(e=>setTimeout(e,1e3)),e.assignments.forEach(t=>{const s=a.value.find(e=>e.id===t.dataId);s&&(s.assigneeId=t.assigneeId,s.assigneeName=t.assigneeName,s.status="assigned",s.assignTime=(new Date).toISOString(),s.operationRecords=s.operationRecords||[],s.operationRecords.unshift({id:`op_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"cross_department_assign",description:`跨部门智能分配给 ${t.assigneeName}（${t.department}）`,operatorId:"current_user",operatorName:"当前用户",createTime:(new Date).toISOString(),remark:e.remark}),s.assignmentHistory||(s.assignmentHistory=[]),s.assignmentHistory.unshift({id:`ah_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,dataId:t.dataId,assignType:"cross_department",assignMode:e.strategy,toUserId:t.assigneeId,toUserName:t.assigneeName,departmentId:"",departmentName:t.department,operatorId:"current_user",operatorName:"当前用户",createTime:(new Date).toISOString(),remark:e.remark}),s.currentAssignment={type:"cross_department",mode:e.strategy,assignTime:(new Date).toISOString(),assigneeId:t.assigneeId,assigneeName:t.assigneeName,departmentId:"",departmentName:t.department})});(new Date).toISOString();const t={id:"current_user",name:"当前用户"};for(const a of e.assignments)await H({dataId:a.dataId,assignType:"cross_department",assignMode:e.strategy,toUserId:a.assigneeId,toUserName:a.assigneeName,departmentId:"",departmentName:a.department,operatorId:t.id,operatorName:t.name,remark:e.remark});console.log(`跨部门智能分配完成: ${e.assignments.length} 条资料，策略: ${e.strategy}`)}catch(t){throw console.error("跨部门智能分配失败:",t),t}finally{u.value=!1}}}});export{i as g,d as u};
