import{l as e,aC as a,aA as s,r as t,Z as i,b as l,z as r,ag as n,m as o,q as c,p as d,U as u,M as m,O as p,S as v,u as g,a7 as f,F as y,a9 as h,T as N,Q as k}from"./vendor-BtukhyiH.js";import{d as b,u as _,c as T,_ as w}from"./index-BGtT17ll.js";import{G as x,F as S,r as V,J as A,u as C,I as O,k as P,H as I,E as D}from"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";const U={class:"logistics-track"},$={class:"page-header"},j={class:"header-actions"},z={class:"card-header"},B={class:"header-info"},E={class:"header-actions"},H={class:"basic-info"},J={class:"info-grid"},q={class:"info-item"},F={class:"value"},L={class:"info-item"},Y={class:"value"},K={class:"info-item"},M={class:"value"},Z={class:"info-item"},G={class:"value"},Q={class:"info-item"},R={class:"value"},W={class:"info-item"},X={class:"value"},ee={class:"tracking-timeline"},ae={class:"timeline-content"},se={class:"timeline-meta"},te={key:0,class:"timeline-location"},ie={key:1,class:"timeline-operator"},le={class:"dialog-footer"},re=w(e({__name:"Track",setup(e){const w=a(),re=s(),ne=T(re),oe=b(),ce=_(),de=t(!1),ue=t(!1),me=t(!1),pe=t(!1),ve=new Set,ge=t(!1),fe=i({trackingNo:"",company:""}),ye=i({trackingNos:"",company:""}),he=i({trackingNo:"",companyName:"",status:"",receiverName:"",receiverPhone:"",receiverAddress:"",shipTime:"",estimatedTime:""}),Ne=t([]),ke=t([{code:"SF",name:"顺丰速运"},{code:"YTO",name:"圆通速递"},{code:"ZTO",name:"中通快递"},{code:"STO",name:"申通快递"},{code:"YD",name:"韵达速递"},{code:"HTKY",name:"百世快递"},{code:"JD",name:"京东物流"},{code:"EMS",name:"中国邮政"}]),be=e=>({pending:"待发货",shipped:"已发货",in_transit:"运输中",delivering:"派送中",delivered:"已签收",exception:"异常"}[e]||"未知"),_e=e=>{const a=ce.currentUser;return a?"admin"===a.role?e:"department_manager"===a.role?e.filter(e=>{const s=ce.getUserById(e.createdBy);return s?.department===a.department}):"sales_staff"===a.role?e.filter(e=>e.createdBy===a.id):"customer_service"===a.role?e.filter(e=>e.servicePersonId===a.id):e.filter(e=>e.createdBy===a.id):[]},Te=async()=>{if(fe.trackingNo.trim()){if(!ge.value){de.value=!0;try{const e=fe.trackingNo.trim(),a=_e(oe.orders);let s=a.find(a=>a.expressNo===e||a.trackingNumber===e||a.expressNumber===e);if(!s){const t=JSON.parse(localStorage.getItem("crm_logistics")||"[]"),i=JSON.parse(localStorage.getItem("crm_shipments")||"[]"),l=t.find(a=>a.trackingNumber===e);if(l&&(s=a.find(e=>e.orderNumber===l.orderNumber)),!s){const t=i.find(a=>a.trackingNumber===e);t&&(s=a.find(e=>e.orderNumber===t.orderNumber))}}if(!s)return D.warning("未找到该快递单号对应的订单"),void(de.value=!1);const t=s.expressNo||s.trackingNumber||s.expressNumber,i=s.expressCompany||s.logisticsCompany||"未知快递";if(!t)return D.warning("该订单尚未发货或缺少物流信息"),void(de.value=!1);if(await new Promise(e=>{const a=setTimeout(()=>{ve.delete(a),e(void 0)},1e3);ve.add(a)}),ge.value)return;Object.assign(he,{trackingNo:t,companyName:Ce(i)||i,status:s.status,receiverName:s.customerName,receiverPhone:s.phone||s.customerPhone||"138****1234",receiverAddress:s.address||s.shippingAddress||s.deliveryAddress||"地址未填写",shipTime:s.shipTime||s.shippedAt||s.deliveryTime||s.createTime,estimatedTime:s.estimatedDeliveryTime||""});const l=[];if(("shipped"===s.status||"delivered"===s.status)&&(l.push({time:s.shipTime||s.shippedAt||s.deliveryTime||s.createTime,status:"已发货",description:`快件已从${i}发出，快递单号：${t}`,location:"发货地",operator:"物流员",type:"warning"}),"delivered"===s.status)){const e=new Date(s.shipTime||s.shippedAt||s.deliveryTime||s.createTime);e.setDate(e.getDate()+1),l.unshift({time:e.toISOString().replace("T"," ").substring(0,19),status:"运输中",description:"快件正在运输途中",location:"中转站",operator:"系统",type:"info"}),e.setDate(e.getDate()+1);const a=s.address||s.shippingAddress||s.deliveryAddress||"目的地";l.unshift({time:e.toISOString().replace("T"," ").substring(0,19),status:"派送中",description:`快件正在派送中，派送员正在配送至${a}`,location:a.split("省")[0]+"省"||"目的地",operator:"派送员",type:"primary"}),e.setHours(e.getHours()+4),l.unshift({time:e.toISOString().replace("T"," ").substring(0,19),status:"已签收",description:`您的快件已由${s.customerName}签收，感谢使用${i}`,location:a,operator:s.customerName,type:"success"})}Ne.value=l,ge.value||D.success("查询成功")}catch(e){ge.value||D.error("查询失败，请稍后重试")}finally{ge.value||(de.value=!1)}}}else D.warning("请输入物流单号")},we=()=>{fe.trackingNo="",fe.company="",Object.assign(he,{trackingNo:"",companyName:"",status:"",receiverName:"",receiverPhone:"",receiverAddress:"",shipTime:"",estimatedTime:""}),Ne.value=[]},xe=async()=>{if(he.trackingNo&&!ge.value){ue.value=!0;try{await new Promise(e=>{const a=setTimeout(()=>{ve.delete(a),e(void 0)},1e3);ve.add(a)}),ge.value||D.success("轨迹已刷新")}catch(e){ge.value||D.error("刷新失败")}finally{ge.value||(ue.value=!1)}}},Se=()=>{he.trackingNo?ne.push(`/logistics/track/detail/${he.trackingNo}`):D.warning("请先查询物流轨迹")},Ve=()=>{he.trackingNo?D.success("导出功能开发中..."):D.warning("请先查询物流轨迹")},Ae=async()=>{if(ye.trackingNos.trim()){if(!ge.value){me.value=!0;try{await new Promise(e=>{const a=setTimeout(()=>{ve.delete(a),e(void 0)},2e3);ve.add(a)}),ge.value||(D.success("批量查询完成"),pe.value=!1)}catch(e){ge.value||D.error("批量查询失败")}finally{ge.value||(me.value=!1)}}}else D.warning("请输入物流单号")},Ce=e=>{const a=ke.value.find(a=>a.code===e);return a?.name||""};return l(()=>{oe.setupLogisticsEventListener(),oe.startLogisticsAutoSync();const e=w.query.trackingNo,a=w.query.company;e&&(fe.trackingNo=e,a&&(fe.company=a),Te()),oe.$subscribe((e,a)=>{if(he.trackingNo&&e.events.some(e=>"expressNo"===e.key||"expressCompany"===e.key||"status"===e.key)){_e(oe.orders).find(e=>e.expressNo===he.trackingNo)&&Te()}})}),r(()=>{ge.value=!0,ve.forEach(e=>{clearTimeout(e)}),ve.clear()}),(e,a)=>{const s=n("el-button"),t=n("el-input"),i=n("el-form-item"),l=n("el-option"),r=n("el-select"),b=n("el-form"),_=n("el-card"),T=n("el-tag"),w=n("el-divider"),D=n("el-icon"),re=n("el-timeline-item"),ne=n("el-timeline"),oe=n("el-empty"),ce=n("el-dialog");return c(),o("div",U,[d("div",$,[a[7]||(a[7]=d("h2",null,"物流跟踪",-1)),d("div",j,[u(s,{onClick:Ve,icon:g(x)},{default:p(()=>[...a[6]||(a[6]=[v(" 导出轨迹 ",-1)])]),_:1},8,["icon"])])]),u(_,{class:"search-card"},{default:p(()=>[u(b,{model:fe,inline:!0,class:"search-form"},{default:p(()=>[u(i,{label:"物流单号"},{default:p(()=>[u(t,{modelValue:fe.trackingNo,"onUpdate:modelValue":a[0]||(a[0]=e=>fe.trackingNo=e),placeholder:"请输入物流单号",clearable:"",style:{width:"300px"},onKeyup:f(Te,["enter"])},null,8,["modelValue"])]),_:1}),u(i,{label:"物流公司"},{default:p(()=>[u(r,{modelValue:fe.company,"onUpdate:modelValue":a[1]||(a[1]=e=>fe.company=e),placeholder:"请选择物流公司",clearable:"",style:{width:"200px"}},{default:p(()=>[(c(!0),o(y,null,h(ke.value,e=>(c(),m(l,{key:e.code,label:e.name,value:e.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(i,null,{default:p(()=>[u(s,{onClick:Te,type:"primary",icon:g(S),loading:de.value},{default:p(()=>[...a[8]||(a[8]=[v(" 查询轨迹 ",-1)])]),_:1},8,["icon","loading"]),u(s,{onClick:we,icon:g(V)},{default:p(()=>[...a[9]||(a[9]=[v(" 重置 ",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),he.trackingNo?(c(),m(_,{key:0,class:"result-card"},{header:p(()=>{return[d("div",z,[d("div",B,[d("h3",null,N(he.trackingNo),1),u(T,{type:(e=he.status,{pending:"info",shipped:"warning",in_transit:"primary",delivering:"primary",delivered:"success",exception:"danger"}[e]||"info"),size:"large"},{default:p(()=>[v(N(be(he.status)),1)]),_:1},8,["type"])]),d("div",E,[u(s,{onClick:Se,type:"primary",size:"small"},{default:p(()=>[...a[10]||(a[10]=[v(" 查看详情 ",-1)])]),_:1}),u(s,{onClick:xe,icon:g(V),size:"small",loading:ue.value},{default:p(()=>[...a[11]||(a[11]=[v(" 刷新轨迹 ",-1)])]),_:1},8,["icon","loading"])])])];var e}),default:p(()=>[d("div",H,[d("div",J,[d("div",q,[a[12]||(a[12]=d("span",{class:"label"},"物流公司：",-1)),d("span",F,N(he.companyName),1)]),d("div",L,[a[13]||(a[13]=d("span",{class:"label"},"收货人：",-1)),d("span",Y,N(he.receiverName),1)]),d("div",K,[a[14]||(a[14]=d("span",{class:"label"},"联系电话：",-1)),d("span",M,N(he.receiverPhone),1)]),d("div",Z,[a[15]||(a[15]=d("span",{class:"label"},"收货地址：",-1)),d("span",G,N(he.receiverAddress),1)]),d("div",Q,[a[16]||(a[16]=d("span",{class:"label"},"发货时间：",-1)),d("span",R,N(he.shipTime),1)]),d("div",W,[a[17]||(a[17]=d("span",{class:"label"},"预计送达：",-1)),d("span",X,N(he.estimatedTime),1)])])]),u(w),d("div",ee,[a[18]||(a[18]=d("h4",null,"物流轨迹",-1)),u(ne,null,{default:p(()=>[(c(!0),o(y,null,h(Ne.value,(e,a)=>{return c(),m(re,{key:a,timestamp:e.time,type:e.type,icon:(s=e.status,{"已签收":I,"派送中":P,"运输中":P,"已发货":P,"异常":O}[s]||P)},{default:p(()=>[d("div",ae,[d("h5",null,N(e.status),1),d("p",null,N(e.description),1),d("div",se,[e.location?(c(),o("div",te,[u(D,null,{default:p(()=>[u(g(A))]),_:1}),d("span",null,N(e.location),1)])):k("",!0),e.operator?(c(),o("div",ie,[u(D,null,{default:p(()=>[u(g(C))]),_:1}),d("span",null,N(e.operator),1)])):k("",!0)])])]),_:2},1032,["timestamp","type","icon"]);var s}),128))]),_:1})])]),_:1})):(c(),m(oe,{key:1,description:"请输入物流单号查询轨迹信息"})),u(ce,{modelValue:pe.value,"onUpdate:modelValue":a[5]||(a[5]=e=>pe.value=e),title:"批量查询",width:"600px"},{footer:p(()=>[d("span",le,[u(s,{onClick:a[4]||(a[4]=e=>pe.value=!1)},{default:p(()=>[...a[19]||(a[19]=[v("取消",-1)])]),_:1}),u(s,{onClick:Ae,type:"primary",loading:me.value},{default:p(()=>[...a[20]||(a[20]=[v(" 批量查询 ",-1)])]),_:1},8,["loading"])])]),default:p(()=>[u(b,{model:ye,"label-width":"100px"},{default:p(()=>[u(i,{label:"物流单号"},{default:p(()=>[u(t,{modelValue:ye.trackingNos,"onUpdate:modelValue":a[2]||(a[2]=e=>ye.trackingNos=e),type:"textarea",rows:6,placeholder:"请输入物流单号，每行一个"},null,8,["modelValue"])]),_:1}),u(i,{label:"物流公司"},{default:p(()=>[u(r,{modelValue:ye.company,"onUpdate:modelValue":a[3]||(a[3]=e=>ye.company=e),placeholder:"请选择物流公司",style:{width:"100%"}},{default:p(()=>[(c(!0),o(y,null,h(ke.value,e=>(c(),m(l,{key:e.code,label:e.name,value:e.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-4037f9d1"]]);export{re as default};
