import{l as e,aA as a,r as t,e as r,w as l,b as s,n as i,Y as n,ag as d,aq as o,m as c,q as u,p as v,U as p,O as m,u as g,T as f,J as y,M as h,S as w,P as b,F as T,a9 as D,Q as _}from"./vendor-BtukhyiH.js";import{o as k,P as S,d as x,R as C,a9 as N,T as O,I as z,F as M,G as A,r as I,E as Y}from"./elementPlus-DxaqjplL.js";import{u as F,d as $,c as V,_ as L}from"./index-BGtT17ll.js";import{u as U}from"./service-CQY3-CML.js";import{i as j}from"./utils-DfI7e5Rl.js";import"./env-DLalhsF6.js";const P={class:"service-data-container"},B={class:"metrics-grid"},E={class:"metric-card"},W={class:"metric-icon"},q={class:"metric-content"},G={class:"metric-value"},J={class:"metric-card"},Q={class:"metric-icon refund"},R={class:"metric-content"},X={class:"metric-value"},H={class:"metric-card"},K={class:"metric-icon today"},Z={class:"metric-content"},ee={class:"metric-value"},ae={class:"metric-card"},te={class:"metric-icon pending"},re={class:"metric-content"},le={class:"metric-value"},se={class:"metric-card"},ie={class:"metric-icon urgent"},ne={class:"metric-content"},de={class:"metric-value"},oe={class:"charts-section"},ce={class:"chart-row"},ue={class:"chart-card"},ve={class:"chart-header"},pe={class:"chart-card"},me={class:"chart-row"},ge={class:"chart-card"},fe={class:"chart-card"},ye={class:"orders-section"},he={class:"quick-filters"},we={class:"section-header"},be={class:"section-actions"},Te={class:"pagination-wrapper"},De=L(e({__name:"Data",setup(e){const L=a(),De=V(L),_e=U(),ke=F(),Se=$(),xe=new Date,Ce=`${xe.getFullYear()}-${String(xe.getMonth()+1).padStart(2,"0")}-${String(xe.getDate()).padStart(2,"0")}`,Ne=t([Ce,Ce]),Oe=t(!1),ze=t(""),Me=t(""),Ae=t("30days"),Ie=t(1),Ye=t(20),Fe=t(0),$e=t("today"),Ve=[{label:"今日",value:"today"},{label:"昨日",value:"yesterday"},{label:"本周",value:"thisWeek"},{label:"上周",value:"lastWeek"},{label:"近7天",value:"last7Days"},{label:"本月",value:"thisMonth"},{label:"今年",value:"thisYear"},{label:"全部",value:"all"}],Le=t(),Ue=t(),je=t(),Pe=t();let Be=null,Ee=null,We=null,qe=null;const Ge=r(()=>{const e=Je(),a=(new Date).toISOString().slice(0,10),t=e.length,r=e.filter(e=>e.createTime.slice(0,10)===a).length,l=e.filter(e=>"pending"===e.status).length,s=e.filter(e=>"urgent"===e.priority).length,i=e.filter(e=>"return"===e.serviceType||"refund"===e.serviceType).reduce((e,a)=>e+(a.price||0),0),n=t>0?20*Math.random()-10:0,d=r>0?30*Math.random()-15:0,o=l>0?25*Math.random()-12.5:0,c=s>0?40*Math.random()-20:0,u=i>0?15*Math.random()-7.5:0;return{totalOrders:t,ordersTrend:Number(n.toFixed(1)),refundAmount:i,refundTrend:Number(u.toFixed(1)),todayOrders:r,todayTrend:Number(d.toFixed(1)),pendingOrders:l,pendingTrend:Number(o.toFixed(1)),urgentOrders:s,urgentTrend:Number(c.toFixed(1))}}),Je=()=>{const e=ke.currentUser;if(!e)return[];let a=_e.services;if(Ne.value&&2===Ne.value.length){const[e,t]=Ne.value;a=a.filter(a=>{const r=a.createTime.slice(0,10);return r>=e&&r<=t})}return"admin"===e.role?a:"manager"===e.role||"department_manager"===e.role?a.filter(a=>a.department?a.department===e.department||a.department===e.departmentId:a.createdBy===e.id||a.assignedTo===e.name||a.assignedTo===e.id||a.handlerId===e.id):"customer_service"===e.role?a.filter(a=>a.createdBy===e.id||a.assignedTo===e.name||a.assignedTo===e.id||a.handlerId===e.id||a.handlerName===e.name):"sales_staff"===e.role?a.filter(a=>a.createdBy===e.id||a.salesPersonId===e.id||a.salesPerson===e.name||a.assignedTo===e.name||a.assignedTo===e.id):a.filter(a=>a.createdBy===e.id||a.assignedTo===e.name||a.assignedTo===e.id)},Qe=r(()=>Je().map(e=>({id:e.id,orderNo:e.serviceNumber,originalOrderNo:e.orderNumber,customerName:e.customerName,productName:e.productName||"未知商品",serviceType:e.serviceType,amount:e.price||0,status:e.status,priority:e.priority,createTime:e.createTime,updateTime:e.updateTime||e.createTime}))),Re=r(()=>{let e=Qe.value;return ze.value&&(e=e.filter(e=>e.orderNo.toLowerCase().includes(ze.value.toLowerCase())||e.customerName.includes(ze.value)||e.originalOrderNo.toLowerCase().includes(ze.value.toLowerCase()))),Me.value&&(e=e.filter(e=>e.status===Me.value)),Fe.value=e.length,e.slice((Ie.value-1)*Ye.value,Ie.value*Ye.value)}),Xe=e=>{console.log("日期范围变更:",e),Ze(),da()},He=()=>{Y.success("数据导出功能开发中...")},Ke=async()=>{Oe.value=!0;try{await Ze(),da(),Y.success("数据已刷新")}catch(e){Y.error("数据刷新失败")}finally{Oe.value=!1}},Ze=async()=>{try{await _e.loadAfterSalesServices()}catch(e){console.error("加载售后数据失败:",e)}},ea=()=>{Ie.value=1},aa=()=>{Ie.value=1},ta=e=>{Ye.value=e,Ie.value=1},ra=e=>{Ie.value=e},la=e=>({return:"退货",exchange:"换货",repair:"维修",refund:"退款"}[e]||e),sa=e=>({pending:"待处理",processing:"处理中",resolved:"已解决",closed:"已关闭"}[e]||e),ia=()=>{console.log("更新趋势图:",Ae.value),na()},na=()=>{if(!Le.value)return;Be&&Be.dispose(),Be=j(Le.value);const e=Je();let a=[],t=0;switch(Ae.value){case"7days":t=7,a=Array.from({length:t},(e,a)=>{const r=new Date;return r.setDate(r.getDate()-(t-1)+a),r.toISOString().slice(5,10)});break;case"30days":t=30,a=Array.from({length:t},(e,a)=>{const r=new Date;return r.setDate(r.getDate()-(t-1)+a),r.toISOString().slice(5,10)});break;case"3months":t=90,a=Array.from({length:t},(e,a)=>{const r=new Date;return r.setDate(r.getDate()-(t-1)+a),r.toISOString().slice(5,10)});break;case"6months":t=180,a=Array.from({length:t},(e,a)=>{const r=new Date;return r.setDate(r.getDate()-(t-1)+a),r.toISOString().slice(5,10)});break;default:t=7,a=Array.from({length:t},(e,a)=>{const r=new Date;return r.setDate(r.getDate()-(t-1)+a),r.toISOString().slice(5,10)})}const r=a.map(a=>e.filter(e=>e.createTime.slice(5,10)===a).length);let l=a;if(t>30){const e=Math.ceil(t/10);l=a.map((a,t)=>t%e===0?a:"")}const s={title:{text:"售后订单趋势",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:e=>{const t=e[0].dataIndex;return`${a[t]}: ${e[0].value}个订单`}},xAxis:{type:"category",data:l,axisLabel:{rotate:t>30?45:0}},yAxis:{type:"value"},series:[{data:r,type:"line",smooth:!0,itemStyle:{color:"#409EFF"}}]};Be.setOption(s)},da=()=>{i(()=>{na(),(()=>{if(!Ue.value)return;Ee&&Ee.dispose(),Ee=j(Ue.value);const e=Je(),a={title:{text:"售后类型分布",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"item"},series:[{type:"pie",radius:"60%",data:[{name:"退货",value:e.filter(e=>"return"===e.serviceType).length},{name:"换货",value:e.filter(e=>"exchange"===e.serviceType).length},{name:"维修",value:e.filter(e=>"repair"===e.serviceType).length},{name:"退款",value:e.filter(e=>"refund"===e.serviceType).length}],emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};Ee.setOption(a)})(),(()=>{if(!je.value)return;We&&We.dispose(),We=j(je.value);const e=Je().filter(e=>"resolved"===e.status||"closed"===e.status),a=[0,0,0,0,0];e.forEach(e=>{const t=new Date(e.createTime),r=new Date(e.updateTime||e.createTime),l=Math.ceil((r-t)/864e5);l<=1?a[0]++:l<=3?a[1]++:l<=7?a[2]++:l<=15?a[3]++:a[4]++});const t={title:{text:"处理时长分析",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}: {c}个订单"},xAxis:{type:"category",data:["0-1天","1-3天","3-7天","7-15天","15天以上"]},yAxis:{type:"value"},series:[{data:a,type:"bar",itemStyle:{color:"#67C23A"}}]};We.setOption(t)})(),(()=>{if(!Pe.value)return;qe&&qe.dispose(),qe=j(Pe.value);const e=Je().filter(e=>"return"===e.serviceType||"refund"===e.serviceType),a=Array.from({length:7},(e,a)=>{const t=new Date;return t.setDate(t.getDate()-6+a),t.toISOString().slice(5,10)}),t=a.map(a=>e.filter(e=>e.createTime.slice(5,10)===a).reduce((e,a)=>e+(a.price||0),0)),r={title:{text:"退款金额趋势",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}: ¥{c}"},xAxis:{type:"category",data:a},yAxis:{type:"value"},series:[{data:t,type:"line",smooth:!0,itemStyle:{color:"#F56C6C"}}]};qe.setOption(r)})()})};l(()=>_e.services,()=>{da()},{deep:!0});const oa=()=>{Be?.resize(),Ee?.resize(),We?.resize(),qe?.resize()};return s(async()=>{await Ze(),i(()=>{da(),window.addEventListener("resize",oa)})}),n(()=>{window.removeEventListener("resize",oa),Be?.dispose(),Ee?.dispose(),We?.dispose(),qe?.dispose()}),(e,a)=>{const t=d("el-icon"),r=d("el-option"),l=d("el-select"),s=d("el-button"),i=d("el-date-picker"),n=d("el-input"),F=d("el-table-column"),$=d("el-link"),V=d("el-tag"),L=d("el-table"),U=d("el-pagination"),j=o("loading");return u(),c("div",P,[a[24]||(a[24]=v("div",{class:"page-header"},[v("h1",{class:"page-title"},"售后数据看板")],-1)),v("div",B,[v("div",E,[v("div",W,[p(t,null,{default:m(()=>[p(g(k))]),_:1})]),v("div",q,[v("div",G,f(Ge.value.totalOrders),1),a[6]||(a[6]=v("div",{class:"metric-label"},"售后订单数量",-1)),v("div",{class:y(["metric-trend",{positive:Ge.value.ordersTrend>0,negative:Ge.value.ordersTrend<0}])},[Ge.value.ordersTrend>0?(u(),h(t,{key:0},{default:m(()=>[p(g(S))]),_:1})):(u(),h(t,{key:1},{default:m(()=>[p(g(x))]),_:1})),w(" "+f(Math.abs(Ge.value.ordersTrend))+"% ",1)],2)])]),v("div",J,[v("div",Q,[p(t,null,{default:m(()=>[p(g(C))]),_:1})]),v("div",R,[v("div",X,"¥"+f(Ge.value.refundAmount.toLocaleString()),1),a[7]||(a[7]=v("div",{class:"metric-label"},"已退款金额",-1)),v("div",{class:y(["metric-trend",{positive:Ge.value.refundTrend>0,negative:Ge.value.refundTrend<0}])},[Ge.value.refundTrend>0?(u(),h(t,{key:0},{default:m(()=>[p(g(S))]),_:1})):(u(),h(t,{key:1},{default:m(()=>[p(g(x))]),_:1})),w(" "+f(Math.abs(Ge.value.refundTrend))+"% ",1)],2)])]),v("div",H,[v("div",K,[p(t,null,{default:m(()=>[p(g(N))]),_:1})]),v("div",Z,[v("div",ee,f(Ge.value.todayOrders),1),a[8]||(a[8]=v("div",{class:"metric-label"},"今日售后单",-1)),v("div",{class:y(["metric-trend",{positive:Ge.value.todayTrend>0,negative:Ge.value.todayTrend<0}])},[Ge.value.todayTrend>0?(u(),h(t,{key:0},{default:m(()=>[p(g(S))]),_:1})):(u(),h(t,{key:1},{default:m(()=>[p(g(x))]),_:1})),w(" "+f(Math.abs(Ge.value.todayTrend))+"% ",1)],2)])]),v("div",ae,[v("div",te,[p(t,null,{default:m(()=>[p(g(O))]),_:1})]),v("div",re,[v("div",le,f(Ge.value.pendingOrders),1),a[9]||(a[9]=v("div",{class:"metric-label"},"待处理",-1)),v("div",{class:y(["metric-trend",{positive:Ge.value.pendingTrend>0,negative:Ge.value.pendingTrend<0}])},[Ge.value.pendingTrend>0?(u(),h(t,{key:0},{default:m(()=>[p(g(S))]),_:1})):(u(),h(t,{key:1},{default:m(()=>[p(g(x))]),_:1})),w(" "+f(Math.abs(Ge.value.pendingTrend))+"% ",1)],2)])]),v("div",se,[v("div",ie,[p(t,null,{default:m(()=>[p(g(z))]),_:1})]),v("div",ne,[v("div",de,f(Ge.value.urgentOrders),1),a[10]||(a[10]=v("div",{class:"metric-label"},"紧急订单",-1)),v("div",{class:y(["metric-trend",{positive:Ge.value.urgentTrend>0,negative:Ge.value.urgentTrend<0}])},[Ge.value.urgentTrend>0?(u(),h(t,{key:0},{default:m(()=>[p(g(S))]),_:1})):(u(),h(t,{key:1},{default:m(()=>[p(g(x))]),_:1})),w(" "+f(Math.abs(Ge.value.urgentTrend))+"% ",1)],2)])])]),v("div",oe,[v("div",ce,[v("div",ue,[v("div",ve,[a[11]||(a[11]=v("h3",null,"售后订单趋势",-1)),p(l,{modelValue:Ae.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Ae.value=e),onChange:ia},{default:m(()=>[p(r,{label:"最近7天",value:"7days"}),p(r,{label:"最近30天",value:"30days"}),p(r,{label:"最近3个月",value:"3months"}),p(r,{label:"最近6个月",value:"6months"})]),_:1},8,["modelValue"])]),v("div",{class:"chart-content",ref_key:"trendChart",ref:Le},null,512)]),v("div",pe,[a[12]||(a[12]=v("div",{class:"chart-header"},[v("h3",null,"售后类型分布")],-1)),v("div",{class:"chart-content",ref_key:"typeChart",ref:Ue},null,512)])]),v("div",me,[v("div",ge,[a[13]||(a[13]=v("div",{class:"chart-header"},[v("h3",null,"处理时长分析")],-1)),v("div",{class:"chart-content",ref_key:"durationChart",ref:je},null,512)]),v("div",fe,[a[14]||(a[14]=v("div",{class:"chart-header"},[v("h3",null,"退款金额趋势")],-1)),v("div",{class:"chart-content",ref_key:"refundChart",ref:Pe},null,512)])])]),v("div",ye,[v("div",he,[(u(),c(T,null,D(Ve,e=>p(s,{key:e.value,type:$e.value===e.value?"primary":"",onClick:a=>(e=>{$e.value=e;const a=new Date;let t,r=new Date(a);switch(e){case"today":t=new Date(a);break;case"yesterday":t=new Date(a),t.setDate(a.getDate()-1),r=new Date(t);break;case"thisWeek":t=new Date(a),t.setDate(a.getDate()-a.getDay());break;case"lastWeek":t=new Date(a),t.setDate(a.getDate()-a.getDay()-7),r=new Date(t),r.setDate(t.getDate()+6);break;case"last7Days":t=new Date(a),t.setDate(a.getDate()-6);break;case"thisMonth":t=new Date(a.getFullYear(),a.getMonth(),1);break;case"thisYear":t=new Date(a.getFullYear(),0,1);break;default:t=new Date(2020,0,1),r=new Date(2099,11,31)}const l=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;Ne.value=[l(t),l(r)],Xe(Ne.value)})(e.value),class:"filter-btn"},{default:m(()=>[w(f(e.label),1)]),_:2},1032,["type","onClick"])),64))]),v("div",we,[a[17]||(a[17]=v("h3",null,"售后订单明细",-1)),v("div",be,[p(i,{modelValue:Ne.value,"onUpdate:modelValue":a[1]||(a[1]=e=>Ne.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:Xe,style:{"margin-right":"10px"}},null,8,["modelValue"]),p(n,{modelValue:ze.value,"onUpdate:modelValue":a[2]||(a[2]=e=>ze.value=e),placeholder:"搜索订单号、客户名称",style:{width:"200px","margin-right":"10px"},onInput:ea},{prefix:m(()=>[p(t,null,{default:m(()=>[p(g(M))]),_:1})]),_:1},8,["modelValue"]),p(l,{modelValue:Me.value,"onUpdate:modelValue":a[3]||(a[3]=e=>Me.value=e),placeholder:"状态筛选",onChange:aa,style:{"margin-right":"10px"}},{default:m(()=>[p(r,{label:"全部",value:""}),p(r,{label:"待处理",value:"pending"}),p(r,{label:"处理中",value:"processing"}),p(r,{label:"已解决",value:"resolved"}),p(r,{label:"已关闭",value:"closed"})]),_:1},8,["modelValue"]),p(s,{type:"primary",onClick:He},{default:m(()=>[p(t,null,{default:m(()=>[p(g(A))]),_:1}),a[15]||(a[15]=w(" 导出数据 ",-1))]),_:1}),p(s,{onClick:Ke},{default:m(()=>[p(t,null,{default:m(()=>[p(g(I))]),_:1}),a[16]||(a[16]=w(" 刷新 ",-1))]),_:1})])]),b((u(),h(L,{data:Re.value,stripe:""},{default:m(()=>[p(F,{prop:"orderNo",label:"售后单号",width:"160","show-overflow-tooltip":""}),p(F,{prop:"originalOrderNo",label:"原订单号",width:"160","show-overflow-tooltip":""},{default:m(({row:e})=>[p($,{type:"primary",onClick:a=>(e=>{const a=Se.orders.find(a=>a.orderNumber===e.originalOrderNo);a?De.push(`/order/detail/${a.id}`):Y.warning("未找到对应的订单信息")})(e)},{default:m(()=>[w(f(e.originalOrderNo),1)]),_:2},1032,["onClick"])]),_:1}),p(F,{prop:"customerName",label:"客户姓名",width:"120","show-overflow-tooltip":""},{default:m(({row:e})=>[p($,{type:"primary",onClick:a=>(e=>{const a=_e.services.find(a=>a.id===e.id);a&&a.customerId?De.push(`/customer/detail/${a.customerId}`):Y.warning("未找到对应的客户信息")})(e)},{default:m(()=>[w(f(e.customerName),1)]),_:2},1032,["onClick"])]),_:1}),p(F,{prop:"serviceType",label:"售后类型",width:"110"},{default:m(({row:e})=>{return[p(V,{type:(a=e.serviceType,{return:"danger",exchange:"warning",repair:"info",refund:"success"}[a]||"info")},{default:m(()=>[w(f(la(e.serviceType)),1)]),_:2},1032,["type"])];var a}),_:1}),p(F,{prop:"amount",label:"涉及金额",width:"110",align:"right"},{default:m(({row:e})=>[w(" ¥"+f(e.amount.toLocaleString()),1)]),_:1}),p(F,{prop:"status",label:"状态",width:"100"},{default:m(({row:e})=>{return[p(V,{type:(a=e.status,{pending:"warning",processing:"primary",resolved:"success",closed:"info"}[a]||"info")},{default:m(()=>[w(f(sa(e.status)),1)]),_:2},1032,["type"])];var a}),_:1}),p(F,{prop:"priority",label:"优先级",width:"90"},{default:m(({row:e})=>["urgent"===e.priority?(u(),h(V,{key:0,type:"danger",size:"small"},{default:m(()=>[...a[18]||(a[18]=[w("紧急",-1)])]),_:1})):"high"===e.priority?(u(),h(V,{key:1,type:"warning",size:"small"},{default:m(()=>[...a[19]||(a[19]=[w("高",-1)])]),_:1})):(u(),h(V,{key:2,type:"info",size:"small"},{default:m(()=>[...a[20]||(a[20]=[w("普通",-1)])]),_:1}))]),_:1}),p(F,{prop:"createTime",label:"创建时间",width:"160","show-overflow-tooltip":""}),p(F,{prop:"updateTime",label:"更新时间",width:"160","show-overflow-tooltip":""}),p(F,{prop:"productName",label:"商品名称","min-width":"180","show-overflow-tooltip":""}),p(F,{label:"操作",width:"200",fixed:"right"},{default:m(({row:e})=>[p(s,{type:"primary",size:"small",onClick:a=>(e=>{De.push(`/service/detail/${e.id}`)})(e)},{default:m(()=>[...a[21]||(a[21]=[w("查看",-1)])]),_:1},8,["onClick"]),"pending"===e.status?(u(),h(s,{key:0,type:"success",size:"small",onClick:a=>(async e=>{try{await _e.updateServiceStatus(e.id,"processing","开始处理"),Y.success(`开始处理订单 ${e.orderNo}`),await Ze()}catch(a){Y.error("处理失败")}})(e)},{default:m(()=>[...a[22]||(a[22]=[w("处理",-1)])]),_:1},8,["onClick"])):_("",!0),"pending"===e.status||"processing"===e.status?(u(),h(s,{key:1,type:"warning",size:"small",onClick:a=>(e=>{De.push(`/service/edit/${e.id}`)})(e)},{default:m(()=>[...a[23]||(a[23]=[w("编辑",-1)])]),_:1},8,["onClick"])):_("",!0)]),_:1})]),_:1},8,["data"])),[[j,Oe.value]]),v("div",Te,[p(U,{"current-page":Ie.value,"onUpdate:currentPage":a[4]||(a[4]=e=>Ie.value=e),"page-size":Ye.value,"onUpdate:pageSize":a[5]||(a[5]=e=>Ye.value=e),"page-sizes":[10,20,50,100],total:Fe.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ta,onCurrentChange:ra},null,8,["current-page","page-size","total"])])])])}}}),[["__scopeId","data-v-02844357"]]);export{De as default};
