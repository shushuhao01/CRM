const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/uploadService-rJoD_mJD.js","assets/index-BGtT17ll.js","assets/vendor-BtukhyiH.js","assets/elementPlus-DxaqjplL.js","assets/utils-DfI7e5Rl.js","assets/index-Cj-RrGL6.css"])))=>i.map(i=>d[i]);
import{_ as e,d as a,i as l,u as t,b as o,a as s,S as r,c as d,l as u}from"./index-BGtT17ll.js";import{l as n,e as i,ag as c,M as m,Q as p,q as v,O as f,U as h,m as y,F as g,a9 as b,S as _,T as k,p as V,u as w,aA as x,aC as C,r as A,Z as T,b as U,a8 as q,a2 as S,P as $,V as F}from"./vendor-BtukhyiH.js";import{s as M,E as I,m as D,C as N,J as P,u as O,F as z,Z as K,N as j,r as Y,A as B,e as E,_ as W,$ as R,R as H,a0 as L,b as Z}from"./elementPlus-DxaqjplL.js";import{u as J}from"./product-BpGlv1tT.js";import{u as Q}from"./orderFieldConfig-DyZNi40x.js";import{m as G}from"./phone-CSnHMTQT.js";import{d as X}from"./sensitiveInfo-PTigg6SS.js";import"./utils-DfI7e5Rl.js";import"./env-DLalhsF6.js";const ee={class:"card-header"},ae=e(n({__name:"CustomFieldsCard",props:{modelValue:{},show:{type:Boolean}},emits:["update:modelValue"],setup(e){const a=e,l=Q(),t=i(()=>l.customFields.length>0),o=i(()=>t.value&&!1!==a.show),s=i(()=>[...l.customFields].sort((e,a)=>e.sortOrder-a.sortOrder)),r=e=>{switch(e){case"text":case"select":case"datetime":default:return 8;case"number":case"date":return 6;case"radio":case"checkbox":return 12}};return(a,l)=>{const t=c("el-icon"),d=c("el-input"),u=c("el-input-number"),n=c("el-date-picker"),i=c("el-option"),x=c("el-select"),C=c("el-radio"),A=c("el-radio-group"),T=c("el-checkbox"),U=c("el-checkbox-group"),q=c("el-form-item"),S=c("el-col"),$=c("el-row"),F=c("el-card");return o.value?(v(),m(F,{key:0,class:"custom-fields-card"},{header:f(()=>[V("div",ee,[h(t,null,{default:f(()=>[h(w(M))]),_:1}),l[0]||(l[0]=V("span",null,"自定义字段",-1))])]),default:f(()=>[h($,{gutter:20},{default:f(()=>[(v(!0),y(g,null,b(s.value,a=>(v(),m(S,{key:a.id,span:r(a.fieldType)},{default:f(()=>[h(q,{label:a.fieldName,prop:`customFields.${a.fieldKey}`,required:a.required},{default:f(()=>["text"===a.fieldType?(v(),m(d,{key:0,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l,placeholder:a.placeholder||`请输入${a.fieldName}`,clearable:""},null,8,["modelValue","onUpdate:modelValue","placeholder"])):"number"===a.fieldType?(v(),m(u,{key:1,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l,placeholder:a.placeholder||`请输入${a.fieldName}`,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])):"date"===a.fieldType?(v(),m(n,{key:2,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l,type:"date",placeholder:a.placeholder||`请选择${a.fieldName}`,style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):"datetime"===a.fieldType?(v(),m(n,{key:3,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l,type:"datetime",placeholder:a.placeholder||`请选择${a.fieldName}`,style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):"select"===a.fieldType?(v(),m(x,{key:4,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l,placeholder:a.placeholder||`请选择${a.fieldName}`,style:{width:"100%"},clearable:""},{default:f(()=>[(v(!0),y(g,null,b(a.options,e=>(v(),m(i,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):"radio"===a.fieldType?(v(),m(A,{key:5,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l},{default:f(()=>[(v(!0),y(g,null,b(a.options,e=>(v(),m(C,{key:e.value,label:e.value},{default:f(()=>[_(k(e.label),1)]),_:2},1032,["label"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):"checkbox"===a.fieldType?(v(),m(U,{key:6,modelValue:e.modelValue[a.fieldKey],"onUpdate:modelValue":l=>e.modelValue[a.fieldKey]=l},{default:f(()=>[(v(!0),y(g,null,b(a.options,e=>(v(),m(T,{key:e.value,label:e.value},{default:f(()=>[_(k(e.label),1)]),_:2},1032,["label"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):p("",!0)]),_:2},1032,["label","prop","required"])]),_:2},1032,["span"]))),128))]),_:1})]),_:1})):p("",!0)}}}),[["__scopeId","data-v-a13f9bfe"]]),le={class:"order-form"},te={class:"page-header"},oe={class:"card-header"},se={class:"header-left"},re={key:0,class:"delivery-info"},de={class:"phone-management"},ue={class:"card-header"},ne={class:"header-left"},ie={class:"product-search"},ce={class:"product-list"},me=["onClick"],pe={class:"product-image"},ve=["src","alt"],fe={class:"product-info"},he={class:"product-name"},ye={class:"product-price"},ge={class:"product-stock"},be={class:"product-actions"},_e={class:"card-header"},ke={class:"header-left"},Ve={key:0,class:"selected-products"},we={class:"amount-summary-modern"},xe={class:"amount-row"},Ce={class:"amount-field"},Ae={class:"field-amount subtotal"},Te={class:"amount-field"},Ue={class:"field-label"},qe={class:"amount-field"},Se={class:"amount-field"},$e={class:"payment-method-wrapper"},Fe={class:"amount-row"},Me={class:"amount-field"},Ie={class:"field-amount collect"},De={class:"amount-field"},Ne={class:"discount-horizontal"},Pe={class:"field-amount discount"},Oe={key:0,class:"discount-percent"},ze={class:"amount-field screenshot-field"},Ke={class:"screenshot-buttons"},je={class:"screenshot-content"},Ye={key:0,class:"screenshot-thumbnails"},Be=["onMouseenter","onClick"],Ee=["src"],We={class:"thumbnail-overlay"},Re=["onClick"],He={class:"mark-section"},Le={class:"mark-description"},Ze={class:"remark-section"},Je={class:"form-footer"},Qe={class:"order-confirm"},Ge={class:"confirm-section customer-info"},Xe={class:"info-grid"},ea={class:"info-item"},aa={class:"value"},la={class:"info-item"},ta={class:"value"},oa={class:"info-item"},sa={class:"value"},ra={class:"info-item"},da={class:"value"},ua={class:"info-item"},na={class:"value"},ia={class:"confirm-section order-mark"},ca={class:"mark-content"},ma={class:"mark-item"},pa={key:0,class:"mark-note"},va={class:"confirm-section amount-info"},fa={class:"amount-summary-two-columns"},ha={class:"amount-column basic-amounts"},ya={class:"amount-item"},ga={class:"value"},ba={class:"amount-item"},_a={class:"discount-info"},ka={class:"value discount"},Va={key:0,class:"discount-percent"},wa={class:"amount-column important-amounts"},xa={class:"amount-item highlight total-amount"},Ca={class:"value"},Aa={class:"amount-item highlight deposit-amount"},Ta={class:"value"},Ua={class:"amount-item highlight collect-amount"},qa={class:"value"},Sa={class:"confirm-section product-info"},$a={class:"dialog-footer"},Fa={class:"dialog-footer"},Ma=e(n({__name:"Add",setup(e){const n=x(),M=C(),ee=d(n),Ma=a(),Ia=l(),Da=t(),Na=o(),Pa=s(),Oa=J(),za=Q(),Ka=A(),ja=A(!1),Ya=A(!1),Ba=A(!1),Ea=A(!1),Wa=A(!1),Ra=A(!1),Ha=A(""),La=A(!1),Za=A([]),Ja=A([]),Qa=A(!1),Ga=i(()=>Ia.customers),Xa=i(()=>{const e=JSON.parse(localStorage.getItem("crm_product_price_config")||"{}");return Oa.products.filter(e=>"active"===e.status&&!e.isDeleted&&e.stock>0).map(a=>{let l=a.price;if(e.enabled&&e.products&&e.products[a.id]){const t=e.products[a.id].price;null!=t&&(l=t)}return{id:a.id,name:a.name,code:a.code,price:l,originalPrice:a.price,stock:a.stock,category:a.category,image:a.image,isHot:a.isHot}})}),el=A(null),al=A([]),ll=A(!1),tl=A(),ol=A(!1),sl=T({phone:"",remark:""}),rl={phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"blur"}]},dl=T({customerId:"",serviceWechat:"",orderSource:"",receiverName:"",receiverPhone:"",receiverAddress:"",expressCompany:"",products:[],discount:0,totalAmount:0,depositAmount:0,depositScreenshot:"",paymentMethod:"",paymentMethodOther:"",markType:"normal",remark:"",customFields:{}}),ul=A([{label:"微信支付",value:"wechat"},{label:"支付宝支付",value:"alipay"},{label:"银行转账",value:"bank_transfer"},{label:"云闪付",value:"unionpay"},{label:"货到付款",value:"cod"},{label:"其他",value:"other"}]),nl=e=>{"other"!==e&&(dl.paymentMethodOther="")},il={customerId:[{required:!0,message:"请选择客户",trigger:"change"}],serviceWechat:[{required:!0,message:"请输入客服微信号",trigger:"blur"}],orderSource:[{required:!0,message:"请选择订单来源",trigger:"change"}],expressCompany:[{required:!0,message:"请选择快递公司",trigger:"change"}],receiverName:[{required:!0,message:"请输入收货人姓名",trigger:"blur"}],receiverPhone:[{required:!0,message:"请输入收货人电话",trigger:"blur"}],receiverAddress:[{required:!0,message:"请输入收货地址",trigger:"blur"}],markType:[{required:!0,message:"请选择订单类型",trigger:"change"}]},cl=A([]),ml=A(-1),pl=i(()=>{const e=Da.currentUser?.role||"employee",a="employee"===e?"sales":e;let l=0;return l="admin"===a||"super_admin"===a?Pa.productConfig.adminMaxDiscount:"department_manager"===a||"manager"===a?Pa.productConfig.managerMaxDiscount:"sales"===a?Pa.productConfig.salesMaxDiscount:0,console.log("[优惠折扣] 当前角色:",e,"映射角色:",a,"优惠比例:",l,"%"),console.log("[优惠折扣] 配置详情:",{admin:Pa.productConfig.adminMaxDiscount,manager:Pa.productConfig.managerMaxDiscount,sales:Pa.productConfig.salesMaxDiscount}),l/100}),vl=A(!1),fl=i(()=>dl.products.reduce((e,a)=>e+(a.price||0)*(a.quantity||0),0)),hl=i(()=>(dl.totalAmount||0)-(dl.depositAmount||0)),yl=i(()=>fl.value-(dl.totalAmount||0)),gl=i(()=>0===fl.value?0:yl.value/fl.value*100);i(()=>fl.value*(1-pl.value));const bl=i(()=>Ha.value?Xa.value.filter(e=>e.name.toLowerCase().includes(Ha.value.toLowerCase())):Xa.value);A("");const _l=e=>{e&&(ja.value=!0,setTimeout(()=>{ja.value=!1},300))},kl=e=>{const a=Ga.value.find(a=>a.id===e);a&&(el.value=a,dl.receiverName=a.name,dl.receiverAddress=a.address,Vl())},Vl=async e=>{try{const e=[{id:1,number:el.value?.phone||"",remark:"默认手机号",isDefault:!0}];al.value=e,e.length>0&&(dl.receiverPhone=e[0].number)}catch(a){I.error("加载客户手机号失败")}},wl=async()=>{try{await tl.value.validate(),ol.value=!0,setTimeout(()=>{const e={id:Date.now(),number:sl.phone,remark:sl.remark||"新增手机号",isDefault:!1};al.value.push(e),sl.phone="",sl.remark="",ll.value=!1,ol.value=!1,I.success("手机号添加成功")},1e3)}catch(e){ol.value=!1}},xl=()=>{sl.phone="",sl.remark="",ll.value=!1},Cl=()=>{el.value&&(dl.receiverAddress=el.value.address,I.success("已同步客户地址"))},Al=()=>{},Tl=async()=>{try{Ya.value=!0,await Oa.refreshProducts(),I.success("商品列表已刷新，已同步在售产品")}catch(e){I.error("刷新商品列表失败，请检查网络连接"),console.error("刷新商品失败:",e)}finally{Ya.value=!1}},Ul=()=>{dl.products.forEach(e=>{e.total=e.price*e.quantity}),vl.value||(dl.totalAmount=fl.value)},ql=()=>{},Sl=e=>{if(null==e)return;vl.value=!0;const a=fl.value*(1-pl.value),l=(100*pl.value).toFixed(0);return console.log("[订单总额变更] 详细信息:",{"修改后的值":e,"商品小计":fl.value,"最大优惠比例":pl.value,"优惠百分比显示":l,"最低允许金额":a}),e<a?(dl.totalAmount=a,void Z.alert(`订单总额不能低于 ¥${a.toFixed(2)}（最大优惠${l}%）`,"优惠限制提示",{confirmButtonText:"确定",type:"warning"})):e>fl.value?(dl.totalAmount=fl.value,void Z.alert("订单总额不能超过商品小计","提示",{confirmButtonText:"确定",type:"warning"})):void(dl.depositAmount>e&&(dl.depositAmount=e,I.info("定金已自动调整为订单总额")))},$l=()=>{vl.value=!1,dl.totalAmount=fl.value,I.success("订单总额已同步为商品小计")},Fl=A(),Ml=()=>{Fl.value?.click()},Il=e=>{const a=e.target,l=a.files;if(l){for(let e=0;e<l.length;e++){if(cl.value.length>=3){I.warning("最多只能上传3张图片");break}Nl(l[e])}a.value=""}},Dl=async()=>{if(cl.value.length>=3)I.warning("最多只能上传3张图片");else try{const e=await navigator.clipboard.read();for(const a of e)for(const e of a.types)if(e.startsWith("image/")){const l=await a.getType(e),t=new File([l],"pasted-image.png",{type:e});return void Nl(t)}I.warning("剪贴板中没有图片")}catch(e){I.error("粘贴图片失败，请检查浏览器权限")}},Nl=async e=>{if(Pl(e))if(cl.value.length>=3)I.warning("最多只能上传3张图片");else try{const{uploadImage:a}=await u(async()=>{const{uploadImage:e}=await import("./uploadService-rJoD_mJD.js");return{uploadImage:e}},__vite__mapDeps([0,1,2,3,4,5])),l=await a(e,"order");l.success&&l.url?(cl.value.push(l.url),dl.depositScreenshot=cl.value[0]||"",I.success("图片上传成功")):I.error(l.message||"图片上传失败")}catch(a){console.error("图片上传失败:",a),I.error("图片上传失败，请重试")}},Pl=e=>{const a=e.type.startsWith("image/"),l=e.size/1024/1024<2;return a?!!l||(I.error("图片大小不能超过 2MB!"),!1):(I.error("只能上传图片文件!"),!1)},Ol=e=>{"reserved"===e?I.info("已选择预留单，订单将保留在您处，不会流转到审核员"):I.info("已选择正常发货单，订单将按正常流程进行审核")},zl=async()=>{try{if(await Ka.value.validate(),0===dl.products.length)return void I.warning("请至少选择一个商品");Wa.value=!0}catch(e){I.error("请完善订单信息")}},Kl=async()=>{try{Ea.value=!0;for(const s of dl.products){const e=Oa.products.find(e=>e.id===s.id);if(!e)return void I.error(`商品 ${s.name} 不存在`);if(e.stock<s.quantity)return void I.error(`商品 ${s.name} 库存不足，当前库存：${e.stock}，需要：${s.quantity}`)}const e=dl.products.reduce((e,a)=>e+(a.price*a.quantity||0),0),a=dl.totalAmount||e-(dl.discount||0),l=a-(dl.depositAmount||0),t={customerId:dl.customerId,customerName:el.value?.name||"",customerPhone:el.value?.phone||"",products:dl.products,subtotal:e,discount:dl.discount,totalAmount:a,collectAmount:l,depositAmount:dl.depositAmount,depositScreenshot:dl.depositScreenshot,depositScreenshots:cl.value.length>0?cl.value:void 0,receiverName:dl.receiverName,receiverPhone:dl.receiverPhone,receiverAddress:dl.receiverAddress,markType:dl.markType,remark:dl.remark,salesPersonId:Da.user?.id||"1",createdBy:Da.user?.name||"系统用户",serviceWechat:dl.serviceWechat,orderSource:dl.orderSource,expressCompany:dl.expressCompany,paymentMethod:dl.paymentMethod,paymentMethodOther:"other"===dl.paymentMethod?dl.paymentMethodOther:""},o=await Ma.createOrder(t);for(const s of dl.products)await Oa.updateProductStock(s.id,-s.quantity);if(t.customerId&&Ia.incrementOrderCount(t.customerId),Na.sendMessage(Na.MessageType.ORDER_SUBMITTED,`新订单已提交：客户 ${t.customerName}，订单金额 ¥${a.toFixed(2)}`,{relatedId:o?.id||Date.now().toString(),relatedType:"order",actionUrl:`/order/detail/${o?.id||Date.now().toString()}`}),"normal"===t.markType){const e=Ma.transferDelayMinutes||3;I.success(`订单已提交，该订单${e}分钟后将流转至审核`)}else"reserved"===t.markType?I.success("预留单已保存，信息将保留在系统中"):I.success("订单已提交");Wa.value=!1,ee.push({path:"/order/list",query:{refresh:"true",timestamp:Date.now().toString()}})}catch(e){I.error("提交失败，请重试")}finally{Ea.value=!1}},jl=()=>{Wa.value=!1},Yl=()=>{n.back()},Bl=e=>{const a=Ja.value.find(a=>a.code===e);if(a)return a.name;return{sf:"顺丰速运",SF:"顺丰速运",yt:"圆通速递",YTO:"圆通速递",zt:"中通快递",ZTO:"中通快递",st:"申通快递",STO:"申通快递",yd:"韵达速递",YD:"韵达速递",bs:"百世快递",db:"德邦快递",jd:"京东物流"}[e]||e};return U(async()=>{await Ia.loadCustomers(),"function"==typeof Ma.loadTransferDelayConfig&&await Ma.loadTransferDelayConfig(),(async()=>{Qa.value=!0;try{const{apiService:e}=await u(async()=>{const{apiService:e}=await import("./index-BGtT17ll.js").then(e=>e.Q);return{apiService:e}},__vite__mapDeps([1,2,3,4,5])),a=await e.get("/logistics/companies/active");a&&Array.isArray(a)&&(Ja.value=a.map(e=>({code:e.code,name:e.shortName||e.name,logo:e.logo})))}catch(e){console.warn("加载物流公司列表失败，使用默认列表:",e),Ja.value=[{code:"SF",name:"顺丰速运"},{code:"YTO",name:"圆通速递"},{code:"ZTO",name:"中通快递"},{code:"STO",name:"申通快递"},{code:"YD",name:"韵达速递"}]}finally{Qa.value=!1}})(),(async()=>{try{const e=localStorage.getItem("auth_token"),a=await fetch("/api/v1/system/payment-methods",{headers:{Authorization:`Bearer ${e}`}}),l=await a.json();l.success&&l.data&&l.data.length>0&&(ul.value=l.data.map(e=>({label:e.label,value:e.value})))}catch(e){console.warn("加载支付方式失败，使用默认配置:",e)}})();try{await Oa.refreshProducts()}catch(s){console.error("加载商品数据失败:",s),0===Oa.products.length&&Oa.initData()}const{customerId:e,customerName:a,customerPhone:l,customerAddress:t,productId:o}=M.query;if(e){let o=Ia.customers.find(a=>a.id===e);o?(dl.customerId=o.id,dl.receiverName=o.name,dl.receiverPhone=o.phone,dl.receiverAddress=o.address||"",el.value=o,I.success(`已自动选择客户：${o.name}`)):a&&l?(dl.customerId=e,dl.receiverName=a,dl.receiverPhone=l,dl.receiverAddress=t||"",o={id:e,name:a,phone:l,address:t||"",age:0,level:"normal",salesPersonId:"",orderCount:0,createTime:"",createdBy:""},el.value=o,I.success(`已自动选择客户：${a}`)):I.warning("未找到指定的客户信息，请手动选择客户")}if(o){const e=Oa.products.find(e=>e.id===o);if(e){const a={id:e.id,name:e.name,price:e.price,quantity:1,total:e.price};dl.products.push(a),I.success(`已自动添加商品：${e.name}`)}else I.warning("未找到指定的商品信息")}}),(e,a)=>{const l=c("el-icon"),t=c("el-option"),o=c("el-select"),s=c("el-form-item"),d=c("el-col"),u=c("el-input"),n=c("el-row"),i=c("el-button"),x=c("el-card"),C=c("el-table-column"),A=c("el-input-number"),T=c("el-table"),U=c("el-tooltip"),M=c("el-tag"),Z=c("el-radio"),J=c("el-radio-group"),Q=c("el-alert"),Ma=c("el-form"),Ia=c("el-dialog");return v(),y("div",le,[V("div",te,[V("h2",null,k(Ra.value?"编辑订单":"新增订单"),1)]),h(Ma,{model:dl,rules:il,ref_key:"orderFormRef",ref:Ka,"label-width":"120px"},{default:f(()=>[h(x,{class:"customer-card"},{header:f(()=>[V("div",oe,[V("div",se,[h(l,null,{default:f(()=>[h(w(O))]),_:1}),a[23]||(a[23]=V("span",null,"客户信息",-1))])])]),default:f(()=>[h(n,{gutter:20},{default:f(()=>[h(d,{span:8},{default:f(()=>[h(s,{label:"选择客户",prop:"customerId",required:""},{default:f(()=>[h(o,{modelValue:dl.customerId,"onUpdate:modelValue":a[0]||(a[0]=e=>dl.customerId=e),placeholder:"请选择客户",style:{width:"100%"},filterable:"",remote:"","remote-method":_l,loading:ja.value,onChange:kl,size:"large"},{default:f(()=>[(v(!0),y(g,null,b(Ga.value,e=>(v(),m(t,{key:e.id,label:`${e.name} (${w(G)(e.phone)})`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),h(d,{span:8},{default:f(()=>[h(s,{label:"客服微信号",prop:"serviceWechat",required:""},{default:f(()=>[h(u,{modelValue:dl.serviceWechat,"onUpdate:modelValue":a[1]||(a[1]=e=>dl.serviceWechat=e),placeholder:"请输入负责客服的微信号",clearable:""},{prefix:f(()=>[h(l,null,{default:f(()=>[h(w(D))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),h(d,{span:8},{default:f(()=>[h(s,{label:w(za).orderSourceFieldName,prop:"orderSource",required:""},{default:f(()=>[h(o,{modelValue:dl.orderSource,"onUpdate:modelValue":a[2]||(a[2]=e=>dl.orderSource=e),placeholder:`请选择${w(za).orderSourceFieldName}`,style:{width:"100%"}},{default:f(()=>[(v(!0),y(g,null,b(w(za).orderSourceOptions,e=>(v(),m(t,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),el.value?(v(),y("div",re,[a[25]||(a[25]=V("h4",null,"收货信息",-1)),h(n,{gutter:20},{default:f(()=>[h(d,{span:6},{default:f(()=>[h(s,{label:"收货人",prop:"receiverName"},{default:f(()=>[h(u,{modelValue:dl.receiverName,"onUpdate:modelValue":a[3]||(a[3]=e=>dl.receiverName=e),placeholder:"请输入收货人姓名",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),h(d,{span:12},{default:f(()=>[h(s,{label:"收货电话",prop:"receiverPhone"},{default:f(()=>[V("div",de,[h(o,{modelValue:dl.receiverPhone,"onUpdate:modelValue":a[4]||(a[4]=e=>dl.receiverPhone=e),placeholder:"请选择收货电话",style:{width:"100%"},clearable:""},{default:f(()=>[(v(!0),y(g,null,b(al.value,e=>(v(),m(t,{key:e.id,label:w(G)(e.number),value:e.number},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),h(i,{type:"primary",size:"small",onClick:a[5]||(a[5]=e=>ll.value=!0),style:{"margin-left":"8px"},icon:w(N)},{default:f(()=>[...a[24]||(a[24]=[_(" 新增 ",-1)])]),_:1},8,["icon"])])]),_:1})]),_:1}),h(d,{span:6},{default:f(()=>[h(s,{label:"指定快递",prop:"expressCompany",required:""},{default:f(()=>[h(o,{modelValue:dl.expressCompany,"onUpdate:modelValue":a[6]||(a[6]=e=>dl.expressCompany=e),placeholder:"请选择快递公司",style:{width:"100%"},loading:Qa.value},{default:f(()=>[(v(!0),y(g,null,b(Ja.value,e=>(v(),m(t,{key:e.code,label:e.name,value:e.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),h(n,null,{default:f(()=>[h(d,{span:24},{default:f(()=>[h(s,{label:"收货地址",prop:"receiverAddress"},{default:f(()=>[h(u,{modelValue:dl.receiverAddress,"onUpdate:modelValue":a[7]||(a[7]=e=>dl.receiverAddress=e),placeholder:"请输入详细收货地址",clearable:""},q({_:2},[el.value&&el.value.address?{name:"suffix",fn:f(()=>[h(i,{size:"small",type:"text",onClick:Cl,title:"同步客户地址"},{default:f(()=>[h(l,null,{default:f(()=>[h(w(P))]),_:1})]),_:1})]),key:"0"}:void 0]),1032,["modelValue"])]),_:1})]),_:1})]),_:1})])):p("",!0)]),_:1}),h(ae,{modelValue:dl.customFields,"onUpdate:modelValue":a[8]||(a[8]=e=>dl.customFields=e),show:!!el.value},null,8,["modelValue","show"]),h(x,{class:"product-card"},{header:f(()=>[V("div",ue,[V("div",ne,[h(l,null,{default:f(()=>[h(w(j))]),_:1}),a[26]||(a[26]=V("span",null,"产品选择",-1))]),h(i,{type:"primary",size:"small",icon:w(Y),onClick:Tl,title:"刷新商品列表"},{default:f(()=>[...a[27]||(a[27]=[_(" 刷新 ",-1)])]),_:1},8,["icon"])])]),default:f(()=>[V("div",ie,[h(u,{modelValue:Ha.value,"onUpdate:modelValue":a[9]||(a[9]=e=>Ha.value=e),placeholder:"搜索产品名称、编号...",size:"large",clearable:"",onInput:Al},{prefix:f(()=>[h(l,null,{default:f(()=>[h(w(z))]),_:1})]),_:1},8,["modelValue"])]),V("div",ce,[(v(!0),y(g,null,b(bl.value,e=>(v(),y("div",{key:e.id,class:"product-item",onClick:a=>(e=>{let a=e.price;const l=JSON.parse(localStorage.getItem("crm_product_price_config")||"{}");if(l.enabled&&l.products&&l.products[e.id]){const t=l.products[e.id].price;null!=t&&(a=t,console.log(`[订单创建] 商品 ${e.name} 应用优惠价格: ¥${e.price} → ¥${a}`))}const t=dl.products.find(a=>a.id===e.id);t?t.quantity<e.stock?(t.quantity++,t.total=t.price*t.quantity,Ul(),I.success(`${e.name} 数量已增加`)):I.warning("库存不足"):(dl.products.push({...e,price:a,originalPrice:e.price,quantity:1,total:1*a}),Ul(),I.success(`${e.name} 已添加到订单`))})(e)},[V("div",pe,[V("img",{src:e.image||"/default-product.png",alt:e.name},null,8,ve)]),V("div",fe,[V("div",he,k(e.name),1),V("div",ye,"¥"+k(e.price),1),V("div",ge,"库存: "+k(e.stock),1)]),V("div",be,[h(i,{type:"info",size:"small",icon:w(K),onClick:S(a=>(e=>{ee.push(`/product/detail/${e.id}`)})(e),["stop"]),title:"查看商品详情"},{default:f(()=>[...a[28]||(a[28]=[_(" 详情 ",-1)])]),_:1},8,["icon","onClick"]),h(i,{type:"primary",size:"small",icon:w(N)},{default:f(()=>[...a[29]||(a[29]=[_("添加",-1)])]),_:1},8,["icon"])])],8,me))),128))])]),_:1}),h(x,{class:"summary-card"},{header:f(()=>[V("div",_e,[V("div",ke,[h(l,null,{default:f(()=>[h(w(H))]),_:1}),a[30]||(a[30]=V("span",null,"订单汇总",-1))])])]),default:f(()=>[dl.products.length>0?(v(),y("div",Ve,[a[31]||(a[31]=V("h4",null,"已选商品",-1)),h(T,{data:dl.products,style:{width:"100%"}},{default:f(()=>[h(C,{prop:"name",label:"商品名称"}),h(C,{prop:"price",label:"单价",width:"100"},{default:f(({row:e})=>[_(" ¥"+k(e.price),1)]),_:1}),h(C,{label:"数量",width:"150"},{default:f(({row:e,$index:a})=>[h(A,{modelValue:e.quantity,"onUpdate:modelValue":a=>e.quantity=a,min:1,max:e.stock,size:"small",onChange:Ul},null,8,["modelValue","onUpdate:modelValue","max"])]),_:1}),h(C,{label:"小计",width:"100"},{default:f(({row:e})=>[_(" ¥"+k(((e.price||0)*(e.quantity||0)).toFixed(2)),1)]),_:1}),h(C,{label:"操作",width:"80"},{default:f(({$index:e})=>[h(i,{type:"danger",size:"small",icon:w(B),onClick:a=>(e=>{const a=dl.products[e];dl.products.splice(e,1),Ul(),I.success(`${a.name} 已从订单中移除`)})(e)},null,8,["icon","onClick"])]),_:1})]),_:1},8,["data"])])):p("",!0),V("div",we,[V("div",xe,[V("div",Ce,[a[32]||(a[32]=V("span",{class:"field-label"},"商品小计",-1)),V("span",Ae,"¥"+k(fl.value.toFixed(2)),1)]),V("div",Te,[V("span",Ue,[a[33]||(a[33]=_(" 订单总额 ",-1)),vl.value?(v(),m(U,{key:0,content:"点击同步商品小计",placement:"top"},{default:f(()=>[h(i,{type:"text",size:"small",icon:w(Y),onClick:$l,class:"sync-button"},null,8,["icon"])]),_:1})):p("",!0)]),h(A,{modelValue:dl.totalAmount,"onUpdate:modelValue":a[10]||(a[10]=e=>dl.totalAmount=e),min:0,max:fl.value,precision:2,placeholder:"订单总额",class:"field-input",onChange:Sl},null,8,["modelValue","max"])]),V("div",qe,[a[34]||(a[34]=V("span",{class:"field-label"},"定金",-1)),h(A,{modelValue:dl.depositAmount,"onUpdate:modelValue":a[11]||(a[11]=e=>dl.depositAmount=e),min:0,max:dl.totalAmount||0,precision:2,placeholder:"定金金额",class:"field-input",onChange:ql},null,8,["modelValue","max"])]),V("div",Se,[a[35]||(a[35]=V("span",{class:"field-label"},[_("支付方式 "),V("span",{class:"required-star"},"*")],-1)),V("div",$e,[h(o,{modelValue:dl.paymentMethod,"onUpdate:modelValue":a[12]||(a[12]=e=>dl.paymentMethod=e),placeholder:"请选择支付方式",class:"field-input",style:{width:"140px"},onChange:nl},{default:f(()=>[(v(!0),y(g,null,b(ul.value,e=>(v(),m(t,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),"other"===dl.paymentMethod?(v(),m(u,{key:0,modelValue:dl.paymentMethodOther,"onUpdate:modelValue":a[13]||(a[13]=e=>dl.paymentMethodOther=e),placeholder:"请输入支付方式",style:{width:"140px","margin-left":"8px"}},null,8,["modelValue"])):p("",!0)])])]),V("div",Fe,[V("div",Me,[a[36]||(a[36]=V("span",{class:"field-label"},"代收金额",-1)),V("span",Ie,"¥"+k(hl.value.toFixed(2)),1)]),V("div",De,[a[37]||(a[37]=V("span",{class:"field-label"},"优惠金额",-1)),V("div",Ne,[V("span",Pe,"¥"+k(yl.value.toFixed(2)),1),yl.value>0?(v(),y("span",Oe," ("+k(gl.value.toFixed(1))+"%) ",1)):p("",!0)])]),V("div",ze,[a[40]||(a[40]=V("span",{class:"field-label"},"定金截图",-1)),V("div",Ke,[h(i,{type:"primary",size:"small",icon:w(E),onClick:Ml},{default:f(()=>[...a[38]||(a[38]=[_(" 上传截图 ",-1)])]),_:1},8,["icon"]),h(i,{type:"success",size:"small",icon:w(W),onClick:Dl},{default:f(()=>[...a[39]||(a[39]=[_(" 粘贴图片 ",-1)])]),_:1},8,["icon"])]),V("div",je,[cl.value.length>0?(v(),y("div",Ye,[(v(!0),y(g,null,b(cl.value,(e,t)=>(v(),y("div",{key:t,class:"thumbnail-item",onMouseenter:e=>ml.value=t,onMouseleave:a[14]||(a[14]=e=>ml.value=-1),onClick:a=>(e=>{const a=e||dl.depositScreenshot;a&&(Za.value=[a],La.value=!0)})(e)},[V("img",{src:e,alt:"定金截图"},null,8,Ee),$(V("div",We,[h(l,{class:"zoom-icon"},{default:f(()=>[h(w(R))]),_:1})],512),[[F,ml.value===t]]),V("div",{class:"thumbnail-delete",onClick:S(e=>(e=>{cl.value.splice(e,1),dl.depositScreenshot=cl.value[0]||"",I.success("图片已删除")})(t),["stop"])},[h(l,null,{default:f(()=>[h(w(B))]),_:1})],8,Re)],40,Be))),128))])):p("",!0)]),V("input",{ref_key:"fileInput",ref:Fl,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:Il},null,544)])])]),V("div",He,[a[43]||(a[43]=V("h4",null,"订单标记",-1)),h(n,{gutter:20},{default:f(()=>[h(d,{span:12},{default:f(()=>[h(s,{label:"订单类型",prop:"markType",required:""},{default:f(()=>[h(J,{modelValue:dl.markType,"onUpdate:modelValue":a[15]||(a[15]=e=>dl.markType=e),onChange:Ol},{default:f(()=>[h(Z,{label:"normal"},{default:f(()=>[h(M,{type:"success",size:"small"},{default:f(()=>[...a[41]||(a[41]=[_("正常发货单",-1)])]),_:1})]),_:1}),h(Z,{label:"reserved"},{default:f(()=>[h(M,{type:"warning",size:"small"},{default:f(()=>[...a[42]||(a[42]=[_("预留单",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),h(d,{span:12},{default:f(()=>[V("div",Le,["reserved"===dl.markType?(v(),m(Q,{key:0,title:"预留单说明",description:"预留单将保留在下单人处，不会流转到审核员。需要修改为正常发货单后才会进入审核流程。",type:"warning",closable:!1,"show-icon":""})):(v(),m(Q,{key:1,title:"正常发货单",description:"订单将按正常流程进行审核和发货处理。",type:"success",closable:!1,"show-icon":""}))])]),_:1})]),_:1})]),V("div",Ze,[h(s,{label:"订单备注"},{default:f(()=>[h(u,{modelValue:dl.remark,"onUpdate:modelValue":a[16]||(a[16]=e=>dl.remark=e),type:"textarea",rows:3,placeholder:"请输入订单备注信息"},null,8,["modelValue"])]),_:1})]),V("div",Je,[h(i,{onClick:Yl,size:"large"},{default:f(()=>[...a[44]||(a[44]=[_("取消",-1)])]),_:1}),h(i,{onClick:zl,type:"primary",size:"large",loading:Ba.value},{default:f(()=>[...a[45]||(a[45]=[_(" 保存订单 ",-1)])]),_:1},8,["loading"])])]),_:1})]),_:1},8,["model"]),h(Ia,{modelValue:Wa.value,"onUpdate:modelValue":a[18]||(a[18]=e=>Wa.value=e),title:"订单确认",width:"600px","before-close":jl},{footer:f(()=>[V("span",$a,[h(i,{onClick:a[17]||(a[17]=e=>Wa.value=!1)},{default:f(()=>[...a[62]||(a[62]=[_("取消",-1)])]),_:1}),h(i,{type:"primary",onClick:Kl,loading:Ea.value},{default:f(()=>[...a[63]||(a[63]=[_(" 确认提交审核 ",-1)])]),_:1},8,["loading"])])]),default:f(()=>[V("div",Qe,[a[61]||(a[61]=V("h4",null,"请确认以下订单信息：",-1)),V("div",Ge,[a[51]||(a[51]=V("h5",null,"客户信息",-1)),V("div",Xe,[V("div",ea,[a[46]||(a[46]=V("span",{class:"label"},"客户：",-1)),V("span",aa,k(el.value?.name),1)]),V("div",la,[a[47]||(a[47]=V("span",{class:"label"},"电话：",-1)),V("span",ta,k(el.value?.phone?w(X)(el.value.phone,w(r).PHONE,w(Da).currentUser?.id||""):""),1)]),V("div",oa,[a[48]||(a[48]=V("span",{class:"label"},"收货人：",-1)),V("span",sa,k(dl.receiverName),1)]),V("div",ra,[a[49]||(a[49]=V("span",{class:"label"},"收货地址：",-1)),V("span",da,k(dl.receiverAddress),1)]),V("div",ua,[a[50]||(a[50]=V("span",{class:"label"},"快递公司：",-1)),V("span",na,k(Bl(dl.expressCompany)),1)])])]),V("div",ia,[a[53]||(a[53]=V("h5",null,"订单标记",-1)),V("div",ca,[V("div",ma,[a[52]||(a[52]=V("span",{class:"label"},"订单类型：",-1)),h(M,{type:"normal"===dl.markType?"success":"warning",size:"small"},{default:f(()=>[_(k("normal"===dl.markType?"正常发货单":"预留单"),1)]),_:1},8,["type"])]),"reserved"===dl.markType?(v(),y("div",pa," * 预留单将保留在您处，不会流转到审核员 ")):p("",!0)])]),V("div",va,[a[59]||(a[59]=V("h5",null,"金额汇总",-1)),V("div",fa,[V("div",ha,[V("div",ya,[a[54]||(a[54]=V("span",{class:"label"},"商品小计",-1)),V("span",ga,"¥"+k(fl.value.toFixed(2)),1)]),V("div",ba,[a[55]||(a[55]=V("span",{class:"label"},"优惠金额",-1)),V("div",_a,[V("span",ka,"¥"+k(yl.value.toFixed(2)),1),yl.value>0?(v(),y("span",Va," ("+k(gl.value.toFixed(1))+"%) ",1)):p("",!0)])])]),V("div",wa,[V("div",xa,[a[56]||(a[56]=V("span",{class:"label"},"订单总额",-1)),V("span",Ca,"¥"+k((dl.totalAmount||0).toFixed(2)),1)]),V("div",Aa,[a[57]||(a[57]=V("span",{class:"label"},"定金",-1)),V("span",Ta,"¥"+k((dl.depositAmount||0).toFixed(2)),1)]),V("div",Ua,[a[58]||(a[58]=V("span",{class:"label"},"代收金额",-1)),V("span",qa,"¥"+k(hl.value.toFixed(2)),1)])])])]),V("div",Sa,[a[60]||(a[60]=V("h5",null,"商品信息",-1)),h(T,{data:dl.products,size:"small"},{default:f(()=>[h(C,{prop:"name",label:"商品名称"}),h(C,{prop:"price",label:"单价",width:"80"},{default:f(({row:e})=>[_("¥"+k(e.price),1)]),_:1}),h(C,{prop:"quantity",label:"数量",width:"60"}),h(C,{label:"小计",width:"80"},{default:f(({row:e})=>[_("¥"+k(((e.price||0)*(e.quantity||0)).toFixed(2)),1)]),_:1})]),_:1},8,["data"])])])]),_:1},8,["modelValue"]),h(Ia,{modelValue:ll.value,"onUpdate:modelValue":a[21]||(a[21]=e=>ll.value=e),title:"新增手机号",width:"400px","before-close":xl},{footer:f(()=>[V("span",Fa,[h(i,{onClick:xl},{default:f(()=>[...a[64]||(a[64]=[_("取消",-1)])]),_:1}),h(i,{type:"primary",onClick:wl,loading:ol.value},{default:f(()=>[...a[65]||(a[65]=[_(" 确认添加 ",-1)])]),_:1},8,["loading"])])]),default:f(()=>[h(Ma,{ref_key:"addPhoneFormRef",ref:tl,model:sl,rules:rl,"label-width":"80px"},{default:f(()=>[h(s,{label:"手机号",prop:"phone"},{default:f(()=>[h(u,{modelValue:sl.phone,"onUpdate:modelValue":a[19]||(a[19]=e=>sl.phone=e),placeholder:"请输入手机号",clearable:""},null,8,["modelValue"])]),_:1}),h(s,{label:"备注",prop:"remark"},{default:f(()=>[h(u,{modelValue:sl.remark,"onUpdate:modelValue":a[20]||(a[20]=e=>sl.remark=e),placeholder:"请输入备注（可选）",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),La.value?(v(),m(w(L),{key:0,"url-list":Za.value,onClose:a[22]||(a[22]=e=>La.value=!1)},null,8,["url-list"])):p("",!0)])}}}),[["__scopeId","data-v-68b4ff60"]]);export{Ma as default};
