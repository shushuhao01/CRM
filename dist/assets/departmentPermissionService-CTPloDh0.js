import{z as e}from"./index-BGtT17ll.js";import"./vendor-BtukhyiH.js";import"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";const t=new class{departmentPermissions;userDepartmentCache;constructor(){this.departmentPermissions=new Map,this.userDepartmentCache=new Map}async setDepartmentPermissions(e,t){const s={departmentId:e,permissions:t.permissions||[],inheritFromParent:t.inheritFromParent||!1,managerExtraPermissions:t.managerExtraPermissions||["data.department.view_all","performance.department.view_all","customer.department.view_all"],dataScope:t.dataScope||"department",createdAt:new Date,updatedAt:new Date};return this.departmentPermissions.set(e,s),s}getDepartmentPermissions(e){return this.departmentPermissions.get(e)||{departmentId:e,permissions:[],inheritFromParent:!1,managerExtraPermissions:[],dataScope:"self",createdAt:new Date,updatedAt:new Date}}async calculateDepartmentFullPermissions(e,t){const s=this.getDepartmentPermissions(e);let r=[...s.permissions];if(s.inheritFromParent){const s=this.findDepartmentInTree(t,e);if(s&&s.parentId){const e=await this.calculateDepartmentFullPermissions(s.parentId,t);r=[...new Set([...r,...e])]}}return r}async calculateUserFinalPermissions(t,s,r){const{departmentId:n,roleId:a,isManager:i}=s,m=await e.getRolePermissions(a)||[],o=await this.calculateDepartmentFullPermissions(n,r),p=await e.getUserPersonalPermissions(t)||[];let d=[];if(i){d=this.getDepartmentPermissions(n).managerExtraPermissions}const c=[...new Set([...m,...o,...d,...p])];let l="self";if(i){l="all"===this.getDepartmentPermissions(n).dataScope?"all":"department"}else{"department"===this.getDepartmentPermissions(n).dataScope&&o.length>0&&(l="department")}return{userId:t,departmentId:n,roleId:a,finalPermissions:c,permissionSources:{role:m,department:o,personal:p,manager:d},dataScope:l,isDepartmentManager:i}}findDepartmentInTree(e,t){for(const s of e){if(s.id===t)return s;if(s.children){const e=this.findDepartmentInTree(s.children,t);if(e)return e}}return null}async hasPermission(e,t,s,r){return(await this.calculateUserFinalPermissions(e,s,r)).finalPermissions.includes(t)}async canAccessData(e,t,s,r){const{departmentId:n,isManager:a}=r;if(e===t)return!0;if(a&&n===s)return!0;const i=this.getDepartmentPermissions(n);return"all"===i.dataScope||"department"===i.dataScope&&n===s}async getDataScopeFilter(e,t){const{departmentId:s,isManager:r}=t;if(r){return"all"===this.getDepartmentPermissions(s).dataScope?{type:"all"}:{type:"department",value:s}}return"department"===this.getDepartmentPermissions(s).dataScope?{type:"department",value:s}:{type:"self",value:e}}async batchSetDepartmentPermissions(e){const t=[];for(const{departmentId:s,config:r}of e){const e=await this.setDepartmentPermissions(s,r);t.push(e)}return t}async getDepartmentPermissionChain(e,t){const s=[],r=this.findDepartmentInTree(t,e);if(!r)return s;const n=this.getDepartmentPermissions(e);if(s.push({departmentId:e,permissions:n.permissions,inherited:!1}),n.inheritFromParent&&r.parentId){const e=await this.getDepartmentPermissionChain(r.parentId,t);s.push(...e.map(e=>({...e,inherited:!0})))}return s}clearCache(){this.userDepartmentCache.clear()}exportDepartmentPermissions(){return Array.from(this.departmentPermissions.values())}async importDepartmentPermissions(e){for(const t of e)this.departmentPermissions.set(t.departmentId,t)}};export{t as default};
