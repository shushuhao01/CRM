import{aw as e,r as t,e as r}from"./vendor-BtukhyiH.js";import{g as a}from"./index-BGtT17ll.js";import{isProduction as s}from"./env-DLalhsF6.js";const c={async getList(e={}){const t={};e.page&&(t.page=e.page),e.limit&&(t.limit=e.limit),e.status&&(t.status=e.status),e.serviceType&&(t.serviceType=e.serviceType),e.search&&(t.search=e.search),e.orderNumber&&(t.orderNumber=e.orderNumber);const r=await a.get("/services",t);return r.data||r},async getDetail(e){const t=await a.get(`/services/${e}`);return t.data||t},async create(e){const t=await a.post("/services",e);return t.data||t},async update(e,t){const r=await a.put(`/services/${e}`,t);return r.data||r},async updateStatus(e,t,r){await a.patch(`/services/${e}/status`,{status:t,remark:r})},async assign(e,t,r,s){await a.patch(`/services/${e}/assign`,{assignedTo:t,assignedToId:r,remark:s})},async setPriority(e,t,r){await a.patch(`/services/${e}/priority`,{priority:t,remark:r})},async delete(e){await a.delete(`/services/${e}`)},async getStatistics(){const e=await a.get("/services/stats/summary");return e.data||e}},i=e("service",()=>{const e=t([]),a=t(!1),i=t(0),o=r(()=>e.value.length),n=r(()=>e.value),u=r(()=>e.value.filter(e=>"pending"===e.status)),l=r(()=>e.value.filter(e=>"processing"===e.status)),d=t=>e.value.find(e=>e.id===t),v=async t=>{try{if(console.log("[ServiceStore] 创建售后服务..."),s()){const r=await c.create(t),a=S(r);return e.value.unshift(a),console.log("[ServiceStore] API创建成功:",a.serviceNumber),a}{const r={id:`SH${Date.now()}`,serviceNumber:`SH${Date.now()}`,orderId:t.orderId||"",orderNumber:t.orderNumber||"",customerId:t.customerId||"",customerName:t.customerName||"",customerPhone:t.customerPhone||"",serviceType:t.serviceType||"return",status:"pending",priority:t.priority||"normal",reason:t.reason||"",description:t.description||"",productName:t.productName||"",productSpec:t.productSpec||"",quantity:t.quantity||1,price:t.price||0,createTime:(new Date).toISOString().slice(0,19).replace("T"," "),createdBy:t.createdBy||"customer",assignedTo:t.assignedTo||"",updateTime:(new Date).toISOString().slice(0,19).replace("T"," "),attachments:t.attachments||[]};return e.value.unshift(r),m(),console.log("[ServiceStore] 本地创建成功:",r.serviceNumber),r}}catch(r){throw console.error("[ServiceStore] 创建售后服务失败:",r),r}},S=e=>({id:e.id,serviceNumber:e.serviceNumber,orderId:e.orderId||"",orderNumber:e.orderNumber||"",customerId:e.customerId||"",customerName:e.customerName||"",customerPhone:e.customerPhone||"",serviceType:e.serviceType||"return",status:e.status||"pending",priority:e.priority||"normal",reason:e.reason||"",description:e.description||"",createTime:e.createTime||"",createdBy:e.createdBy||"",assignedTo:e.assignedTo,updateTime:e.updateTime,expectedTime:e.expectedTime,remark:e.remark,attachments:e.attachments||[],productName:e.productName,productSpec:e.productSpec,quantity:e.quantity,price:e.price,contactAddress:e.contactAddress,contactName:e.contactName,contactPhone:e.contactPhone,createdById:e.createdById,departmentId:e.departmentId}),m=()=>{localStorage.setItem("crm_after_sales_services",JSON.stringify(e.value))};return{services:e,loading:a,total:i,serviceCount:o,afterSalesServices:n,pendingServices:u,processingServices:l,loadAfterSalesServices:async(t={})=>{a.value=!0;try{if(console.log("[ServiceStore] 加载售后服务列表..."),s()){const r=await c.getList(t);e.value=(r.items||[]).map(S),i.value=r.total||0,console.log("[ServiceStore] API加载成功，共",e.value.length,"条记录")}else{const t=localStorage.getItem("crm_after_sales_services");t&&(e.value=JSON.parse(t)),i.value=e.value.length,console.log("[ServiceStore] 本地加载成功，共",e.value.length,"条记录")}return e.value}catch(r){throw console.error("[ServiceStore] 加载售后服务列表失败:",r),r}finally{a.value=!1}},getServiceById:d,fetchServiceById:async e=>{try{if(s()){const t=await c.getDetail(e);return S(t)}return d(e)||null}catch(t){return console.error("[ServiceStore] 获取售后服务详情失败:",t),null}},createAfterSalesService:v,updateService:async(t,r)=>{try{if(console.log("[ServiceStore] 更新售后服务:",t),s()){const a=await c.update(t,r),s=e.value.findIndex(e=>e.id===t);return-1!==s?(e.value[s]={...e.value[s],...S(a)},e.value[s]):S(a)}{const a=e.value.findIndex(e=>e.id===t);return-1!==a?(e.value[a]={...e.value[a],...r,updateTime:(new Date).toISOString().slice(0,19).replace("T"," ")},m(),e.value[a]):null}}catch(a){throw console.error("[ServiceStore] 更新售后服务失败:",a),a}},updateServiceStatus:async(t,r,a)=>{try{console.log("[ServiceStore] 更新售后服务状态:",t,r),s()&&await c.updateStatus(t,r,a);const i=e.value.find(e=>e.id===t);i&&(i.status=r,i.updateTime=(new Date).toISOString().slice(0,19).replace("T"," "),a&&(i.remark=a),s()||m())}catch(i){throw console.error("[ServiceStore] 更新状态失败:",i),i}},assignService:async(t,r,a,i)=>{try{console.log("[ServiceStore] 分配处理人:",t,r),s()&&await c.assign(t,r,a,i);const o=e.value.find(e=>e.id===t);o&&(o.assignedTo=r,o.status="pending"===o.status?"processing":o.status,o.updateTime=(new Date).toISOString().slice(0,19).replace("T"," "),i&&(o.remark=i),s()||m())}catch(o){throw console.error("[ServiceStore] 分配处理人失败:",o),o}},setServicePriority:async(t,r,a)=>{try{console.log("[ServiceStore] 设置优先级:",t,r),s()&&await c.setPriority(t,r,a);const i=e.value.find(e=>e.id===t);i&&(i.priority=r,i.updateTime=(new Date).toISOString().slice(0,19).replace("T"," "),a&&(i.remark=a),s()||m())}catch(i){throw console.error("[ServiceStore] 设置优先级失败:",i),i}},deleteService:async t=>{try{console.log("[ServiceStore] 删除售后服务:",t),s()&&await c.delete(t);const r=e.value.findIndex(e=>e.id===t);return-1!==r&&(e.value.splice(r,1),s()||m(),!0)}catch(r){throw console.error("[ServiceStore] 删除售后服务失败:",r),r}},getServicesByOrderId:t=>e.value.filter(e=>e.orderId===t),getServicesByCustomerId:t=>e.value.filter(e=>e.customerId===t),checkExistingAfterSales:async t=>e.value.find(e=>e.orderId===t)||null,addService:v,createService:v,getServicesByStatus:async t=>e.value.filter(e=>e.status===t)}});export{i as u};
