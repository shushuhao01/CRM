import{l as e,r as a,e as l,w as r,b as t,Y as s,ag as d,aq as o,m as n,q as u,p as i,U as c,O as v,S as m,u as p,T as f,P as h,M as b,F as g,a9 as y,Q as _,a7 as w,J as k,af as C,n as I}from"./vendor-BtukhyiH.js";import{C as x,G as V,V as U,R as M,B as S,a4 as N,Z as L,Q as D,j as z,ae as A,F as Y,af as j,w as P,ab as R,K as T,A as O,E as B,b as $}from"./elementPlus-DxaqjplL.js";import{f as q,u as F,d as E,_ as J}from"./index-BGtT17ll.js";import"./utils-DfI7e5Rl.js";const K={class:"page-header"},Q={class:"header-actions"},G={class:"share-overview"},Z={class:"card-content"},H={class:"card-icon total"},W={class:"card-info"},X={class:"card-value"},ee={class:"card-content"},ae={class:"card-icon amount"},le={class:"card-info"},re={class:"card-value"},te={class:"card-content"},se={class:"card-icon members"},de={class:"card-info"},oe={class:"card-value"},ne={class:"card-content"},ue={class:"card-icon orders"},ie={class:"card-info"},ce={class:"card-value"},ve={class:"card-header"},me={class:"header-filters"},pe={class:"search-container"},fe={class:"share-members"},he={class:"action-buttons"},be={class:"pagination-wrapper"},ge={class:"order-search-container"},ye={key:0,class:"search-result-tip"},_e={key:0,class:"no-result"},we={key:1,class:"found-result"},ke={key:2,class:"multiple-results"},Ce={class:"order-option"},Ie={class:"order-main"},xe={class:"customer-name"},Ve={class:"order-amount"},Ue={class:"order-sub"},Me={class:"phone"},Se={class:"time"},Ne={key:0,class:"order-info-card"},Le={class:"order-info-header"},De={class:"amount-text"},ze={class:"share-members-config"},Ae={class:"percentage-summary"},Ye={key:0,class:"error-text"},je={key:0,class:"share-detail"},Pe={class:"share-details-section"},Re={class:"share-members-grid"},Te={class:"member-header"},Oe={class:"member-avatar"},Be={class:"member-info"},$e={class:"member-name"},qe={class:"share-amount-section"},Fe={class:"percentage-display"},Ee={class:"percentage-circle"},Je={class:"percentage-text"},Ke={class:"amount-display"},Qe={class:"amount-value"},Ge={class:"member-footer"},Ze={key:0,class:"confirm-time"},He={key:0,style:{"margin-top":"15px"}},We={class:"amount"},Xe=J(e({__name:"Share",setup(e){const J=q(),Xe=F(),ea=E(),aa=a(!1),la=a(!1),ra=a(!1),ta=a(!1),sa=a(!1),da=a(!1),oa=a(!1),na=a(1),ua=a(20),ia=a(0),ca=a(""),va=a(null),ma=a(""),pa=a(!1),fa=a("csv"),ha=a(null),ba=a(!1),ga=a(),ya=a({orderId:"",shareMembers:[{userId:"",percentage:50},{userId:"",percentage:50}],description:""}),_a={orderId:[{required:!0,message:"请选择订单",trigger:"change"}],shareMembers:[{required:!0,message:"请配置分享成员",trigger:"change"}]},wa=a([]),ka=a([]),Ca=a(null),Ia=a(null),xa=a(""),Va=l(()=>J.performanceShares),Ua=l(()=>J.shareStats),Ma=l(()=>{let e=Va.value;const a=Xe.currentUser;if(a&&("super_admin"===a.role||"admin"===a.role||(e=(a.role,e.filter(e=>e.createdById===a.id||e.createdBy===a.name)))),ca.value&&(e=e.filter(e=>e.status===ca.value)),va.value&&2===va.value.length){const[a,l]=va.value;e=e.filter(e=>{const r=e.createTime.split(" ")[0];return r>=a&&r<=l})}if(pa.value&&ma.value.trim()){const a=ma.value.trim().toLowerCase();e=e.filter(e=>e.orderNumber.toLowerCase().includes(a))}return e}),Sa=l(()=>ya.value.shareMembers.reduce((e,a)=>e+(a.percentage||0),0)),Na=async()=>{aa.value=!0;try{const e={page:na.value,limit:ua.value,status:ca.value||void 0,userId:Xe.currentUser?.id},a=await J.loadPerformanceShares(e);ia.value=a.total,a.shares.length}catch(e){console.error("加载分享记录失败:",e),B.error("加载分享记录失败")}finally{aa.value=!1}},La=async()=>{try{console.log("[业绩分享] 开始加载用户列表"),await Xe.loadUsers();const e=["sales_staff","sales_manager","department_manager","admin","super_admin"];ka.value=Xe.users.filter(a=>{const l=a.role||"";return e.includes(l)&&"active"===a.status}).map(e=>({id:e.id,name:e.realName||e.name||e.username,department:e.departmentName||e.department||"未分配",role:e.role})),console.log("[业绩分享] 可用用户数:",ka.value.length),console.log("[业绩分享] 可用用户列表:",ka.value)}catch(e){console.error("[业绩分享] 加载用户列表失败:",e),ka.value=[]}},Da=()=>{xa.value="",wa.value=[],ya.value.orderId="",Ca.value=null},za=e=>{Ca.value=wa.value.find(a=>a.id===e)},Aa=()=>{ya.value.shareMembers.length<5&&ya.value.shareMembers.push({userId:"",percentage:0})},Ya=()=>{},ja=async()=>{if(ga.value)try{if(await ga.value.validate(),100!==Sa.value)return void B.error("分享比例总和必须为100%");da.value=!0,console.log("[业绩分享] 开始提交分享数据");const e={orderId:ya.value.orderId,orderNumber:Ca.value?.orderNumber||"",orderAmount:Ca.value?.totalAmount||0,shareMembers:ya.value.shareMembers.map(e=>{const a=(Ca.value?.totalAmount||0)*e.percentage/100;return{userId:e.userId,userName:ka.value.find(a=>a.id===e.userId)?.name||"",percentage:e.percentage,shareAmount:a,status:"pending"}}),createdBy:Xe.currentUser?.name||"",createdById:Xe.currentUser?.id||"",description:ya.value.description};if(console.log("[业绩分享] 分享数据:",e),sa.value){const a=Va.value.find(e=>e.id===ya.value.orderId);a&&(await J.updatePerformanceShare(a.id,e),B.success("分享更新成功"))}else{const a=await J.createPerformanceShare(e);console.log("[业绩分享] 分享创建成功:",a)}Ra(),await Na(),console.log("[业绩分享] 触发业绩数据同步"),await J.syncPerformanceData(),console.log("[业绩分享] 分享流程完成"),B.success("分享创建成功")}catch(e){console.error("[业绩分享] 提交分享失败:",e),B.error("提交分享失败")}finally{da.value=!1}},Pa=async()=>{console.log("[业绩分享] 打开新建分享对话框"),await La(),la.value=!0},Ra=()=>{la.value=!1,sa.value=!1,ya.value={orderId:"",shareMembers:[{userId:"",percentage:50},{userId:"",percentage:50}],description:""},Ca.value=null,xa.value="",wa.value=[],ga.value?.resetFields()},Ta=e=>{Ia.value=e,ra.value=!0},Oa=e=>Xe.isAdmin&&"active"===e.status,Ba=e=>{window.open(`/order/detail/${e}`,"_blank")},$a=()=>{ta.value=!0},qa=async()=>{try{ba.value=!0;const{value:e}=await $.prompt("请选择导出格式和日期范围","导出业绩分享记录",{confirmButtonText:"导出",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"可选：输入日期范围 (格式: 2024-01-01 至 2024-12-31)",showInput:!1,message:C("div",[C("div",{style:"margin-bottom: 10px"},"导出格式:"),C("el-radio-group",{modelValue:"csv","onUpdate:modelValue":e=>{fa.value=e}},[C("el-radio",{label:"csv"},"CSV格式"),C("el-radio",{label:"json"},"JSON格式")]),C("div",{style:"margin: 15px 0 10px 0"},"日期范围:"),C("el-date-picker",{modelValue:ha.value,"onUpdate:modelValue":e=>{ha.value=e},type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:"width: 100%"})])}),a={format:fa.value};ha.value&&2===ha.value.length&&(a.startDate=ha.value[0],a.endDate=ha.value[1]),B.loading("正在导出数据...");const l=await(void 0)(a);if("csv"===a.format){const e=new Blob([l.data],{type:"text/csv;charset=utf-8"}),a=window.URL.createObjectURL(e),r=document.createElement("a");r.href=a,r.download=`业绩分享记录_${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(a)}else{const e=JSON.stringify(l.data.data,null,2),a=new Blob([e],{type:"application/json;charset=utf-8"}),r=window.URL.createObjectURL(a),t=document.createElement("a");t.href=r,t.download=`业绩分享记录_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(r)}B.success("导出成功！")}catch(e){"cancel"!==e&&(console.error("导出失败:",e),B.error("导出失败，请重试"))}finally{ba.value=!1}},Fa=e=>({active:"success",completed:"info",cancelled:"danger"}[e]||"info"),Ea=e=>({active:"生效中",completed:"已完成",cancelled:"已取消"}[e]||e),Ja=e=>({pending:"待确认",confirmed:"已确认",shipped:"已发货",delivered:"已送达",cancelled:"已取消",completed:"已完成",processing:"处理中",paid:"已支付",unpaid:"未支付"}[e]||e),Ka=({row:e,rowIndex:a})=>"table-row-"+(a%2==0?"even":"odd"),Qa=e=>{B.info(`点击了分享记录: ${e.shareNumber}`)},Ga=e=>({pending:"待审核",approved:"已通过",rejected:"已拒绝"}[e]||e),Za=e=>{na.value=e,Na()},Ha=()=>{ma.value.trim()?(pa.value=!0,na.value=1):B.warning("请输入订单号")},Wa=()=>{ma.value="",pa.value=!1,na.value=1},Xa=a(null);r(()=>J.performanceShares,()=>{I(()=>{J.syncPerformanceData()})},{deep:!0}),t(async()=>{await Na(),await La(),Xa.value=setInterval(async()=>{await Na(),await J.syncPerformanceData()},3e4)}),s(()=>{Xa.value&&(clearInterval(Xa.value),Xa.value=null)});const el=e=>{ua.value=e,na.value=1,Na()};return r([ca,va],()=>{na.value=1,Na()}),(e,a)=>{const l=d("el-button"),r=d("el-icon"),t=d("el-card"),s=d("el-col"),C=d("el-row"),I=d("el-option"),q=d("el-select"),F=d("el-date-picker"),E=d("el-input"),fa=d("el-table-column"),ha=d("el-link"),La=d("el-tag"),Xa=d("el-table"),al=d("el-pagination"),ll=d("el-tooltip"),rl=d("el-form-item"),tl=d("el-descriptions-item"),sl=d("el-descriptions"),dl=d("el-input-number"),ol=d("el-form"),nl=d("el-dialog"),ul=o("loading");return u(),n("div",{class:k(["performance-share",{"page-loaded":!aa.value}])},[i("div",K,[a[15]||(a[15]=i("h2",null,"业绩分享",-1)),i("div",Q,[c(l,{onClick:Pa,type:"primary",icon:p(x),class:"action-btn-primary",loading:da.value},{default:v(()=>[...a[13]||(a[13]=[m(" 新建分享 ",-1)])]),_:1},8,["icon","loading"]),c(l,{onClick:qa,icon:p(V),class:"action-btn-secondary",loading:ba.value},{default:v(()=>[...a[14]||(a[14]=[m(" 导出记录 ",-1)])]),_:1},8,["icon","loading"])])]),i("div",G,[c(C,{gutter:20},{default:v(()=>[c(s,{span:6},{default:v(()=>[c(t,{class:"overview-card"},{default:v(()=>[i("div",Z,[i("div",H,[c(r,null,{default:v(()=>[c(p(U))]),_:1})]),i("div",W,[i("div",X,f(Ua.value.totalShares),1),a[16]||(a[16]=i("div",{class:"card-label"},"总分享次数",-1))])])]),_:1})]),_:1}),c(s,{span:6},{default:v(()=>[c(t,{class:"overview-card"},{default:v(()=>[i("div",ee,[i("div",ae,[c(r,null,{default:v(()=>[c(p(M))]),_:1})]),i("div",le,[i("div",re,"¥"+f(Ua.value.totalAmount.toLocaleString()),1),a[17]||(a[17]=i("div",{class:"card-label"},"分享总金额",-1))])])]),_:1})]),_:1}),c(s,{span:6},{default:v(()=>[c(t,{class:"overview-card"},{default:v(()=>[i("div",te,[i("div",se,[c(r,null,{default:v(()=>[c(p(S))]),_:1})]),i("div",de,[i("div",oe,f(Ua.value.involvedMembers),1),a[18]||(a[18]=i("div",{class:"card-label"},"参与成员",-1))])])]),_:1})]),_:1}),c(s,{span:6},{default:v(()=>[c(t,{class:"overview-card"},{default:v(()=>[i("div",ne,[i("div",ue,[c(r,null,{default:v(()=>[c(p(N))]),_:1})]),i("div",ie,[i("div",ce,f(Ua.value.sharedOrders),1),a[19]||(a[19]=i("div",{class:"card-label"},"分享订单数",-1))])])]),_:1})]),_:1})]),_:1})]),c(t,{class:"share-records"},{header:v(()=>[i("div",ve,[a[23]||(a[23]=i("span",null,"分享记录",-1)),i("div",me,[c(l,{onClick:$a,icon:p(A),class:"fullscreen-btn",title:"全屏查看"},{default:v(()=>[...a[20]||(a[20]=[m(" 全屏查看 ",-1)])]),_:1},8,["icon"]),c(q,{modelValue:ca.value,"onUpdate:modelValue":a[0]||(a[0]=e=>ca.value=e),placeholder:"状态筛选",clearable:"",style:{width:"120px"}},{default:v(()=>[c(I,{label:"全部",value:""}),c(I,{label:"生效中",value:"active"}),c(I,{label:"已完成",value:"completed"}),c(I,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"]),c(F,{modelValue:va.value,"onUpdate:modelValue":a[1]||(a[1]=e=>va.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px","margin-left":"10px"}},null,8,["modelValue"]),i("div",pe,[c(E,{modelValue:ma.value,"onUpdate:modelValue":a[2]||(a[2]=e=>ma.value=e),placeholder:"搜索订单号",clearable:"",style:{width:"180px"},onKeyup:w(Ha,["enter"]),onClear:Wa},{prefix:v(()=>[c(r,null,{default:v(()=>[c(p(Y))]),_:1})]),_:1},8,["modelValue"]),c(l,{type:"primary",onClick:Ha,disabled:!ma.value.trim(),class:"search-btn"},{default:v(()=>[...a[21]||(a[21]=[m(" 搜索 ",-1)])]),_:1},8,["disabled"]),pa.value?(u(),b(l,{key:0,onClick:Wa,class:"clear-btn"},{default:v(()=>[...a[22]||(a[22]=[m(" 清除 ",-1)])]),_:1})):_("",!0)])])])]),default:v(()=>[h((u(),b(Xa,{data:Ma.value,class:"share-table","row-class-name":Ka,onRowClick:Qa},{default:v(()=>[c(fa,{prop:"shareNumber",label:"分享编号",width:"140"}),c(fa,{prop:"orderNumber",label:"订单编号",width:"140"},{default:v(({row:e})=>[c(ha,{type:"primary",onClick:a=>Ba(e.orderId)},{default:v(()=>[m(f(e.orderNumber),1)]),_:2},1032,["onClick"])]),_:1}),c(fa,{prop:"orderAmount",label:"订单金额",width:"120"},{default:v(({row:e})=>[m(" ¥"+f(e.orderAmount.toLocaleString()),1)]),_:1}),c(fa,{label:"分享成员",width:"200"},{default:v(({row:e})=>[i("div",fe,[(u(!0),n(g,null,y(e.shareMembers,e=>(u(),b(La,{key:e.userId,size:"small",type:e.userId===p(Xe).currentUser?.id?"success":"info",style:{"margin-right":"5px"}},{default:v(()=>[m(f(e.userName)+" ("+f(e.percentage)+"%) ",1)]),_:2},1032,["type"]))),128))])]),_:1}),c(fa,{prop:"createTime",label:"创建时间",width:"160"}),c(fa,{prop:"status",label:"状态",width:"100"},{default:v(({row:e})=>[c(La,{type:Fa(e.status)},{default:v(()=>[m(f(Ea(e.status)),1)]),_:2},1032,["type"])]),_:1}),c(fa,{prop:"createdBy",label:"创建人",width:"100"}),c(fa,{label:"操作",width:"150",fixed:"right"},{default:v(({row:e})=>{return[i("div",he,[c(l,{type:"info",size:"small",plain:"",onClick:a=>Ta(e),class:"action-btn view-btn"},{default:v(()=>[c(r,null,{default:v(()=>[c(p(L))]),_:1}),a[24]||(a[24]=m(" 详情 ",-1))]),_:1},8,["onClick"]),"active"===e.status&&(t=e,Xe.isAdmin&&"active"===t.status)?(u(),b(l,{key:0,type:"primary",size:"small",plain:"",onClick:a=>(e=>{sa.value=!0,ya.value={orderId:e.orderId,shareMembers:[...e.shareMembers],description:e.description},Ca.value=wa.value.find(a=>a.id===e.orderId),la.value=!0})(e),class:"action-btn edit-btn"},{default:v(()=>[c(r,null,{default:v(()=>[c(p(D))]),_:1}),a[25]||(a[25]=m(" 编辑 ",-1))]),_:1},8,["onClick"])):_("",!0),"active"===e.status&&Oa(e)?(u(),b(l,{key:1,type:"danger",size:"small",plain:"",onClick:a=>(async e=>{try{await $.confirm("确定要取消这个业绩分享吗？","确认取消",{type:"warning"}),await J.cancelPerformanceShare(e.id)?(B.success("业绩分享已取消"),await Na(),await J.syncPerformanceData()):B.error("取消失败，请重试")}catch(a){console.error("取消分享失败:",a),B.error("取消失败")}})(e),class:"action-btn cancel-btn"},{default:v(()=>[c(r,null,{default:v(()=>[c(p(z))]),_:1}),a[26]||(a[26]=m(" 取消 ",-1))]),_:1},8,["onClick"])):_("",!0)])];var t}),_:1})]),_:1},8,["data"])),[[ul,aa.value]]),i("div",be,[c(al,{"current-page":na.value,"onUpdate:currentPage":a[3]||(a[3]=e=>na.value=e),"page-size":ua.value,"onUpdate:pageSize":a[4]||(a[4]=e=>ua.value=e),"page-sizes":[10,20,50,100],total:ia.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:el,onCurrentChange:Za},null,8,["current-page","page-size","total"])])]),_:1}),c(nl,{modelValue:la.value,"onUpdate:modelValue":a[9]||(a[9]=e=>la.value=e),title:sa.value?"编辑分享":"新建分享",width:"800px","close-on-click-modal":!1},{footer:v(()=>[c(l,{onClick:Ra},{default:v(()=>[...a[31]||(a[31]=[m("取消",-1)])]),_:1}),c(l,{type:"primary",onClick:ja,loading:da.value,disabled:100!==Sa.value},{default:v(()=>[m(f(sa.value?"更新":"确认分享"),1)]),_:1},8,["loading","disabled"])]),default:v(()=>[c(ol,{ref_key:"shareFormRef",ref:ga,model:ya.value,rules:_a,"label-width":"100px"},{default:v(()=>[c(rl,{label:"订单搜索",prop:"orderId"},{default:v(()=>[i("div",ge,[c(E,{modelValue:xa.value,"onUpdate:modelValue":a[5]||(a[5]=e=>xa.value=e),placeholder:"请输入完整订单号（如：ORD20250101001）或客户信息进行搜索",clearable:"",onInput:a[6]||(a[6]=e=>(async e=>{if(!e||0===e.trim().length)return wa.value=[],Ca.value=null,void(ya.value.orderId="");oa.value=!0;try{await new Promise(e=>setTimeout(e,200));const a=ea.searchOrders(e).filter(e=>!Va.value.some(a=>a.orderId===e.id)),l=a.find(a=>a.orderNumber.toLowerCase()===e.toLowerCase().trim());if(l)return Ca.value=l,ya.value.orderId=l.id,void(wa.value=[l]);wa.value=a.slice(0,10),1===wa.value.length&&(Ca.value=wa.value[0],ya.value.orderId=wa.value[0].id)}catch(a){console.error("搜索订单失败:",a),B.error("搜索订单失败，请重试")}finally{oa.value=!1}})(xa.value)),onClear:Da,style:{"margin-bottom":"10px"},loading:oa.value},{prefix:v(()=>[c(r,null,{default:v(()=>[c(p(Y))]),_:1})]),suffix:v(()=>[c(ll,{content:"支持订单号、客户名称、客户电话搜索",placement:"top"},{default:v(()=>[c(r,null,{default:v(()=>[c(p(j))]),_:1})]),_:1})]),_:1},8,["modelValue","loading"]),xa.value&&!oa.value?(u(),n("div",ye,[0===wa.value.length?(u(),n("span",_e,[c(r,null,{default:v(()=>[c(p(P))]),_:1}),a[27]||(a[27]=m(" 未找到匹配的订单，请检查订单号是否正确 ",-1))])):Ca.value?(u(),n("span",we,[c(r,null,{default:v(()=>[c(p(R))]),_:1}),m(" 已找到订单："+f(Ca.value.orderNumber),1)])):wa.value.length>1?(u(),n("span",ke,[c(r,null,{default:v(()=>[c(p(T))]),_:1}),m(" 找到 "+f(wa.value.length)+" 个匹配订单，请从下方选择 ",1)])):_("",!0)])):_("",!0),wa.value.length>1&&!Ca.value?(u(),b(q,{key:1,modelValue:ya.value.orderId,"onUpdate:modelValue":a[7]||(a[7]=e=>ya.value.orderId=e),placeholder:"从搜索结果中选择订单",style:{width:"100%","margin-top":"10px"},onChange:za},{default:v(()=>[(u(!0),n(g,null,y(wa.value,e=>(u(),b(I,{key:e.id,label:`${e.orderNumber} - ¥${e.totalAmount.toLocaleString()} - ${e.customerName}`,value:e.id},{default:v(()=>[i("div",Ce,[i("div",Ie,[c(La,{type:"primary",size:"small"},{default:v(()=>[m(f(e.orderNumber),1)]),_:2},1024),i("span",xe,f(e.customerName),1),i("span",Ve,"¥"+f(e.totalAmount.toLocaleString()),1)]),i("div",Ue,[i("span",Me,f(e.customerPhone),1),i("span",Se,f(e.createTime),1)])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])):_("",!0)])]),_:1}),Ca.value?(u(),n("div",Ne,[i("div",Le,[c(r,{class:"info-icon"},{default:v(()=>[c(p(T))]),_:1}),a[28]||(a[28]=i("span",{class:"info-title"},"订单详情",-1))]),c(sl,{column:2,border:"",size:"small"},{default:v(()=>[c(tl,{label:"订单编号"},{default:v(()=>[c(La,{type:"primary"},{default:v(()=>[m(f(Ca.value.orderNumber),1)]),_:1})]),_:1}),c(tl,{label:"客户名称"},{default:v(()=>[m(f(Ca.value.customerName),1)]),_:1}),c(tl,{label:"订单金额"},{default:v(()=>[i("span",De,"¥"+f(Ca.value.totalAmount.toLocaleString()),1)]),_:1}),c(tl,{label:"创建时间"},{default:v(()=>[m(f(Ca.value.createTime),1)]),_:1}),c(tl,{label:"订单状态"},{default:v(()=>{return[c(La,{type:(e=Ca.value.status,{pending:"warning",confirmed:"primary",shipped:"info",delivered:"success",cancelled:"danger"}[e]||"info")},{default:v(()=>[m(f(Ja(Ca.value.status)),1)]),_:1},8,["type"])];var e}),_:1}),c(tl,{label:"审核状态"},{default:v(()=>{return[c(La,{type:(e=Ca.value.auditStatus,{pending:"warning",approved:"success",rejected:"danger"}[e]||"info")},{default:v(()=>[m(f(Ga(Ca.value.auditStatus)),1)]),_:1},8,["type"])];var e}),_:1})]),_:1})])):_("",!0),c(rl,{label:"分享成员",prop:"shareMembers",style:{"margin-top":"20px"}},{default:v(()=>[i("div",ze,[(u(!0),n(g,null,y(ya.value.shareMembers,(e,r)=>(u(),n("div",{key:r,class:"member-item"},[c(q,{modelValue:e.userId,"onUpdate:modelValue":a=>e.userId=a,placeholder:"选择成员",filterable:"",clearable:"",style:{width:"280px"},onChange:e=>(e=>{const a=ya.value.shareMembers[e],l=ka.value.find(e=>e.id===a.userId);l&&(a.userName=l.name)})(r)},{default:v(()=>[(u(!0),n(g,null,y(ka.value,e=>{return u(),b(I,{key:e.id,label:`${e.name} (${e.department||"未知部门"} - ${t=e.role,{sales_staff:"销售员",sales_manager:"销售经理",department_manager:"部门经理",admin:"管理员",customer_service:"客服"}[t]||t})`,value:e.id,disabled:(a=e.id,l=r,ya.value.shareMembers.some((e,r)=>r!==l&&e.userId===a))},null,8,["label","value","disabled"]);var a,l,t}),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),c(dl,{modelValue:e.percentage,"onUpdate:modelValue":a=>e.percentage=a,min:1,max:100,precision:1,style:{width:"120px","margin-left":"10px"},onChange:Ya},null,8,["modelValue","onUpdate:modelValue"]),a[29]||(a[29]=i("span",{style:{"margin-left":"5px"}},"%",-1)),ya.value.shareMembers.length>1?(u(),b(l,{key:0,type:"danger",size:"small",icon:p(O),circle:"",style:{"margin-left":"10px"},onClick:e=>(e=>{ya.value.shareMembers.splice(e,1)})(r)},null,8,["icon","onClick"])):_("",!0)]))),128)),c(l,{type:"primary",size:"small",icon:p(x),onClick:Aa,disabled:ya.value.shareMembers.length>=5},{default:v(()=>[...a[30]||(a[30]=[m(" 添加成员 ",-1)])]),_:1},8,["icon","disabled"]),i("div",Ae,[m(" 总比例: "+f(Sa.value)+"% ",1),100!==Sa.value?(u(),n("span",Ye," (比例总和必须为100%) ")):_("",!0)])])]),_:1}),c(rl,{label:"分享说明",prop:"description"},{default:v(()=>[c(E,{modelValue:ya.value.description,"onUpdate:modelValue":a[8]||(a[8]=e=>ya.value.description=e),type:"textarea",rows:3,placeholder:"请输入分享说明（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),c(nl,{modelValue:ra.value,"onUpdate:modelValue":a[10]||(a[10]=e=>ra.value=e),title:"分享详情",width:"600px"},{default:v(()=>[Ia.value?(u(),n("div",je,[c(sl,{column:1,border:""},{default:v(()=>[c(tl,{label:"分享编号"},{default:v(()=>[m(f(Ia.value.shareNumber),1)]),_:1}),c(tl,{label:"订单编号"},{default:v(()=>[m(f(Ia.value.orderNumber),1)]),_:1}),c(tl,{label:"订单金额"},{default:v(()=>[m("¥"+f(Ia.value.orderAmount.toLocaleString()),1)]),_:1}),c(tl,{label:"创建时间"},{default:v(()=>[m(f(Ia.value.createTime),1)]),_:1}),c(tl,{label:"创建人"},{default:v(()=>[m(f(Ia.value.createdBy),1)]),_:1}),c(tl,{label:"状态"},{default:v(()=>[c(La,{type:Fa(Ia.value.status)},{default:v(()=>[m(f(Ea(Ia.value.status)),1)]),_:1},8,["type"])]),_:1})]),_:1}),i("div",Pe,[a[33]||(a[33]=i("h4",{class:"section-title"},"分享明细",-1)),i("div",Re,[(u(!0),n(g,null,y(Ia.value.shareMembers,(e,l)=>(u(),n("div",{key:l,class:"member-share-card"},[i("div",Te,[i("div",Oe,[c(r,null,{default:v(()=>[c(p(S))]),_:1})]),i("div",Be,[i("div",$e,f(e.userName),1),c(La,{type:"confirmed"===e.status?"success":"warning",size:"small",class:"member-status"},{default:v(()=>[m(f("confirmed"===e.status?"已确认":"待确认"),1)]),_:2},1032,["type"])])]),i("div",qe,[i("div",Fe,[i("div",Ee,[i("span",Je,f(e.percentage)+"%",1)])]),i("div",Ke,[a[32]||(a[32]=i("div",{class:"amount-label"},"分享金额",-1)),i("div",Qe," ¥"+f((Ia.value.orderAmount*e.percentage/100).toLocaleString()),1)])]),i("div",Ge,[e.confirmTime?(u(),n("div",Ze," 确认时间："+f(e.confirmTime),1)):_("",!0)])]))),128))])]),Ia.value.description?(u(),n("div",He,[a[34]||(a[34]=i("h4",null,"分享说明",-1)),i("p",null,f(Ia.value.description),1)])):_("",!0)])):_("",!0)]),_:1},8,["modelValue"]),c(nl,{modelValue:ta.value,"onUpdate:modelValue":a[12]||(a[12]=e=>ta.value=e),title:"分享记录 - 全屏查看",fullscreen:"","close-on-click-modal":!1},{footer:v(()=>[c(l,{onClick:a[11]||(a[11]=e=>ta.value=!1)},{default:v(()=>[...a[37]||(a[37]=[m("关闭",-1)])]),_:1}),c(l,{type:"primary",onClick:qa,icon:p(V)},{default:v(()=>[...a[38]||(a[38]=[m(" 导出数据 ",-1)])]),_:1},8,["icon"])]),default:v(()=>[h((u(),b(Xa,{data:Ma.value,class:"fullscreen-table",height:"calc(100vh - 200px)","row-class-name":Ka},{default:v(()=>[c(fa,{prop:"shareNumber",label:"分享编号",width:"140",fixed:""}),c(fa,{prop:"orderNumber",label:"订单编号",width:"140",fixed:""},{default:v(({row:e})=>[c(ha,{type:"primary",onClick:a=>Ba(e.orderId)},{default:v(()=>[m(f(e.orderNumber),1)]),_:2},1032,["onClick"])]),_:1}),c(fa,{prop:"fromMember",label:"分享人",width:"120"}),c(fa,{prop:"toMember",label:"接收人",width:"120"}),c(fa,{prop:"shareAmount",label:"分享金额",width:"120",align:"right"},{default:v(({row:e})=>[i("span",We,"¥"+f(e.shareAmount.toLocaleString()),1)]),_:1}),c(fa,{prop:"shareRatio",label:"分享比例",width:"100",align:"center"},{default:v(({row:e})=>[m(f(e.shareRatio)+"% ",1)]),_:1}),c(fa,{prop:"status",label:"状态",width:"100",align:"center"},{default:v(({row:e})=>[c(La,{type:Fa(e.status)},{default:v(()=>[m(f(Ea(e.status)),1)]),_:2},1032,["type"])]),_:1}),c(fa,{prop:"shareDate",label:"分享日期",width:"180"}),c(fa,{prop:"effectiveDate",label:"生效日期",width:"180"}),c(fa,{prop:"description",label:"分享说明","min-width":"200","show-overflow-tooltip":""}),c(fa,{label:"操作",width:"180",fixed:"right"},{default:v(({row:r})=>[c(l,{link:"",type:"primary",size:"small",onClick:e=>Ta(r)},{default:v(()=>[...a[35]||(a[35]=[m(" 查看详情 ",-1)])]),_:1},8,["onClick"]),"active"===r.status&&Oa(r)?(u(),b(l,{key:0,link:"",type:"danger",size:"small",onClick:a=>e.handleCancelShare(r)},{default:v(()=>[...a[36]||(a[36]=[m(" 取消分享 ",-1)])]),_:1},8,["onClick"])):_("",!0)]),_:1})]),_:1},8,["data"])),[[ul,aa.value]])]),_:1},8,["modelValue"])],2)}}}),[["__scopeId","data-v-9329652e"]]);export{Xe as default};
