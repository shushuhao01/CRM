import{l as e,aA as a,aC as t,r as l,Z as r,e as o,b as n,w as s,Y as i,ag as d,aq as u,m as c,q as p,p as m,U as v,F as f,a9 as g,M as h,O as y,S as b,T as _,a7 as w,P as k,V as A,Q as N,u as T,a2 as S}from"./vendor-BtukhyiH.js";import{d as C,u as V,h as R,f as x,b as L,e as P,E,S as U,c as D,r as z,_ as I}from"./index-C4IdUW1A.js";import{C as M,G as j,j as $,X as O,r as H,d as q,Y as W,b as B,E as F}from"./elementPlus-DxaqjplL.js";import{a as Q}from"./export-D-SEmR7Z.js";import{orderApi as G}from"./order-DOc9fodO.js";import{d as J}from"./sensitiveInfo-CTSC2tj2.js";import"./utils-DfI7e5Rl.js";const K={class:"order-list"},Y={class:"quick-filters"},X={class:"search-header"},Z={class:"search-actions"},ee={class:"advanced-search"},ae={class:"table-card-container"},te={class:"table-header"},le={class:"table-title"},re={key:0,class:"selected-info"},oe={class:"table-actions"},ne={class:"column-settings-container"},se={class:"column-settings-header"},ie=["onDragstart","onDrop"],de={key:3,class:"amount-text"},ue={key:4},ce={key:5,class:"product-list"},pe={key:6},me={key:0,class:"deposit-text"},ve={key:1,class:"no-deposit"},fe={key:7},ge={key:8},he={key:9},ye={class:"operation-buttons"},be={class:"pagination-container"},_e={class:"pagination-info"},we={class:"pagination"},ke={class:"cancel-order-form"},Ae={class:"order-info"},Ne={class:"dialog-footer"},Te={class:"audit-footer",style:{"margin-top":"20px","text-align":"right"}},Se={class:"audit-footer",style:{"margin-top":"20px","text-align":"right"}},Ce=I(e({name:"OrderList",__name:"List",setup(e){const I=a(),Ce=t(),Ve=D(I),Re=C(),xe=V();R(),x();const Le=L(),Pe=l(!1),Ee=l(!1),Ue=l("all"),De=l([]),ze=l({prop:"createTime",order:"descending"}),Ie=l({}),Me=l(!1),je=l(!1),$e=l(),Oe=l({id:"",orderNumber:"",customerName:"",totalAmount:0}),He=r({reason:"",description:""}),qe={reason:[{required:!0,message:"请选择取消原因",trigger:"change"}]},We=l(!1),Be=l("pending"),Fe=l([]),Qe=l(!1),Ge=r({orderNumber:"",customerName:"",status:[],markType:"",dateRange:[],minAmount:void 0,maxAmount:void 0,operator:"",productName:"",customerPhone:"",paymentMethod:"",onlyAuditPendingSubmitted:!1,onlyResubmittable:!1}),Je=r({page:1,size:20,total:0}),Ke=l([{key:"all",label:"全部",count:0},{key:"pending",label:"待审核",count:0},{key:"approved",label:"已审核",count:0},{key:"shipped",label:"已发货",count:0},{key:"delivered",label:"已签收",count:0},{key:"pending_deposit",label:"待付定金",count:0},{key:"pending_payment",label:"待付尾款",count:0}]),Ye=l([{prop:"orderNumber",label:"订单号",visible:!0},{prop:"customerName",label:"客户姓名",visible:!0},{prop:"status",label:"状态",visible:!0},{prop:"markType",label:"标记",visible:!0},{prop:"totalAmount",label:"订单金额",visible:!0},{prop:"salesPersonName",label:"负责销售",visible:!0},{prop:"products",label:"商品",visible:!0},{prop:"depositAmount",label:"定金",visible:!0},{prop:"collectAmount",label:"代收金额",visible:!0},{prop:"serviceWechat",label:"客服微信号",visible:!0},{prop:"orderSource",label:"订单来源",visible:!0},{prop:"remark",label:"订单备注",visible:!1},{prop:"receiverPhone",label:"收货电话",visible:!1},{prop:"paymentMethod",label:"支付方式",visible:!1},{prop:"createTime",label:"创建时间",visible:!0}]),Xe=o(()=>xe.users.filter(e=>["sales_staff","department_manager","admin","super_admin","customer_service"].includes(e.role)).map(e=>({id:e.id,name:e.realName||e.name||e.username,department:e.departmentName||e.department||"未分配"}))),Ze=o(()=>xe.users.map(e=>({id:e.id,name:e.realName||e.name||e.username}))),ea=o(()=>Re.orders),aa=e=>({reserved:"预留单",normal:"正常发货单",return:"退单"}[e]||"正常发货单"),ta=(e,a,t)=>{if("pending"===e)return t?"待审核":"待流转";return{pending_transfer:"待流转",pending_audit:"待审核",audit_rejected:"审核拒绝",pending_shipment:"待发货",shipped:"已发货",delivered:"已签收",package_exception:"包裹异常",rejected:"拒收",rejected_returned:"物流部退回",logistics_returned:"物流部退回",logistics_cancelled:"物流部取消",after_sales_created:"已建售后",pending_cancel:"待取消",cancel_failed:"取消失败",cancelled:"已取消",draft:"草稿",approved:"已审核",confirmed:"已确认",refunded:"退货退款"}[e]||"未知"},la=(e,a)=>{if("return"===a)return"warning";return{pending_transfer:"info",pending_audit:"warning",audit_rejected:"danger",pending_shipment:"primary",shipped:"primary",delivered:"success",package_exception:"warning",rejected:"danger",rejected_returned:"info",after_sales_created:"warning",pending_cancel:"warning",cancel_failed:"danger",cancelled:"info",draft:"info",pending:"warning",approved:"success",confirmed:"success",refunded:"info"}[e]||"info"},ra=e=>{const a=xe.currentUser;if(!a)return[];if(xe.isSuperAdmin)return e;if(xe.isDepartmentManager){const a=xe.accessibleDepartments;return e.filter(e=>{if(e.departmentId)return a.includes(e.departmentId);const t=Xe.value.find(a=>a.id===e.salesPersonId);return t&&a.includes(t.department)})}if(xe.isSalesStaff)return e.filter(e=>e.salesPersonId===a.id);if(xe.isCustomerService){const t=a.customerServiceType;return t?e.filter(e=>{switch(t){case"after_sales":return"return"===e.markType||"after_sales_created"===e.status;case"audit":return"pending_audit"===e.status||"pending"===e.auditStatus;case"general":return!0;default:return!1}}):[]}return e.filter(e=>e.createdBy===a.id)},oa=o(()=>{let e=ra(ea.value);if("all"!==Ue.value&&(e=e.filter(e=>{switch(Ue.value){case"pending_deposit":return"pending"===e.status&&e.depositAmount>0;case"pending_payment":return"approved"===e.status&&e.depositAmount>0;default:return e.status===Ue.value}})),Ge.orderNumber&&(e=e.filter(e=>e.orderNumber.toLowerCase().includes(Ge.orderNumber.toLowerCase()))),Ge.customerName&&(e=e.filter(e=>e.customerName.toLowerCase().includes(Ge.customerName.toLowerCase()))),Ge.customerPhone&&(e=e.filter(e=>e.customerPhone.includes(Ge.customerPhone))),Ge.status.length>0&&(e=e.filter(e=>Ge.status.includes(e.status))),Ge.markType&&(e=e.filter(e=>(e.markType||"normal")===Ge.markType)),Ge.operator&&(e=e.filter(e=>e.operator.toLowerCase().includes(Ge.operator.toLowerCase()))),Ge.productName&&(e=e.filter(e=>Array.isArray(e.products)&&e.products.some(e=>e.name.toLowerCase().includes(Ge.productName.toLowerCase())))),Ge.paymentMethod&&(e=e.filter(e=>e.paymentMethod===Ge.paymentMethod)),Ge.onlyAuditPendingSubmitted&&(e=e.filter(e=>"pending_audit"===e.status&&("pending"===e.auditStatus||!0===e.isAuditTransferred))),Ge.onlyResubmittable&&(e=e.filter(e=>ha(e.status,e.auditStatus,e.isAuditTransferred,e.operatorId))),void 0!==Ge.minAmount&&(e=e.filter(e=>e.totalAmount>=Ge.minAmount)),void 0!==Ge.maxAmount&&(e=e.filter(e=>e.totalAmount<=Ge.maxAmount)),Ge.dateRange&&2===Ge.dateRange.length){const[a,t]=Ge.dateRange;e=e.filter(e=>{const l=new Date(e.createTime);return l>=a&&l<=t})}const{prop:a,order:t}=ze.value||{prop:"createTime",order:"descending"};if(a&&t&&null!==t){const l=(e,a)=>{switch(a){case"createTime":return new Date(e.createTime).getTime()||0;case"totalAmount":case"depositAmount":return Number(e[a]??0);case"products":return Array.isArray(e.products)?e.products.length:0;default:const t=e[a];return"string"==typeof t?t.toLowerCase():Number(t??0)}};e=e.slice().sort((e,r)=>{const o=l(e,a),n=l(r,a);let s=0;return s="string"==typeof o&&"string"==typeof n?o.localeCompare(n):o-n,"ascending"===t?s:-s})}return e}),na=o(()=>xe.isDepartmentHead||xe.isManager||xe.isSuperAdmin),sa=o(()=>ra(ea.value).filter(e=>"pending_cancel"===e.status)),ia=o(()=>ra(ea.value).filter(e=>"cancelled"===e.status||"cancel_failed"===e.status)),da=e=>({customer_cancel:"客户主动取消",out_of_stock:"商品缺货",price_change:"价格调整",order_error:"订单信息错误",other:"其他原因","客户要求取消":"客户要求取消","商品缺货":"商品缺货","价格争议":"价格争议"}[e]||e),ua=o(()=>window.innerHeight-60-60-120-60-40),ca=o(()=>Ye.value.filter(e=>e.visible).map(e=>{const a={prop:e.prop,label:e.label,visible:e.visible};switch(e.prop){case"orderNumber":case"createTime":return{...a,width:180,sortable:"custom"};case"customerName":case"totalAmount":return{...a,width:120,sortable:"custom"};case"salesPersonName":case"status":case"operator":return{...a,width:100,sortable:"custom"};case"markType":return{...a,width:100,align:"center"};case"customerPhone":return{...a,width:130};case"products":return{...a,minWidth:200};case"depositAmount":return{...a,width:120};case"paymentMethod":return{...a,width:100};default:return a}})),pa=(e,a)=>{switch(a.prop){case"orderNumber":return e.orderNumber;case"customerName":return e.customerName;case"salesPersonName":return e.createdByName||e.createdBy||"系统用户";case"status":return ta(e.status);case"markType":return aa(e.markType||"normal");case"totalAmount":return`¥${(e.totalAmount||0).toLocaleString()}`;case"receiverPhone":return e.receiverPhone?J(e.receiverPhone,U.PHONE):"-";case"products":return Array.isArray(e.products)?e.products.map(e=>`${e.name} × ${e.quantity}`).join(", "):e.products||"-";case"depositAmount":return e.depositAmount?`¥${e.depositAmount.toLocaleString()}`:"-";case"collectAmount":return e.collectAmount?`¥${e.collectAmount.toLocaleString()}`:"-";case"paymentMethod":return ma(e.paymentMethod,e.paymentMethodOther);case"orderSource":return va(e.orderSource);case"createTime":return e.createTime;case"operator":return e.operator;default:return e[a.prop]||"-"}},ma=(e,a)=>{if(!e)return"-";if("other"===e&&a)return a;return{wechat:"微信支付",alipay:"支付宝",bank_transfer:"银行转账",unionpay:"云闪付",cod:"货到付款",cash:"现金",card:"刷卡",other:"其他"}[e]||e},va=e=>{if(!e)return"-";return{online_store:"线上商城",wechat_mini:"微信小程序",wechat_service:"微信客服",phone_call:"电话咨询",offline_store:"线下门店",referral:"客户推荐",advertisement:"广告投放",other:"其他渠道"}[e]||e},fa=(e,a)=>!!["pending_transfer","pending_audit","audit_rejected","pending_shipment","logistics_returned","cancel_failed"].includes(e)&&("cancelled"!==e&&(!!xe.isSuperAdmin||(!!xe.isManager||a===xe.user.id))),ga=e=>["shipped","delivered","rejected","package_exception","rejected_returned"].includes(e),ha=(e,a,t,l)=>!!["pending_transfer","audit_rejected","logistics_returned","cancel_failed"].includes(e)&&(!(!xe.isSuperAdmin&&!xe.isManager)||l===xe.user.id),ya=()=>{Ee.value=!Ee.value},ba=({prop:e,order:a})=>{ze.value={prop:e,order:a}},_a=e=>{De.value=e},wa=e=>{e||ka()},ka=()=>{const e=Ye.value.map(e=>({prop:e.prop,label:e.label,visible:e.visible}));localStorage.setItem("orderListColumnSettings",JSON.stringify(e))},Aa=()=>{Ye.value.forEach(e=>{e.visible=["orderNumber","customerName","status","markType","products","totalAmount","createTime","operator"].includes(e.prop)}),ka()};let Na=-1;const Ta=e=>{e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move")},Sa=async()=>{if(De.value&&0!==De.value.length)try{await B.confirm(`确定要取消选中的 ${De.value.length} 个订单吗？`,"批量取消",{type:"warning"}),Pe.value=!0,await z.post("/api/orders/batch-cancel",{orderIds:De.value.map(e=>e.id),operatorId:xe.user.id}),De.value.forEach(e=>{const a=ea.value.find(a=>a.id===e.id);a&&(a.status="cancelled",Le.sendMessage(Le.MessageType.ORDER_CANCELLED,`订单 ${a.orderNumber} (客户: ${a.customerName}, 金额: ¥${a.totalAmount?.toLocaleString()}) 已取消`,{relatedId:a.id,relatedType:"order",actionUrl:`/order/detail/${a.id}`}))}),De.value=[],F.success("批量取消成功"),Ra()}catch(e){"cancel"!==e&&F.error("批量取消失败，请重试")}finally{Pe.value=!1}else F.warning("请先选择要取消的订单")},Ca=async()=>{if(De.value&&0!==De.value.length)try{Pe.value=!0;const e=De.value.map(e=>({orderNumber:e.orderNumber||"",customerName:e.customerName||"",customerPhone:e.customerPhone||"",receiverName:e.receiverName||"",receiverPhone:e.receiverPhone||"",receiverAddress:e.receiverAddress||"",products:e.products||[],totalQuantity:e.totalQuantity||0,totalAmount:e.totalAmount||0,depositAmount:e.depositAmount||0,codAmount:e.codAmount||0,customerAge:e.customerAge||0,customerHeight:e.customerHeight||0,customerWeight:e.customerWeight||0,medicalHistory:e.medicalHistory||"",serviceWechat:e.serviceWechat||"",remark:e.remark||"",createTime:e.createTime||"",status:e.status||"",shippingStatus:e.shippingStatus||""}));await Q(e,xe.isAdmin),F.success(`成功导出 ${De.value?.length||0} 条订单数据`)}catch{F.error("导出失败，请重试")}finally{Pe.value=!1}else F.warning("请先选择要导出的订单")},Va=async()=>{try{Pe.value=!0;const e=oa.value.map(e=>({orderNumber:e.orderNumber||"",customerName:e.customerName||"",customerPhone:e.customerPhone||"",receiverName:e.receiverName||"",receiverPhone:e.receiverPhone||"",receiverAddress:e.receiverAddress||"",products:e.products||[],totalQuantity:e.totalQuantity||0,totalAmount:e.totalAmount||0,depositAmount:e.depositAmount||0,codAmount:e.codAmount||0,customerAge:e.customerAge||0,customerHeight:e.customerHeight||0,customerWeight:e.customerWeight||0,medicalHistory:e.medicalHistory||"",serviceWechat:e.serviceWechat||"",remark:e.remark||"",createTime:e.createTime||"",status:e.status||"",shippingStatus:e.shippingStatus||""}));await Q(e,xe.isAdmin),F.success(`成功导出 ${e.length} 条订单数据`)}catch{F.error("导出失败，请重试")}finally{Pe.value=!1}},Ra=()=>{Ke.value.forEach(e=>{"all"===e.key?e.count=ea.value.length:"pending_deposit"===e.key?e.count=ea.value.filter(e=>"pending"===e.status&&e.depositAmount>0).length:"pending_payment"===e.key?e.count=ea.value.filter(e=>"approved"===e.status&&e.depositAmount>0).length:e.count=ea.value.filter(a=>a.status===e.key).length})},xa=()=>{Ve.push("/order/add")},La=e=>{Ve.push(`/order/detail/${e.id}`)},Pa=()=>{Me.value=!1,$e.value&&$e.value.clearValidate()},Ea=async()=>{if($e.value)try{await $e.value.validate(),je.value=!0,await G.cancelRequest({orderId:Oe.value.id,reason:He.reason,description:He.description,operatorId:xe.user?.id||"current_user"});const e=ea.value.find(e=>e.id===Oe.value.id);e&&(e.status="pending_cancel",e.cancelStatus="pending",e.cancelReason=He.reason,e.cancelDescription=He.description,e.cancelRequestTime=(new Date).toLocaleString("zh-CN"),e.updateTime=(new Date).toLocaleString("zh-CN"),Le.sendMessage(Le.MessageType.ORDER_CANCEL_REQUEST,`订单 ${e.orderNumber} 的取消申请已提交，等待管理员审核`,{relatedId:e.id,relatedType:"order",actionUrl:`/order/detail/${e.id}`})),F.success("取消申请已提交，等待管理员审核"),Me.value=!1,Ra()}catch(e){console.error("取消订单申请失败:",e);let a="提交取消申请失败，请重试";e&&"object"==typeof e&&(e.response?.data?.message?a=e.response.data.message:e.data?.message?a=e.data.message:e.message&&(a=e.message)),F.error(a)}finally{je.value=!1}},Ua=()=>{We.value=!0,Be.value="pending",Fe.value=[]},Da=()=>{We.value=!1,Fe.value=[]},za=e=>{Be.value=e,Fe.value=[]},Ia=e=>{Fe.value=e},Ma=async()=>{if(0!==Fe.value.length){if(!Qe.value)try{Qe.value=!0;const e=Fe.value.map(e=>e.id),a=await Re.approveCancelOrders(e);if(!1===a||void 0===a)return void F.error("审核通过失败，请重试");F.success("审核通过成功"),Fe.value=[],await Qa(),Da()}catch(e){console.error("审核通过失败:",e),F.error("审核通过失败，请重试")}finally{Qe.value=!1}}else F.warning("请选择要审核的订单")},ja=async()=>{if(0!==Fe.value.length){if(!Qe.value)try{Qe.value=!0;const e=Fe.value.map(e=>e.id),a=await Re.rejectCancelOrders(e);if(!1===a||void 0===a)return void F.error("审核拒绝失败，请重试");F.success("审核拒绝成功"),Fe.value=[],await Qa(),Da()}catch(e){console.error("审核拒绝失败:",e),F.error("审核拒绝失败，请重试")}finally{Qe.value=!1}}else F.warning("请选择要审核的订单")},$a=()=>{Je.page=1,Wa()},Oa=()=>{Ge.orderNumber="",Ge.customerName="",Ge.status=[],Ge.markType="",Ge.dateRange=[],Ge.minAmount=void 0,Ge.maxAmount=void 0,Ge.operator="",Ge.productName="",Ge.customerPhone="",Ge.paymentMethod="",Ge.onlyAuditPendingSubmitted=!1,Ge.onlyResubmittable=!1,Ue.value="all",Ee.value=!1,Je.page=1,Wa()},Ha=e=>{Je.size=e,Je.page=1,Wa()},qa=e=>{Je.page=e,Wa()},Wa=()=>{Je.total=oa.value.length};let Ba=!1,Fa=0;const Qa=async(e=!1)=>{const a=Date.now();if(e||!(Ba||a-Fa<500))try{Ba=!0,Pe.value=!0,Fa=a;0===(await Re.loadOrdersFromAPI()).length&&0===Re.orders.length&&console.log("[订单列表] API无数据，检查是否需要初始化本地数据"),Wa(),Ra()}catch(t){console.error("加载订单列表失败:",t),Re.orders.length,Wa(),Ra()}finally{Pe.value=!1,Ba=!1}else console.log("[订单列表] 跳过重复加载")},Ga=e=>{console.log("[订单列表] 收到订单流转事件:",e),Qa(),F.success(`${e.length} 个订单已自动流转到审核`)},Ja=()=>{console.log("[订单列表] 收到刷新列表事件"),Qa()},Ka=e=>{console.log("[订单列表] 订单状态变更:",e),Qa()},Ya=()=>{};n(async()=>{(()=>{const e=localStorage.getItem("orderListColumnSettings");if(e)try{JSON.parse(e).forEach(e=>{const a=Ye.value.find(a=>a.prop===e.prop);a&&(a.visible=e.visible)})}catch(a){console.warn("Failed to load column settings:",a)}})();const e=[xe.loadUsers(),Qa(!0)];await Promise.all(e),setTimeout(()=>{Re.setupLogisticsEventListener(),Re.startLogisticsAutoSync()},100),window.addEventListener("resize",Ya),window.addEventListener("orderStatusUpdated",Xa),window.addEventListener("orderUpdated",Za),window.addEventListener("todoStatusUpdated",et),P.on(E.ORDER_TRANSFERRED,Ga),P.on(E.REFRESH_ORDER_LIST,Ja),P.on(E.ORDER_STATUS_CHANGED,Ka)});const Xa=e=>{console.log("订单状态已更新，刷新订单列表",e.detail),Qa()},Za=e=>{console.log("订单数据已更新，刷新订单列表",e.detail),Qa()},et=e=>{console.log("待办状态已更新，刷新订单列表",e.detail),Qa()};return s(()=>Ce.query,(e,a)=>{"true"===e.refresh&&"true"!==a?.refresh&&setTimeout(()=>{Ve.replace({path:"/order/list"})},100)},{immediate:!1}),i(()=>{window.removeEventListener("resize",Ya),window.removeEventListener("orderStatusUpdated",Xa),window.removeEventListener("todoStatusUpdated",et),P.off(E.ORDER_TRANSFERRED,Ga),P.off(E.REFRESH_ORDER_LIST,Ja),P.off(E.ORDER_STATUS_CHANGED,Ka);document.querySelectorAll('a[href^="blob:"]').forEach(e=>{const a=e.getAttribute("href");a&&a.startsWith("blob:")&&(URL.revokeObjectURL(a),e.parentNode&&e.parentNode.removeChild(e))})}),(e,a)=>{const t=d("el-tag"),l=d("el-button"),r=d("el-input"),o=d("el-form-item"),n=d("el-option"),s=d("el-select"),i=d("el-checkbox"),C=d("el-form"),V=d("el-date-picker"),R=d("el-col"),x=d("el-input-number"),L=d("el-row"),P=d("el-collapse-transition"),E=d("el-card"),U=d("el-icon"),D=d("el-dropdown-menu"),z=d("el-dropdown"),I=d("el-table-column"),Q=d("el-link"),Ce=d("el-table"),ze=d("el-pagination"),Xe=d("el-dialog"),ra=d("el-tab-pane"),Wa=d("el-tabs"),Ba=u("loading");return p(),c("div",K,[a[54]||(a[54]=m("div",{class:"page-header"},[m("h2",null,"订单管理")],-1)),m("div",Y,[(p(!0),c(f,null,g(Ke.value,e=>(p(),h(t,{key:e.key,type:Ue.value===e.key?"primary":"",effect:Ue.value===e.key?"dark":"plain",onClick:a=>{return t=e.key,Ue.value=t,Je.page=1,void Ra();var t},class:"filter-tag"},{default:y(()=>[b(_(e.label),1)]),_:2},1032,["type","effect","onClick"]))),128))]),v(E,{class:"search-card"},{default:y(()=>[m("div",X,[a[22]||(a[22]=m("span",{class:"search-title"},"筛选条件",-1)),m("div",Z,[v(l,{text:"",type:"primary",onClick:ya,icon:Ee.value?"ArrowUp":"ArrowDown"},{default:y(()=>[b(_(Ee.value?"收起":"高级筛选"),1)]),_:1},8,["icon"]),v(l,{text:"",type:"primary",onClick:Va,icon:"Download"},{default:y(()=>[...a[21]||(a[21]=[b(" 导出 ",-1)])]),_:1})])]),v(C,{model:Ge,inline:"",class:"basic-search"},{default:y(()=>[v(o,{label:"订单号"},{default:y(()=>[v(r,{modelValue:Ge.orderNumber,"onUpdate:modelValue":a[0]||(a[0]=e=>Ge.orderNumber=e),placeholder:"请输入订单号",clearable:"",onKeyup:w($a,["enter"])},null,8,["modelValue"])]),_:1}),v(o,{label:"客户姓名"},{default:y(()=>[v(r,{modelValue:Ge.customerName,"onUpdate:modelValue":a[1]||(a[1]=e=>Ge.customerName=e),placeholder:"请输入客户姓名",clearable:"",onKeyup:w($a,["enter"])},null,8,["modelValue"])]),_:1}),v(o,{label:"订单状态"},{default:y(()=>[v(s,{modelValue:Ge.status,"onUpdate:modelValue":a[2]||(a[2]=e=>Ge.status=e),placeholder:"请选择状态",clearable:"",multiple:"","collapse-tags":"",style:{"min-width":"200px",width:"auto"}},{default:y(()=>[v(n,{label:"待流转",value:"pending_transfer"}),v(n,{label:"待审核",value:"pending_audit"}),v(n,{label:"审核拒绝",value:"audit_rejected"}),v(n,{label:"待发货",value:"pending_shipment"}),v(n,{label:"已发货",value:"shipped"}),v(n,{label:"已签收",value:"delivered"}),v(n,{label:"物流部退回",value:"logistics_returned"}),v(n,{label:"物流部取消",value:"logistics_cancelled"}),v(n,{label:"待取消",value:"pending_cancel"}),v(n,{label:"取消失败",value:"cancel_failed"}),v(n,{label:"已取消",value:"cancelled"}),v(n,{label:"草稿",value:"draft"}),v(n,{label:"已审核",value:"approved"}),v(n,{label:"审核退回",value:"rejected"}),v(n,{label:"待付定金",value:"pending_deposit"}),v(n,{label:"待付尾款",value:"pending_payment"})]),_:1},8,["modelValue"])]),_:1}),v(o,{label:"标记"},{default:y(()=>[v(s,{modelValue:Ge.markType,"onUpdate:modelValue":a[3]||(a[3]=e=>Ge.markType=e),placeholder:"请选择标记",clearable:"",style:{"min-width":"140px",width:"auto"}},{default:y(()=>[v(n,{label:"正常发货单",value:"normal"}),v(n,{label:"预留单",value:"reserved"}),v(n,{label:"退单",value:"return"})]),_:1},8,["modelValue"])]),_:1}),v(o,null,{default:y(()=>[v(i,{modelValue:Ge.onlyAuditPendingSubmitted,"onUpdate:modelValue":a[4]||(a[4]=e=>Ge.onlyAuditPendingSubmitted=e)},{default:y(()=>[...a[23]||(a[23]=[b(" 仅显示已提审的待审核 ",-1)])]),_:1},8,["modelValue"]),v(i,{modelValue:Ge.onlyResubmittable,"onUpdate:modelValue":a[5]||(a[5]=e=>Ge.onlyResubmittable=e),style:{"margin-left":"16px"}},{default:y(()=>[...a[24]||(a[24]=[b(" 仅显示可再次提审 ",-1)])]),_:1},8,["modelValue"])]),_:1}),v(o,null,{default:y(()=>[v(l,{type:"primary",onClick:$a,icon:"Search"},{default:y(()=>[...a[25]||(a[25]=[b("搜索",-1)])]),_:1}),v(l,{onClick:Oa,icon:"Refresh"},{default:y(()=>[...a[26]||(a[26]=[b("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),v(P,null,{default:y(()=>[k(m("div",ee,[v(C,{model:Ge,inline:!1,"label-width":"100px"},{default:y(()=>[v(L,{gutter:20},{default:y(()=>[v(R,{span:8},{default:y(()=>[v(o,{label:"创建时间"},{default:y(()=>[v(V,{modelValue:Ge.dateRange,"onUpdate:modelValue":a[6]||(a[6]=e=>Ge.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),v(R,{span:8},{default:y(()=>[v(o,{label:"金额范围"},{default:y(()=>[v(x,{modelValue:Ge.minAmount,"onUpdate:modelValue":a[7]||(a[7]=e=>Ge.minAmount=e),placeholder:"最小金额",min:0,precision:2,style:{width:"48%"}},null,8,["modelValue"]),a[27]||(a[27]=m("span",{style:{margin:"0 2%"}},"-",-1)),v(x,{modelValue:Ge.maxAmount,"onUpdate:modelValue":a[8]||(a[8]=e=>Ge.maxAmount=e),placeholder:"最大金额",min:0,precision:2,style:{width:"48%"}},null,8,["modelValue"])]),_:1})]),_:1}),v(R,{span:8},{default:y(()=>[v(o,{label:"操作人"},{default:y(()=>[v(s,{modelValue:Ge.operator,"onUpdate:modelValue":a[9]||(a[9]=e=>Ge.operator=e),placeholder:"请选择操作人",clearable:"",filterable:""},{default:y(()=>[(p(!0),c(f,null,g(Ze.value,e=>(p(),h(n,{key:e.id,label:e.name,value:e.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),v(L,{gutter:20},{default:y(()=>[v(R,{span:8},{default:y(()=>[v(o,{label:"商品名称"},{default:y(()=>[v(r,{modelValue:Ge.productName,"onUpdate:modelValue":a[10]||(a[10]=e=>Ge.productName=e),placeholder:"请输入商品名称",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),v(R,{span:8},{default:y(()=>[v(o,{label:"客户电话"},{default:y(()=>[v(r,{modelValue:Ge.customerPhone,"onUpdate:modelValue":a[11]||(a[11]=e=>Ge.customerPhone=e),placeholder:"请输入客户电话",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),v(R,{span:8},{default:y(()=>[v(o,{label:"支付方式"},{default:y(()=>[v(s,{modelValue:Ge.paymentMethod,"onUpdate:modelValue":a[12]||(a[12]=e=>Ge.paymentMethod=e),placeholder:"请选择支付方式",clearable:""},{default:y(()=>[v(n,{label:"现金",value:"cash"}),v(n,{label:"银行转账",value:"bank_transfer"}),v(n,{label:"支付宝",value:"alipay"}),v(n,{label:"微信支付",value:"wechat"}),v(n,{label:"刷卡",value:"card"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])],512),[[A,Ee.value]])]),_:1})]),_:1}),m("div",ae,[m("div",te,[m("div",le,[a[28]||(a[28]=m("span",null,"订单列表",-1)),De.value.length>0?(p(),c("span",re," （已选择 "+_(De.value.length)+" 项） ",1)):N("",!0)]),m("div",oe,[v(l,{type:"primary",onClick:xa,size:"small"},{default:y(()=>[v(U,null,{default:y(()=>[v(T(M))]),_:1}),a[29]||(a[29]=b(" 新建订单 ",-1))]),_:1}),De.value.length>0?(p(),h(l,{key:0,type:"primary",size:"small",onClick:Ca,icon:T(j)},{default:y(()=>[...a[30]||(a[30]=[b(" 批量导出 ",-1)])]),_:1},8,["icon"])):N("",!0),De.value.length>0?(p(),h(l,{key:1,type:"danger",size:"small",onClick:Sa,icon:T($)},{default:y(()=>[...a[31]||(a[31]=[b(" 批量取消 ",-1)])]),_:1},8,["icon"])):N("",!0),na.value?(p(),h(l,{key:2,onClick:Ua,size:"small",icon:T(O),type:"warning"},{default:y(()=>[...a[32]||(a[32]=[b(" 取消订单审核 ",-1)])]),_:1},8,["icon"])):N("",!0),v(l,{onClick:Qa,size:"small",icon:T(H)},{default:y(()=>[...a[33]||(a[33]=[b(" 刷新 ",-1)])]),_:1},8,["icon"]),v(z,{trigger:"click",onVisibleChange:wa},{dropdown:y(()=>[v(D,null,{default:y(()=>[m("div",ne,[m("div",se,[a[36]||(a[36]=m("span",null,"列显示设置",-1)),v(l,{size:"small",text:"",onClick:Aa},{default:y(()=>[...a[35]||(a[35]=[b("重置",-1)])]),_:1})]),(p(!0),c(f,null,g(Ye.value,(e,t)=>(p(),c("div",{class:"column-item",key:e.prop,draggable:"true",onDragstart:e=>((e,a)=>{Na=a,e.dataTransfer&&(e.dataTransfer.effectAllowed="move")})(e,t),onDragover:Ta,onDrop:e=>((e,a)=>{if(e.preventDefault(),-1!==Na&&Na!==a){const e=Ye.value[Na];Ye.value.splice(Na,1),Ye.value.splice(a,0,e),ka()}Na=-1})(e,t)},[v(U,{class:"drag-handle"},{default:y(()=>[v(T(W))]),_:1}),v(i,{modelValue:e.visible,"onUpdate:modelValue":a=>e.visible=a,onClick:a[13]||(a[13]=S(()=>{},["stop"])),onChange:ka},{default:y(()=>[b(_(e.label),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])],40,ie))),128))])]),_:1})]),default:y(()=>[v(l,{size:"small"},{default:y(()=>[a[34]||(a[34]=b(" 列设置 ",-1)),v(U,null,{default:y(()=>[v(T(q))]),_:1})]),_:1})]),_:1})])]),k((p(),h(Ce,{data:oa.value,onSelectionChange:_a,onSortChange:ba,"default-sort":{prop:"createTime",order:"descending"},stripe:"",border:"",height:ua.value,style:{width:"100%"}},{default:y(()=>[v(I,{type:"selection",width:"55"}),(p(!0),c(f,null,g(ca.value,e=>(p(),h(I,{key:e.prop,prop:e.prop,label:e.label,width:e.width,"min-width":e.minWidth,sortable:e.sortable,align:e.align},{default:y(({row:a})=>{return["orderNumber"===e.prop?(p(),h(Q,{key:0,onClick:e=>La(a),type:"primary"},{default:y(()=>[b(_(a.orderNumber),1)]),_:2},1032,["onClick"])):"status"===e.prop?(p(),h(t,{key:1,type:la(a.status,a.markType)},{default:y(()=>[b(_(ta(a.status,a.markType,a.isAuditTransferred)),1)]),_:2},1032,["type"])):"markType"===e.prop?(p(),h(t,{key:2,type:(l=a.markType||"normal",{reserved:"warning",normal:"success",return:"danger"}[l]||"success"),size:"small",effect:"dark"},{default:y(()=>[b(_(aa(a.markType||"normal")),1)]),_:2},1032,["type"])):"totalAmount"===e.prop?(p(),c("span",de," ¥"+_((a.totalAmount||0).toLocaleString()),1)):"customerPhone"===e.prop?(p(),c("span",ue,_(a.customerPhone?T(J)(a.customerPhone,"phone"):"-"),1)):"products"===e.prop?(p(),c("div",ce,[(p(!0),c(f,null,g(a.products,e=>(p(),c("div",{key:e.id,class:"product-item"},_(e.name)+" × "+_(e.quantity),1))),128))])):"depositAmount"===e.prop?(p(),c("span",pe,[a.depositAmount?(p(),c("span",me," ¥"+_(a.depositAmount.toLocaleString()),1)):(p(),c("span",ve,"-"))])):"paymentMethod"===e.prop?(p(),c("span",fe,_(ma(a.paymentMethod,a.paymentMethodOther)),1)):"orderSource"===e.prop?(p(),c("span",ge,_(va(a.orderSource)),1)):(p(),c("span",he,_(pa(a,e)),1))];var l}),_:2},1032,["prop","label","width","min-width","sortable","align"]))),128)),v(I,{label:"操作","min-width":"200",fixed:"right"},{default:y(({row:e})=>{return[m("div",ye,[v(l,{type:"text",size:"small",onClick:a=>La(e)},{default:y(()=>[...a[37]||(a[37]=[b("详情",-1)])]),_:1},8,["onClick"]),"cancelled"!==e.status&&"after_sales_created"!==e.status?(p(),c(f,{key:0},[(t=e.status,r=e.operatorId,e.markType,e.auditStatus,e.isAuditTransferred,["pending_transfer","audit_rejected","logistics_returned","cancel_failed"].includes(t)&&(xe.isSuperAdmin||xe.isManager||r===xe.user.id)?(p(),h(l,{key:0,type:"text",size:"small",onClick:a=>(e=>{Ve.push(`/order/edit/${e.id}`)})(e)},{default:y(()=>[...a[38]||(a[38]=[b(" 编辑 ",-1)])]),_:1},8,["onClick"])):N("",!0)),ha(e.status,e.auditStatus,e.isAuditTransferred,e.operatorId)?(p(),h(l,{key:1,type:"text",size:"small",onClick:a=>(async e=>{try{await B.confirm(`确定要提审订单 ${e.orderNumber} 吗？${"normal"===e.markType?"正常发货单将直接流转到审核环节。":""}`,"提审确认",{confirmButtonText:"确定提审",cancelButtonText:"取消",type:"warning"}),Ie.value[e.id]=!0,await G.submitAudit(e.id,{operatorId:xe.user.id,markType:e.markType});const a=ea.value.find(a=>a.id===e.id),t=Re.getOrderById(e.id);a&&t&&(a.auditStatus="pending",t.auditStatus="pending",t.status="pending_audit","reserved"===a.markType&&(a.markType="normal",t.markType="normal"),a.isAuditTransferred=!0,a.auditTransferTime=(new Date).toLocaleString("zh-CN"),t.isAuditTransferred=!0,t.auditTransferTime=(new Date).toLocaleString("zh-CN"),t.statusHistory||(t.statusHistory=[]),t.statusHistory.push({status:"pending_audit",time:(new Date).toLocaleString("zh-CN"),operator:xe.user?.name||"系统",description:"订单已提交审核",remark:"手动提审"}),Le.sendMessage(Le.MessageType.AUDIT_PENDING,`订单 ${a.orderNumber} (客户: ${a.customerName}, 金额: ¥${a.totalAmount?.toLocaleString()}) 已提交审核`,{relatedId:a.id,relatedType:"order",actionUrl:`/order/detail/${a.id}`})),F.success("订单已提审"),Ra()}catch(a){"cancel"!==a&&F.error("提审失败，请重试")}finally{Ie.value[e.id]=!1}})(e),loading:Ie.value[e.id]},{default:y(()=>[...a[39]||(a[39]=[b(" 提审 ",-1)])]),_:1},8,["onClick","loading"])):N("",!0),fa(e.status,e.operatorId)?(p(),h(l,{key:2,type:"text",size:"small",onClick:a=>(e=>{Oe.value={id:e.id,orderNumber:e.orderNumber,customerName:e.customerName,totalAmount:e.totalAmount},He.reason="",He.description="",Me.value=!0})(e)},{default:y(()=>[...a[40]||(a[40]=[b(" 取消 ",-1)])]),_:1},8,["onClick"])):N("",!0),ga(e.status)?(p(),h(l,{key:3,type:"text",size:"small",onClick:a=>(e=>{Ve.push({path:"/service/add",query:{orderNumber:e.orderNumber,customerId:e.customerId,customerName:e.customerName,customerPhone:e.customerPhone,products:JSON.stringify(e.products)}})})(e)},{default:y(()=>[...a[41]||(a[41]=[b(" 售后 ",-1)])]),_:1},8,["onClick"])):N("",!0)],64)):N("",!0)])];var t,r}),_:1})]),_:1},8,["data","height"])),[[Ba,Pe.value]]),m("div",be,[m("div",_e,[m("span",null,"共 "+_(Je.total)+" 条记录",1)]),m("div",we,[v(ze,{"current-page":Je.page,"onUpdate:currentPage":a[14]||(a[14]=e=>Je.page=e),"page-size":Je.size,"onUpdate:pageSize":a[15]||(a[15]=e=>Je.size=e),"page-sizes":[10,20,50,100],total:Je.total,layout:"sizes, prev, pager, next, jumper",onSizeChange:Ha,onCurrentChange:qa},null,8,["current-page","page-size","total"])])])]),v(Xe,{modelValue:Me.value,"onUpdate:modelValue":a[18]||(a[18]=e=>Me.value=e),title:"申请取消订单",width:"500px","before-close":Pa},{footer:y(()=>[m("div",Ne,[v(l,{onClick:Pa},{default:y(()=>[...a[46]||(a[46]=[b("取消",-1)])]),_:1}),v(l,{type:"primary",onClick:Ea,loading:je.value},{default:y(()=>[...a[47]||(a[47]=[b(" 提交审核 ",-1)])]),_:1},8,["loading"])])]),default:y(()=>[m("div",ke,[m("div",Ae,[a[45]||(a[45]=m("h4",null,"订单信息",-1)),m("p",null,[a[42]||(a[42]=m("strong",null,"订单号：",-1)),b(_(Oe.value.orderNumber),1)]),m("p",null,[a[43]||(a[43]=m("strong",null,"客户：",-1)),b(_(Oe.value.customerName),1)]),m("p",null,[a[44]||(a[44]=m("strong",null,"金额：",-1)),b("¥"+_(Oe.value.totalAmount?.toLocaleString()),1)])]),v(C,{model:He,rules:qe,ref_key:"cancelFormRef",ref:$e,"label-width":"100px"},{default:y(()=>[v(o,{label:"取消原因",prop:"reason"},{default:y(()=>[v(s,{modelValue:He.reason,"onUpdate:modelValue":a[16]||(a[16]=e=>He.reason=e),placeholder:"请选择取消原因",style:{width:"100%"}},{default:y(()=>[v(n,{label:"客户主动取消",value:"customer_cancel"}),v(n,{label:"商品缺货",value:"out_of_stock"}),v(n,{label:"价格调整",value:"price_change"}),v(n,{label:"订单信息错误",value:"order_error"}),v(n,{label:"其他原因",value:"other"})]),_:1},8,["modelValue"])]),_:1}),v(o,{label:"详细说明"},{default:y(()=>[v(r,{modelValue:He.description,"onUpdate:modelValue":a[17]||(a[17]=e=>He.description=e),type:"textarea",rows:4,placeholder:"请详细说明取消原因（选填）...",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"]),v(Xe,{modelValue:We.value,"onUpdate:modelValue":a[20]||(a[20]=e=>We.value=e),title:"取消订单审核",width:"1200px","close-on-click-modal":!1},{default:y(()=>[v(Wa,{modelValue:Be.value,"onUpdate:modelValue":a[19]||(a[19]=e=>Be.value=e),onTabChange:za},{default:y(()=>[v(ra,{label:"待审核",name:"pending"},{default:y(()=>[v(Ce,{data:sa.value,onSelectionChange:Ia,style:{width:"100%"},"max-height":"400"},{default:y(()=>[v(I,{type:"selection",width:"55"}),v(I,{prop:"orderNumber",label:"订单号",width:"180"}),v(I,{prop:"customerName",label:"客户姓名",width:"120"}),v(I,{label:"负责销售",width:"100"},{default:y(({row:e})=>[b(_(e.createdByName||e.createdBy||"系统用户"),1)]),_:1}),v(I,{prop:"totalAmount",label:"金额",width:"120"},{default:y(({row:e})=>[b(" ¥"+_(e.totalAmount?.toFixed(2)||"0.00"),1)]),_:1}),v(I,{prop:"cancelRequestTime",label:"申请时间",width:"180"}),v(I,{label:"取消原因","min-width":"150"},{default:y(({row:e})=>[b(_(da(e.cancelReason)),1)]),_:1})]),_:1},8,["data"]),m("div",Te,[v(l,{onClick:Da},{default:y(()=>[...a[48]||(a[48]=[b("关闭",-1)])]),_:1}),v(l,{type:"success",onClick:Ma,loading:Qe.value,disabled:0===Fe.value.length},{default:y(()=>[...a[49]||(a[49]=[b(" 审核取消通过 ",-1)])]),_:1},8,["loading","disabled"]),v(l,{type:"danger",onClick:ja,loading:Qe.value,disabled:0===Fe.value.length},{default:y(()=>[...a[50]||(a[50]=[b(" 审核取消拒绝 ",-1)])]),_:1},8,["loading","disabled"])])]),_:1}),v(ra,{label:"已审核",name:"audited"},{default:y(()=>[v(Ce,{data:ia.value,style:{width:"100%"},"max-height":"400"},{default:y(()=>[v(I,{prop:"orderNumber",label:"订单号",width:"180"}),v(I,{prop:"customerName",label:"客户姓名",width:"120"}),v(I,{label:"负责销售",width:"100"},{default:y(({row:e})=>[b(_(e.createdByName||e.createdBy||"系统用户"),1)]),_:1}),v(I,{prop:"totalAmount",label:"金额",width:"120"},{default:y(({row:e})=>[b(" ¥"+_(e.totalAmount?.toFixed(2)||"0.00"),1)]),_:1}),v(I,{prop:"cancelRequestTime",label:"申请时间",width:"180"}),v(I,{label:"取消原因",width:"150"},{default:y(({row:e})=>[b(_(da(e.cancelReason)),1)]),_:1}),v(I,{prop:"status",label:"审核结果",width:"100"},{default:y(({row:e})=>["cancelled"===e.status?(p(),h(t,{key:0,type:"success"},{default:y(()=>[...a[51]||(a[51]=[b("已取消",-1)])]),_:1})):"cancel_failed"===e.status?(p(),h(t,{key:1,type:"danger"},{default:y(()=>[...a[52]||(a[52]=[b("取消失败",-1)])]),_:1})):N("",!0)]),_:1})]),_:1},8,["data"]),m("div",Se,[v(l,{onClick:Da},{default:y(()=>[...a[53]||(a[53]=[b("关闭",-1)])]),_:1})])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-2edf4ba1"]]);export{Ce as default};
