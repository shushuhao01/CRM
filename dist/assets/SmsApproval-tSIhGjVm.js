var M=(P,h,C)=>new Promise((S,_)=>{var b=o=>{try{p(C.next(o))}catch(r){_(r)}},g=o=>{try{p(C.throw(o))}catch(r){_(r)}},p=o=>o.done?S(o.value):Promise.resolve(o.value).then(b,g);p((C=C.apply(P,h)).next())});import{g as ve,S as fe,$ as Q,_ as _e}from"./settings-CuxbDWOu.js";import{useDepartmentStore as ge}from"./department-CTOju6hT.js";import{a as ye}from"./sensitiveInfo-BWt1a88R.js";import{E as U}from"./elementPlus-Bmwh7Rh8.js";import{l as be,r as D,Z as j,e as ke,c as Ce,ag as d,aq as Se,m as V,p as v,U as t,O as a,q as k,P as Ve,F as Z,a9 as G,u as E,M as T,S as s,T as u,Q as I}from"./vendor-D8Vxqhr-.js";import"./utils-ywHRn0uI.js";const we={class:"sms-approval-container"},De={class:"card-header"},Te={class:"header-actions"},he={class:"search-section"},Re={class:"pagination-container"},ze={key:0,class:"detail-content"},Ne={class:"content-preview"},xe={class:"recipients-list"},Ie={key:0,class:"approval-info"},Me={key:0,class:"dialog-footer"},Ue={key:1,class:"dialog-footer"},je=be({__name:"SmsApproval",setup(P){const h=ve(),C=ge(),S=D(!1),_=D([]),b=D(!1),g=D(!1),p=D(null),o=j({applicant:"",department:"",status:"",dateRange:[]}),r=j({action:"approve",remark:"",recordIds:[]}),f=j({currentPage:1,pageSize:20,total:0}),$=[{id:1,applicant:"张三",department:"销售部",templateName:"客户回访模板",recipientCount:50,content:"尊敬的客户，感谢您对我们产品的支持，我们将为您提供更好的服务。",reason:"月度客户回访活动",status:"pending",applyTime:"2024-01-15 10:30:00",recipients:["13800138001","13800138002","13800138003"]},{id:2,applicant:"李四",department:"市场部",templateName:"促销活动模板",recipientCount:200,content:"新年大促销！全场商品8折起，活动时间：1月20日-1月31日，详情咨询客服。",reason:"新年促销活动推广",status:"approved",applyTime:"2024-01-14 14:20:00",approveTime:"2024-01-14 16:45:00",approver:"王经理",approveRemark:"活动内容合规，批准发送",recipients:["13800138004","13800138005"]},{id:3,applicant:"王五",department:"客服部",templateName:"服务通知模板",recipientCount:30,content:"您的订单已发货，快递单号：SF123456789，预计3-5个工作日送达。",status:"rejected",applyTime:"2024-01-13 09:15:00",approveTime:"2024-01-13 11:30:00",approver:"张主管",approveRemark:"快递单号格式不正确，请修改后重新申请",recipients:["13800138006"]}],Y=D([]),K=ke(()=>{let l=[...$];if(o.applicant&&(l=l.filter(e=>e.applicant.includes(o.applicant))),o.department&&(l=l.filter(e=>e.department===o.department)),o.status&&(l=l.filter(e=>e.status===o.status)),o.dateRange&&o.dateRange.length===2){const[e,i]=o.dateRange;l=l.filter(R=>{const y=R.applyTime.split(" ")[0];return y>=e&&y<=i})}return l}),A=l=>({pending:"warning",approved:"success",rejected:"danger"})[l]||"info",F=l=>({pending:"待审核",approved:"已通过",rejected:"已拒绝"})[l]||l,W=()=>{w()},X=()=>{o.applicant="",o.department="",o.status="",o.dateRange=[],w()},ee=l=>{_.value=l},B=l=>{r.action="approve",r.recordIds=[l.id],r.remark="",g.value=!0},q=l=>{r.action="reject",r.recordIds=[l.id],r.remark="",g.value=!0},te=()=>{_.value.length&&(r.action="approve",r.recordIds=_.value.map(l=>l.id),r.remark="",g.value=!0)},ae=()=>{_.value.length&&(r.action="reject",r.recordIds=_.value.map(l=>l.id),r.remark="",g.value=!0)},le=l=>{p.value=l,b.value=!0},ne=()=>{p.value&&(B(p.value),b.value=!1)},oe=()=>{p.value&&(q(p.value),b.value=!1)},re=()=>M(this,null,function*(){if(!r.remark.trim()){U.warning("请输入审核备注");return}try{S.value=!0,yield new Promise(l=>setTimeout(l,1e3)),r.recordIds.forEach(l=>{const e=$.find(i=>i.id===l);e&&(e.status=r.action==="approve"?"approved":"rejected",e.approveTime=new Date().toLocaleString(),e.approver="当前用户",e.approveRemark=r.remark,r.action==="approve"?h.sendMessage(Q.SMS_SEND_APPROVED,`您的短信发送申请"${e.templateName}"已审核通过，可以开始发送了。`,{relatedId:e.id,relatedType:"sms_send",actionUrl:"/system/sms-approval"}):h.sendMessage(Q.SMS_SEND_REJECTED,`您的短信发送申请"${e.templateName}"审核未通过。拒绝原因：${r.remark}`,{relatedId:e.id,relatedType:"sms_send",actionUrl:"/system/sms-approval"}))}),U.success(`${r.action==="approve"?"通过":"拒绝"}审核成功`),g.value=!1,w()}catch(l){U.error("操作失败，请重试")}finally{S.value=!1}}),se=l=>{f.pageSize=l,w()},pe=l=>{f.currentPage=l,w()},w=()=>{S.value=!0,setTimeout(()=>{const l=K.value;f.total=l.length;const e=(f.currentPage-1)*f.pageSize,i=e+f.pageSize;Y.value=l.slice(e,i),S.value=!1},500)};return Ce(()=>M(this,null,function*(){try{yield C.initData(),w()}catch(l){console.error("初始化部门数据失败:",l)}})),(l,e)=>{const i=d("el-button"),R=d("el-input"),y=d("el-form-item"),z=d("el-option"),L=d("el-select"),ie=d("el-date-picker"),O=d("el-form"),c=d("el-table-column"),N=d("el-tag"),de=d("el-table"),ue=d("el-pagination"),me=d("el-card"),m=d("el-descriptions-item"),H=d("el-descriptions"),J=d("el-dialog"),ce=Se("loading");return v(),V("div",we,[t(me,null,{header:a(()=>[k("div",De,[e[14]||(e[14]=k("span",null,"短信审核管理",-1)),k("div",Te,[t(i,{type:"primary",onClick:te,disabled:!_.value.length},{default:a(()=>[...e[12]||(e[12]=[s(" 批量通过 ",-1)])]),_:1},8,["disabled"]),t(i,{type:"danger",onClick:ae,disabled:!_.value.length},{default:a(()=>[...e[13]||(e[13]=[s(" 批量拒绝 ",-1)])]),_:1},8,["disabled"])])])]),default:a(()=>[k("div",he,[t(O,{model:o,inline:""},{default:a(()=>[t(y,{label:"申请人"},{default:a(()=>[t(R,{modelValue:o.applicant,"onUpdate:modelValue":e[0]||(e[0]=n=>o.applicant=n),placeholder:"请输入申请人姓名",clearable:""},null,8,["modelValue"])]),_:1}),t(y,{label:"部门"},{default:a(()=>[t(L,{modelValue:o.department,"onUpdate:modelValue":e[1]||(e[1]=n=>o.department=n),placeholder:"请选择部门",clearable:""},{default:a(()=>[(v(!0),V(Z,null,G(E(C).departmentList,n=>(v(),T(z,{key:n.id,label:n.name,value:n.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"审核状态"},{default:a(()=>[t(L,{modelValue:o.status,"onUpdate:modelValue":e[2]||(e[2]=n=>o.status=n),placeholder:"请选择状态",clearable:""},{default:a(()=>[t(z,{label:"待审核",value:"pending"}),t(z,{label:"已通过",value:"approved"}),t(z,{label:"已拒绝",value:"rejected"})]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"申请时间"},{default:a(()=>[t(ie,{modelValue:o.dateRange,"onUpdate:modelValue":e[3]||(e[3]=n=>o.dateRange=n),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(y,null,{default:a(()=>[t(i,{type:"primary",onClick:W},{default:a(()=>[...e[15]||(e[15]=[s("搜索",-1)])]),_:1}),t(i,{onClick:X},{default:a(()=>[...e[16]||(e[16]=[s("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),Ve((v(),T(de,{data:Y.value,onSelectionChange:ee,style:{width:"100%"}},{default:a(()=>[t(c,{type:"selection",width:"55"}),t(c,{prop:"id",label:"申请ID",width:"80"}),t(c,{prop:"applicant",label:"申请人",width:"100"}),t(c,{prop:"department",label:"部门",width:"120"}),t(c,{prop:"templateName",label:"短信模板",width:"150"}),t(c,{prop:"recipientCount",label:"接收人数",width:"100"}),t(c,{prop:"content",label:"短信内容","min-width":"200","show-overflow-tooltip":""}),t(c,{prop:"reason",label:"申请原因",width:"150","show-overflow-tooltip":""}),t(c,{prop:"status",label:"状态",width:"100"},{default:a(({row:n})=>[t(N,{type:A(n.status)},{default:a(()=>[s(u(F(n.status)),1)]),_:2},1032,["type"])]),_:1}),t(c,{prop:"applyTime",label:"申请时间",width:"160"}),t(c,{prop:"approveTime",label:"审核时间",width:"160"}),t(c,{label:"操作",width:"200",fixed:"right"},{default:a(({row:n})=>[n.status==="pending"?(v(),T(i,{key:0,type:"primary",size:"small",onClick:x=>B(n)},{default:a(()=>[...e[17]||(e[17]=[s(" 通过 ",-1)])]),_:1},8,["onClick"])):I("",!0),n.status==="pending"?(v(),T(i,{key:1,type:"danger",size:"small",onClick:x=>q(n)},{default:a(()=>[...e[18]||(e[18]=[s(" 拒绝 ",-1)])]),_:1},8,["onClick"])):I("",!0),t(i,{type:"info",size:"small",onClick:x=>le(n)},{default:a(()=>[...e[19]||(e[19]=[s(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ce,S.value]]),k("div",Re,[t(ue,{"current-page":f.currentPage,"onUpdate:currentPage":e[4]||(e[4]=n=>f.currentPage=n),"page-size":f.pageSize,"onUpdate:pageSize":e[5]||(e[5]=n=>f.pageSize=n),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:pe},null,8,["current-page","page-size","total"])])]),_:1}),t(J,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=n=>b.value=n),title:"审核详情",width:"800px"},{footer:a(()=>{var n;return[((n=p.value)==null?void 0:n.status)==="pending"?(v(),V("div",Me,[t(i,{onClick:e[6]||(e[6]=x=>b.value=!1)},{default:a(()=>[...e[21]||(e[21]=[s("取消",-1)])]),_:1}),t(i,{type:"danger",onClick:oe},{default:a(()=>[...e[22]||(e[22]=[s("拒绝",-1)])]),_:1}),t(i,{type:"primary",onClick:ne},{default:a(()=>[...e[23]||(e[23]=[s("通过",-1)])]),_:1})])):(v(),V("div",Ue,[t(i,{onClick:e[7]||(e[7]=x=>b.value=!1)},{default:a(()=>[...e[24]||(e[24]=[s("关闭",-1)])]),_:1})]))]}),default:a(()=>[p.value?(v(),V("div",ze,[t(H,{column:2,border:""},{default:a(()=>[t(m,{label:"申请ID"},{default:a(()=>[s(u(p.value.id),1)]),_:1}),t(m,{label:"申请人"},{default:a(()=>[s(u(p.value.applicant),1)]),_:1}),t(m,{label:"部门"},{default:a(()=>[s(u(p.value.department),1)]),_:1}),t(m,{label:"短信模板"},{default:a(()=>[s(u(p.value.templateName),1)]),_:1}),t(m,{label:"接收人数"},{default:a(()=>[s(u(p.value.recipientCount),1)]),_:1}),t(m,{label:"申请时间"},{default:a(()=>[s(u(p.value.applyTime),1)]),_:1}),t(m,{label:"申请原因",span:2},{default:a(()=>[s(u(p.value.reason),1)]),_:1}),t(m,{label:"短信内容",span:2},{default:a(()=>[k("div",Ne,u(p.value.content),1)]),_:1}),t(m,{label:"接收人列表",span:2},{default:a(()=>[k("div",xe,[(v(!0),V(Z,null,G(p.value.recipients,n=>(v(),T(N,{key:n,style:{margin:"2px"}},{default:a(()=>[s(u(E(ye)(n,E(fe).PHONE)),1)]),_:2},1024))),128))])]),_:1})]),_:1}),p.value.status!=="pending"?(v(),V("div",Ie,[e[20]||(e[20]=k("h4",null,"审核信息",-1)),t(H,{column:2,border:""},{default:a(()=>[t(m,{label:"审核状态"},{default:a(()=>[t(N,{type:A(p.value.status)},{default:a(()=>[s(u(F(p.value.status)),1)]),_:1},8,["type"])]),_:1}),t(m,{label:"审核时间"},{default:a(()=>[s(u(p.value.approveTime),1)]),_:1}),t(m,{label:"审核人"},{default:a(()=>[s(u(p.value.approver),1)]),_:1}),t(m,{label:"审核备注",span:2},{default:a(()=>[s(u(p.value.approveRemark||"无"),1)]),_:1})]),_:1})])):I("",!0)])):I("",!0)]),_:1},8,["modelValue"]),t(J,{modelValue:g.value,"onUpdate:modelValue":e[11]||(e[11]=n=>g.value=n),title:"审核备注",width:"500px"},{footer:a(()=>[t(i,{onClick:e[10]||(e[10]=n=>g.value=!1)},{default:a(()=>[...e[25]||(e[25]=[s("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:re},{default:a(()=>[...e[26]||(e[26]=[s("确认",-1)])]),_:1})]),default:a(()=>[t(O,{model:r,"label-width":"80px"},{default:a(()=>[t(y,{label:"审核结果"},{default:a(()=>[t(N,{type:r.action==="approve"?"success":"danger"},{default:a(()=>[s(u(r.action==="approve"?"通过":"拒绝"),1)]),_:1},8,["type"])]),_:1}),t(y,{label:"备注",required:""},{default:a(()=>[t(R,{modelValue:r.remark,"onUpdate:modelValue":e[9]||(e[9]=n=>r.remark=n),type:"textarea",rows:4,placeholder:"请输入审核备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),qe=_e(je,[["__scopeId","data-v-54f9a5f3"]]);export{qe as default};
