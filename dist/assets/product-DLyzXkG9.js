var J=Object.defineProperty,Q=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var M=(e,o,a)=>o in e?J(e,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[o]=a,w=(e,o)=>{for(var a in o||(o={}))X.call(o,a)&&M(e,a,o[a]);if(L)for(var a of L(o))Y.call(o,a)&&M(e,a,o[a]);return e},k=(e,o)=>Q(e,V(o));var i=(e,o,a)=>new Promise((d,c)=>{var f=g=>{try{n(a.next(g))}catch(p){c(p)}},l=g=>{try{n(a.throw(g))}catch(p){c(p)}},n=g=>g.done?d(g.value):Promise.resolve(g.value).then(f,l);n((a=a.apply(e,o)).next())});import{f as h,K as Z}from"./settings-CuxbDWOu.js";import{r as C,e as I}from"./vendor-D8Vxqhr-.js";const m={getList(){return i(this,arguments,function*(e={}){try{return(yield h.get("/api/v1/products",{params:e})).data}catch(o){return console.error("获取产品列表失败:",o),this.getMockProductList(e)}})},getActiveList(){return i(this,arguments,function*(e={}){return this.getList(k(w({},e),{status:"active"}))})},getDetail(e){return i(this,null,function*(){try{return(yield h.get(`/api/v1/products/${e}`)).data}catch(o){throw console.error("获取产品详情失败:",o),o}})},create(e){return i(this,null,function*(){try{return(yield h.post("/api/v1/products",e)).data}catch(o){throw console.error("创建产品失败:",o),o}})},update(e,o){return i(this,null,function*(){try{return(yield h.put(`/api/v1/products/${e}`,o)).data}catch(a){throw console.error("更新产品失败:",a),a}})},delete(e){return i(this,null,function*(){try{yield h.delete(`/api/v1/products/${e}`)}catch(o){throw console.error("删除产品失败:",o),o}})},getStockStatistics(){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/stock/statistics")).data}catch(e){throw console.error("获取库存统计失败:",e),e}})},adjustStock(e){return i(this,null,function*(){try{return(yield h.post("/api/v1/products/stock/adjust",e)).data}catch(o){throw console.error("库存调整失败:",o),o}})},getStockAdjustments(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/stock/adjustments",{params:e})).data}catch(o){throw console.error("获取库存调整记录失败:",o),o}})},batchImport(e){return i(this,null,function*(){try{return(yield h.post("/api/v1/products/batch-import",e)).data}catch(o){throw console.error("批量导入产品失败:",o),o}})},exportProducts(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/export",{params:e})).data}catch(o){throw console.error("导出产品数据失败:",o),o}})},getCategoryList(){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/categories")).data}catch(e){throw console.error("获取产品分类列表失败:",e),e}})},getCategoryTree(){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/categories/tree")).data}catch(e){throw console.error("获取产品分类树形结构失败:",e),e}})},createCategory(e){return i(this,null,function*(){try{return(yield h.post("/api/v1/products/categories",e)).data}catch(o){throw console.error("创建产品分类失败:",o),o}})},updateCategory(e,o){return i(this,null,function*(){try{return(yield h.put(`/api/v1/products/categories/${e}`,o)).data}catch(a){throw console.error("更新产品分类失败:",a),a}})},deleteCategory(e){return i(this,null,function*(){try{yield h.delete(`/api/v1/products/categories/${e}`)}catch(o){throw console.error("删除产品分类失败:",o),o}})},getCategoryDetail(e){return i(this,null,function*(){try{return(yield h.get(`/api/v1/products/categories/${e}`)).data}catch(o){throw console.error("获取产品分类详情失败:",o),o}})},getSalesStatistics(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/sales/statistics",{params:e})).data}catch(o){console.error("获取销售统计失败:",o);const d=this.getMockProductList(),c=d.reduce((g,p)=>g+p.salesCount*p.price,0),f=d.reduce((g,p)=>g+p.salesCount,0),l=d.length,n=d.filter(g=>g.stock<=g.minStock&&g.stock>0).length;return{totalRevenue:c,totalSales:f,totalProducts:l,lowStockWarning:n,revenueChange:"+12.5%",salesChange:"+8.3%",productsChange:"+2.1%",warningChange:"-5.2%"}}})},getSalesTrend(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/sales/trend",{params:e})).data}catch(o){console.error("获取销售趋势失败:",o);const{period:a}=e;let d=[],c=[],f=[];if(a==="7days")for(let l=6;l>=0;l--){const n=new Date;n.setDate(n.getDate()-l),d.push(`${n.getMonth()+1}/${n.getDate()}`),c.push(Math.floor(Math.random()*100)+50),f.push(Math.floor(Math.random()*5e4)+2e4)}else if(a==="30days")for(let l=3;l>=0;l--)d.push(`第${4-l}周`),c.push(Math.floor(Math.random()*500)+200),f.push(Math.floor(Math.random()*2e5)+1e5);else if(a==="90days")for(let l=2;l>=0;l--){const n=new Date;n.setMonth(n.getMonth()-l),d.push(`${n.getMonth()+1}月`),c.push(Math.floor(Math.random()*2e3)+1e3),f.push(Math.floor(Math.random()*8e5)+4e5)}return{timeLabels:d,salesData:c,revenueData:f}}})},getCategorySales(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/sales/category",{params:e})).data}catch(o){console.error("获取分类销售占比失败:",o);const d=this.getMockProductList(),c=new Map;d.forEach(l=>{const n=l.categoryName,g=l.salesCount*l.price;c.has(n)?c.set(n,c.get(n)+g):c.set(n,g)});const f=Array.from(c.values()).reduce((l,n)=>l+n,0);return Array.from(c.entries()).map(([l,n])=>({name:l,value:Math.round(n),percentage:Math.round(n/f*100)})).sort((l,n)=>n.value-l.value)}})},getTopProducts(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/sales/top",{params:e})).data}catch(o){console.error("获取热销商品排行失败:",o);const d=this.getMockProductList(),c=e.limit||5;return d.map(f=>({id:f.id,name:f.name,sales:f.salesCount,revenue:f.salesCount*f.price,image:f.image,categoryName:f.categoryName})).sort((f,l)=>l.sales-f.sales).slice(0,c)}})},getInventoryWarning(e){return i(this,null,function*(){try{return(yield h.get("/api/v1/products/inventory/warning",{params:e})).data}catch(o){console.error("获取库存预警失败:",o);const d=this.getMockProductList(),c=d.filter(n=>n.stock<=n.minStock&&n.stock>0),f=d.filter(n=>n.stock===0),l=new Map;return d.forEach(n=>{const g=n.categoryName;l.has(g)||l.set(g,{name:g,lowStock:0,outOfStock:0,totalStock:0});const p=l.get(g);p.totalStock+=n.stock,n.stock===0?p.outOfStock++:n.stock<=n.minStock&&p.lowStock++}),{lowStockCount:c.length,outOfStockCount:f.length,totalWarning:c.length+f.length,categories:Array.from(l.values())}}})},getMockProductList(e){let a=[];if(e.status&&(a=a.filter(n=>n.status===e.status)),e.categoryId&&(a=a.filter(n=>n.categoryId===e.categoryId)),e.keyword){const n=e.keyword.toLowerCase();a=a.filter(g=>g.name.toLowerCase().includes(n)||g.code.toLowerCase().includes(n)||g.brand.toLowerCase().includes(n))}const d=e.page||1,c=e.pageSize||10,f=(d-1)*c,l=f+c;return{list:a.slice(f,l),total:a.length,page:d,pageSize:c}}},oe=Z("product",()=>{const e=C([]),o=C([]),a=C(!1),d=C({currentPage:1,pageSize:20,total:0}),c=C({name:"",code:"",categoryId:"",status:"",stockStatus:"",minPrice:null,maxPrice:null,showDeleted:!1,onlyDeleted:!1}),f=I(()=>{const r=e.value.length,t=e.value.filter(u=>u.stock<=u.minStock&&u.stock>0).length,s=e.value.filter(u=>u.stock===0).length;return{totalProducts:r,lowStockCount:t,outOfStockCount:s}}),l=()=>i(void 0,null,function*(){try{a.value=!0;const r=yield m.getCategoryTree();o.value=r}catch(r){console.error("加载分类失败:",r)}finally{a.value=!1}}),n=(...t)=>i(void 0,[...t],function*(r={}){try{a.value=!0;const s=yield m.getList(r);e.value=s.list,d.value.total=s.total,d.value.currentPage=s.page,d.value.pageSize=s.pageSize}catch(s){console.error("加载商品失败:",s)}finally{a.value=!1}}),g=(r=!1)=>i(void 0,null,function*(){(r||o.value.length===0)&&(yield l()),(r||e.value.length===0)&&(yield n())}),p=()=>{const r=Date.now(),t=Math.floor(Math.random()*1e3);let s=r+t;for(;e.value.some(u=>u.id===s);)s=Date.now()+Math.floor(Math.random()*1e3);return s},z=r=>i(void 0,null,function*(){const t=k(w({},r),{id:p(),createTime:new Date().toLocaleString("zh-CN")});return e.value.unshift(t),console.log("[ProductStore] 本地添加新商品:",t.name,"ID:",t.id),t}),b=(r,t)=>i(void 0,null,function*(){const s=e.value.findIndex(u=>u.id===r);if(s!==-1){const u=k(w(w({},e.value[s]),t),{updateTime:new Date().toLocaleString("zh-CN")});return e.value[s]=u,console.log("[ProductStore] 本地更新商品:",u.name,"ID:",r),u}return console.warn("[ProductStore] 未找到要更新的商品 ID:",r),null}),x=r=>i(void 0,null,function*(){const t=e.value.find(s=>s.id===r);return t?(t.deleted=!0,t.status="inactive",t.updateTime=new Date().toISOString(),console.log("[ProductStore] 本地软删除商品:",t.name,"ID:",r),!0):(console.warn("[ProductStore] 未找到要删除的商品 ID:",r),!1)}),N=r=>{const t=e.value.find(s=>s.id===r);return t&&t.deleted?(t.deleted=!1,t.status="active",t.updateTime=new Date().toISOString(),!0):!1},T=r=>{const t=e.value.findIndex(s=>s.id===r);return t!==-1?(e.value.splice(t,1),!0):!1},$=r=>e.value.find(t=>t.id==r||t.id===Number(r)||String(t.id)===String(r)),A=I(()=>{let r=[...e.value];if(c.value.onlyDeleted?r=r.filter(t=>t.deleted===!0):c.value.showDeleted||(r=r.filter(t=>!t.deleted)),c.value.name&&(r=r.filter(t=>t.name.toLowerCase().includes(c.value.name.toLowerCase()))),c.value.code&&(r=r.filter(t=>t.code.toLowerCase().includes(c.value.code.toLowerCase()))),c.value.categoryId&&(r=r.filter(t=>t.categoryId===c.value.categoryId)),c.value.status&&(c.value.status==="active"?r=r.filter(t=>t.status==="active"&&!t.deleted):r=r.filter(t=>t.status===c.value.status)),c.value.stockStatus)switch(c.value.stockStatus){case"normal":r=r.filter(t=>t.stock>t.minStock);break;case"warning":r=r.filter(t=>t.stock<=t.minStock&&t.stock>0);break;case"out_of_stock":r=r.filter(t=>t.stock===0);break}return c.value.minPrice!==null&&(r=r.filter(t=>t.price>=c.value.minPrice)),c.value.maxPrice!==null&&(r=r.filter(t=>t.price<=c.value.maxPrice)),r}),O=r=>{Object.assign(c.value,r)},j=()=>{c.value={name:"",code:"",categoryId:"",status:"",stockStatus:"",minPrice:null,maxPrice:null,showDeleted:!1,onlyDeleted:!1}},_=r=>{Object.assign(d.value,r)},F=(r,t)=>{const s=e.value.find(u=>u.id===r);if(s){const u=s.stock+t;s.stock=Math.max(0,u),s.updateTime=new Date().toLocaleString(),s.stock===0?s.status="out_of_stock":s.status==="out_of_stock"&&s.stock>0&&(s.status="active")}},W=(...t)=>i(void 0,[...t],function*(r={}){try{a.value=!0;const s=yield m.getActiveList(r);return e.value=s.list,d.value=k(w({},d.value),{total:s.total,current:s.page,pageSize:s.pageSize}),s}catch(s){throw console.error("获取产品列表失败:",s),s}finally{a.value=!1}}),B=()=>i(void 0,null,function*(){try{a.value=!0;const r={page:d.value.current,pageSize:d.value.pageSize,status:"active"};c.value.name&&(r.name=c.value.name),c.value.categoryId&&(r.categoryId=c.value.categoryId),c.value.stockStatus&&(r.stockStatus=c.value.stockStatus);const t=yield m.getActiveList(r);return e.value=t.list,d.value=k(w({},d.value),{total:t.total,current:t.page,pageSize:t.pageSize}),t}catch(r){throw console.error("刷新产品列表失败:",r),r}finally{a.value=!1}}),E=r=>{const t=s=>{for(const u of s){if(u.id===r)return u;if(u.children){const y=t(u.children);if(y)return y}}return null};return t(o.value)},R=r=>{const t=[],s=(u,y,P)=>{for(const v of u){const S=[...P,v];if(v.id===y)return t.push(...S),!0;if(v.children&&s(v.children,y,S))return!0}return!1};return s(o.value,r,[]),t},q=()=>{const r=[],t=s=>{for(const u of s)r.push(u),u.children&&t(u.children)};return t(o.value),r},K=r=>i(void 0,null,function*(){if(!r.trim())return[];const t=r.toLowerCase().trim(),s=e.value.filter(u=>u.deleted?!1:u.name.toLowerCase().includes(t)||u.code.toLowerCase().includes(t)||u.brand.toLowerCase().includes(t)||u.specification.toLowerCase().includes(t)||u.description.toLowerCase().includes(t));return s.sort((u,y)=>{const P=u.name.toLowerCase().includes(t),v=y.name.toLowerCase().includes(t),S=u.code.toLowerCase().includes(t),D=y.code.toLowerCase().includes(t);return P&&!v?-1:!P&&v?1:S&&!D?-1:!S&&D?1:0}),s.slice(0,50)}),U=r=>i(void 0,null,function*(){try{a.value=!0;const t=yield m.createCategory(r);return yield l(),t}catch(t){throw console.error("添加分类失败:",t),t}finally{a.value=!1}}),G=(r,t)=>i(void 0,null,function*(){try{a.value=!0;const s=yield m.updateCategory(r,t);return yield l(),s}catch(s){throw console.error("更新分类失败:",s),s}finally{a.value=!1}}),H=r=>i(void 0,null,function*(){try{a.value=!0,yield m.deleteCategory(r),yield l()}catch(t){throw console.error("删除分类失败:",t),t}finally{a.value=!1}});return setTimeout(()=>{g()},0),{products:e,categories:o,loading:a,pagination:d,searchForm:c,stats:f,getFilteredProducts:A,addProduct:z,updateProduct:b,deleteProduct:x,restoreProduct:N,permanentDeleteProduct:T,getProductById:$,setSearchForm:O,resetSearchForm:j,setPagination:_,updateProductStock:F,fetchProducts:W,refreshProducts:B,searchProducts:K,initData:g,loadCategories:l,loadProducts:n,addCategory:U,updateCategory:G,deleteCategory:H,findCategoryById:E,getCategoryPath:R,getFlatCategories:q}});export{m as p,oe as u};
