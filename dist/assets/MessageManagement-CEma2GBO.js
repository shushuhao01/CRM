import{N as e,_ as a,O as l,u as t}from"./index-C4IdUW1A.js";import{C as s,E as i,b as d,F as o,at as n,i as r,aH as u,aT as c,u as m,s as p,ai as f,Q as v,A as g,g as h,m as b}from"./elementPlus-DxaqjplL.js";import{l as y,r as _,Z as w,e as k,w as V,b as x,ag as M,aq as C,m as I,q as z,p as U,U as S,O as A,S as T,u as D,F,a9 as E,M as N,P,T as L,Q as q,s as H,z as B,n as j}from"./vendor-BtukhyiH.js";import{T as O,E as G}from"./style-BM3euvlk.js";import"./utils-DfI7e5Rl.js";const W={class:"message-subscription"},$={class:"page-header"},K={class:"header-right"},Y={class:"filter-section"},R={class:"table-section"},J={class:"message-types"},Q={class:"notification-methods"},Z={class:"pagination-section"},X={class:"message-type-selection"},ee={class:"type-categories-compact"},ae={class:"category-header-compact"},le={class:"category-name-compact"},te={class:"type-options-compact"},se={class:"notification-methods-selection"},ie={key:1,class:"methods-grid"},de={class:"method-content"},oe={class:"method-name"},ne={class:"method-meta"},re={key:0,class:"member-count"},ue={class:"time-settings"},ce={key:0,class:"time-range"},me={class:"dialog-footer"},pe={key:0,class:"subscription-detail"},fe={class:"notification-methods"},ve=a(y({__name:"MessageSubscription",setup(a){const l=[{name:"订单管理",types:[{value:"order_created",label:"新建订单通知",description:"有新订单创建时通知"},{value:"order_submitted",label:"订单提交成功",description:"订单提交成功时通知"},{value:"order_paid",label:"订单支付成功",description:"订单支付成功时通知"},{value:"order_shipped",label:"订单发货通知",description:"订单发货时通知"},{value:"order_delivered",label:"订单送达通知",description:"订单送达时通知"},{value:"order_signed",label:"订单签收通知",description:"订单签收时通知"},{value:"order_cancelled",label:"订单取消通知",description:"订单取消时通知"},{value:"order_cancel_request",label:"订单取消申请",description:"订单取消申请时通知"},{value:"order_cancel_approved",label:"订单取消通过",description:"订单取消申请通过时通知"},{value:"order_modify_approved",label:"订单修改申请通过",description:"订单修改申请通过时通知"},{value:"order_refunded",label:"订单退款通知",description:"订单退款时通知"},{value:"payment_reminder",label:"付款提醒",description:"订单待付款提醒"}]},{name:"售后服务",types:[{value:"after_sales_created",label:"新售后申请",description:"新售后申请时通知"},{value:"after_sales_processing",label:"售后处理中",description:"售后处理中时通知"},{value:"after_sales_urgent",label:"紧急售后",description:"紧急售后时通知"},{value:"after_sales_completed",label:"售后完成",description:"售后完成时通知"},{value:"return_notification",label:"退货通知",description:"退货申请时通知"}]},{name:"客户管理",types:[{value:"customer_created",label:"新建客户通知",description:"新客户注册时通知"},{value:"customer_updated",label:"客户信息更新",description:"客户信息更新时通知"},{value:"customer_call",label:"客户来电",description:"客户来电时通知"},{value:"customer_complaint",label:"客户投诉",description:"客户投诉时通知"},{value:"customer_rejected",label:"客户拒收",description:"客户拒收时通知"},{value:"customer_sharing",label:"客户分享通知",description:"客户分享时通知"},{value:"customer_feedback",label:"客户反馈",description:"收到客户反馈时通知"}]},{name:"商品管理",types:[{value:"product_created",label:"商品添加成功",description:"商品添加成功时通知"},{value:"product_updated",label:"商品信息更新",description:"商品信息更新时通知"},{value:"product_out_of_stock",label:"商品缺货",description:"商品缺货时通知"},{value:"product_price_changed",label:"商品价格变更",description:"商品价格变更时通知"}]},{name:"物流管理",types:[{value:"shipping_notification",label:"发货通知",description:"商品发货时通知"},{value:"delivery_confirmation",label:"签收通知",description:"商品签收时通知"},{value:"logistics_pickup",label:"物流揽件",description:"物流揽件时通知"},{value:"logistics_in_transit",label:"物流运输中",description:"物流运输中时通知"},{value:"logistics_delivered",label:"物流已送达",description:"物流已送达时通知"},{value:"package_anomaly",label:"包裹异常",description:"包裹异常时通知"}]},{name:"财务管理",types:[{value:"payment_notification",label:"付款通知",description:"付款时通知"},{value:"payment_received",label:"收款确认",description:"收款确认时通知"},{value:"invoice_generated",label:"发票生成",description:"发票生成时通知"},{value:"refund_processed",label:"退款处理",description:"退款处理时通知"}]},{name:"审批流程",types:[{value:"audit_notification",label:"审核通知",description:"需要审核时通知"},{value:"audit_pending",label:"待审核",description:"待审核时通知"},{value:"audit_approved",label:"审核通过",description:"审核通过时通知"},{value:"audit_rejected",label:"审核拒绝",description:"审核拒绝时通知"}]},{name:"业绩分享",types:[{value:"performance_share_created",label:"业绩分享创建",description:"业绩分享创建时通知"},{value:"performance_share_received",label:"收到业绩分享",description:"收到业绩分享时通知"},{value:"performance_share_confirmed",label:"业绩分享确认",description:"业绩分享确认时通知"},{value:"performance_share_rejected",label:"业绩分享拒绝",description:"业绩分享拒绝时通知"},{value:"performance_share_cancelled",label:"业绩分享取消",description:"业绩分享取消时通知"}]},{name:"服务管理",types:[{value:"call_incoming",label:"来电提醒",description:"有新的来电时通知"},{value:"call_missed",label:"未接来电",description:"有未接来电时通知"},{value:"call_record_created",label:"通话记录创建",description:"新增通话记录时通知"},{value:"call_followup_due",label:"跟进提醒",description:"客户跟进到期时通知"},{value:"sms_sent",label:"短信发送",description:"短信发送成功时通知"},{value:"sms_failed",label:"短信失败",description:"短信发送失败时通知"},{value:"sms_quota_low",label:"短信余额不足",description:"短信余额不足时通知"}]},{name:"资料管理",types:[{value:"customer_data_created",label:"客户资料创建",description:"新增客户资料时通知"},{value:"customer_data_updated",label:"客户资料更新",description:"客户资料更新时通知"},{value:"customer_data_imported",label:"客户资料导入",description:"批量导入客户资料时通知"},{value:"customer_query_executed",label:"客户查询执行",description:"执行客户查询时通知"},{value:"customer_data_exported",label:"客户资料导出",description:"导出客户资料时通知"},{value:"data_deleted",label:"资料删除",description:"资料被删除移入回收站时通知"},{value:"data_recovered",label:"资料恢复",description:"资料从回收站恢复时通知"},{value:"data_permanently_deleted",label:"资料永久删除",description:"资料从回收站永久删除时通知"},{value:"recycle_bin_cleanup",label:"回收站清理",description:"回收站定期清理时通知"}]},{name:"短信管理",types:[{value:"sms_template_applied",label:"短信模板申请",description:"短信模板申请时通知"},{value:"sms_template_approved",label:"短信模板审核通过",description:"短信模板审核通过时通知"},{value:"sms_template_rejected",label:"短信模板审核拒绝",description:"短信模板审核拒绝时通知"},{value:"sms_send_applied",label:"短信发送申请",description:"短信发送申请时通知"},{value:"sms_send_approved",label:"短信发送审核通过",description:"短信发送审核通过时通知"},{value:"sms_send_rejected",label:"短信发送审核拒绝",description:"短信发送审核拒绝时通知"},{value:"sms_send_success",label:"短信发送成功",description:"短信发送成功时通知"},{value:"sms_send_failed",label:"短信发送失败",description:"短信发送失败时通知"}]},{name:"系统管理",types:[{value:"system_maintenance",label:"系统维护通知",description:"系统维护时通知"},{value:"system_update",label:"系统更新",description:"系统更新时通知"},{value:"user_login",label:"用户登录",description:"用户登录时通知"},{value:"user_created",label:"系统用户添加成功",description:"系统用户添加成功时通知"},{value:"permission_configured",label:"权限配置成功",description:"权限配置成功时通知"},{value:"data_export_success",label:"导出成功",description:"数据导出成功时通知"},{value:"data_import_completed",label:"导入完成",description:"数据导入完成时通知"},{value:"system_alert",label:"系统告警",description:"系统异常时通知"}]}],t=l.flatMap(e=>e.types),o=[{value:"dingtalk",label:"钉钉"},{value:"wechat_work",label:"企业微信"},{value:"email",label:"邮件"},{value:"sms",label:"短信"},{value:"system_message",label:"系统消息"}],n=_([{id:"1",name:"销售部"},{id:"2",name:"客服部"},{id:"3",name:"技术部"},{id:"4",name:"财务部"},{id:"5",name:"人事部"}]),r=w({departmentId:"",messageType:"",status:""}),u=_([]),c=_(!1),m=_([]),p=_(!1),f=w({page:1,size:20,total:0}),v=_(!1),g=_(!1),h=_(!1),b=_(!1),y=_(null),H=_(),B=w({id:"",departmentId:"",messageTypes:[],notificationMethods:[],priority:"normal",scheduleEnabled:!1,scheduleStart:"",scheduleEnd:"",excludeWeekends:!1,remark:""}),j={departmentId:[{required:!0,message:"请选择订阅部门",trigger:"change"}],messageTypes:[{required:!0,message:"请选择至少一种消息类型",trigger:"change"}],notificationMethods:[{required:!0,message:"请选择至少一种通知方式",trigger:"change"}]},O=k(()=>h.value?"编辑订阅规则":"新建订阅规则"),G=k(()=>{if(!B.departmentId||0===m.value.length)return o;const e=[];return m.value.forEach(a=>{if(a.enabled&&a.supportedDepartments.includes(B.departmentId)){const l=o.find(e=>e.value===a.method);l&&e.push({...l,memberCount:a.members.length,configStatus:a.enabled?"已配置":"未配置"})}}),e.length>0?e:o}),ve=async()=>{c.value=!0;try{const a=await e.get("/message/subscription-rules",{params:{page:f.page,pageSize:f.size,departmentId:r.departmentId,messageType:r.messageType,status:r.status}});if(a.success&&a.data){const e=a.data.map(e=>({...e,statusLoading:!1,messageTypeNames:e.messageTypes?e.messageTypes.map(e=>_e(e)).join(", "):_e(e.messageType)}));u.value=e,f.total=a.total||e.length}else u.value=[],f.total=0}catch(a){console.error("加载订阅规则失败:",a),i.error("加载订阅规则失败"),u.value=[],f.total=0}finally{c.value=!1}},ge=()=>{r.departmentId="",r.messageType="",r.status="",ve()},he=()=>{h.value=!1,be(),v.value=!0},be=()=>{B.id="",B.departmentId="",B.messageTypes=[],B.notificationMethods=[],B.priority="normal",B.scheduleEnabled=!1,B.scheduleStart="",B.scheduleEnd="",B.excludeWeekends=!1,B.remark=""},ye=async()=>{if(H.value)try{await H.value.validate(),b.value=!0;const a={departmentId:B.departmentId,messageTypes:B.messageTypes,notificationMethods:B.notificationMethods,priority:B.priority,scheduleEnabled:B.scheduleEnabled,scheduleStart:B.scheduleStart,scheduleEnd:B.scheduleEnd,excludeWeekends:B.excludeWeekends,remark:B.remark};h.value?await e.put(`/message/subscription-rules/${B.id}`,a):await e.post("/message/subscription-rules",a),i.success(h.value?"订阅规则更新成功":"订阅规则创建成功"),v.value=!1,ve()}catch(a){console.error("保存失败:",a),i.error("保存失败，请重试")}finally{b.value=!1}},_e=e=>{const a=t.find(a=>a.value===e);return a?a.label:e},we=e=>({audit_notification:"warning",approval_result:"warning",shipping_notification:"success",delivery_confirmation:"success",return_notification:"danger",customer_created:"primary",customer_share:"info",customer_feedback:"info",order_created:"success",order_updated:"primary",payment_reminder:"warning",system_maintenance:"danger",system_alert:"danger"}[e]||"info"),ke=e=>({dingtalk:"primary",wechat_work:"success",email:"warning",sms:"danger",system_message:"info"}[e]||"info"),Ve=e=>({dingtalk:"钉钉",wechat_work:"企业微信",email:"邮件",sms:"短信",system_message:"系统消息"}[e]||e),xe=e=>({low:"低",normal:"普通",high:"高"}[e]||e),Me=e=>e||"-",Ce=e=>e.types.every(e=>B.messageTypes.includes(e.value)),Ie=e=>{const a=e.types.filter(e=>B.messageTypes.includes(e.value)).length;return a>0&&a<e.types.length};return V(()=>B.departmentId,(e,a)=>{if(e!==a&&B.notificationMethods.length>0){const e=G.value.map(e=>e.value);B.notificationMethods=B.notificationMethods.filter(a=>e.includes(a))}}),x(()=>{ve(),(async()=>{p.value=!0;try{const a=await e.get("/message/notification-configs");m.value=a.success&&a.data?a.data:[]}catch(a){console.error("获取通知配置失败:",a),i.error("获取通知配置失败")}finally{p.value=!1}})()}),(a,o)=>{const m=M("el-icon"),p=M("el-button"),_=M("el-option"),w=M("el-select"),k=M("el-form-item"),V=M("el-form"),x=M("el-table-column"),be=M("el-tag"),ze=M("el-switch"),Ue=M("el-table"),Se=M("el-pagination"),Ae=M("el-checkbox"),Te=M("el-alert"),De=M("el-checkbox-group"),Fe=M("el-radio"),Ee=M("el-radio-group"),Ne=M("el-time-picker"),Pe=M("el-input"),Le=M("el-dialog"),qe=M("el-descriptions-item"),He=M("el-descriptions"),Be=C("loading");return z(),I("div",W,[U("div",$,[o[18]||(o[18]=U("div",{class:"header-left"},[U("h3",null,"消息订阅管理"),U("p",null,"管理各部门的消息订阅规则，设置不同消息类型的通知方式")],-1)),U("div",K,[S(p,{type:"primary",onClick:he},{default:A(()=>[S(m,null,{default:A(()=>[S(D(s))]),_:1}),o[17]||(o[17]=T(" 新建订阅规则 ",-1))]),_:1})])]),U("div",Y,[S(V,{model:r,inline:""},{default:A(()=>[S(k,{label:"部门"},{default:A(()=>[S(w,{modelValue:r.departmentId,"onUpdate:modelValue":o[0]||(o[0]=e=>r.departmentId=e),placeholder:"选择部门",clearable:"",style:{width:"200px"}},{default:A(()=>[S(_,{label:"全部部门",value:""}),(z(!0),I(F,null,E(n.value,e=>(z(),N(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"消息类型"},{default:A(()=>[S(w,{modelValue:r.messageType,"onUpdate:modelValue":o[1]||(o[1]=e=>r.messageType=e),placeholder:"选择消息类型",clearable:"",style:{width:"200px"}},{default:A(()=>[S(_,{label:"全部类型",value:""}),(z(!0),I(F,null,E(D(t),e=>(z(),N(_,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"状态"},{default:A(()=>[S(w,{modelValue:r.status,"onUpdate:modelValue":o[2]||(o[2]=e=>r.status=e),placeholder:"选择状态",clearable:"",style:{width:"120px"}},{default:A(()=>[S(_,{label:"全部状态",value:""}),S(_,{label:"启用",value:"enabled"}),S(_,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1}),S(k,null,{default:A(()=>[S(p,{type:"primary",onClick:ve},{default:A(()=>[...o[19]||(o[19]=[T("查询",-1)])]),_:1}),S(p,{onClick:ge},{default:A(()=>[...o[20]||(o[20]=[T("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),U("div",R,[P((z(),N(Ue,{data:u.value,stripe:"",border:"",style:{width:"100%"}},{default:A(()=>[S(x,{prop:"id",label:"规则ID",width:"80"}),S(x,{prop:"departmentName",label:"订阅部门",width:"120"}),S(x,{label:"消息类型",width:"250"},{default:A(({row:e})=>[U("div",J,[(z(!0),I(F,null,E(e.messageTypes,e=>(z(),N(be,{key:e,type:we(e),size:"small",style:{"margin-right":"4px","margin-bottom":"2px"}},{default:A(()=>[T(L(_e(e)),1)]),_:2},1032,["type"]))),128))])]),_:1}),S(x,{label:"通知方式",width:"200"},{default:A(({row:e})=>[U("div",Q,[(z(!0),I(F,null,E(e.notificationMethods,e=>(z(),N(be,{key:e,type:ke(e),size:"small",style:{"margin-right":"4px","margin-bottom":"2px"}},{default:A(()=>[T(L(Ve(e)),1)]),_:2},1032,["type"]))),128))])]),_:1}),S(x,{prop:"createdBy",label:"创建人",width:"100"}),S(x,{prop:"createdAt",label:"创建时间",width:"160"},{default:A(({row:e})=>[T(L(Me(e.createdAt)),1)]),_:1}),S(x,{label:"状态",width:"80"},{default:A(({row:a})=>[S(ze,{modelValue:a.isEnabled,"onUpdate:modelValue":e=>a.isEnabled=e,onChange:l=>(async a=>{a.statusLoading=!0;try{await e.put(`/message/subscription-rules/${a.id}/toggle`,{isEnabled:a.isEnabled}),i.success("订阅规则已"+(a.isEnabled?"启用":"禁用"))}catch(l){a.isEnabled=!a.isEnabled,console.error("状态更新失败:",l),i.error("状态更新失败")}finally{a.statusLoading=!1}})(a),loading:a.statusLoading},null,8,["modelValue","onUpdate:modelValue","onChange","loading"])]),_:1}),S(x,{label:"操作",width:"200",fixed:"right"},{default:A(({row:a})=>[S(p,{type:"primary",size:"small",onClick:e=>(e=>{y.value=e,g.value=!0})(a)},{default:A(()=>[...o[21]||(o[21]=[T(" 查看 ",-1)])]),_:1},8,["onClick"]),S(p,{type:"warning",size:"small",onClick:e=>(e=>{h.value=!0,Object.assign(B,e),v.value=!0})(a)},{default:A(()=>[...o[22]||(o[22]=[T(" 编辑 ",-1)])]),_:1},8,["onClick"]),S(p,{type:"danger",size:"small",onClick:l=>(async a=>{try{await d.confirm(`确定要删除"${a.departmentName}"的订阅规则吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await e.delete(`/message/subscription-rules/${a.id}`),i.success("删除成功"),ve()}catch(l){"cancel"!==l.message&&(console.error("删除失败:",l),i.error("删除失败，请重试"))}})(a)},{default:A(()=>[...o[23]||(o[23]=[T(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Be,c.value]]),U("div",Z,[S(Se,{"current-page":f.page,"onUpdate:currentPage":o[3]||(o[3]=e=>f.page=e),"page-size":f.size,"onUpdate:pageSize":o[4]||(o[4]=e=>f.size=e),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ve,onCurrentChange:ve},null,8,["current-page","page-size","total"])])]),S(Le,{modelValue:v.value,"onUpdate:modelValue":o[15]||(o[15]=e=>v.value=e),title:O.value,width:"700px","close-on-click-modal":!1,class:"subscription-dialog"},{footer:A(()=>[U("div",me,[S(p,{onClick:o[14]||(o[14]=e=>v.value=!1)},{default:A(()=>[...o[30]||(o[30]=[T("取消",-1)])]),_:1}),S(p,{type:"primary",onClick:ye,loading:b.value},{default:A(()=>[T(L(h.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:A(()=>[S(V,{ref_key:"subscriptionFormRef",ref:H,model:B,rules:j,"label-width":"90px",class:"subscription-form"},{default:A(()=>[S(k,{label:"订阅部门",prop:"departmentId"},{default:A(()=>[S(w,{modelValue:B.departmentId,"onUpdate:modelValue":o[5]||(o[5]=e=>B.departmentId=e),placeholder:"请选择部门",style:{width:"100%"},disabled:h.value},{default:A(()=>[(z(!0),I(F,null,E(n.value,e=>(z(),N(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),S(k,{label:"消息类型",prop:"messageTypes"},{default:A(()=>[U("div",X,[o[25]||(o[25]=U("div",{class:"selection-tip"},"选择要订阅的消息类型（支持多选）",-1)),U("div",ee,[(z(),I(F,null,E(l,e=>U("div",{key:e.name,class:"type-category-compact"},[U("div",ae,[U("span",le,L(e.name),1),S(Ae,{indeterminate:Ie(e),"model-value":Ce(e),onChange:a=>((e,a)=>{a?e.types.forEach(e=>{B.messageTypes.includes(e.value)||B.messageTypes.push(e.value)}):e.types.forEach(e=>{const a=B.messageTypes.indexOf(e.value);a>-1&&B.messageTypes.splice(a,1)})})(e,a),class:"category-check-all-compact",size:"small"},{default:A(()=>[...o[24]||(o[24]=[T(" 全选 ",-1)])]),_:1},8,["indeterminate","model-value","onChange"])]),U("div",te,[(z(!0),I(F,null,E(e.types,e=>(z(),N(Ae,{key:e.value,modelValue:B.messageTypes,"onUpdate:modelValue":o[6]||(o[6]=e=>B.messageTypes=e),label:e.value,class:"type-option-compact",disabled:h.value,size:"small"},{default:A(()=>[T(L(e.label),1)]),_:2},1032,["modelValue","label","disabled"]))),128))])])),64))])])]),_:1}),S(k,{label:"通知方式",prop:"notificationMethods"},{default:A(()=>[U("div",se,[B.departmentId?(z(),I("div",ie,[S(De,{modelValue:B.notificationMethods,"onUpdate:modelValue":o[7]||(o[7]=e=>B.notificationMethods=e),class:"methods-group"},{default:A(()=>[(z(!0),I(F,null,E(G.value,e=>(z(),I("div",{key:e.value,class:"method-card"},[S(Ae,{label:e.value,class:"method-checkbox"},{default:A(()=>[U("div",de,[U("div",oe,L(e.label),1),U("div",ne,[e.memberCount?(z(),I("span",re,L(e.memberCount)+"人",1)):q("",!0),e.configStatus?(z(),N(be,{key:1,type:"已配置"===e.configStatus?"success":"warning",size:"small",class:"config-status"},{default:A(()=>[T(L(e.configStatus),1)]),_:2},1032,["type"])):q("",!0)])])]),_:2},1032,["label"])]))),128))]),_:1},8,["modelValue"])])):(z(),N(Te,{key:0,title:"请先选择订阅部门",description:"系统将根据部门的通知配置显示可用的通知方式",type:"info",closable:!1,"show-icon":"",class:"department-alert"}))])]),_:1}),S(k,{label:"优先级",prop:"priority"},{default:A(()=>[S(Ee,{modelValue:B.priority,"onUpdate:modelValue":o[8]||(o[8]=e=>B.priority=e),class:"priority-group"},{default:A(()=>[S(Fe,{label:"low",class:"priority-option"},{default:A(()=>[...o[26]||(o[26]=[T("低",-1)])]),_:1}),S(Fe,{label:"normal",class:"priority-option"},{default:A(()=>[...o[27]||(o[27]=[T("普通",-1)])]),_:1}),S(Fe,{label:"high",class:"priority-option"},{default:A(()=>[...o[28]||(o[28]=[T("高",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"时间设置"},{default:A(()=>[U("div",ue,[S(Ae,{modelValue:B.scheduleEnabled,"onUpdate:modelValue":o[9]||(o[9]=e=>B.scheduleEnabled=e),label:"启用时间限制"},null,8,["modelValue"]),B.scheduleEnabled?(z(),I("div",ce,[S(Ne,{modelValue:B.scheduleStart,"onUpdate:modelValue":o[10]||(o[10]=e=>B.scheduleStart=e),placeholder:"开始时间",format:"HH:mm","value-format":"HH:mm",class:"time-picker"},null,8,["modelValue"]),o[29]||(o[29]=U("span",{class:"time-separator"},"至",-1)),S(Ne,{modelValue:B.scheduleEnd,"onUpdate:modelValue":o[11]||(o[11]=e=>B.scheduleEnd=e),placeholder:"结束时间",format:"HH:mm","value-format":"HH:mm",class:"time-picker"},null,8,["modelValue"]),S(Ae,{modelValue:B.excludeWeekends,"onUpdate:modelValue":o[12]||(o[12]=e=>B.excludeWeekends=e),label:"排除周末",class:"weekend-option"},null,8,["modelValue"])])):q("",!0)])]),_:1}),S(k,{label:"备注"},{default:A(()=>[S(Pe,{modelValue:B.remark,"onUpdate:modelValue":o[13]||(o[13]=e=>B.remark=e),type:"textarea",rows:2,placeholder:"可选：输入备注信息",class:"remark-input"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),S(Le,{modelValue:g.value,"onUpdate:modelValue":o[16]||(o[16]=e=>g.value=e),title:"订阅规则详情",width:"500px"},{default:A(()=>[y.value?(z(),I("div",pe,[S(He,{column:1,border:""},{default:A(()=>[S(qe,{label:"规则ID"},{default:A(()=>[T(L(y.value.id),1)]),_:1}),S(qe,{label:"订阅部门"},{default:A(()=>[T(L(y.value.departmentName),1)]),_:1}),S(qe,{label:"消息类型"},{default:A(()=>[S(be,{type:we(y.value.messageType)},{default:A(()=>[T(L(y.value.messageTypeName),1)]),_:1},8,["type"])]),_:1}),S(qe,{label:"通知方式"},{default:A(()=>[U("div",fe,[(z(!0),I(F,null,E(y.value.notificationMethods,e=>(z(),N(be,{key:e,type:ke(e),size:"small",style:{"margin-right":"4px","margin-bottom":"2px"}},{default:A(()=>[T(L(Ve(e)),1)]),_:2},1032,["type"]))),128))])]),_:1}),S(qe,{label:"优先级"},{default:A(()=>{return[S(be,{type:(e=y.value.priority,{low:"info",normal:"primary",high:"danger"}[e]||"primary")},{default:A(()=>[T(L(xe(y.value.priority)),1)]),_:1},8,["type"])];var e}),_:1}),S(qe,{label:"状态"},{default:A(()=>[S(be,{type:y.value.isEnabled?"success":"danger"},{default:A(()=>[T(L(y.value.isEnabled?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),S(qe,{label:"创建人"},{default:A(()=>[T(L(y.value.createdBy),1)]),_:1}),S(qe,{label:"创建时间"},{default:A(()=>[T(L(Me(y.value.createdAt)),1)]),_:1}),S(qe,{label:"更新时间"},{default:A(()=>[T(L(Me(y.value.updatedAt)),1)]),_:1}),y.value.remark?(z(),N(qe,{key:0,label:"备注"},{default:A(()=>[T(L(y.value.remark),1)]),_:1})):q("",!0)]),_:1})])):q("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-d3af32b4"]]),ge={class:"announcement-publish"},he={class:"publish-header"},be={class:"header-right"},ye={class:"filter-section"},_e={class:"announcement-list"},we={class:"announcement-title"},ke={class:"display-methods"},Ve={class:"publish-time"},xe={class:"editor-container"},Me="default",Ce=a(y({__name:"AnnouncementPublish",setup(e){const a=l(),t=H(),m={toolbarKeys:["headerSelect","bold","italic","underline","through","color","bgColor","|","fontSize","fontFamily","lineHeight","|","bulletedList","numberedList","todo","|","emotion","insertLink","insertImage","insertTable","codeBlock","divider","|","undo","redo","|","fullScreen"]},p={placeholder:"请输入公告内容...",MENU_CONF:{uploadImage:{server:"/api/v1/upload/image",fieldName:"file",maxFileSize:5242880,allowedFileTypes:["image/*"],onBeforeUpload:e=>(console.log("onBeforeUpload",e),e),onProgress(e){console.log("onProgress",e)},onSuccess(e,a){console.log("onSuccess",e,a)},onFailed(e,a){console.log("onFailed",e,a),i.error("图片上传失败")},onError(e,a,l){console.log("onError",e,a,l),i.error("图片上传出错")}}}},f=_(!1),v=_(!1),g=_(!1),h=_(!1),b=_("immediate"),y=w({status:"",type:""}),k=_([]),V=w({title:"",content:"",type:"company",targetDepartments:[],isPopup:!1,isMarquee:!0,scheduledAt:""}),F={title:[{required:!0,message:"请输入公告标题",trigger:"blur"}],content:[{required:!0,message:"请输入公告内容",trigger:"blur"}],type:[{required:!0,message:"请选择公告类型",trigger:"change"}],targetDepartments:[{validator:(e,a,l)=>{"department"!==V.type||a&&0!==a.length?l():l(new Error("请选择目标部门"))},trigger:"change"}],scheduledAt:[{validator:(e,a,l)=>{"scheduled"!==b.value||a?l():l(new Error("请选择发布时间"))},trigger:"change"}]},E=_(),j=e=>{if(!e)return"info";return{draft:"info",published:"success",scheduled:"warning",expired:"danger"}[e]||"info"},W=e=>{if(!e)return"未知状态";return{draft:"草稿",published:"已发布",scheduled:"已安排",expired:"已过期"}[e]||e},$=async()=>{f.value=!0;try{const e=await a.loadAnnouncements(y);e&&e.success&&Array.isArray(e.data)||e&&Array.isArray(e.data)?k.value=e.data:e&&Array.isArray(e)?k.value=e:k.value=[]}catch(e){console.error("加载公告列表失败:",e),k.value=[]}finally{f.value=!1}},K=()=>{y.status="",y.type="",$()},Y=()=>{h.value=!1,g.value=!0},R=async()=>{if(E.value)try{await E.value.validate(),v.value=!0;const e={...V,status:"immediate"===b.value?"published":"scheduled",publishedAt:"immediate"===b.value?(new Date).toISOString().replace("T"," ").substring(0,19):void 0};"immediate"===b.value&&delete e.scheduledAt,h.value?await a.updateAnnouncement(e.id,e):await a.createAnnouncement(e),g.value=!1,$()}catch(e){console.error("保存公告失败:",e)}finally{v.value=!1}},J=()=>{Object.assign(V,{title:"",content:"",type:"company",targetDepartments:[],isPopup:!1,isMarquee:!0,scheduledAt:""}),b.value="immediate",E.value&&E.value.resetFields()},Q=e=>{t.value=e},Z=e=>{};return x(()=>{$()}),B(()=>{const e=t.value;null!=e&&e.destroy()}),(e,l)=>{const i=M("el-icon"),_=M("el-button"),w=M("el-option"),x=M("el-select"),H=M("el-form-item"),B=M("el-form"),X=M("el-table-column"),ee=M("el-tag"),ae=M("el-tooltip"),le=M("el-table"),te=M("el-input"),se=M("el-radio"),ie=M("el-radio-group"),de=M("el-checkbox"),oe=M("el-date-picker"),ne=M("el-dialog"),re=C("loading");return z(),I("div",ge,[U("div",he,[l[13]||(l[13]=U("div",{class:"header-left"},[U("h3",null,"公告发布管理"),U("p",null,"发布和管理系统公告")],-1)),U("div",be,[S(_,{type:"primary",onClick:Y},{default:A(()=>[S(i,null,{default:A(()=>[S(D(s))]),_:1}),l[12]||(l[12]=T(" 发布公告 ",-1))]),_:1})])]),U("div",ye,[S(B,{model:y,inline:""},{default:A(()=>[S(H,{label:"公告状态"},{default:A(()=>[S(x,{modelValue:y.status,"onUpdate:modelValue":l[0]||(l[0]=e=>y.status=e),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:A(()=>[S(w,{label:"草稿",value:"draft"}),S(w,{label:"已发布",value:"published"}),S(w,{label:"已安排",value:"scheduled"}),S(w,{label:"已过期",value:"expired"})]),_:1},8,["modelValue"])]),_:1}),S(H,{label:"公告类型"},{default:A(()=>[S(x,{modelValue:y.type,"onUpdate:modelValue":l[1]||(l[1]=e=>y.type=e),placeholder:"全部类型",clearable:"",style:{width:"120px"}},{default:A(()=>[S(w,{label:"全公司",value:"company"}),S(w,{label:"部门",value:"department"})]),_:1},8,["modelValue"])]),_:1}),S(H,null,{default:A(()=>[S(_,{type:"primary",onClick:$},{default:A(()=>[S(i,null,{default:A(()=>[S(D(o))]),_:1}),l[14]||(l[14]=T(" 查询 ",-1))]),_:1}),S(_,{onClick:K},{default:A(()=>[S(i,null,{default:A(()=>[S(D(n))]),_:1}),l[15]||(l[15]=T(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),U("div",_e,[P((z(),N(le,{data:k.value,stripe:"",style:{width:"100%"}},{default:A(()=>[S(X,{prop:"title",label:"公告标题","min-width":"200"},{default:A(({row:e})=>[U("div",we,[S(i,{class:"title-icon"},{default:A(()=>[S(D(r))]),_:1}),U("span",null,L(e.title),1)])]),_:1}),S(X,{label:"公告类型",width:"100",align:"center"},{default:A(({row:e})=>[S(ee,{type:"company"===e.type?"primary":"success",size:"small"},{default:A(()=>[T(L("company"===e.type?"全公司":"部门"),1)]),_:2},1032,["type"])]),_:1}),S(X,{label:"状态",width:"100",align:"center"},{default:A(({row:e})=>[S(ee,{type:j(e.status),size:"small"},{default:A(()=>[T(L(W(e.status)),1)]),_:2},1032,["type"])]),_:1}),S(X,{label:"显示方式",width:"120",align:"center"},{default:A(({row:e})=>[U("div",ke,[e.isPopup?(z(),N(ae,{key:0,content:"弹窗显示"},{default:A(()=>[S(i,{class:"method-icon popup"},{default:A(()=>[S(D(u))]),_:1})]),_:1})):q("",!0),e.isMarquee?(z(),N(ae,{key:1,content:"横幅滚动"},{default:A(()=>[S(i,{class:"method-icon marquee"},{default:A(()=>[S(D(c))]),_:1})]),_:1})):q("",!0)])]),_:1}),S(X,{label:"发布时间",width:"160",align:"center"},{default:A(({row:e})=>[U("div",Ve,L(e.publishedAt||e.scheduledAt||"-"),1)]),_:1}),S(X,{label:"创建人",width:"100",align:"center"},{default:A(({row:e})=>[T(L(e.createdBy),1)]),_:1}),S(X,{label:"操作",width:"200",align:"center",fixed:"right"},{default:A(({row:e})=>[S(_,{type:"primary",size:"small",onClick:a=>(e=>{h.value=!0,Object.assign(V,{id:e.id,title:e.title,content:e.content,type:e.type,targetDepartments:e.targetDepartments||[],isPopup:e.isPopup,isMarquee:e.isMarquee,scheduledAt:e.scheduledAt||""}),b.value=e.scheduledAt?"scheduled":"immediate",g.value=!0})(e)},{default:A(()=>[...l[16]||(l[16]=[T(" 编辑 ",-1)])]),_:1},8,["onClick"]),"draft"===e.status?(z(),N(_,{key:0,type:"success",size:"small",onClick:l=>(async e=>{try{await d.confirm("确认发布此公告吗？","确认发布",{type:"warning"}),await a.updateAnnouncement(e.id,{status:"published"}),$()}catch(l){"cancel"!==l&&console.error("发布公告失败:",l)}})(e)},{default:A(()=>[...l[17]||(l[17]=[T(" 发布 ",-1)])]),_:1},8,["onClick"])):q("",!0),S(_,{type:"danger",size:"small",onClick:l=>(async e=>{try{await d.confirm("确认删除此公告吗？删除后无法恢复。","确认删除",{type:"warning"}),await a.deleteAnnouncement(e.id),$()}catch(l){"cancel"!==l&&console.error("删除公告失败:",l)}})(e)},{default:A(()=>[...l[18]||(l[18]=[T(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[re,f.value]])]),S(ne,{modelValue:g.value,"onUpdate:modelValue":l[11]||(l[11]=e=>g.value=e),title:h.value?"编辑公告":"发布公告",width:"800px",onClose:J},{footer:A(()=>[S(_,{onClick:l[10]||(l[10]=e=>g.value=!1)},{default:A(()=>[...l[25]||(l[25]=[T("取消",-1)])]),_:1}),S(_,{type:"primary",onClick:R,loading:v.value},{default:A(()=>[T(L(h.value?"更新":"发布"),1)]),_:1},8,["loading"])]),default:A(()=>[S(B,{model:V,rules:F,ref_key:"formRef",ref:E,"label-width":"100px"},{default:A(()=>[S(H,{label:"公告标题",prop:"title"},{default:A(()=>[S(te,{modelValue:V.title,"onUpdate:modelValue":l[2]||(l[2]=e=>V.title=e),placeholder:"请输入公告标题"},null,8,["modelValue"])]),_:1}),S(H,{label:"公告内容",prop:"content"},{default:A(()=>[U("div",xe,[S(D(O),{style:{"border-bottom":"1px solid #ccc"},editor:t.value,defaultConfig:m,mode:Me},null,8,["editor"]),S(D(G),{style:{height:"300px","overflow-y":"hidden"},modelValue:V.content,"onUpdate:modelValue":l[3]||(l[3]=e=>V.content=e),defaultConfig:p,mode:Me,onOnCreated:Q,onOnChange:Z},null,8,["modelValue"])])]),_:1}),S(H,{label:"公告类型",prop:"type"},{default:A(()=>[S(ie,{modelValue:V.type,"onUpdate:modelValue":l[4]||(l[4]=e=>V.type=e)},{default:A(()=>[S(se,{label:"company"},{default:A(()=>[...l[19]||(l[19]=[T("全公司",-1)])]),_:1}),S(se,{label:"department"},{default:A(()=>[...l[20]||(l[20]=[T("指定部门",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"department"===V.type?(z(),N(H,{key:0,label:"目标部门",prop:"targetDepartments"},{default:A(()=>[S(x,{modelValue:V.targetDepartments,"onUpdate:modelValue":l[5]||(l[5]=e=>V.targetDepartments=e),multiple:"",placeholder:"请选择目标部门",style:{width:"100%"}},{default:A(()=>[S(w,{label:"销售部",value:"sales"}),S(w,{label:"技术部",value:"tech"}),S(w,{label:"市场部",value:"marketing"}),S(w,{label:"财务部",value:"finance"}),S(w,{label:"人事部",value:"hr"})]),_:1},8,["modelValue"])]),_:1})):q("",!0),S(H,{label:"显示方式"},{default:A(()=>[S(de,{modelValue:V.isPopup,"onUpdate:modelValue":l[6]||(l[6]=e=>V.isPopup=e)},{default:A(()=>[...l[21]||(l[21]=[T("弹窗显示",-1)])]),_:1},8,["modelValue"]),S(de,{modelValue:V.isMarquee,"onUpdate:modelValue":l[7]||(l[7]=e=>V.isMarquee=e)},{default:A(()=>[...l[22]||(l[22]=[T("横幅滚动",-1)])]),_:1},8,["modelValue"])]),_:1}),S(H,{label:"发布方式"},{default:A(()=>[S(ie,{modelValue:b.value,"onUpdate:modelValue":l[8]||(l[8]=e=>b.value=e)},{default:A(()=>[S(se,{label:"immediate"},{default:A(()=>[...l[23]||(l[23]=[T("立即发布",-1)])]),_:1}),S(se,{label:"scheduled"},{default:A(()=>[...l[24]||(l[24]=[T("定时发布",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"scheduled"===b.value?(z(),N(H,{key:1,label:"发布时间",prop:"scheduledAt"},{default:A(()=>[S(oe,{modelValue:V.scheduledAt,"onUpdate:modelValue":l[9]||(l[9]=e=>V.scheduledAt=e),type:"datetime",placeholder:"选择发布时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})):q("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-e0ee43b6"]]);const Ie=new class{configs=[];async loadConfigurations(){try{return this.configs=JSON.parse(localStorage.getItem("notification_configs")||"[]"),this.configs}catch(e){return console.error("加载通知配置失败:",e),[]}}async saveConfiguration(e){try{const a=this.configs.findIndex(a=>a.id===e.id);a>=0?this.configs[a]=e:this.configs.push(e),localStorage.setItem("notification_configs",JSON.stringify(this.configs))}catch(a){throw console.error("保存通知配置失败:",a),a}}async triggerNotification(e){try{const a=this.getMatchingConfigs(e);for(const l of a)await this.sendNotification(l,e)}catch(a){console.error("触发通知失败:",a)}}getMatchingConfigs(e){return this.configs.filter(a=>!!a.enabled&&(!!a.departmentIds.includes(e.userDepartmentId)&&(!(a.memberIds.length>0&&!a.memberIds.includes(e.userId))&&(!a.messageType||a.messageType===e.type))))}async sendNotification(e,a){try{switch(e.notificationMethod){case"dingtalk":await this.sendDingTalkNotification(e,a);break;case"wechat_work":await this.sendWeChatWorkNotification(e,a);break;case"email":await this.sendEmailNotification(e,a);break;case"sms":await this.sendSmsNotification(e,a);break;case"system_message":await this.sendSystemNotification(e,a);break;default:console.warn("未知的通知方式:",e.notificationMethod)}}catch(l){console.error(`发送${e.notificationMethod}通知失败:`,l)}}async sendDingTalkNotification(e,a){console.log("发送钉钉通知:",{config:e.name,message:a.message,webhook:e.params?.webhook}),i.success(`钉钉通知已发送: ${a.message}`)}async sendWeChatWorkNotification(e,a){const l={msgtype:"text",text:{content:a.message,mentioned_mobile_list:e.params?.mentionAll?["@all"]:e.params?.mentionedList?e.params.mentionedList.split(",").map(e=>e.trim()):[]}};console.log("发送企业微信群机器人通知:",{config:e.name,groupName:e.params?.groupName||"未命名群",webhook:e.params?.webhook,message:l,mentionAll:e.params?.mentionAll,mentionedList:e.params?.mentionedList});const t=e.params?.groupName?` (${e.params.groupName})`:"";i.success(`企业微信群机器人通知已发送${t}: ${a.message}`)}async sendEmailNotification(e,a){console.log("发送邮件通知:",{config:e.name,message:a.message,smtp:e.params?.smtpServer}),i.success(`邮件通知已发送: ${a.message}`)}async sendSmsNotification(e,a){console.log("发送短信通知:",{config:e.name,message:a.message,provider:e.params?.smsProvider}),i.success(`短信通知已发送: ${a.message}`)}async sendSystemNotification(e,a){console.log("发送系统通知:",{config:e.name,message:a.message,userId:a.userId}),i.info(`系统通知已发送: ${a.message}`)}async testConfiguration(e){try{const a={type:"custom",userId:"test-user",userDepartmentId:e.departmentIds[0]||"test-dept",data:{},message:"这是一条测试通知消息",title:"测试通知"};return await this.sendNotification(e,a),!0}catch(a){return console.error("测试通知配置失败:",a),!1}}},ze={class:"message-config"},Ue={class:"page-header"},Se={class:"header-right"},Ae={class:"filter-section"},Te={class:"config-cards"},De={class:"card-header"},Fe={class:"header-left"},Ee={class:"method-icon"},Ne={class:"method-info"},Pe={class:"method-name"},Le={class:"config-name"},qe={class:"header-right"},He={class:"card-content"},Be={class:"content-section"},je={class:"department-selection"},Oe={class:"selected-departments"},Ge={class:"content-section"},We={class:"member-selection"},$e={key:0,class:"all-members-notice"},Ke={key:1,class:"member-config"},Ye={key:0,class:"selected-members"},Re={class:"content-section"},Je={class:"config-params"},Qe={class:"config-status"},Ze={class:"card-footer"},Xe={class:"footer-left"},ea={class:"created-info"},aa={class:"footer-right"},la={key:0,class:"empty-state"},ta={key:0,class:"pagination-wrapper"},sa={class:"member-selection"},ia={key:0,class:"selected-members"},da={class:"config-params"},oa={class:"member-selector"},na={class:"member-filter"},ra={key:0,class:"config-detail"},ua={class:"department-list"},ca={key:0},ma={key:1,class:"member-list"},pa=a(y({__name:"MessageConfig",setup(e){const a=t(),l=_([{value:"dingtalk",label:"钉钉"},{value:"wechat_work",label:"企业微信"},{value:"email",label:"邮件"},{value:"sms",label:"短信"},{value:"system_message",label:"系统消息"}]),o=_([{id:"1",name:"销售部",memberCount:15},{id:"2",name:"客服部",memberCount:8},{id:"3",name:"技术部",memberCount:12},{id:"4",name:"财务部",memberCount:5},{id:"5",name:"人事部",memberCount:3}]),n=k(()=>a.users.map(e=>({id:e.id,name:e.realName||e.name||e.username,departmentId:e.departmentId||"",departmentName:e.departmentName||e.department||"未分配",position:e.position||"员工",email:e.email||"",phone:e.phone||""}))),r=_([{id:"1",name:"销售部钉钉通知",notificationMethod:"dingtalk",departments:[{id:"1",name:"销售部"}],members:[{id:"1",name:"张三",departmentName:"销售部"},{id:"2",name:"李四",departmentName:"销售部"}],enabled:!0,createdBy:"系统管理员",createdAt:"2024-01-15 10:00:00",description:"销售部门钉钉通知配置",params:{webhook:"https://oapi.dingtalk.com/robot/send?access_token=xxx",secret:"xxx",atAll:!1},statusLoading:!1,testLoading:!1},{id:"2",name:"全员系统消息",notificationMethod:"system_message",departments:o.value,members:[],enabled:!0,createdBy:"系统管理员",createdAt:"2024-01-15 09:30:00",description:"系统消息全员通知",params:{retentionDays:30,autoMarkRead:!1,pushToMobile:!0},statusLoading:!1,testLoading:!1}]),u=_(!1),c=_(!1),h=_(!1),b=_(!1),y=_(!1),V=_(!1),H=_(null),B=w({notificationMethod:"",departmentId:"",status:""}),O=w({currentPage:1,pageSize:10,total:0}),G=_(),W=w({id:"",name:"",notificationMethod:"",departmentIds:[],memberIds:[],description:"",params:{}}),$={name:[{required:!0,message:"请输入配置名称",trigger:"blur"}],notificationMethod:[{required:!0,message:"请选择通知方式",trigger:"change"}],departmentIds:[{required:!0,message:"请选择支持的部门",trigger:"change"}]},K=_(),Y=w({departmentId:"",name:""}),R=_([]),J=_([]),Q=k(()=>{let e=[...r.value];if(B.notificationMethod&&(e=e.filter(e=>e.notificationMethod===B.notificationMethod)),B.departmentId&&(e=e.filter(e=>e.departments.some(e=>e.id===B.departmentId))),B.status){const a="enabled"===B.status;e=e.filter(e=>e.enabled===a)}O.total=e.length;const a=(O.currentPage-1)*O.pageSize,l=a+O.pageSize;return e.slice(a,l)}),Z=k(()=>n.value.filter(e=>W.memberIds.includes(e.id))),X=k(()=>W.departmentIds.length>0?o.value.filter(e=>W.departmentIds.includes(e.id)):o.value),ee=e=>{const a=l.value.find(a=>a.value===e);return a?a.label:e},ae=async()=>{u.value=!0;try{await new Promise(e=>setTimeout(e,500))}catch(e){i.error("加载配置失败")}finally{u.value=!1}},le=()=>{B.notificationMethod="",B.departmentId="",B.status="",ae()},te=()=>{V.value=!1,se(),h.value=!0},se=()=>{W.id="",W.name="",W.notificationMethod="",W.departmentIds=[],W.memberIds=[],W.description="",W.params={}},ie=async()=>{if(G.value)try{await G.value.validate(),c.value=!0;const e={id:V.value?W.id:Date.now().toString(),name:W.name,notificationMethod:W.notificationMethod,messageType:W.messageType,departmentIds:W.departmentIds,memberIds:"system_message"===W.notificationMethod?[]:W.memberIds,enabled:!0,params:W.params};await Ie.saveConfiguration(e);const a={...e,departments:o.value.filter(a=>e.departmentIds.includes(a.id)),members:n.value.filter(a=>e.memberIds.includes(a.id)),createdBy:"当前用户",createdAt:(new Date).toISOString().replace("T"," ").substring(0,19),statusLoading:!1,testLoading:!1};if(V.value){const l=r.value.findIndex(a=>a.id===e.id);l>-1&&(r.value[l]={...r.value[l],...a}),i.success("配置更新成功")}else r.value.unshift(a),i.success("配置创建成功");h.value=!1}catch(e){console.error("保存失败:",e)}finally{c.value=!1}},de=()=>{let e=n.value;W.departmentIds.length>0&&(e=e.filter(e=>W.departmentIds.includes(e.departmentId))),Y.departmentId&&(e=e.filter(e=>e.departmentId===Y.departmentId)),Y.name&&(e=e.filter(e=>e.name.includes(Y.name))),R.value=e},oe=e=>{J.value=e},ne=()=>{H.value?(H.value.members=[...J.value],i.success("成员配置已更新")):W.memberIds=J.value.map(e=>e.id),b.value=!1},re=e=>{O.pageSize=e,O.currentPage=1},ue=e=>{O.currentPage=e},ce=e=>{e?(H.value=e,J.value=[...e.members||[]]):J.value=[...Z.value],de(),b.value=!0,j(()=>{K.value&&J.value.forEach(e=>{K.value.toggleRowSelection(e,!0)})})},me=e=>{if(!e.config)return!1;switch(e.notificationMethod){case"dingtalk":return!(!e.config.webhook||!e.config.secret);case"wechat_work":return!!e.config.webhook;case"email":return!!(e.config.smtpHost&&e.config.smtpPort&&e.config.username&&e.config.password);case"sms":return!!(e.config.accessKeyId&&e.config.accessKeySecret&&e.config.signName&&e.config.templateCode);case"system_message":return!0;default:return!1}};return x(async()=>{await a.loadUsers(),await Ie.loadConfigurations(),ae()}),(e,a)=>{const t=M("el-icon"),n=M("el-button"),_=M("el-option"),w=M("el-select"),k=M("el-form-item"),x=M("el-form"),j=M("el-switch"),se=M("el-tag"),pe=M("el-empty"),fe=M("el-pagination"),ve=M("el-input"),ge=M("el-alert"),he=M("el-dialog"),be=M("el-table-column"),ye=M("el-table"),_e=M("el-descriptions-item"),we=M("el-descriptions"),ke=C("loading");return z(),I("div",ze,[U("div",Ue,[a[31]||(a[31]=U("div",{class:"header-left"},[U("h3",null,"通知配置管理"),U("p",null,"配置各种通知方式的部门和成员设置，管理通知渠道的可用性")],-1)),U("div",Se,[S(n,{type:"primary",onClick:te},{default:A(()=>[S(t,null,{default:A(()=>[S(D(s))]),_:1}),a[30]||(a[30]=T(" 新建配置 ",-1))]),_:1})])]),U("div",Ae,[S(x,{inline:""},{default:A(()=>[S(k,{label:"通知方式"},{default:A(()=>[S(w,{modelValue:B.notificationMethod,"onUpdate:modelValue":a[0]||(a[0]=e=>B.notificationMethod=e),placeholder:"选择通知方式",clearable:"",style:{width:"200px"}},{default:A(()=>[S(_,{label:"全部",value:""}),(z(!0),I(F,null,E(l.value,e=>(z(),N(_,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"部门"},{default:A(()=>[S(w,{modelValue:B.departmentId,"onUpdate:modelValue":a[1]||(a[1]=e=>B.departmentId=e),placeholder:"选择部门",clearable:"",style:{width:"200px"}},{default:A(()=>[S(_,{label:"全部",value:""}),(z(!0),I(F,null,E(o.value,e=>(z(),N(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"状态"},{default:A(()=>[S(w,{modelValue:B.status,"onUpdate:modelValue":a[2]||(a[2]=e=>B.status=e),placeholder:"选择状态",clearable:"",style:{width:"200px"}},{default:A(()=>[S(_,{label:"全部",value:""}),S(_,{label:"启用",value:"enabled"}),S(_,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1}),S(k,null,{default:A(()=>[S(n,{type:"primary",onClick:ae},{default:A(()=>[...a[32]||(a[32]=[T("搜索",-1)])]),_:1}),S(n,{onClick:le},{default:A(()=>[...a[33]||(a[33]=[T("重置",-1)])]),_:1})]),_:1})]),_:1})]),P((z(),I("div",Te,[(z(!0),I(F,null,E(Q.value,e=>(z(),I("div",{key:e.id,class:"config-card"},[U("div",De,[U("div",Fe,[U("div",Ee,["dingtalk"===e.notificationMethod?(z(),N(t,{key:0,class:"dingtalk-icon"},{default:A(()=>[...a[34]||(a[34]=[U("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[U("defs",null,[U("linearGradient",{id:"dingtalkGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[U("stop",{offset:"0%",style:{"stop-color":"#1890FF","stop-opacity":"1"}}),U("stop",{offset:"100%",style:{"stop-color":"#096DD9","stop-opacity":"1"}})])]),U("circle",{cx:"512",cy:"512",r:"448",fill:"url(#dingtalkGradient)"}),U("path",{d:"M512 128c-212.1 0-384 171.9-384 384 0 84.4 27.2 162.4 73.3 225.9L288 864l134.4-67.2c29.1 8.9 59.8 13.6 91.6 13.6 212.1 0 384-171.9 384-384S724.1 128 512 128z",fill:"white"}),U("path",{d:"M685.7 394.1c-2.3-8.1-3.8-16.5-4.4-25.1-1.2-17.1 0-34.4 3.6-51.2 2.4-11.2 6-22.1 10.7-32.6 3.6-8.1 8.1-15.8 13.4-23 4.8-6.5 10.4-12.4 16.7-17.6l-15.2-19.6c-9.8 8.1-18.7 17.3-26.5 27.4-8.5 11-15.8 22.9-21.6 35.6-6.3 13.8-11 28.3-13.9 43.2-2.7 13.8-3.6 27.9-2.7 41.9 0.6 9.5 2.2 18.9 4.8 28.1l35.1-6.1z",fill:"#1890FF"}),U("path",{d:"M512 320c-106 0-192 86-192 192s86 192 192 192 192-86 192-192-86-192-192-192zm0 320c-70.7 0-128-57.3-128-128s57.3-128 128-128 128 57.3 128 128-57.3 128-128 128z",fill:"#1890FF"}),U("circle",{cx:"512",cy:"512",r:"64",fill:"#1890FF"})],-1)])]),_:1})):"wechat_work"===e.notificationMethod?(z(),N(t,{key:1,class:"wechat-icon"},{default:A(()=>[...a[35]||(a[35]=[U("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[U("defs",null,[U("linearGradient",{id:"wechatGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[U("stop",{offset:"0%",style:{"stop-color":"#52C41A","stop-opacity":"1"}}),U("stop",{offset:"100%",style:{"stop-color":"#389E0D","stop-opacity":"1"}})])]),U("circle",{cx:"512",cy:"512",r:"448",fill:"url(#wechatGradient)"}),U("path",{d:"M663.2 394.9c-103.1-45.7-226.4-19.7-299.2 63.1-72.8 82.8-72.8 207.6 0 290.4 36.4 41.4 86.9 67.8 142.4 74.6l-28.4-42.6c-38.5-5.8-73.9-24.1-100.8-52.2-53.6-56.1-53.6-147.9 0-204 53.6-56.1 140.4-56.1 194 0 26.9 28.1 42.4 65.5 43.6 105.4h56.8c-1.2-57.4-24.1-111.9-63.1-152.3-19.5-20.2-42.6-36.4-68.1-47.8 41.4-28.1 94.3-28.1 135.7 0 20.2 13.7 36.4 32.5 47.8 54.9l42.6-28.4c-16.2-32.5-40.2-60.6-70.7-81.1z",fill:"white"}),U("circle",{cx:"420",cy:"460",r:"24",fill:"white"}),U("circle",{cx:"604",cy:"460",r:"24",fill:"white"}),U("path",{d:"M380 580c0-22.1 17.9-40 40-40h184c22.1 0 40 17.9 40 40s-17.9 40-40 40H420c-22.1 0-40-17.9-40-40z",fill:"white"})],-1)])]),_:1})):"email"===e.notificationMethod?(z(),N(t,{key:2,class:"email-icon"},{default:A(()=>[...a[36]||(a[36]=[U("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[U("defs",null,[U("linearGradient",{id:"emailGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[U("stop",{offset:"0%",style:{"stop-color":"#FA8C16","stop-opacity":"1"}}),U("stop",{offset:"100%",style:{"stop-color":"#D46B08","stop-opacity":"1"}})])]),U("circle",{cx:"512",cy:"512",r:"448",fill:"url(#emailGradient)"}),U("path",{d:"M160 288c0-17.7 14.3-32 32-32h640c17.7 0 32 14.3 32 32v448c0 17.7-14.3 32-32 32H192c-17.7 0-32-14.3-32-32V288z",fill:"white"}),U("path",{d:"M832 320L512 544 192 320v416h640V320z",fill:"#FA8C16"}),U("path",{d:"M192 320l320 224 320-224H192z",fill:"white"}),U("path",{d:"M192 320l160 112v-112H192zm480 0v112l160-112H672z",fill:"#D46B08"})],-1)])]),_:1})):"sms"===e.notificationMethod?(z(),N(t,{key:3,class:"sms-icon"},{default:A(()=>[...a[37]||(a[37]=[U("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[U("defs",null,[U("linearGradient",{id:"smsGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[U("stop",{offset:"0%",style:{"stop-color":"#FF4D4F","stop-opacity":"1"}}),U("stop",{offset:"100%",style:{"stop-color":"#CF1322","stop-opacity":"1"}})])]),U("circle",{cx:"512",cy:"512",r:"448",fill:"url(#smsGradient)"}),U("rect",{x:"256",y:"192",width:"512",height:"640",rx:"64",ry:"64",fill:"white"}),U("rect",{x:"288",y:"224",width:"448",height:"576",rx:"32",ry:"32",fill:"#F5F5F5"}),U("rect",{x:"320",y:"256",width:"384",height:"32",rx:"16",ry:"16",fill:"#FF4D4F"}),U("rect",{x:"320",y:"320",width:"384",height:"320",rx:"16",ry:"16",fill:"white"}),U("circle",{cx:"400",cy:"420",r:"16",fill:"#FF4D4F"}),U("circle",{cx:"512",cy:"420",r:"16",fill:"#FF4D4F"}),U("circle",{cx:"624",cy:"420",r:"16",fill:"#FF4D4F"}),U("rect",{x:"320",y:"480",width:"256",height:"16",rx:"8",ry:"8",fill:"#D9D9D9"}),U("rect",{x:"320",y:"520",width:"320",height:"16",rx:"8",ry:"8",fill:"#D9D9D9"}),U("rect",{x:"320",y:"560",width:"192",height:"16",rx:"8",ry:"8",fill:"#D9D9D9"}),U("circle",{cx:"512",cy:"720",r:"32",fill:"#FF4D4F"})],-1)])]),_:1})):(z(),N(t,{key:4,class:"system-icon"},{default:A(()=>[...a[38]||(a[38]=[U("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[U("defs",null,[U("linearGradient",{id:"systemGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[U("stop",{offset:"0%",style:{"stop-color":"#722ED1","stop-opacity":"1"}}),U("stop",{offset:"100%",style:{"stop-color":"#531DAB","stop-opacity":"1"}})])]),U("circle",{cx:"512",cy:"512",r:"448",fill:"url(#systemGradient)"}),U("path",{d:"M512 128c-212.1 0-384 171.9-384 384s171.9 384 384 384 384-171.9 384-384-171.9-384-384-384z",fill:"white"}),U("path",{d:"M512 192c-176.7 0-320 143.3-320 320s143.3 320 320 320 320-143.3 320-320-143.3-320-320-320z",fill:"#722ED1"}),U("path",{d:"M448 320h128v64H448v-64zm0 128h128v192H448V448z",fill:"white"}),U("circle",{cx:"512",cy:"352",r:"24",fill:"white"}),U("rect",{x:"480",y:"416",width:"64",height:"160",rx:"8",ry:"8",fill:"white"})],-1)])]),_:1}))]),U("div",Ne,[U("h4",Pe,L(ee(e.notificationMethod)),1),U("p",Le,L(e.name),1)])]),U("div",qe,[S(j,{modelValue:e.enabled,"onUpdate:modelValue":a=>e.enabled=a,onChange:a=>(async e=>{e.statusLoading=!0;try{await new Promise(e=>setTimeout(e,500)),i.success("配置已"+(e.enabled?"启用":"禁用"))}catch(a){e.enabled=!e.enabled,i.error("状态更新失败")}finally{e.statusLoading=!1}})(e),loading:e.statusLoading,size:"large"},null,8,["modelValue","onUpdate:modelValue","onChange","loading"])])]),U("div",He,[U("div",Be,[a[39]||(a[39]=U("div",{class:"section-label"},"支持部门",-1)),U("div",je,[S(w,{"model-value":e.departments.map(e=>e.id),multiple:"",placeholder:"选择支持的部门",onChange:a=>((e,a)=>{e.departments=o.value.filter(e=>a.includes(e.id)),i.success("部门配置已更新")})(e,a),class:"department-select"},{default:A(()=>[(z(!0),I(F,null,E(o.value,e=>(z(),N(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["model-value","onChange"]),U("div",Oe,[(z(!0),I(F,null,E(e.departments.slice(0,3),e=>(z(),N(se,{key:e.id,size:"small",class:"dept-tag"},{default:A(()=>[T(L(e.name),1)]),_:2},1024))),128)),e.departments.length>3?(z(),N(se,{key:0,size:"small",type:"info",class:"dept-tag"},{default:A(()=>[T(" +"+L(e.departments.length-3),1)]),_:2},1024)):q("",!0)])])]),U("div",Ge,[a[41]||(a[41]=U("div",{class:"section-label"},"通知成员",-1)),U("div",We,["system_message"===e.notificationMethod?(z(),I("div",$e,[S(t,null,{default:A(()=>[S(D(m))]),_:1}),a[40]||(a[40]=U("span",null,"全员通知",-1))])):(z(),I("div",Ke,[S(n,{type:"primary",size:"small",onClick:a=>ce(e),class:"select-member-btn"},{default:A(()=>[T(" 选择成员 ("+L(e.members.length)+"人) ",1)]),_:2},1032,["onClick"]),e.members.length>0?(z(),I("div",Ye,[(z(!0),I(F,null,E(e.members.slice(0,2),e=>(z(),N(se,{key:e.id,size:"small",class:"member-tag"},{default:A(()=>[T(L(e.name),1)]),_:2},1024))),128)),e.members.length>2?(z(),N(se,{key:0,size:"small",type:"info",class:"member-tag"},{default:A(()=>[T(" +"+L(e.members.length-2),1)]),_:2},1024)):q("",!0)])):q("",!0)]))])]),U("div",Re,[a[43]||(a[43]=U("div",{class:"section-label"},"配置参数",-1)),U("div",Je,[S(n,{type:"text",onClick:a=>(e=>{H.value=e,V.value=!0,W.id=e.id,W.name=e.name,W.notificationMethod=e.notificationMethod,W.departmentIds=(e.departments||[]).map(e=>e.id),W.memberIds=(e.members||[]).map(e=>e.id),e.config&&Object.assign(W,e.config),h.value=!0})(e),class:"config-btn"},{default:A(()=>[S(t,null,{default:A(()=>[S(D(p))]),_:1}),a[42]||(a[42]=T(" 配置参数 ",-1))]),_:1},8,["onClick"]),U("div",Qe,[S(se,{type:me(e)?"success":"warning",size:"small"},{default:A(()=>[T(L(me(e)?"已配置":"待配置"),1)]),_:2},1032,["type"])])])])]),U("div",Ze,[U("div",Xe,[U("span",ea,L(e.createdBy)+" · "+L(e.createdAt),1)]),U("div",aa,[S(n,{type:"text",size:"small",onClick:a=>(async e=>{e.testLoading=!0;try{await Ie.testConfiguration(e)?i.success(`${ee(e.notificationMethod)}测试通知发送成功`):i.error("测试通知发送失败")}catch(a){i.error("测试通知发送失败")}finally{e.testLoading=!1}})(e),loading:e.testLoading},{default:A(()=>[S(t,null,{default:A(()=>[S(D(f))]),_:1}),a[44]||(a[44]=T(" 测试 ",-1))]),_:1},8,["onClick","loading"]),S(n,{type:"text",size:"small",onClick:a=>(e=>{V.value=!0,H.value=e,W.id=e.id,W.name=e.name,W.notificationMethod=e.notificationMethod,W.departmentIds=e.departments.map(e=>e.id),W.memberIds=e.members.map(e=>e.id),W.description=e.description,W.params={...e.params},h.value=!0})(e)},{default:A(()=>[S(t,null,{default:A(()=>[S(D(v))]),_:1}),a[45]||(a[45]=T(" 编辑 ",-1))]),_:1},8,["onClick"]),S(n,{type:"text",size:"small",onClick:a=>(async e=>{try{await d.confirm(`确定要删除配置"${e.name}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await new Promise(e=>setTimeout(e,500));const a=r.value.findIndex(a=>a.id===e.id);a>-1&&r.value.splice(a,1),i.success("删除成功")}catch(a){}})(e),class:"delete-btn"},{default:A(()=>[S(t,null,{default:A(()=>[S(D(g))]),_:1}),a[46]||(a[46]=T(" 删除 ",-1))]),_:1},8,["onClick"])])])]))),128)),0===Q.value.length?(z(),I("div",la,[S(pe,{description:"暂无通知配置"},{default:A(()=>[S(n,{type:"primary",onClick:te},{default:A(()=>[...a[47]||(a[47]=[T("创建第一个配置",-1)])]),_:1})]),_:1})])):q("",!0)])),[[ke,u.value]]),Q.value.length>0?(z(),I("div",ta,[S(fe,{"current-page":O.currentPage,"onUpdate:currentPage":a[3]||(a[3]=e=>O.currentPage=e),"page-size":O.pageSize,"onUpdate:pageSize":a[4]||(a[4]=e=>O.pageSize=e),"page-sizes":[6,12,18,24],total:O.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:re,onCurrentChange:ue},null,8,["current-page","page-size","total"])])):q("",!0),S(he,{modelValue:h.value,"onUpdate:modelValue":a[23]||(a[23]=e=>h.value=e),title:V.value?"编辑通知配置":"新建通知配置",width:"800px","close-on-click-modal":!1},{footer:A(()=>[S(n,{onClick:a[22]||(a[22]=e=>h.value=!1)},{default:A(()=>[...a[52]||(a[52]=[T("取消",-1)])]),_:1}),S(n,{type:"primary",onClick:ie,loading:c.value},{default:A(()=>[T(L(V.value?"更新":"创建"),1)]),_:1},8,["loading"])]),default:A(()=>[S(x,{ref_key:"configFormRef",ref:G,model:W,rules:$,"label-width":"120px"},{default:A(()=>[S(k,{label:"配置名称",prop:"name"},{default:A(()=>[S(ve,{modelValue:W.name,"onUpdate:modelValue":a[5]||(a[5]=e=>W.name=e),placeholder:"请输入配置名称"},null,8,["modelValue"])]),_:1}),S(k,{label:"通知方式",prop:"notificationMethod"},{default:A(()=>[S(w,{modelValue:W.notificationMethod,"onUpdate:modelValue":a[6]||(a[6]=e=>W.notificationMethod=e),placeholder:"选择通知方式",style:{width:"100%"}},{default:A(()=>[(z(!0),I(F,null,E(l.value,e=>(z(),N(_,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"支持部门",prop:"departmentIds"},{default:A(()=>[S(w,{modelValue:W.departmentIds,"onUpdate:modelValue":a[7]||(a[7]=e=>W.departmentIds=e),multiple:"",placeholder:"选择支持的部门",style:{width:"100%"}},{default:A(()=>[(z(!0),I(F,null,E(o.value,e=>(z(),N(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),"system_message"!==W.notificationMethod?(z(),N(k,{key:0,label:"通知成员",prop:"memberIds"},{default:A(()=>[U("div",sa,[S(n,{type:"primary",onClick:ce},{default:A(()=>[T(" 选择成员 (已选 "+L(W.memberIds.length)+" 人) ",1)]),_:1}),Z.value.length>0?(z(),I("div",ia,[(z(!0),I(F,null,E(Z.value.slice(0,5),e=>(z(),N(se,{key:e.id,closable:"",onClose:a=>(e=>{const a=W.memberIds.indexOf(e);a>-1&&W.memberIds.splice(a,1)})(e.id),style:{"margin-right":"8px","margin-top":"8px"}},{default:A(()=>[T(L(e.name)+" ("+L(e.departmentName)+") ",1)]),_:2},1032,["onClose"]))),128)),Z.value.length>5?(z(),N(se,{key:0,type:"info",style:{"margin-top":"8px"}},{default:A(()=>[T(" +"+L(Z.value.length-5)+" 人 ",1)]),_:1})):q("",!0)])):q("",!0)])]),_:1})):q("",!0),"system_message"===W.notificationMethod?(z(),N(k,{key:1,label:"通知范围"},{default:A(()=>[S(ge,{title:"系统消息支持全员通知",type:"info",closable:!1,"show-icon":""})]),_:1})):q("",!0),S(k,{label:"配置参数"},{default:A(()=>[U("div",da,["dingtalk"===W.notificationMethod?(z(),I(F,{key:0},[S(k,{label:"Webhook地址"},{default:A(()=>[S(ve,{modelValue:W.params.webhook,"onUpdate:modelValue":a[8]||(a[8]=e=>W.params.webhook=e),placeholder:"请输入钉钉机器人Webhook地址"},null,8,["modelValue"])]),_:1}),S(k,{label:"签名密钥"},{default:A(()=>[S(ve,{modelValue:W.params.secret,"onUpdate:modelValue":a[9]||(a[9]=e=>W.params.secret=e),placeholder:"请输入签名密钥"},null,8,["modelValue"])]),_:1}),S(k,{label:"@所有人"},{default:A(()=>[S(j,{modelValue:W.params.atAll,"onUpdate:modelValue":a[10]||(a[10]=e=>W.params.atAll=e)},null,8,["modelValue"])]),_:1})],64)):q("",!0),"wechat_work"===W.notificationMethod?(z(),I(F,{key:1},[S(k,{label:"Webhook地址",required:""},{default:A(()=>[S(ve,{modelValue:W.params.webhook,"onUpdate:modelValue":a[11]||(a[11]=e=>W.params.webhook=e),placeholder:"请输入企业微信群机器人Webhook地址",style:{width:"100%"}},null,8,["modelValue"]),a[48]||(a[48]=U("div",{class:"form-tip"}," 企业微信群机器人Webhook地址，格式：https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxxxxx ",-1))]),_:1}),S(k,{label:"群名称"},{default:A(()=>[S(ve,{modelValue:W.params.groupName,"onUpdate:modelValue":a[12]||(a[12]=e=>W.params.groupName=e),placeholder:"请输入群名称（可选）",style:{width:"100%"}},null,8,["modelValue"]),a[49]||(a[49]=U("div",{class:"form-tip"},"用于标识该机器人所在的群，便于管理",-1))]),_:1}),S(k,{label:"@所有人"},{default:A(()=>[S(j,{modelValue:W.params.mentionAll,"onUpdate:modelValue":a[13]||(a[13]=e=>W.params.mentionAll=e)},null,8,["modelValue"]),a[50]||(a[50]=U("div",{class:"form-tip"},"开启后，消息将@所有人",-1))]),_:1}),S(k,{label:"@指定成员"},{default:A(()=>[S(ve,{modelValue:W.params.mentionedList,"onUpdate:modelValue":a[14]||(a[14]=e=>W.params.mentionedList=e),placeholder:"请输入要@的成员手机号，多个用逗号分隔",style:{width:"100%"}},null,8,["modelValue"]),a[51]||(a[51]=U("div",{class:"form-tip"},"指定要@的成员手机号，多个用逗号分隔，如：13800138000,13800138001",-1))]),_:1})],64)):q("",!0),"email"===W.notificationMethod?(z(),I(F,{key:2},[S(k,{label:"SMTP服务器"},{default:A(()=>[S(ve,{modelValue:W.params.smtpHost,"onUpdate:modelValue":a[15]||(a[15]=e=>W.params.smtpHost=e),placeholder:"请输入SMTP服务器地址"},null,8,["modelValue"])]),_:1}),S(k,{label:"SMTP端口"},{default:A(()=>[S(ve,{modelValue:W.params.smtpPort,"onUpdate:modelValue":a[16]||(a[16]=e=>W.params.smtpPort=e),placeholder:"请输入SMTP端口"},null,8,["modelValue"])]),_:1}),S(k,{label:"发件人邮箱"},{default:A(()=>[S(ve,{modelValue:W.params.fromEmail,"onUpdate:modelValue":a[17]||(a[17]=e=>W.params.fromEmail=e),placeholder:"请输入发件人邮箱"},null,8,["modelValue"])]),_:1})],64)):q("",!0),"sms"===W.notificationMethod?(z(),I(F,{key:3},[S(k,{label:"短信平台"},{default:A(()=>[S(w,{modelValue:W.params.smsProvider,"onUpdate:modelValue":a[18]||(a[18]=e=>W.params.smsProvider=e),placeholder:"选择短信平台"},{default:A(()=>[S(_,{label:"阿里云",value:"aliyun"}),S(_,{label:"腾讯云",value:"tencent"}),S(_,{label:"华为云",value:"huawei"})]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"AccessKey"},{default:A(()=>[S(ve,{modelValue:W.params.accessKey,"onUpdate:modelValue":a[19]||(a[19]=e=>W.params.accessKey=e),placeholder:"请输入AccessKey"},null,8,["modelValue"])]),_:1}),S(k,{label:"SecretKey"},{default:A(()=>[S(ve,{modelValue:W.params.secretKey,"onUpdate:modelValue":a[20]||(a[20]=e=>W.params.secretKey=e),type:"password",placeholder:"请输入SecretKey"},null,8,["modelValue"])]),_:1})],64)):q("",!0)])]),_:1}),S(k,{label:"描述"},{default:A(()=>[S(ve,{modelValue:W.description,"onUpdate:modelValue":a[21]||(a[21]=e=>W.description=e),type:"textarea",rows:3,placeholder:"请输入配置描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),S(he,{modelValue:b.value,"onUpdate:modelValue":a[27]||(a[27]=e=>b.value=e),title:"选择通知成员",width:"800px","close-on-click-modal":!1},{footer:A(()=>[S(n,{onClick:a[26]||(a[26]=e=>b.value=!1)},{default:A(()=>[...a[54]||(a[54]=[T("取消",-1)])]),_:1}),S(n,{type:"primary",onClick:ne},{default:A(()=>[T(" 确定 (已选 "+L(J.value.length)+" 人) ",1)]),_:1})]),default:A(()=>[U("div",oa,[U("div",na,[S(x,{inline:""},{default:A(()=>[S(k,{label:"部门"},{default:A(()=>[S(w,{modelValue:Y.departmentId,"onUpdate:modelValue":a[24]||(a[24]=e=>Y.departmentId=e),placeholder:"选择部门",clearable:""},{default:A(()=>[S(_,{label:"全部部门",value:""}),(z(!0),I(F,null,E(X.value,e=>(z(),N(_,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),S(k,{label:"姓名"},{default:A(()=>[S(ve,{modelValue:Y.name,"onUpdate:modelValue":a[25]||(a[25]=e=>Y.name=e),placeholder:"输入姓名搜索",clearable:""},null,8,["modelValue"])]),_:1}),S(k,null,{default:A(()=>[S(n,{type:"primary",onClick:de},{default:A(()=>[...a[53]||(a[53]=[T("搜索",-1)])]),_:1})]),_:1})]),_:1})]),S(ye,{ref_key:"memberTableRef",ref:K,data:R.value,style:{width:"100%"},onSelectionChange:oe,"max-height":"400"},{default:A(()=>[S(be,{type:"selection",width:"55"}),S(be,{prop:"name",label:"姓名",width:"120"}),S(be,{prop:"departmentName",label:"部门",width:"120"}),S(be,{prop:"position",label:"职位",width:"120"}),S(be,{prop:"email",label:"邮箱"}),S(be,{prop:"phone",label:"手机号",width:"120"})]),_:1},8,["data"])])]),_:1},8,["modelValue"]),S(he,{modelValue:y.value,"onUpdate:modelValue":a[29]||(a[29]=e=>y.value=e),title:"查看通知配置",width:"600px"},{footer:A(()=>[S(n,{onClick:a[28]||(a[28]=e=>y.value=!1)},{default:A(()=>[...a[55]||(a[55]=[T("关闭",-1)])]),_:1})]),default:A(()=>[H.value?(z(),I("div",ra,[S(we,{column:2,border:""},{default:A(()=>[S(_e,{label:"配置名称"},{default:A(()=>[T(L(H.value.name),1)]),_:1}),S(_e,{label:"通知方式"},{default:A(()=>{return[S(se,{type:(e=H.value.notificationMethod,{dingtalk:"primary",wechat_work:"success",email:"warning",sms:"danger",system_message:"info"}[e]||"default")},{default:A(()=>[T(L(ee(H.value.notificationMethod)),1)]),_:1},8,["type"])];var e}),_:1}),S(_e,{label:"状态"},{default:A(()=>[S(se,{type:H.value.enabled?"success":"danger"},{default:A(()=>[T(L(H.value.enabled?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),S(_e,{label:"支持部门"},{default:A(()=>[U("div",ua,[(z(!0),I(F,null,E(H.value.departments,e=>(z(),N(se,{key:e.id,size:"small",style:{"margin-right":"4px","margin-bottom":"4px"}},{default:A(()=>[T(L(e.name),1)]),_:2},1024))),128))])]),_:1}),S(_e,{label:"通知成员",span:2},{default:A(()=>["system_message"===H.value.notificationMethod?(z(),I("div",ca," 全员通知 ")):(z(),I("div",ma,[(z(!0),I(F,null,E(H.value.members,e=>(z(),N(se,{key:e.id,size:"small",style:{"margin-right":"4px","margin-bottom":"4px"}},{default:A(()=>[T(L(e.name)+" ("+L(e.departmentName)+") ",1)]),_:2},1024))),128))]))]),_:1}),S(_e,{label:"创建人"},{default:A(()=>[T(L(H.value.createdBy),1)]),_:1}),S(_e,{label:"创建时间"},{default:A(()=>[T(L(H.value.createdAt),1)]),_:1}),S(_e,{label:"描述",span:2},{default:A(()=>[T(L(H.value.description||"无"),1)]),_:1})]),_:1})])):q("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-be3f1db2"]]),fa={class:"message-management"},va={class:"stats-section"},ga={class:"stats-content"},ha={class:"stats-icon subscription"},ba={class:"stats-info"},ya={class:"stats-number"},_a={class:"stats-content"},wa={class:"stats-icon announcement"},ka={class:"stats-info"},Va={class:"stats-number"},xa={class:"stats-content"},Ma={class:"stats-icon message"},Ca={class:"stats-info"},Ia={class:"stats-number"},za={class:"stats-content"},Ua={class:"stats-icon config"},Sa={class:"stats-info"},Aa={class:"stats-number"},Ta={class:"tabs-section"},Da={class:"tab-label"},Fa={class:"tab-label"},Ea={class:"tab-label"},Na=a(y({__name:"MessageManagement",setup(e){const a=_("subscription"),t=l(),s=_({totalSubscriptions:0,activeSubscriptions:0,totalAnnouncements:0,publishedAnnouncements:0,unreadMessages:0,totalMessages:0,configuredChannels:0,totalChannels:0});return x(()=>{(async()=>{try{const e=await t.messageApi.getMessageStats();e.data&&(s.value=e.data)}catch(e){console.error("加载统计数据失败:",e)}})()}),(e,l)=>{const t=M("el-icon"),i=M("el-card"),d=M("el-col"),o=M("el-row"),n=M("el-tab-pane"),u=M("el-tabs");return z(),I("div",fa,[l[8]||(l[8]=U("div",{class:"page-header"},[U("h2",null,"消息管理"),U("p",null,"管理系统消息订阅、公告发布和通知配置")],-1)),U("div",va,[S(o,{gutter:20},{default:A(()=>[S(d,{span:6},{default:A(()=>[S(i,{class:"stats-card"},{default:A(()=>[U("div",ga,[U("div",ha,[S(t,null,{default:A(()=>[S(D(h))]),_:1})]),U("div",ba,[U("div",ya,L(s.value.activeSubscriptions)+"/"+L(s.value.totalSubscriptions),1),l[1]||(l[1]=U("div",{class:"stats-label"},"消息订阅",-1))])])]),_:1})]),_:1}),S(d,{span:6},{default:A(()=>[S(i,{class:"stats-card"},{default:A(()=>[U("div",_a,[U("div",wa,[S(t,null,{default:A(()=>[S(D(r))]),_:1})]),U("div",ka,[U("div",Va,L(s.value.publishedAnnouncements)+"/"+L(s.value.totalAnnouncements),1),l[2]||(l[2]=U("div",{class:"stats-label"},"系统公告",-1))])])]),_:1})]),_:1}),S(d,{span:6},{default:A(()=>[S(i,{class:"stats-card"},{default:A(()=>[U("div",xa,[U("div",Ma,[S(t,null,{default:A(()=>[S(D(b))]),_:1})]),U("div",Ca,[U("div",Ia,L(s.value.unreadMessages)+"/"+L(s.value.totalMessages),1),l[3]||(l[3]=U("div",{class:"stats-label"},"未读消息",-1))])])]),_:1})]),_:1}),S(d,{span:6},{default:A(()=>[S(i,{class:"stats-card"},{default:A(()=>[U("div",za,[U("div",Ua,[S(t,null,{default:A(()=>[S(D(p))]),_:1})]),U("div",Sa,[U("div",Aa,L(s.value.configuredChannels)+"/"+L(s.value.totalChannels),1),l[4]||(l[4]=U("div",{class:"stats-label"},"通知渠道",-1))])])]),_:1})]),_:1})]),_:1})]),U("div",Ta,[S(u,{modelValue:a.value,"onUpdate:modelValue":l[0]||(l[0]=e=>a.value=e),class:"message-tabs"},{default:A(()=>[S(n,{name:"subscription"},{label:A(()=>[U("div",Da,[S(t,{class:"tab-icon"},{default:A(()=>[S(D(h))]),_:1}),l[5]||(l[5]=U("span",null,"消息订阅",-1))])]),default:A(()=>[S(ve)]),_:1}),S(n,{name:"announcement"},{label:A(()=>[U("div",Fa,[S(t,{class:"tab-icon"},{default:A(()=>[S(D(r))]),_:1}),l[6]||(l[6]=U("span",null,"公告发布",-1))])]),default:A(()=>[S(Ce)]),_:1}),S(n,{name:"config"},{label:A(()=>[U("div",Ea,[S(t,{class:"tab-icon"},{default:A(()=>[S(D(p))]),_:1}),l[7]||(l[7]=U("span",null,"通知配置",-1))])]),default:A(()=>[S(pa)]),_:1})]),_:1},8,["modelValue"])])])}}}),[["__scopeId","data-v-25acd00d"]]);export{Na as default};
