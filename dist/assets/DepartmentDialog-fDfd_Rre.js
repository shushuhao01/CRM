const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/userApiService-CEBmH0Pk.js","assets/index-DkAJPKqn.js","assets/vendor-BtukhyiH.js","assets/elementPlus-DxaqjplL.js","assets/utils-DfI7e5Rl.js","assets/index-Cj-RrGL6.css"])))=>i.map(i=>d[i]);
import{z as e,l as a,u as t,_ as r}from"./index-DkAJPKqn.js";import{au as s,K as l,H as i,j as n,E as o,B as d,D as c,a5 as m,s as p}from"./elementPlus-DxaqjplL.js";import{useDepartmentStore as u}from"./department-DPqzaatc.js";import v from"./departmentPermissionService-BriqDnjF.js";import{l as f,r as g,e as h,Z as w,w as b,ag as y,M as _,q as I,O as V,p as E,U as k,u as x,m as P,F as S,a9 as O,S as D,T as j,n as A}from"./vendor-BtukhyiH.js";const U={class:"dialog-content"},T={class:"form-section"},F={class:"section-header"},q={class:"form-grid"},$={class:"form-tip"},B={class:"form-section"},C={class:"dialog-footer"},H=r(f({__name:"DepartmentDialog",props:{modelValue:{type:Boolean},department:{default:null},isEdit:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup(r,{emit:f}){const H=r,K=f,L=u(),R=g(),Z=g(!1),z=h(()=>e.getAllPermissions()),M=h(()=>{const e=(a,t="")=>{const r=[];return a.forEach(a=>{if("action"===a.type&&r.push({id:a.id,code:a.code,name:a.name,parentPath:t,level:G(a.code)}),a.children&&a.children.length>0){const s=t?`${t} > ${a.name}`:a.name;r.push(...e(a.children,s))}}),r};return e(z.value)});h(()=>{const e=[];return z.value.forEach(a=>{const t=[],r=e=>{e.forEach(e=>{"action"===e.type&&t.push({id:e.id,code:e.code,name:e.name,level:G(e.code)}),e.children&&r(e.children)})};a.children&&r(a.children),e.push({id:a.id,name:a.name,icon:a.icon||"Setting",permissions:t})}),e});const N=[{key:"basic",name:"基础权限",description:"适合普通员工的基础操作权限",icon:d,count:8,permissions:["customer.list.view","customer.follow","order.list.view","order.create","product.list","service.ticket.view","service.ticket.create","service.chat.view","service.chat.reply","service.knowledge.view","data.list.view","data.search.basic","performance.personal.view"]},{key:"advanced",name:"高级权限",description:"适合主管级别的进阶操作权限",icon:c,count:15,permissions:["customer.list.view","customer.list.export","customer.add.create","customer.edit","customer.follow","order.list.view","order.create","order.edit","order.status","product.list","product.add","product.edit","product.category","service.ticket.view","service.ticket.create","service.ticket.edit","service.ticket.assign","service.chat.view","service.chat.reply","service.chat.transfer","service.chat.history","service.knowledge.view","service.knowledge.create","service.knowledge.edit","data.list.view","data.search.basic","data.search.advanced","performance.personal.view","performance.team.view"]},{key:"manager",name:"管理员权限",description:"拥有所有操作权限，适合管理员",icon:m,count:25,permissions:[]},{key:"custom",name:"自定义权限",description:"根据需要自由选择权限组合",icon:p,count:0,permissions:[]}],G=e=>{const a={basic:{text:"基础",type:"info",color:"#0ea5e9"},advanced:{text:"高级",type:"warning",color:"#f59e0b"},admin:{text:"管理员",type:"danger",color:"#ef4444"}};return a[e]||a.basic},J=w({name:"",code:"",level:1,parentId:null,managerId:null,sortOrder:1,status:"active",permissions:[],description:"",inheritFromParent:!1,dataScope:"department",managerExtraPermissions:[]});b(()=>J.parentId,e=>{if(e){const a=L.getDepartmentById(e);a&&(J.level=(a.level||1)+1,console.log(`[DepartmentDialog] 父部门层级: ${a.level}, 当前部门层级: ${J.level}`))}else J.level=1});const Q=g(!1),W=g("");h(()=>M.value.length);const X={name:[{required:!0,message:"请输入部门名称",trigger:"blur"},{min:2,max:50,message:"部门名称长度在 2 到 50 个字符",trigger:"blur"}],code:[{required:!0,message:"请输入部门编码",trigger:"blur"},{min:2,max:20,message:"部门编码长度在 2 到 20 个字符",trigger:"blur"},{pattern:/^[A-Z0-9_]+$/,message:"部门编码只能包含大写字母、数字和下划线，例如：TECH_DEPT",trigger:"blur"}],sortOrder:[{required:!0,message:"请输入排序号",trigger:"blur"}],status:[{required:!0,message:"请选择部门状态",trigger:"change"}]},Y={value:"id",label:"name",children:"children"},ee=h(()=>{const e=a=>a.filter(e=>!H.isEdit||!H.department||e.id!==H.department.id&&!ae(e.id,H.department.id)).map(a=>({...a,children:a.children?e(a.children):[]}));return e(L.departmentTree)}),ae=(e,a)=>{const t=(e,a)=>{for(const r of e){if(r.id===a)return r;if(r.children){const e=t(r.children,a);if(e)return e}}return null},r=t(L.departmentTree,e);if(!r)return!1;let s=r;for(;s.parentId;){if(s.parentId===a)return!0;if(s=t(L.departmentTree,s.parentId)||s,!s.parentId)break}return!1},te=g([]),re=()=>{Object.assign(J,{name:"",code:"",level:1,parentId:null,managerId:null,sortOrder:1,status:"active",permissions:[],description:""}),W.value="",Q.value=!1,A(()=>{R.value?.clearValidate()})},se=()=>{const e=J.permissions;for(const a of N)if("custom"!==a.key)if("manager"===a.key){if(M.value.map(e=>e.code).every(a=>e.includes(a)))return"manager"}else if(a.permissions.length===e.length&&a.permissions.every(a=>e.includes(a)))return a.key;return e.length>0?"custom":""},le=async()=>{if(H.isEdit&&H.department){Object.assign(J,{name:H.department.name,code:H.department.code,level:H.department.level,parentId:H.department.parentId,managerId:H.department.managerId||null,sortOrder:H.department.sortOrder||1,status:H.department.status,permissions:[],description:H.department.description||""});try{const e=v.getDepartmentPermissions(H.department.id);J.inheritFromParent=e.inheritFromParent,J.dataScope=e.dataScope,J.managerExtraPermissions=[...e.managerExtraPermissions]}catch(e){console.warn("加载部门权限配置失败:",e),J.inheritFromParent=!1,J.dataScope="department",J.managerExtraPermissions=[]}A(()=>{W.value=se()})}else re(),W.value=""};b(()=>H.modelValue,e=>{e&&(le(),(async()=>{try{const{userApiService:e}=await a(async()=>{const{userApiService:e}=await import("./userApiService-CEBmH0Pk.js");return{userApiService:e}},__vite__mapDeps([0,1,2,3,4,5])),t=await e.getUsers({status:"active"});te.value=t.data.map(e=>({id:e.id.toString(),name:e.realName||e.username,role:e.role,department:e.department?.name}))}catch(e){console.error("加载用户列表失败:",e);const a=t();await a.loadUsers(),te.value=a.users.map(e=>({id:e.id,name:e.name,role:e.role,department:e.department}))}})())}),b(()=>H.department,()=>{H.modelValue&&le()}),b(()=>J.permissions,()=>{if(0===J.permissions.length)W.value="";else{const e=se();e!==W.value&&(W.value=e)}},{deep:!0});const ie=()=>{K("update:modelValue",!1),re()},ne=async()=>{if(R.value)try{if(!(await R.value.validate()))return;let a;if(Z.value=!0,H.isEdit&&H.department)await L.updateDepartment(H.department.id,{name:J.name,code:J.code,level:J.level,parentId:J.parentId,managerId:J.managerId,sortOrder:J.sortOrder,status:J.status,description:J.description}),a=H.department.id;else{a=(await L.addDepartment({name:J.name,code:J.code,level:J.level,parentId:J.parentId,managerId:J.managerId,sortOrder:J.sortOrder,status:J.status,description:J.description})).id}try{await v.setDepartmentPermissions(a,{permissions:J.permissions,inheritFromParent:J.inheritFromParent,dataScope:J.dataScope,managerExtraPermissions:J.managerExtraPermissions})}catch(e){console.warn("权限保存失败，但部门创建成功:",e)}o.success(H.isEdit?"部门更新成功":"部门创建成功"),K("success")}catch(a){console.error("部门操作失败:",a);let e="操作失败";a instanceof Error?e=a.message:"object"==typeof a&&null!==a&&(e="code"in a&&Array.isArray(a.code)?"表单验证失败，请检查输入内容":"message"in a?String(a.message):"操作失败，请重试"),o.error(e)}finally{Z.value=!1}};return(e,a)=>{const t=y("el-icon"),o=y("el-input"),d=y("el-form-item"),c=y("el-tree-select"),m=y("el-option"),p=y("el-select"),u=y("el-input-number"),v=y("el-radio"),f=y("el-radio-group"),g=y("el-form"),h=y("el-button"),w=y("el-dialog");return I(),_(w,{"model-value":r.modelValue,title:r.isEdit?"编辑部门":"新建部门",width:"900px","before-close":ie,class:"department-dialog","align-center":"","destroy-on-close":""},{footer:V(()=>[E("div",C,[k(h,{onClick:ie,class:"cancel-btn"},{default:V(()=>[...a[11]||(a[11]=[D(" 取消 ",-1)])]),_:1}),k(h,{type:"primary",onClick:ne,loading:Z.value,class:"submit-btn"},{default:V(()=>[D(j(r.isEdit?"保存":"创建"),1)]),_:1},8,["loading"])])]),default:V(()=>[E("div",U,[k(g,{ref_key:"formRef",ref:R,model:J,rules:X,"label-width":"100px",class:"department-form","label-position":"left"},{default:V(()=>[E("div",T,[E("div",F,[k(t,{class:"section-icon"},{default:V(()=>[k(x(s))]),_:1}),a[7]||(a[7]=E("span",{class:"section-title"},"基本信息",-1))]),E("div",q,[k(d,{label:"部门名称",prop:"name",class:"form-item"},{default:V(()=>[k(o,{modelValue:J.name,"onUpdate:modelValue":a[0]||(a[0]=e=>J.name=e),placeholder:"请输入部门名称",maxlength:"50","show-word-limit":"",class:"compact-input"},null,8,["modelValue"])]),_:1}),k(d,{label:"部门编码",prop:"code",class:"form-item"},{default:V(()=>[k(o,{modelValue:J.code,"onUpdate:modelValue":a[1]||(a[1]=e=>J.code=e),placeholder:"例如：TECH_DEPT、SALES_01",maxlength:"20","show-word-limit":"",class:"compact-input"},null,8,["modelValue"]),E("div",$,[k(t,null,{default:V(()=>[k(x(l))]),_:1}),a[8]||(a[8]=E("span",null,"只能包含大写字母、数字和下划线",-1))])]),_:1}),k(d,{label:"上级部门",prop:"parentId",class:"form-item"},{default:V(()=>[k(c,{modelValue:J.parentId,"onUpdate:modelValue":a[2]||(a[2]=e=>J.parentId=e),data:ee.value,props:Y,placeholder:"请选择上级部门（可选）",clearable:"","check-strictly":"","render-after-expand":!1,class:"compact-select"},null,8,["modelValue","data"])]),_:1}),k(d,{label:"部门负责人",prop:"managerId",class:"form-item"},{default:V(()=>[k(p,{modelValue:J.managerId,"onUpdate:modelValue":a[3]||(a[3]=e=>J.managerId=e),placeholder:"请选择部门负责人（可选）",clearable:"",filterable:"",class:"compact-select"},{default:V(()=>[(I(!0),P(S,null,O(te.value,e=>(I(),_(m,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),k(d,{label:"排序",prop:"sortOrder",class:"form-item"},{default:V(()=>[k(u,{modelValue:J.sortOrder,"onUpdate:modelValue":a[4]||(a[4]=e=>J.sortOrder=e),min:1,max:999,placeholder:"排序号",class:"compact-number","controls-position":"right"},null,8,["modelValue"])]),_:1}),k(d,{label:"状态",prop:"status",class:"form-item"},{default:V(()=>[k(f,{modelValue:J.status,"onUpdate:modelValue":a[5]||(a[5]=e=>J.status=e),class:"compact-radio"},{default:V(()=>[k(v,{label:"active"},{default:V(()=>[k(t,null,{default:V(()=>[k(x(i))]),_:1}),a[9]||(a[9]=D(" 启用 ",-1))]),_:1}),k(v,{label:"inactive"},{default:V(()=>[k(t,null,{default:V(()=>[k(x(n))]),_:1}),a[10]||(a[10]=D(" 停用 ",-1))]),_:1})]),_:1},8,["modelValue"])]),_:1})])]),E("div",B,[k(d,{label:"部门描述",prop:"description",class:"description-item"},{default:V(()=>[k(o,{modelValue:J.description,"onUpdate:modelValue":a[6]||(a[6]=e=>J.description=e),type:"textarea",rows:2,placeholder:"请输入部门描述（可选）",maxlength:"200","show-word-limit":"",class:"compact-textarea"},null,8,["modelValue"])]),_:1})])]),_:1},8,["model"])])]),_:1},8,["model-value","title"])}}}),[["__scopeId","data-v-8dd67547"]]);export{H as D};
