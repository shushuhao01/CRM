import{u as o,i as t,d as e,b as n}from"./index-DkAJPKqn.js";import{u as r}from"./product-BDuYhoXd.js";import"./vendor-BtukhyiH.js";import"./elementPlus-DxaqjplL.js";import"./utils-DfI7e5Rl.js";import"./env-DLalhsF6.js";let a=!1,s=null;const c=async()=>(a&&s||(a=!0,console.log("[AppInit] 开始预加载应用数据..."),s=(async()=>{try{const t=o();if(!t.isLoggedIn||!t.token)return void console.log("[AppInit] 用户未登录，跳过预加载");(()=>{try{const o="crm_store_order",t=localStorage.getItem(o);if(t){const e=t.length;e>1048576&&(console.log(`[AppInit] 清理过大的订单缓存数据 (${(e/1024/1024).toFixed(2)}MB)`),localStorage.removeItem(o))}let e=0;for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o){const t=localStorage.getItem(o);t&&(e+=t.length)}}e>4194304&&(console.log(`[AppInit] localStorage使用过高 (${(e/1024/1024).toFixed(2)}MB)，清理订单缓存`),localStorage.removeItem("crm_store_order"),localStorage.removeItem("crm_store_orders"))}catch(o){console.warn("[AppInit] 清理存储数据失败:",o)}})();const e=[l(),i(),p(),f()];(await Promise.allSettled(e)).forEach((o,t)=>{const e=["客户数据","订单数据","产品数据","通知数据"];"fulfilled"===o.status?console.log(`[AppInit] ✅ ${e[t]} 加载成功`):console.warn(`[AppInit] ⚠️ ${e[t]} 加载失败:`,o.reason)}),console.log("[AppInit] 应用数据预加载完成")}catch(t){console.error("[AppInit] 预加载失败:",t)}finally{a=!1,s=null}})()),s),l=async()=>{try{const o=t();await o.loadCustomers()}catch(o){console.warn("[AppInit] 加载客户数据失败:",o)}},i=async()=>{try{const o=e();"function"==typeof o.loadTransferDelayConfig&&await o.loadTransferDelayConfig(),"function"==typeof o.loadOrdersFromAPI&&await o.loadOrdersFromAPI(),"function"==typeof o.startAutoTransferTask&&(o.startAutoTransferTask(),console.log("[AppInit] 订单自动流转定时任务已启动")),"function"==typeof o.checkAndTransferOrders&&o.checkAndTransferOrders()}catch(o){console.warn("[AppInit] 加载订单数据失败:",o)}},p=async()=>{try{const o=r();"function"==typeof o.initData&&await o.initData()}catch(o){console.warn("[AppInit] 加载产品数据失败:",o)}},f=async()=>{try{const o=n();"function"==typeof o.loadMessagesFromAPI&&await o.loadMessagesFromAPI()}catch(o){console.warn("[AppInit] 加载通知数据失败:",o)}};export{c as preloadAppData};
