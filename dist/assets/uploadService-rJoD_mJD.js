const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/aliyun-oss-sdk-DCJ43jeS.js","assets/elementPlus-DxaqjplL.js","assets/vendor-BtukhyiH.js"])))=>i.map(i=>d[i]);
import{l as e}from"./index-BGtT17ll.js";import{a}from"./utils-DfI7e5Rl.js";import{E as s}from"./elementPlus-DxaqjplL.js";import"./vendor-BtukhyiH.js";const t={maxFileSize:10,allowedTypes:"jpg,png,gif,webp,jpeg"},o={storageType:"local",localPath:"./uploads",localDomain:"",accessKey:"",secretKey:"",bucketName:"",region:"oss-cn-hangzhou",customDomain:"",maxFileSize:10,allowedTypes:"jpg,png,gif,webp,jpeg",imageCompressEnabled:!0,imageCompressQuality:"medium",imageCompressMaxWidth:1200,imageCompressCustomQuality:60};let r={...t},c={...o},i=0,n=0;const l=3e5,m=async()=>{const e=Date.now();if(i>0&&e-i<l)return r;try{const s=localStorage.getItem("auth_token"),t=await a.get("/api/v1/system/upload-config",{headers:{Authorization:`Bearer ${s}`}});if(t.data?.success&&t.data?.data)return r=t.data.data,i=e,r}catch(s){console.warn("获取上传配置失败，使用默认配置:",s)}return t},d=async()=>{const e=Date.now();if(n>0&&e-n<l)return c;try{const s=localStorage.getItem("auth_token"),t=await a.get("/api/v1/system/storage-settings",{headers:{Authorization:`Bearer ${s}`}});if(t.data?.success&&t.data?.data)return c={...o,...t.data.data},n=e,console.log("[UploadService] 存储配置已更新:",c.storageType),c}catch(s){console.warn("获取存储配置失败，使用默认配置:",s)}return o},u=()=>{n=0,i=0,console.log("[UploadService] 存储配置缓存已清除")},g=async(e,s)=>{const t={system:"/api/v1/system/upload-image",product:"/api/v1/system/upload-product-image",avatar:"/api/v1/system/upload-avatar",order:"/api/v1/system/upload-order-image",service:"/api/v1/system/upload-service-image"}[s];try{const s=new FormData;s.append("image",e);const o=localStorage.getItem("auth_token"),r=await a.post(t,s,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${o}`}});return r.data?.success&&r.data?.data?.url?{success:!0,url:r.data.data.url,filename:r.data.data.filename,size:r.data.data.size}:{success:!1,message:r.data?.message||"上传失败"}}catch(o){const e=o;return console.error("本地上传失败:",o),{success:!1,message:e.response?.data?.message||e.message||"上传失败，请重试"}}},p=async(a,s,t=!0)=>{const[o,r]=await Promise.all([m(),d()]);if(!a.type.startsWith("image/"))return{success:!1,message:"只能上传图片文件"};let c=a;const i=!1!==r.imageCompressEnabled;if(t&&i&&a.size>51200)try{let e=1200,s=.6;switch(r.imageCompressQuality){case"high":e=1920,s=.8;break;case"medium":e=1200,s=.6;break;case"low":e=800,s=.4;break;case"custom":e=r.imageCompressMaxWidth||1200,s=(r.imageCompressCustomQuality||60)/100}c=await(async(e,a=800,s=.6)=>new Promise((t,o)=>{if("image/gif"===e.type)return void t(e);const r=new Image,c=document.createElement("canvas"),i=c.getContext("2d");r.onload=()=>{let{width:o,height:n}=r;const l=o,m=n;o>a&&(n=Math.round(n*a/o),o=a),n>800&&(o=Math.round(800*o/n),n=800),c.width=o,c.height=n,i?.drawImage(r,0,0,o,n),c.toBlob(a=>{if(a)if(a.size<e.size){const s=new File([a],e.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()});console.log(`[UploadService] 图片压缩成功: ${(e.size/1024).toFixed(1)}KB -> ${(s.size/1024).toFixed(1)}KB (${l}x${m} -> ${o}x${n})`),t(s)}else c.toBlob(a=>{if(a&&a.size<e.size){const s=new File([a],e.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg",lastModified:Date.now()});console.log(`[UploadService] 图片二次压缩: ${(e.size/1024).toFixed(1)}KB -> ${(s.size/1024).toFixed(1)}KB`),t(s)}else console.log(`[UploadService] 压缩后更大，使用原文件: ${(e.size/1024).toFixed(1)}KB`),t(e)},"image/jpeg",.4);else t(e)},"image/jpeg",s)},r.onerror=()=>{console.warn("[UploadService] 图片加载失败，使用原文件"),t(e)};const n=new FileReader;n.onload=e=>{r.src=e.target?.result},n.onerror=()=>o(new Error("读取文件失败")),n.readAsDataURL(e)}))(a,e,s),console.log(`[UploadService] 图片压缩: ${(a.size/1024).toFixed(1)}KB -> ${(c.size/1024).toFixed(1)}KB`)}catch(l){console.warn("[UploadService] 图片压缩失败，使用原文件:",l)}const n=r.maxFileSize||o.maxFileSize;return c.size/1024/1024>n?{success:!1,message:`文件大小超过限制，最大允许 ${n}MB`}:(console.log("[UploadService] 当前存储类型:",r.storageType),"oss"===r.storageType?r.accessKey&&r.secretKey&&r.bucketName&&r.region?(async(a,s,t)=>{try{const o=new(0,(await e(async()=>{const{default:e}=await import("./aliyun-oss-sdk-DCJ43jeS.js").then(e=>e.a);return{default:e}},__vite__mapDeps([0,1,2]))).default)({region:t.region,accessKeyId:t.accessKey,accessKeySecret:t.secretKey,bucket:t.bucketName,secure:!0}),r=Date.now(),c=`${s}/${r}_${Math.random().toString(36).substring(2,8)}.${a.name.split(".").pop()}`;let i=(await o.put(c,a)).url;return t.customDomain&&(i=`${t.customDomain.replace(/\/$/,"")}/${c}`),console.log("[UploadService] OSS上传成功:",i),{success:!0,url:i,filename:c,size:a.size}}catch(l){const a=l;console.error("OSS上传失败:",l);let s="上传失败，请重试";return"InvalidAccessKeyId"===a.code?s="OSS Access Key无效，请检查配置":"SignatureDoesNotMatch"===a.code?s="OSS Secret Key错误，请检查配置":"NoSuchBucket"===a.code?s="OSS Bucket不存在，请检查配置":"AccessDenied"===a.code?s="OSS访问被拒绝，请检查权限配置":a.message&&(s=a.message),{success:!1,message:s}}})(c,s,r):(console.warn("[UploadService] OSS配置不完整，回退到本地上传"),g(c,s)):g(c,s))},y=async(e,a)=>{const t=await p(e,a);return t.success&&t.url?(s.success("图片上传成功"),t.url):(s.error(t.message||"上传失败"),null)};export{u as clearStorageConfigCache,d as getStorageConfig,m as getUploadConfig,p as uploadImage,y as uploadImageWithMessage};
