var Re=Object.defineProperty,ze=Object.defineProperties;var Le=Object.getOwnPropertyDescriptors;var we=Object.getOwnPropertySymbols;var He=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var _e=(n,g,b)=>g in n?Re(n,g,{enumerable:!0,configurable:!0,writable:!0,value:b}):n[g]=b,Ve=(n,g)=>{for(var b in g||(g={}))He.call(g,b)&&_e(n,b,g[b]);if(we)for(var b of we(g))Fe.call(g,b)&&_e(n,b,g[b]);return n},Ae=(n,g)=>ze(n,Le(g));var H=(n,g,b)=>new Promise((D,h)=>{var S=y=>{try{G(b.next(y))}catch(T){h(T)}},q=y=>{try{G(b.throw(y))}catch(T){h(T)}},G=y=>y.done?D(y.value):Promise.resolve(y.value).then(S,q);G((b=b.apply(n,g)).next())});import{aw as Ye,r as k,e as ae,l as Ce,w as fe,c as Ee,ag as _,M as O,p as v,O as a,q as d,U as t,a7 as De,S as E,m as U,F as le,a9 as te,u as K,J as xe,Q as R,T as Y,aC as Ze,az as je,Z as Ke,a8 as Je,P as Qe,V as We,n as Xe}from"./vendor-D8Vxqhr-.js";import{E as A,b as he,a1 as el,i as ll,a2 as tl}from"./elementPlus-Bmwh7Rh8.js";import{_ as ke,u as al,h as sl,t as ol,g as rl,c as nl,v as ge}from"./settings-CuxbDWOu.js";import{c as dl}from"./customerTags-Cm4wsNSA.js";import{u as il}from"./index-BwmIV1hk.js";import{g as ul,a as cl,b as ml,c as pl}from"./addressData-DOzoWqjI.js";import"./utils-ywHRn0uI.js";const Ge=Ye("improvementGoals",()=>{const n=k([{id:"1",label:"减肥瘦身",value:"减肥瘦身",isDefault:!0,order:1,createdAt:new Date,updatedAt:new Date},{id:"2",label:"增肌塑形",value:"增肌塑形",isDefault:!0,order:2,createdAt:new Date,updatedAt:new Date},{id:"3",label:"改善睡眠",value:"改善睡眠",isDefault:!0,order:3,createdAt:new Date,updatedAt:new Date},{id:"4",label:"提高免疫力",value:"提高免疫力",isDefault:!0,order:4,createdAt:new Date,updatedAt:new Date},{id:"5",label:"调理肠胃",value:"调理肠胃",isDefault:!0,order:5,createdAt:new Date,updatedAt:new Date},{id:"6",label:"美容养颜",value:"美容养颜",isDefault:!0,order:6,createdAt:new Date,updatedAt:new Date},{id:"7",label:"其他",value:"其他",isDefault:!0,order:7,createdAt:new Date,updatedAt:new Date}]),g=ae(()=>n.value.sort((o,c)=>o.order-c.order)),b=ae(()=>n.value.filter(o=>!o.isDefault).sort((o,c)=>o.order-c.order)),D=ae(()=>n.value.filter(o=>o.isDefault).sort((o,c)=>o.order-c.order)),h=o=>{const c=n.value.length>0?Math.max(...n.value.map(B=>B.order)):0,x={id:Date.now().toString(),label:o.trim(),value:o.trim(),isDefault:!1,order:c+1,createdAt:new Date,updatedAt:new Date};if(n.value.some(B=>B.value===x.value))throw new Error("该改善问题选项已存在");return n.value.push(x),M(),x},S=o=>{const c=n.value.findIndex(w=>w.id===o);if(c===-1)throw new Error("改善问题选项不存在");const x=n.value[c];return n.value.splice(c,1),M(),x},q=(o,c)=>{const x=n.value.find(e=>e.id===o);if(!x)throw new Error("改善问题选项不存在");const w=c.trim();if(n.value.some(e=>e.id!==o&&e.value===w))throw new Error("该改善问题选项已存在");return x.label=w,x.value=w,x.updatedAt=new Date,M(),x},G=o=>n.value.find(c=>c.id===o),y=o=>{o.forEach((c,x)=>{const w=n.value.find(B=>B.id===c);w&&(w.order=x+1,w.updatedAt=new Date)}),M()},T=()=>{n.value=n.value.filter(o=>o.isDefault)},Z=()=>{try{const o=localStorage.getItem("improvement-goals");if(o){const x=JSON.parse(o).map((w,B)=>Ae(Ve({},w),{order:w.order||B+1,createdAt:new Date(w.createdAt),updatedAt:new Date(w.updatedAt)}));n.value=x}}catch(o){console.error("加载改善问题选项失败:",o)}},M=()=>{try{localStorage.setItem("improvement-goals",JSON.stringify(n.value))}catch(o){console.error("保存改善问题选项失败:",o)}};return{goals:n,allGoals:g,customGoals:b,defaultGoals:D,addGoal:h,removeGoal:S,updateGoal:q,getGoalById:G,reorderGoals:y,resetToDefault:T,loadFromStorage:Z,saveToStorage:M,startAutoSave:()=>{}}}),pe={PHONE:/^1[3-9]\d{9}$/,EMAIL:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,PASSWORD:/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,20}$/,CHINESE_NAME:/^[\u4e00-\u9fa5]{2,10}$/},vl=()=>({required:(n="此项为必填项")=>({required:!0,message:n,trigger:"blur"}),phone:(n="请输入正确的手机号")=>({pattern:pe.PHONE,message:n,trigger:"blur"}),email:(n="请输入正确的邮箱地址")=>({pattern:pe.EMAIL,message:n,trigger:"blur"}),password:(n="密码必须包含字母和数字，长度8-20位")=>({pattern:pe.PASSWORD,message:n,trigger:"blur"}),chineseName:(n="请输入正确的中文姓名")=>({pattern:pe.CHINESE_NAME,message:n,trigger:"blur"}),length:(n,g,b)=>({min:n,max:g,message:b||`长度应在${n}-${g}个字符之间`,trigger:"blur"}),number:(n,g)=>({type:"number",min:n,max:g,message:`请输入${n!==void 0?`${n}到`:""}${g!==void 0?g:""}之间的数字`,trigger:"blur"})}),ee=vl(),gl={class:"manager-content"},fl={class:"add-section"},hl={class:"add-form"},yl={class:"goals-list"},bl={class:"goals-grid"},wl=["onDragstart","onDrop"],_l={class:"goal-content"},Vl={key:0,class:"goal-display"},Al={class:"goal-label"},Dl={key:0,class:"default-tag"},xl={key:1,class:"goal-edit"},Cl={class:"goal-actions"},El={class:"stats-section"},kl={class:"stats"},Gl={class:"dialog-footer"},Sl=Ce({__name:"ImprovementGoalsManager",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(n,{emit:g}){const b=n,D=g,h=Ge(),S=k(b.modelValue),q=k(""),G=k(null),y=k(""),T=k(null),Z=k(null);fe(()=>b.modelValue,p=>{S.value=p}),fe(S,p=>{D("update:modelValue",p)});const M=()=>{S.value=!1,x()},W=()=>{const p=q.value.trim();if(!p){A.warning("请输入改善问题选项");return}try{h.addGoal(p),h.saveToStorage(),q.value="",A.success("添加成功")}catch(i){A.error(i instanceof Error?i.message:"添加失败")}},o=p=>{G.value=p.id,y.value=p.label},c=p=>{const i=y.value.trim();if(!i){A.warning("请输入改善问题选项");return}try{h.updateGoal(p,i),h.saveToStorage(),x(),A.success("编辑成功")}catch(z){A.error(z instanceof Error?z.message:"编辑失败")}},x=()=>{G.value=null,y.value=""},w=p=>{try{h.removeGoal(p),h.saveToStorage(),A.success("删除成功")}catch(i){A.error(i instanceof Error?i.message:"删除失败")}},B=()=>H(this,null,function*(){try{yield he.confirm("确定要重置为默认选项吗？这将删除所有自定义的改善问题选项。","重置确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),h.resetToDefault(),h.saveToStorage(),A.success("重置成功")}catch(p){}}),e=(p,i)=>{T.value=i.id,p.dataTransfer&&(p.dataTransfer.effectAllowed="move",p.dataTransfer.setData("text/plain",i.id))},ce=p=>{p.preventDefault(),p.dataTransfer&&(p.dataTransfer.dropEffect="move")},ne=(p,i)=>{p.preventDefault();const z=T.value;if(!(!z||z===i.id))try{const $=h.allGoals,oe=$.findIndex(J=>J.id===z),X=$.findIndex(J=>J.id===i.id);if(oe===-1||X===-1)return;const j=[...$],[f]=j.splice(oe,1);j.splice(X,0,f);const I=j.map(J=>J.id);h.reorderGoals(I),A.success("排序已更新")}catch($){A.error("排序失败")}},se=()=>{T.value=null,Z.value=null};return Ee(()=>{h.loadFromStorage()}),(p,i)=>{const z=_("el-input"),$=_("el-button"),oe=_("el-popconfirm"),X=_("el-divider"),j=_("el-dialog");return v(),O(j,{modelValue:S.value,"onUpdate:modelValue":i[3]||(i[3]=f=>S.value=f),title:"改善问题管理",width:"600px","before-close":M,class:"improvement-goals-manager"},{footer:a(()=>[d("div",Gl,[t($,{onClick:M},{default:a(()=>[...i[12]||(i[12]=[E("关闭",-1)])]),_:1}),t($,{type:"danger",onClick:B},{default:a(()=>[...i[13]||(i[13]=[E("重置为默认",-1)])]),_:1})])]),default:a(()=>[d("div",gl,[d("div",fl,[i[5]||(i[5]=d("h4",null,"添加新的改善问题选项",-1)),d("div",hl,[t(z,{modelValue:q.value,"onUpdate:modelValue":i[0]||(i[0]=f=>q.value=f),placeholder:"请输入新的改善问题选项",maxlength:"20","show-word-limit":"",onKeyup:De(W,["enter"])},null,8,["modelValue"]),t($,{type:"primary",onClick:W,disabled:!q.value.trim()},{default:a(()=>[...i[4]||(i[4]=[E(" 添加 ",-1)])]),_:1},8,["disabled"])])]),d("div",yl,[i[11]||(i[11]=d("h4",null,[E("现有改善问题选项 "),d("span",{class:"sort-hint"},"（拖拽可调整顺序）")],-1)),d("div",bl,[(v(!0),U(le,null,te(K(h).allGoals,f=>(v(),U("div",{key:f.id,class:xe(["goal-item",{"is-default":f.isDefault,dragging:T.value===f.id}]),draggable:"true",onDragstart:I=>e(I,f),onDragover:i[2]||(i[2]=I=>ce(I)),onDrop:I=>ne(I,f),onDragend:se},[d("div",_l,[i[6]||(i[6]=d("div",{class:"drag-handle",title:"拖拽排序"},[d("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor"},[d("circle",{cx:"4",cy:"4",r:"1"}),d("circle",{cx:"4",cy:"8",r:"1"}),d("circle",{cx:"4",cy:"12",r:"1"}),d("circle",{cx:"8",cy:"4",r:"1"}),d("circle",{cx:"8",cy:"8",r:"1"}),d("circle",{cx:"8",cy:"12",r:"1"}),d("circle",{cx:"12",cy:"4",r:"1"}),d("circle",{cx:"12",cy:"8",r:"1"}),d("circle",{cx:"12",cy:"12",r:"1"})])],-1)),!G.value||G.value!==f.id?(v(),U("div",Vl,[d("span",Al,Y(f.label),1),f.isDefault?(v(),U("span",Dl,"默认")):R("",!0)])):(v(),U("div",xl,[t(z,{modelValue:y.value,"onUpdate:modelValue":i[1]||(i[1]=I=>y.value=I),size:"small",onKeyup:De(I=>c(f.id),["enter"]),onBlur:x},null,8,["modelValue","onKeyup"])]))]),d("div",Cl,[!G.value||G.value!==f.id?(v(),O($,{key:0,type:"text",size:"small",onClick:I=>o(f)},{default:a(()=>[...i[7]||(i[7]=[E(" 编辑 ",-1)])]),_:1},8,["onClick"])):R("",!0),G.value===f.id?(v(),O($,{key:1,type:"text",size:"small",onClick:I=>c(f.id)},{default:a(()=>[...i[8]||(i[8]=[E(" 保存 ",-1)])]),_:1},8,["onClick"])):R("",!0),G.value===f.id?(v(),O($,{key:2,type:"text",size:"small",onClick:x},{default:a(()=>[...i[9]||(i[9]=[E(" 取消 ",-1)])]),_:1})):R("",!0),!G.value||G.value!==f.id?(v(),O(oe,{key:3,title:f.isDefault?"确定要删除这个默认改善问题选项吗？删除后将无法恢复。":"确定要删除这个改善问题选项吗？",onConfirm:I=>w(f.id)},{reference:a(()=>[t($,{type:"text",size:"small",class:xe(["delete-btn",{"default-delete":f.isDefault}])},{default:a(()=>[...i[10]||(i[10]=[E(" 删除 ",-1)])]),_:1},8,["class"])]),_:2},1032,["title","onConfirm"])):R("",!0)])],42,wl))),128))])]),d("div",El,[t(X),d("div",kl,[d("span",null,"总计："+Y(K(h).allGoals.length)+" 个选项",1),d("span",null,"默认："+Y(K(h).defaultGoals.length)+" 个",1),d("span",null,"自定义："+Y(K(h).customGoals.length)+" 个",1)])])])]),_:1},8,["modelValue"])}}}),Ul=ke(Sl,[["__scopeId","data-v-0213883d"]]),Tl={class:"customer-form"},Il={class:"page-header"},ql={class:"form-section"},$l={class:"phone-input-group"},Ol={key:0,class:"verify-result"},Bl={key:0},Pl={key:1},Nl={key:2,class:"permission-warning"},Ml={style:{color:"#e6a23c","font-weight":"500"}},Rl={style:{"margin-top":"12px"}},zl={class:"form-section"},Ll={class:"form-section"},Hl={class:"improvement-goals-section"},Fl={class:"form-section"},Yl={class:"form-section"},Zl={class:"form-footer"},jl=Ce({__name:"Add",setup(n){var ye;const g=Ze(),b=je(),D=al(),h=sl(),S=ol(),q=rl(),G=Ge();il();const y=nl(b),T=k(!1),Z=k(),M=k(!1),W=k(!1),o=k(null),c=ae(()=>g.name==="CustomerEdit"),x=ae(()=>D.isLoggedIn&&D.currentUser),w=ae(()=>!!(o.value&&o.value.type==="warning")),B=ae(()=>w.value?o.value&&o.value.type==="warning"?'该手机号已存在客户记录，无法重复创建。请点击"查看详情"查看已有客户信息。':"保存按钮已禁用":"");!x.value&&!c.value&&(A.error("您没有创建客户的权限"),y.push("/customer/list"));const e=Ke({name:"",gender:"",phone:"",age:null,fanAcquisitionTime:"",email:"",wechat:"",height:null,weight:null,province:"",city:"",district:"",street:"",detailAddress:"",isOverseas:!1,overseasAddress:"",medicalHistory:"",improvementGoals:[],otherGoals:"",level:"normal",status:"active",source:"",tags:[],salesPerson:((ye=D.currentUser)==null?void 0:ye.name)||"",remark:""}),ce=k([]),ne=k([]),se=k([]),p=k([]),i=r=>{e.city="",e.district="",e.street="",ne.value=ul(r),se.value=[],p.value=[]},z=r=>{e.district="",e.street="",se.value=cl(e.province,r),p.value=[]},$=r=>{e.street="",p.value=ml(e.province,e.city,r)},oe=r=>{r?(e.province="",e.city="",e.district="",e.street="",e.detailAddress="",ne.value=[],se.value=[],p.value=[]):e.overseasAddress=""};k([{label:"张三",value:"zhangsan"},{label:"李四",value:"lisi"},{label:"王五",value:"wangwu"},{label:"赵六",value:"zhaoliu"},{label:"钱七",value:"qianqi"}]);const X=k([]),j=k(!1),f=()=>{var r,l;c.value||(e.salesPerson=((r=D.currentUser)==null?void 0:r.realName)||((l=D.currentUser)==null?void 0:l.username)||"当前用户")},I={name:[ee.required("请输入客户姓名"),ee.chineseName("请输入正确的中文姓名")],phone:[ee.required("请输入手机号"),ee.phone("请输入正确的手机号格式")],email:[ee.email("请输入正确的邮箱格式")],gender:[ee.required("请选择性别")],age:[{required:!0,message:"请输入年龄",trigger:"blur"},{type:"number",min:1,max:120,message:"年龄应在1-120之间",trigger:"blur"}],fanAcquisitionTime:[ee.required("请选择进粉时间")],height:[{required:!0,message:"请输入身高",trigger:"blur"},{type:"number",min:50,max:250,message:"身高应在50-250cm之间",trigger:"blur"}],weight:[{required:!0,message:"请输入体重",trigger:"blur"},{type:"number",min:20,max:300,message:"体重应在20-300kg之间",trigger:"blur"}],level:[{required:!0,message:"请选择客户等级",trigger:"change"}],status:[{required:!0,message:"请选择客户状态",trigger:"change"}],medicalHistory:[{max:500,message:"疾病史长度不能超过500个字符",trigger:"blur"}],salesPerson:[{required:!0,message:"请选择负责销售",trigger:"change"}],province:[{validator:(r,l,u)=>{!e.isOverseas&&!l?u(new Error("请选择省份")):u()},trigger:"change"}],city:[{validator:(r,l,u)=>{!e.isOverseas&&!l?u(new Error("请选择城市")):u()},trigger:"change"}],district:[{validator:(r,l,u)=>{!e.isOverseas&&!l?u(new Error("请选择区县")):u()},trigger:"change"}],street:[{min:1,max:100,message:"街道长度应在1-100个字符之间",trigger:"blur"}],detailAddress:[{validator:(r,l,u)=>{!e.isOverseas&&!l?u(new Error("请输入详细地址")):!e.isOverseas&&l&&(l.length<5||l.length>200)?u(new Error("详细地址长度应在5-200个字符之间")):u()},trigger:"blur"}],overseasAddress:[{validator:(r,l,u)=>{e.isOverseas&&!l?u(new Error("请输入境外地址")):e.isOverseas&&l&&(l.length<5||l.length>200)?u(new Error("境外地址长度应在5-200个字符之间")):u()},trigger:"blur"}],address:[{min:5,max:200,message:"地址长度应在5-200个字符之间",trigger:"blur"}],wechat:[{min:3,max:50,message:"微信号长度应在3-50个字符之间",trigger:"blur"}],qq:[{type:"number",min:1e4,max:9999999999,message:"请输入正确的QQ号",trigger:"blur"}],improvementGoals:[{required:!0,validator:(r,l,u)=>{!l||l.length===0?u(new Error("请至少选择一个改善问题")):u()},trigger:"change"}],otherGoals:[{validator:(r,l,u)=>{e.improvementGoals.includes("其他")&&(!l||l.trim()==="")?u(new Error("选择其他时，请填写具体的改善目标")):u()},trigger:"blur"}]},J=()=>H(this,null,function*(){if(!e.phone||e.phone.length!==11){A.warning("请输入正确的手机号");return}M.value=!0,o.value=null;try{const r=yield ge.checkExists(e.phone);if(!r.success){console.error("API调用失败:",r.message),o.value={type:"error",message:`验证失败: ${r.message}`},A.error(`验证失败: ${r.message}`);return}if(r.data){const l=r.data;o.value={type:"warning",message:"该手机号已存在客户记录",owner:l.creatorName||l.name,createTime:l.createTime,customerId:l.id},console.log("客户已存在:",l),A.warning("客户已存在，请查看详情")}else o.value={type:"success",message:"该手机号可以创建新客户"},console.log("客户不存在，可以创建"),A.success("验证通过，可以创建新客户");console.log("=== 验证客户完成 ===")}catch(r){console.error("验证客户失败:",r);let l="验证失败，请重试";r instanceof TypeError&&r.message.includes("Failed to fetch")?l="网络连接失败，请检查网络连接后重试":r instanceof Error&&(l=`验证失败: ${r.message}`),o.value={type:"error",message:l},A.error(l)}finally{M.value=!1}}),Se=()=>{var r;(r=o.value)!=null&&r.customerId&&y.push(`/customer/detail/${o.value.customerId}`)},Ue=()=>H(this,null,function*(){e.phone&&e.phone.length===11?yield J():o.value=null}),Te=()=>H(this,null,function*(){if(Z.value)try{if(!(yield Z.value.validate()))return;yield h.withLoading(()=>H(this,null,function*(){var l,u;if(c.value)console.log("更新客户信息:",e);else{console.log("=== 开始保存客户 ==="),console.log("表单数据:",e);const P=yield ge.checkExists(e.phone);if(console.log("检查客户是否存在响应:",P),P.data){const m=P.data;throw console.log("客户已存在，抛出错误:",m),new Error(`手机号 ${e.phone} 已存在，客户姓名：${m.name}`)}const de=[e.province,e.city,e.district,e.street,e.detailAddress].filter(Boolean).join(" "),L={name:e.name,phone:e.phone,age:e.age||0,address:de,level:e.level,status:e.status,salesPersonId:((l=D.currentUser)==null?void 0:l.id)||"admin",createdBy:((u=D.currentUser)==null?void 0:u.id)||"admin",wechatId:e.wechat,email:e.email,fanAcquisitionTime:e.fanAcquisitionTime,company:"",position:"",source:e.source,tags:e.tags,remarks:e.remark,height:e.height,weight:e.weight,gender:e.gender,medicalHistory:e.medicalHistory,improvementGoals:e.improvementGoals,otherGoals:e.otherGoals};console.log("准备保存的客户数据:",L);const ie=yield S.createCustomer(L);console.log("保存客户结果:",ie),c.value||q.sendMessage(q.MessageType.CUSTOMER_CREATED,`客户 ${e.name}（${e.phone}）添加成功`,{relatedId:L.phone,relatedType:"customer",actionUrl:"/customer/list"}),console.log("=== 保存客户完成 ===")}}),c.value?"正在更新客户信息...":"正在添加客户..."),A.success(c.value?"客户信息更新成功":"客户添加成功"),yield new Promise(l=>setTimeout(l,100)),yield S.forceSyncData(),yield Xe(),console.log("客户添加成功，已完成强化数据同步"),y.push({path:"/customer/list",query:{refresh:"true",timestamp:Date.now().toString()}})}catch(r){console.error("保存客户失败:",r),h.showError({title:c.value?"更新客户信息失败":"添加客户失败",message:r instanceof Error?r.message:String(r)})}}),Ie=()=>H(this,null,function*(){try{yield he.confirm("确定要取消吗？未保存的数据将丢失","提示",{confirmButtonText:"确定",cancelButtonText:"继续编辑",type:"warning"}),y.push("/customer/list")}catch(r){}}),qe=()=>H(this,null,function*(){if(console.log("=== handleSaveAndOrder 开始 ==="),!Z.value){console.error("customerFormRef 不存在");return}try{if(console.log("开始表单验证..."),!(yield Z.value.validate())){console.log("表单验证失败");return}console.log("表单验证通过"),yield h.withLoading(()=>H(this,null,function*(){var ue,me,F,re;console.log("检查客户是否已存在，手机号:",e.phone);const l=yield ge.checkExists(e.phone);if(console.log("客户存在检查结果:",l),l.data){const N=l.data;console.log("客户已存在，客户信息:",N),A.success("客户已存在，正在跳转到下单页面...");const C=[e.province,e.city,e.district,e.street,e.detailAddress].filter(Boolean).join(" ");console.log("准备跳转到订单页面，参数:",{customerId:N.id,customerName:N.name,customerPhone:N.phone,customerAddress:N.address||C}),y.push({path:"/order/add",query:{customerId:N.id,customerName:N.name,customerPhone:N.phone,customerAddress:N.address||C}});return}console.log("客户不存在，开始创建新客户");const u=[e.province,e.city,e.district,e.street,e.detailAddress].filter(Boolean).join(" "),P=(ue=D.currentUser)==null?void 0:ue.id,de=(me=D.currentUser)==null?void 0:me.name;console.log("当前用户信息检查:",{currentUser:D.currentUser,currentUserId:P,currentUserName:de,isLoggedIn:D.isLoggedIn}),!P&&D.isLoggedIn&&(console.warn("用户已登录但用户ID为空，尝试重新初始化用户信息"),D.initUser());const L=((F=D.currentUser)==null?void 0:F.id)||"admin",ie=((re=D.currentUser)==null?void 0:re.name)||"系统管理员";console.log("最终使用的用户信息:",{finalUserId:L,finalUserName:ie});const m={name:e.name,phone:e.phone,age:e.age||0,address:u,level:e.level,status:e.status,salesPersonId:L,createdBy:L,wechatId:e.wechat,email:e.email,fanAcquisitionTime:e.fanAcquisitionTime,company:"",position:"",source:e.source,tags:e.tags,remarks:e.remark,height:e.height,weight:e.weight,gender:e.gender,medicalHistory:e.medicalHistory,improvementGoals:e.improvementGoals,otherGoals:e.otherGoals,province:e.province,city:e.city,district:e.district,street:e.street,detailAddress:e.detailAddress,overseasAddress:e.overseasAddress};console.log("准备创建客户，数据:",m);const V=yield S.createCustomer(m);console.log("客户创建成功，新客户信息:",V),console.log("强制刷新客户列表数据以确保新客户显示"),yield S.forceRefreshCustomers(),console.log("客户列表数据刷新完成，当前客户数量:",S.customers.length),q.sendMessage(q.MessageType.CUSTOMER_CREATED,`客户 ${e.name}（${e.phone}）添加成功`,{relatedId:m.phone,relatedType:"customer",actionUrl:"/customer/list"}),A.success("客户添加成功！"),he.confirm("客户添加成功！您希望：","操作选择",{confirmButtonText:"立即为该客户下单",cancelButtonText:"查看客户列表",type:"success",distinguishCancelAndClose:!0}).then(()=>{console.log("用户选择跳转到订单页面，参数:",{customerId:V.id,customerName:e.name,customerPhone:e.phone,customerAddress:u}),y.push({path:"/order/add",query:{customerId:V.id,customerName:e.name,customerPhone:e.phone,customerAddress:u}})}).catch(N=>{N==="cancel"&&(console.log("用户选择查看客户列表"),y.push({path:"/customer/list",query:{refresh:"true",timestamp:Date.now().toString()}}))})}),"正在保存客户信息..."),console.log("=== handleSaveAndOrder 完成 ===")}catch(r){console.error("handleSaveAndOrder 失败:",r),h.showError("保存客户信息失败",r)}}),$e=()=>H(this,null,function*(){if(!c.value)return;const r=g.params.id;T.value=!0;try{yield new Promise(u=>setTimeout(u,500));const l=yield S.getCustomerById(r);l?Object.assign(e,{name:l.name,gender:l.gender,phone:l.phone,age:l.age,email:l.email,wechatId:l.wechatId,address:l.address,level:l.level,source:l.source,tags:l.tags||[],salesPerson:l.salesPersonId,remark:l.remarks}):(A.error("客户不存在"),y.push("/customer/list"))}catch(l){A.error("加载客户信息失败"),y.push("/customer/list")}finally{T.value=!1}}),Oe=()=>{ce.value=pl()},Be=()=>H(this,null,function*(){try{j.value=!0;const r=yield dl.getActiveList();X.value=r.data}catch(r){console.error("加载标签失败:",r),A.error("加载标签失败")}finally{j.value=!1}});return fe(()=>e.phone,(r,l)=>{r!==l&&o.value&&(o.value=null)}),Ee(()=>{f(),Oe(),Be(),$e()}),(r,l)=>{const u=_("el-input"),P=_("el-button"),de=_("el-divider"),L=_("el-icon"),ie=_("el-alert"),m=_("el-form-item"),V=_("el-col"),ue=_("el-radio"),me=_("el-radio-group"),F=_("el-row"),re=_("el-input-number"),N=_("el-date-picker"),C=_("el-option"),Q=_("el-select"),be=_("el-checkbox"),Pe=_("el-checkbox-group"),ve=_("el-tooltip"),Ne=_("el-form"),Me=_("el-card");return v(),U("div",Tl,[d("div",Il,[d("h2",null,Y(c.value?"编辑客户":"新增客户"),1)]),t(Me,{class:"form-card"},{default:a(()=>[t(Ne,{ref_key:"customerFormRef",ref:Z,model:e,rules:I,"label-width":"100px",size:"default"},{default:a(()=>[d("div",ql,[l[34]||(l[34]=d("h3",{class:"section-title"},"基本信息",-1)),t(F,{gutter:20},{default:a(()=>[t(V,{span:10},{default:a(()=>[t(m,{label:"手机号",prop:"phone"},{default:a(()=>[d("div",$l,[t(u,{modelValue:e.phone,"onUpdate:modelValue":l[0]||(l[0]=s=>e.phone=s),placeholder:"请输入手机号",clearable:"",onBlur:Ue},null,8,["modelValue"]),t(P,{type:"primary",size:"default",onClick:J,loading:M.value,disabled:!e.phone||e.phone.length!==11},{default:a(()=>[...l[27]||(l[27]=[E(" 验证客户 ",-1)])]),_:1},8,["loading","disabled"])]),o.value?(v(),U("div",Ol,[t(ie,{title:o.value.message,type:o.value.type,closable:!1,"show-icon":""},Je({_:2},[o.value.type==="warning"?{name:"default",fn:a(()=>[d("p",null,Y(o.value.message),1),o.value.owner?(v(),U("p",Bl,[l[28]||(l[28]=d("strong",null,"归属人：",-1)),E(Y(o.value.owner),1)])):R("",!0),o.value.createTime?(v(),U("p",Pl,[l[29]||(l[29]=d("strong",null,"创建时间：",-1)),E(Y(o.value.createTime),1)])):R("",!0),w.value?(v(),U("div",Nl,[t(de),d("p",Ml,[t(L,null,{default:a(()=>[t(K(el))]),_:1}),l[30]||(l[30]=E(" 权限提示：该客户由其他成员创建，您没有权限保存修改。如需操作，请联系管理员或客户创建者。 ",-1))])])):R("",!0),d("div",Rl,[t(P,{size:"small",type:"text",onClick:Se},{default:a(()=>[...l[31]||(l[31]=[E("查看客户详情",-1)])]),_:1})])]),key:"0"}:void 0]),1032,["title","type"])])):R("",!0)]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"客户姓名",prop:"name"},{default:a(()=>[t(u,{modelValue:e.name,"onUpdate:modelValue":l[1]||(l[1]=s=>e.name=s),placeholder:"请输入客户姓名",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:6},{default:a(()=>[t(m,{label:"性别",prop:"gender"},{default:a(()=>[t(me,{modelValue:e.gender,"onUpdate:modelValue":l[2]||(l[2]=s=>e.gender=s)},{default:a(()=>[t(ue,{label:"male"},{default:a(()=>[...l[32]||(l[32]=[E("男",-1)])]),_:1}),t(ue,{label:"female"},{default:a(()=>[...l[33]||(l[33]=[E("女",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(F,{gutter:20},{default:a(()=>[t(V,{span:8},{default:a(()=>[t(m,{label:"年龄",prop:"age"},{default:a(()=>[t(re,{modelValue:e.age,"onUpdate:modelValue":l[3]||(l[3]=s=>e.age=s),min:1,max:120,placeholder:"请输入年龄",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"身高(cm)",prop:"height"},{default:a(()=>[t(re,{modelValue:e.height,"onUpdate:modelValue":l[4]||(l[4]=s=>e.height=s),min:50,max:250,placeholder:"请输入身高",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"体重(kg)",prop:"weight"},{default:a(()=>[t(re,{modelValue:e.weight,"onUpdate:modelValue":l[5]||(l[5]=s=>e.weight=s),min:20,max:300,placeholder:"请输入体重",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(F,{gutter:20},{default:a(()=>[t(V,{span:8},{default:a(()=>[t(m,{label:"进粉时间",prop:"fanAcquisitionTime"},{default:a(()=>[t(N,{modelValue:e.fanAcquisitionTime,"onUpdate:modelValue":l[6]||(l[6]=s=>e.fanAcquisitionTime=s),type:"date",placeholder:"请选择进粉时间",style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"微信号",prop:"wechat"},{default:a(()=>[t(u,{modelValue:e.wechat,"onUpdate:modelValue":l[7]||(l[7]=s=>e.wechat=s),placeholder:"请输入微信号",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"邮箱",prop:"email"},{default:a(()=>[t(u,{modelValue:e.email,"onUpdate:modelValue":l[8]||(l[8]=s=>e.email=s),placeholder:"请输入邮箱地址",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),d("div",zl,[l[36]||(l[36]=d("h3",{class:"section-title"},"收货地址",-1)),t(F,{gutter:20},{default:a(()=>[t(V,{span:6},{default:a(()=>[t(m,{label:"省份",prop:"province",required:!e.isOverseas},{default:a(()=>[t(Q,{modelValue:e.province,"onUpdate:modelValue":l[9]||(l[9]=s=>e.province=s),placeholder:"请选择省份",style:{width:"100%"},onChange:i,disabled:e.isOverseas},{default:a(()=>[(v(!0),U(le,null,te(ce.value,s=>(v(),O(C,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},8,["required"])]),_:1}),t(V,{span:6},{default:a(()=>[t(m,{label:"城市",prop:"city",required:!e.isOverseas},{default:a(()=>[t(Q,{modelValue:e.city,"onUpdate:modelValue":l[10]||(l[10]=s=>e.city=s),placeholder:"请选择城市",style:{width:"100%"},onChange:z,disabled:e.isOverseas},{default:a(()=>[(v(!0),U(le,null,te(ne.value,s=>(v(),O(C,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},8,["required"])]),_:1}),t(V,{span:6},{default:a(()=>[t(m,{label:"区县",prop:"district",required:!e.isOverseas},{default:a(()=>[t(Q,{modelValue:e.district,"onUpdate:modelValue":l[11]||(l[11]=s=>e.district=s),placeholder:"请选择区县",style:{width:"100%"},onChange:$,disabled:e.isOverseas},{default:a(()=>[(v(!0),U(le,null,te(se.value,s=>(v(),O(C,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},8,["required"])]),_:1}),t(V,{span:6},{default:a(()=>[t(m,{label:"街道",prop:"street"},{default:a(()=>[t(Q,{modelValue:e.street,"onUpdate:modelValue":l[12]||(l[12]=s=>e.street=s),placeholder:"请选择街道",style:{width:"100%"},disabled:e.isOverseas},{default:a(()=>[(v(!0),U(le,null,te(p.value,s=>(v(),O(C,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),t(m,{label:"详细地址",prop:"detailAddress",required:!e.isOverseas},{default:a(()=>[t(u,{modelValue:e.detailAddress,"onUpdate:modelValue":l[13]||(l[13]=s=>e.detailAddress=s),placeholder:"请输入详细地址（门牌号、楼层等）",clearable:"",disabled:e.isOverseas},null,8,["modelValue","disabled"])]),_:1},8,["required"]),t(m,null,{default:a(()=>[t(be,{modelValue:e.isOverseas,"onUpdate:modelValue":l[14]||(l[14]=s=>e.isOverseas=s),onChange:oe},{default:a(()=>[...l[35]||(l[35]=[E(" 使用境外地址 ",-1)])]),_:1},8,["modelValue"])]),_:1}),Qe(t(m,{label:"境外地址",prop:"overseasAddress",required:e.isOverseas},{default:a(()=>[t(u,{modelValue:e.overseasAddress,"onUpdate:modelValue":l[15]||(l[15]=s=>e.overseasAddress=s),placeholder:"请输入完整的境外地址",clearable:""},null,8,["modelValue"])]),_:1},8,["required"]),[[We,e.isOverseas]])]),d("div",Ll,[l[38]||(l[38]=d("h3",{class:"section-title"},"健康信息",-1)),t(m,{label:"疾病史",prop:"medicalHistory",required:""},{default:a(()=>[t(u,{modelValue:e.medicalHistory,"onUpdate:modelValue":l[16]||(l[16]=s=>e.medicalHistory=s),type:"textarea",rows:3,placeholder:"请输入疾病史（如有）"},null,8,["modelValue"])]),_:1}),t(m,{label:"改善问题",prop:"improvementGoals",required:""},{default:a(()=>[d("div",Hl,[t(Pe,{modelValue:e.improvementGoals,"onUpdate:modelValue":l[17]||(l[17]=s=>e.improvementGoals=s),class:"improvement-goals-group"},{default:a(()=>[(v(!0),U(le,null,te(K(G).allGoals,s=>(v(),O(be,{key:s.id,label:s.value},{default:a(()=>[E(Y(s.label),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),K(D).isSuperAdmin?(v(),O(P,{key:0,type:"text",size:"small",onClick:l[18]||(l[18]=s=>W.value=!0),class:"edit-goals-btn"},{default:a(()=>[t(L,null,{default:a(()=>[t(K(ll))]),_:1}),l[37]||(l[37]=E(" 修改 ",-1))]),_:1})):R("",!0)])]),_:1}),e.improvementGoals.includes("其他")?(v(),O(m,{key:0,label:"其他改善目标",prop:"otherGoals",required:""},{default:a(()=>[t(F,{gutter:20},{default:a(()=>[t(V,{span:24},{default:a(()=>[t(u,{modelValue:e.otherGoals,"onUpdate:modelValue":l[19]||(l[19]=s=>e.otherGoals=s),placeholder:"请输入其他改善目标",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})):R("",!0)]),d("div",Fl,[l[39]||(l[39]=d("h3",{class:"section-title"},"客户分类",-1)),t(F,{gutter:20},{default:a(()=>[t(V,{span:12},{default:a(()=>[t(m,{label:"客户等级",prop:"level"},{default:a(()=>[t(Q,{modelValue:e.level,"onUpdate:modelValue":l[20]||(l[20]=s=>e.level=s),placeholder:"请选择客户等级",style:{width:"100%"}},{default:a(()=>[t(C,{label:"普通客户",value:"normal"}),t(C,{label:"白银客户",value:"silver"}),t(C,{label:"黄金客户",value:"gold"}),t(C,{label:"钻石客户",value:"diamond"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(V,{span:12},{default:a(()=>[t(m,{label:"客户来源",prop:"source"},{default:a(()=>[t(Q,{modelValue:e.source,"onUpdate:modelValue":l[21]||(l[21]=s=>e.source=s),placeholder:"请选择客户来源",style:{width:"100%"}},{default:a(()=>[t(C,{label:"线上推广",value:"online"}),t(C,{label:"朋友介绍",value:"referral"}),t(C,{label:"电话营销",value:"telemarketing"}),t(C,{label:"门店到访",value:"store"}),t(C,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(F,{gutter:20},{default:a(()=>[t(V,{span:8},{default:a(()=>[t(m,{label:"客户状态",prop:"status"},{default:a(()=>[t(Q,{modelValue:e.status,"onUpdate:modelValue":l[22]||(l[22]=s=>e.status=s),placeholder:"请选择客户状态",style:{width:"100%"}},{default:a(()=>[t(C,{label:"活跃",value:"active"}),t(C,{label:"非活跃",value:"inactive"}),t(C,{label:"潜在客户",value:"potential"}),t(C,{label:"已流失",value:"lost"}),t(C,{label:"黑名单",value:"blacklist"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"客户标签",prop:"tags"},{default:a(()=>[t(Q,{modelValue:e.tags,"onUpdate:modelValue":l[23]||(l[23]=s=>e.tags=s),multiple:"",placeholder:"请选择客户标签",style:{width:"100%"},loading:j.value},{default:a(()=>[(v(!0),U(le,null,te(X.value,s=>(v(),O(C,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(V,{span:8},{default:a(()=>[t(m,{label:"负责销售",prop:"salesPerson"},{default:a(()=>[t(u,{modelValue:e.salesPerson,"onUpdate:modelValue":l[24]||(l[24]=s=>e.salesPerson=s),placeholder:"负责销售",style:{width:"100%"},readonly:""},{suffix:a(()=>[t(ve,{content:"新建客户的负责销售默认为当前创建者，不可修改",placement:"top"},{default:a(()=>[t(L,null,{default:a(()=>[t(K(tl))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),d("div",Yl,[l[40]||(l[40]=d("h3",{class:"section-title"},"备注信息",-1)),t(m,{label:"客户备注",prop:"remark"},{default:a(()=>[t(u,{modelValue:e.remark,"onUpdate:modelValue":l[25]||(l[25]=s=>e.remark=s),type:"textarea",rows:4,placeholder:"请输入客户备注信息"},null,8,["modelValue"])]),_:1})])]),_:1},8,["model"])]),_:1}),d("div",Zl,[t(P,{onClick:Ie,size:"large"},{default:a(()=>[...l[41]||(l[41]=[E("取消",-1)])]),_:1}),t(ve,{content:B.value,disabled:!w.value,placement:"top"},{default:a(()=>[t(P,{type:"primary",onClick:Te,loading:T.value,disabled:w.value,size:"large"},{default:a(()=>[E(Y(c.value?"更新":"保存"),1)]),_:1},8,["loading","disabled"])]),_:1},8,["content","disabled"]),t(ve,{content:B.value,disabled:!w.value,placement:"top"},{default:a(()=>[c.value?R("",!0):(v(),O(P,{key:0,type:"success",onClick:qe,loading:T.value,disabled:w.value,size:"large"},{default:a(()=>[...l[42]||(l[42]=[E(" 保存并下单 ",-1)])]),_:1},8,["loading","disabled"]))]),_:1},8,["content","disabled"])]),t(Ul,{modelValue:W.value,"onUpdate:modelValue":l[26]||(l[26]=s=>W.value=s)},null,8,["modelValue"])])}}}),at=ke(jl,[["__scopeId","data-v-cb4879f9"]]);export{at as default};
