<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户添加测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin-bottom: 30px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>客户数据存储测试</h1>
        
        <div class="test-section">
            <h2>1. 检查当前存储状态</h2>
            <button onclick="checkStorage()">检查 localStorage</button>
            <button onclick="clearStorage()">清空存储</button>
            <div id="storageResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. 模拟添加客户</h2>
            <button onclick="addTestCustomer()">添加测试客户</button>
            <button onclick="addMultipleCustomers()">添加多个客户</button>
            <div id="addResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. 验证数据持久化</h2>
            <button onclick="refreshAndCheck()">刷新页面并检查数据</button>
            <div id="persistResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. 测试数据同步</h2>
            <button onclick="testDataSync()">测试数据同步</button>
            <div id="syncResult" class="result"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'crm_customers_unified';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            element.textContent += logMessage;
            element.className = `result ${type}`;
            element.scrollTop = element.scrollHeight;
        }

        function checkStorage() {
            const element = document.getElementById('storageResult');
            element.textContent = '';
            
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const customers = JSON.parse(data);
                    log('storageResult', `找到存储数据，共 ${customers.length} 个客户:`, 'success');
                    log('storageResult', JSON.stringify(customers, null, 2));
                } else {
                    log('storageResult', '未找到存储数据', 'info');
                }
                
                // 检查其他可能的存储键
                const allKeys = Object.keys(localStorage).filter(key => key.includes('crm') || key.includes('customer'));
                if (allKeys.length > 0) {
                    log('storageResult', `\n其他相关存储键: ${allKeys.join(', ')}`);
                }
            } catch (error) {
                log('storageResult', `检查存储失败: ${error.message}`, 'error');
            }
        }

        function clearStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                // 清理其他可能的客户相关存储
                const keysToRemove = Object.keys(localStorage).filter(key => 
                    key.includes('crm') && key.includes('customer')
                );
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                log('storageResult', '存储已清空', 'success');
                checkStorage();
            } catch (error) {
                log('storageResult', `清空存储失败: ${error.message}`, 'error');
            }
        }

        function addTestCustomer() {
            const element = document.getElementById('addResult');
            element.textContent = '';
            
            try {
                // 获取现有数据
                let customers = [];
                const existingData = localStorage.getItem(STORAGE_KEY);
                if (existingData) {
                    customers = JSON.parse(existingData);
                }
                
                // 创建测试客户
                const testCustomer = {
                    id: Date.now().toString(),
                    code: `TEST${Date.now()}`,
                    name: '测试客户' + Math.floor(Math.random() * 1000),
                    phone: '1380013' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'),
                    age: 25 + Math.floor(Math.random() * 40),
                    address: '测试地址',
                    level: 'normal',
                    status: 'active',
                    salesPersonId: 'test_sales',
                    orderCount: 0,
                    createTime: new Date().toLocaleString(),
                    createdBy: 'test_user',
                    email: 'test@example.com',
                    company: '测试公司',
                    position: '测试职位',
                    source: '测试来源',
                    tags: ['测试'],
                    remarks: '这是一个测试客户'
                };
                
                // 添加到数组
                customers.push(testCustomer);
                
                // 保存到存储
                localStorage.setItem(STORAGE_KEY, JSON.stringify(customers));
                
                log('addResult', `成功添加测试客户: ${testCustomer.name} (${testCustomer.phone})`, 'success');
                log('addResult', `当前总客户数: ${customers.length}`);
                log('addResult', JSON.stringify(testCustomer, null, 2));
                
            } catch (error) {
                log('addResult', `添加客户失败: ${error.message}`, 'error');
            }
        }

        function addMultipleCustomers() {
            const element = document.getElementById('addResult');
            element.textContent = '';
            
            try {
                let customers = [];
                const existingData = localStorage.getItem(STORAGE_KEY);
                if (existingData) {
                    customers = JSON.parse(existingData);
                }
                
                const initialCount = customers.length;
                
                // 添加3个测试客户
                for (let i = 1; i <= 3; i++) {
                    const testCustomer = {
                        id: (Date.now() + i).toString(),
                        code: `BATCH${Date.now()}_${i}`,
                        name: `批量测试客户${i}`,
                        phone: `1390139${String(Date.now()).slice(-4)}${i}`,
                        age: 20 + i * 5,
                        address: `测试地址${i}`,
                        level: ['normal', 'silver', 'gold'][i-1],
                        status: 'active',
                        salesPersonId: 'batch_sales',
                        orderCount: 0,
                        createTime: new Date().toLocaleString(),
                        createdBy: 'batch_test',
                        email: `batch${i}@example.com`,
                        company: `测试公司${i}`,
                        position: `测试职位${i}`,
                        source: '批量测试',
                        tags: ['批量', '测试'],
                        remarks: `批量测试客户${i}`
                    };
                    customers.push(testCustomer);
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(customers));
                
                log('addResult', `成功批量添加 3 个客户`, 'success');
                log('addResult', `客户数量: ${initialCount} → ${customers.length}`);
                
            } catch (error) {
                log('addResult', `批量添加失败: ${error.message}`, 'error');
            }
        }

        function refreshAndCheck() {
            const element = document.getElementById('persistResult');
            element.textContent = '';
            
            log('persistResult', '准备刷新页面测试数据持久化...', 'info');
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function testDataSync() {
            const element = document.getElementById('syncResult');
            element.textContent = '';
            
            try {
                // 模拟不同组件间的数据同步
                const data1 = localStorage.getItem(STORAGE_KEY);
                
                if (data1) {
                    const customers1 = JSON.parse(data1);
                    log('syncResult', `第一次读取: ${customers1.length} 个客户`, 'info');
                    
                    // 模拟添加客户
                    const newCustomer = {
                        id: 'sync_test_' + Date.now(),
                        code: `SYNC${Date.now()}`,
                        name: '同步测试客户',
                        phone: '1350135' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'),
                        age: 30,
                        address: '同步测试地址',
                        level: 'normal',
                        status: 'active',
                        salesPersonId: 'sync_sales',
                        orderCount: 0,
                        createTime: new Date().toLocaleString(),
                        createdBy: 'sync_test',
                        email: 'sync@example.com',
                        company: '同步测试公司',
                        position: '同步测试职位',
                        source: '同步测试',
                        tags: ['同步'],
                        remarks: '数据同步测试客户'
                    };
                    
                    customers1.push(newCustomer);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(customers1));
                    
                    // 立即重新读取验证
                    const data2 = localStorage.getItem(STORAGE_KEY);
                    const customers2 = JSON.parse(data2);
                    
                    log('syncResult', `添加客户后读取: ${customers2.length} 个客户`, 'success');
                    log('syncResult', `新添加的客户: ${newCustomer.name} (${newCustomer.phone})`);
                    
                    // 验证数据一致性
                    const lastCustomer = customers2[customers2.length - 1];
                    if (lastCustomer.id === newCustomer.id) {
                        log('syncResult', '✓ 数据同步成功，新客户已正确保存', 'success');
                    } else {
                        log('syncResult', '✗ 数据同步失败，新客户未正确保存', 'error');
                    }
                    
                } else {
                    log('syncResult', '未找到客户数据，请先添加一些客户', 'info');
                }
                
            } catch (error) {
                log('syncResult', `数据同步测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查存储
        window.onload = function() {
            checkStorage();
        };
    </script>
</body>
</html>