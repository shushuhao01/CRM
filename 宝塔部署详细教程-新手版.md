# 宝塔部署详细教程（新手版）

> 本教程适合完全没有部署经验的新手，每一步都有详细说明和截图位置提示。

---

## 📋 准备工作

### 你需要准备：
1. ✅ 一台云服务器（阿里云/腾讯云/华为云等）
2. ✅ 服务器的 IP 地址
3. ✅ 服务器的 root 密码
4. ✅ 一个域名（可选，没有也能用 IP 访问）

---

## 第一部分：安装宝塔面板（10分钟）

### 步骤 1：连接到服务器

#### Windows 用户：
1. 下载 **Xshell** 或 **PuTTY** 软件
2. 打开软件，输入：
   - 主机：`你的服务器IP`
   - 端口：`22`
   - 用户名：`root`
   - 密码：`你的服务器密码`
3. 点击"连接"

#### Mac/Linux 用户：
1. 打开"终端"应用
2. 输入命令：
   ```bash
   ssh root@你的服务器IP
   ```
3. 输入密码（输入时不显示，直接输入后按回车）

### 步骤 2：安装宝塔面板

连接成功后，复制以下命令，粘贴到终端，按回车：

**CentOS 系统：**
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

**Ubuntu/Debian 系统：**
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

### 步骤 3：等待安装完成

安装过程需要 5-10 分钟，看到类似以下信息表示安装成功：

```
==================================================================
Congratulations! Installed successfully!
==================================================================
外网面板地址: http://你的IP:8888/xxxxxxxx
内网面板地址: http://192.168.x.x:8888/xxxxxxxx
username: xxxxxxxx
password: xxxxxxxx
==================================================================
```

**重要：** 请把这些信息复制保存下来！

### 步骤 4：登录宝塔面板

1. 打开浏览器
2. 输入地址：`http://你的IP:8888/xxxxxxxx`（使用上面显示的地址）
3. 输入用户名和密码
4. 点击"登录"

---

## 第二部分：安装必要软件（15分钟）

### 步骤 1：进入软件商店

登录宝塔面板后：
1. 点击左侧菜单的 **"软件商店"**
2. 你会看到很多软件列表

### 步骤 2：安装 Nginx

1. 在软件商店搜索框输入：`nginx`
2. 找到 **"Nginx 1.22"**（或更高版本）
3. 点击右侧的 **"安装"** 按钮
4. 选择 **"极速安装"**
5. 点击 **"确定"**
6. 等待安装完成（约 2-3 分钟）

### 步骤 3：安装 MySQL

1. 在软件商店搜索框输入：`mysql`
2. 找到 **"MySQL 8.0"**
3. 点击右侧的 **"安装"** 按钮
4. 选择 **"极速安装"**
5. 点击 **"确定"**
6. 等待安装完成（约 5-8 分钟）

### 步骤 4：安装 Node.js

1. 在软件商店搜索框输入：`node`
2. 找到 **"Node.js 版本管理器"**
3. 点击右侧的 **"安装"** 按钮
4. 等待安装完成
5. 安装完成后，点击 **"设置"** 按钮
6. 在弹出的窗口中，点击 **"版本管理"** 标签
7. 找到 **"Node.js 18.x"** 或更高版本
8. 点击右侧的 **"安装"** 按钮
9. 等待安装完成

### 步骤 5：安装 PM2

1. 在软件商店搜索框输入：`pm2`
2. 找到 **"PM2 管理器"**
3. 点击右侧的 **"安装"** 按钮
4. 等待安装完成

---

## 第三部分：创建数据库（5分钟）

### 步骤 1：进入数据库管理

1. 点击左侧菜单的 **"数据库"**
2. 你会看到数据库列表（可能是空的）

### 步骤 2：添加数据库

1. 点击页面上方的 **"添加数据库"** 按钮
2. 在弹出的窗口中填写：
   - **数据库名**：`crm_db`（必须这样写）
   - **用户名**：`crm_user`（必须这样写）
   - **密码**：点击 **"生成密码"** 按钮（会自动生成一个强密码）
   - **访问权限**：选择 **"本地服务器"**
3. **重要：** 点击密码后面的 **"复制"** 按钮，把密码保存到记事本
4. 点击 **"提交"** 按钮

### 步骤 3：导入数据库结构

1. 在数据库列表中，找到刚才创建的 `crm_db`
2. 点击右侧的 **"管理"** 按钮
3. 在新打开的页面中，点击顶部的 **"导入"** 按钮
4. 点击 **"从本地上传"** 按钮
5. 选择项目中的 `database/schema.sql` 文件
6. 点击 **"导入"** 按钮
7. 等待导入完成

---

## 第四部分：上传项目代码（10分钟）

### 方式一：使用 Git（推荐）

#### 步骤 1：进入终端

1. 在宝塔面板，点击右上角的 **"终端"** 按钮
2. 会打开一个黑色的命令行窗口

#### 步骤 2：下载代码

在终端中依次输入以下命令（每输入一行按一次回车）：

```bash
# 1. 进入网站目录
cd /www/wwwroot

# 2. 克隆项目（从 GitHub 下载代码）
git clone https://github.com/shushuhao01/CRM.git

# 3. 进入项目目录
cd CRM

# 4. 查看文件（确认下载成功）
ls
```

如果看到很多文件名（如 package.json, src, backend 等），说明下载成功！

### 方式二：使用宝塔面板上传

#### 步骤 1：打包项目

在你的电脑上：
1. 找到项目文件夹
2. 右键点击文件夹
3. 选择 **"发送到 → 压缩(zipped)文件夹"**（Windows）
4. 或使用 WinRAR/7-Zip 压缩成 `.zip` 文件

#### 步骤 2：上传到服务器

1. 在宝塔面板，点击左侧菜单的 **"文件"**
2. 点击路径导航到 `/www/wwwroot`
3. 点击顶部的 **"上传"** 按钮
4. 选择刚才压缩的文件
5. 等待上传完成（根据网速，可能需要几分钟）

#### 步骤 3：解压文件

1. 在文件列表中找到上传的压缩包
2. 点击右侧的 **"解压"** 按钮
3. 解压路径选择：`/www/wwwroot`
4. 点击 **"解压"** 按钮
5. 解压完成后，会看到一个 `CRM` 文件夹

---

## 第五部分：配置环境变量（5分钟）

### 步骤 1：编辑后端环境变量

1. 在宝塔面板，点击左侧菜单的 **"文件"**
2. 导航到 `/www/wwwroot/CRM/backend`
3. 找到 `.env` 文件
   - 如果没有，点击 **"新建文件"**，文件名输入 `.env`
4. 点击文件名，选择 **"编辑"**
5. 在编辑器中输入以下内容：

```env
# 数据库配置（重要！）
DB_HOST=localhost
DB_PORT=3306
DB_USER=crm_user
DB_PASSWORD=你刚才保存的数据库密码
DB_NAME=crm_db

# 服务器配置
PORT=3000
NODE_ENV=production

# JWT 配置（随机生成一个密钥）
JWT_SECRET=crm_secret_key_2024_abcdefg123456
JWT_EXPIRES_IN=7d
```

**重要：** 把 `DB_PASSWORD` 改成你在第三部分保存的数据库密码！

6. 点击 **"保存"** 按钮

### 步骤 2：编辑前端环境变量

1. 返回到 `/www/wwwroot/CRM` 目录
2. 找到 `.env.production` 文件
3. 点击文件名，选择 **"编辑"**
4. 修改内容：

```env
# API 地址（改成你的域名或IP）
VITE_API_BASE_URL=http://你的IP或域名/api

# 使用真实 API
VITE_USE_REAL_API=true
```

**重要：** 把 `你的IP或域名` 改成你的实际 IP 地址或域名！

5. 点击 **"保存"** 按钮

---

## 第六部分：安装依赖和构建（10分钟）

### 步骤 1：打开终端

1. 在宝塔面板，点击右上角的 **"终端"** 按钮

### 步骤 2：执行部署脚本

在终端中依次输入以下命令：

```bash
# 1. 进入项目目录
cd /www/wwwroot/CRM

# 2. 给脚本执行权限
chmod +x deploy.sh

# 3. 执行部署脚本（自动安装依赖、构建、启动）
./deploy.sh
```

### 步骤 3：等待完成

脚本会自动完成以下操作：
- ✅ 安装前端依赖（约 3-5 分钟）
- ✅ 安装后端依赖（约 2-3 分钟）
- ✅ 构建前端（约 2-3 分钟）
- ✅ 启动后端服务

看到以下信息表示成功：
```
✅ 部署完成！
🎉 部署成功！
```

---

## 第七部分：配置 Nginx（10分钟）

### 步骤 1：创建网站

1. 在宝塔面板，点击左侧菜单的 **"网站"**
2. 点击页面上方的 **"添加站点"** 按钮
3. 在弹出的窗口中填写：
   - **域名**：
     - 如果有域名：输入 `www.你的域名.com` 和 `你的域名.com`（两行）
     - 如果没有域名：输入你的服务器 IP 地址
   - **根目录**：点击右侧的文件夹图标，选择 `/www/wwwroot/CRM/dist`
   - **FTP**：不创建
   - **数据库**：不创建（已经创建过了）
   - **PHP 版本**：选择 **"纯静态"**
4. 点击 **"提交"** 按钮

### 步骤 2：配置反向代理

1. 在网站列表中，找到刚才创建的网站
2. 点击右侧的 **"设置"** 按钮
3. 在弹出的窗口中，点击左侧的 **"反向代理"** 标签
4. 点击 **"添加反向代理"** 按钮
5. 填写信息：
   - **代理名称**：`api`
   - **目标 URL**：`http://127.0.0.1:3000`
   - **发送域名**：`$host`
   - **内容替换**：留空
6. 点击 **"保存"** 按钮

### 步骤 3：配置 URL 重写

1. 在网站设置窗口中，点击左侧的 **"配置文件"** 标签
2. 找到 `location /` 这一段（大约在第 20-30 行）
3. 在 `location /` 的大括号 `{}` 里面，添加一行：
   ```nginx
   try_files $uri $uri/ /index.html;
   ```
4. 在文件末尾（最后一个 `}` 之前），添加：
   ```nginx
   location /api {
       proxy_pass http://127.0.0.1:3000;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
   }
   ```

完整示例：
```nginx
server {
    listen 80;
    server_name 你的域名或IP;
    root /www/wwwroot/CRM/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

5. 点击 **"保存"** 按钮

---

## 第八部分：配置 SSL 证书（可选，5分钟）

### 如果你有域名，强烈建议配置 HTTPS：

1. 在网站设置窗口中，点击左侧的 **"SSL"** 标签
2. 选择 **"Let's Encrypt"** 标签
3. 勾选你的域名（www 和不带 www 都勾选）
4. 输入你的邮箱地址
5. 点击 **"申请"** 按钮
6. 等待 1-2 分钟，看到 **"证书申请成功"**
7. 开启 **"强制 HTTPS"** 开关（右上角）

---

## 第九部分：测试访问（2分钟）

### 步骤 1：访问网站

1. 打开浏览器
2. 输入地址：
   - 如果有域名：`https://你的域名.com`
   - 如果没有域名：`http://你的IP地址`
3. 按回车

### 步骤 2：登录测试

如果看到登录页面，说明部署成功！

使用测试账号登录：
- **用户名**：`admin`
- **密码**：`admin123`

### 步骤 3：测试功能

登录后，测试以下功能：
- ✅ 查看数据看板
- ✅ 进入客户管理
- ✅ 新增一个测试客户
- ✅ 新增一个测试订单

如果都能正常操作，恭喜你，部署成功！🎉

---

## 常见问题排查

### 问题 1：页面打不开

**检查步骤：**
1. 确认服务器防火墙开放了 80 和 443 端口
   - 宝塔面板 → 安全 → 添加端口规则
2. 确认云服务器安全组开放了 80 和 443 端口
   - 登录阿里云/腾讯云控制台 → 安全组 → 添加规则
3. 检查 Nginx 是否运行
   - 宝塔面板 → 软件商店 → Nginx → 查看状态

### 问题 2：页面空白

**检查步骤：**
1. 按 F12 打开浏览器控制台，查看错误信息
2. 检查前端是否构建成功
   - 终端执行：`ls /www/wwwroot/CRM/dist`
   - 应该看到很多文件
3. 检查 Nginx 配置是否正确
   - 根目录是否指向 `/www/wwwroot/CRM/dist`

### 问题 3：API 请求失败

**检查步骤：**
1. 检查后端是否运行
   - 终端执行：`pm2 list`
   - 应该看到 `crm-backend` 状态为 `online`
2. 查看后端日志
   - 终端执行：`pm2 logs crm-backend`
3. 检查数据库连接
   - 确认 `backend/.env` 中的数据库密码正确

### 问题 4：登录失败

**检查步骤：**
1. 确认数据库已导入
   - 宝塔面板 → 数据库 → crm_db → 管理
   - 应该看到多个表（users, customers, orders 等）
2. 查看后端日志
   - 终端执行：`pm2 logs crm-backend`

---

## 维护命令

### 查看后端状态
```bash
pm2 list
```

### 查看后端日志
```bash
pm2 logs crm-backend
```

### 重启后端
```bash
pm2 restart crm-backend
```

### 停止后端
```bash
pm2 stop crm-backend
```

### 更新代码
```bash
cd /www/wwwroot/CRM
git pull
./deploy.sh
```

---

## 🎉 恭喜你完成部署！

如果还有问题，可以：
1. 查看项目的其他文档
2. 在 GitHub 提交 Issue
3. 联系技术支持

**预设测试账号：**
- 超级管理员：`superadmin` / `super123456`
- 管理员：`admin` / `admin123`
- 部门经理：`manager` / `manager123`
- 销售员：`sales` / `sales123`
- 客服：`service` / `service123`

祝使用愉快！🚀
