<template>
  <div class="order-form">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="page-header">
      <h2>{{ isEdit ? 'ÁºñËæëËÆ¢Âçï' : 'Êñ∞Â¢ûËÆ¢Âçï' }}</h2>
    </div>

    <el-form :model="orderForm" :rules="formRules" ref="orderFormRef" label-width="120px">
      <!-- ÂÆ¢Êà∑ÈÄâÊã©Âå∫Âüü -->
      <el-card class="customer-card">
        <template #header>
          <div class="card-header">
            <div class="header-left">
              <el-icon><User /></el-icon>
              <span>ÂÆ¢Êà∑‰ø°ÊÅØ</span>
            </div>
          </div>
        </template>
        
        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="ÈÄâÊã©ÂÆ¢Êà∑" prop="customerId" required>
              <el-select
                v-model="orderForm.customerId"
                placeholder="ËØ∑ÈÄâÊã©ÂÆ¢Êà∑"
                style="width: 100%"
                filterable
                remote
                :remote-method="searchCustomers"
                :loading="customerLoading"
                @change="handleCustomerChange"
                size="large"
              >
                <el-option
                  v-for="customer in customerOptions"
                  :key="customer.id"
                  :label="`${customer.name} (${maskPhone(customer.phone)})`"
                  :value="customer.id"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="ÂÆ¢ÊúçÂæÆ‰ø°Âè∑" prop="serviceWechat" required>
              <el-input
                v-model="orderForm.serviceWechat"
                placeholder="ËØ∑ËæìÂÖ•Ë¥üË¥£ÂÆ¢ÊúçÁöÑÂæÆ‰ø°Âè∑"
                clearable
              >
                <template #prefix>
                  <el-icon><Message /></el-icon>
                </template>
              </el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="ËÆ¢ÂçïÊù•Ê∫ê" prop="orderSource" required>
              <el-select
                v-model="orderForm.orderSource"
                placeholder="ËØ∑ÈÄâÊã©ËÆ¢ÂçïÊù•Ê∫ê"
                style="width: 100%"
              >
                <el-option label="üõí Á∫ø‰∏äÂïÜÂüé" value="online_store" />
                <el-option label="üì± ÂæÆ‰ø°Â∞èÁ®ãÂ∫è" value="wechat_mini" />
                <el-option label="üí¨ ÂæÆ‰ø°ÂÆ¢Êúç" value="wechat_service" />
                <el-option label="üìû ÁîµËØùÂí®ËØ¢" value="phone_call" />
                <el-option label="üè™ Á∫ø‰∏ãÈó®Â∫ó" value="offline_store" />
                <el-option label="üë• ÂÆ¢Êà∑Êé®Ëçê" value="referral" />
                <el-option label="üì∫ ÂπøÂëäÊäïÊîæ" value="advertisement" />
                <el-option label="üéØ ÂÖ∂‰ªñÊ∏†ÈÅì" value="other" />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>

        <!-- Êî∂Ë¥ß‰ø°ÊÅØ -->
        <div v-if="selectedCustomer" class="delivery-info">
          <h4>Êî∂Ë¥ß‰ø°ÊÅØ</h4>
          <el-row :gutter="20">
            <el-col :span="6">
              <el-form-item label="Êî∂Ë¥ß‰∫∫" prop="receiverName">
                <el-input
                  v-model="orderForm.receiverName"
                  placeholder="ËØ∑ËæìÂÖ•Êî∂Ë¥ß‰∫∫ÂßìÂêç"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Êî∂Ë¥ßÁîµËØù" prop="receiverPhone">
                <div class="phone-management">
                  <el-select
                    v-model="orderForm.receiverPhone"
                    placeholder="ËØ∑ÈÄâÊã©Êî∂Ë¥ßÁîµËØù"
                    style="width: 100%"
                    clearable
                  >
                    <el-option
                      v-for="phone in customerPhones"
                      :key="phone.id"
                      :label="maskPhone(phone.number)"
                      :value="phone.number"
                    />
                  </el-select>
                  <el-button 
                    type="primary" 
                    size="small" 
                    @click="showAddPhoneDialog = true"
                    style="margin-left: 8px;"
                    :icon="Plus"
                  >
                    Êñ∞Â¢û
                  </el-button>
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="ÊåáÂÆöÂø´ÈÄí" prop="expressCompany" required>
                <el-select
                  v-model="orderForm.expressCompany"
                  placeholder="ËØ∑ÈÄâÊã©Âø´ÈÄíÂÖ¨Âè∏"
                  style="width: 100%"
                >
                  <el-option label="È°∫‰∏∞ÈÄüËøê" value="sf" />
                  <el-option label="ÂúÜÈÄöÈÄüÈÄí" value="yt" />
                  <el-option label="‰∏≠ÈÄöÂø´ÈÄí" value="zt" />
                  <el-option label="Áî≥ÈÄöÂø´ÈÄí" value="st" />
                  <el-option label="ÈüµËææÈÄüÈÄí" value="yd" />
                  <el-option label="Áôæ‰∏ñÂø´ÈÄí" value="bs" />
                  <el-option label="Âæ∑ÈÇ¶Âø´ÈÄí" value="db" />
                  <el-option label="‰∫¨‰∏úÁâ©ÊµÅ" value="jd" />
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="Êî∂Ë¥ßÂú∞ÂùÄ" prop="receiverAddress">
                <el-input
                  v-model="orderForm.receiverAddress"
                  placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÊî∂Ë¥ßÂú∞ÂùÄ"
                  clearable
                >
                  <template #suffix v-if="selectedCustomer && selectedCustomer.address">
                    <el-button 
                      size="small" 
                      type="text" 
                      @click="syncCustomerAddress"
                      title="ÂêåÊ≠•ÂÆ¢Êà∑Âú∞ÂùÄ"
                    >
                      <el-icon><Location /></el-icon>
                    </el-button>
                  </template>
                </el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </div>
      </el-card>

      <!-- ‰∫ßÂìÅÊêúÁ¥¢ÂíåÈÄâÊã©Âå∫Âüü -->
      <el-card class="product-card">
        <template #header>
          <div class="card-header">
            <div class="header-left">
              <el-icon><ShoppingBag /></el-icon>
              <span>‰∫ßÂìÅÈÄâÊã©</span>
            </div>
            <el-button
              type="primary"
              size="small"
              :icon="Refresh"
              @click="handleRefreshProducts"
              title="Âà∑Êñ∞ÂïÜÂìÅÂàóË°®"
            >
              Âà∑Êñ∞
            </el-button>
          </div>
        </template>

        <!-- ‰∫ßÂìÅÊêúÁ¥¢ -->
        <div class="product-search">
          <el-input
            v-model="productSearchKeyword"
            placeholder="ÊêúÁ¥¢‰∫ßÂìÅÂêçÁß∞„ÄÅÁºñÂè∑..."
            size="large"
            clearable
            @input="handleProductSearch"
          >
            <template #prefix>
              <el-icon><Search /></el-icon>
            </template>
          </el-input>
        </div>

        <!-- ‰∫ßÂìÅÂàóË°® -->
        <div class="product-list">
          <div 
            v-for="product in filteredProducts" 
            :key="product.id" 
            class="product-item"
            @click="addProduct(product)"
          >
            <div class="product-image">
              <img :src="product.image || '/default-product.png'" :alt="product.name" />
            </div>
            <div class="product-info">
              <div class="product-name">{{ product.name }}</div>
              <div class="product-price">¬•{{ product.price }}</div>
              <div class="product-stock">Â∫ìÂ≠ò: {{ product.stock }}</div>
            </div>
            <div class="product-actions">
              <el-button 
                type="info" 
                size="small" 
                :icon="View" 
                @click.stop="viewProductDetail(product)"
                title="Êü•ÁúãÂïÜÂìÅËØ¶ÊÉÖ"
              >
                ËØ¶ÊÉÖ
              </el-button>
              <el-button type="primary" size="small" :icon="Plus">Ê∑ªÂä†</el-button>
            </div>
          </div>
        </div>
      </el-card>

      <!-- ËÆ¢ÂçïÊ±áÊÄªÂå∫Âüü -->
      <el-card class="summary-card">
        <template #header>
          <div class="card-header">
            <div class="header-left">
              <el-icon><Money /></el-icon>
              <span>ËÆ¢ÂçïÊ±áÊÄª</span>
            </div>
          </div>
        </template>

        <!-- Â∑≤ÈÄâÂïÜÂìÅÂàóË°® -->
        <div class="selected-products" v-if="orderForm.products.length > 0">
          <h4>Â∑≤ÈÄâÂïÜÂìÅ</h4>
          <el-table :data="orderForm.products" style="width: 100%">
            <el-table-column prop="name" label="ÂïÜÂìÅÂêçÁß∞" />
            <el-table-column prop="price" label="Âçï‰ª∑" width="100">
              <template #default="{ row }">
                ¬•{{ row.price }}
              </template>
            </el-table-column>
            <el-table-column label="Êï∞Èáè" width="150">
              <template #default="{ row, $index }">
                <el-input-number
                  v-model="row.quantity"
                  :min="1"
                  :max="row.stock"
                  size="small"
                  @change="calculateTotal"
                />
              </template>
            </el-table-column>
            <el-table-column label="Â∞èËÆ°" width="100">
              <template #default="{ row }">
                ¬•{{ ((row.price || 0) * (row.quantity || 0)).toFixed(2) }}
              </template>
            </el-table-column>
            <el-table-column label="Êìç‰Ωú" width="80">
              <template #default="{ $index }">
                <el-button 
                  type="danger" 
                  size="small" 
                  :icon="Delete"
                  @click="removeProduct($index)"
                />
              </template>
            </el-table-column>
          </el-table>
        </div>

        <!-- ÈáëÈ¢ùÊ±áÊÄª - ÁÆÄÁ∫¶Áé∞‰ª£ÂåñÂ∏ÉÂ±Ä -->
        <div class="amount-summary-modern">
          <!-- Á¨¨‰∏ÄË°åÔºöÂïÜÂìÅÂ∞èËÆ°„ÄÅËÆ¢ÂçïÊÄªÈ¢ùÔºàËæìÂÖ•Ê°ÜÔºâ„ÄÅÂÆöÈáëÔºàËæìÂÖ•Ê°ÜÔºâ -->
          <div class="amount-row">
            <div class="amount-field">
              <span class="field-label">ÂïÜÂìÅÂ∞èËÆ°</span>
              <span class="field-amount subtotal">¬•{{ subtotal.toFixed(2) }}</span>
            </div>
            <div class="amount-field">
              <span class="field-label">
                ËÆ¢ÂçïÊÄªÈ¢ù
                <el-tooltip content="ÁÇπÂáªÂêåÊ≠•ÂïÜÂìÅÂ∞èËÆ°" placement="top" v-if="isManuallyModified">
                  <el-button 
                    type="text" 
                    size="small" 
                    :icon="Refresh" 
                    @click="resetToSubtotal"
                    class="sync-button"
                  />
                </el-tooltip>
              </span>
              <el-input-number
                v-model="orderForm.totalAmount"
                :min="0"
                :max="subtotal"
                :precision="2"
                placeholder="ËÆ¢ÂçïÊÄªÈ¢ù"
                class="field-input"
                @change="handleTotalAmountChange"
              />
            </div>
            <div class="amount-field">
              <span class="field-label">ÂÆöÈáë</span>
              <el-input-number
                v-model="orderForm.depositAmount"
                :min="0"
                :max="orderForm.totalAmount || 0"
                :precision="2"
                placeholder="ÂÆöÈáëÈáëÈ¢ù"
                class="field-input"
                @change="calculateCollectAmount"
              />
            </div>
          </div>
          
          <!-- Á¨¨‰∫åË°åÔºö‰ª£Êî∂ÈáëÈ¢ù„ÄÅ‰ºòÊÉ†ÈáëÈ¢ù„ÄÅÂÆöÈáëÊà™Âõæ -->
          <div class="amount-row">
            <div class="amount-field">
              <span class="field-label">‰ª£Êî∂ÈáëÈ¢ù</span>
              <span class="field-amount collect">¬•{{ collectAmount.toFixed(2) }}</span>
            </div>
            <div class="amount-field">
              <span class="field-label">‰ºòÊÉ†ÈáëÈ¢ù</span>
              <div class="discount-horizontal">
                <span class="field-amount discount">¬•{{ discountAmount.toFixed(2) }}</span>
                <span class="discount-percent" v-if="discountAmount > 0">
                  ({{ discountPercentage.toFixed(1) }}%)
                </span>
              </div>
            </div>
            <div class="amount-field screenshot-field">
              <span class="field-label">ÂÆöÈáëÊà™Âõæ</span>
              <div class="screenshot-buttons">
                <el-button type="primary" size="small" :icon="Upload" @click="triggerUpload">
                  ‰∏ä‰º†Êà™Âõæ
                </el-button>
                <el-button type="success" size="small" :icon="DocumentCopy" @click="pasteImage">
                  Á≤òË¥¥ÂõæÁâá
                </el-button>
              </div>
              <div class="screenshot-content">
                <!-- ÂõæÁâáÁº©Áï•ÂõæÂàóË°® -->
                <div class="screenshot-thumbnails" v-if="depositScreenshots.length > 0">
                  <div 
                    v-for="(screenshot, index) in depositScreenshots" 
                    :key="index"
                    class="thumbnail-item"
                    @mouseenter="showZoomIcon = index"
                    @mouseleave="showZoomIcon = -1"
                    @click="previewImage(screenshot)"
                  >
                    <img :src="screenshot" alt="ÂÆöÈáëÊà™Âõæ" />
                    <!-- ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊîæÂ§ßÂõæÊ†á -->
                    <div class="thumbnail-overlay" v-show="showZoomIcon === index">
                      <el-icon class="zoom-icon"><ZoomIn /></el-icon>
                    </div>
                    <!-- Âà†Èô§ÂõæÊ†á -->
                    <div class="thumbnail-delete" @click.stop="removeScreenshot(index)">
                      <el-icon><Delete /></el-icon>
                    </div>
                  </div>
                </div>
              </div>
              
              <input
                ref="fileInput"
                type="file"
                accept="image/*"
                multiple
                style="display: none"
                @change="handleFileSelect"
              />
            </div>
          </div>
        </div>



        <!-- ËÆ¢ÂçïÊ†áËÆ∞ -->
        <div class="mark-section">
          <h4>ËÆ¢ÂçïÊ†áËÆ∞</h4>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ËÆ¢ÂçïÁ±ªÂûã" prop="markType" required>
                <el-radio-group v-model="orderForm.markType" @change="handleMarkTypeChange">
                  <el-radio value="normal">
                    <el-tag type="success" size="small">Ê≠£Â∏∏ÂèëË¥ßÂçï</el-tag>
                  </el-radio>
                  <el-radio value="reserved">
                    <el-tag type="warning" size="small">È¢ÑÁïôÂçï</el-tag>
                  </el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <div class="mark-description">
                <el-alert
                  v-if="orderForm.markType === 'reserved'"
                  title="È¢ÑÁïôÂçïËØ¥Êòé"
                  description="È¢ÑÁïôÂçïÂ∞Ü‰øùÁïôÂú®‰∏ãÂçï‰∫∫Â§ÑÔºå‰∏ç‰ºöÊµÅËΩ¨Âà∞ÂÆ°Ê†∏Âëò„ÄÇÈúÄË¶Å‰øÆÊîπ‰∏∫Ê≠£Â∏∏ÂèëË¥ßÂçïÂêéÊâç‰ºöËøõÂÖ•ÂÆ°Ê†∏ÊµÅÁ®ã„ÄÇ"
                  type="warning"
                  :closable="false"
                  show-icon
                />
                <el-alert
                  v-else
                  title="Ê≠£Â∏∏ÂèëË¥ßÂçï"
                  description="ËÆ¢ÂçïÂ∞ÜÊåâÊ≠£Â∏∏ÊµÅÁ®ãËøõË°åÂÆ°Ê†∏ÂíåÂèëË¥ßÂ§ÑÁêÜ„ÄÇ"
                  type="success"
                  :closable="false"
                  show-icon
                />
              </div>
            </el-col>
          </el-row>
        </div>

        <!-- Â§áÊ≥®‰ø°ÊÅØ -->
        <div class="remark-section">
          <el-form-item label="ËÆ¢ÂçïÂ§áÊ≥®">
            <el-input
              v-model="orderForm.remark"
              type="textarea"
              :rows="3"
              placeholder="ËØ∑ËæìÂÖ•ËÆ¢ÂçïÂ§áÊ≥®‰ø°ÊÅØ"
            />
          </el-form-item>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="form-footer">
          <el-button @click="handleCancel" size="large">ÂèñÊ∂à</el-button>
          <el-button @click="handleSaveOrder" type="primary" size="large" :loading="saving">
            ‰øùÂ≠òËÆ¢Âçï
          </el-button>
        </div>
      </el-card>
    </el-form>

    <!-- ËÆ¢ÂçïÁ°ÆËÆ§ÂºπÁ™ó -->
    <el-dialog
      v-model="confirmDialogVisible"
      title="ËÆ¢ÂçïÁ°ÆËÆ§"
      width="600px"
      :before-close="handleCloseConfirm"
    >
      <div class="order-confirm">
        <h4>ËØ∑Á°ÆËÆ§‰ª•‰∏ãËÆ¢Âçï‰ø°ÊÅØÔºö</h4>
        
        <div class="confirm-section customer-info">
          <h5>ÂÆ¢Êà∑‰ø°ÊÅØ</h5>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">ÂÆ¢Êà∑Ôºö</span>
              <span class="value">{{ selectedCustomer?.name }}</span>
            </div>
            <div class="info-item">
              <span class="label">ÁîµËØùÔºö</span>
              <span class="value">{{ selectedCustomer?.phone ? displaySensitiveInfoNew(selectedCustomer.phone, SensitiveInfoType.PHONE, userStore.currentUser?.id || '') : '' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Êî∂Ë¥ß‰∫∫Ôºö</span>
              <span class="value">{{ orderForm.receiverName }}</span>
            </div>
            <div class="info-item">
              <span class="label">Êî∂Ë¥ßÂú∞ÂùÄÔºö</span>
              <span class="value">{{ orderForm.receiverAddress }}</span>
            </div>
            <div class="info-item">
              <span class="label">Âø´ÈÄíÂÖ¨Âè∏Ôºö</span>
              <span class="value">{{ getExpressCompanyText(orderForm.expressCompany) }}</span>
            </div>
          </div>
        </div>

        <div class="confirm-section order-mark">
          <h5>ËÆ¢ÂçïÊ†áËÆ∞</h5>
          <div class="mark-content">
            <div class="mark-item">
              <span class="label">ËÆ¢ÂçïÁ±ªÂûãÔºö</span>
              <el-tag 
                :type="orderForm.markType === 'normal' ? 'success' : 'warning'" 
                size="small"
              >
                {{ orderForm.markType === 'normal' ? 'Ê≠£Â∏∏ÂèëË¥ßÂçï' : 'È¢ÑÁïôÂçï' }}
              </el-tag>
            </div>
            <div v-if="orderForm.markType === 'reserved'" class="mark-note">
              * È¢ÑÁïôÂçïÂ∞Ü‰øùÁïôÂú®ÊÇ®Â§ÑÔºå‰∏ç‰ºöÊµÅËΩ¨Âà∞ÂÆ°Ê†∏Âëò
            </div>
          </div>
        </div>

        <div class="confirm-section amount-info">
          <h5>ÈáëÈ¢ùÊ±áÊÄª</h5>
          <div class="amount-summary-two-columns">
            <!-- Á¨¨‰∏ÄÂàóÔºöÂü∫Á°ÄÈáëÈ¢ù‰ø°ÊÅØ -->
            <div class="amount-column basic-amounts">
              <div class="amount-item">
                <span class="label">ÂïÜÂìÅÂ∞èËÆ°</span>
                <span class="value">¬•{{ subtotal.toFixed(2) }}</span>
              </div>
              <div class="amount-item">
                <span class="label">‰ºòÊÉ†ÈáëÈ¢ù</span>
                <div class="discount-info">
                  <span class="value discount">¬•{{ discountAmount.toFixed(2) }}</span>
                  <span class="discount-percent" v-if="discountAmount > 0">
                    ({{ discountPercentage.toFixed(1) }}%)
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Á¨¨‰∫åÂàóÔºöÈáçË¶ÅÈáëÈ¢ù‰ø°ÊÅØÔºàÂ∏¶È¢úËâ≤Ê†áËØÜÔºâ -->
            <div class="amount-column important-amounts">
              <div class="amount-item highlight total-amount">
                <span class="label">ËÆ¢ÂçïÊÄªÈ¢ù</span>
                <span class="value">¬•{{ (orderForm.totalAmount || 0).toFixed(2) }}</span>
              </div>
              <div class="amount-item highlight deposit-amount">
                <span class="label">ÂÆöÈáë</span>
                <span class="value">¬•{{ (orderForm.depositAmount || 0).toFixed(2) }}</span>
              </div>
              <div class="amount-item highlight collect-amount">
                <span class="label">‰ª£Êî∂ÈáëÈ¢ù</span>
                <span class="value">¬•{{ collectAmount.toFixed(2) }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="confirm-section product-info">
          <h5>ÂïÜÂìÅ‰ø°ÊÅØ</h5>
          <el-table :data="orderForm.products" size="small">
            <el-table-column prop="name" label="ÂïÜÂìÅÂêçÁß∞" />
            <el-table-column prop="price" label="Âçï‰ª∑" width="80">
              <template #default="{ row }">¬•{{ row.price }}</template>
            </el-table-column>
            <el-table-column prop="quantity" label="Êï∞Èáè" width="60" />
            <el-table-column label="Â∞èËÆ°" width="80">
              <template #default="{ row }">¬•{{ ((row.price || 0) * (row.quantity || 0)).toFixed(2) }}</template>
            </el-table-column>
          </el-table>
        </div>
      </div>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="confirmDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="handleSubmitOrder" :loading="submitting">
            Á°ÆËÆ§Êèê‰∫§ÂÆ°Ê†∏
          </el-button>
        </span>
      </template>
    </el-dialog>

    <!-- Êñ∞Â¢ûÊâãÊú∫Âè∑ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showAddPhoneDialog"
      title="Êñ∞Â¢ûÊâãÊú∫Âè∑"
      width="400px"
      :before-close="handleCloseAddPhoneDialog"
    >
      <el-form
        ref="addPhoneFormRef"
        :model="addPhoneForm"
        :rules="addPhoneRules"
        label-width="80px"
      >
        <el-form-item label="ÊâãÊú∫Âè∑" prop="phone">
          <el-input
            v-model="addPhoneForm.phone"
            placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑"
            clearable
          />
        </el-form-item>
        <el-form-item label="Â§áÊ≥®" prop="remark">
          <el-input
            v-model="addPhoneForm.remark"
            placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®ÔºàÂèØÈÄâÔºâ"
            clearable
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="handleCloseAddPhoneDialog">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="handleAddPhone" :loading="addingPhone">
            Á°ÆËÆ§Ê∑ªÂä†
          </el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ÂõæÁâáÊü•ÁúãÂô® -->
    <el-image-viewer
      v-if="showImageViewer"
      :url-list="currentImageList"
      @close="showImageViewer = false"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage, ElMessageBox, ElImageViewer } from 'element-plus'
import { 
  User, Message, Location, ShoppingBag, Search, Plus, 
  Delete, Money, Upload, Check, DocumentCopy, ZoomIn, Refresh, View 
} from '@element-plus/icons-vue'
import { useOrderStore } from '@/stores/order'
import { useCustomerStore } from '@/stores/customer'
import { useUserStore } from '@/stores/user'
import { useNotificationStore } from '@/stores/notification'
import { useConfigStore } from '@/stores/config'
import { useProductStore } from '@/stores/product'
import { maskPhone } from '@/utils/phone'
import { displaySensitiveInfo as displaySensitiveInfoNew } from '@/utils/sensitiveInfo'
import { SensitiveInfoType } from '@/services/permission'
import { createSafeNavigator } from '@/utils/navigation'

// Êé•Âè£ÂÆö‰πâ
interface Product {
  id: string
  name: string
  code: string
  price: number
  originalPrice: number
  stock: number
  category: string
  image: string
  isHot: boolean
}

interface OrderProduct extends Product {
  quantity: number
  total: number
}

interface Customer {
  id: string
  name: string
  phone: string
  address: string
  age: number
  level: 'normal' | 'vip' | 'premium'
  salesPersonId: string
  orderCount: number
  createTime: string
  createdBy: string
}

interface CustomerPhone {
  id: number
  number: string
  remark: string
  isDefault: boolean
}

interface OrderForm {
  customerId: string
  serviceWechat: string
  orderSource: string
  receiverName: string
  receiverPhone: string
  receiverAddress: string
  expressCompany: string
  products: OrderProduct[]
  discount: number
  totalAmount: number
  depositAmount: number
  depositScreenshot: string
  markType: string
  remark: string
}

interface AddPhoneForm {
  phone: string
  remark: string
}

interface UploadOptions {
  file: File
  onSuccess: (response: UploadResponse) => void
  onError: (error: Error) => void
}

interface UploadResponse {
  url: string
}

const router = useRouter()
const route = useRoute()
const safeNavigator = createSafeNavigator(router)
const orderStore = useOrderStore()
const customerStore = useCustomerStore()
const userStore = useUserStore()
const notificationStore = useNotificationStore()
const configStore = useConfigStore()
const productStore = useProductStore()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const orderFormRef = ref()
const customerLoading = ref(false)
const loading = ref(false) // ‰∫ßÂìÅÂà∑Êñ∞Âä†ËΩΩÁä∂ÊÄÅ
const saving = ref(false)
const submitting = ref(false)
const confirmDialogVisible = ref(false)
const isEdit = ref(false)
const productSearchKeyword = ref('')

// ÂõæÁâáÊü•ÁúãÂô®
const showImageViewer = ref(false)
const currentImageList = ref<string[]>([])

// ÂÆ¢Êà∑ÈÄâÈ°π
const customerOptions = computed(() => customerStore.customers)

// ‰∫ßÂìÅÂàóË°® - ‰ªéproductStoreËé∑ÂèñÔºåÂè™ÊòæÁ§∫ÊúâÂ∫ìÂ≠òÁöÑ‰∏äÊû∂Âú®ÂîÆ‰∫ßÂìÅ
const productList = computed(() => {
  return productStore.products.filter(product => 
    product.status === 'active' && 
    !product.isDeleted && 
    product.stock > 0
  ).map(product => ({
    id: product.id,
    name: product.name,
    code: product.code,
    price: product.price,
    originalPrice: product.originalPrice,
    stock: product.stock,
    category: product.category,
    image: product.image,
    isHot: product.isHot
  }))
})

// ÈÄâ‰∏≠ÁöÑÂÆ¢Êà∑
const selectedCustomer = ref<Customer | null>(null)

// ÂÆ¢Êà∑ÊâãÊú∫Âè∑ÂàóË°®
const customerPhones = ref<CustomerPhone[]>([])

// Êñ∞Â¢ûÊâãÊú∫Âè∑ÂØπËØùÊ°Ü
const showAddPhoneDialog = ref(false)
const addPhoneFormRef = ref()
const addingPhone = ref(false)

// Êñ∞Â¢ûÊâãÊú∫Âè∑Ë°®Âçï
const addPhoneForm = reactive<AddPhoneForm>({
  phone: '',
  remark: ''
})

// Êñ∞Â¢ûÊâãÊú∫Âè∑Ë°®ÂçïÈ™åËØÅËßÑÂàô
const addPhoneRules = {
  phone: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑', trigger: 'blur' },
    { pattern: /^1[3-9]\d{9}$/, message: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Ê†ºÂºè', trigger: 'blur' }
  ]
}

// ËÆ¢ÂçïË°®ÂçïÊï∞ÊçÆ
const orderForm = reactive<OrderForm>({
  customerId: '',
  serviceWechat: '',
  orderSource: '',
  receiverName: '',
  receiverPhone: '',
  receiverAddress: '',
  expressCompany: '',
  products: [] as OrderProduct[],
  discount: 0,
  totalAmount: 0,
  depositAmount: 0,
  depositScreenshot: '',
  markType: 'normal',
  remark: ''
})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const formRules = {
  customerId: [{ required: true, message: 'ËØ∑ÈÄâÊã©ÂÆ¢Êà∑', trigger: 'change' }],
  serviceWechat: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÂÆ¢ÊúçÂæÆ‰ø°Âè∑', trigger: 'blur' }],
  orderSource: [{ required: true, message: 'ËØ∑ÈÄâÊã©ËÆ¢ÂçïÊù•Ê∫ê', trigger: 'change' }],
  expressCompany: [{ required: true, message: 'ËØ∑ÈÄâÊã©Âø´ÈÄíÂÖ¨Âè∏', trigger: 'change' }],
  receiverName: [{ required: true, message: 'ËØ∑ËæìÂÖ•Êî∂Ë¥ß‰∫∫ÂßìÂêç', trigger: 'blur' }],
  receiverPhone: [{ required: true, message: 'ËØ∑ËæìÂÖ•Êî∂Ë¥ß‰∫∫ÁîµËØù', trigger: 'blur' }],
  receiverAddress: [{ required: true, message: 'ËØ∑ËæìÂÖ•Êî∂Ë¥ßÂú∞ÂùÄ', trigger: 'blur' }],
  markType: [{ required: true, message: 'ËØ∑ÈÄâÊã©ËÆ¢ÂçïÁ±ªÂûã', trigger: 'change' }]
}

// Â§öÂº†ÂÆöÈáëÊà™Âõæ
const depositScreenshots = ref<string[]>([])

// ÊéßÂà∂ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊîæÂ§ßÂõæÊ†á
const showZoomIcon = ref(-1)

// Ê†πÊçÆÁî®Êà∑ËßíËâ≤Ëé∑ÂèñÊúÄÂ§ß‰ºòÊÉ†ÊØî‰æã
const maxDiscountRate = computed(() => {
  const userRole = userStore.currentUser?.role || 'employee'
  // Â∞ÜÁî®Êà∑ËßíËâ≤Êò†Â∞ÑÂà∞ÈÖçÁΩÆstoreÊúüÊúõÁöÑËßíËâ≤
  const mappedRole = userRole === 'employee' ? 'sales' : userRole
  return configStore.getMaxDiscountForRole(mappedRole) / 100
})

// Ê†áËÆ∞Áî®Êà∑ÊòØÂê¶ÊâãÂä®‰øÆÊîπËøáËÆ¢ÂçïÊÄªÈ¢ù
const isManuallyModified = ref(false)

// ËÆ°ÁÆóÂ±ûÊÄß
const subtotal = computed(() => {
  return orderForm.products.reduce((sum, product) => {
    return sum + ((product.price || 0) * (product.quantity || 0))
  }, 0)
})

const collectAmount = computed(() => {
  return (orderForm.totalAmount || 0) - (orderForm.depositAmount || 0)
})

// ‰ºòÊÉ†ÈáëÈ¢ù = ÂïÜÂìÅÂ∞èËÆ° - ËÆ¢ÂçïÊÄªÈ¢ù
const discountAmount = computed(() => {
  return subtotal.value - (orderForm.totalAmount || 0)
})

// ‰ºòÊÉ†ÊØî‰æã
const discountPercentage = computed(() => {
  if (subtotal.value === 0) return 0
  return (discountAmount.value / subtotal.value) * 100
})

const filteredProducts = computed(() => {
  if (!productSearchKeyword.value) {
    return productList.value
  }
  return productList.value.filter(product => 
    product.name.toLowerCase().includes(productSearchKeyword.value.toLowerCase())
  )
})

// ‰∏ä‰º†ÈÖçÁΩÆ
const uploadAction = ref('')

// ÊñπÊ≥ï
const handleUpload = (options: UploadOptions) => {
  const { file, onSuccess, onError } = options
  
  // Ê®°Êãü‰∏ä‰º†ËøáÁ®ã
  const formData = new FormData()
  formData.append('file', file)
  
  // Ê®°ÊãüÂºÇÊ≠•‰∏ä‰º†
  setTimeout(() => {
    try {
      // ÂàõÂª∫Êú¨Âú∞È¢ÑËßàURL
      const url = URL.createObjectURL(file)
      onSuccess({ url })
    } catch (error) {
      onError(error as Error)
    }
  }, 1000)
}

const searchCustomers = (query: string) => {
  if (query) {
    customerLoading.value = true
    // Ê®°ÊãüÊêúÁ¥¢
    setTimeout(() => {
      customerLoading.value = false
    }, 300)
  }
}

const handleCustomerChange = (customerId: string) => {
  const customer = customerOptions.value.find(c => c.id === customerId)
  if (customer) {
    selectedCustomer.value = customer
    // ÂêåÊ≠•Êî∂Ë¥ß‰ø°ÊÅØ
    orderForm.receiverName = customer.name
    orderForm.receiverAddress = customer.address
    
    // Âä†ËΩΩÂÆ¢Êà∑ÊâãÊú∫Âè∑ÂàóË°®
    loadCustomerPhones(customerId)
  }
}

// Âä†ËΩΩÂÆ¢Êà∑ÊâãÊú∫Âè∑ÂàóË°®
const loadCustomerPhones = async (customerId: string) => {
  try {
    // Ê®°ÊãüAPIË∞ÉÁî®
    const phones = [
      { id: 1, number: selectedCustomer.value?.phone || '', remark: 'ÈªòËÆ§ÊâãÊú∫Âè∑', isDefault: true }
    ]
    customerPhones.value = phones
    
    // ËÆæÁΩÆÈªòËÆ§ÊâãÊú∫Âè∑
    if (phones.length > 0) {
      orderForm.receiverPhone = phones[0].number
    }
  } catch (error) {
    ElMessage.error('Âä†ËΩΩÂÆ¢Êà∑ÊâãÊú∫Âè∑Â§±Ë¥•')
  }
}

// Êñ∞Â¢ûÊâãÊú∫Âè∑Áõ∏ÂÖ≥ÊñπÊ≥ï
const handleAddPhone = async () => {
  try {
    await addPhoneFormRef.value.validate()
    addingPhone.value = true
    
    // Ê®°ÊãüAPIË∞ÉÁî®
    setTimeout(() => {
      const newPhone = {
        id: Date.now(),
        number: addPhoneForm.phone,
        remark: addPhoneForm.remark || 'Êñ∞Â¢ûÊâãÊú∫Âè∑',
        isDefault: false
      }
      
      customerPhones.value.push(newPhone)
      
      // ÈáçÁΩÆË°®Âçï
      addPhoneForm.phone = ''
      addPhoneForm.remark = ''
      showAddPhoneDialog.value = false
      addingPhone.value = false
      
      ElMessage.success('ÊâãÊú∫Âè∑Ê∑ªÂä†ÊàêÂäü')
    }, 1000)
  } catch (error) {
    addingPhone.value = false
  }
}

const handleCloseAddPhoneDialog = () => {
  addPhoneForm.phone = ''
  addPhoneForm.remark = ''
  showAddPhoneDialog.value = false
}

const syncCustomerAddress = () => {
  if (selectedCustomer.value) {
    orderForm.receiverAddress = selectedCustomer.value.address
    ElMessage.success('Â∑≤ÂêåÊ≠•ÂÆ¢Êà∑Âú∞ÂùÄ')
  }
}

const handleProductSearch = () => {
  // ‰∫ßÂìÅÊêúÁ¥¢ÈÄªËæë
}

const handleRefreshProducts = async () => {
  try {
    loading.value = true
    await productStore.refreshProducts() // ‰ªéAPIÂà∑Êñ∞Âú®ÂîÆ‰∫ßÂìÅÊï∞ÊçÆ
    ElMessage.success('ÂïÜÂìÅÂàóË°®Â∑≤Âà∑Êñ∞ÔºåÂ∑≤ÂêåÊ≠•Âú®ÂîÆ‰∫ßÂìÅ')
  } catch (error) {
    ElMessage.error('Âà∑Êñ∞ÂïÜÂìÅÂàóË°®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•')
    console.error('Âà∑Êñ∞ÂïÜÂìÅÂ§±Ë¥•:', error)
  } finally {
    loading.value = false
  }
}

const addProduct = (product: Product) => {
  const existingProduct = orderForm.products.find(p => p.id === product.id)
  if (existingProduct) {
    if (existingProduct.quantity < product.stock) {
      existingProduct.quantity++
      existingProduct.total = existingProduct.price * existingProduct.quantity
      calculateTotal()
      ElMessage.success(`${product.name} Êï∞ÈáèÂ∑≤Â¢ûÂä†`)
    } else {
      ElMessage.warning('Â∫ìÂ≠ò‰∏çË∂≥')
    }
  } else {
    orderForm.products.push({
      ...product,
      quantity: 1,
      total: product.price * 1
    })
    calculateTotal()
    ElMessage.success(`${product.name} Â∑≤Ê∑ªÂä†Âà∞ËÆ¢Âçï`)
  }
}

const viewProductDetail = (product: Product) => {
  // Ë∑≥ËΩ¨Âà∞ÂïÜÂìÅËØ¶ÊÉÖÈ°µ
  safeNavigator.push(`/product/detail/${product.id}`)
}

const removeProduct = (index: number) => {
  const product = orderForm.products[index]
  orderForm.products.splice(index, 1)
  calculateTotal()
  ElMessage.success(`${product.name} Â∑≤‰ªéËÆ¢Âçï‰∏≠ÁßªÈô§`)
}

const calculateTotal = () => {
  // Êõ¥Êñ∞ÊØè‰∏™‰∫ßÂìÅÁöÑtotalÂ≠óÊÆµ
  orderForm.products.forEach(product => {
    product.total = product.price * product.quantity
  })
  
  // Âè™ÊúâÂú®Áî®Êà∑Ê≤°ÊúâÊâãÂä®‰øÆÊîπËøáËÆ¢ÂçïÊÄªÈ¢ùÊó∂ÔºåÊâçËá™Âä®ÂêåÊ≠•ÂïÜÂìÅÂ∞èËÆ°
  if (!isManuallyModified.value) {
    orderForm.totalAmount = subtotal.value
  }
}

const calculateCollectAmount = () => {
  // ‰ª£Êî∂ÈáëÈ¢ùËÆ°ÁÆóÁöÑÈÄªËæëÂ∑≤Âú®ËÆ°ÁÆóÂ±ûÊÄß‰∏≠ÂÆûÁé∞
}

// Â§ÑÁêÜËÆ¢ÂçïÊÄªÈ¢ùÂèòÂåñ
const handleTotalAmountChange = (value: number) => {
  // Ê†áËÆ∞Áî®Êà∑ÊâãÂä®‰øÆÊîπ‰∫ÜËÆ¢ÂçïÊÄªÈ¢ù
  isManuallyModified.value = true
  
  // È™åËØÅËÆ¢ÂçïÊÄªÈ¢ù‰∏çËÉΩË∂ÖËøáÂïÜÂìÅÂ∞èËÆ°
  if (value > subtotal.value) {
    ElMessage.warning('ËÆ¢ÂçïÊÄªÈ¢ù‰∏çËÉΩË∂ÖËøáÂïÜÂìÅÂ∞èËÆ°')
    orderForm.totalAmount = subtotal.value
    return
  }
  
  // È™åËØÅËÆ¢ÂçïÊÄªÈ¢ù‰∏çËÉΩÂ∞è‰∫é0
  if (value < 0) {
    ElMessage.warning('ËÆ¢ÂçïÊÄªÈ¢ù‰∏çËÉΩÂ∞è‰∫é0')
    orderForm.totalAmount = 0
    return
  }
  
  // ËÆ°ÁÆóÊúÄ‰ΩéÂèØ‰ºòÊÉ†‰ª∑Ê†ºÔºàÂü∫‰∫éÁÆ°ÁêÜÂëòËÆæÁΩÆÁöÑ‰ºòÊÉ†ÊØî‰æãÔºâ
  const minAllowedAmount = subtotal.value * (1 - maxDiscountRate.value)
  
  // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøá‰ºòÊÉ†ÊØî‰æãÈôêÂà∂
  if (value < minAllowedAmount) {
    ElMessageBox.alert(
      `ËÆ¢ÂçïÊÄªÈ¢ù‰∏çËÉΩ‰Ωé‰∫é ¬•${minAllowedAmount.toFixed(2)}ÔºàÊúÄÂ§ß‰ºòÊÉ†${(maxDiscountRate.value * 100).toFixed(0)}%Ôºâ`,
      '‰ºòÊÉ†ÈôêÂà∂ÊèêÁ§∫',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        type: 'warning'
      }
    )
    orderForm.totalAmount = minAllowedAmount
    return
  }
  
  // Â¶ÇÊûúÂÆöÈáëÂ§ß‰∫éÊñ∞ÁöÑËÆ¢ÂçïÊÄªÈ¢ùÔºåËá™Âä®Ë∞ÉÊï¥ÂÆöÈáë
  if (orderForm.depositAmount > value) {
    orderForm.depositAmount = value
    ElMessage.info('ÂÆöÈáëÂ∑≤Ëá™Âä®Ë∞ÉÊï¥‰∏∫ËÆ¢ÂçïÊÄªÈ¢ù')
  }
  
  // ÂΩìÊâãÂä®‰øÆÊîπËÆ¢ÂçïÊÄªÈ¢ùÊó∂ÔºåÈáçÊñ∞ËÆ°ÁÆó‰ª£Êî∂ÈáëÈ¢ù
  calculateCollectAmount()
}

// ÈáçÁΩÆËÆ¢ÂçïÊÄªÈ¢ù‰∏∫ÂïÜÂìÅÂ∞èËÆ°ÔºåÈáçÊñ∞ÂêØÁî®Ëá™Âä®ÂêåÊ≠•
const resetToSubtotal = () => {
  isManuallyModified.value = false
  orderForm.totalAmount = subtotal.value
  ElMessage.success('ËÆ¢ÂçïÊÄªÈ¢ùÂ∑≤ÂêåÊ≠•‰∏∫ÂïÜÂìÅÂ∞èËÆ°')
}

// Êñá‰ª∂ËæìÂÖ•ÂºïÁî®
const fileInput = ref<HTMLInputElement>()

// Ëß¶ÂèëÊñá‰ª∂‰∏ä‰º†
const triggerUpload = () => {
  fileInput.value?.click()
}

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement
  const files = target.files
  if (files) {
    for (let i = 0; i < files.length; i++) {
      if (depositScreenshots.value.length >= 3) {
        ElMessage.warning('ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†3Âº†ÂõæÁâá')
        break
      }
      handleImageFile(files[i])
    }
    // Ê∏ÖÁ©∫inputÂÄºÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
    target.value = ''
  }
}

// Á≤òË¥¥ÂõæÁâáÂäüËÉΩ
const pasteImage = async () => {
  if (depositScreenshots.value.length >= 3) {
    ElMessage.warning('ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†3Âº†ÂõæÁâá')
    return
  }
  
  try {
    const clipboardItems = await navigator.clipboard.read()
    for (const clipboardItem of clipboardItems) {
      for (const type of clipboardItem.types) {
        if (type.startsWith('image/')) {
          const blob = await clipboardItem.getType(type)
          const file = new File([blob], 'pasted-image.png', { type })
          handleImageFile(file)
          return
        }
      }
    }
    ElMessage.warning('Ââ™Ë¥¥Êùø‰∏≠Ê≤°ÊúâÂõæÁâá')
  } catch (error) {
    ElMessage.error('Á≤òË¥¥ÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊùÉÈôê')
  }
}

// Â§ÑÁêÜÂõæÁâáÊñá‰ª∂
const handleImageFile = (file: File) => {
  if (!beforeUpload(file)) {
    return
  }
  
  if (depositScreenshots.value.length >= 3) {
    ElMessage.warning('ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†3Âº†ÂõæÁâá')
    return
  }
  
  // ÂàõÂª∫È¢ÑËßàURL
  const reader = new FileReader()
  reader.onload = (e) => {
    const imageUrl = e.target?.result as string
    depositScreenshots.value.push(imageUrl)
    // ÂêåÊó∂Êõ¥Êñ∞orderForm‰∏≠ÁöÑÂ≠óÊÆµÔºà‰øùÊåÅÂÖºÂÆπÊÄßÔºâ
    orderForm.depositScreenshot = depositScreenshots.value[0] || ''
    ElMessage.success('ÂõæÁâáÂ∑≤Ê∑ªÂä†')
  }
  reader.readAsDataURL(file)
}

// Âà†Èô§Êà™Âõæ
const removeScreenshot = (index: number) => {
  depositScreenshots.value.splice(index, 1)
  // Êõ¥Êñ∞orderForm‰∏≠ÁöÑÂ≠óÊÆµ
  orderForm.depositScreenshot = depositScreenshots.value[0] || ''
  ElMessage.success('ÂõæÁâáÂ∑≤Âà†Èô§')
}

// È¢ÑËßàÂõæÁâá
const previewImage = (imageUrl?: string) => {
  const url = imageUrl || orderForm.depositScreenshot
  if (url) {
    currentImageList.value = [url]
    showImageViewer.value = true
  }
}

const beforeUpload = (file: File) => {
  const isImage = file.type.startsWith('image/')
  const isLt2M = file.size / 1024 / 1024 < 2

  if (!isImage) {
    ElMessage.error('Âè™ËÉΩ‰∏ä‰º†ÂõæÁâáÊñá‰ª∂!')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 2MB!')
    return false
  }
  return true
}

const handleUploadSuccess = (response: UploadResponse) => {
  orderForm.depositScreenshot = response.url
  ElMessage.success('Êà™Âõæ‰∏ä‰º†ÊàêÂäü')
}

const handleUploadError = () => {
  ElMessage.error('Êà™Âõæ‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
}

const handleMarkTypeChange = (value: string) => {
  if (value === 'reserved') {
    ElMessage.info('Â∑≤ÈÄâÊã©È¢ÑÁïôÂçïÔºåËÆ¢ÂçïÂ∞Ü‰øùÁïôÂú®ÊÇ®Â§ÑÔºå‰∏ç‰ºöÊµÅËΩ¨Âà∞ÂÆ°Ê†∏Âëò')
  } else {
    ElMessage.info('Â∑≤ÈÄâÊã©Ê≠£Â∏∏ÂèëË¥ßÂçïÔºåËÆ¢ÂçïÂ∞ÜÊåâÊ≠£Â∏∏ÊµÅÁ®ãËøõË°åÂÆ°Ê†∏')
  }
}

const handleSaveOrder = async () => {
  try {
    await orderFormRef.value.validate()
    
    if (orderForm.products.length === 0) {
      ElMessage.warning('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÂïÜÂìÅ')
      return
    }

    confirmDialogVisible.value = true
  } catch (error) {
    ElMessage.error('ËØ∑ÂÆåÂñÑËÆ¢Âçï‰ø°ÊÅØ')
  }
}

const handleSubmitOrder = async () => {
  try {
    submitting.value = true
    
    // Ê£ÄÊü•Â∫ìÂ≠òÊòØÂê¶ÂÖÖË∂≥
    for (const product of orderForm.products) {
      const currentProduct = productStore.products.find(p => p.id === product.id)
      if (!currentProduct) {
        ElMessage.error(`ÂïÜÂìÅ ${product.name} ‰∏çÂ≠òÂú®`)
        return
      }
      if (currentProduct.stock < product.quantity) {
        ElMessage.error(`ÂïÜÂìÅ ${product.name} Â∫ìÂ≠ò‰∏çË∂≥ÔºåÂΩìÂâçÂ∫ìÂ≠òÔºö${currentProduct.stock}ÔºåÈúÄË¶ÅÔºö${product.quantity}`)
        return
      }
    }
    
    // ËÆ°ÁÆóËÆ¢ÂçïÈáëÈ¢ù
    const subtotal = orderForm.products.reduce((sum, product) => sum + (product.price * product.quantity || 0), 0)
    const totalAmount = subtotal - (orderForm.discount || 0)
    const collectAmount = totalAmount - (orderForm.depositAmount || 0)
    
    // ÊûÑÂª∫ËÆ¢ÂçïÊï∞ÊçÆ
    const orderData = {
      customerId: orderForm.customerId,
      customerName: selectedCustomer.value?.name || '',
      customerPhone: selectedCustomer.value?.phone || '',
      products: orderForm.products,
      subtotal: subtotal,
      discount: orderForm.discount,
      totalAmount: totalAmount,
      collectAmount: collectAmount,
      depositAmount: orderForm.depositAmount,
      depositScreenshot: orderForm.depositScreenshot,
      depositScreenshots: depositScreenshots.value.length > 0 ? depositScreenshots.value : undefined,
      receiverName: orderForm.receiverName,
      receiverPhone: orderForm.receiverPhone,
      receiverAddress: orderForm.receiverAddress,
      markType: orderForm.markType,
      remark: orderForm.remark,
      salesPersonId: userStore.user?.id || '1',
      createdBy: userStore.user?.name || 'Á≥ªÁªüÁî®Êà∑'
    }
    
    // ‰ΩøÁî®ËÆ¢ÂçïstoreÂàõÂª∫ËÆ¢Âçï
    const newOrder = await orderStore.createOrder(orderData)
    
    // ÂáèÂ∞ëÂïÜÂìÅÂ∫ìÂ≠ò
    for (const product of orderForm.products) {
      await productStore.updateProductStock(product.id, -product.quantity)
    }
    
    // Êõ¥Êñ∞ÂÆ¢Êà∑ÁªüËÆ°Êï∞ÊçÆ
    if (orderData.customerId) {
      customerStore.incrementOrderCount(orderData.customerId)
    }
    
    // ÂèëÈÄÅËÆ¢ÂçïÊèê‰∫§Ê∂àÊÅØÊèêÈÜí
    notificationStore.sendMessage(
      notificationStore.MessageType.ORDER_SUBMITTED,
      `Êñ∞ËÆ¢ÂçïÂ∑≤Êèê‰∫§ÔºöÂÆ¢Êà∑ ${orderData.customerName}ÔºåËÆ¢ÂçïÈáëÈ¢ù ¬•${totalAmount.toFixed(2)}`,
      {
        relatedId: newOrder?.id || Date.now().toString(),
        relatedType: 'order',
        actionUrl: `/order/detail/${newOrder?.id || Date.now().toString()}`
      }
    )
    
    // Ê†πÊçÆËÆ¢ÂçïÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÊèêÁ§∫‰ø°ÊÅØ
    if (orderData.markType === 'normal') {
      ElMessage.success('ËÆ¢ÂçïÂ∑≤Êèê‰∫§ÔºåËØ•ËÆ¢Âçï3ÂàÜÈíüÂêéÂ∞ÜÊµÅËΩ¨Ëá≥ÂÆ°Ê†∏')
    } else if (orderData.markType === 'reserved') {
      ElMessage.success('È¢ÑÁïôÂçïÂ∑≤‰øùÂ≠òÔºå‰ø°ÊÅØÂ∞Ü‰øùÁïôÂú®Á≥ªÁªü‰∏≠')
    } else {
      ElMessage.success('ËÆ¢ÂçïÂ∑≤Êèê‰∫§')
    }
    
    confirmDialogVisible.value = false
    
    // Ë∑≥ËΩ¨Âà∞ËÆ¢ÂçïÂàóË°®Âπ∂‰º†ÈÄíÂà∑Êñ∞ÂèÇÊï∞
    safeNavigator.push({
      path: '/order/list',
      query: { refresh: 'true', timestamp: Date.now().toString() }
    })
  } catch (error) {
    ElMessage.error('Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    submitting.value = false
  }
}

const handleCloseConfirm = () => {
  confirmDialogVisible.value = false
}

const handleCancel = () => {
  router.back()
}

// ËæÖÂä©ÊñπÊ≥ï
const getLevelType = (level: string) => {
  const types = {
    'vip': 'warning',
    'premium': 'danger',
    'normal': 'info'
  }
  return types[level] || 'info'
}

const getLevelText = (level: string) => {
  const texts = {
    'vip': 'VIPÂÆ¢Êà∑',
    'premium': 'È´òÁ∫ßÂÆ¢Êà∑',
    'normal': 'ÊôÆÈÄöÂÆ¢Êà∑'
  }
  return texts[level] || 'ÊôÆÈÄöÂÆ¢Êà∑'
}

const getExpressCompanyText = (code: string) => {
  const companies = {
    'sf': 'È°∫‰∏∞ÈÄüËøê',
    'yt': 'ÂúÜÈÄöÈÄüÈÄí',
    'zt': '‰∏≠ÈÄöÂø´ÈÄí',
    'st': 'Áî≥ÈÄöÂø´ÈÄí',
    'yd': 'ÈüµËææÈÄüÈÄí',
    'bs': 'Áôæ‰∏ñÂø´ÈÄí',
    'db': 'Âæ∑ÈÇ¶Âø´ÈÄí',
    'jd': '‰∫¨‰∏úÁâ©ÊµÅ'
  }
  return companies[code] || code
}

onMounted(async () => {
  // È¶ñÂÖàÂä†ËΩΩÂÆ¢Êà∑Êï∞ÊçÆ
  await customerStore.loadCustomers()
  
  // ÂàùÂßãÂåñÂïÜÂìÅÊï∞ÊçÆ
  if (productStore.products.length === 0) {
    productStore.initMockData()
  }
  
  // Ê£ÄÊü•ÊòØÂê¶Êúâ‰º†ÈÄíÁöÑÂÆ¢Êà∑‰ø°ÊÅØÂíåÂïÜÂìÅ‰ø°ÊÅØ
  const { customerId, customerName, customerPhone, customerAddress, productId } = route.query
  
  if (customerId) {
    // Êü•ÊâæÂÆ¢Êà∑‰ø°ÊÅØ
    let customerInfo = customerStore.customers.find(c => c.id === customerId)
    
    if (customerInfo) {
      // ‰ªéstore‰∏≠ÊâæÂà∞ÂÆ¢Êà∑Ôºå‰ΩøÁî®store‰∏≠ÁöÑÂÆåÊï¥‰ø°ÊÅØ
      orderForm.customerId = customerInfo.id
      orderForm.receiverName = customerInfo.name
      orderForm.receiverPhone = customerInfo.phone
      orderForm.receiverAddress = customerInfo.address || ''
      
      selectedCustomer.value = customerInfo
      
      ElMessage.success(`Â∑≤Ëá™Âä®ÈÄâÊã©ÂÆ¢Êà∑Ôºö${customerInfo.name}`)
    } else if (customerName && customerPhone) {
      // Â¶ÇÊûústore‰∏≠Êâæ‰∏çÂà∞‰ΩÜÊúâ‰º†ÈÄíÁöÑÂÆ¢Êà∑‰ø°ÊÅØÔºå‰ΩøÁî®‰º†ÈÄíÁöÑ‰ø°ÊÅØ
      orderForm.customerId = customerId as string
      orderForm.receiverName = customerName as string
      orderForm.receiverPhone = customerPhone as string
      orderForm.receiverAddress = customerAddress as string || ''
      
      // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÂÆ¢Êà∑ÂØπË±°
      customerInfo = {
        id: customerId as string,
        name: customerName as string,
        phone: customerPhone as string,
        address: customerAddress as string || '',
        age: 0,
        level: 'normal' as const,
        salesPersonId: '',
        orderCount: 0,
        createTime: '',
        createdBy: ''
      }
      
      selectedCustomer.value = customerInfo
      
      ElMessage.success(`Â∑≤Ëá™Âä®ÈÄâÊã©ÂÆ¢Êà∑Ôºö${customerName}`)
    } else {
      // Âè™ÊúâcustomerId‰ΩÜÊâæ‰∏çÂà∞ÂÆ¢Êà∑‰ø°ÊÅØ
      ElMessage.warning('Êú™ÊâæÂà∞ÊåáÂÆöÁöÑÂÆ¢Êà∑‰ø°ÊÅØÔºåËØ∑ÊâãÂä®ÈÄâÊã©ÂÆ¢Êà∑')
    }
  }
  
  // Ê£ÄÊü•ÊòØÂê¶Êúâ‰º†ÈÄíÁöÑÂïÜÂìÅ‰ø°ÊÅØ
  if (productId) {
    // Êü•ÊâæÂïÜÂìÅ‰ø°ÊÅØ
    const product = productStore.products.find(p => p.id === productId)
    
    if (product) {
      // Ëá™Âä®Ê∑ªÂä†ÂïÜÂìÅÂà∞ËÆ¢Âçï
      const productToAdd = {
        id: product.id,
        name: product.name,
        price: product.price,
        quantity: 1,
        total: product.price
      }
      
      orderForm.products.push(productToAdd)
      
      ElMessage.success(`Â∑≤Ëá™Âä®Ê∑ªÂä†ÂïÜÂìÅÔºö${product.name}`)
    } else {
      ElMessage.warning('Êú™ÊâæÂà∞ÊåáÂÆöÁöÑÂïÜÂìÅ‰ø°ÊÅØ')
    }
  }
})
</script>

<style scoped>
.order-form {
  padding: 20px;
  width: 100%;
  margin: 0;
}

.page-header {
  margin-bottom: 20px;
}

.page-header h2 {
  margin: 0;
  color: #303133;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 600;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.customer-card,
.product-card,
.summary-card {
  margin-bottom: 20px;
}

.delivery-info {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
}

.delivery-info h4 {
  margin: 0 0 16px 0;
  color: #606266;
}

.product-search {
  margin-bottom: 20px;
}

.product-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  max-height: 400px;
  overflow-y: auto;
}

.product-item {
  border: 1px solid #ebeef5;
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.product-item:hover {
  border-color: #409eff;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
}

.product-image {
  width: 100%;
  height: 120px;
  margin-bottom: 8px;
  border-radius: 4px;
  overflow: hidden;
  background: #f5f7fa;
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.product-info {
  text-align: center;
  margin-bottom: 8px;
}

.product-name {
  font-weight: 600;
  margin-bottom: 4px;
  color: #303133;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
  height: 2.8em; /* 2Ë°åÁöÑÈ´òÂ∫¶ */
}

.product-price {
  color: #f56c6c;
  font-weight: 600;
  font-size: 16px;
}

.product-stock {
  color: #909399;
  font-size: 12px;
}

.product-actions {
  text-align: center;
  display: flex;
  gap: 8px;
  justify-content: center;
}

.selected-products {
  margin-bottom: 20px;
}

.selected-products h4 {
  margin: 0 0 16px 0;
  color: #606266;
}

.amount-calculation {
  margin: 20px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
}

.amount-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.amount-item label {
  font-weight: 600;
  color: #606266;
}

.amount-value {
  font-size: 18px;
  color: #303133;
}

.total-amount {
  font-size: 20px;
  font-weight: 600;
  color: #f56c6c;
}

.collect-amount {
  font-size: 18px;
  font-weight: 600;
  color: #67c23a;
}

.deposit-section,
.mark-section,
.remark-section {
  margin: 20px 0;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
}

.deposit-section h4,
.mark-section h4 {
  margin: 0 0 16px 0;
  color: #606266;
}

.deposit-upload {
  width: 100%;
}

.upload-success {
  display: flex;
  align-items: center;
  gap: 4px;
  color: #67c23a;
  margin-top: 8px;
}

.screenshot-preview {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
  margin-left: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.screenshot-preview:hover {
  border-color: #409eff;
  transform: scale(1.05);
}

.mark-section .el-radio {
  margin-right: 20px;
  margin-bottom: 12px;
}

.mark-section .el-radio__label {
  padding-left: 8px;
}

.mark-description {
  margin-top: 8px;
}

.mark-description .el-alert {
  border-radius: 6px;
}

.form-footer {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
}

.order-confirm {
  max-height: 500px;
  overflow-y: auto;
  padding: 8px;
}

.order-confirm h4 {
  margin: 0 0 20px 0;
  color: #303133;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  padding-bottom: 12px;
  border-bottom: 2px solid #f0f2f5;
}

.confirm-section {
  margin-bottom: 16px;
  padding: 16px;
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  border-radius: 12px;
  border: 1px solid rgba(0, 0, 0, 0.06);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  transition: all 0.2s ease;
}

.confirm-section:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.confirm-section:last-child {
  margin-bottom: 0;
}

.confirm-section h5 {
  margin: 0 0 12px 0;
  color: #1f2937;
  font-weight: 600;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.confirm-section h5::before {
  content: '';
  width: 4px;
  height: 16px;
  background: linear-gradient(135deg, #409eff, #67c23a);
  border-radius: 2px;
}

.confirm-section p {
  margin: 6px 0;
  color: #4b5563;
  font-size: 13px;
  line-height: 1.5;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.confirm-section p strong {
  color: #374151;
  font-weight: 500;
  min-width: 80px;
}

/* Á°ÆËÆ§ÂºπÁ™ó‰∏≠ÁöÑË°®Ê†ºÊ†∑Âºè */
.confirm-section .el-table {
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e5e7eb;
}

.confirm-section .el-table th {
  background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
  color: #374151;
  font-weight: 600;
  font-size: 12px;
  border-bottom: 1px solid #d1d5db;
}

.confirm-section .el-table td {
  border-bottom: 1px solid #f3f4f6;
  font-size: 12px;
  color: #4b5563;
}

.confirm-section .el-table tr:hover td {
  background-color: #f8fafc;
}

/* ‰ø°ÊÅØÁΩëÊ†ºÂ∏ÉÂ±Ä */
.info-grid {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.info-item {
  display: flex;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid #f3f4f6;
}

.info-item:last-child {
  border-bottom: none;
}

.info-item .label {
  color: #6b7280;
  font-weight: 500;
  min-width: 80px;
  font-size: 13px;
}

.info-item .value {
  color: #374151;
  font-weight: 400;
  flex: 1;
  font-size: 13px;
}

/* ËÆ¢ÂçïÊ†áËÆ∞Ê†∑Âºè */
.mark-content {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.mark-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.mark-note {
  color: #e6a23c;
  font-size: 12px;
  font-style: italic;
  padding: 6px 12px;
  background: #fef3c7;
  border-radius: 4px;
  border-left: 3px solid #f59e0b;
}

/* ÁÆÄÁ∫¶Áé∞‰ª£ÂåñÈáëÈ¢ùÊ±áÊÄªÊ†∑Âºè */
.amount-summary-modern {
  margin-top: 24px;
  padding: 32px;
  background: #ffffff;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}

.amount-row {
  display: flex;
  align-items: center;
  margin-bottom: 24px;
  gap: 2%;
  flex-wrap: nowrap;
}

.amount-row:last-child {
  margin-bottom: 0;
}

.amount-field {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
}

.amount-field:nth-child(1) { /* ÂïÜÂìÅÂ∞èËÆ° */
  flex: 0 0 16%;
}

.amount-field:nth-child(2) { /* ËÆ¢ÂçïÊÄªÈ¢ù */
  flex: 0 0 18%;
}

.amount-field:nth-child(3) { /* ÂÆöÈáëÈáëÈ¢ù */
  flex: 0 0 16%;
}

.amount-field:nth-child(4) { /* Â∑≤Êî∂ÈáëÈ¢ù */
  flex: 0 0 14%;
}

.amount-field:nth-child(5) { /* ‰ºòÊÉ†ÈáëÈ¢ù */
  flex: 0 0 18%;
}

.screenshot-field { /* ÂÆöÈáëÊà™Âõæ - ÂåÖÂê´ÊåâÈíÆÂíåÁº©Áï•Âõæ */
  flex: 0 0 18% !important;
}

.field-label {
  font-size: 14px;
  font-weight: 500;
  color: #374151;
  white-space: nowrap;
  min-width: 60px;
  flex-shrink: 0;
}

.field-amount {
  font-size: 18px;
  font-weight: 700;
}

.field-amount.subtotal {
  color: #059669;
}

.field-amount.collect {
  color: #7c3aed;
}

.field-amount.discount {
  color: #ea580c;
}

.field-input {
  flex: 1;
  width: 100%;
}

.field-input .el-input-number {
  width: 100%;
}

.field-input .el-input-number .el-input__inner {
  font-size: 16px;
  font-weight: 600;
  text-align: right;
  padding-right: 12px;
  color: #1f2937;
}

.field-input .el-input-number:focus-within .el-input__inner {
  color: #3b82f6;
}

.sync-button {
  margin-left: 4px;
  padding: 2px 4px;
  color: #3b82f6;
  font-size: 12px;
}

.sync-button:hover {
  color: #2563eb;
  background-color: #eff6ff;
}

.discount-horizontal {
  display: flex;
  align-items: center;
  gap: 8px;
}

.discount-percent {
  font-size: 13px;
  color: #6b7280;
  font-weight: 500;
}

.screenshot-field {
  flex-direction: row;
  align-items: center;
  gap: 8px;
}

.screenshot-content {
  display: flex;
  align-items: center;
  min-height: 32px;
  flex: 1;
  margin-left: 8px;
}

.screenshot-buttons {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  margin-left: 8px;
}

.screenshot-buttons .el-button {
  padding: 4px 8px;
  font-size: 12px;
  height: 28px;
}

.screenshot-btn {
  height: 36px;
  font-size: 13px;
  border-radius: 8px;
}

.screenshot-thumbnails {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: nowrap;
}

.thumbnail-item {
  position: relative;
  width: 60px;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #e5e7eb;
  transition: all 0.2s ease;
  flex-shrink: 0;
  cursor: pointer;
}

.thumbnail-item:hover {
  border-color: #3b82f6;
  transform: scale(1.05);
}

.thumbnail-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumbnail-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.zoom-icon {
  color: white;
  font-size: 20px;
  cursor: pointer;
}

.thumbnail-delete {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 20px;
  height: 20px;
  background: #ef4444;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  font-size: 12px;
  transition: all 0.2s ease;
}

.thumbnail-delete:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.amount-row-first,
.amount-row-second {
  display: flex;
  gap: 24px;
  align-items: flex-start;
  margin-bottom: 20px;
}

.amount-row-second {
  margin-bottom: 0;
}

.amount-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.amount-label {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 4px;
}

.amount-value {
  font-size: 18px;
  font-weight: 700;
  color: #059669;
  padding: 8px 12px;
  background: rgba(5, 150, 105, 0.1);
  border-radius: 6px;
  border: 1px solid rgba(5, 150, 105, 0.2);
}

.amount-value.readonly {
  background: rgba(107, 114, 128, 0.1);
  color: #6b7280;
  border-color: rgba(107, 114, 128, 0.2);
}

.amount-input-wrapper {
  position: relative;
}

.amount-input {
  width: 100% !important;
}

.amount-highlight {
  margin-top: 4px;
  font-size: 16px;
  font-weight: 700;
  color: #dc2626;
  text-align: center;
  padding: 4px 8px;
  background: rgba(220, 38, 38, 0.1);
  border-radius: 4px;
  border: 1px solid rgba(220, 38, 38, 0.2);
}

.discount-controls {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.discount-input {
  width: 100% !important;
}

.discount-percentage {
  font-size: 12px;
  color: #f59e0b;
  font-weight: 600;
  text-align: center;
  padding: 2px 6px;
  background: rgba(245, 158, 11, 0.1);
  border-radius: 4px;
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.screenshot-controls {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.screenshot-controls .el-button {
  flex: 1;
  font-size: 12px;
}

.screenshot-thumbnail {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #e5e7eb;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
}

.screenshot-thumbnail:hover {
  border-color: #3b82f6;
  transform: scale(1.05);
}

.screenshot-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumbnail-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  color: white;
  font-size: 18px;
}

.screenshot-thumbnail:hover .thumbnail-overlay {
  opacity: 1;
}

/* Áé∞‰ª£ÂåñÈáëÈ¢ùÊ±áÊÄªÊ†∑Âºè */
.amount-summary-grid {
  margin-top: 20px;
  padding: 20px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.amount-row-main {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  justify-content: flex-start;
  flex-wrap: wrap;
}

.amount-card {
  flex: 1;
  min-width: 180px;
  max-width: 220px;
  padding: 20px 16px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.amount-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: inherit;
  opacity: 0.9;
  z-index: 1;
}

.amount-card > * {
  position: relative;
  z-index: 2;
}

.amount-card:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.amount-card.subtotal-card {
  background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
  color: white;
}

.amount-card.subtotal-card::after {
  content: 'üõí';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 18px;
  opacity: 0.7;
  z-index: 2;
}

.amount-card.total-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.amount-card.total-card::after {
  content: 'üí∞';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 18px;
  opacity: 0.7;
  z-index: 2;
}

.amount-card.collect-card {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
}

.amount-card.collect-card::after {
  content: 'üì¶';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 18px;
  opacity: 0.7;
  z-index: 2;
}

.amount-label {
  font-size: 13px;
  margin-bottom: 12px;
  opacity: 0.9;
  font-weight: 500;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.amount-value {
  font-size: 24px;
  font-weight: 700;
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.amount-row-detail {
  display: flex;
  gap: 32px;
  padding: 16px 20px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 8px;
  border: 1px solid rgba(228, 231, 237, 0.6);
  backdrop-filter: blur(10px);
  margin-top: 8px;
}

.discount-input-section {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.discount-display {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: rgba(245, 108, 108, 0.1);
  border-radius: 6px;
  border: 1px solid rgba(245, 108, 108, 0.3);
}

.discount-label {
  color: #f56c6c;
  font-size: 13px;
  font-weight: 500;
}

.discount-value {
  color: #f56c6c;
  font-weight: 600;
  font-size: 14px;
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.phone-management {
  display: flex;
  align-items: center;
  gap: 8px;
}

.phone-management .el-select {
  flex: 1;
  min-width: 200px;
}

/* ËÆ¢ÂçïÁ±ªÂûãÊ†áÁ≠æÊ†∑Âºè‰ºòÂåñ */
.confirm-section .el-tag {
  border-radius: 6px;
  font-weight: 500;
}

/* ‰∏≠Á≠âÂ±èÂπïÂìçÂ∫îÂºèÊ†∑Âºè */
@media (max-width: 1024px) and (min-width: 769px) {
  .amount-field:nth-child(1) { /* ÂïÜÂìÅÂ∞èËÆ° */
    flex: 0 0 20%;
  }

  .amount-field:nth-child(2) { /* ËÆ¢ÂçïÊÄªÈ¢ù */
    flex: 0 0 22%;
  }

  .amount-field:nth-child(3) { /* ÂÆöÈáëÈáëÈ¢ù */
    flex: 0 0 20%;
  }

  .amount-field:nth-child(4) { /* Â∑≤Êî∂ÈáëÈ¢ù */
    flex: 0 0 18%;
  }

  .amount-field:nth-child(5) { /* ‰ºòÊÉ†ÈáëÈ¢ù */
    flex: 0 0 20%;
  }

  .screenshot-field { /* ÂÆöÈáëÊà™Âõæ */
    flex: 0 0 20% !important;
  }
  
  .field-input .el-input-number {
    min-width: 100px;
  }
}

/* ÁßªÂä®Á´ØÂìçÂ∫îÂºèÊ†∑Âºè */
@media (max-width: 768px) {
  .order-form {
    padding: 12px;
  }
  
  .product-list {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
  }
  
  .form-footer {
    flex-direction: column;
  }
  
  .form-footer .el-button {
    width: 100%;
  }
  
  /* ËÆ¢ÂçïÁ°ÆËÆ§ÂºπÁ™óÂìçÂ∫îÂºè */
  .info-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .info-item .label {
    min-width: auto;
    font-weight: 600;
  }
  
  .amount-summary-grid {
    padding: 16px;
  }
  
  .amount-row-main {
    flex-direction: column;
    gap: 12px;
  }
  
  .amount-card {
    min-width: auto;
    max-width: none;
    padding: 16px 12px;
  }
  
  .amount-value {
    font-size: 20px;
  }
  
  .amount-row-detail {
    flex-direction: column;
    gap: 16px;
    padding: 12px 16px;
  }
  
  .discount-input-section {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  /* ÂìçÂ∫îÂºèËæìÂÖ•Ê°ÜÊ†∑Âºè */
  .amount-row {
    flex-direction: column;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .amount-field {
    flex: 1 1 100%;
    min-width: 100%;
    justify-content: space-between;
  }
  
  .amount-field:nth-child(1),
  .amount-field:nth-child(2),
  .amount-field:nth-child(3),
  .amount-field:nth-child(4),
  .amount-field:nth-child(5),
  .screenshot-field {
    flex: 1 1 100% !important;
  }
  
  .field-label {
    min-width: 80px;
    flex-shrink: 0;
  }
  
  .field-input {
    flex: 1;
    min-width: 120px;
  }
  
  .field-input .el-input-number {
    width: 100%;
    min-width: 120px;
  }
}

/* ËÆ¢ÂçïÁ°ÆËÆ§ÂºπÁ™ó - ‰∏§ÂàóÈáëÈ¢ùÊ±áÊÄªÊ†∑Âºè */
.amount-summary-two-columns {
  display: flex;
  gap: 24px;
  margin-top: 8px;
}

.amount-column {
  flex: 1;
  padding: 16px;
  border-radius: 12px;
  background: #fafbfc;
  border: 1px solid #e5e7eb;
}

.amount-column.basic-amounts {
  background: #f8fafc;
  border-color: #0ea5e9;
  position: relative;
}

.amount-column.basic-amounts::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%);
  border-radius: 12px 12px 0 0;
}

.amount-column.important-amounts {
  background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%);
  border-color: #f59e0b;
  position: relative;
}

.amount-column.important-amounts::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
  border-radius: 12px 12px 0 0;
}

.amount-column .amount-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.amount-column .amount-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.amount-column .amount-item .label {
  font-size: 13px;
  font-weight: 500;
  color: #6b7280;
  margin: 0;
}

.amount-column .amount-item .value {
  font-size: 15px;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.amount-column .amount-item .value.discount {
  color: #dc2626;
}

.amount-column .discount-info {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
}

.amount-column .discount-percent {
  font-size: 11px;
  color: #059669;
  font-weight: 500;
  background: rgba(5, 150, 105, 0.1);
  padding: 2px 6px;
  border-radius: 4px;
}

.amount-column.basic-amounts .amount-item .label {
  color: #0369a1;
  font-weight: 600;
}

.amount-column.basic-amounts .amount-item .value {
  color: #0369a1;
  font-weight: 700;
}

.amount-column.important-amounts .amount-item .label {
  color: #92400e;
  font-weight: 600;
}

.amount-column.important-amounts .amount-item .value {
  color: #92400e;
  font-weight: 700;
  font-size: 16px;
}

.amount-column.important-amounts .amount-item.total-amount .value {
  color: #dc2626;
  font-size: 18px;
}

.amount-column.important-amounts .amount-item.deposit-amount .value {
  color: #059669;
}

.amount-column.important-amounts .amount-item.collect-amount .value {
  color: #7c3aed;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .amount-summary-two-columns {
    flex-direction: column;
    gap: 16px;
  }
  
  .amount-column {
    padding: 12px;
  }
  
  .amount-column .amount-item {
    padding: 10px 0;
  }
  
  .amount-column .amount-item .label {
    font-size: 12px;
  }
  
  .amount-column .amount-item .value {
    font-size: 14px;
  }
  
  .amount-column.important-amounts .amount-item .value {
    font-size: 15px;
  }
  
  .amount-column.important-amounts .amount-item.total-amount .value {
    font-size: 16px;
  }
}
</style>