<template>
  <div class="order-edit-page">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="page-header">
      <h2 class="page-title">ÁºñËæëËÆ¢Âçï</h2>
    </div>

    <el-form :model="orderForm" :rules="formRules" ref="orderFormRef" label-width="120px" class="order-form">
      <!-- ÂÆ¢Êà∑‰ø°ÊÅØÂå∫Âüü -->
      <div class="form-section">
        <div class="section-header">
          <el-icon><User /></el-icon>
          <span>ÂÆ¢Êà∑‰ø°ÊÅØ</span>
        </div>

        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="ÈÄâÊã©ÂÆ¢Êà∑" prop="customerId" required>
              <el-select
                v-model="orderForm.customerId"
                placeholder="ËØ∑ÈÄâÊã©ÂÆ¢Êà∑"
                style="width: 100%"
                filterable
                @change="handleCustomerChange"
                size="large"
              >
                <el-option
                  v-for="customer in customerOptions"
                  :key="customer.id"
                  :label="`${customer.name} (${customer.phone})`"
                  :value="customer.id"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="ÂÆ¢ÊúçÂæÆ‰ø°Âè∑" prop="serviceWechat" required>
              <el-input
                v-model="orderForm.serviceWechat"
                placeholder="ËØ∑ËæìÂÖ•Ë¥üË¥£ÂÆ¢ÊúçÁöÑÂæÆ‰ø°Âè∑"
                clearable
              >
                <template #prefix>
                  <el-icon><Message /></el-icon>
                </template>
              </el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="ËÆ¢ÂçïÊù•Ê∫ê" prop="orderSource" required>
              <el-select
                v-model="orderForm.orderSource"
                placeholder="ËØ∑ÈÄâÊã©ËÆ¢ÂçïÊù•Ê∫ê"
                style="width: 100%"
              >
                <el-option label="üõí Á∫ø‰∏äÂïÜÂüé" value="online_store" />
                <el-option label="üì± ÂæÆ‰ø°Â∞èÁ®ãÂ∫è" value="wechat_mini" />
                <el-option label="üí¨ ÂæÆ‰ø°ÂÆ¢Êúç" value="wechat_service" />
                <el-option label="üìû ÁîµËØùÂí®ËØ¢" value="phone_call" />
                <el-option label="üè™ Á∫ø‰∏ãÈó®Â∫ó" value="offline_store" />
                <el-option label="üë• ÂÆ¢Êà∑Êé®Ëçê" value="referral" />
                <el-option label="üì∫ ÂπøÂëäÊäïÊîæ" value="advertisement" />
                <el-option label="üéØ ÂÖ∂‰ªñÊ∏†ÈÅì" value="other" />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
      </div>

      <!-- Êî∂Ë¥ß‰ø°ÊÅØ -->
      <div v-if="selectedCustomer" class="form-section">
        <div class="section-header" @click="deliveryCollapsed = !deliveryCollapsed" style="cursor: pointer;">
          <div class="header-left">
            <el-icon><Location /></el-icon>
            <span>Êî∂Ë¥ß‰ø°ÊÅØ</span>
          </div>
          <div class="header-right">
            <el-icon class="collapse-icon" :class="{ 'collapsed': deliveryCollapsed }">
              <ArrowDown />
            </el-icon>
          </div>
        </div>
        <el-collapse-transition>
          <div v-show="!deliveryCollapsed">
            <el-row :gutter="20">
              <el-col :span="6">
                <el-form-item label="Êî∂Ë¥ß‰∫∫" prop="receiverName">
                  <el-input
                    v-model="orderForm.receiverName"
                    placeholder="ËØ∑ËæìÂÖ•Êî∂Ë¥ß‰∫∫ÂßìÂêç"
                    clearable
                  />
                </el-form-item>
              </el-col>
              <el-col :span="12">
                <el-form-item label="Êî∂Ë¥ßÁîµËØù" prop="receiverPhone">
                  <div class="phone-management">
                    <el-select
                      v-model="orderForm.receiverPhone"
                      placeholder="ËØ∑ÈÄâÊã©Êî∂Ë¥ßÁîµËØù"
                      style="width: 100%"
                      clearable
                    >
                      <el-option
                        v-for="phone in customerPhones"
                        :key="phone.id"
                        :label="phone.number"
                        :value="phone.number"
                      />
                    </el-select>
                    <el-button
                      type="primary"
                      size="small"
                      @click="showAddPhoneDialog = true"
                      style="margin-left: 8px;"
                      :icon="Plus"
                    >
                      Êñ∞Â¢û
                    </el-button>
                  </div>
                </el-form-item>
              </el-col>
              <el-col :span="6">
                <el-form-item label="ÊåáÂÆöÂø´ÈÄí" prop="expressCompany" required>
                  <el-select
                    v-model="orderForm.expressCompany"
                    placeholder="ËØ∑ÈÄâÊã©Âø´ÈÄíÂÖ¨Âè∏"
                    style="width: 100%"
                  >
                    <el-option label="üöö È°∫‰∏∞ÈÄüËøê" value="sf" />
                    <el-option label="üì¶ ‰∏≠ÈÄöÂø´ÈÄí" value="zt" />
                    <el-option label="üöõ ÂúÜÈÄöÈÄüÈÄí" value="yt" />
                    <el-option label="üìÆ Áî≥ÈÄöÂø´ÈÄí" value="st" />
                    <el-option label="üöê ÈüµËææÈÄüÈÄí" value="yd" />
                    <el-option label="üöö Âæ∑ÈÇ¶Âø´ÈÄí" value="db" />
                    <el-option label="üì¶ ‰∫¨‰∏úÁâ©ÊµÅ" value="jd" />
                    <el-option label="üöõ ÈÇÆÊîøEMS" value="ems" />
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>
          </div>
        </el-collapse-transition>
      </div>

      <!-- ‰∫ßÂìÅÈÄâÊã©Âå∫Âüü -->
      <div class="form-section">
        <div class="section-header">
          <div class="header-left">
            <el-icon><ShoppingBag /></el-icon>
            <span>‰∫ßÂìÅÈÄâÊã©</span>
          </div>
          <div class="header-right">
            <el-button
              type="primary"
              size="small"
              :icon="Refresh"
              @click="handleRefreshProducts"
              title="Âà∑Êñ∞ÂïÜÂìÅÂàóË°®"
            >
              Âà∑Êñ∞
            </el-button>
          </div>
        </div>

        <!-- ‰∫ßÂìÅÊêúÁ¥¢ -->
        <div class="product-search">
          <el-input
            v-model="productSearchKeyword"
            placeholder="ÊêúÁ¥¢‰∫ßÂìÅÂêçÁß∞„ÄÅÁºñÂè∑..."
            size="large"
            clearable
            @input="handleProductSearch"
          >
            <template #prefix>
              <el-icon><Search /></el-icon>
            </template>
          </el-input>
        </div>

        <!-- ‰∫ßÂìÅÂÆπÂô® - ÊòæÁ§∫ÂïÜÂìÅÂç°Áâá -->
        <div class="product-container">
          <div class="product-list">
            <div
              v-for="product in filteredProducts"
              :key="product.id"
              class="product-item"
              @click="addProduct(product)"
            >
              <div class="product-image">
                <img :src="product.image || '/default-product.png'" :alt="product.name" />
              </div>
              <div class="product-info">
                <div class="product-name">{{ product.name }}</div>
                <div class="product-price">¬•{{ product.price }}</div>
                <div class="product-stock">Â∫ìÂ≠ò: {{ product.stock }}</div>
              </div>
              <div class="product-actions">
                <el-button
                  type="info"
                  size="small"
                  :icon="View"
                  @click.stop="viewProductDetail(product)"
                  title="Êü•ÁúãÂïÜÂìÅËØ¶ÊÉÖ"
                >
                  ËØ¶ÊÉÖ
                </el-button>
                <el-button type="primary" size="small" :icon="Plus">Ê∑ªÂä†</el-button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ËÆ¢ÂçïÊ±áÊÄªÂå∫Âüü -->
      <div class="form-section">
        <div class="section-header">
          <el-icon><Money /></el-icon>
          <span>ËÆ¢ÂçïÊ±áÊÄª</span>
        </div>

        <!-- Â∑≤ÈÄâÂïÜÂìÅÂàóË°® -->
        <div class="selected-products" v-if="orderForm.products.length > 0">
          <h4>Â∑≤ÈÄâÂïÜÂìÅ</h4>
          <el-table :data="orderForm.products" style="width: 100%">
            <el-table-column prop="productName" label="ÂïÜÂìÅÂêçÁß∞" />
            <el-table-column prop="price" label="Âçï‰ª∑" width="100">
              <template #default="{ row }">
                ¬•{{ row.price }}
              </template>
            </el-table-column>
            <el-table-column label="Êï∞Èáè" width="150">
              <template #default="{ row, $index }">
                <el-input-number
                  v-model="row.quantity"
                  :min="1"
                  :max="row.stock"
                  size="small"
                  @change="calculateAmounts"
                />
              </template>
            </el-table-column>
            <el-table-column label="Â∞èËÆ°" width="100">
              <template #default="{ row }">
                ¬•{{ ((row.price || 0) * (row.quantity || 0)).toFixed(2) }}
              </template>
            </el-table-column>
            <el-table-column label="Êìç‰Ωú" width="80">
              <template #default="{ $index }">
                <el-button
                  type="danger"
                  size="small"
                  :icon="Delete"
                  @click="removeProduct($index)"
                >
                  Âà†Èô§
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
        <div v-else class="empty-products">
          <el-empty description="ÊöÇÊó†ÈÄâÊã©ÂïÜÂìÅ" />
        </div>

        <!-- ÈáëÈ¢ùÊ±áÊÄª - ÁÆÄÁ∫¶Áé∞‰ª£ÂåñÂ∏ÉÂ±Ä -->
        <div class="amount-summary-modern">
          <!-- Á¨¨‰∏ÄË°åÔºöÂïÜÂìÅÂ∞èËÆ°„ÄÅËÆ¢ÂçïÊÄªÈ¢ùÔºàËæìÂÖ•Ê°ÜÔºâ„ÄÅÂÆöÈáëÔºàËæìÂÖ•Ê°ÜÔºâ -->
          <div class="amount-row">
            <div class="amount-field">
              <span class="field-label">ÂïÜÂìÅÂ∞èËÆ°</span>
              <span class="field-amount subtotal">¬•{{ subtotal.toFixed(2) }}</span>
            </div>
            <div class="amount-field">
              <span class="field-label">
                ËÆ¢ÂçïÊÄªÈ¢ù
                <el-tooltip content="ÁÇπÂáªÂêåÊ≠•ÂïÜÂìÅÂ∞èËÆ°" placement="top" v-if="isManuallyModified">
                  <el-button
                    type="text"
                    size="small"
                    :icon="Refresh"
                    @click="resetToSubtotal"
                    class="sync-button"
                  />
                </el-tooltip>
              </span>
              <el-input-number
                v-model="orderForm.totalAmount"
                :min="0"
                :max="subtotal"
                :precision="2"
                placeholder="ËÆ¢ÂçïÊÄªÈ¢ù"
                class="field-input"
                @change="handleTotalAmountChange"
              />
            </div>
            <div class="amount-field">
              <span class="field-label">ÂÆöÈáë</span>
              <el-input-number
                v-model="orderForm.depositAmount"
                :min="0"
                :max="orderForm.totalAmount || 0"
                :precision="2"
                placeholder="ÂÆöÈáëÈáëÈ¢ù"
                class="field-input"
                @change="calculateCollectAmount"
              />
            </div>
          </div>

          <!-- Á¨¨‰∫åË°åÔºö‰ª£Êî∂ÈáëÈ¢ù„ÄÅ‰ºòÊÉ†ÈáëÈ¢ù„ÄÅÂÆöÈáëÊà™Âõæ -->
          <div class="amount-row">
            <div class="amount-field">
              <span class="field-label">‰ª£Êî∂ÈáëÈ¢ù</span>
              <span class="field-amount collect">¬•{{ collectAmount.toFixed(2) }}</span>
            </div>
            <div class="amount-field">
              <span class="field-label">‰ºòÊÉ†ÈáëÈ¢ù</span>
              <div class="discount-horizontal">
                <span class="field-amount discount">¬•{{ discountAmount.toFixed(2) }}</span>
                <span class="discount-percent" v-if="discountAmount > 0">
                  ({{ discountPercentage.toFixed(1) }}%)
                </span>
              </div>
            </div>
            <div class="amount-field screenshot-field">
              <span class="field-label">ÂÆöÈáëÊà™Âõæ</span>
              <div class="screenshot-buttons">
                <el-button type="primary" size="small" :icon="Upload" @click="triggerUpload">
                  ‰∏ä‰º†Êà™Âõæ
                </el-button>
                <el-button type="success" size="small" :icon="DocumentCopy" @click="pasteImage">
                  Á≤òË¥¥ÂõæÁâá
                </el-button>
              </div>
              <div class="screenshot-content">
                <!-- ÂõæÁâáÁº©Áï•ÂõæÂàóË°® -->
                <div class="screenshot-thumbnails" v-if="depositScreenshots.length > 0">
                  <div
                    v-for="(screenshot, index) in depositScreenshots"
                    :key="index"
                    class="thumbnail-item"
                    @mouseenter="showZoomIcon = index"
                    @mouseleave="showZoomIcon = -1"
                    @click="previewImage(screenshot)"
                  >
                    <img :src="screenshot" alt="ÂÆöÈáëÊà™Âõæ" />
                    <!-- ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊîæÂ§ßÂõæÊ†á -->
                    <div class="thumbnail-overlay" v-show="showZoomIcon === index">
                      <el-icon class="zoom-icon"><ZoomIn /></el-icon>
                    </div>
                    <!-- Âà†Èô§ÂõæÊ†á -->
                    <div class="thumbnail-delete" @click.stop="removeScreenshot(index)">
                      <el-icon><Delete /></el-icon>
                    </div>
                  </div>
                </div>
              </div>

              <input
                ref="fileInput"
                type="file"
                accept="image/*"
                multiple
                style="display: none"
                @change="handleFileSelect"
              />
            </div>
          </div>
        </div>

        <!-- ËÆ¢ÂçïÊ†áËÆ∞ -->
        <div class="mark-section">
          <h4>ËÆ¢ÂçïÊ†áËÆ∞</h4>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ËÆ¢ÂçïÁ±ªÂûã" prop="markType" required>
                <el-radio-group v-model="orderForm.markType" @change="handleMarkTypeChange">
                  <el-radio value="normal">
                    <el-tag type="success" size="small">Ê≠£Â∏∏ÂèëË¥ßÂçï</el-tag>
                  </el-radio>
                  <el-radio value="reserved">
                    <el-tag type="warning" size="small">È¢ÑÁïôÂçï</el-tag>
                  </el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <div class="mark-description">
                <el-alert
                  v-if="orderForm.markType === 'reserved'"
                  title="È¢ÑÁïôÂçïËØ¥Êòé"
                  description="È¢ÑÁïôÂçïÂ∞Ü‰øùÁïôÂú®‰∏ãÂçï‰∫∫Â§ÑÔºå‰∏ç‰ºöÊµÅËΩ¨Âà∞ÂÆ°Ê†∏Âëò„ÄÇÈúÄË¶Å‰øÆÊîπ‰∏∫Ê≠£Â∏∏ÂèëË¥ßÂçïÂêéÊâç‰ºöËøõÂÖ•ÂÆ°Ê†∏ÊµÅÁ®ã„ÄÇ"
                  type="warning"
                  :closable="false"
                  show-icon
                />
                <el-alert
                  v-else
                  title="Ê≠£Â∏∏ÂèëË¥ßÂçï"
                  description="ËÆ¢ÂçïÂ∞ÜÊåâÊ≠£Â∏∏ÊµÅÁ®ãËøõË°åÂÆ°Ê†∏ÂíåÂèëË¥ßÂ§ÑÁêÜ„ÄÇ"
                  type="success"
                  :closable="false"
                  show-icon
                />
              </div>
            </el-col>
          </el-row>
        </div>

        <!-- Â§áÊ≥®‰ø°ÊÅØ -->
        <div class="remark-section">
          <el-form-item label="ËÆ¢ÂçïÂ§áÊ≥®">
            <el-input
              v-model="orderForm.remark"
              type="textarea"
              :rows="3"
              placeholder="ËØ∑ËæìÂÖ•ËÆ¢ÂçïÂ§áÊ≥®‰ø°ÊÅØ"
            />
          </el-form-item>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="form-footer">
          <el-button @click="handleCancel" size="large">ÂèñÊ∂à</el-button>
          <el-button @click="saveOrder" type="primary" size="large" :loading="saving">
            ‰øùÂ≠òÊõ¥Êñ∞
          </el-button>
        </div>
      </div>
    </el-form>

    <!-- ÂÆ¢Êà∑ÈÄâÊã©ÂºπÁ™ó -->
    <el-dialog
      v-model="showCustomerDialog"
      title="ÈÄâÊã©ÂÆ¢Êà∑"
      width="800px"
      :before-close="handleCustomerDialogClose"
    >
      <div class="customer-search">
        <el-input
          v-model="customerSearchKeyword"
          placeholder="ÊêúÁ¥¢ÂÆ¢Êà∑ÂßìÂêçÊàñÁîµËØù..."
          @input="searchCustomers"
          clearable
        >
          <template #prefix>
            <el-icon><Search /></el-icon>
          </template>
        </el-input>
      </div>
      <div class="customer-list">
        <el-table
          :data="customerSearchResults"
          @row-click="selectCustomer"
          highlight-current-row
          style="width: 100%"
        >
          <el-table-column prop="name" label="ÂÆ¢Êà∑ÂßìÂêç" />
          <el-table-column prop="phone" label="ËÅîÁ≥ªÁîµËØù" />
          <el-table-column prop="address" label="Âú∞ÂùÄ" />
        </el-table>
      </div>
    </el-dialog>

    <!-- Ê∑ªÂä†ÁîµËØùÂè∑Á†ÅÂºπÁ™ó -->
    <el-dialog
      v-model="showAddPhoneDialog"
      title="Ê∑ªÂä†ÁîµËØùÂè∑Á†Å"
      width="400px"
    >
      <el-form :model="phoneForm" label-width="80px">
        <el-form-item label="ÁîµËØùÂè∑Á†Å">
          <el-input
            v-model="phoneForm.phone"
            placeholder="ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showAddPhoneDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="addPhoneNumber">Á°ÆÂÆö</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ËÆ¢ÂçïÁ°ÆËÆ§ÂºπÁ™ó -->
    <el-dialog
      v-model="showConfirmDialog"
      title="ËÆ¢ÂçïÁ°ÆËÆ§"
      width="900px"
      :before-close="handleConfirmDialogClose"
    >
      <div class="confirm-content">
        <!-- ÂÆ¢Êà∑‰ø°ÊÅØ -->
        <div class="confirm-section">
          <h4 class="confirm-title">ÂÆ¢Êà∑‰ø°ÊÅØ</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">ÂÆ¢Êà∑ÂßìÂêç:</span>
              <span class="value">{{ orderForm.customerName }}</span>
            </div>
            <div class="info-item">
              <span class="label">ËÅîÁ≥ªÁîµËØù:</span>
              <span class="value">{{ orderForm.customerPhone }}</span>
            </div>
            <div class="info-item">
              <span class="label">ÈÖçÈÄÅÂú∞ÂùÄ:</span>
              <span class="value">{{ orderForm.deliveryAddress || 'Êó†' }}</span>
            </div>
            <div class="info-item">
              <span class="label">ÈÖçÈÄÅÊó∂Èó¥:</span>
              <span class="value">{{ orderForm.deliveryTime || 'Êó†' }}</span>
            </div>
            <div class="info-item">
              <span class="label">ËÆ¢ÂçïÁ±ªÂûã:</span>
              <el-tag :type="orderForm.orderType === 'normal' ? 'success' : 'warning'">
                {{ orderForm.orderType === 'normal' ? 'Ê≠£Â∏∏ËÆ¢Âçï' : 'È¢ÑÁïôËÆ¢Âçï' }}
              </el-tag>
            </div>
            <div v-if="orderForm.remarks" class="info-item">
              <span class="label">Â§áÊ≥®:</span>
              <span class="value">{{ orderForm.remarks }}</span>
            </div>
          </div>
        </div>

        <!-- ÈáëÈ¢ùÊ±áÊÄª -->
        <div class="confirm-section">
          <h4 class="confirm-title">ÈáëÈ¢ùÊ±áÊÄª</h4>
          <div class="amount-summary-two-columns">
            <div class="amount-column basic-amounts">
              <div class="amount-item">
                <span class="label">ÂïÜÂìÅÂ∞èËÆ°</span>
                <span class="value">¬•{{ orderForm.subtotal }}</span>
              </div>
              <div class="amount-item">
                <span class="label">‰ºòÊÉ†ÈáëÈ¢ù</span>
                <div class="discount-info">
                  <span class="value discount">-¬•{{ orderForm.discountAmount }}</span>
                  <span v-if="discountPercentage > 0" class="discount-percent">{{ discountPercentage }}%</span>
                </div>
              </div>
            </div>
            <div class="amount-column important-amounts">
              <div class="amount-item total-amount">
                <span class="label">ËÆ¢ÂçïÊÄªÈ¢ù</span>
                <span class="value">¬•{{ orderForm.totalAmount }}</span>
              </div>
              <div class="amount-item deposit-amount">
                <span class="label">ÂÆöÈáëÈáëÈ¢ù</span>
                <span class="value">¬•{{ orderForm.depositAmount }}</span>
              </div>
              <div class="amount-item collect-amount">
                <span class="label">Â∑≤Êî∂ÈáëÈ¢ù</span>
                <span class="value">¬•{{ orderForm.collectedAmount }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ‰∫ßÂìÅ‰ø°ÊÅØ -->
        <div class="confirm-section">
          <h4 class="confirm-title">‰∫ßÂìÅ‰ø°ÊÅØ</h4>
          <el-table :data="orderForm.products" style="width: 100%">
            <el-table-column prop="productName" label="‰∫ßÂìÅÂêçÁß∞" />
            <el-table-column prop="productCode" label="‰∫ßÂìÅÁºñÂè∑" width="120" />
            <el-table-column prop="specification" label="ËßÑÊ†º" width="120" />
            <el-table-column prop="price" label="Âçï‰ª∑" width="100">
              <template #default="scope">
                ¬•{{ scope.row.price }}
              </template>
            </el-table-column>
            <el-table-column prop="quantity" label="Êï∞Èáè" width="80" />
            <el-table-column prop="subtotal" label="Â∞èËÆ°" width="100">
              <template #default="scope">
                ¬•{{ scope.row.subtotal }}
              </template>
            </el-table-column>
          </el-table>
        </div>
      </div>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showConfirmDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="confirmSaveOrder" :loading="saving">
            Á°ÆËÆ§‰øùÂ≠ò
          </el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ÂõæÁâáÊü•ÁúãÂô® -->
    <el-image-viewer
      v-if="showImageViewer"
      :url-list="currentImageList"
      :initial-index="0"
      @close="showImageViewer = false"
    />

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
    <input
      ref="fileInput"
      type="file"
      accept="image/*"
      style="display: none"
      @change="handleFileSelect"
    />
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted, onUnmounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Search, ZoomIn, Close, Delete, ArrowDown, User, Message, Location, Plus, ShoppingBag, Refresh } from '@element-plus/icons-vue'
import { request } from '@/api/request'
import { maskPhone } from '@/utils/phone'
import { useOrderStore } from '@/stores/order'
import { useCustomerStore } from '@/stores/customer'
import { useProductStore } from '@/stores/product'
import { createSafeNavigator } from '@/utils/navigation'

const route = useRoute()
const router = useRouter()
const safeNavigator = createSafeNavigator(router)

// ÂàùÂßãÂåñstores
const orderStore = useOrderStore()
const customerStore = useCustomerStore()
const productStore = useProductStore()

// Ëé∑ÂèñËÆ¢ÂçïID
const orderId = route.params.id

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const saving = ref(false)
const searchKeyword = ref('')
const searchResults = ref([])
const productSearchKeyword = ref('')
const customerSearchKeyword = ref('')
const customerSearchResults = ref([])
const customerPhones = ref([])
const showCustomerDialog = ref(false)
const showAddPhoneDialog = ref(false)
const showConfirmDialog = ref(false)
const showImageViewer = ref(false)
const currentImageList = ref([])
const viewImageUrl = ref('')
const fileInput = ref(null)
const depositScreenshots = ref([])
const showZoomIcon = ref(-1)
const selectedCustomer = ref(null)
const deliveryCollapsed = ref(false) // ÈÖçÈÄÅ‰ø°ÊÅØÈªòËÆ§Â±ïÂºÄ

// Ë°®ÂçïÊï∞ÊçÆ
const orderForm = reactive({
  id: null,
  customerId: null,
  customerName: '',
  customerPhone: '',
  deliveryAddress: '',
  deliveryTime: '',
  receiverName: '',
  receiverPhone: '',
  expressCompany: '',
  serviceWechat: '',
  orderSource: '',
  products: [],
  subtotal: 0,
  totalAmount: 0,
  depositAmount: 0,
  collectedAmount: 0,
  discountAmount: 0,
  depositScreenshot: '',
  orderType: 'normal',
  remarks: ''
})

// ÁîµËØùË°®Âçï
const phoneForm = reactive({
  phone: ''
})

// ËÆ°ÁÆóÂ±ûÊÄß
const subtotal = computed(() => {
  return orderForm.products.reduce((sum, product) => {
    return sum + ((product.price || 0) * (product.quantity || 0))
  }, 0)
})

const collectAmount = computed(() => {
  return (orderForm.totalAmount || 0) - (orderForm.depositAmount || 0)
})

const discountAmount = computed(() => {
  return subtotal.value - (orderForm.totalAmount || 0)
})

const discountPercentage = computed(() => {
  if (subtotal.value > 0 && discountAmount.value > 0) {
    return (discountAmount.value / subtotal.value) * 100
  }
  return 0
})

// ËøáÊª§ÂêéÁöÑ‰∫ßÂìÅÂàóË°®
const filteredProducts = computed(() => {
  if (!productSearchKeyword.value) {
    return productStore.products.filter(product => product.status === 'active')
  }
  return productStore.products.filter(product => 
    product.status === 'active' &&
    (product.name.toLowerCase().includes(productSearchKeyword.value.toLowerCase()) ||
     product.code?.toLowerCase().includes(productSearchKeyword.value.toLowerCase()))
  )
})

// ÂÆ¢Êà∑ÈÄâÈ°π
const customerOptions = computed(() => {
  return customerStore.customers.filter(customer => !customer.deleted)
})

// È°µÈù¢ÂàùÂßãÂåñ
onMounted(async () => {
  await loadOrderData()

  // ÁõëÂê¨ËÆ¢ÂçïÊõ¥Êñ∞‰∫ã‰ª∂ÔºåÁ°Æ‰øùÊï∞ÊçÆÂêåÊ≠•
  window.addEventListener('orderUpdated', handleOrderUpdate)
  window.addEventListener('orderStatusUpdated', handleOrderStatusUpdate)
})

// È°µÈù¢Âç∏ËΩΩÊó∂ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
onUnmounted(() => {
  window.removeEventListener('orderUpdated', handleOrderUpdate)
  window.removeEventListener('orderStatusUpdated', handleOrderStatusUpdate)
})

// Â§ÑÁêÜËÆ¢ÂçïÊõ¥Êñ∞‰∫ã‰ª∂
const handleOrderUpdate = (event) => {
  const { orderId: updatedOrderId } = event.detail
  if (updatedOrderId === orderId) {
    // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçËÆ¢ÂçïÊï∞ÊçÆ
    loadOrderData()
    ElMessage.success('ËÆ¢ÂçïÊï∞ÊçÆÂ∑≤ÂêåÊ≠•Êõ¥Êñ∞')
  }
}

// Â§ÑÁêÜËÆ¢ÂçïÁä∂ÊÄÅÊõ¥Êñ∞‰∫ã‰ª∂
const handleOrderStatusUpdate = (event) => {
  const { orderId: updatedOrderId } = event.detail
  if (updatedOrderId === orderId) {
    // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçËÆ¢ÂçïÊï∞ÊçÆ
    loadOrderData()
    ElMessage.info('ËÆ¢ÂçïÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞')
  }
}

// Âä†ËΩΩËÆ¢ÂçïÊï∞ÊçÆ
const loadOrderData = async () => {
  try {
    const order = orderStore.getOrderById(orderId)
    if (order) {
      // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ - Á°Æ‰øùÊâÄÊúâÂ≠óÊÆµÈÉΩÂêåÊ≠•
      Object.assign(orderForm, {
        id: order.id,
        customerId: order.customerId,
        customerName: order.customerName,
        customerPhone: order.customerPhone,
        // ÈÖçÈÄÅ‰ø°ÊÅØ
        receiverName: order.receiverName || '',
        receiverPhone: order.receiverPhone || '',
        deliveryAddress: order.deliveryAddress || '',
        deliveryTime: order.deliveryTime || '',
        expressCompany: order.expressCompany || '',
        // ÂÆ¢ÊúçÂíåËÆ¢ÂçïÊù•Ê∫ê
        serviceWechat: order.serviceWechat || '',
        orderSource: order.orderSource || '',
        // ‰∫ßÂìÅÂíåÈáëÈ¢ù
        products: order.products || [],
        subtotal: order.subtotal || 0,
        totalAmount: order.totalAmount || 0,
        depositAmount: order.depositAmount || 0,
        collectedAmount: order.collectedAmount || 0,
        discountAmount: order.discountAmount || 0,
        depositScreenshot: order.depositScreenshot || '',
        orderType: order.orderType || 'normal',
        remarks: order.remarks || ''
      })

      // Âä†ËΩΩÂÆ¢Êà∑ÁîµËØùÂàóË°®
      if (order.customerId) {
        await loadCustomerPhones(order.customerId)
      }

      // ÂàùÂßãÂåñÊà™ÂõæÊï∞ÁªÑ
      if (order.depositScreenshots && Array.isArray(order.depositScreenshots)) {
        depositScreenshots.value = [...order.depositScreenshots]
      } else if (order.depositScreenshot) {
        depositScreenshots.value = [order.depositScreenshot]
      } else {
        depositScreenshots.value = []
      }

      // ÈáçÊñ∞ËÆ°ÁÆóÈáëÈ¢ù
      calculateSubtotal()
    }
  } catch (error) {
    console.error('Âä†ËΩΩËÆ¢ÂçïÊï∞ÊçÆÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩËÆ¢ÂçïÊï∞ÊçÆÂ§±Ë¥•')
    goBack()
  }
}

// ÊêúÁ¥¢‰∫ßÂìÅ
const searchProducts = async () => {
  if (searchKeyword.value.trim()) {
    try {
      searchResults.value = await productStore.searchProducts(searchKeyword.value)
    } catch (error) {
      console.error('ÊêúÁ¥¢‰∫ßÂìÅÂ§±Ë¥•:', error)
      searchResults.value = []
    }
  } else {
    searchResults.value = []
  }
}

// Ê∑ªÂä†‰∫ßÂìÅ
const addProduct = (product) => {
  const existingItem = orderForm.products.find(item => item.productId === product.id)
  if (existingItem) {
    existingItem.quantity += 1
    existingItem.subtotal = existingItem.quantity * existingItem.price
  } else {
    orderForm.products.push({
      productId: product.id,
      productName: product.name,
      productCode: product.code,
      specification: product.specification,
      price: product.price,
      quantity: 1,
      subtotal: product.price
    })
  }
  calculateSubtotal()
  searchKeyword.value = ''
  searchResults.value = []
}

// Âà†Èô§‰∫ßÂìÅ
const removeProduct = (index) => {
  orderForm.products.splice(index, 1)
  calculateSubtotal()
}

// ËÆ°ÁÆóÂ∞èËÆ°
const calculateSubtotal = () => {
  orderForm.products.forEach(item => {
    item.subtotal = item.quantity * item.price
  })
  orderForm.subtotal = orderForm.products.reduce((sum, item) => sum + item.subtotal, 0)
  calculateAmounts()
}

// ËÆ°ÁÆóÈáëÈ¢ù
const calculateAmounts = () => {
  orderForm.totalAmount = orderForm.subtotal - orderForm.discountAmount
  orderForm.collectedAmount = orderForm.depositAmount
}

// Â§ÑÁêÜ‰∫ßÂìÅÊêúÁ¥¢
const handleProductSearch = () => {
  // ‰∫ßÂìÅÊêúÁ¥¢ÈÄöËøácomputedÂ±ûÊÄßfilteredProductsËá™Âä®Â§ÑÁêÜ
}

// Â§ÑÁêÜÂÆ¢Êà∑ÂèòÊõ¥
const handleCustomerChange = async (customerId) => {
  if (customerId) {
    const customer = customerStore.getCustomerById(customerId)
    if (customer) {
      selectedCustomer.value = customer
      orderForm.customerName = customer.name
      orderForm.customerPhone = customer.phone
      orderForm.deliveryAddress = customer.address || ''
      
      // ÂêåÊ≠•Êî∂Ë¥ß‰∫∫‰ø°ÊÅØÔºàÈªòËÆ§‰ΩøÁî®ÂÆ¢Êà∑‰ø°ÊÅØÔºâ
      orderForm.receiverName = customer.name
      orderForm.receiverPhone = customer.phone
      
      // ÂêåÊ≠•ÂÆ¢Êà∑ÂæÆ‰ø°Âè∑Âà∞ÂÆ¢ÊúçÂæÆ‰ø°Âè∑Â≠óÊÆµ
      orderForm.serviceWechat = customer.wechatId || ''
      
      // ÂêåÊ≠•ÂÆ¢Êà∑ËÆ¢ÂçïÊù•Ê∫ê
      orderForm.orderSource = customer.source || ''
      
      // Ëá™Âä®Â±ïÂºÄÊî∂Ë¥ß‰ø°ÊÅØÂå∫Âüü
      deliveryCollapsed.value = false
      
      // Âä†ËΩΩÂÆ¢Êà∑ÁîµËØùÂàóË°®
      await loadCustomerPhones(customerId)
    }
  } else {
    selectedCustomer.value = null
    orderForm.customerName = ''
    orderForm.customerPhone = ''
    orderForm.deliveryAddress = ''
    orderForm.receiverName = ''
    orderForm.receiverPhone = ''
    orderForm.serviceWechat = ''
    orderForm.orderSource = ''
    customerPhones.value = []
  }
}

// Âà∑Êñ∞‰∫ßÂìÅÂàóË°®
const handleRefreshProducts = () => {
  productStore.refreshProducts()
  ElMessage.success('‰∫ßÂìÅÂàóË°®Â∑≤Âà∑Êñ∞')
}

// Êü•Áúã‰∫ßÂìÅËØ¶ÊÉÖ
const viewProductDetail = (product) => {
  // Ë∑≥ËΩ¨Âà∞ÂïÜÂìÅËØ¶ÊÉÖÈ°µ
  safeNavigator.push(`/product/detail/${product.id}`)
}

// Â§ÑÁêÜÊÄªÈáëÈ¢ùÂèòÊõ¥
const handleTotalAmountChange = () => {
  calculateCollectAmount()
}

// ËÆ°ÁÆó‰ª£Êî∂ÈáëÈ¢ù
const calculateCollectAmount = () => {
  // ‰ª£Êî∂ÈáëÈ¢ù = ËÆ¢ÂçïÊÄªÈ¢ù - ÂÆöÈáë
  orderForm.collectedAmount = (orderForm.totalAmount || 0) - (orderForm.depositAmount || 0)
}

// ÈáçÁΩÆÂà∞ÂïÜÂìÅÂ∞èËÆ°
const resetToSubtotal = () => {
  orderForm.totalAmount = subtotal.value
  calculateCollectAmount()
}

// Ê£ÄÊü•ÊòØÂê¶ÊâãÂä®‰øÆÊîπËøáÊÄªÈáëÈ¢ù
const isManuallyModified = computed(() => {
  return Math.abs((orderForm.totalAmount || 0) - subtotal.value) > 0.01
})

// ÊêúÁ¥¢ÂÆ¢Êà∑
const searchCustomers = async () => {
  if (customerSearchKeyword.value.trim()) {
    try {
      customerSearchResults.value = await customerStore.searchCustomers(customerSearchKeyword.value)
    } catch (error) {
      console.error('ÊêúÁ¥¢ÂÆ¢Êà∑Â§±Ë¥•:', error)
      customerSearchResults.value = []
    }
  } else {
    customerSearchResults.value = []
  }
}

// ÈÄâÊã©ÂÆ¢Êà∑
const selectCustomer = async (customer) => {
  orderForm.customerId = customer.id
  orderForm.customerName = customer.name
  orderForm.customerPhone = customer.phone
  orderForm.deliveryAddress = customer.address || ''
  
  // ÂêåÊ≠•Êî∂Ë¥ß‰∫∫‰ø°ÊÅØÔºàÈªòËÆ§‰ΩøÁî®ÂÆ¢Êà∑‰ø°ÊÅØÔºâ
  orderForm.receiverName = customer.name
  orderForm.receiverPhone = customer.phone
  
  // ÂêåÊ≠•ÂÆ¢Êà∑ÂæÆ‰ø°Âè∑Âà∞ÂÆ¢ÊúçÂæÆ‰ø°Âè∑Â≠óÊÆµ
  orderForm.serviceWechat = customer.wechatId || ''
  
  // ÂêåÊ≠•ÂÆ¢Êà∑ËÆ¢ÂçïÊù•Ê∫ê
  orderForm.orderSource = customer.source || ''
  
  // Ëá™Âä®Â±ïÂºÄÊî∂Ë¥ß‰ø°ÊÅØÂå∫Âüü
  deliveryCollapsed.value = false

  await loadCustomerPhones(customer.id)
  showCustomerDialog.value = false
}

// Âä†ËΩΩÂÆ¢Êà∑ÁîµËØùÂàóË°®
const loadCustomerPhones = async (customerId) => {
  try {
    const phones = await customerStore.getCustomerPhones(customerId)
    customerPhones.value = phones || []
  } catch (error) {
    console.error('Âä†ËΩΩÂÆ¢Êà∑ÁîµËØùÂ§±Ë¥•:', error)
    customerPhones.value = []
  }
}

// Ê∑ªÂä†ÁîµËØùÂè∑Á†Å
const addPhoneNumber = async () => {
  if (!phoneForm.phone.trim()) {
    ElMessage.warning('ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å')
    return
  }

  try {
    await customerStore.addCustomerPhone(orderForm.customerId, phoneForm.phone)
    customerPhones.value.push(phoneForm.phone)
    orderForm.customerPhone = phoneForm.phone
    phoneForm.phone = ''
    showAddPhoneDialog.value = false
    ElMessage.success('Ê∑ªÂä†ÁîµËØùÂè∑Á†ÅÊàêÂäü')
  } catch (error) {
    console.error('Ê∑ªÂä†ÁîµËØùÂè∑Á†ÅÂ§±Ë¥•:', error)
    ElMessage.error('Ê∑ªÂä†ÁîµËØùÂè∑Á†ÅÂ§±Ë¥•')
  }
}

// ÈÄâÊã©Êà™Âõæ
const selectScreenshot = () => {
  fileInput.value?.click()
}

// Ëß¶ÂèëÊñá‰ª∂‰∏ä‰º†
const triggerUpload = () => {
  fileInput.value?.click()
}

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
const handleFileSelect = (event) => {
  const files = event.target.files
  if (files && files.length > 0) {
    for (let i = 0; i < files.length; i++) {
      if (depositScreenshots.value.length >= 3) {
        ElMessage.warning('ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†3Âº†ÂõæÁâá')
        break
      }
      handleImageFile(files[i])
    }
    // Ê∏ÖÁ©∫inputÂÄºÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
    event.target.value = ''
  }
}

// Á≤òË¥¥ÂõæÁâáÂäüËÉΩ
const pasteImage = async () => {
  if (depositScreenshots.value.length >= 3) {
    ElMessage.warning('ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†3Âº†ÂõæÁâá')
    return
  }

  try {
    const clipboardItems = await navigator.clipboard.read()
    for (const clipboardItem of clipboardItems) {
      for (const type of clipboardItem.types) {
        if (type.startsWith('image/')) {
          const blob = await clipboardItem.getType(type)
          const file = new File([blob], 'pasted-image.png', { type })
          handleImageFile(file)
          return
        }
      }
    }
    ElMessage.warning('Ââ™Ë¥¥Êùø‰∏≠Ê≤°ÊúâÂõæÁâá')
  } catch (error) {
    ElMessage.error('Á≤òË¥¥ÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊùÉÈôê')
  }
}

// Â§ÑÁêÜÂõæÁâáÊñá‰ª∂
const handleImageFile = (file) => {
  if (!beforeUpload(file)) {
    return
  }

  if (depositScreenshots.value.length >= 3) {
    ElMessage.warning('ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†3Âº†ÂõæÁâá')
    return
  }

  // ÂàõÂª∫È¢ÑËßàURL
  const reader = new FileReader()
  reader.onload = (e) => {
    const imageUrl = e.target?.result
    depositScreenshots.value.push(imageUrl)
    // ÂêåÊó∂Êõ¥Êñ∞orderForm‰∏≠ÁöÑÂ≠óÊÆµÔºà‰øùÊåÅÂÖºÂÆπÊÄßÔºâ
    orderForm.depositScreenshot = depositScreenshots.value[0] || ''
    ElMessage.success('ÂõæÁâáÂ∑≤Ê∑ªÂä†')
  }
  reader.readAsDataURL(file)
}

// Êñá‰ª∂‰∏ä‰º†ÂâçÈ™åËØÅ
const beforeUpload = (file) => {
  const isImage = file.type.startsWith('image/')
  const isLt2M = file.size / 1024 / 1024 < 2

  if (!isImage) {
    ElMessage.error('Âè™ËÉΩ‰∏ä‰º†ÂõæÁâáÊñá‰ª∂!')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 2MB!')
    return false
  }
  return true
}

// ÊãçÁÖß
const takeScreenshot = () => {
  // ËøôÈáåÂèØ‰ª•ÈõÜÊàêÁõ∏Êú∫ÂäüËÉΩ
  ElMessage.info('ÊãçÁÖßÂäüËÉΩÂæÖÂÆûÁé∞')
}

// Êü•ÁúãÊà™Âõæ
const viewScreenshot = () => {
  viewImageUrl.value = orderForm.depositScreenshot
  showImageViewer.value = true
}

// È¢ÑËßàÂõæÁâá
const previewImage = (imageUrl) => {
  const url = imageUrl || orderForm.depositScreenshot
  if (url) {
    currentImageList.value = [url]
    showImageViewer.value = true
  }
}

// Âà†Èô§Êà™Âõæ
const removeScreenshot = (index) => {
  if (typeof index === 'number') {
    // Âà†Èô§ÁâπÂÆöÁ¥¢ÂºïÁöÑÊà™Âõæ
    depositScreenshots.value.splice(index, 1)
    // Êõ¥Êñ∞orderForm‰∏≠ÁöÑÂ≠óÊÆµ
    orderForm.depositScreenshot = depositScreenshots.value[0] || ''
    ElMessage.success('ÂõæÁâáÂ∑≤Âà†Èô§')
  } else {
    // ÂÖºÂÆπÊóßÁöÑÂà†Èô§ÊâÄÊúâÊà™ÂõæÁöÑÊñπÂºè
    depositScreenshots.value = []
    orderForm.depositScreenshot = ''
  }
}

// ‰øùÂ≠òËÆ¢Âçï
const saveOrder = () => {
  // È™åËØÅË°®Âçï
  if (!orderForm.customerName) {
    ElMessage.warning('ËØ∑ÈÄâÊã©ÂÆ¢Êà∑')
    return
  }

  if (orderForm.products.length === 0) {
    ElMessage.warning('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™‰∫ßÂìÅ')
    return
  }

  showConfirmDialog.value = true
}

// Á°ÆËÆ§‰øùÂ≠òËÆ¢Âçï
const confirmSaveOrder = async () => {
  saving.value = true
  try {
    await orderStore.updateOrder(orderId, orderForm)
    ElMessage.success('ËÆ¢ÂçïÊõ¥Êñ∞ÊàêÂäü')
    showConfirmDialog.value = false

    // Ëá™Âä®ÂÖ≥Èó≠È°µÈù¢Âπ∂Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®
    setTimeout(() => {
      safeNavigator.push('/order/list')
    }, 1000)
  } catch (error) {
    console.error('Êõ¥Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', error)
    ElMessage.error('Êõ¥Êñ∞ËÆ¢ÂçïÂ§±Ë¥•')
  } finally {
    saving.value = false
  }
}

// Â§ÑÁêÜÂèñÊ∂àÊìç‰Ωú
const handleCancel = async () => {
  try {
    await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÂêóÔºüÊú™‰øùÂ≠òÁöÑÊï∞ÊçÆÂ∞Ü‰∏¢Â§±', 'ÊèêÁ§∫', {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÁªßÁª≠ÁºñËæë',
      type: 'warning'
    })

    safeNavigator.push('/order/list')
  } catch (error) {
    // Áî®Êà∑ÂèñÊ∂àÊìç‰Ωú
  }
}

// ËøîÂõû
const goBack = () => {
  router.back()
}

// Â§ÑÁêÜÂºπÁ™óÂÖ≥Èó≠
const handleCustomerDialogClose = () => {
  showCustomerDialog.value = false
  customerSearchKeyword.value = ''
  customerSearchResults.value = []
}

const handleConfirmDialogClose = () => {
  showConfirmDialog.value = false
}
</script>

<style scoped>
/* È°µÈù¢ÂÆπÂô® */
.order-edit-page {
  padding: 12px;
  background-color: #f5f5f5;
  min-height: 100vh;
  width: 100%;
  box-sizing: border-box;
  max-width: 100%;
}

/* È°µÈù¢Ê†áÈ¢ò */
.page-header {
  margin-bottom: 16px;
  padding: 12px 0;
  border-bottom: 2px solid #e5e7eb;
}

.page-title {
  font-size: 28px;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-header h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
  color: #1f2937;
}

/* Ë°®ÂçïÂå∫Âüü */
.form-section {
  background: white;
  border-radius: 8px;
  margin-bottom: 12px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Âå∫ÂüüÊ†áÈ¢ò */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e5e7eb;
}

.section-header .header-left {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #6b7280; /* Ë∞ÉÊï¥‰∏∫ÁÅ∞Ëâ≤‰ΩÜÊ∏ÖÊô∞ÂèØËßÅ */
}

.section-header .header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ÁÆÄÂçïÁöÑsection-headerÊ†∑ÂºèÔºàÊ≤°Êúâheader-left/header-rightÁªìÊûÑÁöÑÔºâ */
.section-header:not(:has(.header-left)) {
  justify-content: flex-start;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #6b7280; /* Ë∞ÉÊï¥‰∏∫ÁÅ∞Ëâ≤‰ΩÜÊ∏ÖÊô∞ÂèØËßÅ */
}

.section-header:not(:has(.header-left)) .el-icon {
  color: #6b7280;
}

.section-header:not(:has(.header-left)) span {
  color: #6b7280;
}

.order-form {
  max-width: 100%;
  margin: 0;
  width: 100%;
}

/* ÂÆ¢Êà∑‰ø°ÊÅØÊ†∑Âºè */
.customer-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.customer-field {
  display: flex;
  align-items: center;
  gap: 16px;
}

.field-label {
  min-width: 80px;
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

.field-input {
  flex: 1;
  display: flex;
  gap: 8px;
  align-items: center;
}

.readonly-input {
  flex: 1;
}

.select-customer-btn {
  flex-shrink: 0;
}

.phone-management {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.phone-select {
  flex: 1;
  min-width: 200px;
}

/* ÈÖçÈÄÅ‰ø°ÊÅØÊ†∑Âºè */
.delivery-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.delivery-field {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

/* ‰∫ßÂìÅÊêúÁ¥¢Ê†∑Âºè */
.product-search {
  margin-bottom: 16px;
}

.search-input {
  width: 100%;
}

/* ‰∫ßÂìÅÂÆπÂô®Ê†∑Âºè */
.product-container {
  margin-top: 16px;
}

.product-search {
  margin-bottom: 20px;
}

.product-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
  max-height: 450px;
  overflow-y: auto;
  padding: 4px;
}

.product-item {
  border: 1px solid #ebeef5;
  border-radius: 8px;
  padding: 10px;
  cursor: pointer;
  transition: all 0.3s;
}

.product-item:hover {
  border-color: #409eff;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
}

.product-image {
  width: 100%;
  height: 100px;
  margin-bottom: 6px;
  border-radius: 4px;
  overflow: hidden;
  background: #f5f7fa;
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.product-info {
  text-align: center;
  margin-bottom: 6px;
}

.product-name {
  font-weight: 600;
  margin-bottom: 4px;
  color: #303133;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
  height: 2.8em; /* 2Ë°åÁöÑÈ´òÂ∫¶ */
}

.product-price {
  color: #f56c6c;
  font-weight: 600;
  font-size: 16px;
}

.product-stock {
  color: #909399;
  font-size: 12px;
}

.product-actions {
  text-align: center;
  display: flex;
  gap: 8px;
  justify-content: center;
}

/* Â∑≤ÈÄâ‰∫ßÂìÅÊ†∑Âºè */
.empty-products {
  text-align: center;
  padding: 40px 0;
}

.selected-products {
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.selected-products h4 {
  color: #6b7280; /* ‰∏éÂÖ∂‰ªñÊ†áÈ¢ò‰øùÊåÅ‰∏ÄËá¥ÁöÑÁÅ∞Ëâ≤ */
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 16px 0;
  padding: 0;
}

/* ÈáëÈ¢ùÊ±áÊÄªÊ†∑Âºè */
/* ÁÆÄÁ∫¶Áé∞‰ª£ÂåñÈáëÈ¢ùÊ±áÊÄªÊ†∑Âºè */
.amount-summary-modern {
  margin-top: 16px;
  padding: 20px;
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.amount-row {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
  gap: 1.5%;
  flex-wrap: nowrap;
}

.amount-row:last-child {
  margin-bottom: 0;
}

.amount-field {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
}

.amount-field:nth-child(1) { /* ÂïÜÂìÅÂ∞èËÆ° */
  flex: 0 0 16%;
}

.amount-field:nth-child(2) { /* ËÆ¢ÂçïÊÄªÈ¢ù */
  flex: 0 0 22%; /* Â¢ûÂä†ÂÆΩÂ∫¶ */
}

.amount-field:nth-child(3) { /* ÂÆöÈáëÈáëÈ¢ù */
  flex: 0 0 20%; /* Â¢ûÂä†ÂÆΩÂ∫¶ */
}

.amount-field:nth-child(4) { /* Â∑≤Êî∂ÈáëÈ¢ù */
  flex: 0 0 14%;
}

.amount-field:nth-child(5) { /* ‰ºòÊÉ†ÈáëÈ¢ù */
  flex: 0 0 18%;
}

.screenshot-field { /* ÂÆöÈáëÊà™Âõæ - ÂåÖÂê´ÊåâÈíÆÂíåÁº©Áï•Âõæ */
  flex: 0 0 18% !important;
}

.field-label {
  font-size: 14px;
  font-weight: 500;
  color: #374151;
  white-space: nowrap;
  min-width: 60px;
  flex-shrink: 0;
}

.field-amount {
  font-size: 18px;
  font-weight: 700;
}

.field-amount.subtotal {
  color: #059669;
}

.field-amount.collect {
  color: #7c3aed;
}

.field-amount.discount {
  color: #ea580c;
}

.field-input {
  flex: 1;
  width: 100%;
  min-width: 120px; /* Á°Æ‰øùÊúÄÂ∞èÂÆΩÂ∫¶ */
}

.field-input .el-input-number {
  width: 100%;
  min-width: 120px; /* Á°Æ‰øùÊúÄÂ∞èÂÆΩÂ∫¶ */
}

.field-input .el-input-number .el-input__inner {
  font-size: 16px;
  font-weight: 600;
  text-align: right;
  padding-right: 12px;
  color: #1f2937;
}

.field-input .el-input-number:focus-within .el-input__inner {
  color: #3b82f6;
}

.sync-button {
  margin-left: 4px;
  padding: 2px 4px;
  color: #3b82f6;
  font-size: 12px;
}

.sync-button:hover {
  color: #2563eb;
  background-color: #eff6ff;
}

.discount-horizontal {
  display: flex;
  align-items: center;
  gap: 8px;
}

.discount-percent {
  font-size: 13px;
  color: #6b7280;
  font-weight: 500;
}

.screenshot-field {
  flex-direction: row;
  align-items: center;
  gap: 8px;
}

.screenshot-content {
  display: flex;
  align-items: center;
  min-height: 32px;
  flex: 1;
  margin-left: 8px;
}

.screenshot-buttons {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  margin-left: 8px;
}

.screenshot-buttons .el-button {
  padding: 4px 8px;
  font-size: 12px;
  height: 28px;
}

.screenshot-thumbnails {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: nowrap;
}

.thumbnail-item {
  position: relative;
  width: 60px;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #e5e7eb;
  transition: all 0.2s ease;
  flex-shrink: 0;
  cursor: pointer;
}

.thumbnail-item:hover {
  border-color: #3b82f6;
  transform: scale(1.05);
}

.thumbnail-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumbnail-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.zoom-icon {
  color: white;
  font-size: 20px;
  cursor: pointer;
}

.thumbnail-delete {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 20px;
  height: 20px;
  background: #ef4444;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  font-size: 12px;
  transition: all 0.2s ease;
}

.thumbnail-delete:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.mark-section {
  margin-top: 24px;
  padding: 20px;
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.mark-section h4 {
  margin: 0 0 16px 0;
  font-size: 16px;
  font-weight: 600;
  color: #374151;
}

.mark-description {
  margin-top: 12px;
}

.remark-section {
  margin-top: 24px;
  padding: 20px;
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.form-footer {
  margin-top: 32px;
  padding: 24px;
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  display: flex;
  justify-content: center;
  gap: 16px;
}

/* ËÆ¢ÂçïÊ†áËÆ∞Ê†∑Âºè */
.order-tags {
  display: flex;
  gap: 16px;
}

/* Â§áÊ≥®Ê†∑Âºè */
.remarks {
  width: 100%;
}

/* Êìç‰ΩúÊåâÈíÆÊ†∑Âºè */
.form-footer {
  display: flex;
  justify-content: flex-end;
  gap: 16px;
  padding-top: 24px;
  border-top: 1px solid #e5e7eb;
  margin-top: 32px;
}

/* ÂºπÁ™óÊ†∑Âºè */
.customer-search {
  margin-bottom: 16px;
}

.customer-list {
  max-height: 400px;
  overflow-y: auto;
}

.confirm-content {
  max-height: 600px;
  overflow-y: auto;
}

.confirm-section {
  margin-bottom: 24px;
}

.confirm-title {
  margin: 0 0 16px 0;
  font-size: 16px;
  font-weight: 600;
  color: #374151;
  padding-bottom: 8px;
  border-bottom: 2px solid #e5e7eb;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.info-item .label {
  min-width: 80px;
  font-weight: 600;
  color: #6b7280;
  font-size: 13px;
}

.info-item .value {
  color: #374151;
  font-weight: 500;
  flex: 1;
}

/* ËÆ¢ÂçïÁ°ÆËÆ§ÂºπÁ™ó - ‰∏§ÂàóÈáëÈ¢ùÊ±áÊÄªÊ†∑Âºè */
.amount-summary-two-columns {
  display: flex;
  gap: 24px;
  margin-top: 8px;
}

.amount-column {
  flex: 1;
  padding: 16px;
  border-radius: 12px;
  background: #fafbfc;
  border: 1px solid #e5e7eb;
}

.amount-column.basic-amounts {
  background: #f8fafc;
  border-color: #0ea5e9;
  position: relative;
}

.amount-column.basic-amounts::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%);
  border-radius: 12px 12px 0 0;
}

.amount-column.important-amounts {
  background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%);
  border-color: #f59e0b;
  position: relative;
}

.amount-column.important-amounts::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
  border-radius: 12px 12px 0 0;
}

.amount-column .amount-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.amount-column .amount-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.amount-column .amount-item .label {
  font-size: 13px;
  font-weight: 500;
  color: #6b7280;
  margin: 0;
}

.amount-column .amount-item .value {
  font-size: 15px;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.amount-column .amount-item .value.discount {
  color: #dc2626;
}

.amount-column .discount-info {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
}

.amount-column .discount-percent {
  font-size: 11px;
  color: #059669;
  font-weight: 500;
  background: rgba(5, 150, 105, 0.1);
  padding: 2px 6px;
  border-radius: 4px;
}

.amount-column.basic-amounts .amount-item .label {
  color: #0369a1;
  font-weight: 600;
}

.amount-column.basic-amounts .amount-item .value {
  color: #0369a1;
  font-weight: 700;
}

.amount-column.important-amounts .amount-item .label {
  color: #92400e;
  font-weight: 600;
}

.amount-column.important-amounts .amount-item .value {
  color: #92400e;
  font-weight: 700;
  font-size: 16px;
}

.amount-column.important-amounts .amount-item.total-amount .value {
  color: #dc2626;
  font-size: 18px;
}

.amount-column.important-amounts .amount-item.deposit-amount .value {
  color: #059669;
}

.amount-column.important-amounts .amount-item.collect-amount .value {
  color: #7c3aed;
}

.image-viewer {
  text-align: center;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1024px) {
  .customer-info,
  .delivery-info {
    grid-template-columns: 1fr;
  }

  .amount-row-main {
    flex-direction: column;
    gap: 12px;
  }

  .amount-card {
    min-width: auto;
    max-width: none;
  }

  .amount-row-detail {
    flex-direction: column;
    gap: 16px;
  }

  .discount-input-section {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
}

@media (max-width: 768px) {
  .order-edit-page {
    padding: 12px;
  }

  .page-title {
    font-size: 24px;
    margin-bottom: 16px;
  }

  .section-content {
    padding: 16px;
  }

  .customer-field,
  .delivery-field {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .field-label {
    min-width: auto;
  }

  .field-input {
    width: 100%;
  }

  .product-list {
    grid-template-columns: 1fr;
  }

  .form-footer {
    flex-direction: column;
  }

  .form-footer .el-button {
    width: 100%;
  }

  .amount-summary-two-columns {
    flex-direction: column;
    gap: 16px;
  }

  .info-grid {
    grid-template-columns: 1fr;
  }
}

/* ÊäòÂè†ÂõæÊ†áÊ†∑Âºè */
.collapse-icon {
  transition: transform 0.3s ease;
}

.collapse-icon.collapsed {
  transform: rotate(-90deg);
}
</style>
