# 绩效管理"全部"标签页功能说明

## 功能概述

在财务管理模块的绩效管理子菜单中,在"无效"标签页后面新增了"全部"标签页,方便用户一次性查看所有绩效订单,无论是否已处理、有效或无效,都在这里呈现,方便全选导出所有绩效订单。

## 功能特点

### 1. 标签页位置
- 位置: 待处理 -> 有效 -> 无效 -> **全部** (新增)
- 显示: 灰色数字徽章,显示所有绩效订单的总数

### 2. 数据范围
"全部"标签页显示所有已发货后的订单,包括:
- 待处理订单 (performanceStatus = 'pending' 或 NULL)
- 有效订单 (performanceStatus = 'valid')
- 无效订单 (performanceStatus = 'invalid')

### 3. 筛选条件
"全部"标签页支持所有现有的筛选条件:
- 日期范围筛选
- 批量搜索(订单号、客户名称、客户电话)
- 部门筛选
- 销售人员筛选
- 系数筛选

### 4. 批量操作
在"全部"标签页中,可以:
- 全选所有订单
- 批量导出
- 批量设为有效
- 批量设为无效
- 批量设置系数
- 批量设置备注

## 实现细节

### 前端修改

#### 1. 标签页定义 (`src/views/Finance/PerformanceManage.vue`)

```vue
<el-tab-pane name="all">
  <template #label>
    <span>全部 <el-badge :value="statistics.totalCount || 0" :max="999" type="info" class="tab-badge tab-badge-muted" /></span>
  </template>
</el-tab-pane>
```

#### 2. 统计数据类型 (`src/api/finance.ts`)

```typescript
export interface PerformanceManageStatistics {
  pendingCount: number
  processedCount: number
  validCount: number
  invalidCount: number
  totalCount: number  // 🔥 新增
  coefficientSum: number
}
```

#### 3. 标签页切换逻辑

```typescript
const handleStatusTabChange = (tabName: string) => {
  activeStatusTab.value = tabName
  // 🔥 如果选择"全部"标签页,不传递performanceStatus参数
  statusFilter.value = tabName === 'all' ? '' : tabName
  pagination.currentPage = 1
  loadData()
}
```

### 后端修改

#### 1. 统计接口 (`backend/src/routes/finance.ts`)

```typescript
const [pendingCount, processedCount, validCount, invalidCount, totalCount, coefficientSum] = await Promise.all([
  // 待处理
  queryBuilder.clone().andWhere('(order.performanceStatus = :ps OR order.performanceStatus IS NULL)', { ps: 'pending' }).getCount(),
  // 已处理
  queryBuilder.clone().andWhere('order.performanceStatus IS NOT NULL AND order.performanceStatus != :ps', { ps: 'pending' }).getCount(),
  // 有效
  queryBuilder.clone().andWhere('order.performanceStatus = :ps', { ps: 'valid' }).getCount(),
  // 无效
  queryBuilder.clone().andWhere('order.performanceStatus = :ps', { ps: 'invalid' }).getCount(),
  // 🔥 全部：所有已发货订单
  queryBuilder.clone().getCount(),
  // 系数合计
  queryBuilder.clone()
    .andWhere('order.performanceStatus = :ps', { ps: 'valid' })
    .andWhere('order.performanceCoefficient > 0')
    .select('SUM(order.performanceCoefficient)', 'total')
    .getRawOne()
]);
```

#### 2. 列表接口

列表接口无需修改,当不传递 `performanceStatus` 参数时,自动返回所有状态的订单。

## 使用场景

### 场景1: 导出所有绩效订单
```
1. 进入财务管理 -> 绩效管理
2. 点击"全部"标签页
3. 选择日期范围(如本月)
4. 点击"全选"按钮
5. 点击"批量导出"按钮
6. 导出包含所有状态的绩效订单
```

### 场景2: 查看特定部门的所有订单
```
1. 进入财务管理 -> 绩效管理
2. 点击"全部"标签页
3. 选择部门筛选
4. 查看该部门所有绩效订单(包括待处理、有效、无效)
```

### 场景3: 批量处理混合状态订单
```
1. 进入财务管理 -> 绩效管理
2. 点击"全部"标签页
3. 使用批量搜索功能输入订单号
4. 选中需要处理的订单
5. 批量设置状态或系数
```

## 数据统计

### 统计卡片
顶部统计卡片保持不变,显示:
- 待处理: 289
- 已处理: 31
- 有效单数: 16
- 系数合计: 16.0

### 标签页徽章
- 待处理: 显示待处理订单数量
- 有效: 显示有效订单数量(绿色)
- 无效: 显示无效订单数量(灰色)
- **全部: 显示所有订单数量(灰色)** ← 新增

## 注意事项

1. **数据一致性**: "全部"标签页的数量 = 待处理 + 有效 + 无效
2. **筛选条件**: 所有筛选条件在"全部"标签页中同样生效
3. **批量操作**: 在"全部"标签页中可以对不同状态的订单进行批量操作
4. **导出功能**: 导出时会包含订单的当前状态信息

## 测试建议

### 1. 基本功能测试
```
1. 点击"全部"标签页
2. 验证显示所有状态的订单
3. 检查徽章数字是否正确
```

### 2. 筛选功能测试
```
1. 在"全部"标签页中
2. 测试日期范围筛选
3. 测试部门筛选
4. 测试销售人员筛选
5. 验证筛选结果包含所有状态
```

### 3. 批量操作测试
```
1. 在"全部"标签页中
2. 选择多个不同状态的订单
3. 测试批量导出
4. 测试批量设置状态
5. 验证操作成功
```

### 4. 数据一致性测试
```
1. 记录各标签页的数量
2. 验证: 全部 = 待处理 + 有效 + 无效
3. 切换不同筛选条件
4. 再次验证数量一致性
```

## 修复时间

2026-02-24

## 修复人员

Kiro AI Assistant
