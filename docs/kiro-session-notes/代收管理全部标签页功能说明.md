# 代收管理"全部"标签页功能说明

## 功能概述

在财务管理模块的代收管理子菜单中,在"已改代收"标签页后面新增了"全部"标签页,方便用户一次性查看所有代收订单,无论是待处理、已返款还是已改代收,都在这里呈现,方便全选导出所有代收订单。

## 功能特点

### 1. 标签页位置
- 位置: 待处理 -> 已返款 -> 已改代收 -> **全部** (新增)
- 显示: 所有代收订单,不区分状态

### 2. 数据范围
"全部"标签页显示所有已发货的代收订单,包括:
- 待处理订单 (codStatus = 'pending')
- 已返款订单 (codStatus = 'returned')
- 已改代收订单 (codStatus = 'cancelled')

### 3. 筛选条件
"全部"标签页支持所有现有的筛选条件:
- 日期范围筛选(发货日期)
- 批量搜索(订单号、手机号、客户名称、物流单号)
- 部门筛选
- 销售人员筛选
- 订单状态筛选

### 4. 批量操作
在"全部"标签页中,可以:
- 全选所有订单
- 批量改代收
- 批量改返款
- 查看订单详情

## 实现细节

### 前端修改

#### 1. 标签页定义 (`src/views/Finance/CodCollection.vue`)

```vue
<el-tabs v-model="activeTab" @tab-change="handleTabChange" class="status-tabs">
  <el-tab-pane name="pending" label="待处理" />
  <el-tab-pane name="returned" label="已返款" />
  <el-tab-pane name="cancelled" label="已改代收" />
  <el-tab-pane name="all" label="全部" />  <!-- 🔥 新增 -->
</el-tabs>
```

#### 2. 类型定义

```typescript
const activeTab = ref<'pending' | 'returned' | 'cancelled' | 'all'>('pending')
```

### 后端支持

后端代码 (`backend/src/routes/codCollection.ts`) 已经支持"全部"标签页:

```typescript
// 标签页筛选
if (tab === 'pending') {
  queryBuilder.andWhere('o.cod_status = :codStatus', { codStatus: 'pending' });
} else if (tab === 'returned') {
  queryBuilder.andWhere('o.cod_status = :codStatus', { codStatus: 'returned' });
} else if (tab === 'cancelled') {
  queryBuilder.andWhere('o.cod_status = :codStatus', { codStatus: 'cancelled' });
}
// 🔥 当tab不是上述三个值时(如'all'),不添加cod_status筛选,返回所有状态
```

## 使用场景

### 场景1: 导出所有代收订单
```
1. 进入财务管理 -> 代收管理
2. 点击"全部"标签页
3. 选择日期范围(如本月)
4. 点击表格的全选按钮
5. 使用导出功能导出所有代收订单
```

### 场景2: 查看特定部门的所有代收订单
```
1. 进入财务管理 -> 代收管理
2. 点击"全部"标签页
3. 选择部门筛选
4. 查看该部门所有代收订单(包括待处理、已返款、已改代收)
```

### 场景3: 批量处理混合状态订单
```
1. 进入财务管理 -> 代收管理
2. 点击"全部"标签页
3. 使用批量搜索功能输入订单号
4. 选中需要处理的订单
5. 批量改代收或批量改返款
```

### 场景4: 统计分析
```
1. 进入财务管理 -> 代收管理
2. 点击"全部"标签页
3. 选择时间范围
4. 查看所有代收订单的整体情况
5. 分析不同状态订单的分布
```

## 数据统计

### 统计卡片
顶部统计卡片保持不变,显示:
- 今日代收: ¥0.00
- 当月代收: ¥0.00
- 取消代收: ¥0.00
- 已返款: ¥0.00
- 未返款: ¥0.00

### 标签页
- 待处理: 显示codStatus='pending'的订单
- 已返款: 显示codStatus='returned'的订单
- 已改代收: 显示codStatus='cancelled'的订单
- **全部: 显示所有状态的订单** ← 新增

## 表格字段说明

在"全部"标签页中,表格显示以下字段:
- 订单号: 可点击跳转到订单详情
- 客户姓名: 可点击跳转到客户详情
- 订单状态: 已发货、已签收、已完成、拒收等
- 订单金额: 订单总金额
- 代收金额: 需要代收的金额(高亮显示)
- 代收状态: 无代收、未返款、已返款、已取消
- 销售人员: 订单归属的销售人员
- 物流单号: 可点击查看物流轨迹
- 最新物流动态: 显示物流最新状态
- 下单时间: 订单创建时间
- 操作: 详情、改代收、返款

## 代收状态说明

### 1. 无代收 (灰色)
- 条件: codAmount = 0
- 说明: 该订单不需要代收款项

### 2. 未返款 (红色)
- 条件: codAmount > 0 且 codStatus = 'pending'
- 说明: 需要代收但尚未返款

### 3. 已返款 (绿色)
- 条件: codStatus = 'returned'
- 说明: 代收款项已返还

### 4. 已取消 (橙色)
- 条件: codStatus = 'cancelled'
- 说明: 代收已取消或修改

## 注意事项

1. **数据范围**: "全部"标签页只显示已发货的订单(status IN shipped_statuses)
2. **筛选条件**: 所有筛选条件在"全部"标签页中同样生效
3. **批量操作**: 在"全部"标签页中可以对不同状态的订单进行批量操作
4. **日期筛选**: 使用发货日期(shipped_at)进行筛选,不是下单日期

## 测试建议

### 1. 基本功能测试
```
1. 点击"全部"标签页
2. 验证显示所有状态的代收订单
3. 检查数据是否包含待处理、已返款、已改代收
```

### 2. 筛选功能测试
```
1. 在"全部"标签页中
2. 测试日期范围筛选
3. 测试部门筛选
4. 测试销售人员筛选
5. 测试订单状态筛选
6. 验证筛选结果包含所有代收状态
```

### 3. 批量操作测试
```
1. 在"全部"标签页中
2. 选择多个不同状态的订单
3. 测试批量改代收
4. 测试批量改返款
5. 验证操作成功
```

### 4. 批量搜索测试
```
1. 在"全部"标签页中
2. 使用批量搜索功能
3. 输入多个订单号(一行一个)
4. 验证搜索结果包含所有状态
```

### 5. 数据一致性测试
```
1. 记录各标签页的订单数量
2. 验证: 全部 >= 待处理 + 已返款 + 已改代收
3. 切换不同筛选条件
4. 再次验证数量关系
```

## 与绩效管理的区别

### 绩效管理"全部"标签页
- 显示所有已发货订单的绩效信息
- 关注订单的有效性和系数
- 用于绩效统计和佣金计算

### 代收管理"全部"标签页
- 显示所有已发货订单的代收信息
- 关注代收金额和返款状态
- 用于代收款项管理和财务对账

## 修复时间

2026-02-24

## 修复人员

Kiro AI Assistant
