# æ”¯ä»˜ç³»ç»Ÿå®Œæˆæƒ…å†µæŠ¥å‘Š

## ğŸ“‹ å®Œæˆæ¦‚è§ˆ

âœ… **å·²å®Œæˆ**ï¼šæ”¯ä»˜æµç¨‹çš„æ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å®ç°  
âœ… **å·²å®Œæˆ**ï¼šCRMæˆæƒéªŒè¯é›†æˆ  
âš ï¸ **å¾…é…ç½®**ï¼šéœ€è¦é…ç½®çœŸå®çš„æ”¯ä»˜å‚æ•°å’ŒçŸ­ä¿¡æœåŠ¡  
ğŸ§ª **å¯æµ‹è¯•**ï¼šæä¾›äº†å®Œæ•´çš„æµ‹è¯•æ¥å£å’Œæ–‡æ¡£  

---

## ğŸ¯ å·²å®Œæˆçš„åŠŸèƒ½

### 1. åç«¯APIæ¥å£ âœ…

#### å…¬å¼€æ¥å£ (`/api/v1/public/*`)
- âœ… `POST /register` - ç§Ÿæˆ·æ³¨å†Œ
- âœ… `GET /packages` - è·å–å¥—é¤åˆ—è¡¨
- âœ… `POST /payment/create` - åˆ›å»ºæ”¯ä»˜è®¢å•
- âœ… `GET /payment/query/:orderNo` - æŸ¥è¯¢è®¢å•çŠ¶æ€
- âœ… `POST /payment/wechat/notify` - å¾®ä¿¡æ”¯ä»˜å›è°ƒ
- âœ… `POST /payment/alipay/notify` - æ”¯ä»˜å®å›è°ƒ
- âœ… `POST /payment/mock-pay/:orderNo` - æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

#### ç§Ÿæˆ·æˆæƒæ¥å£ (`/api/v1/tenant-license/*`)
- âœ… `POST /verify` - éªŒè¯æˆæƒç 
- âœ… `POST /heartbeat` - å¿ƒè·³æ£€æµ‹
- âœ… `GET /info` - è·å–æˆæƒä¿¡æ¯

#### ç®¡ç†åå°æ¥å£ (`/api/v1/admin/*`)
- âœ… `POST /auth/login` - ç®¡ç†å‘˜ç™»å½•
- âœ… `GET /tenants` - ç§Ÿæˆ·ç®¡ç†
- âœ… `GET /packages` - å¥—é¤ç®¡ç†
- âœ… `GET /payment/orders` - æ”¯ä»˜è®¢å•ç®¡ç†
- âœ… `GET /licenses` - æˆæƒç®¡ç†

### 2. CRMæˆæƒéªŒè¯é›†æˆ âœ…

#### å‰ç«¯ç»„ä»¶
- âœ… `TenantVerifyDialog.vue` - ç§Ÿæˆ·æˆæƒéªŒè¯å¼¹çª—
- âœ… `LicenseInfoPanel.vue` - æˆæƒä¿¡æ¯é¢æ¿
- âœ… `LicenseActivateDialog.vue` - æˆæƒæ¿€æ´»å¼¹çª—

#### å‰ç«¯æœåŠ¡
- âœ… `tenantLicense.ts` - ç§Ÿæˆ·æˆæƒAPI
- âœ… `licenseHeartbeatService.ts` - æˆæƒå¿ƒè·³æ£€æµ‹æœåŠ¡

#### ç™»å½•é¡µé¢é›†æˆ
- âœ… ç™»å½•å‰æˆæƒç éªŒè¯ï¼ˆSaaSæ¨¡å¼ï¼‰
- âœ… ç§Ÿæˆ·ä¿¡æ¯æ˜¾ç¤º
- âœ… åˆ‡æ¢ç§Ÿæˆ·åŠŸèƒ½

### 3. æ•°æ®åº“è¡¨ç»“æ„ âœ…

- âœ… `tenants` - ç§Ÿæˆ·è¡¨
- âœ… `tenant_packages` - å¥—é¤è¡¨
- âœ… `tenant_license_logs` - æˆæƒæ—¥å¿—è¡¨
- âœ… `payment_configs` - æ”¯ä»˜é…ç½®è¡¨
- âœ… `payment_orders` - æ”¯ä»˜è®¢å•è¡¨
- âœ… `payment_logs` - æ”¯ä»˜æ—¥å¿—è¡¨
- âœ… `system_license` - ç§æœ‰éƒ¨ç½²æˆæƒè¡¨

### 4. æ ¸å¿ƒæœåŠ¡ç±» âœ…

- âœ… `PaymentService` - æ”¯ä»˜æœåŠ¡ï¼ˆåˆ›å»ºè®¢å•ã€å¤„ç†å›è°ƒã€æ¿€æ´»ç§Ÿæˆ·ï¼‰
- âœ… `TenantService` - ç§Ÿæˆ·æœåŠ¡ï¼ˆæ³¨å†Œã€éªŒè¯ã€ç®¡ç†ï¼‰
- âœ… `LicenseService` - æˆæƒæœåŠ¡ï¼ˆç§æœ‰éƒ¨ç½²æˆæƒï¼‰
- âœ… `AliyunSmsService` - çŸ­ä¿¡æœåŠ¡ï¼ˆå‘é€é€šçŸ¥ï¼‰

---

## ğŸ”„ å®Œæ•´æ”¯ä»˜æµç¨‹

```
å®˜ç½‘æ³¨å†Œ â†’ é€‰æ‹©å¥—é¤ â†’ åˆ›å»ºè®¢å• â†’ æ”¯ä»˜ â†’ å›è°ƒå¤„ç† â†’ ç”Ÿæˆæˆæƒç  â†’ å‘é€çŸ­ä¿¡ â†’ CRMæ¿€æ´»
```

### æµç¨‹è¯¦è§£

1. **ç”¨æˆ·åœ¨å®˜ç½‘æ³¨å†Œ**
   - å¡«å†™å…¬å¸ä¿¡æ¯ã€è”ç³»æ–¹å¼
   - é€‰æ‹©å¥—é¤ç±»å‹

2. **åˆ›å»ºæ”¯ä»˜è®¢å•**
   - ç”Ÿæˆè®¢å•å·
   - è¿”å›æ”¯ä»˜äºŒç»´ç 

3. **ç”¨æˆ·å®Œæˆæ”¯ä»˜**
   - æ‰«ç æ”¯ä»˜ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
   - æ”¯ä»˜å¹³å°å›è°ƒé€šçŸ¥

4. **ç³»ç»Ÿå¤„ç†å›è°ƒ**
   - éªŒè¯ç­¾å
   - æ›´æ–°è®¢å•çŠ¶æ€
   - ç”Ÿæˆæˆæƒç ï¼ˆTENANT-XXXX-XXXX-XXXX-XXXXï¼‰
   - æ¿€æ´»ç§Ÿæˆ·
   - å‘é€çŸ­ä¿¡é€šçŸ¥

5. **CRMç™»å½•éªŒè¯**
   - ç”¨æˆ·è¾“å…¥æˆæƒç 
   - éªŒè¯ç§Ÿæˆ·èº«ä»½
   - æ˜¾ç¤ºç§Ÿæˆ·ä¿¡æ¯
   - å…è®¸ç™»å½•

---

## ğŸ” éƒ¨ç½²æ¨¡å¼

### SaaSæ¨¡å¼ï¼ˆå¤šç§Ÿæˆ·ï¼‰
- éœ€è¦æˆæƒç éªŒè¯
- æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»
- å¿ƒè·³æ£€æµ‹æˆæƒçŠ¶æ€
- é…ç½®ï¼š`VITE_DEPLOY_MODE=saas`

### ç§æœ‰éƒ¨ç½²æ¨¡å¼
- ä¸éœ€è¦æˆæƒç éªŒè¯
- å•ç§Ÿæˆ·ä½¿ç”¨
- é…ç½®ï¼š`VITE_DEPLOY_MODE=private`

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. å¼€å‘ç¯å¢ƒå¿«é€Ÿæµ‹è¯•

```bash
# 1. æ³¨å†Œç§Ÿæˆ·
curl -X POST http://localhost:3000/api/v1/public/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•å…¬å¸",
    "phone": "13800138000",
    "email": "test@example.com",
    "packageCode": "SAAS_PRO"
  }'

# 2. åˆ›å»ºæ”¯ä»˜è®¢å•
curl -X POST http://localhost:3000/api/v1/public/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "tenantId": "ç§Ÿæˆ·ID",
    "packageId": 2,
    "payType": "wechat",
    "billingCycle": "monthly"
  }'

# 3. æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
curl -X POST http://localhost:3000/api/v1/public/payment/mock-pay/è®¢å•å·

# 4. éªŒè¯æˆæƒç 
curl -X POST http://localhost:3000/api/v1/tenant-license/verify \
  -H "Content-Type: application/json" \
  -d '{"licenseKey": "TENANT-XXXX-XXXX-XXXX-XXXX"}'
```

### 2. CRMç™»å½•æµ‹è¯•

1. è®¾ç½®ç¯å¢ƒå˜é‡ `VITE_DEPLOY_MODE=saas`
2. è®¿é—® CRM ç™»å½•é¡µé¢
3. ç³»ç»Ÿä¼šå¼¹å‡ºæˆæƒç éªŒè¯å¼¹çª—
4. è¾“å…¥æˆæƒç éªŒè¯
5. éªŒè¯æˆåŠŸåæ˜¾ç¤ºç§Ÿæˆ·ä¿¡æ¯
6. è¾“å…¥ç”¨æˆ·åå¯†ç ç™»å½•

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å‰ç«¯ .env
VITE_DEPLOY_MODE=private  # æˆ– saas

# åç«¯ .env
ENABLE_ADMIN=true
```

### æ”¯ä»˜é…ç½®

å¤åˆ¶ `backend/.env.payment.example` ä¸º `.env.payment`ï¼Œå¡«å…¥çœŸå®é…ç½®ã€‚

---

## ğŸ“Š å…³é”®æ–‡ä»¶æ¸…å•

### åç«¯
- `backend/src/app.ts` - è·¯ç”±æ³¨å†Œ
- `backend/src/routes/public/` - å…¬å¼€API
- `backend/src/routes/tenantLicense.ts` - æˆæƒéªŒè¯
- `backend/src/services/PaymentService.ts` - æ”¯ä»˜æœåŠ¡
- `backend/src/services/TenantService.ts` - ç§Ÿæˆ·æœåŠ¡

### å‰ç«¯
- `src/views/Login.vue` - ç™»å½•é¡µé¢ï¼ˆå«æˆæƒéªŒè¯ï¼‰
- `src/components/License/TenantVerifyDialog.vue` - æˆæƒéªŒè¯å¼¹çª—
- `src/api/tenantLicense.ts` - æˆæƒAPI
- `src/services/licenseHeartbeatService.ts` - å¿ƒè·³æœåŠ¡

### æ•°æ®åº“
- `database/migrations/complete_payment_system.sql` - å®Œæ•´è¡¨ç»“æ„

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¼˜å…ˆçº§1ï¼šåŠŸèƒ½å®Œå–„
- [ ] é‚®ä»¶é€šçŸ¥æœåŠ¡
- [ ] è®¢å•é€€æ¬¾åŠŸèƒ½
- [ ] å¥—é¤å‡çº§/é™çº§
- [ ] æ‰¹é‡æˆæƒç®¡ç†

### ä¼˜å…ˆçº§2ï¼šè¿è¥æ”¯æŒ
- [ ] æ•°æ®ç»Ÿè®¡æŠ¥è¡¨
- [ ] è¥é”€æ´»åŠ¨æ”¯æŒ
- [ ] å®¢æˆ·æœåŠ¡å·¥å…·
- [ ] è´¢åŠ¡å¯¹è´¦åŠŸèƒ½

---

**æ”¯ä»˜ç³»ç»Ÿå’ŒCRMæˆæƒéªŒè¯å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•å’Œéƒ¨ç½²ï¼** ğŸ‰
