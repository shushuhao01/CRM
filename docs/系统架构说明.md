# 系统架构说明

## 项目概述

这是一个基于 Vue 3 + TypeScript + Element Plus 的现代化 CRM 客户关系管理系统，采用前后端分离架构。

## 技术栈

### 前端技术栈
- **框架**: Vue 3.4+ (Composition API)
- **语言**: TypeScript 5.0+
- **构建工具**: Vite 5.0+
- **UI 框架**: Element Plus 2.5+
- **状态管理**: Pinia 2.1+
- **路由**: Vue Router 4.2+
- **HTTP 客户端**: Axios 1.6+
- **图表**: ECharts 5.4+
- **富文本编辑器**: Quill 2.0+

### 后端技术栈
- **运行时**: Node.js 18+
- **框架**: Express 4.18+
- **语言**: TypeScript
- **数据库**: MySQL 8.0+
- **ORM**: TypeORM 0.3+
- **进程管理**: PM2

### 开发工具
- **代码规范**: ESLint + Prettier
- **Git 钩子**: Husky
- **包管理器**: npm / pnpm

---

## 项目结构

```
CRM/
├── backend/                 # 后端服务
│   ├── src/
│   │   ├── app.ts          # 应用入口
│   │   ├── config/         # 配置文件
│   │   ├── controllers/    # 控制器
│   │   ├── routes/         # 路由
│   │   ├── services/       # 业务逻辑
│   │   ├── models/         # 数据模型
│   │   └── utils/          # 工具函数
│   ├── package.json
│   └── tsconfig.json
│
├── src/                     # 前端源码
│   ├── api/                # API 接口
│   ├── assets/             # 静态资源
│   ├── components/         # 公共组件
│   ├── config/             # 配置文件
│   ├── router/             # 路由配置
│   ├── stores/             # Pinia 状态管理
│   ├── utils/              # 工具函数
│   ├── views/              # 页面组件
│   ├── App.vue             # 根组件
│   └── main.ts             # 应用入口
│
├── public/                  # 公共资源
├── database/               # 数据库脚本
├── dist/                   # 构建输出
├── node_modules/           # 依赖包
│
├── index.html              # HTML 模板
├── package.json            # 项目配置
├── tsconfig.json           # TS 配置
├── vite.config.ts          # Vite 配置
├── .env                    # 环境变量
├── .env.development        # 开发环境变量
├── .env.production         # 生产环境变量
└── README.md               # 项目说明
```

---

## 核心模块

### 1. 用户认证模块
**位置**: `src/stores/user.ts`, `src/services/authApiService.ts`

**功能**:
- 用户登录/登出
- Token 管理
- 权限验证
- 用户信息管理

**特点**:
- 支持预设账号（源代码配置）
- 支持动态创建用户
- JWT Token 认证
- 权限实时验证

---

### 2. 权限管理模块
**位置**: `src/config/defaultRolePermissions.ts`, `src/stores/user.ts`

**功能**:
- 基于角色的访问控制（RBAC）
- 动态权限配置
- 菜单权限控制
- 按钮权限控制
- 数据权限控制

**权限检查方式**:
```typescript
// 1. 在组件中检查权限
const userStore = useUserStore()
const hasPermission = userStore.hasPermission('customer.add')

// 2. 使用指令控制按钮
<el-button v-permission="'customer.add'">新增</el-button>

// 3. 路由守卫自动检查
router.beforeEach((to, from, next) => {
  // 自动检查路由权限
})
```

---

### 3. 数据存储模块
**位置**: `src/utils/storage.ts`, `src/utils/env.ts`

**存储策略**:
- **开发环境**: localStorage（前端模拟）
- **生产环境**: MySQL 数据库（后端 API）

**自动切换**:
```typescript
// 系统自动检测环境并切换存储方式
const isProduction = import.meta.env.VITE_USE_REAL_API === 'true'

if (isProduction) {
  // 使用后端 API
  await axios.post('/api/customers', data)
} else {
  // 使用 localStorage
  localStorage.setItem('crm_customers', JSON.stringify(data))
}
```

**数据键名规范**:
```
crm_mock_users          # 用户数据
crm_mock_customers      # 客户数据
crm_mock_orders         # 订单数据
crm_mock_departments    # 部门数据
crm_mock_roles          # 角色数据
crm_performance_shares  # 业绩分享数据
crm_logistics_status    # 物流状态数据
```

---

### 4. 客户管理模块
**位置**: `src/views/Customer/`, `src/api/customerDetail.ts`

**功能**:
- 客户列表（分页、搜索、筛选）
- 客户新增/编辑
- 客户详情
- 客户标签管理
- 客户分组管理
- 客户等级管理
- 客户导入/导出
- 客户分享

**数据字段**:
```typescript
interface Customer {
  id: string
  name: string              // 客户姓名
  phone: string             // 联系电话
  wechat: string           // 微信号
  address: string          // 地址
  level: string            // 客户等级
  tags: string[]           // 标签
  source: string           // 来源
  status: string           // 状态
  salesPersonId: string    // 销售员ID
  createTime: string       // 创建时间
  updateTime: string       // 更新时间
}
```

---

### 5. 订单管理模块
**位置**: `src/views/Order/`, `src/stores/order.ts`

**功能**:
- 订单列表（多状态筛选）
- 订单新增/编辑
- 订单详情
- 订单审核
- 订单导出
- 自定义字段配置

**订单状态流转**:
```
待审核 → 审核通过 → 待发货 → 已发货 → 已签收 → 已完成
       ↓
    审核不通过 → 已取消
```

**自定义字段**:
系统支持动态配置订单自定义字段，配置保存在 `src/stores/orderFieldConfig.ts`。

---

### 6. 业绩统计模块
**位置**: `src/views/Performance/`, `src/stores/performance.ts`

**功能**:
- 个人业绩统计
- 团队业绩统计
- 业绩分析（图表）
- 业绩分享配置
- 业绩排名

**统计维度**:
- 订单数量
- 订单金额
- 客户数量
- 成交率
- 时间范围（日/周/月/年）

**业绩守恒原则**:
```
团队总业绩 = Σ(个人业绩 + 分享业绩)
```

---

### 7. 物流管理模块
**位置**: `src/views/Logistics/`, `src/stores/logisticsStatus.ts`

**功能**:
- 物流列表
- 物流跟踪
- 发货列表
- 状态更新（批量）
- 物流公司管理
- 顺丰/圆通 API 对接

**物流状态**:
```typescript
enum LogisticsStatus {
  PENDING = 'pending',           // 待发货
  SHIPPED = 'shipped',           // 已发货
  IN_TRANSIT = 'in_transit',     // 运输中
  DELIVERED = 'delivered',       // 已签收
  REJECTED = 'rejected',         // 拒收
  RETURNED = 'returned'          // 退回
}
```

**API 对接**:
- 顺丰丰桥平台
- 圆通快递 API
- 自动物流跟踪

---

### 8. 售后管理模块
**位置**: `src/views/Service/`, `src/utils/servicePermission.ts`

**功能**:
- 售后列表
- 售后新增/编辑
- 售后详情
- 售后数据统计
- 服务类型配置
- 售后分配

**服务类型**:
- 退货退款
- 换货
- 维修
- 咨询
- 投诉

**权限控制**:
客服拥有完整的售后管理权限，包括新建售后和查看售后数据。

---

### 9. 资料管理模块
**位置**: `src/views/Data/`

**功能**:
- 资料列表
- 资料搜索
- 资料详情
- 资料流转（订单签收自动创建）

**数据来源**:
订单签收后自动创建资料记录，包含客户信息、订单信息、物流信息。

---

### 10. 系统管理模块
**位置**: `src/views/System/`

**功能**:
- 用户管理
- 角色管理
- 部门管理
- 系统设置
- 数据备份
- 数据迁移

**仅管理员可访问**。

---

## 数据流转

### 1. 客户 → 订单 → 物流 → 售后 → 资料

```
客户新增 → 创建订单 → 订单审核 → 发货 → 物流跟踪 → 签收 → 自动创建资料
                                                    ↓
                                                售后服务
```

### 2. 业绩计算流程

```
订单创建 → 订单审核通过 → 计入业绩 → 业绩分享 → 团队业绩汇总
```

### 3. 权限验证流程

```
用户登录 → 获取角色 → 加载权限 → 路由守卫 → 菜单渲染 → 按钮控制
```

---

## 状态管理

使用 Pinia 进行全局状态管理：

### 主要 Store

| Store | 文件 | 功能 |
|-------|------|------|
| userStore | `src/stores/user.ts` | 用户信息、权限 |
| customerStore | `src/stores/customer.ts` | 客户数据 |
| orderStore | `src/stores/order.ts` | 订单数据 |
| performanceStore | `src/stores/performance.ts` | 业绩数据 |
| departmentStore | `src/stores/department.ts` | 部门数据 |
| configStore | `src/stores/config.ts` | 系统配置 |
| notificationStore | `src/stores/notification.ts` | 消息通知 |

---

## API 设计

### RESTful API 规范

```
GET    /api/customers          # 获取客户列表
POST   /api/customers          # 创建客户
GET    /api/customers/:id      # 获取客户详情
PUT    /api/customers/:id      # 更新客户
DELETE /api/customers/:id      # 删除客户
```

### 响应格式

```typescript
interface ApiResponse<T> {
  code: number        // 状态码：200 成功，其他失败
  message: string     // 提示信息
  data: T            // 返回数据
}
```

---

## 安全机制

### 1. 认证安全
- JWT Token 认证
- Token 过期自动刷新
- 登录失败次数限制

### 2. 权限安全
- 前端路由守卫
- 后端接口权限验证
- 数据权限隔离

### 3. 数据安全
- 敏感数据加密存储
- 电话号码脱敏显示
- 操作日志记录

### 4. XSS 防护
- 输入内容过滤
- 富文本编辑器安全配置
- CSP 策略

---

## 性能优化

### 1. 前端优化
- 路由懒加载
- 组件按需加载
- 图片懒加载
- 虚拟滚动（大数据列表）
- 防抖节流

### 2. 数据优化
- 分页加载
- 数据缓存
- 请求合并
- 响应压缩

### 3. 构建优化
- 代码分割
- Tree Shaking
- 资源压缩
- CDN 加速

---

## 部署架构

### 开发环境
```
前端: http://localhost:5173 (Vite Dev Server)
后端: http://localhost:3000 (Express)
数据: localStorage (前端模拟)
```

### 生产环境
```
前端: Nginx 静态文件服务
后端: PM2 进程管理
数据: MySQL 数据库
反向代理: Nginx
```

---

## 扩展性设计

### 1. 模块化设计
每个功能模块独立，易于扩展和维护。

### 2. 配置化
权限、菜单、字段等支持配置化管理。

### 3. 插件化
支持第三方服务对接（物流、支付等）。

### 4. 多租户支持
预留多租户架构，支持数据隔离。

---

## 开发规范

### 1. 代码规范
- 使用 ESLint + Prettier
- 遵循 Vue 3 风格指南
- TypeScript 严格模式

### 2. 命名规范
- 组件: PascalCase
- 文件: kebab-case
- 变量: camelCase
- 常量: UPPER_SNAKE_CASE

### 3. 注释规范
- 函数必须有 JSDoc 注释
- 复杂逻辑必须有行内注释
- 接口必须有类型定义

### 4. Git 规范
- feat: 新功能
- fix: 修复
- docs: 文档
- style: 格式
- refactor: 重构
- test: 测试
- chore: 构建

---

## 常见问题

### Q: 如何添加新的权限？
A: 在 `src/config/defaultRolePermissions.ts` 中添加权限代码，然后在对应角色的 `permissions` 数组中添加。

### Q: 如何添加新的菜单？
A: 在 `src/router/index.ts` 中添加路由，并在路由 meta 中配置权限。

### Q: 如何切换开发/生产环境？
A: 修改 `.env.development` 或 `.env.production` 中的 `VITE_USE_REAL_API` 变量。

### Q: 如何对接新的第三方服务？
A: 在 `backend/src/services/` 中创建新的服务类，在 `backend/src/routes/` 中添加路由。
