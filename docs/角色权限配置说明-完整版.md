# CRM系统角色权限配置详细文档

> 文档版本：1.1
> 更新日期：2026-2-25
> 更新内容：新增财务管理模块权限配置（绩效数据、绩效管理、代收管理、取消代收申请、取消代收审核）
> 适用系统：智能销售CRM

---

## 一、系统角色概述

系统预设了5个角色，每个角色有不同的权限范围和数据访问级别：

| 角色编码 | 角色名称 | 数据范围 | 说明 |
|---------|---------|---------|------|
| `super_admin` | 超级管理员 | 全公司 | 拥有系统所有权限，可管理所有功能和数据 |
| `admin` | 管理员 | 全公司 | 拥有系统所有权限，可管理所有功能和数据 |
| `department_manager` | 部门经理 | 本部门 | 管理本部门业务和团队，查看部门数据 |
| `sales_staff` | 销售员 | 个人 | 专注于客户开发和订单管理，查看个人数据 |
| `customer_service` | 客服 | 全公司 | 处理订单审核、物流和售后服务 |

---

## 二、权限树结构（完整版）

### 2.1 系统管理 (system)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 系统管理 | 部门管理 | 查看部门 | `system.department.view` |
| | | 新增部门 | `system.department.create` |
| | | 编辑部门 | `system.department.edit` |
| | | 删除部门 | `system.department.delete` |
| | | 管理部门 | `system.department.manage` |
| | 用户管理 | 查看用户 | `system.user.view` |
| | | 新增用户 | `system.user.create` |
| | | 编辑用户 | `system.user.edit` |
| | | 删除用户 | `system.user.delete` |
| | | 重置密码 | `system.user.resetPassword` |
| | | 权限设置 | `system.user.setPermissions` |
| | | 操作日志 | `system.user.viewLogs` |
| | 角色权限 | 查看角色 | `system.role.view` |
| | | 新增角色 | `system.role.create` |
| | | 编辑角色 | `system.role.edit` |
| | | 删除角色 | `system.role.delete` |
| | | 设置权限 | `system.role.setPermissions` |
| | 权限管理 | 查看权限 | `system.permission.view` |
| | | 权限管理 | `system.permission.manage` |
| | | 角色管理 | `system.permission.roleManage` |
| | | 敏感权限 | `system.permission.sensitivePermission` |
| | | 客服管理 | `system.permission.customerServiceManage` |
| | 超管面板 | 查看面板 | `system.superAdmin.view` |
| | | 编辑权限 | `system.superAdmin.editPermissions` |
| | | 查看详情 | `system.superAdmin.viewDetails` |
| | | 重置密码 | `system.superAdmin.resetPassword` |
| | | 成员管理 | `system.superAdmin.memberManage` |
| | | 权限详情 | `system.superAdmin.permissionDetails` |
| | 客服管理 | 查看客服 | `system.customerService.view` |
| | | 管理客服 | `system.customerService.manage` |
| | | 设置权限 | `system.customerService.setPermissions` |
| | | 全部启用 | `system.customerService.enableAll` |
| | | 全部禁用 | `system.customerService.disableAll` |
| | 消息管理 | 查看消息 | `system.message.view` |
| | | 发送消息 | `system.message.send` |
| | | 删除消息 | `system.message.delete` |
| | | 消息管理 | `system.message.manage` |
| | 系统设置 | 查看设置 | `system.settings.view` |
| | | 编辑设置 | `system.settings.edit` |
| | | 数据备份 | `system.settings.backup` |
| | | 数据恢复 | `system.settings.restore` |

### 2.2 客户管理 (customer)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 客户管理 | 客户列表 | 查看客户 | `customer.list.view` |
| | | 导出客户 | `customer.list.export` |
| | | 导入客户 | `customer.list.import` |
| | | 编辑客户 | `customer.list.edit` |
| | | 删除客户 | `customer.list.delete` |
| | | 分配客户 | `customer.list.assign` |
| | | 批量操作 | `customer.list.batchOperation` |
| | 新增客户 | 创建客户 | `customer.add.create` |
| | 客户标签 | 查看标签 | `customer.tags.view` |
| | | 新增标签 | `customer.tags.create` |
| | | 编辑标签 | `customer.tags.edit` |
| | | 删除标签 | `customer.tags.delete` |
| | | 分配标签 | `customer.tags.assign` |
| | 客户分组 | 查看分组 | `customer.groups.view` |
| | | 新增分组 | `customer.groups.create` |
| | | 编辑分组 | `customer.groups.edit` |
| | | 删除分组 | `customer.groups.delete` |
| | | 管理分组 | `customer.groups.manage` |

### 2.3 订单管理 (order)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 订单管理 | 订单列表 | 查看订单 | `order.list.view` |
| | | 导出订单 | `order.list.export` |
| | | 编辑订单 | `order.list.edit` |
| | | 删除订单 | `order.list.delete` |
| | | 取消订单 | `order.list.cancel` |
| | | 批量操作 | `order.list.batchOperation` |
| | 新增订单 | 创建订单 | `order.add.create` |
| | 订单审核 | 查看审核 | `order.audit.view` |
| | | 通过审核 | `order.audit.approve` |
| | | 拒绝审核 | `order.audit.reject` |
| | | 撤销审核 | `order.audit.revoke` |
| | | 批量审核 | `order.audit.batchAudit` |

### 2.4 服务管理 (service)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 服务管理 | 工单管理 | 查看工单 | `service.ticket.view` |
| | | 创建工单 | `service.ticket.create` |
| | | 编辑工单 | `service.ticket.edit` |
| | | 删除工单 | `service.ticket.delete` |
| | | 分配工单 | `service.ticket.assign` |
| | | 关闭工单 | `service.ticket.close` |
| | | 导出工单 | `service.ticket.export` |
| | 在线客服 | 查看对话 | `service.chat.view` |
| | | 回复消息 | `service.chat.reply` |
| | | 转接客服 | `service.chat.transfer` |
| | | 查看历史 | `service.chat.history` |
| | | 客服设置 | `service.chat.settings` |
| | 知识库 | 查看知识库 | `service.knowledge.view` |
| | | 创建文档 | `service.knowledge.create` |
| | | 编辑文档 | `service.knowledge.edit` |
| | | 删除文档 | `service.knowledge.delete` |
| | | 分类管理 | `service.knowledge.category` |
| | | 发布文档 | `service.knowledge.publish` |
| | 通话管理 | 查看通话记录 | `service.call.view` |
| | | 发起通话 | `service.call.make` |
| | | 录音管理 | `service.call.record` |
| | | 通话统计 | `service.call.statistics` |
| | 短信管理 | 查看短信记录 | `service.sms.view` |
| | | 发送短信 | `service.sms.send` |
| | | 模板管理 | `service.sms.template` |
| | | 批量发送 | `service.sms.batch` |
| | | 短信统计 | `service.sms.statistics` |

### 2.5 业绩统计 (performance)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 业绩统计 | 个人业绩 | 查看个人业绩 | `performance.personal.view` |
| | | 导出个人数据 | `performance.personal.export` |
| | 团队业绩 | 查看团队业绩 | `performance.team.view` |
| | | 导出团队数据 | `performance.team.export` |
| | | 业绩对比 | `performance.team.compare` |
| | 业绩分析 | 查看分析报告 | `performance.analysis.view` |
| | | 趋势分析 | `performance.analysis.trend` |
| | | 业绩预测 | `performance.analysis.forecast` |
| | 业绩分享 | 查看分享 | `performance.share.view` |
| | | 创建分享 | `performance.share.create` |
| | | 管理分享 | `performance.share.manage` |

### 2.6 物流管理 (logistics)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 物流管理 | 物流列表 | 查看物流列表 | `logistics.list.view` |
| | | 导出物流数据 | `logistics.list.export` |
| | 物流跟踪 | 查看跟踪信息 | `logistics.track.view` |
| | | 更新跟踪状态 | `logistics.track.update` |
| | 物流公司 | 查看物流公司 | `logistics.companies.view` |
| | | 添加物流公司 | `logistics.companies.create` |
| | | 编辑物流公司 | `logistics.companies.edit` |
| | | 删除物流公司 | `logistics.companies.delete` |
| | 发货列表 | 查看发货列表 | `logistics.shipping.view` |
| | | 创建发货单 | `logistics.shipping.create` |
| | | 编辑发货单 | `logistics.shipping.edit` |
| | | 批量导出 | `logistics.shipping.batchExport` |
| | 状态更新 | 查看状态 | `logistics.status.view` |
| | | 更新状态 | `logistics.status.update` |
| | | 批量更新 | `logistics.status.batch` |

### 2.7 售后管理 (afterSales)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 售后管理 | 售后订单 | 查看售后订单 | `afterSales.list.view` |
| | | 导出售后数据 | `afterSales.list.export` |
| | 新建售后 | 创建售后单 | `afterSales.add.create` |
| | | 批量创建 | `afterSales.add.batch` |
| | 售后详情 | 查看售后详情 | `afterSales.detail.view` |
| | | 编辑售后单 | `afterSales.detail.edit` |
| | | 处理售后 | `afterSales.detail.process` |
| | 售后数据 | 查看售后数据 | `afterSales.data.view` |
| | | 售后分析 | `afterSales.data.analysis` |
| | | 售后报告 | `afterSales.data.report` |

### 2.8 资料管理 (data)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 资料管理 | 资料列表 | 查看资料列表 | `data.list.view` |
| | | 导出资料 | `data.list.export` |
| | | 导入资料 | `data.list.import` |
| | | 分配资料 | `data.list.assign` |
| | 客户查询 | 基础查询 | `data.search.basic` |
| | | 高级查询 | `data.search.advanced` |
| | | 导出查询结果 | `data.search.export` |
| | 回收站 | 查看回收站 | `data.recycle.view` |
| | | 恢复数据 | `data.recycle.restore` |
| | | 彻底删除 | `data.recycle.delete` |

### 2.9 商品管理 (product)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 商品管理 | 商品列表 | 查看商品 | `product.list.view` |
| | | 导出商品 | `product.list.export` |
| | | 编辑商品 | `product.list.edit` |
| | | 删除商品 | `product.list.delete` |
| | | 批量操作 | `product.list.batchOperation` |
| | | 价格调整 | `product.list.priceAdjust` |
| | 新增商品 | 创建商品 | `product.add.create` |
| | | 批量新增 | `product.add.batchAdd` |
| | 商品分类 | 查看分类 | `product.category.view` |
| | | 新增分类 | `product.category.create` |
| | | 编辑分类 | `product.category.edit` |
| | | 删除分类 | `product.category.delete` |
| | | 管理分类 | `product.category.manage` |
| | 库存管理 | 查看库存 | `product.inventory.view` |
| | | 调整库存 | `product.inventory.adjust` |
| | | 入库操作 | `product.inventory.inbound` |
| | | 出库操作 | `product.inventory.outbound` |
| | | 转移库存 | `product.inventory.transfer` |
| | | 预警设置 | `product.inventory.alert` |
| | 商品分析 | 查看分析 | `product.analytics.view` |
| | | 销售分析 | `product.analytics.sales` |
| | | 利润分析 | `product.analytics.profit` |
| | | 趋势分析 | `product.analytics.trend` |
| | | 导出报表 | `product.analytics.exportReport` |

### 2.10 财务管理 (finance)

| 一级菜单 | 二级菜单 | 按钮权限 | 权限ID |
|---------|---------|---------|--------|
| 财务管理 | 绩效数据 | 查看绩效数据 | `finance.performance_data.view` |
| | | 导出绩效数据 | `finance.performance_data.export` |
| | | 查看统计 | `finance.performance_data.statistics` |
| | 绩效管理 | 查看绩效管理 | `finance.manage.view` |
| | | 编辑绩效状态 | `finance.manage.edit` |
| | | 批量更新状态 | `finance.manage.batchUpdate` |
| | | 设置绩效系数 | `finance.manage.setCoefficient` |
| | | 配置管理 | `finance.manage.config` |
| | | 导出数据 | `finance.manage.export` |
| | 代收管理 | 查看代收列表 | `finance.cod.view` |
| | | 改代收金额 | `finance.cod.edit` |
| | | 标记返款 | `finance.cod.return` |
| | | 批量改代收 | `finance.cod.batchEdit` |
| | | 批量返款 | `finance.cod.batchReturn` |
| | | 导出代收数据 | `finance.cod.export` |
| | 取消代收申请 | 查看申请列表 | `finance.cod_application.view` |
| | | 发起申请 | `finance.cod_application.create` |
| | | 编辑申请 | `finance.cod_application.edit` |
| | | 撤回申请 | `finance.cod_application.delete` |
| | | 上传凭证 | `finance.cod_application.upload` |
| | 取消代收审核 | 查看审核列表 | `finance.cod.review.view` |
| | | 审核通过 | `finance.cod.review.approve` |
| | | 审核拒绝 | `finance.cod.review.reject` |
| | | 查看详情 | `finance.cod.review.detail` |
| | 增值管理 | 查看增值列表 | `finance.value_added.view` |
| | | 新增增值 | `finance.value_added.create` |
| | | 编辑增值 | `finance.value_added.edit` |
| | | 删除增值 | `finance.value_added.delete` |
| | | 批量操作 | `finance.value_added.batch` |
| | | 导出数据 | `finance.value_added.export` |
| | | 外包公司管理 | `finance.value_added.company` |
| | | 价格档位管理 | `finance.value_added.price_tier` |
| | | 状态配置管理 | `finance.value_added.status_config` |
| | 结算报表 | 查看报表 | `finance.settlement_report.view` |
| | | 导出报表 | `finance.settlement_report.export` |
| | | 查看图表 | `finance.settlement_report.charts` |
| | | 查看排名 | `finance.settlement_report.ranking` |

---

## 三、各角色默认权限配置详情


### 3.1 超级管理员 (super_admin)

**权限标识**: `*` (所有权限)

**权限说明**:
- 拥有系统所有功能的完整访问权限
- 可以管理所有用户、角色、部门
- 可以查看和操作全公司所有数据
- 可以进行系统设置和数据备份恢复
- 不受任何数据范围限制

**数据过滤规则**:
- 客户数据：全公司所有客户
- 订单数据：全公司所有订单
- 业绩数据：全公司所有成员业绩
- 物流数据：全公司所有物流记录

---

### 3.2 管理员 (admin)

**权限标识**: `*` (所有权限)

**权限说明**:
- 与超级管理员权限相同
- 拥有系统所有功能的完整访问权限
- 可以管理所有用户、角色、部门

**数据过滤规则**:
- 与超级管理员相同，无数据范围限制

---

### 3.3 部门经理 (department_manager)

**已配置权限列表**:

```
dashboard                    - 数据看板（一级菜单）
dashboard:personal           - 个人看板
dashboard:department         - 部门看板

customer                     - 客户管理（一级菜单）
customer:list                - 客户列表
customer:view:personal       - 查看个人客户
customer:view:department     - 查看部门客户
customer:add                 - 新增客户
customer:edit                - 编辑客户
customer:import              - 导入客户
customer:export              - 导出客户

order                        - 订单管理（一级菜单）
order:list                   - 订单列表
order:view:personal          - 查看个人订单
order:view:department        - 查看部门订单
order:add                    - 新增订单
order:edit                   - 编辑订单

service                      - 服务管理（一级菜单）
service:call                 - 通话管理
service:call:view            - 查看通话记录
service:call:add             - 新增通话
service:call:edit            - 编辑通话

performance                  - 业绩统计（一级菜单）
performance:personal         - 个人业绩
performance:personal:view    - 查看个人业绩
performance:team             - 团队业绩
performance:team:view        - 查看团队业绩
performance:analysis         - 业绩分析
performance:share            - 业绩分享

logistics                    - 物流管理（一级菜单）
logistics:list               - 物流列表
logistics:view               - 查看物流
logistics:add                - 新增物流
logistics:edit               - 编辑物流
logistics:tracking           - 物流跟踪
logistics:tracking:view      - 查看跟踪

aftersale                    - 售后管理（一级菜单）
aftersale:order              - 售后订单
aftersale:view:personal      - 查看个人售后
aftersale:view:department    - 查看部门售后
aftersale:add                - 新增售后
aftersale:edit               - 编辑售后
aftersale:analysis           - 售后分析

data                         - 资料管理（一级菜单）
data:customer                - 客户资料
data:customer:search         - 客户查询
```

**数据过滤规则**:
- 客户数据：本部门所有成员的客户
- 订单数据：本部门所有成员的订单
- 业绩数据：可查看本部门所有成员业绩，可点击查看详情
- 物流数据：本部门相关的物流记录

**特殊权限说明**:
- ❌ 无系统管理权限
- ❌ 无客户标签管理权限
- ❌ 无客户分组管理权限
- ❌ 无资料列表权限
- ✅ 可查看部门成员业绩详情
- ✅ 可点击团队业绩中所有本部门成员的单数超链接

---

### 3.4 销售员 (sales_staff)

**已配置权限列表**:

```
dashboard                    - 数据看板（一级菜单）
dashboard:personal           - 个人看板

customer                     - 客户管理（一级菜单）
customer:list                - 客户列表
customer:view:personal       - 查看个人客户
customer:add                 - 新增客户

order                        - 订单管理（一级菜单）
order:list                   - 订单列表
order:view:personal          - 查看个人订单
order:add                    - 新增订单
order:edit                   - 编辑订单

service                      - 服务管理（一级菜单）
service:call                 - 通话管理
service:call:view            - 查看通话记录
service:call:add             - 新增通话
service:call:edit            - 编辑通话

performance                  - 业绩统计（一级菜单）
performance:personal         - 个人业绩
performance:personal:view    - 查看个人业绩
performance:team             - 团队业绩
performance:team:view        - 查看团队业绩

logistics                    - 物流管理（一级菜单）
logistics:list               - 物流列表
logistics:view               - 查看物流
logistics:tracking           - 物流跟踪
logistics:tracking:view      - 查看跟踪

aftersale                    - 售后管理（一级菜单）
aftersale:order              - 售后订单
aftersale:view:personal      - 查看个人售后
aftersale:add                - 新增售后

data                         - 资料管理（一级菜单）
data:customer                - 客户资料
data:customer:search         - 客户查询
```

**数据过滤规则**:
- 客户数据：仅个人创建/负责的客户
- 订单数据：仅个人创建的订单
- 业绩数据：可查看团队业绩列表，但只能点击自己那一行的详情
- 物流数据：仅个人相关的物流记录

**特殊权限说明**:
- ❌ 无系统管理权限
- ❌ 无客户标签管理权限
- ❌ 无客户分组管理权限
- ❌ 无客户编辑权限（仅能新增）
- ❌ 无发货列表权限
- ❌ 无状态更新权限
- ❌ 无售后数据分析权限
- ❌ 无回收站权限
- ❌ 无短信管理权限
- ✅ 团队业绩页面只能点击自己那一行的单数超链接和查看详情按钮
- ✅ 其他成员的行显示为普通文本或隐藏操作按钮

---

### 3.5 客服 (customer_service)

**已配置权限列表**:

```
dashboard                    - 数据看板（一级菜单）
dashboard:personal           - 个人看板

order                        - 订单管理（一级菜单）
order:audit                  - 订单审核
order:audit:view             - 查看待审核订单

logistics                    - 物流管理（一级菜单）
logistics:list               - 物流列表
logistics:list:view          - 查看物流列表
logistics:shipping           - 发货列表
logistics:shipping:view      - 查看发货列表
logistics:tracking           - 物流跟踪
logistics:tracking:view      - 查看跟踪
logistics:status             - 状态更新
logistics:status_update      - 更新状态

aftersale                    - 售后管理（一级菜单）
aftersale:order              - 售后订单
aftersale:order:view         - 查看售后订单
aftersale:add                - 新增售后
aftersale:analysis           - 售后分析

data                         - 资料管理（一级菜单）
data:customer                - 客户资料
data:customer:search         - 客户查询
data:list                    - 资料列表
```

**数据过滤规则**:
- 订单数据：全公司待审核订单（用于审核）
- 物流数据：全公司所有物流记录
- 售后数据：全公司所有售后记录

**特殊权限说明**:
- ❌ 无系统管理权限
- ❌ 无客户管理权限（不能查看客户列表）
- ❌ 无订单列表权限（只有审核权限）
- ❌ 无业绩统计权限
- ✅ 可审核全公司订单
- ✅ 可管理全公司物流
- ✅ 可处理全公司售后

---

## 四、数据范围控制规则

### 4.1 数据范围类型

| 范围类型 | 说明 | 适用角色 |
|---------|------|---------|
| `all` | 全公司数据 | 超级管理员、管理员、客服 |
| `department` | 本部门数据 | 部门经理 |
| `self` | 仅个人数据 | 销售员 |

### 4.2 各模块数据过滤规则

#### 客户管理
- **超管/管理员**: 查看全公司所有客户
- **部门经理**: 查看本部门所有成员的客户
- **销售员**: 仅查看自己创建/负责的客户
- **客服**: 无客户列表权限

#### 订单管理
- **超管/管理员**: 查看全公司所有订单
- **部门经理**: 查看本部门所有成员的订单
- **销售员**: 仅查看自己创建的订单
- **客服**: 仅查看待审核订单（用于审核）

#### 业绩统计
- **超管/管理员**: 
  - 查看全公司所有成员业绩
  - 可点击任意成员的单数超链接
  - 可查看任意成员的详情
- **部门经理**: 
  - 查看本部门所有成员业绩
  - 可点击本部门成员的单数超链接
  - 可查看本部门成员的详情
- **销售员**: 
  - 可查看团队业绩列表（只读）
  - 只能点击自己那一行的单数超链接
  - 只能查看自己的详情
  - 其他成员行的操作按钮隐藏
- **客服**: 无业绩统计权限

#### 物流管理
- **超管/管理员**: 查看全公司所有物流
- **部门经理**: 查看本部门相关物流
- **销售员**: 查看个人相关物流
- **客服**: 查看全公司所有物流（用于处理）

---

## 五、权限配置页面说明

### 5.1 访问路径
系统管理 → 角色权限 → 点击"权限设置"按钮

### 5.2 权限树结构
权限树采用三级结构：
1. **一级菜单**: 如"系统管理"、"客户管理"等
2. **二级菜单**: 如"部门管理"、"客户列表"等
3. **按钮权限**: 如"查看"、"新增"、"编辑"、"删除"等

### 5.3 权限保存流程
1. 选择要配置的角色
2. 在权限树中勾选需要的权限
3. 点击"保存权限"按钮
4. 权限保存到数据库（roles表的permissions字段）
5. 同时更新本地缓存
6. 如果当前用户是该角色，立即生效

### 5.4 权限生效机制
- 权限保存后立即生效
- 用户登录时从数据库加载权限
- 权限变更后，当前用户需要刷新页面或重新登录

---

## 六、技术实现说明

### 6.1 数据库存储
- **表名**: `roles`
- **字段**: `permissions` (JSON类型)
- **格式**: 字符串数组，如 `["dashboard", "customer", "customer:list"]`

### 6.2 API接口
- `GET /api/v1/roles` - 获取角色列表（包含权限）
- `GET /api/v1/roles/:id/permissions` - 获取角色权限
- `PUT /api/v1/roles/:id` - 更新角色（包括权限）
- `PUT /api/v1/roles/:id/permissions` - 更新角色权限

### 6.3 前端权限检查
```typescript
// 检查用户是否有某个权限
const hasPermission = (permissionCode: string) => {
  const userPermissions = userStore.permissions
  if (userPermissions.includes('*')) return true // 超管
  return userPermissions.includes(permissionCode)
}
```

### 6.4 默认权限配置文件
- **路径**: `src/config/defaultRolePermissions.ts`
- **作用**: 当角色没有配置权限时，使用默认配置

---

## 七、注意事项

1. **超级管理员和管理员**不可禁用，这是系统预设的保护机制
2. **权限修改后**，已登录用户需要刷新页面才能生效
3. **数据范围控制**是在后端API层面实现的，前端只做显示控制
4. **敏感信息**（如手机号）会根据权限进行脱敏显示
5. **批量操作**权限需要同时具有对应的单条操作权限

---

> 文档结束


---

## 八、财务管理模块权限详解

### 8.1 模块概述

财务管理模块是系统新增的核心功能模块，包含5个子功能：

| 子菜单 | 路径 | 功能说明 | 适用角色 |
|--------|------|----------|----------|
| 绩效数据 | `/finance/performance-data` | 查看订单绩效数据和统计 | 全部角色（按权限区分） |
| 绩效管理 | `/finance/performance-manage` | 管理订单绩效状态和系数 | 仅管理员 |
| 代收管理 | `/finance/cod-collection` | 管理已发货订单的代收款项 | 仅管理员 |
| 取消代收申请 | `/finance/my-cod-application` | 发起代收取消申请 | 除客服外所有角色 |
| 取消代收审核 | `/finance/cod-application-review` | 审核代收取消申请 | 仅管理员 |

### 8.2 绩效数据 (finance.performance_data)

**功能描述**：
查看订单绩效数据，包括订单金额、绩效状态、绩效系数、提成金额等信息。

**权限配置**：

| 角色 | 查看权限 | 导出权限 | 数据范围 |
|------|:--------:|:--------:|----------|
| 超级管理员 | ✅ | ✅ | 全部数据 |
| 管理员 | ✅ | ✅ | 全部数据 |
| 部门经理 | ✅ | ✅ | 本部门数据 |
| 销售员 | ✅ | ✅ | 个人数据 |
| 客服 | ❌ | ❌ | - |

**权限ID列表**：
- `finance` - 财务管理一级菜单
- `finance.performance_data` - 绩效数据二级菜单
- `finance.performance_data.view` - 查看绩效数据
- `finance.performance_data.export` - 导出绩效数据
- `finance.performance_data.statistics` - 查看统计信息

**数据过滤规则**：
```typescript
// 超管/管理员：查看全部
if (role === 'super_admin' || role === 'admin') {
  // 无过滤
}
// 部门经理：查看本部门
else if (role === 'department_manager') {
  query.departmentId = user.departmentId
}
// 销售员：查看个人
else if (role === 'sales_staff') {
  query.salesPersonId = user.id
}
```

### 8.3 绩效管理 (finance.manage)

**功能描述**：
管理订单绩效状态（已计算、已发放、已作废）、设置绩效系数、批量操作、配置绩效规则。

**权限配置**：

| 角色 | 查看 | 编辑 | 批量操作 | 配置管理 |
|------|:----:|:----:|:--------:|:--------:|
| 超级管理员 | ✅ | ✅ | ✅ | ✅ |
| 管理员 | ✅ | ✅ | ✅ | ✅ |
| 部门经理 | ❌ | ❌ | ❌ | ❌ |
| 销售员 | ❌ | ❌ | ❌ | ❌ |
| 客服 | ❌ | ❌ | ❌ | ❌ |

**权限ID列表**：
- `finance.manage` - 绩效管理二级菜单
- `finance.manage.view` - 查看绩效管理
- `finance.manage.edit` - 编辑绩效状态
- `finance.manage.batchUpdate` - 批量更新状态
- `finance.manage.setCoefficient` - 设置绩效系数
- `finance.manage.config` - 配置管理
- `finance.manage.export` - 导出数据

**业务规则**：
1. **绩效状态**：
   - `pending` - 待计算（默认）
   - `calculated` - 已计算
   - `paid` - 已发放
   - `cancelled` - 已作废

2. **绩效系数**：
   - 范围：0-2倍
   - 默认：1倍
   - 用途：调整提成金额

3. **批量操作**：
   - 批量设置状态
   - 批量设置系数
   - 批量设置备注

### 8.4 代收管理 (finance.cod)

**功能描述**：
管理已发货订单的代收款项（快递代收货款/COD），包括改代收、返款、批量操作等。

**权限配置**：

| 角色 | 查看 | 改代收 | 返款 | 批量操作 | 导出 |
|------|:----:|:------:|:----:|:--------:|:----:|
| 超级管理员 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 管理员 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 部门经理 | ❌ | ❌ | ❌ | ❌ | ❌ |
| 销售员 | ❌ | ❌ | ❌ | ❌ | ❌ |
| 客服 | ❌ | ❌ | ❌ | ❌ | ❌ |

**权限ID列表**：
- `finance.cod` - 代收管理二级菜单
- `finance.cod.view` - 查看代收列表
- `finance.cod.edit` - 改代收金额
- `finance.cod.return` - 标记返款
- `finance.cod.batchEdit` - 批量改代收
- `finance.cod.batchReturn` - 批量返款
- `finance.cod.export` - 导出代收数据

**业务规则**：

1. **改代收（修改代收金额）**：
   - **场景**：客户直接付尾款给商家，不需要快递代收
   - **限制**：
     - 修改的金额不能大于当前代收金额
     - 只有"已发货（未签收）"订单可以改代收
     - 已签收和已完成的订单不能改代收
   - **状态变化**：
     - 改为0元 → 标记为"已改代收"（cancelled）
     - 改为>0元 → 保持"待处理"（pending）

2. **返款**：
   - **场景**：快递公司代收货款后，把钱返还给商家
   - **限制**：
     - 只有"已签收"或"已完成"订单才能返款
     - 代收金额不能为0
   - **状态变化**：标记为"已返款"（returned）后不能再修改

3. **订单状态限制**：
   ```
   已发货（未签收） → 可以改代收 ✅
   已签收 → 不能改代收 ❌（客户已付款给快递员）
   已完成 → 不能改代收 ❌（客户已付款给快递员）
   ```

4. **代收金额计算**：
   - **原始代收金额** = 订单总额 - 定金（固定，仅供参考）
   - **当前代收金额** = 最新修改后的金额（可变）
   - **修改上限** = 当前代收金额（而不是原始代收金额）

### 8.5 取消代收申请 (finance.cod_application)

**功能描述**：
销售人员发起代收取消申请，提交审核后由管理员审批。

**权限配置**：

| 角色 | 查看申请 | 发起申请 | 编辑申请 | 撤回申请 | 数据范围 |
|------|:--------:|:--------:|:--------:|:--------:|----------|
| 超级管理员 | ✅ | ✅ | ✅ | ✅ | 全部申请 |
| 管理员 | ✅ | ✅ | ✅ | ✅ | 全部申请 |
| 部门经理 | ✅ | ✅ | ✅ | ✅ | 个人申请 |
| 销售员 | ✅ | ✅ | ✅ | ✅ | 个人申请 |
| 客服 | ❌ | ❌ | ❌ | ❌ | - |

**权限ID列表**：
- `finance.cod_application` - 取消代收申请二级菜单
- `finance.cod_application.view` - 查看申请列表
- `finance.cod_application.create` - 发起申请
- `finance.cod_application.edit` - 编辑申请
- `finance.cod_application.delete` - 撤回申请
- `finance.cod_application.upload` - 上传凭证

**申请流程**：

1. **第一步：选择订单**
   - 从待处理订单列表中选择
   - 支持搜索和筛选
   - 显示订单基本信息和代收金额

2. **第二步：填写信息**
   - **修改后金额**：默认0元，表示客户已全额付款
   - **取消原因**：必填，说明取消代收的原因
   - **尾款凭证**：必传，支持上传或粘贴图片（最多5张）

3. **提交审核**
   - 提交后进入待审核状态
   - 自动通知审核人员（管理员）

4. **审核结果**
   - **通过**：自动更新订单代收金额和状态
   - **拒绝**：可重新编辑后再次提交

**业务规则**：

1. **订单限制**：
   - 只能申请自己创建的订单（管理员不受限制）
   - 订单必须是"已发货（未签收）"状态
   - 订单代收状态必须是"待处理"
   - 不能有待审核的申请（避免重复提交）
   - 订单未被改代收或返款

2. **金额限制**：
   - 修改后金额不能大于当前代收金额
   - 已改过代收的订单，最多只能改为当前代收金额
   - 示例：
     ```
     原始代收¥300 → 第一次改为¥100 → 第二次最多改为¥100
     ```

3. **申请状态**：
   - `pending` - 待审核
   - `approved` - 已通过
   - `rejected` - 已驳回
   - `cancelled` - 已撤回

4. **可编辑状态**：
   - 待审核的申请可以编辑和撤回
   - 已驳回的申请可以重新编辑后提交
   - 已通过的申请不能修改

**消息通知**：

| 触发时机 | 消息类型 | 接收对象 | 优先级 |
|---------|---------|---------|--------|
| 申请提交 | `cod_cancel_request` | 审核人员（管理员） | 高 |
| 审核通过 | `cod_cancel_approved` | 申请人 | 普通 |
| 审核拒绝 | `cod_cancel_rejected` | 申请人 | 高 |

### 8.6 取消代收审核 (finance.cod.review)

**功能描述**：
管理员审核销售人员提交的代收取消申请。

**权限配置**：

| 角色 | 查看审核 | 审核通过 | 审核拒绝 | 数据范围 |
|------|:--------:|:--------:|:--------:|----------|
| 超级管理员 | ✅ | ✅ | ✅ | 全部申请 |
| 管理员 | ✅ | ✅ | ✅ | 全部申请 |
| 部门经理 | ❌ | ❌ | ❌ | - |
| 销售员 | ❌ | ❌ | ❌ | - |
| 客服 | ❌ | ❌ | ❌ | - |

**权限ID列表**：
- `finance.cod.review` - 取消代收审核二级菜单
- `finance.cod.review.view` - 查看审核列表
- `finance.cod.review.approve` - 审核通过
- `finance.cod.review.reject` - 审核拒绝
- `finance.cod.review.detail` - 查看详情

**审核流程**：

1. **查看申请**
   - 查看申请详情
   - 查看订单信息
   - 查看尾款凭证（支持预览）

2. **审核决策**
   - **通过**：
     - 自动更新订单代收金额
     - 自动更新订单代收状态
     - 发送通知给申请人
   - **拒绝**：
     - 必须填写拒绝原因
     - 发送通知给申请人
     - 申请人可重新编辑

3. **审核后处理**
   - 审核通过后自动更新订单：
     ```typescript
     order.codAmount = application.modifiedCodAmount
     if (modifiedCodAmount === 0) {
       order.codStatus = 'cancelled'  // 已改代收
     } else {
       order.codStatus = 'pending'    // 待处理
     }
     ```

**审核规则**：

1. **审核限制**：
   - 只能审核待审核状态的申请
   - 审核后不能重复审核
   - 审核拒绝时必须填写原因

2. **数据验证**：
   - 验证订单状态是否仍然有效
   - 验证修改后金额是否合法
   - 验证订单是否已被其他操作修改

3. **审核权限**：
   - 仅超级管理员和管理员可审核
   - 不能审核自己的申请（如果管理员也发起了申请）

### 8.7 增值管理 (finance.value_added)

**功能描述**：
管理外包公司增值订单，包括订单创建、状态管理、公司管理、价格配置等。

**权限配置**：

| 角色 | 查看 | 新增 | 编辑 | 删除 | 批量操作 | 导出 | 公司管理 | 价格档位 | 状态配置 |
|------|:----:|:----:|:----:|:----:|:--------:|:----:|:--------:|:--------:|:--------:|
| 超级管理员 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 管理员 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 部门经理 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 销售员 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 客服 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

**权限ID列表**：
- `finance.value_added` - 增值管理二级菜单
- `finance.value_added.view` - 查看增值列表
- `finance.value_added.create` - 新增增值
- `finance.value_added.edit` - 编辑增值
- `finance.value_added.delete` - 删除增值
- `finance.value_added.batch` - 批量操作
- `finance.value_added.export` - 导出数据
- `finance.value_added.company` - 外包公司管理
- `finance.value_added.price_tier` - 价格档位管理
- `finance.value_added.status_config` - 状态配置管理

**核心功能**：

1. **订单管理**
   - 创建增值订单
   - 编辑订单信息（外包公司、有效状态、结算状态）
   - 批量操作订单（批量选择公司、批量改状态）
   - 删除无效订单
   - 导出订单数据

2. **外包公司管理**
   - 添加外包公司
   - 编辑公司信息
   - 设置默认公司
   - 启用/停用公司
   - 删除公司（无关联订单时）
   - 查看公司统计数据

3. **价格档位系统**
   - 为公司配置价格档位
   - 支持按单计价（固定金额）
   - 支持按比例计价（订单金额百分比）
   - 设置档位生效时间
   - 系统自动根据订单日期匹配档位

4. **状态配置**
   - 自定义有效状态选项（待处理、有效、无效等）
   - 配置状态颜色和排序
   - 结算状态固定（未结算、已结算）

**订单有效状态**：

系统预设三种状态，管理员可自定义：
- **待处理**：订单刚创建，等待外包公司处理
- **有效**：订单处理成功，可以正常结算
- **无效**：订单处理失败或取消，不计入结算

**订单结算状态**：

固定两种状态，不可自定义：
- **未结算**：订单费用尚未结算给外包公司
- **已结算**：订单费用已结算，不可再修改

**价格档位系统**：

1. **按单计价**：
   - 每个订单收取固定金额
   - 例如：¥900/单、¥1200/单

2. **按比例计价**：
   - 按订单金额的百分比收费
   - 例如：5.5%、8%
   - 计算公式：费用 = 订单金额 × 比例

3. **档位匹配规则**：
   - 根据订单下单日期自动匹配
   - 查找在订单日期生效的档位
   - 多个档位时使用优先级最高的
   - 无匹配档位时使用公司默认单价

**筛选和搜索**：

- 时间筛选：按下单时间筛选（支持快捷选择）
- 公司筛选：按外包公司筛选
- 有效状态筛选：按待处理、有效、无效筛选
- 结算状态筛选：按未结算、已结算筛选
- 批量搜索：支持订单号、客户名称、客户电话、物流单号

**数据范围**：全公司数据（不区分部门和个人）

### 8.8 结算报表 (finance.settlement_report)

**功能描述**：
查看增值订单结算统计、图表分析和公司排名。

**权限配置**：

| 角色 | 查看报表 | 导出报表 | 查看图表 | 查看排名 | 数据范围 |
|------|:--------:|:--------:|:--------:|:--------:|----------|
| 超级管理员 | ✅ | ✅ | ✅ | ✅ | 全部数据 |
| 管理员 | ✅ | ✅ | ✅ | ✅ | 全部数据 |
| 部门经理 | ❌ | ❌ | ❌ | ❌ | - |
| 销售员 | ❌ | ❌ | ❌ | ❌ | - |
| 客服 | ❌ | ❌ | ❌ | ❌ | - |

**权限ID列表**：
- `finance.settlement_report` - 结算报表二级菜单
- `finance.settlement_report.view` - 查看报表
- `finance.settlement_report.export` - 导出报表
- `finance.settlement_report.charts` - 查看图表
- `finance.settlement_report.ranking` - 查看排名

**报表内容**：

1. **统计卡片**
   - 总订单数和总金额
   - 已结算订单数和金额
   - 未结算订单数和金额
   - 平均单价和结算率
   - 有效订单数和有效率
   - 无效订单数和无效率
   - 待处理订单数和占比

2. **图表分析**
   - **结算趋势分析**：折线图显示每日结算金额和订单数
   - **有效率趋势**：折线图显示有效率和结算率变化
   - **状态分布**：饼状图显示各状态订单占比
   - **结算对比**：饼状图显示已结算/未结算对比

3. **公司排名列表**
   - 排名（前三名显示奖牌）
   - 公司名称
   - 总订单数和总金额
   - 有效、无效、待处理订单数
   - 已结算、未结算订单数
   - 已结算金额、未结算金额
   - 平均单价
   - 结算率（进度条显示）
   - 有效率（进度条显示）
   - 最近结算日期

**筛选条件**：

- **时间范围**：按下单时间筛选
- **快捷选择**：今日、本月、上月、本季、上季、Q1-Q4、今年、全部
- **外包公司**：选择特定公司查看数据
- **自定义日期**：选择任意日期范围

**数据导出**：

支持导出公司排名数据为Excel文件，包含：
- 公司排名
- 总订单数和总金额
- 各状态订单数量（有效、无效、待处理）
- 结算统计（已结算、未结算订单数和金额）
- 平均单价
- 结算率和有效率
- 最近结算日期

导出的Excel文件格式美观，列宽自动调整，便于打印和分享。

**使用场景**：

- **月度结算**：查看本月各公司的订单数据，准备结算
- **业绩分析**：对比不同公司的业绩表现
- **质量监控**：关注无效订单占比，评估服务质量
- **趋势预测**：通过历史数据预测未来业务量

**数据范围**：全公司数据（不区分部门和个人）

### 8.9 数据范围控制总结

| 功能模块 | 超管/管理员 | 部门经理 | 销售员 | 客服 |
|---------|------------|----------|--------|------|
| 绩效数据 | 全部数据 | 本部门数据 | 个人数据 | 无权限 |
| 绩效管理 | 全部数据 | 无权限 | 无权限 | 无权限 |
| 代收管理 | 全部数据 | 无权限 | 无权限 | 无权限 |
| 取消代收申请 | 全部申请 | 个人申请 | 个人申请 | 无权限 |
| 取消代收审核 | 全部申请 | 无权限 | 无权限 | 无权限 |
| 增值管理 | 全部数据 | 无权限 | 无权限 | 无权限 |
| 结算报表 | 全部数据 | 无权限 | 无权限 | 无权限 |

### 8.10 配置文件位置

| 文件路径 | 说明 |
|----------|------|
| `src/config/menu.ts` | 财务管理菜单配置 |
| `src/config/defaultRolePermissions.ts` | 角色默认权限配置 |
| `src/views/Finance/PerformanceData.vue` | 绩效数据页面 |
| `src/views/Finance/PerformanceManage.vue` | 绩效管理页面 |
| `src/views/Finance/CodCollection.vue` | 代收管理页面 |
| `src/views/Finance/MyCodApplication.vue` | 取消代收申请页面 |
| `src/views/Finance/CodApplicationReview.vue` | 取消代收审核页面 |
| `src/views/Finance/ValueAddedManage.vue` | 增值管理页面 |
| `src/views/Finance/SettlementReport.vue` | 结算报表页面 |
| `backend/src/routes/codCollection.ts` | 代收管理API |
| `backend/src/routes/codApplication.ts` | 取消代收申请API |
| `backend/src/routes/valueAdded.ts` | 增值管理和结算报表API |
| `backend/src/services/messageService.ts` | 消息通知服务 |

---

> 文档结束
