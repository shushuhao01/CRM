# deploy.sh 脚本说明

## 🎯 脚本特点

新版 `deploy.sh` 采用**分步式自动构建**，特点：

### ✅ 优势
1. **自动执行所有步骤** - 一键运行，无需手动干预
2. **分步显示进度** - 每个步骤都有明确的进度提示
3. **智能跳过已完成步骤** - 如果依赖已安装，自动跳过
4. **实时进度提示** - 构建时显示已用时间
5. **错误处理** - 出错时给出解决方案
6. **内存优化** - 根据服务器内存自动调整配置

### 📊 8个步骤

```
步骤1: 环境检查 (1分钟)
  ├─ 检查 Node.js 版本
  ├─ 检查系统内存
  ├─ 设置内存限制
  └─ 检查磁盘空间

步骤2: 配置文件检查 (1分钟)
  ├─ 检查 backend/.env
  ├─ 检查 .env.production
  └─ 提示修改必要配置

步骤3: 配置npm镜像 (30秒)
  └─ 配置淘宝镜像加速

步骤4: 安装前端依赖 (5-8分钟)
  ├─ 检查是否已安装
  ├─ 询问是否重新安装
  └─ 安装依赖包

步骤5: 安装后端依赖 (3-5分钟)
  ├─ 检查是否已安装
  └─ 安装生产环境依赖

步骤6: 构建前端 (5-10分钟) ⚠️
  ├─ 清理旧缓存
  ├─ 开始构建
  ├─ 显示构建进度
  └─ 验证构建结果

步骤7: 启动后端服务 (1分钟)
  ├─ 检查/安装 PM2
  ├─ 停止旧服务
  ├─ 启动新服务
  └─ 保存配置

步骤8: 部署完成提示
  └─ 显示后续操作指南
```

## 🚀 使用方法

### 基本用法

```bash
cd /www/wwwroot/CRM
chmod +x deploy.sh
./deploy.sh
```

### 首次部署

1. 确保已创建数据库
2. 确保已导入 schema.sql
3. 运行脚本
4. 按提示编辑 backend/.env
5. 等待自动完成

### 更新部署

```bash
cd /www/wwwroot/CRM
git pull origin main
./deploy.sh
```

脚本会自动检测已安装的依赖，跳过不必要的步骤。

## 💡 智能特性

### 1. 自动跳过已安装依赖

如果检测到 `node_modules` 已存在，会询问：
```
node_modules 目录已存在
是否重新安装？(y/N)
```

- 输入 `y` - 重新安装
- 输入 `N` 或等待10秒 - 跳过安装

### 2. 构建进度提示

构建过程中会显示：
```
⏳ 构建进行中... 已过 30 秒
⏳ 构建进行中... 已过 1 分钟
⏳ 构建进行中... 已过 2 分钟
...
```

### 3. 内存自动优化

根据服务器内存自动设置：
- 2GB 服务器 → 1.5GB 限制
- 4GB 服务器 → 3GB 限制
- 8GB+ 服务器 → 4GB 限制

### 4. 错误处理

构建失败时会提示：
```
❌ 前端构建失败

💡 可能的解决方案：
  1. 增加 Swap 虚拟内存
  2. 使用简化构建: npm run build -- --minify false
  3. 使用本地构建方案
```

## ⚠️ 注意事项

### 1. 构建时间

- 2GB 服务器：可能需要 10-15 分钟
- 4GB 服务器：通常 5-8 分钟
- 8GB+ 服务器：通常 3-5 分钟

### 2. 不要中断

构建过程中请勿：
- ❌ 关闭终端
- ❌ 按 Ctrl+C（除非超过15分钟无响应）
- ❌ 关闭宝塔面板

### 3. 首次部署必须配置

首次部署时，必须编辑 `backend/.env`：
- DB_USERNAME
- DB_PASSWORD
- DB_DATABASE
- JWT_SECRET

## 🔧 故障排查

### 问题1：构建卡住

**现象**：超过 15 分钟没反应

**解决**：
```bash
# 按 Ctrl+C 取消
# 增加 Swap
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 重新运行
./deploy.sh
```

### 问题2：依赖安装失败

**解决**：
```bash
# 清理后重试
rm -rf node_modules package-lock.json
rm -rf backend/node_modules
./deploy.sh
```

### 问题3：服务启动失败

**解决**：
```bash
# 查看日志
pm2 logs crm-backend

# 检查端口
netstat -tunlp | grep 3000

# 检查配置
cat backend/.env
```

## 📊 与旧版对比

| 特性 | 旧版 | 新版 |
|------|------|------|
| 执行方式 | 一次性执行 | 分步执行 |
| 进度显示 | 简单 | 详细 ✅ |
| 错误提示 | 基本 | 详细+解决方案 ✅ |
| 智能跳过 | 无 | 有 ✅ |
| 时间提示 | 无 | 有 ✅ |
| 内存优化 | 固定 | 自动调整 ✅ |
| 用户体验 | 一般 | 优秀 ✅ |

## 🎯 总结

新版 `deploy.sh` 脚本：
- ✅ 保持一键部署的便利性
- ✅ 增加分步执行的可控性
- ✅ 提供详细的进度和错误提示
- ✅ 智能优化内存和依赖管理
- ✅ 适合 2GB+ 内存服务器

**推荐使用场景**：
- 首次部署
- 代码更新
- 依赖更新
- 重新部署

---

**版本**：v2.0（分步式构建版）  
**更新日期**：2024-11-23
