# 租户授权码功能说明

## 一、功能概述

本系统支持两种部署模式，每种模式有不同的授权方式：

| 部署模式 | 授权码格式 | 作用 |
|----------|-----------|------|
| 私有部署 | `XXXX-XXXX-XXXX-XXXX` | 激活整个系统，所有用户共享 |
| SaaS租户 | `TENANT-XXXX-XXXX-XXXX-XXXX` | 验证租户身份，类似企业微信的企业ID |

## 二、SaaS租户授权流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    租户授权验证流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【管理后台】                                                    │
│  1. 管理员创建租户 → 系统自动生成授权码                          │
│  2. 管理员将授权码发送给租户                                     │
│                                                                 │
│  【CRM登录页】                                                   │
│  1. 用户点击"授权码"图标                                        │
│  2. 选择"SaaS租户"模式                                          │
│  3. 输入租户授权码（TENANT-XXXX-XXXX-XXXX-XXXX）                │
│  4. 系统验证授权码，返回租户信息                                 │
│  5. 用户输入用户名密码登录                                       │
│  6. 系统在该租户下验证用户身份                                   │
│                                                                 │
│  【授权验证】                                                    │
│  - 检查授权码是否存在                                            │
│  - 检查租户状态（是否禁用）                                      │
│  - 检查授权状态（是否暂停）                                      │
│  - 检查是否过期                                                  │
│  - 首次使用自动激活                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 三、数据库表结构

### 1. 租户表 (tenants) 新增字段

```sql
ALTER TABLE tenants 
ADD COLUMN license_key VARCHAR(100) COMMENT '租户专属授权码',
ADD COLUMN license_status VARCHAR(20) DEFAULT 'pending' COMMENT '授权状态',
ADD COLUMN activated_at DATETIME COMMENT '激活时间',
ADD COLUMN last_verify_at DATETIME COMMENT '最后验证时间',
ADD COLUMN features TEXT COMMENT '功能权限JSON';
```

### 2. 租户授权日志表 (tenant_license_logs)

```sql
CREATE TABLE tenant_license_logs (
  id VARCHAR(36) PRIMARY KEY,
  tenant_id VARCHAR(36) NOT NULL,
  license_key VARCHAR(100),
  action VARCHAR(50) NOT NULL,  -- generate/activate/verify/renew/suspend/revoke
  result VARCHAR(20) DEFAULT 'success',
  message TEXT,
  ip_address VARCHAR(50),
  user_agent VARCHAR(500),
  operator_id VARCHAR(36),
  operator_name VARCHAR(100),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 四、API接口

### 管理后台接口 (需要管理员认证)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/admin/tenants | 获取租户列表 |
| GET | /api/v1/admin/tenants/:id | 获取租户详情 |
| POST | /api/v1/admin/tenants | 创建租户（自动生成授权码） |
| PUT | /api/v1/admin/tenants/:id | 更新租户信息 |
| DELETE | /api/v1/admin/tenants/:id | 删除租户 |
| POST | /api/v1/admin/tenants/:id/regenerate-license | 重新生成授权码 |
| POST | /api/v1/admin/tenants/:id/suspend | 暂停授权 |
| POST | /api/v1/admin/tenants/:id/resume | 恢复授权 |
| POST | /api/v1/admin/tenants/:id/renew | 续期 |
| GET | /api/v1/admin/tenants/:id/logs | 获取授权日志 |

### CRM前端接口 (公开接口)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/tenant-license/verify | 验证租户授权码 |
| GET | /api/v1/tenant-license/info | 获取当前租户信息 |
| POST | /api/v1/tenant-license/heartbeat | 心跳检测 |

## 五、授权状态说明

| 状态 | 说明 |
|------|------|
| pending | 待激活（授权码已生成，但未使用） |
| active | 已激活（正常使用中） |
| expired | 已过期（超过到期时间） |
| suspended | 已暂停（管理员手动暂停） |

## 六、使用示例

### 1. 创建租户

```bash
POST /api/v1/admin/tenants
{
  "name": "测试公司",
  "code": "TEST_COMPANY",
  "packageId": "xxx",
  "maxUsers": 50,
  "expireDate": "2026-12-31",
  "contact": "张三",
  "phone": "13800138000"
}

# 返回
{
  "success": true,
  "data": {
    "id": "xxx",
    "licenseKey": "TENANT-A1B2-C3D4-E5F6-G7H8"
  },
  "message": "租户创建成功，授权码已生成"
}
```

### 2. 验证授权码

```bash
POST /api/v1/tenant-license/verify
{
  "licenseKey": "TENANT-A1B2-C3D4-E5F6-G7H8"
}

# 返回
{
  "success": true,
  "data": {
    "tenantId": "xxx",
    "tenantCode": "TEST_COMPANY",
    "tenantName": "测试公司",
    "packageName": "专业版",
    "maxUsers": 50,
    "expireDate": "2026-12-31"
  },
  "message": "授权验证成功"
}
```

## 七、前端集成

### 登录页面

1. 用户首次访问，点击授权码图标
2. 选择"SaaS租户"模式
3. 输入租户授权码
4. 验证成功后，授权信息保存到 localStorage
5. 后续登录自动带上租户信息

### 本地存储

```javascript
// 保存租户信息
localStorage.setItem('crm_license_mode', 'tenant')
localStorage.setItem('crm_tenant_info', JSON.stringify({
  tenantId: 'xxx',
  tenantCode: 'TEST_COMPANY',
  tenantName: '测试公司',
  licenseKey: 'TENANT-XXXX-XXXX-XXXX-XXXX'
}))
```

## 八、安全考虑

1. 授权码使用加密随机数生成，难以猜测
2. 验证失败会记录日志，包含IP地址
3. 支持暂停/吊销授权码
4. 定期心跳检测授权状态
5. 授权码在前端显示时部分遮蔽
