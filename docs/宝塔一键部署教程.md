# 云客CRM 宝塔面板部署教程

> 版本：v3.0  
> 更新日期：2026-01-09  
> 适用于：云客CRM v2.9.0+  
> 最低配置：2核2GB 内存

---

## 📋 系统概述

云客CRM 是一套完整的客户关系管理系统，包含：
- **CRM主系统**：客户管理、订单管理、物流管理、业绩统计等
- **管理后台**（可选）：授权管理、租户管理、版本管理
- **官网系统**（可选）：产品展示、在线注册、套餐购买
- **移动APP**（可选）：UniApp开发，支持Android/iOS

本教程主要介绍 CRM 主系统的部署。

---

## 📋 准备工作

### 服务器要求
| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 2GB | 4GB+ |
| 硬盘 | 40GB | 100GB+ |
| 系统 | CentOS 7+ / Ubuntu 18+ | CentOS 8 / Ubuntu 22 |
| 带宽 | 1Mbps | 5Mbps+ |

### 你需要准备
1. ✅ 一台云服务器（阿里云/腾讯云/华为云等）
2. ✅ 服务器的 IP 地址和 root 密码
3. ✅ 一个域名（可选，没有也能用 IP 访问）

---

## 第一部分：安装宝塔面板

### 步骤 1：连接服务器

**Windows 用户**：使用 Xshell 或 PuTTY
- 主机：`你的服务器IP`
- 端口：`22`
- 用户名：`root`
- 密码：`你的服务器密码`

**Mac/Linux 用户**：打开终端
```bash
ssh root@你的服务器IP
```

### 步骤 2：安装宝塔面板

**CentOS 系统：**
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

**Ubuntu/Debian 系统：**
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

### 步骤 3：保存登录信息

安装完成后会显示：
```
外网面板地址: http://你的IP:8888/xxxxxxxx
username: xxxxxxxx
password: xxxxxxxx
```

**重要：请保存这些信息！**

---

## 第二部分：安装必要软件

登录宝塔面板后，进入 **软件商店** 安装：

| 软件 | 版本要求 | 安装方式 |
|------|----------|----------|
| Nginx | 1.22+ | 极速安装 |
| MySQL | 8.0 | 极速安装 |
| Node.js版本管理器 | - | 安装后选择 Node 18+ |
| PM2管理器 | - | 极速安装 |

### Node.js 安装步骤
1. 安装 "Node.js版本管理器"
2. 点击 "设置" → "版本管理"
3. 安装 Node.js 18.x 或 20.x
4. 设置为默认版本

---

## 第三部分：创建数据库

### 步骤 1：添加数据库

1. 点击左侧 **"数据库"**
2. 点击 **"添加数据库"**
3. 填写信息：
   - 数据库名：`crm_db`
   - 用户名：`crm_user`
   - 密码：点击 "生成密码"（**请保存此密码**）
   - 访问权限：本地服务器
4. 点击 **"提交"**

### 步骤 2：导入数据库结构

1. 在数据库列表找到 `crm_db`
2. 点击 **"管理"** 进入 phpMyAdmin
3. 点击 **"导入"**
4. 选择项目中的 `database/schema.sql` 文件
5. 点击 **"执行"**

---

## 第四部分：上传项目代码

### 方式一：Git 克隆（推荐）

```bash
# 进入网站目录
cd /www/wwwroot

# 克隆项目
git clone https://github.com/你的仓库/CRM.git

# 进入项目目录
cd CRM
```

### 方式二：宝塔面板上传

1. 在本地将项目打包成 `.zip` 文件
2. 宝塔面板 → 文件 → `/www/wwwroot`
3. 点击 "上传" 上传压缩包
4. 右键解压到当前目录

---

## 第五部分：配置环境变量

### 后端配置

1. 进入 `/www/wwwroot/CRM/backend`
2. 复制 `.env.example` 为 `.env`
3. 编辑 `.env` 文件：

```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 数据库配置（必须修改）
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=crm_user
DB_PASSWORD=你的数据库密码
DB_DATABASE=crm_db
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00

# JWT配置（必须修改）
JWT_SECRET=你的随机密钥至少32位
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# CORS配置
CORS_ORIGIN=*
CORS_CREDENTIALS=true
```

### 生成 JWT_SECRET

在终端执行：
```bash
openssl rand -hex 32
```
复制输出的字符串填入 JWT_SECRET

---

## 第六部分：一键部署

### 执行部署脚本

```bash
# 进入项目目录
cd /www/wwwroot/CRM

# 给脚本执行权限
chmod +x deploy.sh

# 执行一键部署
./deploy.sh
```

### 部署过程

脚本会自动完成：
1. ✅ 环境检查（Node.js、内存）
2. ✅ 安装前端依赖
3. ✅ 安装后端依赖
4. ✅ 构建前端项目
5. ✅ 启动后端服务

### 部署成功标志

```
==========================================
✅ 部署完成！
==========================================
┌─────┬──────────────┬─────────┐
│ id  │ name         │ status  │
├─────┼──────────────┼─────────┤
│ 0   │ crm-backend  │ online  │
└─────┴──────────────┴─────────┘
```

---

## 第七部分：配置 Nginx

### 步骤 1：创建网站

1. 宝塔面板 → 网站 → 添加站点
2. 填写信息：
   - 域名：`你的域名` 或 `服务器IP`
   - 根目录：`/www/wwwroot/CRM/dist`
   - PHP版本：纯静态
3. 点击 "提交"

### 步骤 2：配置反向代理

1. 点击网站 "设置"
2. 点击 "反向代理" → "添加反向代理"
3. 填写：
   - 代理名称：`api`
   - 目标URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`
4. 点击 "保存"

### 步骤 3：配置伪静态

点击 "配置文件"，在 server 块内添加：

```nginx
location / {
    try_files $uri $uri/ /index.html;
}

location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# WebSocket支持
location /socket.io {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

点击 "保存"

---

## 第八部分：测试访问

### 访问系统

打开浏览器，输入：`http://你的域名` 或 `http://你的IP`

### 预设账号

| 角色 | 用户名 | 密码 |
|------|--------|------|
| 超级管理员 | superadmin | super123456 |
| 管理员 | admin | admin123 |
| 部门经理 | manager | manager123 |
| 销售员 | sales | sales123 |
| 客服 | service | service123 |

### 功能测试

登录后测试：
- ✅ 数据看板显示正常
- ✅ 客户管理可以新增/编辑
- ✅ 订单管理功能正常
- ✅ 系统设置可以访问

---

## 🔧 常用维护命令

```bash
# 查看服务状态
pm2 list

# 查看日志
pm2 logs crm-backend

# 重启服务
pm2 restart crm-backend

# 停止服务
pm2 stop crm-backend

# 更新代码后重新部署
cd /www/wwwroot/CRM
git pull
./deploy.sh
```

---

## ⚠️ 常见问题

### 问题1：构建时内存不足

**解决方案**：添加 Swap 虚拟内存
```bash
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 问题2：页面打不开

**检查项**：
1. 防火墙开放 80/443 端口
2. 云服务器安全组开放 80/443 端口
3. Nginx 服务是否运行

### 问题3：API 请求失败

**检查项**：
1. 后端服务是否运行：`pm2 list`
2. 查看后端日志：`pm2 logs crm-backend`
3. 检查数据库连接配置

### 问题4：登录失败

**检查项**：
1. 数据库是否已导入 schema.sql
2. 后端 .env 数据库密码是否正确
3. 查看后端日志排查错误

---

## 📚 相关文档

- [本地构建部署指南](本地构建部署指南.md) - 适合低配服务器
- [多域名部署指南](多域名部署指南.md) - 多系统部署
- [系统架构说明](系统架构说明.md) - 技术架构详解
- [用户登录说明](用户登录说明.md) - 账号权限说明

---

**技术支持**：如有问题请联系开发团队
