# 宝塔一键部署教程（最新优化版）

> 本教程适合完全没有部署经验的新手，使用优化后的一键部署脚本，支持 2GB+ 内存服务器

---

## 📋 准备工作

### 你需要准备：
1. ✅ 一台云服务器（阿里云/腾讯云/华为云等）
   - **最低配置**：2核2GB
   - **推荐配置**：4核8GB
2. ✅ 服务器的 IP 地址
3. ✅ 服务器的 root 密码
4. ✅ 一个域名（可选，没有也能用 IP 访问）

---

## 第一部分：安装宝塔面板（10分钟）

### 步骤 1：连接到服务器

#### Windows 用户：
1. 下载 **Xshell** 或 **PuTTY** 软件
2. 打开软件，输入：
   - 主机：`你的服务器IP`
   - 端口：`22`
   - 用户名：`root`
   - 密码：`你的服务器密码`
3. 点击"连接"

#### Mac/Linux 用户：
1. 打开"终端"应用
2. 输入命令：
   ```bash
   ssh root@你的服务器IP
   ```
3. 输入密码（输入时不显示，直接输入后按回车）

### 步骤 2：安装宝塔面板

连接成功后，复制以下命令，粘贴到终端，按回车：

**CentOS 系统：**
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

**Ubuntu/Debian 系统：**
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

### 步骤 3：等待安装完成

安装过程需要 5-10 分钟，看到类似以下信息表示安装成功：

```
==================================================================
Congratulations! Installed successfully!
==================================================================
外网面板地址: http://你的IP:8888/xxxxxxxx
内网面板地址: http://192.168.x.x:8888/xxxxxxxx
username: xxxxxxxx
password: xxxxxxxx
==================================================================
```

**重要：** 请把这些信息复制保存下来！

### 步骤 4：登录宝塔面板

1. 打开浏览器
2. 输入地址：`http://你的IP:8888/xxxxxxxx`（使用上面显示的地址）
3. 输入用户名和密码
4. 点击"登录"

---

## 第二部分：安装必要软件（15分钟）

### 步骤 1：进入软件商店

登录宝塔面板后：
1. 点击左侧菜单的 **"软件商店"**
2. 你会看到很多软件列表

### 步骤 2：安装 Nginx

1. 在软件商店搜索框输入：`nginx`
2. 找到 **"Nginx 1.22"**（或更高版本）
3. 点击右侧的 **"安装"** 按钮
4. 选择 **"极速安装"**
5. 点击 **"确定"**
6. 等待安装完成（约 2-3 分钟）

### 步骤 3：安装 MySQL

1. 在软件商店搜索框输入：`mysql`
2. 找到 **"MySQL 8.0"**
3. 点击右侧的 **"安装"** 按钮
4. 选择 **"极速安装"**
5. 点击 **"确定"**
6. 等待安装完成（约 5-8 分钟）

### 步骤 4：安装 Node.js

1. 在软件商店搜索框输入：`node`
2. 找到 **"Node.js 版本管理器"**
3. 点击右侧的 **"安装"** 按钮
4. 等待安装完成
5. 安装完成后，点击 **"设置"** 按钮
6. 在弹出的窗口中，点击 **"版本管理"** 标签
7. 找到 **"Node.js 18.x"** 或更高版本
8. 点击右侧的 **"安装"** 按钮
9. 等待安装完成

### 步骤 5：安装 PM2

1. 在软件商店搜索框输入：`pm2`
2. 找到 **"PM2 管理器"**
3. 点击右侧的 **"安装"** 按钮
4. 等待安装完成

---

## 第三部分：创建数据库（5分钟）

### 步骤 1：进入数据库管理

1. 点击左侧菜单的 **"数据库"**
2. 你会看到数据库列表（可能是空的）

### 步骤 2：添加数据库

1. 点击页面上方的 **"添加数据库"** 按钮
2. 在弹出的窗口中填写：
   - **数据库名**：`crm_db`
   - **用户名**：`crm_user`
   - **密码**：点击 **"生成密码"** 按钮（会自动生成一个强密码）
   - **访问权限**：选择 **"本地服务器"**
3. **重要：** 点击密码后面的 **"复制"** 按钮，把密码保存到记事本
4. 点击 **"提交"** 按钮

### 步骤 3：导入数据库结构

1. 在数据库列表中，找到刚才创建的 `crm_db`
2. 点击右侧的 **"管理"** 按钮
3. 在新打开的页面中，点击顶部的 **"导入"** 按钮
4. 点击 **"从本地上传"** 按钮
5. 选择项目中的 `database/schema.sql` 文件
6. 点击 **"导入"** 按钮
7. 等待导入完成

---

## 第四部分：上传项目代码（10分钟）

### 方式一：使用 Git（推荐）

#### 步骤 1：进入终端

1. 在宝塔面板，点击右上角的 **"终端"** 按钮
2. 会打开一个黑色的命令行窗口

#### 步骤 2：下载代码

在终端中依次输入以下命令（每输入一行按一次回车）：

```bash
# 1. 进入网站目录
cd /www/wwwroot

# 2. 克隆项目（从 GitHub 下载代码）
git clone https://github.com/shushuhao01/CRM.git

# 3. 进入项目目录
cd CRM

# 4. 查看文件（确认下载成功）
ls -la
```

如果看到很多文件名（如 package.json, src, backend 等），说明下载成功！

### 方式二：使用宝塔面板上传

#### 步骤 1：打包项目

在你的电脑上：
1. 找到项目文件夹
2. 右键点击文件夹
3. 选择 **"发送到 → 压缩(zipped)文件夹"**（Windows）
4. 或使用 WinRAR/7-Zip 压缩成 `.zip` 文件

#### 步骤 2：上传到服务器

1. 在宝塔面板，点击左侧菜单的 **"文件"**
2. 点击路径导航到 `/www/wwwroot`
3. 点击顶部的 **"上传"** 按钮
4. 选择刚才压缩的文件
5. 等待上传完成（根据网速，可能需要几分钟）

#### 步骤 3：解压文件

1. 在文件列表中找到上传的压缩包
2. 点击右侧的 **"解压"** 按钮
3. 解压路径选择：`/www/wwwroot`
4. 点击 **"解压"** 按钮
5. 解压完成后，会看到一个 `CRM` 文件夹

---

## 第五部分：配置环境变量（5分钟）

### 步骤 1：配置后端环境变量

1. 在宝塔面板，点击左侧菜单的 **"文件"**
2. 导航到 `/www/wwwroot/CRM/backend`
3. 找到 `.env.example` 文件
4. 右键点击，选择 **"复制"**
5. 粘贴到同一目录，重命名为 `.env`
6. 点击 `.env` 文件，选择 **"编辑"**
7. 修改以下关键配置：

```env
# ==========================================
# 数据库配置 - 必须修改！
# ==========================================
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=crm_user
DB_PASSWORD=您在第三部分保存的数据库密码
DB_DATABASE=crm_db
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00

# ==========================================
# JWT配置 - 必须修改！
# ==========================================
JWT_SECRET=请在这里填写随机密钥
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# ==========================================
# CORS配置
# ==========================================
CORS_ORIGIN=*
CORS_CREDENTIALS=true
```

8. 点击 **"保存"** 按钮

### 如何生成 JWT_SECRET？

**方法 1**：在宝塔终端执行
```bash
openssl rand -hex 32
```
复制输出的字符串

**方法 2**：访问在线工具
- https://www.random.org/strings/
- 生成 64 位随机字符串

**方法 3**：自己编一个
- 至少 32 位
- 包含大小写字母、数字、特殊字符
- 例如：`MySecretKey2024!CRM@System#Secure$Password%2024`

### 步骤 2：前端配置（可选）

前端配置会在部署时自动创建，使用默认配置即可。

如需自定义，可以创建 `/www/wwwroot/CRM/.env.production` 文件：

```env
VITE_API_BASE_URL=/api
VITE_APP_TITLE=CRM管理系统
NODE_ENV=production
VITE_USE_REAL_API=true
```

---

## 第六部分：一键部署（10-15分钟）

### 📝 部署前检查清单

在执行部署前，请确认：
- [ ] 已创建数据库 `crm_db`
- [ ] 已导入数据库结构 `schema.sql`
- [ ] 已配置 `backend/.env` 文件
- [ ] 数据库密码已正确填写
- [ ] JWT_SECRET 已修改

### 步骤 1：打开终端

1. 在宝塔面板，点击右上角的 **"终端"** 按钮

### 步骤 2：执行一键部署

在终端中依次输入以下命令：

```bash
# 1. 进入项目目录
cd /www/wwwroot/CRM

# 2. 给脚本执行权限
chmod +x deploy.sh

# 3. 执行一键部署脚本
./deploy.sh
```

### 步骤 3：等待自动部署完成

脚本会自动完成以下操作：

#### 🔍 阶段 1：环境检查（1分钟）
```
📋 检查环境...
✅ Node.js版本检查通过: v20.19.0
💾 系统内存: 2048MB
📊 Node.js 内存限制: 1.5GB
```

#### 📦 阶段 2：安装依赖（5-8分钟）
```
📦 步骤1/6: 安装前端依赖...
📦 步骤2/6: 安装后端依赖...
```

#### 🔨 阶段 3：构建项目（3-5分钟）
```
🔨 步骤3/6: 构建前端...
🔨 步骤4/6: 准备后端...
```

#### 🚀 阶段 4：启动服务（1分钟）
```
🔍 步骤5/6: 检查 PM2...
🚀 步骤6/6: 启动服务...
```

### 步骤 4：确认部署成功

看到以下信息表示部署成功：

```
==========================================
✅ 部署完成！
==========================================

📊 服务状态:
┌─────┬──────────────┬─────────┬─────────┐
│ id  │ name         │ status  │ restart │
├─────┼──────────────┼─────────┼─────────┤
│ 0   │ crm-backend  │ online  │ 0       │
└─────┴──────────────┴─────────┴─────────┘

🎉 部署成功！
```

---

## 第七部分：配置 Nginx（10分钟）

### 步骤 1：创建网站

1. 在宝塔面板，点击左侧菜单的 **"网站"**
2. 点击页面上方的 **"添加站点"** 按钮
3. 在弹出的窗口中填写：
   - **域名**：
     - 如果有域名：输入 `www.你的域名.com` 和 `你的域名.com`（两行）
     - 如果没有域名：输入你的服务器 IP 地址
   - **根目录**：点击右侧的文件夹图标，选择 `/www/wwwroot/CRM/dist`
   - **FTP**：不创建
   - **数据库**：不创建（已经创建过了）
   - **PHP 版本**：选择 **"纯静态"**
4. 点击 **"提交"** 按钮

### 步骤 2：配置反向代理

1. 在网站列表中，找到刚才创建的网站
2. 点击右侧的 **"设置"** 按钮
3. 在弹出的窗口中，点击左侧的 **"反向代理"** 标签
4. 点击 **"添加反向代理"** 按钮
5. 填写信息：
   - **代理名称**：`api`
   - **目标 URL**：`http://127.0.0.1:3000`
   - **发送域名**：`$host`
   - **内容替换**：留空
6. 点击 **"保存"** 按钮

### 步骤 3：配置 URL 重写

1. 在网站设置窗口中，点击左侧的 **"配置文件"** 标签
2. 找到 `location /` 这一段（大约在第 20-30 行）
3. 修改为以下内容：

```nginx
location / {
    try_files $uri $uri/ /index.html;
}

location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

4. 点击 **"保存"** 按钮

---

## 第八部分：测试访问（2分钟）

### 步骤 1：访问网站

1. 打开浏览器
2. 输入地址：
   - 如果有域名：`http://你的域名.com`
   - 如果没有域名：`http://你的IP地址`
3. 按回车

### 步骤 2：登录测试

如果看到登录页面，说明部署成功！

使用预设账号登录：
- **超级管理员**：`superadmin` / `super123456`
- **管理员**：`admin` / `admin123`
- **部门经理**：`manager` / `manager123`
- **销售员**：`sales` / `sales123`
- **客服**：`service` / `service123`

### 步骤 3：测试功能

登录后，测试以下功能：
- ✅ 查看数据看板
- ✅ 进入客户管理
- ✅ 新增一个测试客户
- ✅ 新增一个测试订单

如果都能正常操作，恭喜你，部署成功！🎉

---

## ⚠️ 常见问题排查

### 问题 1：部署时构建卡住

**现象**：构建前端时长时间停在某个文件不动

**原因**：服务器内存不足（2GB 内存可能会卡）

**解决方案 A**：等待更长时间（可能需要 10-20 分钟）

**解决方案 B**：使用本地构建方案
```bash
# 按 Ctrl+C 取消当前部署
# 查看本地构建指南
cat 本地构建部署指南.md
```

**解决方案 C**：添加 Swap 虚拟内存
```bash
# 创建 2GB Swap
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 重新部署
cd /www/wwwroot/CRM
./deploy.sh
```

### 问题 2：页面打不开

**检查步骤**：
1. 确认服务器防火墙开放了 80 和 443 端口
   - 宝塔面板 → 安全 → 添加端口规则
2. 确认云服务器安全组开放了 80 和 443 端口
   - 登录阿里云/腾讯云控制台 → 安全组 → 添加规则
3. 检查 Nginx 是否运行
   - 宝塔面板 → 软件商店 → Nginx → 查看状态

### 问题 3：页面空白

**检查步骤**：
1. 按 F12 打开浏览器控制台，查看错误信息
2. 检查前端是否构建成功
   ```bash
   ls -la /www/wwwroot/CRM/dist
   # 应该看到 index.html 和 assets 文件夹
   ```
3. 检查 Nginx 配置是否正确
   - 根目录是否指向 `/www/wwwroot/CRM/dist`

### 问题 4：API 请求失败

**检查步骤**：
1. 检查后端是否运行
   ```bash
   pm2 list
   # 应该看到 crm-backend 状态为 online
   ```
2. 查看后端日志
   ```bash
   pm2 logs crm-backend
   ```
3. 检查数据库连接
   - 确认 `backend/.env` 中的数据库密码正确

### 问题 5：登录失败

**检查步骤**：
1. 确认数据库已导入
   - 宝塔面板 → 数据库 → crm_db → 管理
   - 应该看到多个表（users, customers, orders 等）
2. 查看后端日志
   ```bash
   pm2 logs crm-backend
   ```

---

## 🔧 维护命令

### 查看后端状态
```bash
pm2 list
```

### 查看后端日志
```bash
pm2 logs crm-backend
```

### 重启后端
```bash
pm2 restart crm-backend
```

### 停止后端
```bash
pm2 stop crm-backend
```

### 更新代码
```bash
cd /www/wwwroot/CRM
git pull
./deploy.sh
```

---

## 📊 脚本优化说明

### 新版 deploy.sh 的改进：

1. **自动内存优化**
   - 检测服务器内存大小
   - 自动设置合适的 Node.js 内存限制
   - 2GB 服务器：1.5GB 限制
   - 4GB 服务器：3GB 限制
   - 8GB+ 服务器：4GB 限制

2. **自动配置检查**
   - 自动检查配置文件是否存在
   - 不存在则自动创建默认配置
   - 提示用户修改必要的配置项

3. **npm 镜像加速**
   - 自动配置淘宝镜像
   - 加快依赖下载速度

4. **优化构建过程**
   - 清理旧的构建缓存
   - 减少内存占用
   - 提高构建成功率

5. **智能依赖安装**
   - 后端只安装生产环境依赖
   - 节省 50% 磁盘空间
   - 减少安装时间

---

## 🎉 恭喜你完成部署！

如果还有问题，可以：
1. 查看项目的其他文档
2. 在 GitHub 提交 Issue
3. 联系技术支持

祝使用愉快！🚀

---

**版本**：v2.0（优化版）  
**更新日期**：2024-11-23  
**适用于**：CRM 系统 v1.8.3+  
**最低配置**：2核2GB 内存
