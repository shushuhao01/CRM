# ä»·æ ¼æ¡£ä½ç³»ç»Ÿ - è°ƒè¯•æŒ‡å—

## é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šï¼š
1. ä¿å­˜æ¡£ä½ä»·æ ¼æˆåŠŸåï¼Œåœ¨ä»·æ ¼æ¡£ä½åˆ—è¡¨ä¸­æ²¡æœ‰çœ‹åˆ°æ–°æ·»åŠ çš„æ¡£ä½ âœ… å·²ä¿®å¤
2. æ²¡æœ‰çœ‹åˆ°åˆ é™¤æŒ‰é’® âœ… å·²ç¡®è®¤å­˜åœ¨
3. éœ€è¦"æ— é™æœŸ"æ—¶é—´é€‰æ‹©é€‰é¡¹ âœ… å·²æ·»åŠ 

## æ ¹æœ¬åŸå› åˆ†æ

### æ¡£ä½åˆ—è¡¨ä¸æ˜¾ç¤ºçš„åŸå› 
é—®é¢˜å‡ºåœ¨ `loadCompanyTiers` å‡½æ•°ä¸­å¯¹ API å“åº”çš„å¤„ç†ï¼š

```javascript
// âŒ é”™è¯¯çš„ä»£ç 
const res = await getCompanyPriceTiers(companyId)
companyTiers.value = res.data || []
```

**åŸå› **ï¼š
- åç«¯è¿”å›ï¼š`{ success: true, data: [æ¡£ä½æ•°ç»„] }`
- Axios å“åº”æ‹¦æˆªå™¨ï¼ˆ`src/utils/request.ts`ï¼‰å·²ç»æå–äº† `data` å­—æ®µ
- æ‰€ä»¥ `res` å·²ç»æ˜¯æ¡£ä½æ•°ç»„ï¼Œä¸éœ€è¦å†è®¿é—® `res.data`
- `res.data` æ˜¯ `undefined`ï¼Œå¯¼è‡´åˆ—è¡¨ä¸ºç©º

**ä¿®å¤**ï¼š
```javascript
// âœ… æ­£ç¡®çš„ä»£ç 
const res = await getCompanyPriceTiers(companyId)
companyTiers.value = Array.isArray(res) ? res : (res?.data || [])
```

è¿™ä¸ªé—®é¢˜ä¸ä¹‹å‰ä¿®å¤çš„ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºé—®é¢˜å®Œå…¨ç›¸åŒï¼

## å·²å®Œæˆçš„ä¿®å¤

### 1. æ— é™æœŸé€‰é¡¹ âœ…
å·²åœ¨ `PriceTierDialog.vue` ä¸­æ·»åŠ "æ— é™æœŸ"å¤é€‰æ¡†ï¼š
- å‹¾é€‰åï¼Œå¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸå­—æ®µä¼šè¢«éšè—
- æäº¤æ—¶ä¼šæ¸…ç©ºæ—¥æœŸå­—æ®µ
- æ˜¾ç¤ºæç¤ºæ–‡å­—ï¼š"è¯¥æ¡£ä½å°†é•¿æœŸæœ‰æ•ˆï¼Œä¸å—æ—¶é—´é™åˆ¶"

### 2. åˆ é™¤æŒ‰é’® âœ…
åˆ é™¤æŒ‰é’®å·²å­˜åœ¨äºä¸¤ä¸ªä½ç½®ï¼š
- **å…¬å¸åˆ—è¡¨**ï¼šå½“å…¬å¸çš„ `totalOrders === 0` æ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
- **æ¡£ä½åˆ—è¡¨**ï¼šæ¯ä¸ªæ¡£ä½éƒ½æœ‰åˆ é™¤æŒ‰é’®ï¼ˆåœ¨æ“ä½œåˆ—ï¼‰

### 3. è°ƒè¯•æ—¥å¿— âœ…
å·²åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼š

#### PriceTierDialog.vue
```javascript
// ä¿å­˜æˆåŠŸå
console.log('[PriceTierDialog] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡emit savedäº‹ä»¶')
emit('saved')
console.log('[PriceTierDialog] savedäº‹ä»¶å·²emit')
```

#### ValueAddedManage.vue
```javascript
// handleTierSaved å‡½æ•°
console.log('[handleTierSaved] æ¡£ä½ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨')
console.log('[handleTierSaved] editingCompany:', editingCompany.value)
console.log('[handleTierSaved] è°ƒç”¨loadCompanyTiersï¼ŒcompanyId:', editingCompany.value.id)

// loadCompanyTiers å‡½æ•°
console.log('[loadCompanyTiers] å¼€å§‹åŠ è½½æ¡£ä½ï¼ŒcompanyId:', companyId)
console.log('[loadCompanyTiers] APIè¿”å›:', res)
console.log('[loadCompanyTiers] æ¡£ä½åˆ—è¡¨:', companyTiers.value)
```

## è°ƒè¯•æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
1. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
2. åˆ‡æ¢åˆ° Consoleï¼ˆæ§åˆ¶å°ï¼‰æ ‡ç­¾é¡µ
3. æ¸…ç©ºç°æœ‰æ—¥å¿—ï¼ˆç‚¹å‡» ğŸš« å›¾æ ‡ï¼‰

### ç¬¬äºŒæ­¥ï¼šæµ‹è¯•æ·»åŠ æ¡£ä½æµç¨‹
1. ç‚¹å‡»"å¤–åŒ…å…¬å¸ç®¡ç†"æŒ‰é’®
2. é€‰æ‹©ä¸€ä¸ªå…¬å¸ï¼Œç‚¹å‡»"ç¼–è¾‘"
3. åˆ‡æ¢åˆ°"ä»·æ ¼æ¡£ä½"æ ‡ç­¾é¡µ
4. ç‚¹å‡»"æ·»åŠ æ¡£ä½"æŒ‰é’®
5. å¡«å†™æ¡£ä½ä¿¡æ¯ï¼š
   - æ¡£ä½åç§°ï¼šæµ‹è¯•æ¡£ä½
   - è®¡ä»·æ–¹å¼ï¼šæŒ‰å•è®¡ä»·
   - å›ºå®šå•ä»·ï¼š1000
   - å‹¾é€‰"æ— é™æœŸ"ï¼ˆæµ‹è¯•æ–°åŠŸèƒ½ï¼‰
   - ä¼˜å…ˆçº§ï¼š10
   - æ¡£ä½æ’åºï¼š1
   - çŠ¶æ€ï¼šå¯ç”¨
6. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®

### ç¬¬ä¸‰æ­¥ï¼šè§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—åºåˆ—ï¼š

```
[PriceTierDialog] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡emit savedäº‹ä»¶
[PriceTierDialog] savedäº‹ä»¶å·²emit
[handleTierSaved] æ¡£ä½ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨
[handleTierSaved] editingCompany: {id: "xxx", companyName: "xxx", ...}
[handleTierSaved] è°ƒç”¨loadCompanyTiersï¼ŒcompanyId: xxx
[loadCompanyTiers] å¼€å§‹åŠ è½½æ¡£ä½ï¼ŒcompanyId: xxx
[loadCompanyTiers] APIè¿”å›: {success: true, data: [...]}
[loadCompanyTiers] æ¡£ä½åˆ—è¡¨: [{id: "xxx", tierName: "æµ‹è¯•æ¡£ä½", ...}]
```

### ç¬¬å››æ­¥ï¼šæ£€æŸ¥å¯èƒ½çš„é—®é¢˜

#### é—®é¢˜1ï¼šæ²¡æœ‰çœ‹åˆ° `[PriceTierDialog]` æ—¥å¿—
**åŸå› **ï¼šä¿å­˜è¯·æ±‚å¤±è´¥
**æ£€æŸ¥**ï¼š
- Network æ ‡ç­¾é¡µä¸­æŸ¥çœ‹ POST è¯·æ±‚æ˜¯å¦æˆåŠŸ
- æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æç¤º
- æ£€æŸ¥è¡¨å•éªŒè¯æ˜¯å¦é€šè¿‡

#### é—®é¢˜2ï¼šçœ‹åˆ° `[PriceTierDialog]` ä½†æ²¡æœ‰ `[handleTierSaved]`
**åŸå› **ï¼šäº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰æ­£ç¡®ç»‘å®š
**æ£€æŸ¥**ï¼š
- ç¡®è®¤ `ValueAddedManage.vue` ä¸­çš„ `<PriceTierDialog>` ç»„ä»¶æœ‰ `@saved="handleTierSaved"`
- æ£€æŸ¥æ˜¯å¦æœ‰ Vue è­¦å‘Šä¿¡æ¯

#### é—®é¢˜3ï¼šçœ‹åˆ° `[handleTierSaved]` ä½† editingCompany ä¸º null
**åŸå› **ï¼šç¼–è¾‘çŠ¶æ€ä¸¢å¤±
**æ£€æŸ¥**ï¼š
- ç¡®è®¤åœ¨æ‰“å¼€æ¡£ä½å¼¹çª—å‰ï¼Œ`editingCompany` å·²æ­£ç¡®è®¾ç½®
- æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä»£ç æ¸…ç©ºäº† `editingCompany`

#### é—®é¢˜4ï¼šAPI è¿”å›ç©ºæ•°ç»„
**åŸå› **ï¼šåç«¯æ•°æ®åº“ä¸­æ²¡æœ‰ä¿å­˜æˆåŠŸ
**æ£€æŸ¥**ï¼š
- Network æ ‡ç­¾é¡µä¸­æŸ¥çœ‹ GET è¯·æ±‚çš„å“åº”
- åç«¯æ—¥å¿—ä¸­æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
- æ•°æ®åº“ä¸­æ£€æŸ¥ `value_added_price_config` è¡¨

#### é—®é¢˜5ï¼šAPI è¿”å›æ•°æ®ä½†åˆ—è¡¨ä¸æ›´æ–°
**åŸå› **ï¼šVue å“åº”å¼æ›´æ–°é—®é¢˜
**æ£€æŸ¥**ï¼š
- ç¡®è®¤ `companyTiers.value = res.data || []` æ‰§è¡Œäº†
- æ£€æŸ¥ `companyTiers` æ˜¯å¦æ­£ç¡®å£°æ˜ä¸º `ref`

## åç«¯ API ç«¯ç‚¹

### è·å–æ¡£ä½åˆ—è¡¨
```
GET /api/value-added/companies/:companyId/price-tiers
```

### åˆ›å»ºæ¡£ä½
```
POST /api/value-added/companies/:companyId/price-tiers
Body: {
  tierName: string
  tierOrder: number
  pricingType: 'fixed' | 'percentage'
  unitPrice: number
  percentageRate: number
  baseAmountField: string
  startDate: string | null
  endDate: string | null
  isActive: 0 | 1
  priority: number
  remark: string
}
```

### æ›´æ–°æ¡£ä½
```
PUT /api/value-added/companies/:companyId/price-tiers/:tierId
```

### åˆ é™¤æ¡£ä½
```
DELETE /api/value-added/companies/:companyId/price-tiers/:tierId
```

## æ•°æ®åº“è¡¨ç»“æ„

è¡¨åï¼š`value_added_price_config`

å…³é”®å­—æ®µï¼š
- `id`: ä¸»é”®
- `company_id`: å¤–åŒ…å…¬å¸ID
- `tier_name`: æ¡£ä½åç§°
- `tier_order`: æ’åº
- `pricing_type`: è®¡ä»·æ–¹å¼ï¼ˆfixed/percentageï¼‰
- `unit_price`: å›ºå®šå•ä»·
- `percentage_rate`: æ¯”ä¾‹
- `start_date`: å¼€å§‹æ—¥æœŸï¼ˆå¯ä¸ºNULLï¼‰
- `end_date`: ç»“æŸæ—¥æœŸï¼ˆå¯ä¸ºNULLï¼‰
- `is_active`: æ˜¯å¦å¯ç”¨ï¼ˆ0/1ï¼‰
- `priority`: ä¼˜å…ˆçº§
- `created_at`: åˆ›å»ºæ—¶é—´

## é¢„æœŸè¡Œä¸º

### æ·»åŠ æ¡£ä½æˆåŠŸå
1. æ˜¾ç¤º"æ·»åŠ æˆåŠŸ"æç¤º
2. å¼¹çª—è‡ªåŠ¨å…³é—­
3. æ¡£ä½åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
4. æ–°æ¡£ä½å‡ºç°åœ¨åˆ—è¡¨ä¸­
5. å…¬å¸åˆ—è¡¨çš„"å•ä»·/æ¯”ä¾‹"åˆ—æ›´æ–°ä¸ºæœ€é«˜ä¼˜å…ˆçº§æ¡£ä½

### æ— é™æœŸé€‰é¡¹
- å‹¾é€‰åï¼Œ`startDate` å’Œ `endDate` éƒ½ä¸º NULL
- è¯¥æ¡£ä½å¯¹æ‰€æœ‰æ—¥æœŸçš„è®¢å•éƒ½æœ‰æ•ˆ
- åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºä¸º"ä¸é™åˆ¶"

### åˆ é™¤æŒ‰é’®æ˜¾ç¤ºè§„åˆ™
- **å…¬å¸åˆ é™¤æŒ‰é’®**ï¼šä»…å½“ `totalOrders === 0` æ—¶æ˜¾ç¤º
- **æ¡£ä½åˆ é™¤æŒ‰é’®**ï¼šå§‹ç»ˆæ˜¾ç¤º
- åˆ é™¤å‰ä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†

## ä¸‹ä¸€æ­¥æ“ä½œ

1. **åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•**ï¼šæŒ‰ç…§ä¸Šè¿°æ­¥éª¤æ“ä½œï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
2. **æˆªå›¾åé¦ˆ**ï¼šå¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œæˆªå›¾æ§åˆ¶å°æ—¥å¿—å’Œ Network è¯·æ±‚
3. **æ£€æŸ¥æ•°æ®åº“**ï¼šç¡®è®¤æ•°æ®æ˜¯å¦çœŸçš„ä¿å­˜åˆ°æ•°æ®åº“ä¸­
4. **æ¸…ç†æ—¥å¿—**ï¼šé—®é¢˜è§£å†³åï¼Œå¯ä»¥ç§»é™¤è°ƒè¯•æ—¥å¿—

## å¸¸è§è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶åˆ·æ–°
å¦‚æœæ•°æ®å·²ä¿å­˜ä½†åˆ—è¡¨ä¸æ›´æ–°ï¼Œå°è¯•ï¼š
```javascript
// åœ¨ handleTierSaved ä¸­
companyTiers.value = []
await loadCompanyTiers(editingCompany.value.id)
```

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥å“åº”æ‹¦æˆªå™¨
ç¡®è®¤ `src/utils/request.ts` ä¸­çš„å“åº”æ‹¦æˆªå™¨æ­£ç¡®è¿”å› `response.data`

### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨è§¦å‘æ›´æ–°
```javascript
// ä½¿ç”¨ nextTick ç¡®ä¿ DOM æ›´æ–°
import { nextTick } from 'vue'
await loadCompanyTiers(editingCompany.value.id)
await nextTick()
```

## ç§»é™¤è°ƒè¯•æ—¥å¿—

é—®é¢˜è§£å†³åï¼Œæœç´¢å¹¶åˆ é™¤ä»¥ä¸‹æ—¥å¿—ï¼š
- `console.log('[PriceTierDialog]`
- `console.log('[handleTierSaved]`
- `console.log('[loadCompanyTiers]`
- `console.warn('[loadCompanyTiers]`
- `console.error('[loadCompanyTiers]`
