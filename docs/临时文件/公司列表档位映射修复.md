# å…¬å¸åˆ—è¡¨æ¡£ä½æ˜ å°„ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šä¿å­˜ä»·æ ¼æ¡£ä½æˆåŠŸï¼Œæ¡£ä½ä¹Ÿå‡ºç°åœ¨åˆ—è¡¨ä¸­ï¼Œä½†å…¬å¸åˆ—è¡¨çš„"å•ä»·/æ¯”ä¾‹"å­—æ®µæ²¡æœ‰æ­£ç¡®æ˜ å°„ã€‚

## æ ¹æœ¬åŸå› 

ä¸ä¹‹å‰çš„æ¡£ä½åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜å®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯ axios å“åº”æ‹¦æˆªå™¨çš„æ•°æ®è®¿é—®é—®é¢˜ã€‚

**é”™è¯¯ä»£ç **ï¼ˆ`src/views/Finance/ValueAddedManage.vue` çš„ `loadCompanies` å‡½æ•°ï¼‰ï¼š
```javascript
const tiersRes = await getCompanyPriceTiers(company.id)
const tiers = tiersRes.data || []  // âŒ é”™è¯¯ï¼štiersRes.data æ˜¯ undefined
```

**åŸå› åˆ†æ**ï¼š
1. åç«¯è¿”å›ï¼š`{ success: true, data: [æ¡£ä½æ•°ç»„] }`
2. Axios å“åº”æ‹¦æˆªå™¨ï¼ˆ`src/utils/request.ts`ï¼‰è¿”å› `data` å­—æ®µ
3. æ‰€ä»¥ `tiersRes` å·²ç»æ˜¯æ¡£ä½æ•°ç»„ï¼Œä¸æ˜¯åŒ…å« `data` å±æ€§çš„å¯¹è±¡
4. è®¿é—® `tiersRes.data` å¾—åˆ° `undefined`
5. `tiers` è¢«è®¾ç½®ä¸ºç©ºæ•°ç»„ `[]`
6. æ— æ³•æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§æ¡£ä½
7. `company.topTier` æœªè®¾ç½®
8. åˆ—è¡¨æ˜¾ç¤º"æœªé…ç½®"

## ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**ï¼š`src/views/Finance/ValueAddedManage.vue`

```javascript
// åŠ è½½å¤–åŒ…å…¬å¸åˆ—è¡¨
const loadCompanies = async () => {
  try {
    const res = await getOutsourceCompanies({ pageSize: 1000 }) as any
    const companiesList = res?.data?.list || res?.list || []

    // ä¸ºæ¯ä¸ªå…¬å¸åŠ è½½æœ€é«˜ä¼˜å…ˆçº§çš„æ¡£ä½
    const { getCompanyPriceTiers } = await import('@/api/valueAdded')
    for (const company of companiesList) {
      try {
        const tiersRes = await getCompanyPriceTiers(company.id)
        // ğŸ”¥ ä¿®å¤ï¼šaxiosæ‹¦æˆªå™¨å·²ç»è¿”å›dataï¼ŒtiersReså°±æ˜¯æ¡£ä½æ•°ç»„
        const tiers = Array.isArray(tiersRes) ? tiersRes : (tiersRes?.data || [])
        console.log(`[loadCompanies] å…¬å¸${company.companyName}çš„æ¡£ä½:`, tiers)
        
        // æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ä¸”å¯ç”¨çš„æ¡£ä½
        const activeTiers = tiers.filter((t: any) => t.isActive === 1)
        if (activeTiers.length > 0) {
          // æŒ‰ä¼˜å…ˆçº§é™åºã€æ¡£ä½é¡ºåºå‡åºæ’åº
          activeTiers.sort((a: any, b: any) => {
            if (b.priority !== a.priority) return b.priority - a.priority
            return a.tierOrder - b.tierOrder
          })
          company.topTier = activeTiers[0]
          console.log(`[loadCompanies] å…¬å¸${company.companyName}çš„æœ€é«˜æ¡£ä½:`, company.topTier)
        } else {
          console.log(`[loadCompanies] å…¬å¸${company.companyName}æ²¡æœ‰å¯ç”¨çš„æ¡£ä½`)
        }
      } catch (e) {
        console.error(`åŠ è½½å…¬å¸${company.companyName}çš„æ¡£ä½å¤±è´¥:`, e)
      }
    }

    companies.value = companiesList
  } catch (e) {
    console.error('åŠ è½½å¤–åŒ…å…¬å¸å¤±è´¥:', e)
  }
}
```

## ä¿®å¤å†…å®¹

1. âœ… ä¿®æ”¹æ¡£ä½æ•°æ®è®¿é—®æ–¹å¼ï¼š`tiersRes.data` â†’ `Array.isArray(tiersRes) ? tiersRes : (tiersRes?.data || [])`
2. âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
3. âœ… ç¡®ä¿ `handleTierSaved` è°ƒç”¨ `loadCompanies()` åˆ·æ–°åˆ—è¡¨

## æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æ¡£ä½æ˜ å°„
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. ç‚¹å‡»"å¤–åŒ…å…¬å¸ç®¡ç†"
3. é€‰æ‹©ä¸€ä¸ªå…¬å¸ï¼Œç‚¹å‡»"ç¼–è¾‘"
4. åˆ‡æ¢åˆ°"ä»·æ ¼æ¡£ä½"æ ‡ç­¾é¡µ
5. æ·»åŠ ä¸€ä¸ªæ¡£ä½ï¼š
   - æ¡£ä½åç§°ï¼šæ ‡å‡†æ¡£
   - è®¡ä»·æ–¹å¼ï¼šæŒ‰å•è®¡ä»·
   - å›ºå®šå•ä»·ï¼š900
   - å‹¾é€‰"æ— é™æœŸ"
   - ä¼˜å…ˆçº§ï¼š10
   - çŠ¶æ€ï¼šå¯ç”¨
6. ç‚¹å‡»"ä¿å­˜"

**é¢„æœŸç»“æœ**ï¼š
- æ˜¾ç¤º"æ·»åŠ æˆåŠŸ"æç¤º
- æ¡£ä½å‡ºç°åœ¨åˆ—è¡¨ä¸­
- æ§åˆ¶å°æ˜¾ç¤ºï¼š
  ```
  [handleTierSaved] æ¡£ä½ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨
  [loadCompanies] å…¬å¸xxxçš„æ¡£ä½: [{...}]
  [loadCompanies] å…¬å¸xxxçš„æœ€é«˜æ¡£ä½: {...}
  ```
- è¿”å›å…¬å¸åˆ—è¡¨ï¼Œ"å•ä»·/æ¯”ä¾‹"åˆ—æ˜¾ç¤ºï¼šÂ¥900.00ï¼ˆç»¿è‰²ï¼‰

### 2. æµ‹è¯•å¤šæ¡£ä½ä¼˜å…ˆçº§
1. ä¸ºåŒä¸€å…¬å¸æ·»åŠ å¤šä¸ªæ¡£ä½ï¼Œè®¾ç½®ä¸åŒä¼˜å…ˆçº§
2. ä¿å­˜åæŸ¥çœ‹å…¬å¸åˆ—è¡¨
3. "å•ä»·/æ¯”ä¾‹"åˆ—åº”æ˜¾ç¤ºä¼˜å…ˆçº§æœ€é«˜çš„æ¡£ä½

### 3. æµ‹è¯•æ¯”ä¾‹è®¡ä»·
1. æ·»åŠ ä¸€ä¸ªæŒ‰æ¯”ä¾‹è®¡ä»·çš„æ¡£ä½
2. è®¡ä»·æ–¹å¼ï¼šæŒ‰æ¯”ä¾‹è®¡ä»·
3. æ¯”ä¾‹ï¼š5.00%
4. ä¿å­˜åæŸ¥çœ‹å…¬å¸åˆ—è¡¨
5. "å•ä»·/æ¯”ä¾‹"åˆ—åº”æ˜¾ç¤ºï¼š5.00%ï¼ˆæ©™è‰²ï¼‰

## æ§åˆ¶å°æ—¥å¿—ç¤ºä¾‹

æˆåŠŸçš„æ—¥å¿—åºåˆ—ï¼š
```
[PriceTierDialog] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡emit savedäº‹ä»¶
[PriceTierDialog] savedäº‹ä»¶å·²emit
[handleTierSaved] æ¡£ä½ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨
[handleTierSaved] editingCompany: {id: "xxx", companyName: "äº‘å®¢æœ", ...}
[handleTierSaved] è°ƒç”¨loadCompanyTiersï¼ŒcompanyId: xxx
[loadCompanyTiers] å¼€å§‹åŠ è½½æ¡£ä½ï¼ŒcompanyId: xxx
[loadCompanyTiers] APIè¿”å›: [{id: "xxx", tierName: "æ ‡å‡†æ¡£", unitPrice: 900, ...}]
[loadCompanyTiers] æ¡£ä½åˆ—è¡¨: [{id: "xxx", tierName: "æ ‡å‡†æ¡£", unitPrice: 900, ...}]
[loadCompanies] å…¬å¸äº‘å®¢æœçš„æ¡£ä½: [{id: "xxx", tierName: "æ ‡å‡†æ¡£", unitPrice: 900, ...}]
[loadCompanies] å…¬å¸äº‘å®¢æœçš„æœ€é«˜æ¡£ä½: {id: "xxx", tierName: "æ ‡å‡†æ¡£", unitPrice: 900, priority: 10, ...}
```

## ç›¸åŒé—®é¢˜æ±‡æ€»

è¿™æ˜¯ç¬¬ä¸‰æ¬¡é‡åˆ°ç›¸åŒçš„ axios å“åº”æ•°æ®è®¿é—®é—®é¢˜ï¼š

### 1. ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºé—®é¢˜
**æ–‡ä»¶**ï¼š`src/views/Finance/ValueAddedManage.vue` - `loadStats` å‡½æ•°
**é”™è¯¯**ï¼š`Object.assign(stats, res.data)` â†’ åº”è¯¥æ˜¯ `Object.assign(stats, res)`

### 2. æ¡£ä½åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜
**æ–‡ä»¶**ï¼š`src/views/Finance/ValueAddedManage.vue` - `loadCompanyTiers` å‡½æ•°
**é”™è¯¯**ï¼š`companyTiers.value = res.data || []` â†’ åº”è¯¥æ˜¯ `Array.isArray(res) ? res : (res?.data || [])`

### 3. å…¬å¸åˆ—è¡¨æ¡£ä½æ˜ å°„é—®é¢˜ï¼ˆæœ¬æ¬¡ï¼‰
**æ–‡ä»¶**ï¼š`src/views/Finance/ValueAddedManage.vue` - `loadCompanies` å‡½æ•°
**é”™è¯¯**ï¼š`const tiers = tiersRes.data || []` â†’ åº”è¯¥æ˜¯ `Array.isArray(tiersRes) ? tiersRes : (tiersRes?.data || [])`

## æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

å»ºè®®åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€å¤„ç† API å“åº”ï¼Œé¿å…ç±»ä¼¼é—®é¢˜åå¤å‡ºç°ï¼š

### æ–¹æ¡ˆ1ï¼šåˆ›å»ºå·¥å…·å‡½æ•°
```javascript
// src/utils/response.ts
export function extractData<T>(res: any): T {
  // å¦‚æœå·²ç»æ˜¯æ•°ç»„æˆ–æ™®é€šå¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (Array.isArray(res) || typeof res !== 'object') {
    return res
  }
  // å¦‚æœæœ‰ data å±æ€§ï¼Œè¿”å› data
  if ('data' in res) {
    return res.data
  }
  // å¦åˆ™è¿”å›åŸå€¼
  return res
}

// ä½¿ç”¨
import { extractData } from '@/utils/response'
const tiers = extractData<PriceTier[]>(tiersRes)
```

### æ–¹æ¡ˆ2ï¼šä¿®æ”¹ API å‡½æ•°è¿”å›ç±»å‹
```typescript
// src/api/valueAdded.ts
export function getCompanyPriceTiers(companyId: string): Promise<PriceTier[]> {
  return request({
    url: `/value-added/companies/${companyId}/price-tiers`,
    method: 'get'
  })
}

// ä½¿ç”¨æ—¶ç›´æ¥å¾—åˆ°æ•°ç»„
const tiers = await getCompanyPriceTiers(company.id)
```

### æ–¹æ¡ˆ3ï¼šåœ¨å“åº”æ‹¦æˆªå™¨ä¸­æ·»åŠ ç±»å‹æ ‡è®°
```typescript
// src/utils/request.ts
service.interceptors.response.use(
  (response: AxiosResponse<ResponseData>) => {
    // ... ç°æœ‰é€»è¾‘ ...
    
    // æ ‡è®°æ•°æ®å·²æå–
    const result = data
    if (typeof result === 'object' && result !== null) {
      Object.defineProperty(result, '__extracted', { value: true, enumerable: false })
    }
    return result
  }
)
```

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†å…¬å¸åˆ—è¡¨"å•ä»·/æ¯”ä¾‹"åˆ—ä¸æ˜¾ç¤ºçš„é—®é¢˜ã€‚æ ¸å¿ƒåŸå› æ˜¯ axios å“åº”æ‹¦æˆªå™¨å·²ç»æå–äº† `data` å­—æ®µï¼Œä½†ä»£ç ä¸­ä»ç„¶å°è¯•è®¿é—® `res.data`ã€‚

è¿™æ˜¯é¡¹ç›®ä¸­ç¬¬ä¸‰æ¬¡é‡åˆ°ç›¸åŒé—®é¢˜ï¼Œå¼ºçƒˆå»ºè®®ï¼š
1. ç»Ÿä¸€ API å“åº”å¤„ç†æ–¹å¼
2. æ·»åŠ  TypeScript ç±»å‹å®šä¹‰
3. åœ¨å›¢é˜Ÿä¸­æ˜ç¡®å“åº”æ•°æ®ç»“æ„
4. è€ƒè™‘ä½¿ç”¨å·¥å…·å‡½æ•°ç»Ÿä¸€å¤„ç†

ä¿®å¤åï¼Œä¿å­˜æ¡£ä½æ—¶ä¼šè‡ªåŠ¨åˆ·æ–°å…¬å¸åˆ—è¡¨ï¼Œ"å•ä»·/æ¯”ä¾‹"åˆ—ä¼šæ­£ç¡®æ˜¾ç¤ºæœ€é«˜ä¼˜å…ˆçº§æ¡£ä½çš„ä»·æ ¼ã€‚
