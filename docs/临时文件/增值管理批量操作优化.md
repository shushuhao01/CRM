# 增值管理批量操作优化

## 实现时间
2026-03-01

## 需求说明
优化增值管理页面的批量操作按钮布局和交互：
1. 添加"批量选择公司"按钮
2. 重新组织批量操作按钮（批量选择公司、批量改有效状态、批量改结算状态）
3. 未勾选订单时，批量操作按钮隐藏，常规按钮居右显示
4. 勾选订单后，批量操作按钮显示在左侧，常规按钮向右缩进

## 实现内容

### 1. 前端UI调整 (`src/views/Finance/ValueAddedManage.vue`)

#### 按钮布局重构
```vue
<div class="action-buttons" :class="{ 'has-selection': selectedRows.length > 0 }">
  <!-- 批量操作按钮（勾选订单后显示） -->
  <div v-if="selectedRows.length > 0" class="batch-actions">
    <el-dropdown @command="handleBatchCompany">
      <el-button type="primary">
        批量选择公司 <el-icon class="el-icon--right"><ArrowDown /></el-icon>
      </el-button>
      <template #dropdown>
        <el-dropdown-menu>
          <el-dropdown-item command="default-company">待分配</el-dropdown-item>
          <el-dropdown-item v-for="company in companies" :key="company.id" :command="company.id">
            {{ company.companyName }}
          </el-dropdown-item>
        </el-dropdown-menu>
      </template>
    </el-dropdown>
    <el-dropdown @command="handleBatchValidStatus">
      <el-button type="warning">
        批量改有效状态 <el-icon class="el-icon--right"><ArrowDown /></el-icon>
      </el-button>
      ...
    </el-dropdown>
    <el-dropdown @command="handleBatchSettlementStatus">
      <el-button type="success">
        批量改结算状态 <el-icon class="el-icon--right"><ArrowDown /></el-icon>
      </el-button>
      ...
    </el-dropdown>
  </div>

  <!-- 常规按钮（始终显示） -->
  <div class="regular-actions">
    <el-button type="info" :icon="Setting" @click="showStatusConfigDialog">状态配置</el-button>
    <el-button type="success" :icon="Plus" @click="showCompanyDialog">外包公司管理</el-button>
    <el-button type="primary" :icon="Download" :disabled="selectedRows.length === 0" @click="handleExport">批量导出</el-button>
  </div>
</div>
```

#### 新增批量选择公司函数
```typescript
const handleBatchCompany = async (companyId: string) => {
  if (selectedRows.value.length === 0) {
    ElMessage.warning('请选择订单')
    return
  }

  let companyName = '待分配'
  let unitPrice = 0

  if (companyId !== 'default-company') {
    const company = companies.value.find(c => c.id === companyId)
    if (!company) return
    companyName = company.companyName

    // 使用公司最高优先级档位的单价
    if (company.topTier) {
      if (company.topTier.pricingType === 'fixed') {
        unitPrice = Number(company.topTier.unitPrice) || 0
      }
    }
  }

  try {
    await ElMessageBox.confirm(
      `确定将 ${selectedRows.value.length} 个订单的外包公司改为"${companyName}"吗？`,
      '提示',
      { type: 'warning' }
    )
  } catch { return }

  try {
    const { batchUpdateOrderCompany } = await import('@/api/valueAdded')
    await batchUpdateOrderCompany({
      ids: selectedRows.value.map(r => r.id),
      companyId,
      companyName,
      unitPrice
    })
    ElMessage.success('批量设置成功')
    loadData()
    loadStats()
    loadCompanies()
  } catch (e: any) {
    ElMessage.error(e?.message || '批量设置失败')
  }
}
```

#### CSS样式优化
```scss
.action-buttons {
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 8px 0;
  justify-content: flex-end; // 默认居右
  transition: all 0.3s ease;

  &.has-selection {
    justify-content: space-between; // 有选择时两端对齐
  }
}

.batch-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.regular-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-left: auto; // 自动推到右侧
}
```

### 2. API接口更新 (`src/api/valueAdded.ts`)

更新批量修改订单公司接口，支持传递单价参数：
```typescript
export function batchUpdateOrderCompany(data: { 
  ids: string[]; 
  companyId: string; 
  companyName: string; 
  unitPrice?: number // 新增可选参数
}) {
  return request({
    url: '/value-added/orders/batch-update-company',
    method: 'put',
    data
  })
}
```

### 3. 后端路由更新 (`backend/src/routes/valueAdded.ts`)

优化批量修改订单公司路由，支持接收和使用前端传来的单价：
```typescript
router.put('/orders/batch-update-company', authenticateToken, async (req: Request, res: Response) => {
  try {
    const { ids, companyId, companyName, unitPrice: providedUnitPrice } = req.body;
    const user = (req as any).currentUser;

    // ... 参数验证 ...

    let unitPrice = 0; // 默认单价为0（待分配）

    // 🔥 如果前端提供了单价，优先使用前端的值
    if (providedUnitPrice !== undefined && providedUnitPrice !== null) {
      unitPrice = Number(providedUnitPrice);
    } else if (companyId !== 'default-company') {
      // 🔥 如果不是"待分配"且前端未提供单价，则从数据库获取
      const priceConfigRepo = AppDataSource.getRepository(ValueAddedPriceConfig);
      const priceTier = await priceConfigRepo.findOne({
        where: { companyId, isActive: 1 },
        order: { priority: 'DESC', tierOrder: 'ASC' }
      });

      if (priceTier && priceTier.pricingType === 'fixed') {
        unitPrice = priceTier.unitPrice || 0;
      }
    }

    // 批量更新订单
    const orders = await orderRepo.findBy({ id: In(ids) });
    for (const order of orders) {
      order.companyId = companyId;
      order.companyName = companyName;
      order.unitPrice = unitPrice;
      order.operatorId = user.id;
      order.operatorName = user.name || user.username;
    }

    await orderRepo.save(orders);

    // 更新公司统计
    await updateCompanyStats(companyId);

    res.json({ success: true, message: '批量修改成功' });
  } catch (error: any) {
    console.error('[ValueAdded] Batch update company error:', error);
    res.status(500).json({ success: false, message: '批量修改失败' });
  }
});
```

## 功能特点

### 1. 动态按钮显示
- **未勾选订单**：批量操作按钮隐藏，常规按钮居右显示
- **勾选订单后**：批量操作按钮显示在左侧，常规按钮保持在右侧

### 2. 批量选择公司
- 支持选择"待分配"或任意外包公司
- 自动获取公司最高优先级档位的单价
- 按单计价：使用档位单价
- 按比例计价：单价设为0（需要订单金额才能计算）
- 待分配：单价设为0

### 3. 平滑过渡动画
- 使用CSS transition实现按钮布局的平滑过渡
- 提升用户体验

### 4. 业务规则
- 批量修改公司后自动更新订单单价
- 批量修改后刷新统计数据和公司列表
- 支持确认对话框，防止误操作

## 交互流程

1. 用户勾选一个或多个订单
2. 批量操作按钮从隐藏变为显示（左侧）
3. 常规按钮保持在右侧
4. 点击"批量选择公司"下拉菜单
5. 选择目标公司
6. 弹出确认对话框
7. 确认后批量更新订单的公司和单价
8. 刷新列表和统计数据

## 文件修改清单

- ✅ `src/views/Finance/ValueAddedManage.vue` - UI和逻辑
- ✅ `src/api/valueAdded.ts` - API接口定义
- ✅ `backend/src/routes/valueAdded.ts` - 后端路由

## 测试要点

1. 未勾选订单时，批量操作按钮是否隐藏
2. 勾选订单后，批量操作按钮是否显示
3. 常规按钮是否始终保持在右侧
4. 批量选择公司功能是否正常工作
5. 单价是否正确更新
6. 统计数据是否正确刷新
7. 按钮布局过渡动画是否流畅

## 注意事项

- 批量操作会同时更新多个订单，确保数据库事务处理正确
- 单价计算逻辑与单个订单修改保持一致
- 批量操作后需要刷新公司统计数据
- 按比例计价时单价为0，实际结算时需要根据订单金额计算
