# 价格档位系统实施进度

## 实施时间
2026-03-01

## ✅ 已完成

### 1. 数据库层（100%）
- ✅ 创建`value_added_price_config`表
- ✅ 为现有公司迁移默认档位（从default_unit_price）
- ✅ 删除`outsource_companies.default_unit_price`字段
- ✅ 验证数据迁移成功（合谱公司：第一档 ¥900）

### 2. 后端实体类（100%）
- ✅ 使用现有`ValueAddedPriceConfig`实体类
- ✅ 实体类已在`database.ts`中注册
- ✅ 字段映射完整：
  - `tierName` - 档位名称
  - `tierOrder` - 档位顺序
  - `pricingType` - 计价方式（fixed/percentage）
  - `unitPrice` - 单价
  - `percentageRate` - 比例
  - `startDate/endDate` - 生效时间
  - `isActive` - 状态

### 3. 后端API（100%）
- ✅ 价格档位CRUD接口已存在：
  - `GET /companies/:companyId/price-tiers` - 获取档位列表
  - `POST /companies/:companyId/price-tiers` - 创建档位
  - `PUT /companies/:companyId/price-tiers/:tierId` - 更新档位
  - `DELETE /companies/:companyId/price-tiers/:tierId` - 删除档位
- ✅ 价格计算逻辑已实现（`calculateOrderPrice`函数）

## 🚧 待完成

### 4. 前端组件（0%）
需要创建/修改以下组件：

#### 4.1 PriceTierDialog.vue（新建）
价格档位管理对话框，功能包括：
- 显示档位列表（表格形式）
- 添加/编辑档位表单
- 删除档位
- 档位排序
- 计价方式切换（按单/按比例）

#### 4.2 ValueAddedManage.vue（修改）
主页面修改：
- ❌ 移除"费用配置"按钮
- ❌ 调整"外包公司管理"对话框列宽
- ❌ 添加"价格档位"按钮到公司操作列
- ❌ 修复待分配单价显示900的问题（改为0）
- ❌ 更新`updateOrderCompany`函数（使用档位计算单价）

#### 4.3 API接口文件（修改）
`src/api/valueAdded.ts`需要添加：
- ❌ `getPriceTiers` - 获取档位列表
- ❌ `createPriceTier` - 创建档位
- ❌ `updatePriceTier` - 更新档位
- ❌ `deletePriceTier` - 删除档位

### 5. 业务逻辑优化（0%）
- ❌ 订单同步时自动匹配档位
- ❌ 切换公司时重新计算单价
- ❌ 档位时间冲突检测
- ❌ 档位优先级处理

### 6. 测试验证（0%）
- ❌ 创建档位测试
- ❌ 价格计算测试
- ❌ UI交互测试
- ❌ 数据验证

## 📋 下一步操作

### 立即执行
1. 创建`PriceTierDialog.vue`组件
2. 修改`ValueAddedManage.vue`：
   - 移除费用配置相关代码
   - 添加价格档位按钮
   - 调整对话框列宽
3. 更新`src/api/valueAdded.ts`添加档位API

### 后续优化
1. 实现自动价格计算逻辑
2. 添加档位冲突检测
3. 完善UI交互体验
4. 编写测试用例

## 📁 相关文件

### 数据库
- `backend/database-migrations/create-price-tier-system.sql` - 本地迁移
- `backend/database-migrations/production-create-price-tier-system.sql` - 生产迁移
- `backend/execute-price-tier-migration.js` - 执行脚本

### 后端
- `backend/src/entities/ValueAddedPriceConfig.ts` - 实体类
- `backend/src/routes/valueAdded.ts` - API路由（已有档位接口）
- `backend/src/config/database.ts` - 数据库配置

### 前端（待创建/修改）
- `src/views/Finance/components/PriceTierDialog.vue` - 待创建
- `src/views/Finance/ValueAddedManage.vue` - 待修改
- `src/api/valueAdded.ts` - 待修改

### 文档
- `docs/临时文件/外包公司价格档位系统设计.md` - 设计文档
- `docs/临时文件/外包公司价格档位系统-实施步骤.md` - 实施步骤
- `docs/临时文件/价格档位系统实施进度.md` - 本文档

## 🎯 核心改进点

1. **灵活的价格体系**：支持多档位、多计价方式
2. **时间范围控制**：每个档位可设置生效时间
3. **自动价格匹配**：根据订单日期自动选择档位
4. **简化管理**：集成到外包公司管理中，无需独立页面

## ⚠️ 注意事项

1. **字符集问题**：`value_added_price_config`表使用`utf8mb4_0900_ai_ci`，与`outsource_companies`表一致
2. **外键约束**：暂未添加外键约束，避免字符集冲突
3. **历史数据**：已有订单的单价不会自动更新
4. **待分配单价**：需要在前端修改为0（目前显示900）

## 🔄 生产环境部署

执行文件：`backend/database-migrations/production-create-price-tier-system.sql`

注意：
- 先备份数据库
- 在phpMyAdmin中执行
- 验证档位数据正确
- 测试前端功能正常

## 估算工作量

- 前端组件开发：2-3小时
- API接口对接：30分钟
- 业务逻辑优化：1小时
- 测试验证：1小时
- 总计：约5小时

## 当前状态

数据库和后端API已完成，可以开始前端开发。建议先完成`PriceTierDialog.vue`组件，然后再修改主页面。
