# 增值管理添加订单字段说明

## 完成时间
2026-02-28

## 新增字段

### 1. 订单状态 (order_status)
- **字段类型**: VARCHAR(20)
- **说明**: 记录订单的当前状态
- **可能值**: 
  - pending - 待确认
  - confirmed - 已确认
  - shipped - 已发货
  - delivered - 已签收
  - completed - 已完成
  - cancelled - 已取消
  - rejected - 拒收
- **显示**: 使用el-tag标签，不同状态不同颜色

### 2. 下单日期 (order_date)
- **字段类型**: DATETIME
- **说明**: 记录订单的创建时间
- **格式**: YYYY-MM-DD HH:mm:ss
- **显示**: 格式化为可读的日期时间

### 3. 结算日期 (settlement_date)
- **字段类型**: DATE
- **说明**: 记录订单的结算日期
- **格式**: YYYY-MM-DD
- **显示**: 格式化为日期，未结算显示"-"

## 数据库变更

### 迁移文件
创建了新的迁移文件：`backend/database-migrations/add-order-fields-to-value-added.sql`

### SQL语句
```sql
-- 添加订单状态字段
ALTER TABLE `value_added_orders` 
ADD COLUMN `order_status` VARCHAR(20) NULL COMMENT '订单状态' AFTER `tracking_number`;

-- 添加下单日期字段
ALTER TABLE `value_added_orders` 
ADD COLUMN `order_date` DATETIME NULL COMMENT '下单日期' AFTER `order_status`;

-- 添加索引
ALTER TABLE `value_added_orders` 
ADD KEY `idx_order_status` (`order_status`),
ADD KEY `idx_order_date` (`order_date`);
```

## 后端变更

### 1. 实体类更新
文件：`backend/src/entities/ValueAddedOrder.ts`

```typescript
@Column('varchar', { length: 20, nullable: true, name: 'order_status' })
orderStatus: string | null;

@Column('datetime', { nullable: true, name: 'order_date' })
orderDate: Date | null;
```

### 2. 数据同步逻辑更新
文件：`backend/src/routes/valueAdded.ts`

在同步订单时，从订单表获取订单状态和下单日期：

```typescript
valueAddedOrder.orderStatus = order.status;
valueAddedOrder.orderDate = order.createdAt;
```

## 前端变更

### 1. API接口类型更新
文件：`src/api/valueAdded.ts`

```typescript
export interface ValueAddedOrder {
  // ...
  orderStatus?: string
  orderDate?: string
  // ...
}
```

### 2. 表格列添加
文件：`src/views/Finance/ValueAddedManage.vue`

#### 订单状态列
```vue
<el-table-column prop="orderStatus" label="订单状态" width="90">
  <template #default="{ row }">
    <el-tag v-if="row.orderStatus" :type="getOrderStatusType(row.orderStatus)" size="small">
      {{ getOrderStatusText(row.orderStatus) }}
    </el-tag>
    <span v-else>-</span>
  </template>
</el-table-column>
```

#### 下单日期列
```vue
<el-table-column prop="orderDate" label="下单日期" width="160">
  <template #default="{ row }">
    {{ row.orderDate ? formatDateTime(row.orderDate) : '-' }}
  </template>
</el-table-column>
```

#### 结算日期列
```vue
<el-table-column prop="settlementDate" label="结算日期" width="120">
  <template #default="{ row }">
    {{ row.settlementDate ? formatDate(row.settlementDate) : '-' }}
  </template>
</el-table-column>
```

### 3. 辅助函数添加

#### 订单状态类型映射
```typescript
const getOrderStatusType = (status: string) => {
  const types: Record<string, any> = {
    pending: 'info',
    confirmed: 'primary',
    shipped: 'primary',
    delivered: 'success',
    completed: 'success',
    cancelled: 'danger',
    rejected: 'danger'
  }
  return types[status] || 'info'
}
```

#### 订单状态文本映射
```typescript
const getOrderStatusText = (status: string) => {
  const texts: Record<string, string> = {
    pending: '待确认',
    confirmed: '已确认',
    shipped: '已发货',
    delivered: '已签收',
    completed: '已完成',
    cancelled: '已取消',
    rejected: '拒收'
  }
  return texts[status] || status
}
```

## 表格列顺序

更新后的列顺序：
1. 选择框
2. 订单号
3. 客户姓名
4. 客户电话
5. 物流单号
6. **订单状态** ⭐ 新增
7. **下单日期** ⭐ 新增
8. 外包公司
9. 单价
10. 实际结算
11. 状态
12. 结算状态
13. 创建时间
14. **结算日期** ⭐ 新增
15. 操作

## 状态标签颜色

### 订单状态
- 待确认 (pending) - 灰色 (info)
- 已确认 (confirmed) - 蓝色 (primary)
- 已发货 (shipped) - 蓝色 (primary)
- 已签收 (delivered) - 绿色 (success)
- 已完成 (completed) - 绿色 (success)
- 已取消 (cancelled) - 红色 (danger)
- 拒收 (rejected) - 红色 (danger)

### 资料状态
- 待处理 (pending) - 橙色 (warning)
- 有效 (valid) - 绿色 (success)
- 无效 (invalid) - 红色 (danger)
- 已补单 (supplemented) - 灰色 (info)

### 结算状态
- 未结算 (unsettled) - 橙色 (warning)
- 已结算 (settled) - 绿色 (success)

## 部署步骤

### 1. 执行数据库迁移
在MySQL数据库中执行迁移文件：
```bash
mysql -u username -p database_name < backend/database-migrations/add-order-fields-to-value-added.sql
```

### 2. 重启后端服务
```bash
cd backend
npm run dev
```

### 3. 刷新前端页面
访问 http://localhost:5173，进入增值管理页面，验证新字段显示正常。

## 测试步骤

### 1. 测试数据同步
1. 在订单管理中创建新订单
2. 将订单状态改为"已签收"或"已完成"
3. 进入增值管理页面
4. 验证新订单自动出现在列表中
5. 验证订单状态和下单日期正确显示

### 2. 测试订单状态显示
1. 验证不同订单状态显示不同颜色的标签
2. 验证状态文本正确（中文）
3. 验证未设置状态时显示"-"

### 3. 测试日期显示
1. 验证下单日期格式正确（YYYY-MM-DD HH:mm:ss）
2. 验证结算日期格式正确（YYYY-MM-DD）
3. 验证未结算订单的结算日期显示"-"

### 4. 测试结算功能
1. 标记订单为有效
2. 点击"结算"按钮
3. 验证结算日期自动填充为当前日期
4. 验证结算日期在列表中正确显示

## 注意事项

1. **数据库迁移**：必须先执行数据库迁移，添加新字段后才能正常使用

2. **历史数据**：已存在的增值订单记录，订单状态和下单日期为NULL，显示为"-"

3. **自动同步**：新同步的订单会自动填充订单状态和下单日期

4. **结算日期**：只有在执行结算操作时才会填充结算日期

5. **列宽度**：
   - 订单状态：90px
   - 下单日期：160px
   - 结算日期：120px

## 相关文件

### 数据库
- `backend/database-migrations/add-order-fields-to-value-added.sql` - 新增字段迁移

### 后端
- `backend/src/entities/ValueAddedOrder.ts` - 实体类
- `backend/src/routes/valueAdded.ts` - 路由和同步逻辑

### 前端
- `src/api/valueAdded.ts` - API接口类型
- `src/views/Finance/ValueAddedManage.vue` - 主视图

## 服务器状态

- 前端服务器：运行中（端口5173）
- 后端服务器：运行中（端口3000）
- 访问地址：http://localhost:5173

## 相关文档

- [增值管理布局和分页优化](./增值管理布局和分页优化.md)
- [增值管理UI优化说明](./增值管理UI优化说明.md)
- [增值管理系统完善说明](./增值管理系统完善说明.md)
- [增值管理系统功能说明](./增值管理系统功能说明.md)
