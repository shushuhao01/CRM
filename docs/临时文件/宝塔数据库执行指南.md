# 宝塔数据库执行指南 - 增值管理系统

## 问题说明
原SQL脚本使用了 `UUID()` 函数配合 `ON DUPLICATE KEY UPDATE`，在宝塔phpMyAdmin中执行会报错。

## 解决方案
使用固定ID的 `INSERT IGNORE` 语句替代。

## 执行步骤

### 方法1：使用简化脚本（推荐）

1. **打开文件**
   - 文件路径：`backend/database-migrations/production-value-added-simple.sql`

2. **在宝塔phpMyAdmin中执行**
   - 选择数据库 `abc789_cn`
   - 点击"SQL"标签
   - 复制整个文件内容
   - 粘贴到SQL输入框
   - 点击"执行"

3. **查看验证结果**
   - 执行成功后会显示4张表的记录数
   - 应该看到：
     ```
     外包公司表: 0
     费用配置表: 1
     增值订单表: 0
     状态配置表: 6
     ```

### 方法2：分步执行（如果方法1失败）

#### 步骤1：创建外包公司表
```sql
USE abc789_cn;

CREATE TABLE IF NOT EXISTS `outsource_companies` (
  `id` VARCHAR(50) NOT NULL,
  `company_name` VARCHAR(200) NOT NULL,
  `contact_person` VARCHAR(50) NULL,
  `contact_phone` VARCHAR(20) NULL,
  `contact_email` VARCHAR(100) NULL,
  `address` VARCHAR(500) NULL,
  `status` VARCHAR(20) DEFAULT 'active',
  `default_unit_price` DECIMAL(10, 2) DEFAULT 0,
  `total_orders` INT DEFAULT 0,
  `valid_orders` INT DEFAULT 0,
  `invalid_orders` INT DEFAULT 0,
  `total_amount` DECIMAL(12,2) DEFAULT 0,
  `settled_amount` DECIMAL(12,2) DEFAULT 0,
  `remark` TEXT NULL,
  `created_by` VARCHAR(50) NULL,
  `created_by_name` VARCHAR(50) NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 步骤2：创建费用配置表
```sql
CREATE TABLE IF NOT EXISTS `value_added_price_config` (
  `id` VARCHAR(50) NOT NULL,
  `config_name` VARCHAR(100) NOT NULL,
  `company_id` VARCHAR(50) NULL,
  `company_name` VARCHAR(200) NULL,
  `unit_price` DECIMAL(10,2) NOT NULL,
  `start_date` DATE NULL,
  `end_date` DATE NULL,
  `conditions` JSON NULL,
  `status` VARCHAR(20) DEFAULT 'active',
  `remark` TEXT NULL,
  `created_by` VARCHAR(50) NULL,
  `created_by_name` VARCHAR(50) NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 步骤3：创建增值订单表
```sql
CREATE TABLE IF NOT EXISTS `value_added_orders` (
  `id` VARCHAR(50) NOT NULL,
  `order_id` VARCHAR(50) NULL,
  `order_number` VARCHAR(50) NULL,
  `customer_id` VARCHAR(50) NULL,
  `customer_name` VARCHAR(100) NULL,
  `customer_phone` VARCHAR(20) NULL,
  `tracking_number` VARCHAR(100) NULL,
  `order_status` VARCHAR(20) NULL,
  `order_date` DATETIME NULL,
  `company_id` VARCHAR(50) NOT NULL,
  `company_name` VARCHAR(200) NOT NULL,
  `unit_price` DECIMAL(10,2) NOT NULL,
  `status` VARCHAR(20) DEFAULT 'pending',
  `settlement_status` VARCHAR(20) DEFAULT 'unsettled',
  `settlement_amount` DECIMAL(10,2) DEFAULT 0,
  `settlement_date` DATE NULL,
  `settlement_batch` VARCHAR(50) NULL,
  `invalid_reason` VARCHAR(500) NULL,
  `supplement_order_id` VARCHAR(50) NULL,
  `export_date` DATE NULL,
  `export_batch` VARCHAR(50) NULL,
  `remark` TEXT NULL,
  `operator_id` VARCHAR(50) NULL,
  `operator_name` VARCHAR(50) NULL,
  `created_by` VARCHAR(50) NULL,
  `created_by_name` VARCHAR(50) NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 步骤4：创建状态配置表
```sql
CREATE TABLE IF NOT EXISTS `value_added_status_configs` (
  `id` VARCHAR(36) NOT NULL,
  `type` VARCHAR(50) NOT NULL,
  `value` VARCHAR(100) NOT NULL,
  `label` VARCHAR(100) NOT NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_value` (`type`, `value`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 步骤5：插入默认数据
```sql
-- 默认费用配置
INSERT IGNORE INTO `value_added_price_config` 
(`id`, `config_name`, `unit_price`, `status`, `remark`, `created_by_name`) 
VALUES
('default-config-001', '默认费用配置', 900.00, 'active', '系统默认配置', '系统');

-- 有效状态配置
INSERT IGNORE INTO `value_added_status_configs` (`id`, `type`, `value`, `label`) VALUES
('vs-pending-001', 'validStatus', 'pending', '待处理'),
('vs-valid-001', 'validStatus', 'valid', '有效'),
('vs-invalid-001', 'validStatus', 'invalid', '无效'),
('vs-supplemented-001', 'validStatus', 'supplemented', '已补单');

-- 结算状态配置
INSERT IGNORE INTO `value_added_status_configs` (`id`, `type`, `value`, `label`) VALUES
('ss-unsettled-001', 'settlementStatus', 'unsettled', '未结算'),
('ss-settled-001', 'settlementStatus', 'settled', '已结算');
```

#### 步骤6：验证
```sql
-- 检查表是否创建
SHOW TABLES LIKE '%value_added%';
SHOW TABLES LIKE 'outsource_companies';

-- 检查数据
SELECT * FROM value_added_price_config;
SELECT * FROM value_added_status_configs;
```

## 常见问题

### Q: 提示"表已存在"
A: 这是正常的，说明表已经创建过了。可以跳过该步骤。

### Q: 提示"Duplicate entry"
A: 使用了 `INSERT IGNORE`，重复数据会被忽略，这是正常的。

### Q: JSON字段报错
A: 确保MySQL版本 >= 5.7.8，如果版本较低，将JSON改为TEXT类型。

### Q: 字符集问题
A: 确保数据库使用 utf8mb4 字符集：
```sql
ALTER DATABASE abc789_cn CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## 执行后检查

1. **检查表结构**
```sql
DESC outsource_companies;
DESC value_added_price_config;
DESC value_added_orders;
DESC value_added_status_configs;
```

2. **检查数据**
```sql
SELECT COUNT(*) FROM value_added_price_config;  -- 应该是1
SELECT COUNT(*) FROM value_added_status_configs;  -- 应该是6
```

3. **重启后端服务**
```bash
pm2 restart crm-backend
```

4. **测试前端**
- 刷新浏览器
- 进入增值管理页面
- 应该能正常加载

## 修复说明

### 原问题
```sql
-- ❌ 错误写法
INSERT INTO table VALUES (UUID(), ...) 
ON DUPLICATE KEY UPDATE ...;
```
UUID()在每次执行时生成新ID，导致重复键冲突。

### 修复方案
```sql
-- ✅ 正确写法
INSERT IGNORE INTO table VALUES ('fixed-id-001', ...);
```
使用固定ID和INSERT IGNORE，避免重复插入。

## 相关文件

- **简化脚本**: `backend/database-migrations/production-value-added-simple.sql`
- **完整脚本**: `backend/database-migrations/production-value-added-system.sql`
- **本地脚本**: `backend/database-migrations/complete-value-added-system.sql`
