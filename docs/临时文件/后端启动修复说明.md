# 后端启动修复说明

## 问题描述

后端服务无法启动，`backend/src/app.ts` 文件存在多处语法错误：
- 未闭合的字符串
- 乱码字符（�）
- TypeScript编译错误

## 修复内容

### 1. 修复所有乱码字符

修复了以下位置的乱码：

```typescript
// ❌ 错误
console.log(`?已加?{isProduction ? '生产' : '开?}环境配置: ${envFile}`);

// ✅ 正确
console.log(`已加载${isProduction ? '生产' : '开发'}环境配置: ${envFile}`);
```

### 2. 修复未闭合的注释

```typescript
// ❌ 错误
// 安全中间?if (process.env.HELMET_ENABLED !== 'false') {

// ✅ 正确
// 安全中间件
if (process.env.HELMET_ENABLED !== 'false') {
```

### 3. 修复其他语法错误

- 修复了"信任代理"注释的乱码
- 修复了"静态文件服务"注释的乱码
- 修复了"启动服务器"注释的乱码
- 修复了"已清理"日志的乱码
- 修复了"健康检查端点"注释的乱码
- 修复了Mock路由注释的乱码
- 修复了"业绩报表定时发送服务失败"日志的乱码

## 启动步骤

### 1. 停止当前后端进程

如果后端正在运行，按 `Ctrl+C` 停止。

### 2. 重新启动后端

```bash
cd backend
npm run dev
```

### 3. 验证启动成功

后端控制台应该输出：

```
已加载开发环境配置: .env.local
✅ 数据库初始化完成
✅ 录音存储服务初始化完成
🚀 CRM API服务已启动
📍 服务地址: http://localhost:3000
🔗 API前缀: /api/v1
🌍 运行环境: development
📊 健康检查: http://localhost:3000/health
🔌 WebSocket实时推送服务已启动
📱 移动端 WebSocket 服务已启动
📅 [定时任务] 消息自动清理任务已启动
✅ [定时任务] 超时提醒服务已启动
📊 [定时任务] 业绩报表定时发送服务已启动
🧹 [定时任务] 消息清理服务已启动
```

## 测试代收取消申请功能

### 1. 刷新前端页面

按 `F5` 或 `Ctrl+R` 刷新浏览器页面。

### 2. 提交申请

1. 进入"代收取消申请"页面
2. 点击"发起申请"
3. 选择订单（下拉选择）
4. 填写修改后金额和取消原因
5. 上传尾款凭证（可选）
6. 点击"提交申请"

### 3. 查看后端日志

提交申请时，后端控制台应该输出：

```
[CodApplication] 权限检查: {
  userId: 'admin',
  username: 'admin',
  userRole: 'admin',
  isAdmin: true,
  orderCreatedBy: 'user_xxx',
  canApply: true
}
```

如果成功，前端会显示"申请提交成功，等待审核"。

## 如果还是报错

### 检查1：数据库连接

确认 `.env.local` 中的数据库配置正确：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=你的密码
DB_DATABASE=crm
```

### 检查2：数据库表

确认 `cod_cancel_applications` 表已创建：

```bash
cd backend
npm run init:cod-table
```

或手动执行SQL：

```sql
-- 见 backend/cod-application-production.sql
```

### 检查3：诊断脚本

运行诊断脚本检查所有依赖：

```bash
cd backend
node diagnose.js
```

应该输出：

```
数据库连接: ✅
数据库表: ✅
实体文件: ✅
路由文件: ✅
后端服务: ✅

🎉 所有检查通过！
```

## 相关文件

- `backend/src/app.ts` - 主应用文件（已修复）
- `backend/src/routes/codApplication.ts` - 代收申请路由
- `backend/src/entities/CodCancelApplication.ts` - 实体定义
- `backend/diagnose.js` - 诊断脚本
- `500错误修复说明.md` - 之前的500错误修复说明

## 注意事项

1. **必须重启后端**：修改代码后必须重启后端服务
2. **清空浏览器缓存**：建议清空缓存并硬性重新加载
3. **查看控制台日志**：出现问题时查看后端控制台的详细错误日志
4. **权限控制**：管理员和超管可以申请任何订单，成员只能申请自己创建的订单

## 功能说明

### 权限控制

- **成员**：只能申请自己创建的订单
- **经理**：可以申请本部门的订单
- **管理员/超管**：可以申请任何订单

### 订单状态验证

只有已发货的订单才能申请取消代收：
- `shipped` - 已发货
- `delivered` - 已送达
- `completed` - 已完成

### 重复申请检查

同一订单如果有待审核的申请，不能重复提交。

### 金额验证

修改后金额必须在 0 到原代收金额之间。

### 图片上传

- 支持格式：jpeg, jpg, png, gif, webp
- 文件大小限制：5MB
- 存储路径：`uploads/cod-proof/`
- 支持粘贴图片和点击上传两种方式

### 审核流程

1. 申请人提交申请（状态：pending）
2. 审核人审核（通过/驳回）
3. 审核通过后自动更新订单代收信息
4. 如果修改后金额为0，订单代收状态改为"已取消"

## 下一步

后端服务启动成功后，可以：

1. 测试提交申请功能
2. 测试审核功能
3. 测试批量审核功能
4. 验证权限控制是否正确
5. 验证订单代收信息是否正确更新
