# 绩效佣金计算问题排查指南

## 问题现象
将订单设置为"有效"状态后，预估佣金没有变化，仍然显示为 ¥0.0

## 佣金计算逻辑

### 计算条件
1. 订单状态必须是"有效"（performanceStatus = 'valid'）
2. 系数必须大于0（performanceCoefficient > 0）
3. 必须配置了佣金阶梯（CommissionLadder表）

### 计算公式

#### 按金额计提（commissionType = 'amount'）
1. 统计该销售人员在时间范围内的签收业绩总金额
   - 只统计状态为 delivered/completed/signed 的订单
   - 只统计有效订单（performanceStatus = 'valid'）
   - 只统计系数>0的订单
   - 总金额 = SUM(订单金额 × 系数)

2. 根据总金额匹配阶梯比例
   - 例如：0-10000元 → 5%，10000-50000元 → 8%

3. 单个订单佣金 = 订单金额 × 系数 × 阶梯比例

#### 按单数计提（commissionType = 'count'）
1. 统计该销售人员在时间范围内的签收订单数量
   - 只统计状态为 delivered/completed/signed 的订单
   - 只统计有效订单（performanceStatus = 'valid'）
   - 只统计系数>0的订单
   - 总数量 = SUM(系数)

2. 根据总数量匹配阶梯单价
   - 例如：0-10单 → 50元/单，10-50单 → 80元/单

3. 单个订单佣金 = 系数 × 阶梯单价

## 排查步骤

### 1. 检查订单状态
```sql
-- 查看订单的当前状态
SELECT 
    order_number AS '订单号',
    status AS '订单状态',
    performance_status AS '绩效状态',
    performance_coefficient AS '系数',
    total_amount AS '订单金额',
    estimated_commission AS '预估佣金'
FROM orders
WHERE order_number = 'ORD202602022049437';
```

**问题点**：
- 如果订单状态不是 delivered/completed/signed，则不会计入业绩统计
- 图片中显示订单状态是"已签收"，这个应该没问题

### 2. 检查是否有阶梯配置
```sql
-- 查看佣金阶梯配置
SELECT 
    id,
    commission_type AS '计提类型',
    department_id AS '部门ID',
    min_value AS '最小值',
    max_value AS '最大值',
    commission_rate AS '比例',
    commission_per_unit AS '单价',
    is_active AS '是否启用',
    sort_order AS '排序'
FROM commission_ladders
WHERE is_active = 1
ORDER BY commission_type, sort_order;
```

**问题点**：
- 如果没有任何阶梯配置，佣金会是0
- 如果阶梯配置的 is_active = 0，也不会生效

### 3. 检查销售人员的业绩统计
```sql
-- 统计销售人员的签收业绩（按金额）
SELECT 
    created_by AS '销售人员ID',
    created_by_name AS '销售人员',
    COUNT(*) AS '订单数',
    SUM(total_amount * performance_coefficient) AS '总业绩',
    SUM(performance_coefficient) AS '总系数'
FROM orders
WHERE created_by = '销售人员ID'
    AND status IN ('delivered', 'completed', 'signed')
    AND performance_status = 'valid'
    AND performance_coefficient > 0
    AND created_at >= '2026-02-01'
    AND created_at <= '2026-02-28 23:59:59'
GROUP BY created_by, created_by_name;
```

### 4. 检查时间范围
- 前端传递的 startDate 和 endDate 必须包含该订单的创建时间
- 如果订单创建时间不在筛选的时间范围内，统计业绩时不会包含该订单

## 可能的原因

### 原因1：没有配置佣金阶梯
**解决方案**：
1. 进入"配置管理"
2. 添加佣金阶梯配置
3. 选择计提类型（按金额或按单数）
4. 设置阶梯范围和比例/单价

### 原因2：订单状态不是已签收
**解决方案**：
- 订单必须是 delivered/completed/signed 状态才会计入业绩
- 图片中显示是"已签收"，应该没问题

### 原因3：时间范围不匹配
**解决方案**：
- 确保筛选的时间范围包含该订单的创建时间
- 图片中显示筛选的是"本月"（2026-02-01 至 2026-02-28）
- 订单创建时间是 2026-02-25，在范围内，应该没问题

### 原因4：阶梯配置的部门不匹配
**解决方案**：
- 检查阶梯配置是否指定了部门
- 如果指定了部门，必须与订单的部门匹配
- 如果没有匹配的部门阶梯，会使用全局阶梯（department_id 为空）

## 建议的修复方案

### 方案1：添加调试日志
在后端 `calculateCommission` 函数中添加详细的日志输出：
```typescript
console.log('[佣金计算] 订单金额:', orderAmount);
console.log('[佣金计算] 系数:', coefficient);
console.log('[佣金计算] 部门ID:', departmentId);
console.log('[佣金计算] 用户ID:', userId);
console.log('[佣金计算] 时间范围:', startDate, '至', endDate);
console.log('[佣金计算] 找到的阶梯配置:', ladders.length, '个');
console.log('[佣金计算] 计提类型:', commissionType);
console.log('[佣金计算] 总业绩/总单数:', totalAmount || totalCount);
console.log('[佣金计算] 匹配的比例/单价:', rate || perUnit);
console.log('[佣金计算] 最终佣金:', commission);
```

### 方案2：检查数据库配置
执行上面的SQL查询，确认：
1. 有阶梯配置且 is_active = 1
2. 阶梯配置的范围覆盖了当前的业绩/单数
3. 阶梯配置的部门匹配或为全局配置

### 方案3：前端显示调试信息
在前端更新成功后，显示计算的详细信息：
```javascript
console.log('更新结果:', response);
console.log('预估佣金:', response.data.estimatedCommission);
```

## 下一步操作

1. 先检查是否有佣金阶梯配置
2. 如果没有，先配置阶梯
3. 如果有配置，检查配置的范围和部门是否正确
4. 添加调试日志，查看计算过程
