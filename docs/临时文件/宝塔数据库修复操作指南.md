# 宝塔 phpMyAdmin 角色类型修复操作指南

## 问题说明
生产环境中5个系统预设角色的类型显示为"自定义角色"，需要修改为"系统角色"。

## 操作步骤

### 方法一：使用简化 SQL 脚本（推荐）

1. **打开宝塔 phpMyAdmin**
   - 登录宝塔面板
   - 进入"数据库"菜单
   - 点击数据库名称右侧的"管理"按钮

2. **选择数据库**
   - 在左侧数据库列表中，选择 `crm` 数据库

3. **打开 SQL 执行器**
   - 点击顶部菜单的"SQL"标签

4. **执行第一条 SQL（检查当前状态）**
   ```sql
   SELECT id, name, display_name, is_system, created_at
   FROM roles 
   WHERE name IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service')
   ORDER BY id;
   ```
   - 复制上面的 SQL
   - 粘贴到 SQL 输入框
   - 点击"执行"按钮
   - 查看结果，确认 `is_system` 字段的值（应该是 0）

5. **执行第二条 SQL（修复角色类型）**
   ```sql
   UPDATE roles 
   SET is_system = 1 
   WHERE name IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
   ```
   - 复制上面的 SQL
   - 粘贴到 SQL 输入框
   - 点击"执行"按钮
   - 应该显示"影响了 5 行"

6. **执行第三条 SQL（验证修复结果）**
   ```sql
   SELECT id, name, display_name, is_system, updated_at
   FROM roles 
   WHERE name IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service')
   ORDER BY id;
   ```
   - 复制上面的 SQL
   - 粘贴到 SQL 输入框
   - 点击"执行"按钮
   - 确认 `is_system` 字段的值已经变为 1

7. **执行第四条 SQL（查看所有角色类型分布）**
   ```sql
   SELECT 
       CASE 
           WHEN is_system = 1 THEN '系统角色'
           ELSE '自定义角色'
       END as role_type,
       COUNT(*) as count
   FROM roles 
   GROUP BY is_system;
   ```
   - 复制上面的 SQL
   - 粘贴到 SQL 输入框
   - 点击"执行"按钮
   - 查看结果，应该显示：
     - 系统角色: 5
     - 自定义角色: X（自定义角色数量）

### 方法二：使用宝塔命令行（备选）

如果 phpMyAdmin 无法执行，可以使用宝塔的命令行工具：

1. **登录服务器 SSH**
   ```bash
   ssh root@your-server-ip
   ```

2. **连接 MySQL**
   ```bash
   mysql -u root -p
   ```

3. **选择数据库**
   ```sql
   USE crm;
   ```

4. **执行修复 SQL**
   ```sql
   UPDATE roles 
   SET is_system = 1 
   WHERE name IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
   ```

5. **验证结果**
   ```sql
   SELECT id, name, display_name, is_system 
   FROM roles 
   WHERE name IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
   ```

6. **退出 MySQL**
   ```sql
   EXIT;
   ```

## 验证修复

修复完成后，请执行以下验证步骤：

1. **清除浏览器缓存**
   - 按 `Ctrl + Shift + Delete`（Windows）或 `Cmd + Shift + Delete`（Mac）
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **重新登录系统**
   - 退出当前账号
   - 重新登录

3. **检查角色列表**
   - 进入"系统管理" > "角色权限"
   - 查看5个预设角色的"角色类型"列
   - 应该显示为"系统角色"

## 预期结果

修复后，5个系统预设角色应该显示为：

| 角色名称 | 角色编码 | is_system | 角色类型显示 |
|---------|---------|-----------|-------------|
| 超级管理员 | super_admin | 1 | 系统角色 |
| 管理员 | admin | 1 | 系统角色 |
| 部门经理 | department_manager | 1 | 系统角色 |
| 销售员 | sales_staff | 1 | 系统角色 |
| 客服 | customer_service | 1 | 系统角色 |

## 常见问题

### Q1: 执行 UPDATE 语句时提示"影响了 0 行"
**原因**：可能是角色名称不匹配，或者 is_system 字段已经是 1

**解决方案**：
1. 先执行查询语句，检查角色名称是否正确
2. 检查 is_system 字段的当前值

### Q2: 提示"Unknown column 'is_system'"
**原因**：数据库表中没有 is_system 字段（这种情况很少见）

**解决方案**：
```sql
ALTER TABLE roles 
ADD COLUMN is_system TINYINT(1) DEFAULT 0 
COMMENT '是否系统角色：1-系统角色, 0-自定义角色';
```

### Q3: 修复后前端仍然显示"自定义角色"
**原因**：浏览器缓存或前端缓存未清除

**解决方案**：
1. 清除浏览器缓存
2. 重新登录系统
3. 如果仍然不行，按 `Ctrl + F5` 强制刷新页面

## 注意事项

1. **备份数据库**：执行任何 UPDATE 操作前，建议先备份数据库
2. **逐条执行**：在宝塔 phpMyAdmin 中，请逐条执行 SQL 语句，不要一次性粘贴所有语句
3. **验证结果**：每次执行后，都要验证结果是否正确
4. **通知用户**：修复完成后，通知所有用户清除缓存或重新登录

## 相关文件

- **正确的 SQL 脚本**：`backend/database-migrations/production-fix-roles-is-system.sql`（使用 is_system 字段）
- 旧版 SQL 脚本：`backend/database-migrations/production-fix-role-types-simple.sql`（已废弃，使用了错误的字段名）
- 数据库表结构：`backend/database-schema.sql`

## 重要说明

生产数据库使用的是 `is_system` 字段（TINYINT 类型），而不是 `roleType` 字段：
- `is_system = 1` 表示系统角色
- `is_system = 0` 表示自定义角色
