# 外包公司默认单价功能说明

## 更新时间
2026-03-01

## 功能概述
为外包公司管理添加"默认单价"字段，用于设置每个外包公司的默认订单单价。

## 修改内容

### 1. 数据库变更
**文件**: `backend/database-migrations/add-default-unit-price-to-companies.sql`

添加字段：
- `default_unit_price` DECIMAL(10, 2) - 默认单价

执行迁移：
```sql
ALTER TABLE outsource_companies 
ADD COLUMN default_unit_price DECIMAL(10, 2) DEFAULT 0 COMMENT '默认单价' 
AFTER status;

-- 可选：为现有公司设置默认值
UPDATE outsource_companies 
SET default_unit_price = 900 
WHERE default_unit_price = 0;
```

### 2. 后端实体更新
**文件**: `backend/src/entities/OutsourceCompany.ts`

添加字段：
```typescript
@Column('decimal', { precision: 10, scale: 2, default: 0, name: 'default_unit_price' })
defaultUnitPrice: number;
```

### 3. 后端路由更新
**文件**: `backend/src/routes/valueAdded.ts`

- 创建公司接口：添加 `defaultUnitPrice` 参数处理
- 更新公司接口：添加 `defaultUnitPrice` 参数处理

### 4. 前端接口类型更新
**文件**: `src/api/valueAdded.ts`

```typescript
export interface OutsourceCompany {
  // ... 其他字段
  defaultUnitPrice: number  // 新增
  // ... 其他字段
}
```

### 5. 前端页面更新
**文件**: `src/views/Finance/ValueAddedManage.vue`

#### 表单字段
- 添加/编辑公司弹窗中增加"默认单价"输入框
- 使用 `el-input-number` 组件，支持小数点后2位

#### 列表显示
- 外包公司列表中增加"默认单价"列
- 显示格式：¥xxx.xx

#### 表单数据
```typescript
const companyForm = reactive({
  // ... 其他字段
  defaultUnitPrice: 0,  // 新增
  // ... 其他字段
})
```

### 6. 费用配置弹窗修复
修复了费用配置按钮点击无弹窗的问题：
- 添加 `handlePriceConfigDialogClose` 函数，在关闭时清空 `currentCompanyId`
- 修复 `showAddPriceDialog` 函数，正确设置 `companyId`

## 使用说明

### 添加外包公司
1. 点击"外包公司管理"按钮
2. 点击"添加公司"按钮
3. 填写公司信息，包括：
   - 公司名称（必填）
   - 默认单价（必填）
   - 联系人、电话、邮箱等（可选）
4. 点击"保存"

### 编辑外包公司
1. 在公司列表中点击"编辑"按钮
2. 修改公司信息，包括默认单价
3. 点击"保存"

### 查看默认单价
- 在外包公司列表中可以直接看到每个公司的默认单价
- 默认单价会影响该公司订单的单价计算

## 数据映射关系

```
外包公司.默认单价 → 增值订单.单价
```

当创建新的增值订单时，会使用对应外包公司的默认单价作为订单单价。

## 注意事项

1. 默认单价为必填项，不能为空
2. 默认单价支持小数点后2位
3. 修改公司的默认单价不会影响已创建的订单
4. 建议在添加公司时就设置好默认单价

## 部署步骤

1. 执行数据库迁移脚本：
   ```bash
   # 在MySQL中执行
   source backend/database-migrations/add-default-unit-price-to-companies.sql
   ```

2. 重启后端服务：
   ```bash
   cd backend
   npm run build
   pm2 restart crm-backend
   ```

3. 清除前端缓存并重新构建：
   ```bash
   cd admin
   npm run build
   ```

## 验证测试

1. 添加新公司，设置默认单价
2. 编辑现有公司，修改默认单价
3. 查看公司列表，确认默认单价显示正确
4. 点击"费用配置"按钮，确认弹窗正常打开
5. 创建新订单，确认单价使用公司的默认单价
