# 增值管理状态和公司显示优化

## 修复内容

### 1. 统计数据显示修复
**问题**：汇总卡片数据显示为0，但标签页数量统计正常
**原因**：axios拦截器已经返回data，前端代码重复访问res.data导致undefined
**修复**：
- `src/views/Finance/ValueAddedManage.vue` - loadStats函数
- `src/views/Finance/components/ValueAddedConfigDialog.vue` - loadConfigs函数
- 将 `Object.assign(stats, res.data)` 改为 `Object.assign(stats, res)`

### 2. 批量搜索功能修复
**问题**：批量搜索时数据加载失败
**原因**：TypeORM使用了错误的占位符语法（`?`而不是命名参数）
**修复**：
- `backend/src/routes/valueAdded.ts` - 关键词搜索部分
- 使用命名参数 `:kw0_1`, `:kw0_2` 等
- 支持订单号、客户电话、物流单号、客户姓名（模糊搜索）
- 支持多种分隔符：换行、逗号、分号

### 3. 外包公司选择优化
**问题**：列表中没有"待分配"选项，无法将订单设为待分配状态
**修复**：
- 在公司下拉列表中添加"待分配"选项（value: `default-company`）
- 更新订单公司时支持"待分配"选项
- 后端接口支持 `default-company` 作为特殊值

### 4. 单价自动更新
**问题**：切换公司时单价没有自动更新
**修复**：
- 前端：`updateOrderCompany` 函数根据公司获取默认单价
- 后端：`PUT /orders/:id/company` 接口返回更新后的单价
- 待分配状态使用默认单价900元

### 5. 取消默认公司功能
**问题**：设置默认公司后无法取消
**修复**：
- 添加"取消默认"按钮（当公司为默认时显示）
- 前端：`cancelDefaultCompany` 函数
- 后端：支持 `id='none'` 参数取消所有默认公司
- 取消后新订单将显示为"待分配"

### 6. 状态配置显示修复
**问题**：状态配置弹窗中没有显示预设状态
**原因**：同样是axios拦截器数据访问问题
**修复**：
- `ValueAddedConfigDialog.vue` 中修复数据访问
- 现在正确显示有效状态和结算状态列表

### 7. 删除重复路由
**问题**：后端存在重复的 `/companies/:id/set-default` 路由定义
**修复**：删除重复定义，保留一个并增强功能

## 修改的文件

### 前端文件
1. `src/views/Finance/ValueAddedManage.vue`
   - 修复loadStats函数数据访问
   - 添加"待分配"选项到公司下拉列表
   - 优化updateOrderCompany函数支持单价自动更新
   - 添加cancelDefaultCompany函数
   - 更新外包公司管理操作列显示取消默认按钮

2. `src/views/Finance/components/ValueAddedConfigDialog.vue`
   - 修复loadConfigs函数数据访问

### 后端文件
1. `backend/src/routes/valueAdded.ts`
   - 修复批量搜索的SQL参数绑定
   - 增强设置默认公司接口支持取消默认
   - 优化更新订单公司接口支持"待分配"
   - 删除重复的路由定义

## 测试验证

### 1. 统计数据测试
```bash
node backend/test-stats-api.js
```
✅ 返回正确的统计数据（4单，¥3600）

### 2. 批量搜索测试
```bash
node backend/test-batch-search.js
```
✅ 成功搜索3条匹配记录

### 3. 状态配置测试
```bash
node backend/test-status-configs.js
```
✅ 返回完整的状态配置列表

## 功能说明

### 外包公司管理
- **设为默认**：新同步的订单自动分配给默认公司
- **取消默认**：取消后新订单显示为"待分配"
- **待分配**：订单未分配给具体公司，使用默认单价900元

### 状态配置
- **有效状态**：待处理、有效、无效、已补单等
- **结算状态**：未结算、已结算等
- 支持自定义添加和删除状态

### 批量搜索
- 支持订单号、客户电话、物流单号、客户姓名
- 支持换行、逗号、分号分隔
- 一次可搜索多个关键词

## 注意事项

1. **默认公司**：同一时间只能有一个默认公司
2. **待分配状态**：companyId为`default-company`，companyName为"待分配"
3. **单价更新**：切换公司时自动更新为该公司的默认单价
4. **状态显示**：列表中显示中文标签，数据库存储英文值

## 部署说明

### 本地环境
- 已自动应用所有修改
- 后端服务已重启
- 前端刷新页面即可看到效果

### 生产环境
1. 部署前端代码更新
2. 部署后端代码更新
3. 重启后端服务
4. 测试所有功能正常

## 完成时间
2026-03-01 16:11
