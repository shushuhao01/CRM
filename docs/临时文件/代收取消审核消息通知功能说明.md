# 代收取消审核消息通知功能说明

## 功能概述

为代收取消申请流程添加了完整的消息通知功能，支持系统内消息推送和第三方渠道通知（钉钉、企业微信等）。

## 消息类型

在系统消息管理中新增了3种代收审核相关的消息类型：

### 1. 代收取消申请（cod_cancel_request）
- **触发时机**：销售人员提交代收取消申请时
- **通知对象**：所有管理员和超级管理员
- **消息优先级**：高
- **消息内容**：
  ```
  📋 代收取消申请待审核
  {申请人} 提交了订单 {订单号} 的代收取消申请，
  原代收金额¥{原金额}，修改后金额¥{新金额}，请及时审核。
  ```
- **跳转链接**：`/finance/cod-application-review`（代收审核页面）

### 2. 代收取消通过（cod_cancel_approved）
- **触发时机**：管理员审核通过代收取消申请时
- **通知对象**：申请人
- **消息优先级**：普通
- **消息内容**：
  ```
  ✅ 代收取消申请已通过
  您的订单 {订单号} 代收取消申请已通过审核，
  审核意见：{审核意见}。代收金额已更新为¥{新金额}。
  ```
- **跳转链接**：`/finance/my-cod-application`（我的申请页面）

### 3. 代收取消拒绝（cod_cancel_rejected）
- **触发时机**：管理员拒绝代收取消申请时
- **通知对象**：申请人
- **消息优先级**：高
- **消息内容**：
  ```
  ❌ 代收取消申请已拒绝
  您的订单 {订单号} 代收取消申请已被拒绝，
  拒绝原因：{拒绝原因}。
  ```
- **跳转链接**：`/finance/my-cod-application`（我的申请页面）

## 技术实现

### 1. 后端实现

#### 消息服务（`backend/src/services/messageService.ts`）
创建了统一的消息服务模块，提供以下功能：
- `sendSystemMessage()` - 发送单条系统消息
- `sendBatchSystemMessages()` - 批量发送系统消息
- 支持WebSocket实时推送
- 自动记录消息发送日志

#### 代收申请路由（`backend/src/routes/codApplication.ts`）
在以下接口中集成了消息通知：

**创建申请接口（POST /create）**
```typescript
// 1. 保存申请
await appRepo.save(application);

// 2. 查询所有审核人员（管理员和超级管理员）
const reviewers = await userRepo.find({
  where: [{ role: 'admin' }, { role: 'super_admin' }]
});

// 3. 批量发送通知
await sendBatchSystemMessages(messages);
```

**审核接口（PUT /review/:id）**
```typescript
// 1. 更新审核状态
await appRepo.save(application);

// 2. 发送审核结果通知给申请人
await sendSystemMessage({
  type: approved ? 'cod_cancel_approved' : 'cod_cancel_rejected',
  targetUserId: application.applicantId,
  ...
});
```

#### 消息类型配置（`backend/src/controllers/MessageController.ts`）
在 `getNotificationOptions()` 方法中添加了代收审核消息类型：
```typescript
// 代收取消审核
{ value: 'cod_cancel_request', label: '代收取消申请', category: '代收审核' },
{ value: 'cod_cancel_approved', label: '代收取消通过', category: '代收审核' },
{ value: 'cod_cancel_rejected', label: '代收取消拒绝', category: '代收审核' }
```

### 2. 前端配置

#### 消息管理页面（`src/views/System/MessageManagement.vue`）
在"通知配置"标签页中，管理员可以：
1. 点击"新增普通配置"按钮
2. 选择通知方式（钉钉、企业微信、邮件等）
3. 在"消息类型"中勾选代收审核相关的消息类型
4. 配置通知对象（全员、指定部门、指定用户）
5. 配置第三方渠道参数（Webhook地址等）

## 使用流程

### 管理员配置通知渠道

1. **进入消息管理**
   - 导航：系统管理 → 消息管理
   - 切换到"通知配置"标签页

2. **创建钉钉通知配置**
   ```
   配置名称：代收审核钉钉通知
   通知方式：钉钉
   消息类型：
     ☑ 代收取消申请
     ☑ 代收取消通过
     ☑ 代收取消拒绝
   Webhook地址：https://oapi.dingtalk.com/robot/send?access_token=xxx
   加签密钥：SEC开头的密钥（可选）
   通知对象：指定部门 → 财务部
   ```

3. **创建企业微信通知配置**
   ```
   配置名称：代收审核企微通知
   通知方式：企业微信
   消息类型：
     ☑ 代收取消申请
     ☑ 代收取消通过
     ☑ 代收取消拒绝
   Webhook地址：https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
   通知对象：指定用户 → 选择财务人员
   ```

4. **启用配置**
   - 创建完成后，确保配置状态为"启用"
   - 可以点击"测试"按钮验证配置是否正确

### 用户接收通知

#### 系统内通知
- 用户登录后，右上角消息图标会显示未读消息数量
- 点击消息图标查看消息列表
- 点击消息可跳转到相关页面

#### 第三方渠道通知
- 钉钉：在钉钉群中接收机器人消息
- 企业微信：在企业微信群中接收机器人消息
- 邮件：接收邮件通知
- 短信：接收短信通知

## 消息图标说明

系统使用Emoji图标增强消息的可读性：

- 📋 - 申请提交
- ✅ - 审核通过
- ❌ - 审核拒绝
- 💰 - 金额相关
- 📱 - 系统通知

## 注意事项

1. **消息发送失败不影响业务流程**
   - 如果消息发送失败，申请创建和审核仍然会成功
   - 失败日志会记录在后端控制台

2. **WebSocket实时推送**
   - 系统内消息支持WebSocket实时推送
   - 用户无需刷新页面即可收到新消息

3. **消息优先级**
   - 申请提交：高优先级（需要及时审核）
   - 审核通过：普通优先级
   - 审核拒绝：高优先级（需要申请人关注）

4. **权限控制**
   - 只有管理员和超级管理员会收到申请通知
   - 申请人只会收到自己申请的审核结果通知

## 扩展功能

系统支持以下扩展功能（需在消息管理中配置）：

1. **多渠道通知**
   - 同时配置多个通知渠道
   - 例如：系统通知 + 钉钉 + 邮件

2. **通知规则**
   - 根据部门配置不同的通知方式
   - 根据消息优先级选择通知渠道

3. **消息模板**
   - 自定义消息内容模板
   - 支持变量替换

4. **通知日志**
   - 查看消息发送历史
   - 统计消息发送成功率

## 测试建议

1. **功能测试**
   - 提交代收取消申请，验证管理员是否收到通知
   - 审核通过/拒绝，验证申请人是否收到通知
   - 验证消息内容是否正确
   - 验证跳转链接是否正确

2. **渠道测试**
   - 测试系统内通知
   - 测试钉钉机器人通知
   - 测试企业微信机器人通知
   - 测试邮件通知

3. **异常测试**
   - 消息服务异常时，业务流程是否正常
   - WebSocket断开时，消息是否能正常保存
   - 第三方渠道配置错误时，是否有错误提示

## 相关文件

### 后端
- `backend/src/services/messageService.ts` - 消息服务
- `backend/src/routes/codApplication.ts` - 代收申请路由
- `backend/src/controllers/MessageController.ts` - 消息控制器
- `backend/src/entities/SystemMessage.ts` - 系统消息实体

### 前端
- `src/views/System/MessageManagement.vue` - 消息管理页面
- `src/views/System/components/MessageConfig.vue` - 通知配置组件
- `src/views/Finance/MyCodApplication.vue` - 我的申请页面
- `src/views/Finance/CodApplicationReview.vue` - 代收审核页面

## 更新日志

**2025-02-25**
- ✅ 新增代收取消审核相关的3种消息类型
- ✅ 创建消息服务模块
- ✅ 在代收申请创建接口中集成消息通知
- ✅ 在代收审核接口中集成消息通知
- ✅ 支持系统内消息和第三方渠道通知
- ✅ 支持WebSocket实时推送
