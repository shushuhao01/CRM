# 增值管理状态映射修复

## 问题描述
增值管理列表中，有效状态和结算状态的下拉列表无法正确显示中文标签，所有订单都显示为"待处理"。

## 问题原因
数据库中存在两套状态配置：
1. **订单表中的状态值**：使用英文（`pending`、`valid`、`invalid`、`unsettled`、`settled`）
2. **状态配置表中的value**：部分使用中文（"待处理"、"有效"、"无效"）

这导致订单的状态值无法匹配到状态配置，下拉列表无法正确显示。

## 修复方案

### 1. 删除中文值的状态配置
删除 `value_added_status_configs` 表中 value 为中文的记录：
- 有效状态：删除 value 为 "待处理"、"有效"、"无效"、"已补单" 的记录
- 结算状态：删除 value 为 "待处理"、"已结算"、"未结算" 的记录

### 2. 添加正确的英文值配置
确保状态配置表中有正确的英文值配置：

**有效状态配置：**
- `pending` → "待处理"
- `valid` → "有效"
- `invalid` → "无效"
- `supplemented` → "已补单"

**结算状态配置：**
- `unsettled` → "未结算"
- `settled` → "已结算"

## 执行步骤

### 本地环境（已完成）
```bash
# 1. 检查当前状态
node backend/check-order-status.js

# 2. 删除中文值配置
node backend/fix-status-configs.js

# 3. 恢复正确的英文值配置
node backend/restore-valid-status-configs.js

# 4. 验证修复结果
node backend/check-order-status.js
```

### 生产环境
执行SQL文件：`backend/database-migrations/fix-status-config-values.sql`

在phpMyAdmin中执行：
1. 选择数据库 `crm_production`
2. 点击"SQL"标签
3. 粘贴SQL内容并执行
4. 查看验证结果

## 修复结果

### 修复前
```
订单状态: pending
状态配置: value="待处理" (无法匹配)
显示结果: 下拉列表为空或显示错误
```

### 修复后
```
订单状态: pending
状态配置: value="pending" label="待处理"
显示结果: 下拉列表正确显示"待处理"
```

## 状态值对照表

### 有效状态
| 数据库值 | 显示标签 | 说明 |
|---------|---------|------|
| pending | 待处理 | 新同步的订单默认状态 |
| valid | 有效 | 有效的增值订单 |
| invalid | 无效 | 无效的增值订单 |
| supplemented | 已补单 | 已补单的订单 |

### 结算状态
| 数据库值 | 显示标签 | 说明 |
|---------|---------|------|
| unsettled | 未结算 | 未结算的订单 |
| settled | 已结算 | 已结算的订单 |

## 注意事项

1. **数据一致性**：确保订单表中的状态值与状态配置表中的value值一致
2. **不要混用中英文**：状态配置的value必须使用英文，label使用中文
3. **新增状态**：如需新增状态，必须在状态配置表中先添加配置
4. **删除状态**：删除状态配置前，确保没有订单使用该状态

## 相关文件

### 脚本文件
- `backend/check-order-status.js` - 检查订单状态值
- `backend/fix-status-configs.js` - 删除中文值配置
- `backend/restore-valid-status-configs.js` - 恢复英文值配置

### SQL文件
- `backend/database-migrations/fix-status-config-values.sql` - 生产环境修复SQL

### 前端文件
- `src/views/Finance/ValueAddedManage.vue` - 增值管理页面
- `src/views/Finance/components/ValueAddedConfigDialog.vue` - 状态配置对话框

## 完成时间
2026-03-01 16:30
