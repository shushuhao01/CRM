# 结算报表图表修复

## 修复内容

### 1. 日期格式统一

#### 问题
- 日期显示包含时间戳（如：2026-02-28T16:00:00.000Z）
- 图表X轴显示不规范

#### 修复
- 后端使用 `DATE()` 函数提取日期部分
- 前端格式化函数统一返回 YYYY-MM-DD 格式
- 所有日期显示统一为北京时间的日期部分

```typescript
const formatDate = (dateStr: string) => {
  if (!dateStr) return '-'
  // 只返回日期部分 YYYY-MM-DD
  const date = dateStr.split('T')[0]
  return date
}
```

### 2. 图表显示修复

#### 问题
- 饼图和柱状图不显示
- 图例配置不完整

#### 修复方案

##### 结算趋势分析图
```typescript
{
  tooltip: {
    trigger: 'axis',
    axisPointer: { type: 'cross' }
  },
  legend: {
    data: ['结算订单数', '结算金额', '平均单价']  // ✅ 添加图例
  },
  // ... 其他配置
}
```

##### 有效率趋势图
```typescript
{
  tooltip: {
    trigger: 'axis',
    axisPointer: { type: 'line' }
  },
  legend: {
    data: ['有效率', '结算率']  // ✅ 添加图例
  },
  // ... 其他配置
}
```

##### 状态分布饼图
```typescript
{
  series: [{
    name: '状态分布',
    type: 'pie',
    radius: '60%',
    label: {
      formatter: '{b}\n{c}单\n{d}%'  // ✅ 添加标签格式化
    },
    // ... 其他配置
  }]
}
```

##### 已结算/未结算对比饼图
```typescript
{
  series: [{
    name: '已结算/未结算对比',
    type: 'pie',
    radius: ['40%', '70%'],  // 环形图
    label: {
      show: true,
      formatter: '{b}\n{c}单\n{d}%'  // ✅ 多行显示
    },
    data: [
      {
        name: '已结算',
        value: summary.value.settled.count,
        itemStyle: { color: '#67c23a' }
      },
      {
        name: '未结算',
        value: summary.value.unsettled.count,
        itemStyle: { color: '#e6a23c' }
      }
    ]
  }]
}
```

### 3. 图表内容调整

#### 调整前
- 第一行：结算趋势分析 + 有效率趋势
- 第二行：状态分布 + 有效/无效对比

#### 调整后
- 第一行：结算趋势分析 + 有效率趋势
- 第二行：状态分布 + **已结算/未结算对比**

#### 原因
- 状态分布图已经包含了有效/无效/待处理三种状态
- 有效/无效对比与状态分布重复
- 已结算/未结算对比更符合"结算报表"的主题

## 图表配置对比

### 状态分布图（保留）
- **数据来源**：statusDistribution（有效/无效/待处理）
- **图表类型**：普通饼图
- **半径**：60%
- **颜色**：
  - 有效：绿色 (#67c23a)
  - 无效：红色 (#f56c6c)
  - 待处理：橙色 (#e6a23c)

### 已结算/未结算对比图（新增）
- **数据来源**：summary.settled 和 summary.unsettled
- **图表类型**：环形饼图（Donut Chart）
- **半径**：内圈40%，外圈70%
- **颜色**：
  - 已结算：绿色 (#67c23a)
  - 未结算：橙色 (#e6a23c)

## 数据流程

### 后端返回数据
```typescript
{
  summary: {
    settled: { count: 100, amount: 90000 },
    unsettled: { count: 50, amount: 45000 }
  },
  dailyData: [
    { date: '2026-02-01', count: 10, amount: 9000, avgAmount: 900 }
  ],
  trendData: [
    { date: '2026-02-01', totalCount: 15, validCount: 12, settledCount: 10, validRate: '80.00', settlementRate: '66.67' }
  ],
  statusDistribution: [
    { status: 'valid', count: 80, amount: 72000 },
    { status: 'invalid', count: 20, amount: 18000 },
    { status: 'pending', count: 50, amount: 45000 }
  ]
}
```

### 前端图表渲染
1. **结算趋势分析图**：使用 `dailyData`
2. **有效率趋势图**：使用 `trendData`
3. **状态分布图**：使用 `statusDistribution`
4. **已结算/未结算对比图**：使用 `summary.settled` 和 `summary.unsettled`

## 日期处理说明

### 后端处理
```sql
-- 按日期分组统计
SELECT 
  DATE(order.settlement_date) as date,  -- 提取日期部分
  COUNT(*) as count,
  SUM(order.settlement_amount) as amount,
  AVG(order.settlement_amount) as avgAmount
FROM value_added_orders order
WHERE order.settlement_status = 'settled'
GROUP BY DATE(order.settlement_date)
ORDER BY date ASC
```

### 前端处理
```typescript
// 格式化日期
const formatDate = (dateStr: string) => {
  if (!dateStr) return '-'
  const date = dateStr.split('T')[0]  // 只取日期部分
  return date  // 返回 YYYY-MM-DD
}

// 图表X轴数据
xAxis: {
  type: 'category',
  data: dailyData.value.map(item => item.date)  // ['2026-02-01', '2026-02-02', ...]
}
```

## 测试检查清单

### 日期格式
- [ ] 图表X轴显示格式为 YYYY-MM-DD
- [ ] 表格中的日期列显示格式为 YYYY-MM-DD
- [ ] 没有显示时间戳或时区信息

### 图表显示
- [ ] 结算趋势分析图正常显示（三条曲线）
- [ ] 有效率趋势图正常显示（两条曲线）
- [ ] 状态分布饼图正常显示（三个扇区）
- [ ] 已结算/未结算对比图正常显示（环形图，两个扇区）

### 图例和标签
- [ ] 所有图表的图例正常显示
- [ ] 饼图的标签显示名称、数量和百分比
- [ ] 鼠标悬停显示详细信息

### 数据准确性
- [ ] 图表数据与汇总卡片数据一致
- [ ] 百分比计算正确
- [ ] 日期范围筛选后数据正确更新

## 可能的问题和解决方案

### 问题1：图表不显示
**原因**：数据为空或格式不正确
**解决**：
1. 检查后端API返回的数据结构
2. 在浏览器控制台查看 `dailyData.value`、`trendData.value` 等数据
3. 确保数据不为空数组

### 问题2：饼图显示为空白
**原因**：数据值为0或图表容器尺寸问题
**解决**：
1. 确保 `summary.value.settled.count` 和 `summary.value.unsettled.count` 不全为0
2. 检查 `.chart-container` 的高度是否正确（应为350px）
3. 调用 `chart.resize()` 重新渲染

### 问题3：日期显示为时间戳
**原因**：后端返回的日期包含时间部分
**解决**：
1. 后端使用 `DATE()` 函数提取日期
2. 前端使用 `split('T')[0]` 截取日期部分

## 相关文件

- `src/views/Finance/SettlementReport.vue` - 结算报表页面
- `backend/src/routes/valueAdded.ts` - 后端API
- `docs/临时文件/结算报表布局优化.md` - 布局优化文档
- `docs/临时文件/结算报表全面优化完成.md` - 全面优化文档

## 总结

本次修复主要解决了三个问题：
1. ✅ 统一日期格式为 YYYY-MM-DD（北京时间）
2. ✅ 修复图表显示问题（添加图例和标签配置）
3. ✅ 将第二个饼图从"有效/无效对比"改为"已结算/未结算对比"

修复后的报表更加清晰、专业，符合财务结算报表的需求。
