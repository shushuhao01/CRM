# 价格档位系统 - UI集成完成

## 执行时间
2026-03-01

## 问题描述

用户反馈：添加外包公司的弹窗只有公司基本信息表单，没有价格档位配置功能。用户希望在添加/编辑公司时就能直接配置价格档位，而不是分成两个独立的弹窗操作。

## 解决方案

将价格档位管理功能集成到添加/编辑公司弹窗中，使用标签页（Tabs）组织内容：
- 第一个标签页：基本信息
- 第二个标签页：价格档位

## 实现细节

### 1. 弹窗结构改造

#### 原设计
```
添加公司弹窗（700px宽）
├── 公司基本信息表单
└── 保存/取消按钮

独立的价格档位弹窗（1100px宽）
├── 档位列表
└── 添加/编辑/删除操作
```

#### 新设计
```
添加/编辑公司弹窗（1000px宽）
├── 标签页1：基本信息
│   └── 公司基本信息表单
├── 标签页2：价格档位（新增公司时禁用）
│   ├── 添加档位按钮
│   ├── 档位列表表格
│   └── 编辑/删除操作
└── 保存/取消按钮
```

### 2. 核心功能

#### 新增公司流程
1. 用户点击"添加公司"按钮
2. 弹窗打开，默认显示"基本信息"标签页
3. "价格档位"标签页显示为禁用状态，提示"请先保存公司基本信息后再配置价格档位"
4. 用户填写基本信息并点击"保存"
5. 保存成功后：
   - 弹窗不关闭
   - 自动切换到"价格档位"标签页
   - 标签页变为可用状态
   - 显示提示"添加成功，可以继续配置价格档位"
6. 用户可以继续添加价格档位，或关闭弹窗

#### 编辑公司流程
1. 用户点击公司列表的"编辑"按钮
2. 弹窗打开，默认显示"基本信息"标签页
3. "价格档位"标签页可用，自动加载该公司的档位列表
4. 用户可以在两个标签页之间切换
5. 修改基本信息后点击"保存"，更新成功

#### 快速编辑档位流程
1. 用户点击公司列表的"价格档位"按钮
2. 弹窗打开，直接显示"价格档位"标签页
3. 用户可以直接管理档位，无需先查看基本信息

### 3. 代码变更

#### 新增变量
```typescript
const companyFormTab = ref('basic')  // 弹窗标签页状态
const companyTiers = ref<any[]>([])  // 档位列表
const tiersLoading = ref(false)      // 档位加载状态
const tierDialogVisible = ref(false) // 档位编辑弹窗
const editingTier = ref<any>(null)   // 正在编辑的档位
```

#### 新增方法
```typescript
// 加载公司的价格档位列表
loadCompanyTiers(companyId: string)

// 显示添加档位弹窗
showAddTierDialog()

// 编辑档位
editTier(tier: any)

// 删除档位
deleteTier(tier: any)

// 档位保存成功回调
handleTierSaved()

// 编辑公司价格档位（直接打开档位标签页）
editCompanyTiers(company: OutsourceCompany)
```

#### 修改方法
```typescript
// showAddCompanyDialog - 重置标签页到basic，清空档位列表
// editCompany - 加载公司档位数据
// saveCompany - 新增公司后切换到档位标签页
```

#### 移除内容
- 移除独立的 `CompanyPriceTiersDialog` 组件引用
- 移除 `priceTiersDialogVisible`、`currentCompanyId`、`currentCompanyName` 变量
- 移除 `showPriceTiersDialog` 方法

### 4. UI改进

#### 弹窗宽度调整
- 原：700px（只有表单）
- 新：1000px（容纳表格）

#### 标签页设计
- 使用 `el-tabs` 的 `border-card` 类型
- 档位标签页在新增模式下禁用
- 禁用时显示友好提示信息

#### 档位列表表格
- 显示：排序、档位名称、计价方式、单价/比例、生效时间、优先级、状态
- 操作：编辑、删除
- 表头提示：系统会根据订单日期自动匹配对应档位

#### 视觉优化
- 按单计价：绿色标签，绿色金额
- 按比例计价：橙色标签，橙色百分比
- 启用状态：绿色标签
- 停用状态：灰色标签

### 5. 用户体验优化

#### 流程简化
- 原：添加公司 → 关闭弹窗 → 找到公司 → 点击价格档位 → 配置档位
- 新：添加公司 → 自动切换到档位标签页 → 配置档位

#### 操作便捷性
- 编辑公司时可以同时查看和修改基本信息与档位
- 快速编辑档位：直接打开档位标签页
- 一个弹窗完成所有操作，减少窗口切换

#### 提示信息
- 新增公司时明确提示需要先保存基本信息
- 保存成功后提示可以继续配置档位
- 档位列表顶部显示自动匹配规则说明

## 技术细节

### 标签页状态管理
```typescript
// 避免与主页面的activeTab冲突，使用独立的变量名
const companyFormTab = ref('basic')
```

### 档位数据加载时机
1. 编辑公司时：打开弹窗时加载
2. 新增公司后：保存成功后加载
3. 切换标签页时：不重新加载（已缓存）

### 弹窗关闭逻辑
- 编辑模式：点击保存后关闭弹窗
- 新增模式：保存基本信息后不关闭，允许继续配置档位
- 用户可随时点击取消或关闭按钮

## 文件变更清单

### 修改的文件
- `src/views/Finance/ValueAddedManage.vue`
  - 重构添加/编辑公司弹窗为标签页结构
  - 集成价格档位管理功能
  - 新增档位相关方法
  - 移除独立档位弹窗的引用

### 使用的组件
- `src/views/Finance/components/PriceTierDialog.vue` - 档位添加/编辑表单
- `src/views/Finance/components/ValueAddedConfigDialog.vue` - 状态配置（保留）

### 移除的组件引用
- `src/views/Finance/components/CompanyPriceTiersDialog.vue` - 不再使用独立弹窗

## 测试要点

### 功能测试
- [ ] 新增公司：基本信息保存后能否切换到档位标签页
- [ ] 新增公司：档位标签页是否正确禁用
- [ ] 编辑公司：能否正常加载档位列表
- [ ] 编辑公司：能否在两个标签页间切换
- [ ] 快速编辑档位：点击"价格档位"按钮是否直接打开档位标签页
- [ ] 档位CRUD：添加、编辑、删除档位是否正常
- [ ] 档位列表：排序、状态、计价方式显示是否正确

### UI测试
- [ ] 弹窗宽度是否合适（1000px）
- [ ] 表格列宽是否合理
- [ ] 标签页切换是否流畅
- [ ] 禁用状态提示是否清晰
- [ ] 颜色标识是否符合设计（绿色/橙色/灰色）

### 交互测试
- [ ] 保存基本信息后是否自动切换标签页
- [ ] 新增公司后弹窗是否保持打开
- [ ] 编辑公司后弹窗是否正常关闭
- [ ] 取消按钮是否正常工作
- [ ] 档位保存后列表是否自动刷新

## 诊断结果

所有文件通过TypeScript诊断检查：
- ✅ src/views/Finance/ValueAddedManage.vue
- ✅ src/views/Finance/components/PriceTierDialog.vue

## 总结

成功将价格档位管理功能集成到添加/编辑公司弹窗中，使用标签页组织内容，大幅简化了用户操作流程。用户现在可以在一个弹窗内完成公司基本信息和价格档位的所有配置，无需在多个弹窗间切换。

新增公司时，系统会在保存基本信息后自动切换到档位标签页，引导用户继续配置价格档位。编辑公司时，用户可以灵活地在基本信息和档位配置之间切换。公司列表中的"价格档位"按钮可以直接打开档位标签页，方便快速管理。

整体交互更加流畅，符合用户的操作习惯。
