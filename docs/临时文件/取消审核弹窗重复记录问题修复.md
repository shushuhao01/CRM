# 取消审核弹窗重复记录问题修复

## 问题描述
每次关闭"取消订单审核"弹窗后，再次打开并切换到"已审核"标签页时，会多出一条重复的记录。例如：
- 第一次打开：显示3条记录
- 关闭后再打开：显示4条记录（新增1条重复）
- 再次关闭后打开：显示5条记录（又新增1条重复）

## 问题分析

### 数据流程
1. 打开弹窗 → 调用 `loadCancelAuditOrders()` 加载订单
2. 加载的订单被添加到 `orderList.value` 中
3. `auditedCancelOrders` 是从 `orderList.value` 中过滤出来的计算属性
4. 关闭弹窗 → `orderList.value` 中的订单没有被清理
5. 再次打开弹窗 → 又加载一次订单，添加到 `orderList.value`
6. 结果：同一个订单在 `orderList.value` 中出现多次

### 原来的过滤逻辑（有问题）
```typescript
// 🔥 更新 orderList：移除旧的取消申请订单，添加新加载的
orderList.value = orderList.value.filter(order =>
  order.status !== 'pending_cancel' &&
  order.status !== 'cancelled' &&
  order.status !== 'cancel_failed'
)

// 添加新加载的订单
orderList.value.push(...pendingOrders, ...auditedOrders)
```

**问题**：
- 这个逻辑只是按状态过滤，移除所有取消相关的订单
- 但如果 `orderList` 中已经有这些订单（从上次打开弹窗时添加的），它们会被移除
- 然后后端又返回同样的订单，再次添加进去
- 如果后端返回的订单数量增加了（比如又审核了一次），就会累积重复

### 根本原因
**没有按订单ID去重**！应该检查订单ID是否已存在，而不是简单地按状态过滤。

## 修复方案

### 修改前端过滤逻辑

**文件**: `src/views/Order/List.vue`

**修改后的逻辑**:
```typescript
// 解析已审核订单数据
let auditedOrders: any[] = []
if (auditedResponse) {
  if (Array.isArray(auditedResponse)) {
    auditedOrders = auditedResponse
  } else if (auditedResponse.data && Array.isArray(auditedResponse.data)) {
    auditedOrders = auditedResponse.data
  }
}

// 🔥 修复：先移除旧的取消申请订单，然后添加新加载的
// 收集所有新加载订单的ID
const newOrderIds = new Set([
  ...pendingOrders.map(o => o.id),
  ...auditedOrders.map(o => o.id)
])

// 移除 orderList 中已存在的这些订单（避免重复）
orderList.value = orderList.value.filter(order => !newOrderIds.has(order.id))

// 添加新加载的订单
orderList.value.push(...pendingOrders, ...auditedOrders)
```

### 修复原理
1. **收集新订单ID**：把本次加载的所有订单ID放入 `Set` 中
2. **按ID过滤**：从 `orderList` 中移除所有ID在 `newOrderIds` 中的订单
3. **添加新订单**：把本次加载的订单添加到 `orderList`

这样可以确保：
- 每个订单在 `orderList` 中只出现一次
- 如果订单状态更新了（比如从 `pending_cancel` 变为 `cancelled`），会用新数据替换旧数据
- 不会出现重复记录

## 验证步骤

### 1. 测试重复打开弹窗
1. 打开"取消订单审核"弹窗
2. 切换到"已审核"标签页，记录订单数量（假设是3条）
3. 关闭弹窗
4. 再次打开弹窗，切换到"已审核"标签页
5. 检查订单数量，应该还是3条（不会变成4条）

### 2. 测试审核后的更新
1. 打开弹窗，在"待审核"标签页审核一个订单
2. 切换到"已审核"标签页，应该看到新审核的订单
3. 关闭弹窗
4. 再次打开弹窗，切换到"已审核"标签页
5. 检查订单数量，应该正确显示（不会重复）

### 3. 测试订单状态更新
1. 审核拒绝一个订单（状态变为 `cancel_failed`）
2. 关闭弹窗
3. 员工重新提交取消申请（状态变为 `pending_cancel`）
4. 再次打开弹窗
5. 在"待审核"标签页应该看到该订单
6. 在"已审核"标签页不应该看到该订单（因为状态已变）

## 预期结果
- 每次打开弹窗，订单数量保持正确，不会累积重复
- 订单状态更新后，会正确显示在对应的标签页
- 关闭弹窗后再打开，数据保持一致

## 技术细节

### 为什么使用 Set？
- `Set` 可以快速判断元素是否存在（O(1) 时间复杂度）
- 避免重复的订单ID

### 为什么不直接清空 orderList？
- `orderList` 中可能还有其他状态的订单（比如正常的订单列表）
- 只需要移除取消审核相关的订单，保留其他订单

### 为什么不在关闭弹窗时清理？
- 可以在关闭时清理，但这样每次打开都要重新加载
- 当前方案更灵活，支持订单状态的实时更新

## 部署说明
- 修改文件：`src/views/Order/List.vue`
- 前端修改，无需重启后端
- 刷新浏览器页面即可生效

## 相关文件
- `src/views/Order/List.vue` - 订单列表页面（已修改）
- `docs/临时文件/订单取消审核重复记录问题修复说明.md` - 后端状态修复说明
- `docs/临时文件/订单取消申请时间格式修复说明.md` - 时间格式修复说明
