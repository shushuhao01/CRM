# 停用公司过滤功能实现

## 实现时间
2026-03-01

## 需求说明
停用的外包公司不应该出现在以下位置的下拉选择中：
1. 订单列表的"外包公司"列下拉选择
2. 批量选择公司的下拉菜单
3. 筛选器中的"外包公司"下拉选择

## 实现方案

### 1. 添加计算属性过滤启用状态的公司

在 `src/views/Finance/ValueAddedManage.vue` 中添加计算属性：

```typescript
// 外包公司
const companies = ref<OutsourceCompany[]>([])

// 🔥 计算属性：只返回启用状态的公司（用于下拉选择）
const activeCompanies = computed(() => {
  return companies.value.filter(c => c.status === 'active')
})
```

### 2. 更新订单列表中的公司下拉选择

将 `companies` 替换为 `activeCompanies`：

```vue
<el-table-column prop="companyName" label="外包公司" width="150">
  <template #default="{ row }">
    <el-select
      v-model="row.companyId"
      size="small"
      placeholder="选择公司"
      @change="(val: string) => updateOrderCompany(row, val)"
    >
      <el-option label="待分配" value="default-company" />
      <el-option v-for="company in activeCompanies" :key="company.id" :label="company.companyName" :value="company.id" />
    </el-select>
  </template>
</el-table-column>
```

### 3. 更新批量选择公司的下拉菜单

```vue
<el-dropdown @command="handleBatchCompany">
  <el-button type="primary">
    批量选择公司 <el-icon class="el-icon--right"><ArrowDown /></el-icon>
  </el-button>
  <template #dropdown>
    <el-dropdown-menu>
      <el-dropdown-item command="default-company">待分配</el-dropdown-item>
      <el-dropdown-item v-for="company in activeCompanies" :key="company.id" :command="company.id">
        {{ company.companyName }}
      </el-dropdown-item>
    </el-dropdown-menu>
  </template>
</el-dropdown>
```

### 4. 更新筛选器中的公司下拉选择

```vue
<el-select v-model="companyFilter" placeholder="外包公司" clearable @change="handleSearch" class="filter-item">
  <el-option label="全部公司" value="" />
  <el-option v-for="company in activeCompanies" :key="company.id" :label="company.companyName" :value="company.id" />
</el-select>
```

## 技术实现

### 计算属性的优势
1. **响应式更新**：当公司状态改变时，下拉列表自动更新
2. **性能优化**：Vue会缓存计算结果，只在依赖变化时重新计算
3. **代码复用**：一个计算属性可以在多个地方使用

### 过滤逻辑
```typescript
const activeCompanies = computed(() => {
  return companies.value.filter(c => c.status === 'active')
})
```

只返回 `status === 'active'` 的公司，停用状态（`status === 'inactive'`）的公司会被过滤掉。

## 业务规则

### 1. 停用公司的影响范围
- ✅ 不出现在新订单的公司选择中
- ✅ 不出现在批量分配公司的选项中
- ✅ 不出现在筛选器的公司选项中
- ✅ 已分配给该公司的订单不受影响（保持原有分配）

### 2. 已分配订单的处理
- 如果订单已经分配给某个公司，即使该公司后来被停用，订单仍然保持原有分配
- 订单列表中会显示该公司名称（即使公司已停用）
- 可以将订单重新分配给其他启用的公司

### 3. 公司管理弹窗
- 公司管理弹窗中显示所有公司（包括停用的）
- 可以查看停用公司的统计数据
- 可以重新启用已停用的公司

## 用户体验

### 停用公司的操作流程
1. 在公司管理弹窗中点击"停用"按钮
2. 公司状态变为"停用"
3. 该公司立即从所有下拉选择中消失
4. 已分配给该公司的订单不受影响

### 重新启用公司
1. 在公司管理弹窗中找到停用的公司
2. 点击"启用"按钮
3. 公司状态变为"启用"
4. 该公司重新出现在所有下拉选择中

## 测试要点

1. ✅ 停用公司后，订单列表的公司下拉中不显示该公司
2. ✅ 停用公司后，批量选择公司的下拉中不显示该公司
3. ✅ 停用公司后，筛选器的公司下拉中不显示该公司
4. ✅ 已分配给停用公司的订单仍然显示该公司名称
5. ✅ 可以将已分配给停用公司的订单重新分配给其他公司
6. ✅ 重新启用公司后，该公司重新出现在所有下拉选择中
7. ✅ 公司管理弹窗中显示所有公司（包括停用的）

## 注意事项

1. **数据一致性**：停用公司不会删除或修改已有订单的分配关系
2. **权限控制**：确保只有有权限的用户才能停用/启用公司
3. **统计数据**：停用公司的统计数据仍然保留和显示
4. **默认公司**：如果默认公司被停用，需要先取消默认状态才能停用

## 相关文件

- `src/views/Finance/ValueAddedManage.vue` - 主视图文件

## 后续优化建议

1. 考虑添加"显示停用公司"的开关，让用户可以选择是否在下拉中显示停用的公司
2. 在停用公司时，如果该公司是默认公司，自动提示用户先设置其他公司为默认
3. 添加批量启用/停用公司的功能
4. 在公司列表中添加"停用"状态的筛选器
