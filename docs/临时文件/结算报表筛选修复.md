# 结算报表筛选修复

## 修复时间
2026-03-01

## 问题描述

用户反馈结算报表页面的汇总卡片、图表和公司排名表格没有根据筛选条件动态更新。

## 根本原因

后端API存在两个问题：

### 问题1：按公司分组统计缺少筛选条件
按公司分组统计时，创建了新的查询构建器，但没有应用日期和公司筛选条件，导致始终返回所有已结算订单的统计数据。

```typescript
// ❌ 错误代码
const companyData = await orderRepo
  .createQueryBuilder('order')
  .select('order.company_id', 'companyId')
  .addSelect('order.company_name', 'companyName')
  .addSelect('COUNT(*)', 'count')
  .addSelect('SUM(order.settlement_amount)', 'amount')
  .where('order.settlement_status = :status', { status: 'settled' })
  // ⚠️ 缺少日期筛选和公司筛选
  .groupBy('order.company_id')
  .addGroupBy('order.company_name')
  .orderBy('amount', 'DESC')
  .getRawMany();
```

### 问题2：日期范围不完整
结束日期没有加上时间部分，导致不包含结束日期当天的数据。

```typescript
// ❌ 错误代码
queryBuilder.where('order.settlement_date BETWEEN :startDate AND :endDate', {
  startDate: new Date(startDate as string),
  endDate: new Date(endDate as string) // 缺少 23:59:59
});
```

## 修复方案

### 1. 统一查询条件构建

创建 `buildBaseQuery` 函数，统一构建基础查询条件：

```typescript
const buildBaseQuery = () => {
  const qb = orderRepo.createQueryBuilder('order');
  
  // 只统计已结算的订单
  qb.where('order.settlement_status = :status', { status: 'settled' });
  
  // 日期筛选（按结算日期）
  if (startDate && endDate) {
    qb.andWhere('order.settlement_date BETWEEN :startDate AND :endDate', {
      startDate: new Date(startDate as string),
      endDate: new Date(endDate as string + ' 23:59:59') // 🔥 包含结束日期当天
    });
  }
  
  // 公司筛选
  if (companyId) {
    qb.andWhere('order.company_id = :companyId', { companyId });
  }
  
  return qb;
};
```

### 2. 应用统一查询条件

按日期分组和按公司分组都使用相同的基础查询条件：

```typescript
// 按日期分组统计
const dailyData = await buildBaseQuery()
  .select('DATE(order.settlement_date)', 'date')
  .addSelect('COUNT(*)', 'count')
  .addSelect('SUM(order.settlement_amount)', 'amount')
  .groupBy('DATE(order.settlement_date)')
  .orderBy('date', 'ASC')
  .getRawMany();

// 按公司分组统计
const companyData = await buildBaseQuery()
  .select('order.company_id', 'companyId')
  .addSelect('order.company_name', 'companyName')
  .addSelect('COUNT(*)', 'count')
  .addSelect('SUM(order.settlement_amount)', 'amount')
  .groupBy('order.company_id')
  .addGroupBy('order.company_name')
  .orderBy('amount', 'DESC')
  .getRawMany();
```

## 业务逻辑说明

### 结算报表使用结算日期

结算报表与增值管理主页面不同：
- **增值管理**：按**下单日期**筛选（查看某时间段内产生的订单）
- **结算报表**：按**结算日期**筛选（查看某时间段内结算的订单）

### 为什么使用结算日期？

1. **业务需求**：财务需要查看某个时间段内完成结算的订单
2. **对账需求**：按结算日期统计便于与财务账目对账
3. **报表准确性**：只统计已结算的订单，金额准确可靠

### 示例说明

假设有以下订单：
- 订单A：2025-01-15下单，2025-02-01结算
- 订单B：2025-01-20下单，2025-02-05结算
- 订单C：2025-02-10下单，2025-02-15结算

用户在结算报表选择"2025年2月"：
- ✅ **正确结果**：显示订单A、B、C（都在2月结算）
- ❌ **错误结果**：只显示订单C（只有C在2月下单）

## 修复效果

### 修复前
- 选择日期范围，汇总卡片显示所有已结算订单的统计
- 图表显示所有已结算订单的趋势
- 公司排名显示所有已结算订单的公司统计
- 筛选条件不生效

### 修复后
- ✅ 选择日期范围，汇总卡片只显示该日期范围内结算的订单统计
- ✅ 图表只显示该日期范围内的结算趋势
- ✅ 公司排名只显示该日期范围内的公司结算统计
- ✅ 选择公司筛选，所有数据只显示该公司的统计
- ✅ 筛选条件完全生效

## 数据流程

```
用户选择筛选条件
  ↓
前端调用 GET /value-added/settlement-report
  ↓
后端构建基础查询条件
  ├─ 只查询已结算订单 (settlement_status = 'settled')
  ├─ 按结算日期筛选 (settlement_date BETWEEN startDate AND endDate)
  └─ 按公司筛选 (company_id = companyId)
  ↓
执行两个查询
  ├─ 按日期分组统计 → dailyData（用于趋势图）
  └─ 按公司分组统计 → companyData（用于饼图和排名表）
  ↓
返回数据给前端
  ↓
前端更新
  ├─ 汇总卡片（总订单数、总金额、平均单价）
  ├─ 结算趋势图
  ├─ 公司结算占比饼图
  └─ 公司排名表格
```

## 测试场景

### 场景1：选择本月
1. 点击"本月"快捷按钮
2. **验证点**：
   - 汇总卡片显示本月结算的订单统计
   - 趋势图显示本月每天的结算数据
   - 饼图显示本月各公司的结算占比
   - 排名表显示本月各公司的结算排名

### 场景2：选择自定义日期
1. 选择日期范围：2025-12-01 至 2025-12-31
2. **验证点**：
   - 所有数据只显示2025年12月结算的订单
   - 数据与选择的日期范围一致

### 场景3：选择公司筛选
1. 选择"本月" + "公司A"
2. **验证点**：
   - 所有数据只显示公司A在本月结算的订单
   - 饼图只显示公司A
   - 排名表只显示公司A

### 场景4：快捷日期切换
1. 依次点击"今日"、"本月"、"上月"
2. **验证点**：
   - 每次切换后数据立即更新
   - 数据与选择的日期范围一致

## 注意事项

1. **结算日期可能为空**：未结算的订单 `settlement_date` 为 NULL，不会出现在结算报表中
2. **时区问题**：确保前后端使用相同的时区
3. **日期格式**：前端传递 `YYYY-MM-DD` 格式，后端自动加上时间部分
4. **数据一致性**：汇总卡片、图表、排名表使用相同的查询条件

## 相关文件

- `backend/src/routes/valueAdded.ts` - 后端路由（结算报表API）
- `src/views/Finance/SettlementReport.vue` - 前端结算报表页面
- `src/api/valueAdded.ts` - API接口定义

## 与增值管理的区别

| 功能 | 增值管理 | 结算报表 |
|------|---------|---------|
| 筛选字段 | `order_date`（下单日期） | `settlement_date`（结算日期） |
| 数据范围 | 所有订单（包括未结算） | 只显示已结算订单 |
| 业务目的 | 查看订单产生情况 | 查看结算完成情况 |
| 金额字段 | `unit_price`（单价） | `settlement_amount`（结算金额） |

## 总结

通过统一查询条件构建和修复日期范围，结算报表现在可以正确响应筛选条件：
- ✅ 日期筛选正确应用到所有统计
- ✅ 公司筛选正确应用到所有统计
- ✅ 汇总卡片、图表、排名表数据一致
- ✅ 按结算日期筛选，符合财务对账需求
