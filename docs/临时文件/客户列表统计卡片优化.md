# 客户列表统计卡片优化

## 修改时间
2026-02-27

## 修改内容

### 1. 统计指标调整
将客户列表页面顶部的4个统计卡片指标调整为:
- **总客户数**: 根据筛选条件统计的客户总数
- **当月客户数**: 本月创建的客户数量(替换原"活跃客户")
- **今日新增**: 今天新增的客户数量(保持不变)
- **未下单客户数**: 订单数量为0的客户数量(替换原"高价值客户")

### 2. 后端API修改

**文件**: `backend/src/routes/customers.ts`

#### 修改点1: 统计逻辑调整
```typescript
// 获取今日日期和本月日期范围
const today = new Date();
const todayStr = today.toISOString().split('T')[0];
const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
const currentMonthStartStr = currentMonthStart.toISOString().split('T')[0];

// 获取订单仓库，用于统计
const orderRepository = AppDataSource.getRepository(Order);

// 统计总数（筛选后的）
const totalCustomers = await statsQueryBuilder.getCount();

// 统计当月客户数（本月创建的客户）
const monthCustomers = await statsQueryBuilder.clone()
  .andWhere('customer.createdAt >= :monthStart', { monthStart: `${currentMonthStartStr} 00:00:00` })
  .getCount();

// 统计今日新增客户数
const newCustomers = await statsQueryBuilder.clone()
  .andWhere('DATE(customer.createdAt) = :today', { today: todayStr })
  .getCount();

// 统计未下单客户数（订单数量为0的客户）
const customersWithOrders = await orderRepository
  .createQueryBuilder('order')
  .select('DISTINCT order.customerId', 'customerId')
  .getRawMany();
const customerIdsWithOrders = customersWithOrders.map(item => item.customerId);

// 获取所有符合筛选条件的客户ID
const allFilteredCustomers = await statsQueryBuilder.clone()
  .select('customer.id')
  .getRawMany();
const allFilteredCustomerIds = allFilteredCustomers.map(item => item.customer_id);

// 计算未下单客户数
const noOrderCustomers = allFilteredCustomerIds.filter(id => !customerIdsWithOrders.includes(id)).length;
```

#### 修改点2: 返回数据结构调整
```typescript
statistics: {
  totalCustomers,      // 总客户数
  monthCustomers,      // 当月客户数
  newCustomers,        // 今日新增
  noOrderCustomers     // 未下单客户数
}
```

### 3. 前端页面修改

**文件**: `src/views/Customer/List.vue`

#### 修改点1: 导入新图标
```typescript
import { Plus, Download, Refresh, User, UserFilled, Star, Search, Setting, Calendar, WarningFilled } from '@element-plus/icons-vue'
```

#### 修改点2: 统计数据结构调整
```typescript
const summaryData = reactive({
  totalCustomers: 0,
  monthCustomers: 0,      // 替换 activeCustomers
  newCustomers: 0,
  noOrderCustomers: 0     // 替换 highValueCustomers
})
```

#### 修改点3: 模板更新
```vue
<el-card class="summary-card">
  <div class="card-content">
    <div class="card-icon month">
      <el-icon><Calendar /></el-icon>
    </div>
    <div class="card-info">
      <div class="card-value">{{ summaryData.monthCustomers }}</div>
      <div class="card-label">当月客户数</div>
    </div>
  </div>
</el-card>

<el-card class="summary-card">
  <div class="card-content">
    <div class="card-icon no-order">
      <el-icon><WarningFilled /></el-icon>
    </div>
    <div class="card-info">
      <div class="card-value">{{ summaryData.noOrderCustomers }}</div>
      <div class="card-label">未下单客户数</div>
    </div>
  </div>
</el-card>
```

#### 修改点4: 样式调整
```css
.card-icon.month {
  background: #67c23a;  /* 绿色 - 当月客户 */
}

.card-icon.no-order {
  background: #f56c6c;  /* 红色 - 未下单客户 */
}
```

#### 修改点5: 数据加载逻辑更新
```typescript
// 更新统计数据（使用后端返回的统计数据）
if (statistics) {
  summaryData.totalCustomers = statistics.totalCustomers || 0
  summaryData.monthCustomers = statistics.monthCustomers || 0
  summaryData.newCustomers = statistics.newCustomers || 0
  summaryData.noOrderCustomers = statistics.noOrderCustomers || 0
}
```

## 功能特点

1. **动态更新**: 统计数据根据筛选条件(日期范围、客户等级、状态等)动态更新
2. **后端计算**: 所有统计数据由后端API计算返回,确保数据准确性
3. **权限控制**: 统计数据遵循用户权限,不同角色看到不同范围的统计
4. **性能优化**: 使用数据库查询优化,避免前端大量计算

## 测试要点

1. 验证总客户数是否正确
2. 验证当月客户数是否只统计本月创建的客户
3. 验证今日新增是否只统计今天创建的客户
4. 验证未下单客户数是否正确(订单数为0)
5. 验证筛选条件改变时,统计数据是否正确更新
6. 验证不同角色用户看到的统计数据是否符合权限范围

## 注意事项

1. 未下单客户数的计算需要关联订单表,可能影响性能,已使用优化的查询方式
2. 统计数据基于筛选条件,当用户应用筛选时,统计数据会相应变化
3. 所有统计都遵循用户的数据权限范围
