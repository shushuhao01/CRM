# 角色类型和恢复默认功能修复说明

## 问题描述

### 问题1：自定义角色点击"恢复默认"提示错误
- **现象**：自定义角色点击"恢复默认"按钮时，提示"该角色为管理员角色，拥有所有权限"
- **原因**：`resetToDefaultPermissions` 函数没有判断角色是否为系统预设角色
- **影响**：自定义角色无法使用"恢复默认"功能

### 问题2：系统预设角色的类型可以修改
- **现象**：5个系统预设角色（超级管理员、管理员、经理、销售员、客服）的角色类型下拉框可以修改
- **原因**：角色类型下拉框的 `disabled` 属性只判断了 `canEditRole`，没有判断是否为系统预设角色
- **影响**：系统预设角色的类型可能被误修改，导致权限管理混乱

## 修复方案

### 修复1：限制"恢复默认"功能仅对系统预设角色生效

修改 `resetToDefaultPermissions` 函数，增加系统预设角色判断：

```javascript
const resetToDefaultPermissions = () => {
  if (!currentRole.value) {
    ElMessage.warning('未选择角色')
    return
  }

  // 🔥 检查是否为系统预设角色
  const isSystemRole = SYSTEM_PRESET_ROLES.includes(currentRole.value.code)
  
  if (!isSystemRole) {
    ElMessage.warning('只有系统预设角色才能恢复默认权限配置')
    return
  }

  // ... 后续逻辑
}
```

**逻辑说明**：
- 只有系统预设角色（`super_admin`, `admin`, `department_manager`, `sales_staff`, `customer_service`）才能使用"恢复默认"功能
- 自定义角色点击"恢复默认"时，提示"只有系统预设角色才能恢复默认权限配置"
- 这样可以避免自定义角色误操作，也更符合业务逻辑

### 修复2：禁止修改系统预设角色的类型

修改角色类型下拉框的 `disabled` 属性：

```vue
<el-select
  v-model="row.roleType"
  size="small"
  @change="handleRoleTypeChange(row)"
  :disabled="!canEditRole || isSystemPresetRole(row)"
>
```

修改 `handleRoleTypeChange` 函数，增加系统预设角色判断：

```javascript
const handleRoleTypeChange = async (row: RoleData) => {
  // 🔥 防止系统预设角色修改类型
  if (isSystemPresetRole(row)) {
    ElMessage.warning('系统预设角色不可修改类型')
    // 恢复原值
    await loadRoleList()
    return
  }

  // ... 后续逻辑
}
```

**逻辑说明**：
- 系统预设角色的类型下拉框被禁用，无法点击
- 如果通过其他方式触发修改（如API调用），会提示"系统预设角色不可修改类型"并恢复原值
- 自定义角色可以自由修改类型（系统角色、业务角色、临时角色、自定义角色）

### 修复3：确保数据库中系统预设角色的类型正确

创建数据库迁移脚本 `backend/database-migrations/update-system-roles-type.sql`：

```sql
-- 更新系统预设角色的类型为 'system'
UPDATE roles 
SET roleType = 'system'
WHERE code IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
```

**执行方式**：
```bash
# 开发环境
sqlite3 backend/data/crm.db < backend/database-migrations/update-system-roles-type.sql

# 生产环境
sqlite3 /path/to/production/crm.db < backend/database-migrations/update-system-roles-type.sql
```

## 系统预设角色定义

系统中定义了5个系统预设角色，它们的特点是：

| 角色编码 | 角色名称 | 角色类型 | 特殊限制 |
|---------|---------|---------|---------|
| `super_admin` | 超级管理员 | system | 不可删除、不可禁用、不可修改类型 |
| `admin` | 管理员 | system | 不可删除、不可禁用、不可修改类型 |
| `department_manager` | 部门经理 | system | 不可删除、不可修改类型 |
| `sales_staff` | 销售员 | system | 不可删除、不可修改类型 |
| `customer_service` | 客服 | system | 不可删除、不可修改类型 |

**判断逻辑**：

```javascript
// 系统预设角色列表
const SYSTEM_PRESET_ROLES = ['super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service']

// 判断是否为系统预设角色
const isSystemPresetRole = (role: RoleData) => {
  return SYSTEM_PRESET_ROLES.includes(role.code) || role.isSystem === true
}

// 判断是否为不可禁用角色（超级管理员和管理员）
const isNonDisableableRole = (role: RoleData) => {
  return ['super_admin', 'admin'].includes(role.code)
}
```

## 自定义角色特点

自定义角色是管理员创建的角色，它们的特点是：

| 特性 | 说明 |
|-----|------|
| 角色编码 | 不在系统预设角色列表中 |
| 角色类型 | 默认为 `custom`，可以修改为其他类型 |
| 删除 | 可以删除（如果没有用户使用） |
| 禁用 | 可以禁用 |
| 修改类型 | 可以修改 |
| 恢复默认 | 不支持（因为没有默认权限配置） |

## 测试步骤

### 测试1：自定义角色的"恢复默认"功能

1. 创建一个自定义角色（例如：测试角色）
2. 配置一些权限并保存
3. 点击"权限设置"按钮
4. 点击"恢复默认"按钮
5. **预期结果**：提示"只有系统预设角色才能恢复默认权限配置"

### 测试2：系统预设角色的"恢复默认"功能

1. 找到系统预设角色（例如：销售员）
2. 点击"权限设置"按钮
3. 修改一些权限
4. 点击"恢复默认"按钮
5. **预期结果**：
   - 弹出确认对话框："确定要将角色「销售员」的权限恢复为系统默认配置吗？"
   - 点击"确定恢复"后，权限树恢复为默认配置
   - 提示"已恢复为默认权限配置，请点击'保存权限'按钮保存"

### 测试3：系统预设角色的类型修改

1. 找到系统预设角色（例如：销售员）
2. 查看"角色类型"列的下拉框
3. **预期结果**：下拉框被禁用（灰色），无法点击

### 测试4：自定义角色的类型修改

1. 创建一个自定义角色（例如：测试角色）
2. 查看"角色类型"列的下拉框
3. **预期结果**：下拉框可以点击
4. 修改角色类型（例如：从"自定义角色"改为"业务角色"）
5. **预期结果**：提示"角色类型更新成功"，列表刷新后显示新类型

### 测试5：数据库中的角色类型

执行以下SQL查询：

```sql
SELECT id, name, code, roleType, status 
FROM roles 
WHERE code IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
```

**预期结果**：所有系统预设角色的 `roleType` 字段都应该是 `system`

## 相关文件

- `src/views/System/Role.vue` - 角色管理页面
  - `resetToDefaultPermissions` 函数 - 恢复默认权限
  - `handleRoleTypeChange` 函数 - 角色类型修改
  - `isSystemPresetRole` 函数 - 判断是否为系统预设角色
  - `SYSTEM_PRESET_ROLES` 常量 - 系统预设角色列表
- `backend/database-migrations/update-system-roles-type.sql` - 数据库迁移脚本

## 注意事项

1. **数据库迁移**：修复后需要执行数据库迁移脚本，确保系统预设角色的类型正确
2. **权限配置**：系统预设角色的默认权限配置在 `src/config/defaultRolePermissions.ts` 中定义
3. **角色编码**：判断是否为系统预设角色时，使用的是 `role.code` 字段，不是 `role.name`
4. **向后兼容**：如果数据库中没有 `roleType` 字段，需要先添加该字段

## 后续优化建议

1. **角色类型图标**：为不同类型的角色添加不同的图标，方便区分
2. **角色类型说明**：在角色类型下拉框中添加说明文字，帮助用户理解不同类型的含义
3. **权限模板**：为自定义角色提供权限模板功能，方便快速配置权限
4. **角色复制**：支持从系统预设角色复制权限到自定义角色

---

**修复时间**：2026-02-26
**修复人员**：Kiro AI Assistant
**测试状态**：待用户验证
