# 资料列表字段完善说明

## 修改概述

完善资料列表主视图的3个关键字段：签收日期、归属人、操作人，并添加订单状态更新时间追踪功能。

## 一、数据库变更

### 1. 新增字段：`orders.status_updated_at`

**用途**：记录订单状态最后一次变更的时间（如签收、发货、取消等）

**字段定义**：
```sql
`status_updated_at` TIMESTAMP NULL COMMENT '状态更新时间（记录最后一次状态变更的时间）'
```

**索引**：
```sql
INDEX `idx_status_updated_at` (`status_updated_at`)
```

### 2. 数据初始化逻辑

```sql
-- 已签收的订单：使用 delivered_at
UPDATE `orders` 
SET `status_updated_at` = `delivered_at` 
WHERE `delivered_at` IS NOT NULL;

-- 已发货但未签收的订单：使用 shipped_at
UPDATE `orders` 
SET `status_updated_at` = `shipped_at` 
WHERE `shipped_at` IS NOT NULL AND `delivered_at` IS NULL;

-- 其他订单：使用 updated_at
UPDATE `orders` 
SET `status_updated_at` = `updated_at` 
WHERE `status_updated_at` IS NULL;
```

## 二、迁移脚本

### 本地开发环境
文件：`scripts/add-status-updated-time.sql`

执行方式：
```bash
# 方式1：使用 MySQL 命令行
mysql -u root -p crm_local < scripts/add-status-updated-time.sql

# 方式2：使用 PowerShell
Get-Content scripts/add-status-updated-time.sql | mysql -u root -p crm_local
```

### 生产环境
文件：`scripts/production-add-status-updated-time.sql`

**执行步骤**：

1. 登录宝塔面板
2. 进入"数据库"管理
3. 找到 `crm` 数据库，点击"管理"
4. 点击"SQL"标签
5. 复制 `scripts/production-add-status-updated-time.sql` 的内容
6. 粘贴并执行
7. 查看验证结果

**预期结果**：
- 添加字段成功
- 添加索引成功
- 所有订单的 `status_updated_at` 都有值
- 查看示例数据正常

## 三、Schema 文件更新

文件：`database/schema.sql`

**变更位置**：`orders` 表定义（第 315-410 行）

**新增内容**：
```sql
`status_updated_at` TIMESTAMP NULL COMMENT '状态更新时间（记录最后一次状态变更的时间，如签收、发货等）',
```

**新增索引**：
```sql
INDEX `idx_status_updated_at` (`status_updated_at`)
```

## 四、资料列表字段说明

### 1. 签收日期 (`signDate`)

**当前状态**：✅ 已完善

**显示逻辑**：
- 使用 `formatDateTime` 格式化为北京时间
- 格式：`YYYY-MM-DD HH:mm:ss`
- 无签收日期显示 `-`

**数据来源**：
- 目前：从订单的 `delivered_at` 字段获取
- 未来：可以映射到 `status_updated_at` 字段（当状态为已签收时）

**代码位置**：
```vue
<!-- 签收日期列 -->
<template #column-signDate="{ row }">
  {{ row.signDate ? formatDateTime(row.signDate) : '-' }}
</template>
```

### 2. 归属人 (`assigneeName`)

**当前状态**：✅ 已完善

**显示逻辑**：
- 显示当前资料的归属人姓名
- 分配后显示最新的归属人
- 重新分配后自动更新为新的归属人
- 未分配显示 `-`

**代码位置**：
```vue
<!-- 归属人列 -->
<template #column-assigneeName="{ row }">
  {{ row.assigneeName || '-' }}
</template>
```

### 3. 操作人 (`operatorName`)

**当前状态**：✅ 已完善

**显示逻辑**：
- 显示最后操作（分配/封存）的用户姓名
- 记录谁执行了分配操作
- 无操作记录显示 `-`

**代码位置**：
```vue
<!-- 操作人列 -->
<template #column-operatorName="{ row }">
  {{ row.operatorName || '-' }}
</template>
```

### 4. 分配时间 (`assignDate`)

**当前状态**：⚠️ 需要修正

**问题**：
- 当前显示的是下单时间（`orderDate`）而不是分配时间
- 未分配的资料也显示了时间

**应该的逻辑**：
- 已分配：显示分配时间（`assignDate`）
- 未分配：显示 `-`
- 封存/恢复：显示操作时间

**需要修改的代码**：
```vue
<!-- 分配时间列 - 当前（错误） -->
<template #column-assignDate="{ row }">
  {{ row.status === 'pending' ? row.orderDate : (row.assignDate || '-') }}
</template>

<!-- 分配时间列 - 应该改为 -->
<template #column-assignDate="{ row }">
  {{ row.assignDate ? formatDateTime(row.assignDate) : '-' }}
</template>
```

## 五、后续任务

### 1. 更新后端 Order 实体

文件：`backend/src/entities/Order.ts`

添加字段：
```typescript
@Column({ name: 'status_updated_at', type: 'timestamp', nullable: true, comment: '状态更新时间' })
statusUpdatedAt?: Date;
```

### 2. 修改状态更新逻辑

在以下场景自动更新 `status_updated_at`：
- 订单发货时
- 订单签收时
- 订单取消时
- 订单状态变更时

文件位置：
- `backend/src/routes/orders.ts` - 订单状态更新API
- `src/components/Logistics/StatusUpdateDialog.vue` - 状态更新弹窗

### 3. 修正分配时间显示

文件：`src/views/Data/List.vue`

修改分配时间列的模板，使用正确的逻辑。

### 4. 资料分配时记录操作信息

确保在分配资料时正确记录：
- `assignDate`：分配时间
- `operatorId`：操作人ID
- `operatorName`：操作人姓名

## 六、验证清单

### 数据库验证

- [ ] 本地数据库已添加 `status_updated_at` 字段
- [ ] 生产数据库已添加 `status_updated_at` 字段
- [ ] 索引已创建
- [ ] 现有数据已初始化

### 功能验证

- [ ] 签收日期显示正确的北京时间格式
- [ ] 归属人显示当前资料的归属人
- [ ] 操作人显示最后操作的用户
- [ ] 分配时间只在已分配时显示
- [ ] 未分配的资料分配时间显示 `-`

### 代码验证

- [ ] Order 实体已添加 statusUpdatedAt 字段
- [ ] 状态更新时自动记录 status_updated_at
- [ ] 分配时间模板已修正
- [ ] 资料分配逻辑正确记录操作信息

## 七、相关文件

### 数据库脚本
- `scripts/add-status-updated-time.sql` - 本地环境迁移脚本
- `scripts/production-add-status-updated-time.sql` - 生产环境迁移脚本
- `database/schema.sql` - 数据库Schema注册表

### 前端代码
- `src/views/Data/List.vue` - 资料列表主视图
- `src/api/data.ts` - 资料数据类型定义

### 后端代码
- `backend/src/entities/Order.ts` - 订单实体（待更新）
- `backend/src/routes/orders.ts` - 订单路由（待更新）

## 八、注意事项

1. **生产环境执行前备份**：
   - 执行 SQL 前先备份 `orders` 表
   - 建议在业务低峰期执行

2. **执行时间**：
   - 本地环境：已完成
   - 生产环境：待执行

3. **数据一致性**：
   - 确保所有订单的 `status_updated_at` 都有值
   - 验证时间格式正确（北京时间）

4. **性能影响**：
   - 添加索引可能需要几秒钟
   - 更新现有数据根据订单数量而定
   - 建议在业务低峰期执行

## 九、回滚方案

如果需要回滚，执行以下SQL：

```sql
-- 删除索引
ALTER TABLE `orders` DROP INDEX `idx_status_updated_at`;

-- 删除字段
ALTER TABLE `orders` DROP COLUMN `status_updated_at`;
```

## 十、总结

本次修改主要完善了资料列表的数据显示准确性，并为订单状态追踪添加了新的时间字段。通过这些改进，用户可以更清晰地了解：

1. 订单何时签收（签收日期）
2. 资料当前归属谁（归属人）
3. 谁执行了分配操作（操作人）
4. 何时进行的分配（分配时间）

同时，新增的 `status_updated_at` 字段为未来的状态追踪和数据分析提供了基础。
