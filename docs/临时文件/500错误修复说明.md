# 500错误修复说明

## 问题描述

提交代收取消申请时，后端返回500错误（Internal Server Error）。

## 问题原因

`CodCancelApplication` 实体中的 `paymentProof` 字段使用了错误的列类型：

```typescript
// ❌ 错误：simple-json 类型在MySQL中可能导致问题
@Column('simple-json', { nullable: true, name: 'payment_proof' })
paymentProof: string[] | null;
```

`simple-json` 类型是TypeORM的一个特殊类型，它会将数据序列化为字符串存储。但在MySQL中，应该使用原生的 `json` 类型。

## 修复方案

修改实体定义，使用MySQL原生的 `json` 类型：

```typescript
// ✅ 正确：使用MySQL原生json类型
@Column('json', { nullable: true, name: 'payment_proof' })
paymentProof: string[] | null;
```

## 数据库字段类型

MySQL数据库中的字段定义：

```sql
`payment_proof` json DEFAULT NULL COMMENT '尾款凭证（图片URL数组）'
```

## 类型对比

### simple-json
- TypeORM特殊类型
- 存储为字符串（TEXT）
- 需要手动序列化/反序列化
- 可能在某些数据库中出现兼容性问题

### json
- MySQL原生类型
- 直接存储JSON数据
- 数据库层面支持JSON操作
- 更好的性能和兼容性

## 其他改进

### 1. 添加详细的错误日志

```typescript
catch (error: any) {
  console.error('[CodApplication] Create error:', error);
  console.error('[CodApplication] Error stack:', error.stack);
  console.error('[CodApplication] Error message:', error.message);
  res.status(500).json({ success: false, message: '提交申请失败' });
}
```

### 2. 权限检查日志

```typescript
console.log('[CodApplication] 权限检查:', {
  userId: user.id,
  username: user.username,
  userRole: user.role,
  isAdmin,
  orderCreatedBy: order.createdBy,
  canApply: isAdmin || order.createdBy === user.id
});
```

## 测试步骤

### 1. 重启后端服务

```bash
# 停止当前后端进程（Ctrl+C）
# 然后重新启动
cd backend
npm run dev
```

### 2. 清空浏览器缓存

- 按 F12 打开开发者工具
- 右键点击刷新按钮
- 选择"清空缓存并硬性重新加载"

### 3. 重新测试提交申请

1. 登录系统
2. 进入"代收取消申请"页面
3. 点击"发起申请"
4. 选择订单
5. 填写信息并上传图片
6. 点击"提交申请"
7. ✅ 应该能成功提交

### 4. 查看后端日志

提交申请时，后端控制台应该输出：

```
[CodApplication] 权限检查: {
  userId: 'admin',
  username: 'admin',
  userRole: 'admin',
  isAdmin: true,
  orderCreatedBy: 'user_xxx',
  canApply: true
}
```

如果出现错误，会输出详细的错误信息：

```
[CodApplication] Create error: Error: ...
[CodApplication] Error stack: ...
[CodApplication] Error message: ...
```

## 如果还是报错

### 检查1：数据库表是否存在

```sql
SHOW TABLES LIKE 'cod_cancel_applications';
```

如果表不存在，执行：

```bash
cd backend
npm run init:cod-table
```

或手动执行SQL：

```sql
-- 见 backend/cod-application-production.sql
```

### 检查2：数据库字段类型

```sql
DESCRIBE cod_cancel_applications;
```

确认 `payment_proof` 字段类型为 `json`。

### 检查3：数据库连接

确认后端能正常连接到MySQL数据库：

```typescript
// 查看 backend/src/config/database.ts
// 确认数据库配置正确
```

### 检查4：TypeORM同步

如果使用了TypeORM的自动同步功能，可能需要：

1. 删除旧表
2. 重新创建表
3. 或手动修改字段类型

```sql
-- 修改字段类型
ALTER TABLE cod_cancel_applications 
MODIFY COLUMN payment_proof JSON DEFAULT NULL COMMENT '尾款凭证（图片URL数组）';
```

## 相关文件

- `backend/src/entities/CodCancelApplication.ts` - 实体定义（已修复）
- `backend/src/routes/codApplication.ts` - 路由处理（已添加日志）
- `backend/cod-application-production.sql` - 数据库SQL
- `backend/database-schema.sql` - 完整schema

## 注意事项

1. **必须重启后端**：修改实体定义后必须重启后端服务
2. **数据库字段类型**：确保数据库中的字段类型与实体定义一致
3. **JSON数据格式**：paymentProof存储的是字符串数组，例如：`["/uploads/cod-proof/xxx.png"]`

## TypeORM列类型参考

### MySQL支持的列类型

- `int`, `tinyint`, `smallint`, `mediumint`, `bigint`
- `float`, `double`, `decimal`
- `char`, `varchar`, `text`, `mediumtext`, `longtext`
- `date`, `datetime`, `timestamp`, `time`
- `json` - MySQL 5.7.8+
- `enum`, `set`
- `blob`, `mediumblob`, `longblob`

### TypeORM特殊类型

- `simple-array` - 存储为逗号分隔的字符串
- `simple-json` - 存储为JSON字符串（不推荐用于MySQL）
- `simple-enum` - 存储为字符串

## 最佳实践

1. **使用原生类型**：优先使用数据库原生类型
2. **避免特殊类型**：避免使用TypeORM的特殊类型（simple-json, simple-array）
3. **明确指定类型**：在@Column装饰器中明确指定列类型
4. **添加注释**：使用comment选项添加字段说明
