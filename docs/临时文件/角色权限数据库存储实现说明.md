# è§’è‰²æƒé™æ•°æ®åº“å­˜å‚¨å®ç°è¯´æ˜

## ä¿®æ”¹æ—¶é—´
2026-02-26

## é—®é¢˜æè¿°

### åŸé—®é¢˜
åœ¨"ç³»ç»Ÿç®¡ç† â†’ è§’è‰²æƒé™"é¡µé¢ï¼Œç‚¹å‡»æŸä¸ªè§’è‰²çš„"æƒé™è®¾ç½®"æŒ‰é’®æ—¶ï¼š
- æƒé™æ ‘åªå‹¾é€‰äº†ä¸€çº§èœå•ï¼ˆæ¨¡å—ï¼‰
- äºŒçº§èœå•å’Œæ“ä½œæƒé™ï¼ˆæŒ‰é’®æƒé™ï¼‰æ²¡æœ‰é»˜è®¤å‹¾é€‰
- æƒé™æ•°æ®ä¿å­˜åœ¨ localStorageï¼Œè€Œä¸æ˜¯æ•°æ®åº“

### æœŸæœ›æ•ˆæœ
1. æ‰“å¼€æƒé™è®¾ç½®å¼¹çª—æ—¶ï¼Œè‡ªåŠ¨å‹¾é€‰è¯¥è§’è‰²åœ¨æ•°æ®åº“ä¸­çš„æ‰€æœ‰æƒé™ï¼ˆæ¨¡å—ã€èœå•ã€æ“ä½œï¼‰
2. ç®¡ç†å‘˜ä¿®æ”¹æƒé™åï¼Œä¿å­˜åˆ°æ•°æ®åº“
3. ç‚¹å‡»"æ¢å¤é»˜è®¤"æŒ‰é’®ï¼Œæ¢å¤åˆ° `defaultRolePermissions.ts` ä¸­çš„é¢„è®¾æƒé™
4. å¯¹åº”è§’è‰²çš„ç”¨æˆ·ç™»å½•åï¼Œä»æ•°æ®åº“è¯»å–æƒé™

## å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®åº“è¡¨ç»“æ„

#### roles è¡¨å­—æ®µ
```sql
CREATE TABLE `roles` (
  `id` VARCHAR(50) PRIMARY KEY,
  `name` VARCHAR(50) UNIQUE NOT NULL,
  `code` VARCHAR(50) UNIQUE NOT NULL,
  `description` TEXT,
  `status` VARCHAR(20) DEFAULT 'active',
  `level` INT DEFAULT 0,
  `color` VARCHAR(20),
  `data_scope` VARCHAR(20) DEFAULT 'self',
  `permissions` JSON DEFAULT NULL,  -- ğŸ”¥ æƒé™IDæ•°ç»„
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### permissions å­—æ®µè¯´æ˜
- ç±»å‹ï¼šJSON
- å­˜å‚¨å†…å®¹ï¼šæƒé™IDæ•°ç»„ï¼Œä¾‹å¦‚ï¼š`["dashboard.view", "customer.list.view", "order.list.view"]`
- é»˜è®¤å€¼ï¼šNULLï¼ˆè¡¨ç¤ºä½¿ç”¨ defaultRolePermissions.ts ä¸­çš„é¢„è®¾æƒé™ï¼‰

### 2. åç«¯API

#### 2.1 è·å–è§’è‰²æƒé™
```
GET /api/v1/roles/:id/permissions
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "roleId": "3",
    "roleName": "éƒ¨é—¨ç»ç†",
    "permissions": [
      "dashboard.view",
      "customer.list.view",
      "customer.list.export",
      "finance",
      "finance.performance_data",
      "finance.performance_data.view"
    ]
  }
}
```

#### 2.2 æ›´æ–°è§’è‰²æƒé™
```
PUT /api/v1/roles/:id/permissions
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "permissions": [
    "dashboard.view",
    "customer.list.view",
    "finance.performance_data.view"
  ]
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "roleId": "3",
    "roleName": "éƒ¨é—¨ç»ç†",
    "permissions": [...]
  },
  "message": "æƒé™æ›´æ–°æˆåŠŸ"
}
```

### 3. å‰ç«¯å®ç°

#### 3.1 roleApiService æ–°å¢æ–¹æ³•

**æ–‡ä»¶**ï¼š`src/services/roleApiService.ts`

```typescript
/**
 * è·å–è§’è‰²æƒé™
 */
async getRolePermissions(roleId: string): Promise<{
  roleId: string;
  roleName: string;
  permissions: string[];
}> {
  const response = await apiService.get(`/roles/${roleId}/permissions`)
  return response.data
}

/**
 * æ›´æ–°è§’è‰²æƒé™
 */
async updateRolePermissions(roleId: string, permissions: string[]): Promise<{
  roleId: string;
  roleName: string;
  permissions: string[];
}> {
  const response = await apiService.put(`/roles/${roleId}/permissions`, {
    permissions
  })
  return response.data
}
```

#### 3.2 Role.vue ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/views/System/Role.vue`

##### ä¿®æ”¹1ï¼šhandlePermissions å‡½æ•°
```typescript
const handlePermissions = async (row: RoleData) => {
  currentRole.value = row
  
  // ğŸ”¥ ä»æ•°æ®åº“åŠ è½½è§’è‰²æƒé™
  let rolePermissions: string[] = []
  
  try {
    const permissionData = await roleApiService.getRolePermissions(row.id)
    rolePermissions = permissionData.permissions || []
  } catch (error) {
    // å¦‚æœæ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æƒé™
    rolePermissions = getDefaultPermissionsByRole(row.code || row.name)
  }
  
  // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æƒé™ï¼Œä½¿ç”¨é»˜è®¤æƒé™
  if (rolePermissions.length === 0) {
    rolePermissions = getDefaultPermissionsByRole(row.code || row.name)
  }
  
  checkedPermissions.value = rolePermissions
  permissionDialogVisible.value = true
  
  // è®¾ç½®æƒé™æ ‘é€‰ä¸­çŠ¶æ€
  setTimeout(() => {
    if (permissionTreeRef.value) {
      permissionTreeRef.value.setCheckedKeys(rolePermissions)
    }
  }, 1000)
}
```

##### ä¿®æ”¹2ï¼šconfirmPermissions å‡½æ•°
```typescript
const confirmPermissions = async () => {
  try {
    permissionLoading.value = true
    
    const checkedKeys = permissionTreeRef.value?.getCheckedKeys() as string[]
    
    // ğŸ”¥ ä¿å­˜æƒé™åˆ°æ•°æ®åº“
    await roleApiService.updateRolePermissions(currentRole.value.id, checkedKeys || [])
    
    // ä¿å­˜æ•°æ®èŒƒå›´
    await roleApiService.updateRole({
      id: currentRole.value.id,
      dataScope: currentRoleDataScope.value
    })
    
    ElMessage.success('æƒé™è®¾ç½®æˆåŠŸï¼Œå·²ä¿å­˜åˆ°æ•°æ®åº“')
    handlePermissionDialogClose()
    loadRoleList()
  } catch (error) {
    ElMessage.error('æƒé™è®¾ç½®å¤±è´¥')
  } finally {
    permissionLoading.value = false
  }
}
```

##### ä¿®æ”¹3ï¼šresetToDefaultPermissions å‡½æ•°
```typescript
const resetToDefaultPermissions = () => {
  ElMessageBox.confirm(
    `ç¡®å®šè¦å°†è§’è‰²ã€Œ${currentRole.value.name}ã€çš„æƒé™æ¢å¤ä¸ºç³»ç»Ÿé»˜è®¤é…ç½®å—ï¼Ÿ`,
    'æ¢å¤é»˜è®¤æƒé™',
    {
      confirmButtonText: 'ç¡®å®šæ¢å¤',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    }
  ).then(() => {
    // è·å–è¯¥è§’è‰²çš„é»˜è®¤æƒé™
    const defaultPermissions = getDefaultRolePermissions(currentRole.value!.code)
    
    // è®¾ç½®æƒé™æ ‘çš„é€‰ä¸­çŠ¶æ€
    if (permissionTreeRef.value) {
      permissionTreeRef.value.setCheckedKeys(defaultPermissions)
      ElMessage.success('å·²æ¢å¤ä¸ºé»˜è®¤æƒé™é…ç½®ï¼Œè¯·ç‚¹å‡»"ä¿å­˜æƒé™"æŒ‰é’®ä¿å­˜')
    }
  })
}
```

### 4. æƒé™åŠ è½½æµç¨‹

#### 4.1 ç”¨æˆ·ç™»å½•æ—¶
```
ç”¨æˆ·ç™»å½• 
  â†’ åç«¯æŸ¥è¯¢ users è¡¨è·å– role_id
  â†’ åç«¯æŸ¥è¯¢ roles è¡¨è·å– permissions å­—æ®µ
  â†’ å¦‚æœ permissions ä¸º NULLï¼Œä½¿ç”¨ defaultRolePermissions.ts ä¸­çš„é¢„è®¾å€¼
  â†’ è¿”å›æƒé™æ•°ç»„ç»™å‰ç«¯
  â†’ å‰ç«¯å­˜å‚¨åˆ° Pinia store
  â†’ æ ¹æ®æƒé™æ§åˆ¶èœå•æ˜¾ç¤ºã€é¡µé¢è®¿é—®ã€æŒ‰é’®å¯è§æ€§
```

#### 4.2 ç®¡ç†å‘˜ä¿®æ”¹æƒé™æ—¶
```
æ‰“å¼€æƒé™è®¾ç½®å¼¹çª—
  â†’ è°ƒç”¨ GET /api/v1/roles/:id/permissions
  â†’ ä»æ•°æ®åº“è¯»å– permissions å­—æ®µ
  â†’ å¦‚æœä¸º NULLï¼Œä½¿ç”¨é»˜è®¤æƒé™
  â†’ è®¾ç½®æƒé™æ ‘çš„é»˜è®¤å‹¾é€‰çŠ¶æ€

ç®¡ç†å‘˜å‹¾é€‰/å–æ¶ˆå‹¾é€‰æƒé™
  â†’ ç‚¹å‡»"ä¿å­˜æƒé™"æŒ‰é’®
  â†’ è°ƒç”¨ PUT /api/v1/roles/:id/permissions
  â†’ æ›´æ–°æ•°æ®åº“ roles.permissions å­—æ®µ
  â†’ è¯¥è§’è‰²çš„ç”¨æˆ·é‡æ–°ç™»å½•åç”Ÿæ•ˆ
```

#### 4.3 æ¢å¤é»˜è®¤æƒé™æ—¶
```
ç‚¹å‡»"æ¢å¤é»˜è®¤"æŒ‰é’®
  â†’ ä» defaultRolePermissions.ts è¯»å–é¢„è®¾æƒé™
  â†’ è®¾ç½®æƒé™æ ‘çš„é€‰ä¸­çŠ¶æ€
  â†’ ç‚¹å‡»"ä¿å­˜æƒé™"æŒ‰é’®
  â†’ æ›´æ–°æ•°æ®åº“ roles.permissions å­—æ®µ
```

### 5. æ•°æ®åº“è¿ç§»

#### 5.1 æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
```sql
SHOW COLUMNS FROM roles LIKE 'permissions';
```

#### 5.2 æ·»åŠ å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
```sql
ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `permissions` JSON DEFAULT NULL COMMENT 'æƒé™IDæ•°ç»„ï¼ˆJSONæ ¼å¼ï¼‰';

ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `data_scope` VARCHAR(20) DEFAULT 'self' COMMENT 'æ•°æ®èŒƒå›´ï¼šall-å…¨éƒ¨æ•°æ®, department-éƒ¨é—¨æ•°æ®, self-ä¸ªäººæ•°æ®';

ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `status` VARCHAR(20) DEFAULT 'active' COMMENT 'çŠ¶æ€ï¼šactive-å¯ç”¨, inactive-ç¦ç”¨';

ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `level` INT DEFAULT 0 COMMENT 'è§’è‰²çº§åˆ«ï¼Œæ•°å­—è¶Šå°æƒé™è¶Šé«˜';

ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `color` VARCHAR(20) DEFAULT NULL COMMENT 'è§’è‰²é¢œè‰²æ ‡è¯†';
```

#### 5.3 åˆå§‹åŒ–ç°æœ‰è§’è‰²çš„æƒé™
```sql
-- æ›´æ–°ç°æœ‰è§’è‰²çš„ permissions å­—æ®µä¸ºç©ºæ•°ç»„ï¼ˆå¦‚æœä¸ºç©ºï¼‰
UPDATE `roles` SET `permissions` = '[]' WHERE `permissions` IS NULL;
```

### 6. æµ‹è¯•éªŒè¯

#### 6.1 å¼€å‘ç¯å¢ƒæµ‹è¯•
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼š`localStorage.clear()`
2. é‡æ–°ç™»å½•ç³»ç»Ÿ
3. è¿›å…¥"ç³»ç»Ÿç®¡ç† â†’ è§’è‰²æƒé™"
4. ç‚¹å‡»"é”€å”®å‘˜"è§’è‰²çš„"æƒé™è®¾ç½®"æŒ‰é’®
5. éªŒè¯æƒé™æ ‘æ˜¯å¦æ­£ç¡®å‹¾é€‰äº†æ‰€æœ‰å±‚çº§çš„æƒé™
6. ä¿®æ”¹æƒé™åç‚¹å‡»"ä¿å­˜æƒé™"
7. é‡æ–°æ‰“å¼€æƒé™è®¾ç½®å¼¹çª—ï¼ŒéªŒè¯ä¿®æ”¹æ˜¯å¦ä¿å­˜æˆåŠŸ
8. ç‚¹å‡»"æ¢å¤é»˜è®¤"æŒ‰é’®ï¼ŒéªŒè¯æ˜¯å¦æ¢å¤ä¸ºé¢„è®¾æƒé™

#### 6.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. å¤‡ä»½æ•°æ®åº“
2. æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼š`backend/database-migrations/add-permissions-to-roles.sql`
3. éƒ¨ç½²å‰ç«¯å’Œåç«¯ä»£ç 
4. é€šçŸ¥ç”¨æˆ·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–é‡æ–°ç™»å½•
5. éªŒè¯æƒé™åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### 7. æ³¨æ„äº‹é¡¹

#### 7.1 æƒé™IDæ ¼å¼
æƒé™IDå¿…é¡»ä¸ `src/services/permissionService.js` ä¸­çš„ `PERMISSION_TREE` ä¿æŒä¸€è‡´ï¼š
- æ¨¡å—ï¼š`finance`
- å­èœå•ï¼š`finance.performance_data`
- æ“ä½œæƒé™ï¼š`finance.performance_data.view`

#### 7.2 é»˜è®¤æƒé™é…ç½®
`src/config/defaultRolePermissions.ts` ä¸­çš„æƒé™é…ç½®ä½œä¸ºç³»ç»Ÿé¢„è®¾å€¼ï¼š
- æ–°åˆ›å»ºçš„è§’è‰²é»˜è®¤ä½¿ç”¨é¢„è®¾æƒé™
- ç‚¹å‡»"æ¢å¤é»˜è®¤"æŒ‰é’®æ—¶æ¢å¤ä¸ºé¢„è®¾æƒé™
- æ•°æ®åº“ä¸­ `permissions` å­—æ®µä¸º NULL æ—¶ä½¿ç”¨é¢„è®¾æƒé™

#### 7.3 æƒé™ç¼“å­˜
- å‰ç«¯ä¼šå°†æƒé™ç¼“å­˜åˆ° localStorage ä¸­
- ä¿®æ”¹æƒé™åï¼Œç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½çœ‹åˆ°æ–°æƒé™
- å¼€å‘ç¯å¢ƒæµ‹è¯•æ—¶éœ€è¦æ¸…é™¤ localStorage ç¼“å­˜

#### 7.4 æ•°æ®èŒƒå›´
`data_scope` å­—æ®µæ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®çš„æ•°æ®èŒƒå›´ï¼š
- `all`ï¼šå…¨éƒ¨æ•°æ®ï¼ˆè¶…ç®¡ã€ç®¡ç†å‘˜ï¼‰
- `department`ï¼šéƒ¨é—¨æ•°æ®ï¼ˆéƒ¨é—¨ç»ç†ï¼‰
- `self`ï¼šä¸ªäººæ•°æ®ï¼ˆé”€å”®å‘˜ã€å®¢æœï¼‰

### 8. ç›¸å…³æ–‡ä»¶

#### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/services/roleApiService.ts` - æ–°å¢æƒé™APIæ–¹æ³•
2. `src/views/System/Role.vue` - ä¿®æ”¹æƒé™åŠ è½½å’Œä¿å­˜é€»è¾‘
3. `backend/src/controllers/RoleController.ts` - æƒé™APIå®ç°ï¼ˆå·²å­˜åœ¨ï¼‰
4. `backend/src/routes/roles.ts` - æƒé™è·¯ç”±ï¼ˆå·²å­˜åœ¨ï¼‰
5. `backend/src/entities/Role.ts` - Role å®ä½“å®šä¹‰ï¼ˆå·²å­˜åœ¨ï¼‰

#### æ–°å¢çš„æ–‡ä»¶
1. `backend/database-migrations/add-permissions-to-roles.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
2. `docs/ä¸´æ—¶æ–‡ä»¶/è§’è‰²æƒé™æ•°æ®åº“å­˜å‚¨å®ç°è¯´æ˜.md` - æœ¬æ–‡æ¡£

### 9. åç»­ä¼˜åŒ–å»ºè®®

#### 9.1 æƒé™çƒ­æ›´æ–°
å®ç°æƒé™çƒ­æ›´æ–°æœºåˆ¶ï¼Œç”¨æˆ·æ— éœ€é‡æ–°ç™»å½•å³å¯çœ‹åˆ°æ–°æƒé™ï¼š
- ä½¿ç”¨ WebSocket æ¨é€æƒé™å˜æ›´é€šçŸ¥
- å‰ç«¯ç›‘å¬é€šçŸ¥ï¼Œè‡ªåŠ¨åˆ·æ–°æƒé™æ•°æ®

#### 9.2 æƒé™å®¡è®¡æ—¥å¿—
è®°å½•æƒé™å˜æ›´å†å²ï¼š
- è°åœ¨ä»€ä¹ˆæ—¶é—´ä¿®æ”¹äº†å“ªä¸ªè§’è‰²çš„æƒé™
- ä¿®æ”¹å‰åçš„æƒé™å¯¹æ¯”
- ä¾¿äºè¿½æº¯å’Œå®¡è®¡

#### 9.3 æƒé™æ¨¡æ¿
æ”¯æŒåˆ›å»ºæƒé™æ¨¡æ¿ï¼š
- ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå¸¸ç”¨çš„æƒé™ç»„åˆ
- æ–°å»ºè§’è‰²æ—¶å¯ä»¥ä»æ¨¡æ¿å¿«é€Ÿåˆ›å»º

#### 9.4 æƒé™ç»§æ‰¿
æ”¯æŒè§’è‰²æƒé™ç»§æ‰¿ï¼š
- å­è§’è‰²å¯ä»¥ç»§æ‰¿çˆ¶è§’è‰²çš„æƒé™
- å‡å°‘é‡å¤é…ç½®

---

## æ€»ç»“

æœ¬æ¬¡ä¿®æ”¹å®ç°äº†è§’è‰²æƒé™çš„æ•°æ®åº“å­˜å‚¨åŠŸèƒ½ï¼š
1. âœ… æƒé™æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ `roles.permissions` å­—æ®µ
2. âœ… æ‰“å¼€æƒé™è®¾ç½®å¼¹çª—æ—¶ï¼Œä»æ•°æ®åº“åŠ è½½æƒé™å¹¶æ­£ç¡®å‹¾é€‰æ‰€æœ‰å±‚çº§
3. âœ… ç®¡ç†å‘˜ä¿®æ”¹æƒé™åï¼Œä¿å­˜åˆ°æ•°æ®åº“
4. âœ… æ”¯æŒæ¢å¤é»˜è®¤æƒé™
5. âœ… ç”¨æˆ·ç™»å½•æ—¶ä»æ•°æ®åº“è¯»å–æƒé™

æ‰€æœ‰ä¿®æ”¹å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ã€‚

---

> æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2026å¹´2æœˆ26æ—¥
> 
> æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0
