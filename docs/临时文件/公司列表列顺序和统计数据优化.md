# 公司列表列顺序和统计数据优化

## 优化内容

### 1. 调整列顺序 ✅

**优化前**：
```
排序 | 公司名称 | 联系人 | 联系电话 | 单价/比例 | 总订单数 | 有效订单 | 总金额 | 状态 | 操作
```

**优化后**：
```
排序 | 状态 | 公司名称 | 联系人 | 联系电话 | 单价/比例 | 总订单数 | 有效订单 | 总金额 | 操作
```

**改进点**：
- 状态列移到排序后面，更容易快速识别公司状态
- 状态作为重要的筛选维度，放在前面更合理
- 视觉上更容易区分启用和停用的公司

### 2. 确保统计数据正确显示 ✅

**问题**：
- 统计字段可能为 `undefined` 或 `null`
- 显示时会出现空白或 `NaN`

**修复**：
```vue
<!-- 总订单数 -->
<el-table-column prop="totalOrders" label="总订单数" width="100" align="center">
  <template #default="{ row }">{{ row.totalOrders || 0 }}</template>
</el-table-column>

<!-- 有效订单 -->
<el-table-column prop="validOrders" label="有效订单" width="100" align="center">
  <template #default="{ row }">{{ row.validOrders || 0 }}</template>
</el-table-column>

<!-- 总金额 -->
<el-table-column prop="totalAmount" label="总金额" width="120" align="right">
  <template #default="{ row }">¥{{ formatMoney(row.totalAmount || 0) }}</template>
</el-table-column>
```

**改进点**：
- 使用 `|| 0` 确保空值显示为 0
- 金额格式化时也处理空值
- 避免显示 `undefined` 或 `NaN`

### 3. 更新统计数据 ✅

**问题**：
- 数据库中的统计数据与实际订单数据不一致
- 例如：显示总订单=2，但实际只有1个订单

**解决方案**：
创建了两个脚本：

#### 检查脚本：`backend/check-company-stats.js`
```javascript
// 查询公司统计数据
SELECT total_orders, valid_orders, invalid_orders, total_amount, settled_amount
FROM outsource_companies

// 查询实际订单统计
SELECT 
  COUNT(*) as actual_total,
  SUM(CASE WHEN status = 'valid' THEN 1 ELSE 0 END) as actual_valid,
  SUM(CASE WHEN status = 'invalid' THEN 1 ELSE 0 END) as actual_invalid,
  SUM(unit_price) as actual_total_amount,
  SUM(CASE WHEN settlement_status = 'settled' THEN settlement_amount ELSE 0 END) as actual_settled_amount
FROM value_added_orders
WHERE company_id = ?

// 对比并显示差异
```

#### 更新脚本：`backend/update-company-stats.js`
```javascript
// 为每个公司重新计算统计数据
UPDATE outsource_companies
SET 
  total_orders = (SELECT COUNT(*) FROM value_added_orders WHERE company_id = ?),
  valid_orders = (SELECT COUNT(*) FROM value_added_orders WHERE company_id = ? AND status = 'valid'),
  invalid_orders = (SELECT COUNT(*) FROM value_added_orders WHERE company_id = ? AND status = 'invalid'),
  total_amount = (SELECT SUM(unit_price) FROM value_added_orders WHERE company_id = ?),
  settled_amount = (SELECT SUM(settlement_amount) FROM value_added_orders WHERE company_id = ? AND settlement_status = 'settled')
WHERE id = ?
```

**执行结果**：
```
✓ 合谱: 总订单=1, 有效=1, 无效=0, 总金额=900.00, 已结算=0.00
```

## 列定义详解

### 1. 排序列
- **宽度**：70px
- **对齐**：居中
- **用途**：显示公司的排序顺序，用于手动调整公司显示顺序

### 2. 状态列
- **宽度**：80px
- **对齐**：默认（左对齐）
- **显示**：
  - 启用：绿色标签
  - 停用：灰色标签
- **用途**：快速识别公司的启用状态

### 3. 公司名称列
- **宽度**：min-width 150px（自适应）
- **对齐**：默认（左对齐）
- **显示**：
  - 公司名称
  - 默认公司显示绿色"默认"标签
- **用途**：主要识别信息

### 4. 联系人列
- **宽度**：100px
- **对齐**：默认（左对齐）
- **用途**：显示公司联系人姓名

### 5. 联系电话列
- **宽度**：120px
- **对齐**：默认（左对齐）
- **用途**：显示公司联系电话

### 6. 单价/比例列
- **宽度**：130px
- **对齐**：右对齐
- **显示**：
  - 固定单价：¥900.00（绿色，加粗）
  - 比例：5.00%（橙色，加粗）
  - 未配置：未配置（灰色）
- **用途**：显示最高优先级档位的价格

### 7. 总订单数列
- **宽度**：100px
- **对齐**：居中
- **显示**：数字，空值显示 0
- **用途**：显示该公司的总订单数量

### 8. 有效订单列
- **宽度**：100px
- **对齐**：居中
- **显示**：数字，空值显示 0
- **用途**：显示该公司的有效订单数量

### 9. 总金额列
- **宽度**：120px
- **对齐**：右对齐
- **显示**：¥900.00 格式，空值显示 ¥0.00
- **用途**：显示该公司的总金额（所有订单单价之和）

### 10. 操作列
- **宽度**：420px
- **对齐**：默认（左对齐）
- **固定**：右侧固定
- **按钮**：
  1. 设为默认/取消默认
  2. 编辑
  3. 价格档位
  4. 停用/启用
  5. 删除（始终显示，有订单时禁用）

## 统计数据字段说明

### OutsourceCompany 实体字段

```typescript
@Column('int', { default: 0, name: 'total_orders' })
totalOrders: number;  // 总订单数

@Column('int', { default: 0, name: 'valid_orders' })
validOrders: number;  // 有效订单数

@Column('int', { default: 0, name: 'invalid_orders' })
invalidOrders: number;  // 无效订单数

@Column('decimal', { precision: 12, scale: 2, default: 0, name: 'total_amount' })
totalAmount: number;  // 总金额（所有订单单价之和）

@Column('decimal', { precision: 12, scale: 2, default: 0, name: 'settled_amount' })
settledAmount: number;  // 已结算金额
```

### 统计数据更新时机

统计数据在以下情况下会自动更新：

1. **批量处理订单状态**（`batch-process` 接口）
   - 更新有效状态
   - 更新结算状态
   - 标记有效/无效
   - 结算/取消结算

2. **更新函数**：`updateCompanyStats(companyId)`
   ```javascript
   async function updateCompanyStats(companyId: string) {
     const orderRepo = AppDataSource.getRepository(ValueAddedOrder);
     const companyRepo = AppDataSource.getRepository(OutsourceCompany);

     const [totalOrders, validOrders, invalidOrders, totalAmount, settledAmount] = await Promise.all([
       orderRepo.count({ where: { companyId } }),
       orderRepo.count({ where: { companyId, status: 'valid' } }),
       orderRepo.count({ where: { companyId, status: 'invalid' } }),
       orderRepo.createQueryBuilder('order')
         .select('SUM(order.unit_price)', 'total')
         .where('order.company_id = :companyId', { companyId })
         .getRawOne(),
       orderRepo.createQueryBuilder('order')
         .select('SUM(order.settlement_amount)', 'total')
         .where('order.company_id = :companyId AND order.settlement_status = :status', { companyId, status: 'settled' })
         .getRawOne()
     ]);

     await companyRepo.update(companyId, {
       totalOrders,
       validOrders,
       invalidOrders,
       totalAmount: parseFloat(totalAmount?.total || 0),
       settledAmount: parseFloat(settledAmount?.total || 0)
     });
   }
   ```

## 测试验证

### 1. 测试列顺序
1. 打开"外包公司管理"
2. 查看列顺序：排序 → 状态 → 公司名称 → ...
3. 验证状态列在排序后面

### 2. 测试统计数据显示
1. 查看公司列表
2. 验证总订单数、有效订单、总金额都正确显示
3. 新添加的公司应显示 0，而不是空白

### 3. 测试统计数据准确性
1. 运行检查脚本：`node backend/check-company-stats.js`
2. 查看数据库统计与实际订单是否匹配
3. 如果不匹配，运行更新脚本：`node backend/update-company-stats.js`

### 4. 测试统计数据更新
1. 在增值管理中修改订单状态
2. 返回公司列表
3. 验证统计数据已更新

## 相关文件

### 前端文件
- `src/views/Finance/ValueAddedManage.vue` - 公司列表表格

### 后端文件
- `backend/src/entities/OutsourceCompany.ts` - 公司实体类
- `backend/src/routes/valueAdded.ts` - 公司列表接口和统计更新函数
- `backend/check-company-stats.js` - 统计数据检查脚本
- `backend/update-company-stats.js` - 统计数据更新脚本

## 优化效果

### 视觉效果
- ✅ 状态列位置更合理，更容易识别
- ✅ 列顺序更符合逻辑
- ✅ 统计数据显示完整，无空白

### 数据准确性
- ✅ 统计数据与实际订单一致
- ✅ 空值正确处理，显示为 0
- ✅ 金额格式化正确

### 用户体验
- ✅ 快速识别公司状态
- ✅ 统计数据一目了然
- ✅ 数据可信度提高

## 后续建议

### 1. 定时任务
建议添加定时任务，定期校验和更新统计数据：
```javascript
// 每天凌晨2点更新所有公司统计
cron.schedule('0 2 * * *', async () => {
  await updateAllCompanyStats();
});
```

### 2. 实时更新
在订单状态变更时，立即更新公司统计：
```javascript
// 订单状态变更后
await updateCompanyStats(order.companyId);
```

### 3. 缓存优化
对于频繁访问的统计数据，可以考虑使用 Redis 缓存：
```javascript
// 缓存公司统计数据，5分钟过期
await redis.setex(`company:stats:${companyId}`, 300, JSON.stringify(stats));
```

### 4. 统计报表
添加更详细的统计报表：
- 按月统计
- 按季度统计
- 同比环比分析
- 趋势图表

## 总结

本次优化完成了以下工作：
1. ✅ 调整列顺序，状态列移到排序后面
2. ✅ 确保统计数据正确显示，处理空值
3. ✅ 更新数据库中的统计数据，确保准确性
4. ✅ 创建检查和更新脚本，便于维护

公司列表现在更加清晰、准确，用户可以快速了解每个公司的运营情况。
