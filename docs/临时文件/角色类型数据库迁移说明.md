# 角色类型数据库迁移说明

## 执行结果

✅ 本地开发环境（crm_local）已成功执行数据库迁移

### 执行内容

1. ✅ 添加 `roleType` 字段到 `roles` 表
2. ✅ 更新5个系统预设角色的类型为 `system`

### 更新结果

| ID | 角色名称 | 角色编码 | 角色类型 | 状态 |
|----|---------|---------|---------|------|
| super_admin | SuperAdmin | super_admin | system | active |
| admin | 管理员 | admin | system | active |
| department_manager | 部门经理 | department_manager | system | active |
| sales_staff | 销售员 | sales_staff | system | active |
| customer_service | 客服 | customer_service | system | active |

## 生产环境部署

### 方式1：使用 SQL 脚本（推荐）

```bash
# 连接到生产环境数据库
mysql -h <生产环境IP> -u <用户名> -p <数据库名>

# 执行 SQL 脚本
source backend/database-migrations/update-system-roles-type.sql
```

### 方式2：使用 Node.js 脚本

```bash
# 1. 修改生产环境配置文件 backend/.env
DB_TYPE=mysql
DB_HOST=<生产环境IP>
DB_PORT=3306
DB_DATABASE=<数据库名>
DB_USERNAME=<用户名>
DB_PASSWORD=<密码>

# 2. 执行脚本
cd backend
node scripts/update-system-roles-type.js
```

## SQL 脚本内容

```sql
-- 1. 添加 roleType 字段（如果不存在）
ALTER TABLE roles ADD COLUMN IF NOT EXISTS roleType VARCHAR(20) DEFAULT 'custom' AFTER status;

-- 2. 更新系统预设角色的类型为 'system'
UPDATE roles 
SET roleType = 'system'
WHERE code IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');

-- 3. 验证更新结果
SELECT id, name, code, roleType, status 
FROM roles 
WHERE code IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service')
ORDER BY FIELD(code, 'super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
```

## 验证步骤

### 1. 数据库验证

执行以下 SQL 查询：

```sql
SELECT id, name, code, roleType, status FROM roles;
```

**预期结果**：
- 5个系统预设角色的 `roleType` 字段应该是 `system`
- 其他自定义角色的 `roleType` 字段应该是 `custom`

### 2. 前端验证

1. 登录系统
2. 进入"系统管理" -> "角色权限"
3. 查看角色列表的"角色类型"列
4. **预期结果**：
   - 超级管理员、管理员、部门经理、销售员、客服 显示"系统角色"
   - 系统预设角色的类型下拉框被禁用（灰色）
   - 自定义角色的类型下拉框可以修改

### 3. 功能验证

#### 测试1：系统预设角色不可修改类型

1. 找到系统预设角色（例如：销售员）
2. 尝试点击"角色类型"下拉框
3. **预期结果**：下拉框被禁用，无法点击

#### 测试2：自定义角色可以修改类型

1. 创建一个自定义角色
2. 点击"角色类型"下拉框
3. **预期结果**：可以选择不同的类型（系统角色、业务角色、临时角色、自定义角色）

#### 测试3：恢复默认权限功能

1. 找到系统预设角色（例如：销售员）
2. 点击"权限设置"按钮
3. 点击"恢复默认"按钮
4. **预期结果**：弹出确认对话框，点击确定后恢复默认权限

5. 创建一个自定义角色
6. 点击"权限设置"按钮
7. 点击"恢复默认"按钮
8. **预期结果**：提示"只有系统预设角色才能恢复默认权限配置"

## 回滚方案

如果需要回滚，执行以下 SQL：

```sql
-- 删除 roleType 字段
ALTER TABLE roles DROP COLUMN roleType;
```

**注意**：回滚后，前端代码需要同步回滚，否则会出现错误。

## 相关文件

- `backend/database-migrations/update-system-roles-type.sql` - SQL 迁移脚本
- `backend/scripts/update-system-roles-type.js` - Node.js 迁移脚本
- `src/views/System/Role.vue` - 前端角色管理页面
- `docs/临时文件/角色类型和恢复默认功能修复说明.md` - 功能修复说明

## 注意事项

1. **备份数据库**：执行迁移前，请先备份生产环境数据库
2. **测试环境验证**：建议先在测试环境执行，确认无误后再部署到生产环境
3. **前端代码同步**：数据库迁移完成后，需要同步部署前端代码
4. **用户通知**：如果系统正在使用中，建议在低峰期执行迁移

---

**执行时间**：2026-02-26
**执行人员**：Kiro AI Assistant
**执行状态**：✅ 本地开发环境已完成，生产环境待部署
