# 生产环境代收功能部署指南

## 问题根本原因

**生产环境的 `orders` 表缺少以下两个字段：**
1. `cod_amount` - 代收金额（可修改）
2. `cod_modified` - 是否修改过代收金额

这导致：
- 所有订单的代收金额为 NULL 或 0
- 系统无法正确判断订单是否修改过代收
- 发起取消代收申请时获取不到正确的当前代收金额

## 解决方案

### 方案一：执行SQL更新脚本（推荐）

#### 步骤1：备份数据库
```bash
# 在宝塔面板或SSH执行
mysqldump -u root -p 数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 步骤2：上传SQL脚本
将以下文件上传到服务器：
```
backend/sql-backups/add-cod-fields-to-orders.sql
```

#### 步骤3：执行SQL脚本
在宝塔面板 → 数据库 → 管理 → SQL窗口中执行：

```sql
-- 或者直接复制以下内容执行：

-- 1. 添加 cod_amount 字段
ALTER TABLE `orders` 
ADD COLUMN `cod_amount` DECIMAL(10,2) DEFAULT NULL COMMENT '代收金额（可修改）' 
AFTER `deposit_amount`;

-- 2. 添加 cod_modified 字段
ALTER TABLE `orders` 
ADD COLUMN `cod_modified` TINYINT(1) DEFAULT 0 COMMENT '是否修改过代收金额：0-未修改，1-已修改' 
AFTER `cod_amount`;

-- 3. 初始化现有订单的 cod_amount
UPDATE `orders` 
SET `cod_amount` = `total_amount` - IFNULL(`deposit_amount`, 0)
WHERE `cod_amount` IS NULL 
    AND `status` IN ('pending_transfer', 'pending_audit', 'pending_shipment', 'shipped');

-- 4. 初始化已签收订单的 cod_amount
UPDATE `orders` 
SET `cod_amount` = `total_amount` - IFNULL(`deposit_amount`, 0)
WHERE `cod_amount` IS NULL 
    AND `status` IN ('delivered', 'logistics_returned', 'logistics_cancelled', 'package_exception');
```

#### 步骤4：验证结果
执行以下SQL验证：

```sql
-- 检查字段是否添加成功
SHOW COLUMNS FROM orders LIKE '%cod%';

-- 检查数据统计
SELECT 
    COUNT(*) AS '总订单数',
    SUM(CASE WHEN cod_amount IS NULL THEN 1 ELSE 0 END) AS 'cod_amount为NULL',
    SUM(CASE WHEN cod_amount = 0 THEN 1 ELSE 0 END) AS 'cod_amount为0',
    SUM(CASE WHEN cod_amount > 0 THEN 1 ELSE 0 END) AS 'cod_amount大于0',
    SUM(CASE WHEN cod_modified = 1 THEN 1 ELSE 0 END) AS '已修改代收'
FROM `orders`;

-- 查看最近订单
SELECT 
    order_number,
    total_amount,
    deposit_amount,
    cod_amount,
    cod_modified,
    status
FROM `orders` 
ORDER BY created_at DESC 
LIMIT 10;
```

#### 步骤5：重启后端服务
```bash
# SSH执行
pm2 restart crm-backend

# 或在宝塔面板 → PM2管理器 → 重启
```

#### 步骤6：测试功能
1. 创建新订单，检查代收金额是否正确
2. 查看订单列表，确认"已改代收"标识正确
3. 发起取消代收申请，确认当前代收金额正确
4. 在代收管理中查看代收金额是否正确

### 方案二：重新初始化数据库（不推荐，会丢失数据）

如果是测试环境或可以接受数据丢失，可以重新执行：
```bash
# 上传最新的 database-init.sql
# 在数据库管理工具中执行
```

## 预期结果

执行完成后：
- ✅ 未改代收的订单不显示"已改"标识
- ✅ 发起取消代收申请时，当前代收金额正确
- ✅ 代收管理中的代收金额正确
- ✅ 新创建的订单自动计算代收金额

## 常见问题

### Q1：执行SQL时报错"字段已存在"
**A：** 说明字段已经添加过了，跳过添加步骤，直接执行数据初始化：
```sql
UPDATE `orders` 
SET `cod_amount` = `total_amount` - IFNULL(`deposit_amount`, 0)
WHERE `cod_amount` IS NULL OR `cod_amount` = 0;
```

### Q2：执行后部分订单代收金额仍为0
**A：** 检查这些订单的 `total_amount` 和 `deposit_amount` 是否正确：
```sql
SELECT 
    order_number,
    total_amount,
    deposit_amount,
    cod_amount,
    (total_amount - IFNULL(deposit_amount, 0)) AS '应该的代收金额'
FROM `orders` 
WHERE cod_amount = 0 OR cod_amount IS NULL;
```

### Q3：重启服务后仍然有问题
**A：** 检查以下几点：
1. 确认数据库字段已正确添加
2. 确认后端代码已更新到最新版本
3. 清除浏览器缓存并刷新页面
4. 查看后端日志是否有错误

### Q4：开发环境和生产环境数据库结构不一致
**A：** 这是本次问题的根本原因。建议：
1. 使用版本控制管理数据库迁移脚本
2. 每次部署前对比数据库结构差异
3. 建立标准的部署流程和检查清单

## 部署检查清单

部署代收功能时，请确认：

- [ ] 数据库已备份
- [ ] `orders` 表已添加 `cod_amount` 字段
- [ ] `orders` 表已添加 `cod_modified` 字段
- [ ] 现有订单的 `cod_amount` 已初始化
- [ ] `cod_cancel_applications` 表已创建
- [ ] 后端代码已更新并重启
- [ ] 前端代码已构建并部署
- [ ] 功能测试通过

## 后续优化建议

1. **数据库迁移管理**
   - 使用 TypeORM migrations 或类似工具
   - 每次数据库变更都创建迁移脚本
   - 版本控制所有迁移脚本

2. **部署自动化**
   - 编写部署脚本自动执行数据库更新
   - 添加部署前的数据库结构检查
   - 自动备份数据库

3. **监控和告警**
   - 监控关键字段的数据完整性
   - 设置异常数据告警
   - 记录所有数据库变更操作

## 联系支持

如果遇到问题，请提供：
1. 执行 `scripts/diagnose-production-cod-issue.sql` 的完整截图
2. 后端日志（最近100行）
3. 浏览器控制台错误信息
4. 数据库版本和字符集信息
