# 取消订单审核问题排查指南

## 问题现象

员工提交了取消订单申请，管理员也收到了消息通知，但是打开"取消订单申请审核"弹窗时，显示"暂无数据"。

## 问题原因

### 根本原因
之前的代码将取消申请的订单状态设置为 `'pending'`，而不是 `'pending_cancel'`，导致专门的 API 查询不到这些订单。

### 代码问题
```typescript
// 错误的代码（已修复）
order.status = 'pending';  // ❌ 错误

// 正确的代码
order.status = 'pending_cancel';  // ✅ 正确
```

## 排查步骤

### 步骤1：检查数据库中的订单状态

执行以下 SQL 查询：

```sql
-- 查看所有可能的取消申请订单
SELECT 
    id,
    order_number,
    customer_name,
    status,
    remark,
    cancel_reason,
    created_by_name,
    updated_at
FROM orders 
WHERE status = 'pending' 
   OR status = 'pending_cancel'
   OR remark LIKE '%取消原因%'
ORDER BY updated_at DESC
LIMIT 20;
```

**预期结果**：
- 如果 `status = 'pending'` 且 `remark` 包含"取消原因"，说明是旧的取消申请，需要修复
- 如果 `status = 'pending_cancel'`，说明是新的取消申请，状态正确

### 步骤2：检查 API 响应

打开浏览器开发者工具（F12），切换到 Network 标签页，然后：

1. 点击"取消订单申请审核"按钮
2. 查找 `/api/v1/orders/pending-cancel` 请求
3. 查看响应数据

**预期响应**：
```json
{
  "success": true,
  "code": 200,
  "data": [
    {
      "id": "订单ID",
      "orderNumber": "订单号",
      "customerName": "客户姓名",
      "status": "pending_cancel",
      "cancelReason": "客户主动取消",
      ...
    }
  ]
}
```

**如果 `data` 为空数组**：
- 说明数据库中没有 `status = 'pending_cancel'` 的订单
- 需要执行步骤3修复已存在的订单

### 步骤3：修复已存在的取消申请订单

执行以下 SQL 语句：

```sql
-- 1. 先查看需要修复的订单（确认数量）
SELECT 
    COUNT(*) as total,
    GROUP_CONCAT(order_number) as order_numbers
FROM orders 
WHERE status = 'pending' 
  AND (remark LIKE '%取消原因%' OR remark LIKE '%customer_cancel%' OR remark LIKE '%out_of_stock%');

-- 2. 执行修复
UPDATE orders 
SET status = 'pending_cancel'
WHERE status = 'pending' 
  AND (remark LIKE '%取消原因%' OR remark LIKE '%customer_cancel%' OR remark LIKE '%out_of_stock%');

-- 3. 验证修复结果
SELECT 
    id,
    order_number,
    customer_name,
    status,
    remark,
    updated_at
FROM orders 
WHERE status = 'pending_cancel'
ORDER BY updated_at DESC;
```

### 步骤4：重新测试

修复后，重新测试：

1. 刷新页面（Ctrl + F5 强制刷新）
2. 点击"取消订单申请审核"按钮
3. 查看"待审核"标签页

**预期结果**：
- 弹窗中显示所有待审核的取消申请
- 订单信息完整显示

## 新订单测试

如果修复后仍然有问题，可以创建一个新的取消申请来测试：

### 1. 创建新订单
1. 登录普通成员账号
2. 创建一个新订单

### 2. 提交取消申请
1. 在订单列表中找到刚创建的订单
2. 点击"申请取消"按钮
3. 选择取消原因："客户主动取消"
4. 填写详细说明："测试取消申请功能"
5. 提交申请

### 3. 检查数据库
```sql
-- 查看刚提交的取消申请
SELECT 
    id,
    order_number,
    customer_name,
    status,
    cancel_reason,
    remark,
    created_by_name,
    updated_at
FROM orders 
ORDER BY updated_at DESC
LIMIT 1;
```

**预期结果**：
- `status` 应该是 `'pending_cancel'`
- `cancel_reason` 应该包含中文："客户主动取消 - 测试取消申请功能"
- `remark` 应该包含："取消原因: 客户主动取消 - 测试取消申请功能"

### 4. 检查消息通知
1. 登录管理员账号
2. 查看消息中心
3. 找到最新的取消申请通知

**预期结果**：
- 通知标题：📝 取消申请待审核
- 通知内容：【销售员：XXX】订单 #订单号（客户：客户名）申请取消，原因：客户主动取消 - 测试取消申请功能
- 取消原因显示为中文

### 5. 测试审核弹窗
1. 点击"取消订单申请审核"按钮
2. 查看"待审核"标签页

**预期结果**：
- 弹窗中显示刚才提交的取消申请
- 所有信息正确显示

## 常见问题

### Q1: 修复后仍然显示"暂无数据"
**可能原因**：
1. 浏览器缓存问题
2. 前端代码未更新
3. 后端服务未重启

**解决方案**：
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 强制刷新页面（Ctrl + F5）
3. 重启后端服务
4. 检查后端日志，确认 API 被调用

### Q2: 消息通知中的取消原因仍然显示英文
**可能原因**：
- 旧的消息通知还在，新的通知才会显示中文

**解决方案**：
- 提交一个新的取消申请，查看新的消息通知

### Q3: API 返回 401 未授权
**可能原因**：
- Token 过期或无效

**解决方案**：
- 重新登录
- 检查 localStorage 中的 token

## 验证清单

- [ ] 数据库中的订单状态为 `'pending_cancel'`
- [ ] API `/api/v1/orders/pending-cancel` 返回正确数据
- [ ] 消息通知中的取消原因显示为中文
- [ ] 取消审核弹窗中显示待审核的订单
- [ ] 可以正常进行审核操作（通过/拒绝）

## 相关文件

- 后端修复：`backend/src/routes/orders.ts`
- 前端修复：`src/views/Order/List.vue`
- 实体类型：`backend/src/entities/Order.ts`
- 修复脚本：`scripts/fix-existing-cancel-requests.sql`
- 检查脚本：`scripts/check-pending-cancel-orders.sql`
