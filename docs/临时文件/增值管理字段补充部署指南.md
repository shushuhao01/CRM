# 增值管理字段补充部署指南

## 问题说明

生产环境的 `outsource_companies` 表缺少以下字段：
- `is_default` - 标记默认公司
- `sort_order` - 公司排序顺序

导致外包公司列表接口报错，统计数据无法正常显示。

## 解决方案

需要在生产数据库中添加这两个字段。

## 执行步骤

### 方式一：分步执行（最安全，推荐）

在宝塔面板的数据库管理 SQL 窗口中，**一次执行一条**：

**第1步：选择数据库**
```sql
USE crm_production;
```

**第2步：添加 is_default 字段**
```sql
ALTER TABLE outsource_companies ADD COLUMN is_default TINYINT DEFAULT 0 COMMENT '是否默认公司';
```

**第3步：添加 sort_order 字段**
```sql
ALTER TABLE outsource_companies ADD COLUMN sort_order INT DEFAULT 999 COMMENT '排序顺序';
```

**第4步：添加索引**
```sql
ALTER TABLE outsource_companies ADD INDEX idx_sort_order (sort_order);
```

**第5步：更新排序值（这两条一起执行）**
```sql
SET @row_number = 0;
UPDATE outsource_companies SET sort_order = (@row_number := @row_number + 1) WHERE sort_order = 999 ORDER BY created_at ASC;
```

**第6步：验证结果**
```sql
SELECT id, company_name, is_default, sort_order, status, created_at FROM outsource_companies ORDER BY sort_order ASC;
```

### 方式二：一次性执行（如果分步执行成功）

如果你确认可以一次性执行，复制以下完整SQL：

```sql
USE crm_production;

ALTER TABLE outsource_companies ADD COLUMN is_default TINYINT DEFAULT 0 COMMENT '是否默认公司';
ALTER TABLE outsource_companies ADD COLUMN sort_order INT DEFAULT 999 COMMENT '排序顺序';
ALTER TABLE outsource_companies ADD INDEX idx_sort_order (sort_order);

SET @row_number = 0;
UPDATE outsource_companies SET sort_order = (@row_number := @row_number + 1) WHERE sort_order = 999 ORDER BY created_at ASC;

SELECT id, company_name, is_default, sort_order, status, created_at FROM outsource_companies ORDER BY sort_order ASC;
```

## 注意事项

### 如果字段已存在

如果执行时提示字段已存在（错误代码 1060），说明字段已经添加过了，可以忽略该错误。

可以先检查字段是否存在：

```sql
-- 检查字段是否存在
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_DEFAULT, COLUMN_COMMENT
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = 'crm_production' 
AND TABLE_NAME = 'outsource_companies' 
AND COLUMN_NAME IN ('is_default', 'sort_order');
```

### 如果索引已存在

如果提示索引已存在（错误代码 1061），可以跳过索引创建步骤。

检查索引：

```sql
-- 检查索引是否存在
SHOW INDEX FROM outsource_companies WHERE Key_name = 'idx_sort_order';
```

## 验证结果

执行完成后，应该看到：

1. 表结构中包含 `is_default` 和 `sort_order` 字段
2. 现有公司数据的 `sort_order` 已按创建时间排序（1, 2, 3...）
3. 所有公司的 `is_default` 默认为 0

示例输出：
```
+--------------------------------------+--------------+-------------------+------------+------------+--------+---------------------+
| id                                   | company_name | default_unit_price| is_default | sort_order | status | created_at          |
+--------------------------------------+--------------+-------------------+------------+------------+--------+---------------------+
| xxx-xxx-xxx                          | 合谱         | 900.00            | 0          | 1          | active | 2026-03-01 11:44:36 |
+--------------------------------------+--------------+-------------------+------------+------------+--------+---------------------+
```

## 后续操作

执行完成后：

1. 重启后端服务（如果需要）
2. 刷新前端页面
3. 检查增值管理页面的统计卡片和标签页数字是否正常显示
4. 检查外包公司管理功能是否正常

## 回滚方案

如果需要回滚（不推荐），可以执行：

```sql
-- 删除字段（谨慎操作！）
ALTER TABLE outsource_companies DROP COLUMN is_default;
ALTER TABLE outsource_companies DROP COLUMN sort_order;

-- 删除索引
ALTER TABLE outsource_companies DROP INDEX idx_sort_order;
```

## 相关文件

- SQL文件（完整版）：`backend/database-migrations/production-add-outsource-missing-fields.sql`
- SQL文件（简化版）：`backend/database-migrations/production-add-outsource-fields-simple.sql`
- 后端路由修复：`backend/src/routes/valueAdded.ts` (已支持 dateFilter 参数)

## 问题排查

如果执行后仍有问题：

1. 检查后端日志：`backend/logs/error.log`
2. 检查浏览器控制台是否有API错误
3. 确认后端服务已重启
4. 清除浏览器缓存后重试

## 完成标志

✅ 统计卡片显示正确的数字（全部资料、待处理、有效、无效等）
✅ 标签页显示正确的数量徽章
✅ 外包公司管理功能正常
✅ 公司列表可以正常加载和排序
