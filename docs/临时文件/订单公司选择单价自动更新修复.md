# 订单公司选择单价自动更新修复

## 问题描述

用户反馈两个问题：
1. 公司列表操作列宽度太宽（420px），留白太多
2. 主视图增值管理列表中，选择公司后单价变成0，应该自动更新为该公司最高优先级档位的单价

## 根本原因

### 问题1：操作列宽度
- 列宽设置为 420px，但实际按钮内容只需要 380px
- 导致右侧留白过多

### 问题2：单价不更新
**前端问题**：
```javascript
// ❌ 错误代码
const company = companies.value.find(c => c.id === companyId)
unitPrice = Number(company.defaultUnitPrice) || 0  // defaultUnitPrice 字段已删除
```

**原因**：
1. `updateOrderCompany` 函数使用了已删除的 `defaultUnitPrice` 字段
2. 应该使用 `company.topTier` 获取最高优先级档位的价格
3. 前端没有将计算的单价传给后端

## 修复方案

### 1. 优化操作列宽度 ✅

**文件**：`src/views/Finance/ValueAddedManage.vue`

```vue
<!-- 从 420px 减少到 380px -->
<el-table-column label="操作" width="380" fixed="right">
```

**效果**：
- 减少 40px 宽度
- 按钮布局仍然合理
- 减少右侧留白

### 2. 修复单价自动更新 ✅

#### 前端修复

**文件**：`src/views/Finance/ValueAddedManage.vue`

```javascript
const updateOrderCompany = async (row: ValueAddedOrder, companyId: string) => {
  let companyName = '待分配'
  let unitPrice = 0 // 业务规则：待分配时单价为0

  if (companyId !== 'default-company') {
    const company = companies.value.find(c => c.id === companyId)
    if (!company) return
    companyName = company.companyName
    
    // 🔥 业务规则：使用公司最高优先级档位的单价
    if (company.topTier) {
      if (company.topTier.pricingType === 'fixed') {
        unitPrice = Number(company.topTier.unitPrice) || 0
      } else {
        // 按比例计价时，这里暂时设为0，实际计算需要订单金额
        unitPrice = 0
      }
    } else {
      // 没有配置档位时，单价为0
      unitPrice = 0
    }
    
    console.log(`[updateOrderCompany] 公司=${companyName}, 档位=${company.topTier?.tierName || '未配置'}, 单价=${unitPrice}`)
  }

  try {
    const { updateOrderCompany: updateAPI } = await import('@/api/valueAdded')
    await updateAPI(row.id, {
      companyId,
      companyName,
      unitPrice // 🔥 添加单价参数
    })

    // 更新本地数据
    row.companyId = companyId
    row.companyName = companyName
    row.unitPrice = unitPrice as any

    ElMessage.success('修改成功')
    loadStats()
  } catch (e: any) {
    ElMessage.error(e?.message || '修改失败')
    loadData()
  }
}
```

**改进点**：
1. 使用 `company.topTier` 获取最高优先级档位
2. 判断档位的计价方式（fixed/percentage）
3. 固定单价直接使用，比例计价暂时设为0
4. 将计算的单价传给后端
5. 添加调试日志

#### API 接口更新

**文件**：`src/api/valueAdded.ts`

```typescript
export function updateOrderCompany(
  id: string, 
  data: { 
    companyId: string; 
    companyName: string; 
    unitPrice?: number  // 🔥 添加可选的单价参数
  }
) {
  return request({
    url: `/value-added/orders/${id}/company`,
    method: 'put',
    data
  })
}
```

#### 后端路由优化

**文件**：`backend/src/routes/valueAdded.ts`

```javascript
router.put('/orders/:id/company', authenticateToken, async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const { companyId, companyName, unitPrice: providedUnitPrice } = req.body;
    const user = (req as any).currentUser;

    let unitPrice = 0; // 默认单价为0（待分配）

    // 🔥 如果前端提供了单价，优先使用前端的值
    if (providedUnitPrice !== undefined && providedUnitPrice !== null) {
      unitPrice = Number(providedUnitPrice);
    } else if (companyId !== 'default-company') {
      // 🔥 如果不是"待分配"且前端未提供单价，则从数据库获取
      const priceConfigRepo = AppDataSource.getRepository(ValueAddedPriceConfig);
      const priceTier = await priceConfigRepo.findOne({
        where: { companyId, isActive: 1 },
        order: { priority: 'DESC', tierOrder: 'ASC' }  // 🔥 按优先级降序
      });

      if (priceTier && priceTier.pricingType === 'fixed') {
        unitPrice = priceTier.unitPrice || 0;
      }
    }

    // 更新订单
    order.companyId = companyId;
    order.companyName = companyName;
    order.unitPrice = unitPrice;
    order.operatorId = user.id;
    order.operatorName = user.name || user.username;

    await orderRepo.save(order);

    // 🔥 更新公司统计
    await updateCompanyStats(companyId);

    res.json({ success: true, message: '修改成功', data: { unitPrice } });
  } catch (error: any) {
    console.error('[ValueAdded] Update order company error:', error);
    res.status(500).json({ success: false, message: '修改失败' });
  }
});
```

**改进点**：
1. 优先使用前端传入的单价
2. 如果前端未提供，从数据库获取最高优先级档位
3. 排序改为按优先级降序（priority DESC）
4. 只使用固定单价档位
5. 更新后自动刷新公司统计

## 业务规则

### 单价计算规则

1. **待分配**（companyId = 'default-company'）
   - 单价 = 0

2. **选择公司**（companyId ≠ 'default-company'）
   - 有档位配置：
     - 固定单价：使用档位的 unitPrice
     - 比例计价：暂时设为 0（需要订单金额才能计算）
   - 无档位配置：单价 = 0

3. **档位选择规则**
   - 只使用启用的档位（isActive = 1）
   - 按优先级降序排序（priority DESC）
   - 优先级相同时按档位顺序升序（tierOrder ASC）
   - 选择第一个匹配的档位

### 数据流程

```
用户选择公司
    ↓
前端查找公司信息
    ↓
获取 company.topTier（最高优先级档位）
    ↓
判断计价方式
    ├─ 固定单价：使用 unitPrice
    └─ 比例计价：设为 0
    ↓
调用后端 API，传入 unitPrice
    ↓
后端更新订单
    ├─ 更新 companyId
    ├─ 更新 companyName
    └─ 更新 unitPrice
    ↓
更新公司统计数据
    ↓
返回成功，前端更新界面
```

## 测试场景

### 场景1：选择有固定单价档位的公司
1. 在增值管理列表中，选择一个订单
2. 点击"外包公司"下拉框
3. 选择一个配置了固定单价档位的公司（如：合谱，900元）
4. 验证单价列立即更新为 900.00
5. 验证控制台日志显示正确的档位信息

### 场景2：选择有比例档位的公司
1. 选择一个配置了比例计价档位的公司
2. 验证单价列显示为 0.00
3. 说明：比例计价需要订单金额才能计算

### 场景3：选择没有档位的公司
1. 选择一个未配置档位的公司
2. 验证单价列显示为 0.00
3. 提示用户需要配置档位

### 场景4：选择"待分配"
1. 将订单改为"待分配"
2. 验证单价列显示为 0.00
3. 验证公司名称显示为"待分配"

### 场景5：多档位优先级
1. 为公司配置多个档位，设置不同优先级
2. 选择该公司
3. 验证使用优先级最高的档位单价

## 控制台日志示例

成功的日志：
```
[updateOrderCompany] 公司=合谱, 档位=标准档, 单价=900
```

未配置档位：
```
[updateOrderCompany] 公司=测试公司, 档位=未配置, 单价=0
```

## 相关文件

### 前端文件
- `src/views/Finance/ValueAddedManage.vue` - 主视图，updateOrderCompany 函数
- `src/api/valueAdded.ts` - API 接口定义

### 后端文件
- `backend/src/routes/valueAdded.ts` - 订单公司更新路由

## 优化效果

### 操作列宽度
- ✅ 从 420px 减少到 380px
- ✅ 减少右侧留白
- ✅ 按钮布局仍然合理

### 单价自动更新
- ✅ 选择公司后单价立即更新
- ✅ 使用最高优先级档位的单价
- ✅ 待分配时单价为 0
- ✅ 未配置档位时单价为 0
- ✅ 支持固定单价和比例计价

### 用户体验
- ✅ 单价自动计算，无需手动输入
- ✅ 价格准确，基于档位配置
- ✅ 操作流畅，即时反馈

## 后续优化建议

### 1. 比例计价支持
当前比例计价时单价显示为 0，建议：
```javascript
if (company.topTier.pricingType === 'percentage') {
  // 获取订单金额
  const orderAmount = row.orderAmount || 0
  // 计算比例价格
  unitPrice = orderAmount * (company.topTier.percentageRate / 100)
}
```

### 2. 档位时间范围
建议在选择档位时考虑时间范围：
```javascript
const orderDate = row.orderDate || new Date()
const matchedTier = findMatchingPriceTier(tiers, orderDate)
```

### 3. 价格预览
在选择公司时，显示价格预览：
```vue
<el-option 
  v-for="company in companies" 
  :key="company.id" 
  :label="`${company.companyName} (¥${company.topTier?.unitPrice || 0})`" 
  :value="company.id" 
/>
```

### 4. 批量更新
支持批量修改订单公司，并自动更新单价：
```javascript
async function batchUpdateOrderCompany(ids, companyId) {
  // 获取公司档位
  // 批量更新订单
  // 更新统计
}
```

## 总结

本次修复完成了以下工作：
1. ✅ 优化公司列表操作列宽度（420px → 380px）
2. ✅ 修复订单选择公司后单价自动更新功能
3. ✅ 使用最高优先级档位的单价
4. ✅ 支持待分配、固定单价、比例计价等场景
5. ✅ 添加调试日志，便于排查问题

现在选择公司后，单价会立即更新为该公司最高优先级档位的价格，符合业务需求。
