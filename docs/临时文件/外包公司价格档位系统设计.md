# 外包公司价格档位系统设计

## 设计时间
2026-03-01

## 需求背景

用户需要一个更灵活的价格配置系统，类似绩效管理的计提方式：
1. 支持多个价格档位（第一档、第二档...）
2. 每个档位有生效时间范围
3. 支持两种计价方式：按单计价、按金额比例计价
4. 集成到外包公司管理中，不需要独立的费用配置页面

## 数据库设计

### 1. 外包公司价格档位表（新建）

```sql
CREATE TABLE `value_added_company_price_tiers` (
  `id` VARCHAR(50) NOT NULL COMMENT '档位ID',
  `company_id` VARCHAR(50) NOT NULL COMMENT '外包公司ID',
  `tier_name` VARCHAR(100) NOT NULL COMMENT '档位名称（第一档、第二档等）',
  `tier_order` INT NOT NULL DEFAULT 1 COMMENT '档位顺序',
  `pricing_type` VARCHAR(20) NOT NULL DEFAULT 'per_order' COMMENT '计价方式: per_order-按单计价, percentage-按比例计价',
  `unit_price` DECIMAL(10,2) DEFAULT 0.00 COMMENT '单价（按单计价时使用）',
  `percentage` DECIMAL(5,2) DEFAULT 0.00 COMMENT '比例（按比例计价时使用，如5.5表示5.5%）',
  `start_date` DATE NULL COMMENT '生效开始日期',
  `end_date` DATE NULL COMMENT '生效结束日期',
  `status` VARCHAR(20) NOT NULL DEFAULT 'active' COMMENT '状态: active-启用, inactive-停用',
  `remark` TEXT COMMENT '备注',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by_id` VARCHAR(50) COMMENT '创建人ID',
  `created_by_name` VARCHAR(100) COMMENT '创建人姓名',
  PRIMARY KEY (`id`),
  KEY `idx_company_id` (`company_id`),
  KEY `idx_tier_order` (`tier_order`),
  KEY `idx_date_range` (`start_date`, `end_date`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_price_tier_company` FOREIGN KEY (`company_id`) REFERENCES `value_added_outsource_companies` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='外包公司价格档位表';
```

### 2. 修改外包公司表

```sql
-- 移除 default_unit_price 字段（改用档位系统）
ALTER TABLE `value_added_outsource_companies` 
DROP COLUMN `default_unit_price`;
```

### 3. 删除旧的价格配置表

```sql
-- 可选：如果不再需要旧的价格配置表
DROP TABLE IF EXISTS `value_added_price_config`;
```

## 前端UI设计

### 1. 外包公司管理主对话框

```
┌─────────────────────────────────────────────────────────────────┐
│ 外包公司管理                                          [添加公司] │
├─────────────────────────────────────────────────────────────────┤
│ 排序 │ 公司名称      │ 联系人 │ 联系电话    │ 总订单 │ 操作    │
├─────────────────────────────────────────────────────────────────┤
│  1   │ 合速物流[默认]│ 张三   │ 13800138000 │  156   │ [操作]  │
│  2   │ 极兔速递      │ 李四   │ 13900139000 │   89   │ [操作]  │
└─────────────────────────────────────────────────────────────────┘

操作按钮：
- 设为默认/取消默认
- 价格档位（重点功能）
- 编辑
- 删除/启用停用
```

### 2. 价格档位管理对话框（新增）

```
┌─────────────────────────────────────────────────────────────────┐
│ 价格档位管理 - 合速物流                          [添加档位]     │
├─────────────────────────────────────────────────────────────────┤
│ 档位 │ 计价方式 │ 单价/比例 │ 生效时间          │ 状态 │ 操作 │
├─────────────────────────────────────────────────────────────────┤
│ 第一档│ 按单计价 │ ¥900.00  │ 2024-01-01 至今   │ 启用 │ [编辑]│
│ 第二档│ 按比例   │ 5.5%     │ 2024-06-01~12-31  │ 启用 │ [编辑]│
│ 第三档│ 按单计价 │ ¥1200.00 │ 2025-01-01 至今   │ 启用 │ [编辑]│
└─────────────────────────────────────────────────────────────────┘

说明：
- 系统会根据订单日期自动匹配对应档位
- 如果有多个档位在同一时间生效，使用档位顺序最小的
- 按比例计价时，基数为订单金额
```

### 3. 添加/编辑档位表单

```
┌─────────────────────────────────────────────┐
│ 添加价格档位                                │
├─────────────────────────────────────────────┤
│ 档位名称: [第一档                    ]      │
│ 档位顺序: [1                         ]      │
│                                             │
│ 计价方式: ○ 按单计价  ○ 按比例计价         │
│                                             │
│ 【按单计价时显示】                          │
│ 单价(元): [900.00                   ]      │
│                                             │
│ 【按比例计价时显示】                        │
│ 比例(%):  [5.5                      ]      │
│ 说明: 按订单金额的5.5%计算                  │
│                                             │
│ 生效时间:                                   │
│ 开始日期: [2024-01-01] 结束日期: [不限制]  │
│                                             │
│ 状态: ○ 启用  ○ 停用                       │
│                                             │
│ 备注: [                              ]      │
│       [                              ]      │
│                                             │
│              [取消]  [保存]                 │
└─────────────────────────────────────────────┘
```

## 业务逻辑

### 1. 价格计算逻辑

```typescript
// 根据订单日期和公司ID获取适用的价格档位
function getApplicablePriceTier(companyId: string, orderDate: Date) {
  // 1. 查询该公司所有启用的档位
  // 2. 筛选出在orderDate生效的档位（start_date <= orderDate <= end_date）
  // 3. 按tier_order排序，取第一个
  // 4. 返回档位信息
}

// 计算订单单价
function calculateOrderPrice(order: Order, priceTier: PriceTier) {
  if (priceTier.pricingType === 'per_order') {
    // 按单计价
    return priceTier.unitPrice;
  } else if (priceTier.pricingType === 'percentage') {
    // 按比例计价
    const orderAmount = order.totalAmount || 0;
    return orderAmount * (priceTier.percentage / 100);
  }
  return 0;
}
```

### 2. 档位优先级规则

1. **时间匹配**：订单日期必须在档位的生效时间范围内
2. **状态过滤**：只考虑状态为"启用"的档位
3. **顺序优先**：如果多个档位同时生效，使用tier_order最小的
4. **默认处理**：如果没有匹配的档位，单价为0

### 3. 档位冲突检测

添加/编辑档位时，检测是否与现有档位时间重叠：
- 允许：不同档位时间不重叠
- 警告：时间重叠但tier_order不同（会使用顺序小的）
- 禁止：完全相同的时间范围和顺序

## API设计

### 1. 价格档位API

```typescript
// 获取公司的价格档位列表
GET /api/v1/value-added/companies/:companyId/price-tiers
Response: { list: PriceTier[], total: number }

// 创建价格档位
POST /api/v1/value-added/companies/:companyId/price-tiers
Body: { tierName, tierOrder, pricingType, unitPrice, percentage, startDate, endDate, status, remark }

// 更新价格档位
PUT /api/v1/value-added/companies/:companyId/price-tiers/:tierId
Body: { tierName, tierOrder, pricingType, unitPrice, percentage, startDate, endDate, status, remark }

// 删除价格档位
DELETE /api/v1/value-added/companies/:companyId/price-tiers/:tierId

// 获取订单适用的价格档位
GET /api/v1/value-added/orders/:orderId/applicable-price-tier
Response: { tier: PriceTier, calculatedPrice: number }
```

### 2. 修改现有API

```typescript
// 同步订单时，自动计算单价
POST /api/v1/value-added/sync-orders
- 根据订单日期和分配的公司，自动匹配价格档位
- 计算并设置unitPrice

// 更新订单公司时，重新计算单价
PUT /api/v1/value-added/orders/:orderId/company
- 根据新公司和订单日期，重新匹配价格档位
- 更新unitPrice
```

## 实体类设计

```typescript
// backend/src/entities/ValueAddedCompanyPriceTier.ts
@Entity('value_added_company_price_tiers')
export class ValueAddedCompanyPriceTier {
  @PrimaryColumn({ length: 50 })
  id: string;

  @Column({ name: 'company_id', length: 50 })
  companyId: string;

  @Column({ name: 'tier_name', length: 100 })
  tierName: string;

  @Column({ name: 'tier_order', type: 'int', default: 1 })
  tierOrder: number;

  @Column({ name: 'pricing_type', length: 20, default: 'per_order' })
  pricingType: 'per_order' | 'percentage';

  @Column({ name: 'unit_price', type: 'decimal', precision: 10, scale: 2, default: 0 })
  unitPrice: number;

  @Column({ name: 'percentage', type: 'decimal', precision: 5, scale: 2, default: 0 })
  percentage: number;

  @Column({ name: 'start_date', type: 'date', nullable: true })
  startDate: Date | null;

  @Column({ name: 'end_date', type: 'date', nullable: true })
  endDate: Date | null;

  @Column({ length: 20, default: 'active' })
  status: string;

  @Column({ type: 'text', nullable: true })
  remark: string | null;

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date;

  @Column({ name: 'created_by_id', length: 50, nullable: true })
  createdById: string | null;

  @Column({ name: 'created_by_name', length: 100, nullable: true })
  createdByName: string | null;

  @ManyToOne(() => ValueAddedOutsourceCompany, company => company.priceTiers)
  @JoinColumn({ name: 'company_id' })
  company: ValueAddedOutsourceCompany;
}
```

## 前端组件设计

### 1. 组件结构

```
src/views/Finance/ValueAddedManage.vue
  └─ components/
      ├─ ValueAddedConfigDialog.vue (保留，用于状态配置)
      ├─ CompanyManageDialog.vue (新建，外包公司管理)
      └─ PriceTierDialog.vue (新建，价格档位管理)
```

### 2. 组件职责

**CompanyManageDialog.vue**
- 显示外包公司列表
- 添加/编辑/删除公司
- 设置默认公司
- 打开价格档位管理对话框

**PriceTierDialog.vue**
- 显示指定公司的价格档位列表
- 添加/编辑/删除档位
- 档位排序
- 时间冲突检测

## 迁移策略

### 1. 数据迁移

```sql
-- 1. 为现有公司创建默认档位
INSERT INTO value_added_company_price_tiers (
  id, company_id, tier_name, tier_order, pricing_type, 
  unit_price, start_date, status, created_at
)
SELECT 
  CONCAT('tier-', id, '-001'),
  id,
  '第一档',
  1,
  'per_order',
  default_unit_price,
  '2024-01-01',
  'active',
  NOW()
FROM value_added_outsource_companies
WHERE default_unit_price IS NOT NULL AND default_unit_price > 0;

-- 2. 删除default_unit_price字段
ALTER TABLE value_added_outsource_companies 
DROP COLUMN default_unit_price;
```

### 2. 代码迁移

1. 创建新的实体类和API
2. 更新前端组件
3. 测试价格计算逻辑
4. 执行数据迁移
5. 删除旧的费用配置相关代码

## 优势

1. **灵活性**：支持多种计价方式和时间段
2. **可扩展**：未来可以添加更多计价规则
3. **自动化**：系统自动根据日期匹配档位
4. **清晰**：档位概念直观，易于理解和管理
5. **集成**：与外包公司管理紧密集成，操作便捷

## 注意事项

1. **历史订单**：已有订单的单价不会自动更新，只影响新订单
2. **档位删除**：删除档位前需要检查是否有订单使用
3. **时间重叠**：需要明确告知用户档位优先级规则
4. **比例计价**：需要确保订单金额字段存在且准确
