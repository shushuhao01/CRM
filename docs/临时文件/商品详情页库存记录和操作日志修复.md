# å•†å“è¯¦æƒ…é¡µåº“å­˜è®°å½•å’Œæ“ä½œæ—¥å¿—ä¿®å¤

## ä¿®å¤æ—¥æœŸ
2026-02-28

## é—®é¢˜æè¿°

### é—®é¢˜1: åº“å­˜è®°å½•è®¡ç®—é”™è¯¯
- å˜åŒ–ååº“å­˜ä¸€ç›´æ˜¾ç¤ºç›¸åŒæ•°å­—
- éœ€è¦å®ç°æ­£ç¡®çš„åº“å­˜ç´¯è®¡è®¡ç®—é€»è¾‘

### é—®é¢˜2: ç¼ºå°‘ç¿»é¡µæ§ä»¶
- åº“å­˜è®°å½•åº•éƒ¨æ²¡æœ‰ç¿»é¡µæ§ä»¶
- éœ€è¦æ·»åŠ åˆ†é¡µåŠŸèƒ½ï¼Œé»˜è®¤10æ¡/é¡µ

### é—®é¢˜3: æ“ä½œæ—¥å¿—æ˜¾ç¤ºIDè€Œéå§“å
- æ“ä½œæ—¥å¿—æ˜¾ç¤ºçš„æ˜¯ç”¨æˆ·IDï¼ˆå¦‚`user_176693458301_x5gsnc82z`ï¼‰
- åº”è¯¥æ˜¾ç¤ºç”¨æˆ·çš„çœŸå®å§“å

### é—®é¢˜4: ç›¸å…³ç»Ÿè®¡æ•°æ®èŒƒå›´æ§åˆ¶é”™è¯¯
- è§’è‰²åˆ¤æ–­ä½¿ç”¨äº†é”™è¯¯çš„è§’è‰²åç§°
- éœ€è¦ç»Ÿä¸€ä½¿ç”¨æ­£ç¡®çš„è§’è‰²ä»£ç 

## ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜1ä¿®å¤ âœ…
**æ–‡ä»¶**: `src/views/Product/Detail.vue`

**ä¿®å¤å†…å®¹**:
1. å®ç°æ­£ç¡®çš„åº“å­˜ç´¯è®¡è®¡ç®—é€»è¾‘
2. è®¡ç®—åˆå§‹åº“å­˜ = å½“å‰åº“å­˜ + å·²å”®å‡ºæ€»æ•°
3. æŒ‰æ—¶é—´é¡ºåºé€æ­¥é€’å‡åº“å­˜
4. å…³è”è®¢å•IDå’Œè®¢å•å·ï¼Œä¾¿äºè¿½æº¯

**å…³é”®ä»£ç **:
```typescript
// è®¡ç®—åˆå§‹åº“å­˜ï¼ˆå½“å‰åº“å­˜ + å·²å”®å‡ºæ€»æ•°ï¼‰
const totalSold = productOrders.reduce((sum, order) => {
  const product = order.products.find(p => p.id === productId || p.id === Number(productId))
  return sum + (product?.quantity || 0)
}, 0)
let currentStockValue = (currentProduct.stock || 0) + totalSold

// æŒ‰æ—¶é—´é¡ºåºé€’å‡åº“å­˜
stockRecords.value = records
  .sort((a, b) => new Date(a.createTime).getTime() - new Date(b.createTime).getTime())
  .map(record => {
    const stockAfter = currentStockValue
    currentStockValue -= record.quantity
    return { ...record, stockAfter }
  })
  .reverse()
```

### é—®é¢˜2ä¿®å¤ âœ…
**æ–‡ä»¶**: `src/views/Product/Detail.vue`

**ä¿®å¤å†…å®¹**:
1. æ·»åŠ åˆ†é¡µçŠ¶æ€ç®¡ç†
2. å®ç°åˆ†é¡µè®¡ç®—é€»è¾‘
3. æ·»åŠ Element Plusåˆ†é¡µç»„ä»¶
4. æ”¯æŒ10/20/50/100æ¡/é¡µåˆ‡æ¢

**å…³é”®ä»£ç **:
```typescript
// åº“å­˜è®°å½•åˆ†é¡µ
const stockPagination = reactive({
  currentPage: 1,
  pageSize: 10,
  total: 0
})

// åº“å­˜è®°å½•æ˜¾ç¤ºæ•°æ®(åˆ†é¡µå)
const paginatedStockRecords = computed(() => {
  const start = (stockPagination.currentPage - 1) * stockPagination.pageSize
  const end = start + stockPagination.pageSize
  return stockRecords.value.slice(start, end)
})

// ç¿»é¡µå¤„ç†å‡½æ•°
const handleStockPageChange = (page: number) => {
  stockPagination.currentPage = page
}

const handleStockSizeChange = (size: number) => {
  stockPagination.pageSize = size
  stockPagination.currentPage = 1
}
```

### é—®é¢˜3ä¿®å¤ âœ…
**æ–‡ä»¶**: `src/views/Product/Detail.vue`

**ä¿®å¤å†…å®¹**:
1. å¢å¼º`getUserName`å‡½æ•°ï¼Œæ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
2. ç¡®ä¿åœ¨`loadOperationLogs`å¼€å§‹æ—¶åŠ è½½ç”¨æˆ·æ•°æ®
3. æ”¯æŒç‰¹æ®ŠIDæ ¼å¼çš„åŒ¹é…ï¼ˆå¦‚`user_xxx`æ ¼å¼ï¼‰
4. æ·»åŠ å¤šç§åŒ¹é…ç­–ç•¥ï¼š
   - ç›´æ¥IDåŒ¹é…
   - usernameåŒ¹é…
   - åŒ…å«å…³ç³»åŒ¹é…

**å…³é”®ä»£ç **:
```typescript
// ğŸ”¥ ç¡®ä¿ç”¨æˆ·æ•°æ®å·²åŠ è½½
if (userStore.users.length === 0) {
  console.log('[æ“ä½œæ—¥å¿—] ç”¨æˆ·æ•°æ®æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...')
  await userStore.loadUsers()
  console.log('[æ“ä½œæ—¥å¿—] ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆï¼Œå…±', userStore.users.length, 'ä¸ªç”¨æˆ·')
}

// ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šå°†ç”¨æˆ·IDè½¬æ¢ä¸ºå§“å
const getUserName = (userId: string | undefined) => {
  if (!userId) {
    console.log('[æ“ä½œæ—¥å¿—] userIdä¸ºç©ºï¼Œè¿”å›"ç³»ç»Ÿ"')
    return 'ç³»ç»Ÿ'
  }

  console.log('[æ“ä½œæ—¥å¿—] æŸ¥æ‰¾ç”¨æˆ·ID:', userId)

  // å°è¯•é€šè¿‡IDæŸ¥æ‰¾ç”¨æˆ·
  const user = userStore.getUserById(userId)
  if (user) {
    const userName = user.realName || user.name || user.username || userId
    console.log('[æ“ä½œæ—¥å¿—] æ‰¾åˆ°ç”¨æˆ·:', userName)
    return userName
  }

  // ğŸ”¥ å¦‚æœIDæ˜¯ç‰¹æ®Šæ ¼å¼(å¦‚ user_xxx),å°è¯•æå–çœŸå®IDæˆ–åŒ¹é…username
  if (typeof userId === 'string' && userId.includes('_')) {
    console.log('[æ“ä½œæ—¥å¿—] æ£€æµ‹åˆ°ç‰¹æ®Šæ ¼å¼IDï¼Œå°è¯•åŒ¹é…...')
    const matchedUser = userStore.users.find(u =>
      u.username === userId ||
      u.id === userId ||
      String(u.id) === userId ||
      userId.includes(String(u.id)) ||
      userId.includes(u.username)
    )
    if (matchedUser) {
      const userName = matchedUser.realName || matchedUser.name || matchedUser.username || userId
      console.log('[æ“ä½œæ—¥å¿—] é€šè¿‡ç‰¹æ®Šæ ¼å¼åŒ¹é…åˆ°ç”¨æˆ·:', userName)
      return userName
    }
  }

  // å¦‚æœéƒ½æ‰¾ä¸åˆ°,è¿”å›åŸID
  console.log('[æ“ä½œæ—¥å¿—] æœªæ‰¾åˆ°ç”¨æˆ·ï¼Œè¿”å›åŸID:', userId)
  console.log('[æ“ä½œæ—¥å¿—] å½“å‰ç”¨æˆ·åˆ—è¡¨:', userStore.users.map(u => ({ id: u.id, name: u.name, username: u.username })))
  return userId
}
```

**è°ƒè¯•æ–¹æ³•**:
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. è¿›å…¥å•†å“è¯¦æƒ…é¡µé¢
3. æŸ¥çœ‹`[æ“ä½œæ—¥å¿—]`å¼€å¤´çš„æ—¥å¿—è¾“å‡º
4. æ£€æŸ¥ç”¨æˆ·æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½
5. æ£€æŸ¥IDåŒ¹é…è¿‡ç¨‹

### é—®é¢˜4ä¿®å¤ âœ…
**æ–‡ä»¶**: `src/views/Product/Detail.vue`

**ä¿®å¤å†…å®¹**:
1. ä¿®å¤`applyDataScopeControl`å‡½æ•°ä¸­çš„è§’è‰²åˆ¤æ–­
2. ä¿®å¤`loadRelatedStatsFromLocal`å‡½æ•°ä¸­çš„è§’è‰²åˆ¤æ–­
3. ç»Ÿä¸€ä½¿ç”¨æ­£ç¡®çš„è§’è‰²ä»£ç 
4. ğŸ”¥ **æ–°å¢**ï¼šç¡®ä¿åœ¨è®¡ç®—ç»Ÿè®¡æ•°æ®å‰å…ˆåŠ è½½è®¢å•æ•°æ®
5. ğŸ”¥ **æ–°å¢**ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

**è§’è‰²åç§°å¯¹ç…§è¡¨**:
| æ—§è§’è‰²åç§° | æ–°è§’è‰²åç§° | è¯´æ˜ |
|-----------|-----------|------|
| `super_admin` | `super_admin` | è¶…çº§ç®¡ç†å‘˜ï¼ˆä¸å˜ï¼‰ |
| âŒ æ—  | `admin` | ç®¡ç†å‘˜ï¼ˆæ–°å¢ï¼‰ |
| âŒ `department_head` | `department_manager` | éƒ¨é—¨ç»ç† |
| âŒ `sales` | `sales_staff` | é”€å”®å‘˜ |
| `customer_service` | `customer_service` | å®¢æœï¼ˆä¸å˜ï¼‰ |

**ä¿®å¤åçš„ä»£ç **:
```typescript
// loadRelatedStatsFromLocalå‡½æ•° - ç¡®ä¿è®¢å•æ•°æ®å·²åŠ è½½
const loadRelatedStatsFromLocal = async () => {
  try {
    const productId = route.params.id as string

    console.log('[ç›¸å…³ç»Ÿè®¡] å¼€å§‹ä»æœ¬åœ°æ•°æ®åŠ è½½ç»Ÿè®¡...')
    console.log('[ç›¸å…³ç»Ÿè®¡] å•†å“ID:', productId)
    console.log('[ç›¸å…³ç»Ÿè®¡] è®¢å•æ€»æ•°:', orderStore.orders.length)

    // ğŸ”¥ ç¡®ä¿è®¢å•æ•°æ®å·²åŠ è½½
    if (orderStore.orders.length === 0) {
      console.log('[ç›¸å…³ç»Ÿè®¡] è®¢å•æ•°æ®æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...')
      await orderStore.loadOrdersFromAPI()
      console.log('[ç›¸å…³ç»Ÿè®¡] è®¢å•æ•°æ®åŠ è½½å®Œæˆï¼Œå…±', orderStore.orders.length, 'ä¸ªè®¢å•')
    }

    // è·å–åŒ…å«è¯¥å•†å“çš„æ‰€æœ‰è®¢å•ï¼Œåº”ç”¨æ•°æ®èŒƒå›´æ§åˆ¶
    const allOrders = applyDataScopeControl(orderStore.orders)
    console.log('[ç›¸å…³ç»Ÿè®¡] åº”ç”¨æ•°æ®èŒƒå›´æ§åˆ¶åçš„è®¢å•æ•°:', allOrders.length)
    
    const productOrders = allOrders.filter(order =>
      order.products.some(p => p.id === productId || p.id === Number(productId))
    )
    console.log('[ç›¸å…³ç»Ÿè®¡] åŒ…å«è¯¥å•†å“çš„è®¢å•æ•°:', productOrders.length)

    // ... è®¡ç®—ç»Ÿè®¡æ•°æ® ...

    console.log('[ç›¸å…³ç»Ÿè®¡] ç»Ÿè®¡æ•°æ®è®¡ç®—å®Œæˆ:', relatedStats.value)
  } catch (error) {
    console.error('[ç›¸å…³ç»Ÿè®¡] ä»æœ¬åœ°åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    // ...
  }
}

// applyDataScopeControlå‡½æ•°
const applyDataScopeControl = (orders: unknown[]) => {
  const currentUser = userStore.user
  if (!currentUser) return []

  // è¶…çº§ç®¡ç†å‘˜å’Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¢å•
  if (currentUser.role === 'super_admin' || currentUser.role === 'admin') {
    return orders
  }

  // éƒ¨é—¨ç»ç†å¯ä»¥æŸ¥çœ‹æœ¬éƒ¨é—¨æ‰€æœ‰è®¢å•
  if (currentUser.role === 'department_manager') {
    return orders.filter(order =>
      order.salesPerson?.departmentId === currentUser.departmentId ||
      order.customerService?.departmentId === currentUser.departmentId
    )
  }

  // é”€å”®å‘˜åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
  if (currentUser.role === 'sales_staff') {
    return orders.filter(order => order.salesPersonId === currentUser.id)
  }

  // å®¢æœåªèƒ½æŸ¥çœ‹è‡ªå·±è´Ÿè´£çš„è®¢å•
  if (currentUser.role === 'customer_service') {
    return orders.filter(order => order.customerServiceId === currentUser.id)
  }

  // å…¶ä»–è§’è‰²é»˜è®¤åªèƒ½æŸ¥çœ‹è‡ªå·±ç›¸å…³çš„è®¢å•
  return orders.filter(order =>
    order.salesPersonId === currentUser.id ||
    order.customerServiceId === currentUser.id
  )
}

// loadRelatedStatsFromLocalå‡½æ•°
const currentUser = userStore.user
let dataScope: 'all' | 'department' | 'personal' = 'personal'
if (currentUser?.role === 'super_admin' || currentUser?.role === 'admin') {
  dataScope = 'all'
} else if (currentUser?.role === 'department_manager') {
  dataScope = 'department'
}
```

## æ•°æ®èŒƒå›´è¯´æ˜

### ç›¸å…³ç»Ÿè®¡å¡ç‰‡æ•°æ®æ¥æº
1. **ä¼˜å…ˆä½¿ç”¨åç«¯API**: è°ƒç”¨`/products/${productId}/stats`è·å–ç»Ÿè®¡æ•°æ®
2. **é™çº§æ–¹æ¡ˆ**: å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®¢å•æ•°æ®è®¡ç®—ç»Ÿè®¡
3. **æ•°æ®ä¾èµ–**: æœ¬åœ°è®¡ç®—ä¾èµ–`orderStore.orders`ï¼Œä¼šè‡ªåŠ¨åŠ è½½è®¢å•æ•°æ®

### è°ƒè¯•æ–¹æ³•
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹`[ç›¸å…³ç»Ÿè®¡]`å¼€å¤´çš„æ—¥å¿—ï¼š
- è®¢å•æ•°æ®åŠ è½½æƒ…å†µ
- æ•°æ®èŒƒå›´æ§åˆ¶åçš„è®¢å•æ•°é‡
- åŒ…å«è¯¥å•†å“çš„è®¢å•æ•°é‡
- æœ€ç»ˆè®¡ç®—çš„ç»Ÿè®¡æ•°æ®

### ç›¸å…³ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºè§„åˆ™
æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒèŒƒå›´çš„æ•°æ®ï¼š

1. **è¶…çº§ç®¡ç†å‘˜/ç®¡ç†å‘˜** (`super_admin` / `admin`)
   - æ•°æ®èŒƒå›´ï¼šå…¨éƒ¨æ•°æ®
   - æ ‡ç­¾ï¼šç»¿è‰² "å…¨éƒ¨æ•°æ®"
   - ç»Ÿè®¡æ‰€æœ‰è®¢å•å’Œå•†å“æ•°æ®

2. **éƒ¨é—¨ç»ç†** (`department_manager`)
   - æ•°æ®èŒƒå›´ï¼šéƒ¨é—¨æ•°æ®
   - æ ‡ç­¾ï¼šæ©™è‰² "éƒ¨é—¨æ•°æ®"
   - ç»Ÿè®¡æœ¬éƒ¨é—¨çš„è®¢å•å’Œå•†å“æ•°æ®

3. **é”€å”®å‘˜** (`sales_staff`)
   - æ•°æ®èŒƒå›´ï¼šä¸ªäººæ•°æ®
   - æ ‡ç­¾ï¼šç°è‰² "ä¸ªäººæ•°æ®"
   - ç»Ÿè®¡ä¸ªäººçš„è®¢å•å’Œå•†å“æ•°æ®

4. **å®¢æœ** (`customer_service`)
   - æ•°æ®èŒƒå›´ï¼šä¸ªäººæ•°æ®
   - æ ‡ç­¾ï¼šç°è‰² "ä¸ªäººæ•°æ®"
   - ç»Ÿè®¡ä¸ªäººè´Ÿè´£çš„è®¢å•æ•°æ®

## æµ‹è¯•éªŒè¯

### é—®é¢˜1æµ‹è¯•
1. è¿›å…¥å•†å“è¯¦æƒ…é¡µé¢
2. æŸ¥çœ‹åº“å­˜è®°å½•è¡¨æ ¼
3. éªŒè¯"å˜åŒ–ååº“å­˜"åˆ—çš„æ•°å€¼æ˜¯å¦æ­£ç¡®é€’å‡
4. æ£€æŸ¥æ˜¯å¦å…³è”äº†è®¢å•å·

### é—®é¢˜2æµ‹è¯•
1. è¿›å…¥å•†å“è¯¦æƒ…é¡µé¢
2. æ»šåŠ¨åˆ°åº“å­˜è®°å½•å¡ç‰‡
3. éªŒè¯åº•éƒ¨æ˜¯å¦æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
4. æµ‹è¯•ç¿»é¡µå’Œåˆ‡æ¢æ¯é¡µæ¡æ•°åŠŸèƒ½

### é—®é¢˜3æµ‹è¯•
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. è¿›å…¥å•†å“è¯¦æƒ…é¡µé¢
3. æŸ¥çœ‹æ“ä½œæ—¥å¿—å¡ç‰‡
4. éªŒè¯æ“ä½œäººåˆ—æ˜¯å¦æ˜¾ç¤ºå§“åè€ŒéID
5. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ç”¨æˆ·æ•°æ®åŠ è½½å’ŒåŒ¹é…è¿‡ç¨‹

### é—®é¢˜4æµ‹è¯•
1. ä½¿ç”¨ä¸åŒè§’è‰²ç™»å½•ç³»ç»Ÿï¼š
   - è¶…çº§ç®¡ç†å‘˜/ç®¡ç†å‘˜
   - éƒ¨é—¨ç»ç†
   - é”€å”®å‘˜
2. è¿›å…¥å•†å“è¯¦æƒ…é¡µé¢
3. æŸ¥çœ‹"ç›¸å…³ç»Ÿè®¡"å¡ç‰‡
4. éªŒè¯æ•°æ®èŒƒå›´æ ‡ç­¾æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
5. éªŒè¯ç»Ÿè®¡æ•°æ®æ˜¯å¦ç¬¦åˆè§’è‰²æƒé™

## æ³¨æ„äº‹é¡¹

1. **æ“ä½œæ—¥å¿—æ˜¾ç¤ºé—®é¢˜**ï¼š
   - å¦‚æœä»ç„¶æ˜¾ç¤ºIDï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
   - ç¡®è®¤ç”¨æˆ·æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½
   - æ£€æŸ¥è®¢å•æ•°æ®ä¸­çš„`createdBy`å­—æ®µæ ¼å¼

2. **è§’è‰²æƒé™**ï¼š
   - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è§’è‰²ä»£ç 
   - ä¸è¦æ··ç”¨æ—§çš„è§’è‰²åç§°
   - ç»Ÿä¸€ä½¿ç”¨ï¼š`super_admin`, `admin`, `department_manager`, `sales_staff`, `customer_service`

3. **æ•°æ®èŒƒå›´**ï¼š
   - åç«¯APIåº”è¯¥æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤æ•°æ®
   - å‰ç«¯ä½œä¸ºé™çº§æ–¹æ¡ˆï¼Œä¹Ÿå®ç°äº†æ•°æ®è¿‡æ»¤
   - ç¡®ä¿å‰åç«¯è§’è‰²åˆ¤æ–­é€»è¾‘ä¸€è‡´

## ç›¸å…³æ–‡ä»¶
- `src/views/Product/Detail.vue` - å•†å“è¯¦æƒ…é¡µé¢ä¸»æ–‡ä»¶
- `src/stores/user.ts` - ç”¨æˆ·storeï¼Œæä¾›getUserByIdæ–¹æ³•
- `src/stores/product.ts` - å•†å“store
- `src/stores/order.ts` - è®¢å•store

## çŠ¶æ€
- âœ… é—®é¢˜1: åº“å­˜è®°å½•è®¡ç®— - å·²ä¿®å¤
- âœ… é—®é¢˜2: æ·»åŠ ç¿»é¡µæ§ä»¶ - å·²å®Œæˆ
- âœ… é—®é¢˜3: æ“ä½œæ—¥å¿—æ˜¾ç¤ºID - å·²ä¿®å¤ï¼ˆå¢å¼ºè°ƒè¯•ï¼‰
- âœ… é—®é¢˜4: æ•°æ®èŒƒå›´æ§åˆ¶ - å·²ä¿®å¤


## åç«¯APIä¿®å¤

### å•†å“ç»Ÿè®¡APIè§’è‰²åˆ¤æ–­ä¿®å¤ âœ…
**æ–‡ä»¶**: `backend/src/controllers/ProductController.ts`

**é—®é¢˜**: 
- åç«¯`getProductStats`æ–¹æ³•ä½¿ç”¨äº†é”™è¯¯çš„è§’è‰²åç§°
- å¯¼è‡´APIè¿”å›çš„æ•°æ®èŒƒå›´ä¸æ­£ç¡®

**ä¿®å¤å†…å®¹**:
ç»Ÿä¸€è§’è‰²åç§°ï¼Œä¸å‰ç«¯ä¿æŒä¸€è‡´ï¼š

| æ—§è§’è‰²åç§° | æ–°è§’è‰²åç§° | è¯´æ˜ |
|-----------|-----------|------|
| `super_admin` | `super_admin` | è¶…çº§ç®¡ç†å‘˜ï¼ˆä¸å˜ï¼‰ |
| `admin` | `admin` | ç®¡ç†å‘˜ï¼ˆä¸å˜ï¼‰ |
| âŒ `department_head` | `department_manager` | éƒ¨é—¨ç»ç† |
| âŒ `manager` | `department_manager` | éƒ¨é—¨ç»ç† |
| âŒ `sales` | `sales_staff` | é”€å”®å‘˜ |
| `customer_service` | `customer_service` | å®¢æœï¼ˆä¸å˜ï¼‰ |

**ä¿®å¤åçš„ä»£ç **:
```typescript
// æ ¹æ®ç”¨æˆ·è§’è‰²åº”ç”¨æ•°æ®èŒƒå›´è¿‡æ»¤
if (userRole === 'super_admin' || userRole === 'admin') {
  // è¶…çº§ç®¡ç†å‘˜å’Œç®¡ç†å‘˜ï¼šæŸ¥çœ‹å…¨éƒ¨æ•°æ®
} else if (userRole === 'department_manager') {
  // éƒ¨é—¨ç»ç†ï¼šæŸ¥çœ‹æœ¬éƒ¨é—¨æ•°æ®
  if (departmentId) {
    queryBuilder = queryBuilder.andWhere(
      '(order.salesPersonDepartmentId = :departmentId OR order.customerServiceDepartmentId = :departmentId)',
      { departmentId }
    )
  }
} else if (userRole === 'sales_staff') {
  // é”€å”®å‘˜ï¼šåªçœ‹è‡ªå·±çš„è®¢å•
  queryBuilder = queryBuilder.andWhere('order.salesPersonId = :userId', { userId })
} else if (userRole === 'customer_service') {
  // å®¢æœï¼šåªçœ‹è‡ªå·±è´Ÿè´£çš„è®¢å•
  queryBuilder = queryBuilder.andWhere('order.customerServiceId = :userId', { userId })
}

// è¿”å›æ•°æ®èŒƒå›´æ ‡è¯†
dataScope: userRole === 'super_admin' || userRole === 'admin' ? 'all' :
           userRole === 'department_manager' ? 'department' : 'personal'
```

**é‡å¯åç«¯æœåŠ¡**:
ä¿®æ”¹åéœ€è¦é‡å¯åç«¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼š
```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
pm2 restart crm-backend
```
