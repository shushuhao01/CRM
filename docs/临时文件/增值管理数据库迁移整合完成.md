# 增值管理数据库迁移整合完成

## 执行时间
2026-03-02

## 任务概述
整合所有增值管理相关的数据库迁移文件，完成本地数据库迁移，生成生产环境SQL，并更新schema.sql源文件。

## 涉及的迁移文件

### 1. init-value-added-status-presets.sql
- 功能：初始化状态配置预设数据
- 内容：有效状态（待处理、有效、无效）和结算状态（未结算、已结算）

### 2. add-company-sort-order.sql
- 功能：为外包公司表添加排序字段
- 内容：sort_order（排序）、is_default（是否默认）

### 3. fix-status-configs-safe.sql
- 功能：修复状态配置中的中文value问题
- 内容：删除错误配置，插入正确的英文value配置

### 4. create-price-tier-system.sql
- 功能：创建价格档位系统
- 内容：value_added_price_config表，支持多档位、时间范围、按单/按比例计价

### 5. add-value-added-permissions.sql
- 功能：添加增值管理和结算报表权限
- 内容：15条权限（2个菜单 + 13个按钮）

### 6. production-add-value-added-remark-presets.sql
- 功能：添加备注预设功能
- 内容：value_added_remark_presets表 + 15条预设数据

## 本地数据库迁移状态

### ✅ 已完成
1. 状态配置表和数据 - 6条配置
2. 外包公司排序字段 - sort_order, is_default
3. 价格档位表 - value_added_price_config
4. 备注预设表和数据 - 15条预设（10条无效原因 + 5条通用备注）
5. 订单表备注字段 - remark字段
6. 权限数据 - 15条权限

### 验证结果
```
=== 状态配置 ===
✓ 6条配置（3个有效状态 + 2个结算状态 + 1个已补单）

=== 外包公司字段 ===
✓ sort_order: int
✓ is_default: tinyint

=== 价格档位 ===
✓ 表已创建，支持多档位配置

=== 备注预设 ===
✓ invalid: 10条
✓ general: 5条

=== 订单备注字段 ===
✓ remark: text

=== 权限 ===
✓ 15条权限（财务管理 > 增值管理 + 结算报表）
```

## 生产环境SQL文件

### 文件位置
`backend/database-migrations/production-value-added-complete.sql`

### 特点
1. **自动跳过已存在的表和字段** - 使用 `IF NOT EXISTS` 和动态SQL
2. **支持一次性执行** - 所有SQL语句可以一起执行
3. **包含完整验证** - 执行后自动显示验证结果
4. **分段清晰** - 5个部分，每部分有明确注释

### 执行步骤
```sql
-- 1. 登录宝塔面板 phpMyAdmin
-- 2. 选择 crm_production 数据库
-- 3. 复制整个SQL文件内容
-- 4. 粘贴到SQL执行窗口
-- 5. 点击执行
-- 6. 查看验证结果
```

### SQL内容结构
```
第一部分：状态配置表和数据
  - 创建 value_added_status_configs 表
  - 删除错误的中文value配置
  - 插入正确的状态配置

第二部分：外包公司表字段
  - 添加 sort_order 字段
  - 添加 is_default 字段
  - 创建索引

第三部分：价格档位系统
  - 创建 value_added_price_config 表
  - 从 default_unit_price 迁移数据（如果存在）
  - 删除 default_unit_price 字段

第四部分：备注预设系统
  - 创建 value_added_remark_presets 表
  - 插入15条预设数据
  - 为订单表添加 remark 字段

第五部分：权限配置
  - 创建财务管理父级菜单
  - 添加增值管理菜单和9个按钮权限
  - 添加结算报表菜单和4个按钮权限
```

## schema.sql更新

### 更新内容
在 `database/schema.sql` 文件末尾添加：

1. **增值管理系统表**
   - value_added_orders（增值订单表）
   - outsource_companies（外包公司表）
   - value_added_price_config（价格档位配置表）
   - value_added_status_configs（状态配置表）
   - value_added_remark_presets（备注预设表）

2. **初始数据**
   - 6条状态配置
   - 15条备注预设

### 表结构特点
- 完整的字段注释
- 合理的索引设计
- 支持软删除和时间戳
- 使用 utf8mb4 字符集
- 支持 ON DUPLICATE KEY UPDATE

## 数据库表关系

```
value_added_orders (增值订单)
  ├─ company_id → outsource_companies.id (外包公司)
  ├─ status → value_added_status_configs (有效状态)
  └─ settlement_status → value_added_status_configs (结算状态)

outsource_companies (外包公司)
  └─ id → value_added_price_config.company_id (价格档位)

value_added_price_config (价格档位)
  ├─ company_id → outsource_companies.id
  ├─ pricing_type: fixed/percentage
  └─ 支持时间范围和优先级

value_added_status_configs (状态配置)
  ├─ type: validStatus/settlementStatus
  └─ value: pending/valid/invalid/unsettled/settled

value_added_remark_presets (备注预设)
  ├─ category: invalid/general
  └─ usage_count: 使用次数统计
```

## 权限树结构

```
财务管理 (finance)
├─ 增值管理 (finance.value_added)
│  ├─ 查看增值订单 (finance.value_added.view)
│  ├─ 创建增值订单 (finance.value_added.create)
│  ├─ 编辑增值订单 (finance.value_added.edit)
│  ├─ 删除增值订单 (finance.value_added.delete)
│  ├─ 批量操作订单 (finance.value_added.batch)
│  ├─ 导出订单数据 (finance.value_added.export)
│  ├─ 管理外包公司 (finance.value_added.company)
│  ├─ 配置价格档位 (finance.value_added.price_tier)
│  └─ 配置状态选项 (finance.value_added.status_config)
└─ 结算报表 (finance.settlement_report)
   ├─ 查看结算报表 (finance.settlement_report.view)
   ├─ 导出报表数据 (finance.settlement_report.export)
   ├─ 查看统计图表 (finance.settlement_report.charts)
   └─ 查看公司排名 (finance.settlement_report.ranking)
```

## 注意事项

### 生产环境部署
1. **执行前备份数据库**
2. **在低峰期执行**
3. **执行后清除权限缓存**
4. **要求用户重新登录**

### 字符集问题
- 所有表使用 `utf8mb4_unicode_ci`
- 价格档位表的 company_id 关联需要注意字符集对齐
- 使用 `COLLATE utf8mb4_unicode_ci` 处理关联查询

### 数据迁移
- default_unit_price 字段会自动迁移到价格档位系统
- 迁移后会自动删除 default_unit_price 字段
- 如果字段不存在，会自动跳过

## 相关文件

### 数据库迁移文件
- `backend/database-migrations/init-value-added-status-presets.sql`
- `backend/database-migrations/add-company-sort-order.sql`
- `backend/database-migrations/fix-status-configs-safe.sql`
- `backend/database-migrations/create-price-tier-system.sql`
- `backend/database-migrations/add-value-added-permissions.sql`
- `backend/database-migrations/production-add-value-added-remark-presets.sql`
- `backend/database-migrations/production-value-added-complete.sql` ⭐ 生产环境统一SQL

### 辅助脚本
- `backend/check-value-added-migrations.js` - 检查迁移状态
- `backend/add-permissions-simple.js` - 添加权限
- `backend/execute-price-tier-migration.js` - 价格档位迁移

### Schema文件
- `database/schema.sql` - 数据库完整schema（已更新）

## 完成状态

✅ 本地数据库迁移完成
✅ 生产环境SQL生成完成
✅ schema.sql更新完成
✅ 文档整理完成

## 下一步

1. 将 `production-value-added-complete.sql` 发送给用户
2. 指导用户在生产环境执行
3. 执行后验证功能是否正常
4. 清除权限缓存，要求用户重新登录
