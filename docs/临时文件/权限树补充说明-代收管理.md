# 权限树补充说明 - 代收管理模块

## 修改时间
2026-02-26

## 修改内容

### 1. 权限树补充
在 `src/services/permissionService.js` 的财务管理模块中补充了3个新子菜单：

#### 1.1 代收管理（finance.cod_collection）
- 路径：`/finance/cod-collection`
- 图标：Wallet
- 排序：3
- 操作权限：
  - `finance.cod_collection.view` - 查看代收
  - `finance.cod_collection.export` - 导出代收
  - `finance.cod_collection.edit` - 编辑代收
  - `finance.cod_collection.refund` - 返款操作

#### 1.2 取消代收申请（finance.cod_application）
- 路径：`/finance/my-cod-application`
- 图标：DocumentRemove
- 排序：4
- 操作权限：
  - `finance.cod_application.view` - 查看申请
  - `finance.cod_application.create` - 创建申请
  - `finance.cod_application.cancel` - 撤销申请

#### 1.3 取消代收审核（finance.cod_review）
- 路径：`/finance/cod-application-review`
- 图标：CircleCheck
- 排序：5
- 操作权限：
  - `finance.cod_review.view` - 查看审核
  - `finance.cod_review.approve` - 通过审核
  - `finance.cod_review.reject` - 拒绝审核
  - `finance.cod_review.batch` - 批量审核

### 2. 财务管理模块权限统计

#### 修改前
- 子菜单：2个（绩效数据、绩效管理）
- 操作权限：4个
- 总权限：7个（1个模块 + 2个菜单 + 4个操作）

#### 修改后
- 子菜单：5个（绩效数据、绩效管理、代收管理、取消代收申请、取消代收审核）
- 操作权限：15个
- 总权限：21个（1个模块 + 5个菜单 + 15个操作）

### 3. 权限树自动更新机制

#### 3.1 权限总数统计
在 `src/views/System/Role.vue` 的 `loadRoleStats()` 函数中：
```javascript
const allPermissions = permissionService.getAllPermissions()

// 递归统计所有权限(包括子权限)
const countPermissions = (permissions: any[]): number => {
  let count = 0
  permissions.forEach(perm => {
    count++ // 计数当前权限
    if (perm.children && perm.children.length > 0) {
      count += countPermissions(perm.children) // 递归计数子权限
    }
  })
  return count
}

totalPermissions = countPermissions(allPermissions)
```

这个函数会自动统计 `PERMISSION_TREE` 中的所有权限，包括新增的3个子菜单及其操作权限。

#### 3.2 权限树显示
在角色权限管理页面的两个弹窗中：
- **权限管理按钮**：显示所有权限的明细列表
- **权限设置按钮**：显示权限树，用于勾选角色权限

这两个弹窗都会从 `permissionService.getAllPermissions()` 获取权限数据，因此会自动显示新增的权限。

### 4. 开发环境验证步骤

#### 4.1 清除缓存（重要！）
由于权限数据可能被缓存在 localStorage 中，需要清除缓存：

**方法1：清除特定缓存**
```javascript
// 在浏览器控制台执行
localStorage.removeItem('role_permissions')
localStorage.removeItem('user_permissions')
```

**方法2：使用无痕模式**
- 打开浏览器的无痕/隐私模式
- 重新登录系统

**方法3：清除所有缓存**
```javascript
// 在浏览器控制台执行
localStorage.clear()
```

#### 4.2 验证权限树
1. 登录系统（建议使用超管账号）
2. 进入：系统管理 → 角色权限
3. 查看页面顶部的统计卡片：
   - 权限总数应该增加了14个（3个菜单 + 11个操作）
4. 点击"权限管理"按钮：
   - 在权限明细列表中应该能看到财务管理模块下的5个子菜单
5. 点击任意角色的"权限设置"按钮：
   - 在权限树中展开财务管理节点
   - 应该能看到5个子菜单及其操作权限的勾选框

### 5. 注意事项

#### 5.1 只补充，不修改
- 本次修改只在财务管理模块中新增了3个子菜单
- 没有修改任何现有权限的配置
- 保持了与现有权限结构的一致性

#### 5.2 权限代码规范
- 模块：`finance`
- 子菜单：`finance.{menu_name}`
- 操作权限：`finance.{menu_name}.{action}`

#### 5.3 排序规则
- 绩效数据：sort: 1
- 绩效管理：sort: 2
- 代收管理：sort: 3（新增）
- 取消代收申请：sort: 4（新增）
- 取消代收审核：sort: 5（新增）

### 6. 后续工作

#### 6.1 角色权限分配
需要在 `src/config/defaultRolePermissions.ts` 中为各角色分配新权限：
- 超管/管理员：全部权限
- 部门经理：代收管理（查看）、取消代收申请（创建、查看）
- 销售员：取消代收申请（创建、查看）
- 客服：无权访问

#### 6.2 菜单配置
确认 `src/config/menu.ts` 中已经配置了这3个子菜单的路由。

#### 6.3 生产环境部署
- 部署后，用户首次访问时会自动加载新的权限树
- 如果用户已登录，可能需要重新登录才能看到新权限

## 修改文件
- `src/services/permissionService.js` - 补充权限树

## 验证状态
- [x] 权限树补充完成
- [ ] 开发环境验证
- [ ] 角色权限分配
- [ ] 生产环境部署
