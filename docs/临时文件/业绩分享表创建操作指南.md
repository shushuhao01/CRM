# 业绩分享表创建操作指南

## 问题背景
开发环境访问业绩分享页面报错：`can't access property "map", share.shareMembers is undefined`

**根本原因**：开发环境数据库缺少 `performance_shares` 和 `performance_share_members` 表

## 操作步骤

### 一、开发环境修复（必须执行）

#### 1. 检查表是否存在
打开 Navicat 或其他 MySQL 客户端，连接到开发环境数据库 `crm_local`，执行：

```sql
-- 执行文件：scripts/check-performance-shares-tables.sql
SELECT 
    'performance_shares' as table_name,
    COUNT(*) as table_exists
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'crm_local' 
  AND TABLE_NAME = 'performance_shares';

SELECT 
    'performance_share_members' as table_name,
    COUNT(*) as table_exists
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'crm_local' 
  AND TABLE_NAME = 'performance_share_members';
```

**结果判断**：
- `table_exists = 0`：表不存在，需要创建（继续步骤2）
- `table_exists = 1`：表已存在，检查是否有其他问题

#### 2. 创建缺失的表
如果表不存在，执行创建脚本：

```bash
# 在 Navicat 中执行
scripts/create-performance-shares-tables-dev.sql
```

**执行步骤**：
1. 打开 Navicat
2. 连接到开发环境数据库 `crm_local`
3. 点击"查询" → "新建查询"
4. 复制 `scripts/create-performance-shares-tables-dev.sql` 的内容
5. 点击"运行"
6. 查看执行结果，确认两个表都创建成功

#### 3. 验证修复
1. 无需重启后端服务
2. 清除浏览器缓存（Ctrl+Shift+Delete）
3. 刷新业绩分享页面
4. 确认不再报错

### 二、生产环境检查（可选）

生产环境通常已有这两个表，但为了保险起见，可以检查一下：

#### 1. 登录宝塔面板
访问：https://your-server-ip:8888

#### 2. 进入数据库管理
数据库 → 找到 `crm` 或 `abc789_cn` → 点击"管理"

#### 3. 执行检查SQL
```sql
SELECT 
    TABLE_NAME,
    TABLE_ROWS,
    CREATE_TIME
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = DATABASE()
  AND TABLE_NAME IN ('performance_shares', 'performance_share_members');
```

**结果判断**：
- 有结果：表已存在，无需操作
- 无结果：表不存在，执行 `scripts/create-performance-shares-tables-prod.sql`

## 表结构说明

### performance_shares（业绩分享记录表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(50) | 分享ID（主键）|
| share_number | VARCHAR(50) | 分享编号（唯一）|
| order_id | VARCHAR(50) | 订单ID |
| order_number | VARCHAR(50) | 订单号 |
| order_amount | DECIMAL(10,2) | 订单金额 |
| total_share_amount | DECIMAL(10,2) | 总分享金额 |
| share_count | INT | 分享人数 |
| status | ENUM | 状态：active/completed/cancelled |
| description | TEXT | 分享说明 |
| created_by | VARCHAR(50) | 创建人ID |
| created_by_name | VARCHAR(50) | 创建人姓名 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| completed_at | TIMESTAMP | 完成时间 |
| cancelled_at | TIMESTAMP | 取消时间 |

### performance_share_members（业绩分享成员表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(50) | 成员ID（主键）|
| share_id | VARCHAR(50) | 分享记录ID（外键）|
| user_id | VARCHAR(50) | 用户ID |
| user_name | VARCHAR(50) | 用户姓名 |
| department | VARCHAR(100) | 所属部门 |
| share_percentage | DECIMAL(5,2) | 分享比例 |
| share_amount | DECIMAL(10,2) | 分享金额 |
| status | ENUM | 确认状态：pending/confirmed/rejected |
| confirm_time | TIMESTAMP | 确认时间 |
| reject_reason | TEXT | 拒绝原因 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

## 相关API接口

业绩分享功能使用以下后端API（已实现）：

```
GET  /api/v1/performance/shares          # 获取业绩分享列表
GET  /api/v1/performance/shares/:id      # 获取详情
POST /api/v1/performance/shares          # 创建分享
DELETE /api/v1/performance/shares/:id    # 取消分享
POST /api/v1/performance/shares/:id/confirm  # 确认分享
GET  /api/v1/performance/stats           # 获取统计数据
```

## 常见问题

### Q1: 执行SQL脚本时报错"表已存在"
**A**: 说明表已经存在，无需重复创建。可以直接刷新页面测试。

### Q2: 创建表后仍然报错
**A**: 请检查：
1. 是否清除了浏览器缓存
2. 数据库名称是否正确（开发环境应该是 `crm_local`）
3. 后端服务是否正常运行
4. 浏览器控制台是否有其他错误信息

### Q3: 生产环境需要执行吗？
**A**: 通常不需要。生产环境正常说明表已存在。但如果生产环境也报错，可以按照相同步骤检查和创建。

### Q4: 会影响现有数据吗？
**A**: 不会。这是创建新表，不会影响现有的订单、客户等数据。

### Q5: 需要重启后端服务吗？
**A**: 不需要。创建表后直接刷新页面即可。

## 注意事项

1. ⚠️ 执行SQL脚本前请确认数据库名称正确
2. ⚠️ 生产环境操作前请先备份数据库
3. ⚠️ 如果表已存在，不要重复执行创建脚本
4. ✅ 开发环境可以放心执行，不会影响现有数据
5. ✅ 创建表后无需重启服务

## 相关文件
- `scripts/check-performance-shares-tables.sql` - 检查脚本
- `scripts/create-performance-shares-tables-dev.sql` - 开发环境创建脚本
- `scripts/create-performance-shares-tables-prod.sql` - 生产环境创建脚本
- `docs/临时文件/业绩分享报错问题分析.md` - 详细问题分析
- `backend/src/routes/performance.ts` - 后端API实现
- `database/schema.sql` - 完整数据库结构（第1093-1139行）

## 执行记录

### 开发环境
- [ ] 已检查表是否存在
- [ ] 已执行创建脚本
- [ ] 已验证页面正常
- [ ] 执行人：________
- [ ] 执行时间：________

### 生产环境
- [ ] 已检查表是否存在（通常已存在）
- [ ] 无需操作
- [ ] 检查人：________
- [ ] 检查时间：________
