# 代收取消申请500错误 - 完整故障排查指南

## 当前状态

✅ 数据库表存在且可以正常插入数据
✅ 实体定义已修复（json类型）
✅ 权限控制已修复
✅ 前端代码正常

❓ 后端服务可能未重启或有其他错误

## 立即执行的步骤

### 步骤1：重启后端服务

1. 找到运行后端的终端窗口
2. 按 `Ctrl + C` 停止后端服务
3. 等待完全停止（看到命令提示符）
4. 重新启动：
   ```bash
   cd backend
   npm run dev
   ```

### 步骤2：观察启动日志

后端启动时应该看到类似输出：

```
✅ 数据库连接成功
✅ 服务器启动成功
🚀 服务器运行在 http://localhost:3000
```

如果看到错误，请记录下来。

### 步骤3：测试提交申请

1. 刷新浏览器页面（F5）
2. 进入"代收取消申请"页面
3. 点击"发起申请"
4. 选择订单并填写信息
5. 点击"提交申请"

### 步骤4：查看后端控制台

提交申请时，后端控制台应该输出：

```
[CodApplication] 权限检查: {
  userId: 'admin',
  username: 'admin',
  userRole: 'admin',
  isAdmin: true,
  orderCreatedBy: 'xxx',
  canApply: true
}
```

如果出现错误，会输出：

```
[CodApplication] Create error: Error: ...
[CodApplication] Error stack: ...
[CodApplication] Error message: ...
```

## 可能的错误原因和解决方案

### 错误1：后端未重启

**症状**：修改代码后没有重启后端

**解决**：
```bash
# 停止后端（Ctrl+C）
# 重新启动
cd backend
npm run dev
```

### 错误2：端口被占用

**症状**：
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决**：
```bash
# Windows
netstat -ano | findstr :3000
taskkill /PID <进程ID> /F

# 或者修改端口
# 在 backend/.env.local 中修改 PORT=3001
```

### 错误3：数据库连接失败

**症状**：
```
Error: connect ECONNREFUSED
```

**解决**：
1. 确认MySQL服务正在运行
2. 检查 `backend/.env.local` 中的数据库配置
3. 测试数据库连接：
   ```bash
   cd backend
   node test-cod-insert.js
   ```

### 错误4：TypeORM实体同步问题

**症状**：
```
Error: ER_BAD_FIELD_ERROR: Unknown column 'xxx'
```

**解决**：
```sql
-- 检查表结构
DESCRIBE cod_cancel_applications;

-- 如果字段类型不对，修改
ALTER TABLE cod_cancel_applications 
MODIFY COLUMN payment_proof JSON DEFAULT NULL;
```

### 错误5：JSON序列化错误

**症状**：
```
Error: Cannot convert undefined or null to object
```

**解决**：检查前端发送的数据格式，确保 `paymentProof` 是数组。

### 错误6：权限验证错误

**症状**：
```
Error: Cannot read property 'role' of undefined
```

**解决**：检查JWT token是否有效，重新登录。

## 调试技巧

### 1. 查看完整的请求数据

在 `backend/src/routes/codApplication.ts` 的 `create` 接口开头添加：

```typescript
console.log('[CodApplication] 收到创建请求:', {
  body: req.body,
  user: (req as any).user
});
```

### 2. 逐步调试

在代码中添加更多日志：

```typescript
console.log('[CodApplication] 1. 开始处理');
console.log('[CodApplication] 2. 查询订单');
console.log('[CodApplication] 3. 权限检查');
console.log('[CodApplication] 4. 创建申请对象');
console.log('[CodApplication] 5. 保存到数据库');
```

### 3. 使用Postman测试

创建一个POST请求：

```
URL: http://localhost:3000/api/v1/cod-application/create
Method: POST
Headers:
  Authorization: Bearer <你的token>
  Content-Type: application/json
Body:
{
  "orderId": "订单ID",
  "modifiedCodAmount": 0,
  "cancelReason": "测试原因",
  "paymentProof": ["/uploads/cod-proof/test.png"]
}
```

### 4. 检查数据库日志

如果使用MySQL，可以开启查询日志：

```sql
SET GLOBAL general_log = 'ON';
SET GLOBAL log_output = 'TABLE';
SELECT * FROM mysql.general_log ORDER BY event_time DESC LIMIT 10;
```

## 常见问题FAQ

### Q1: 为什么测试脚本能插入，但后端报错？

A: 可能是TypeORM的实体映射问题。检查：
- 实体类是否正确导入
- 字段类型是否匹配
- 是否有必填字段未提供

### Q2: 如何确认后端是否真的重启了？

A: 查看后端控制台的启动时间戳，或者修改代码添加一个明显的日志。

### Q3: 如何查看完整的错误堆栈？

A: 在catch块中使用：
```typescript
console.error('[CodApplication] 完整错误:', JSON.stringify(error, null, 2));
```

### Q4: 前端显示500，但后端没有任何日志？

A: 可能是：
1. 请求没有到达后端（检查网络）
2. 中间件拦截了请求（检查认证中间件）
3. 路由配置错误（检查路由注册）

## 下一步行动

如果按照以上步骤仍然无法解决，请提供：

1. **后端控制台的完整输出**（从启动到报错）
2. **浏览器Network标签的详细信息**：
   - Request Headers
   - Request Payload
   - Response
3. **后端日志文件**：
   ```bash
   # 查看最近的错误日志
   tail -n 100 backend/logs/error.log
   tail -n 100 backend/logs/combined.log
   ```

## 快速测试命令

```bash
# 1. 测试数据库连接和插入
cd backend
node test-cod-insert.js

# 2. 检查后端进程
netstat -ano | findstr :3000

# 3. 查看最近的日志
Get-Content backend/logs/combined.log -Tail 50

# 4. 重启后端
# Ctrl+C 停止
npm run dev
```

## 成功的标志

当一切正常时，你应该看到：

1. ✅ 后端启动无错误
2. ✅ 提交申请时后端输出权限检查日志
3. ✅ 前端显示"申请提交成功，等待审核"
4. ✅ 数据库中有新记录
5. ✅ 申请列表中显示新申请

## 联系支持

如果问题持续存在，请提供：
- 操作系统版本
- Node.js版本（`node -v`）
- MySQL版本
- 完整的错误日志
- 重现步骤
