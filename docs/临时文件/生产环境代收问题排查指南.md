# 生产环境代收问题排查指南

## 问题描述

**开发环境：** ✅ 功能正常
- 未改代收的订单不显示"已改"标识
- 发起取消代收申请时，当前代收金额正确
- 代收管理中的代收金额正确

**生产环境：** ❌ 功能异常
- 未改代收的订单显示"已改"标识
- 发起取消代收申请时，当前代收金额为 0
- 代收管理中的代收金额为 0

## 可能的原因

### 1. 数据库字段缺失或不一致
生产环境的 `orders` 表可能缺少以下字段：
- `cod_amount` - 代收金额（可修改）
- `cod_modified` - 是否修改过代收金额

### 2. 数据迁移问题
如果字段存在但数据为空：
- `cod_amount` 字段值为 NULL 或 0
- `cod_modified` 字段值异常（应该为 0 但是为 1）

### 3. 数据库版本差异
- 开发环境和生产环境使用不同版本的数据库
- 字段类型或默认值不一致

### 4. 代码部署问题
- 后端代码未正确部署
- 环境变量配置不一致
- 数据库连接配置错误

## 排查步骤

### 步骤1：执行诊断脚本

在生产环境的数据库中执行以下脚本：

```bash
# 文件位置：scripts/diagnose-production-cod-issue.sql
```

**请截图以下所有结果：**
1. orders 表的 cod 相关字段列表
2. 最近 10 条订单数据
3. 代收数据统计
4. 问题订单列表
5. 取消代收申请表数据

### 步骤2：对比开发环境

在开发环境执行相同的诊断脚本，对比结果差异。

### 步骤3：检查后端日志

查看生产环境后端日志，搜索以下关键词：
- `cod_amount`
- `codAmount`
- `代收金额`
- `订单创建`

### 步骤4：检查前端请求

使用浏览器开发者工具，检查：
1. 订单列表 API 返回的数据
2. 订单详情 API 返回的数据
3. 代收申请 API 的请求参数

## 常见问题及解决方案

### 问题A：cod_amount 字段不存在

**症状：**
- 所有订单的代收金额都为 0 或 NULL
- 发起取消代收申请时获取不到当前代收金额

**解决方案：**
```sql
-- 添加 cod_amount 字段
ALTER TABLE orders 
ADD COLUMN cod_amount DECIMAL(10,2) DEFAULT NULL 
COMMENT '代收金额（可修改）';

-- 初始化现有订单的代收金额
UPDATE orders 
SET cod_amount = total_amount - IFNULL(deposit_amount, 0)
WHERE cod_amount IS NULL 
    AND status IN ('pending', 'confirmed', 'paid', 'pending_shipment', 'shipped');
```

### 问题B：cod_modified 字段不存在或值异常

**症状：**
- 所有订单都显示"已改代收"标识
- 或者没有订单显示"已改代收"标识

**解决方案：**
```sql
-- 添加 cod_modified 字段（如果不存在）
ALTER TABLE orders 
ADD COLUMN cod_modified TINYINT(1) DEFAULT 0 
COMMENT '是否修改过代收金额';

-- 重置所有订单的 cod_modified 为 0
UPDATE orders 
SET cod_modified = 0
WHERE cod_modified IS NULL OR cod_modified != 0;
```

### 问题C：数据不一致

**症状：**
- cod_amount 为 0 但 cod_modified 为 1
- 订单显示"已改代收"但实际没有改过

**解决方案：**
```sql
-- 修复数据不一致
UPDATE orders 
SET 
    cod_amount = total_amount - IFNULL(deposit_amount, 0),
    cod_modified = 0
WHERE (cod_amount = 0 OR cod_amount IS NULL) 
    AND cod_modified = 1
    AND status IN ('pending', 'confirmed', 'paid', 'pending_shipment', 'shipped');
```

### 问题D：后端代码未更新

**症状：**
- 数据库字段正确，但功能仍然异常
- 后端日志显示旧的逻辑

**解决方案：**
1. 确认后端代码已正确部署
2. 重启后端服务
3. 清除 Node.js 缓存：`rm -rf node_modules && npm install`
4. 检查 PM2 进程：`pm2 restart all`

## 完整修复流程

### 1. 备份数据库
```bash
# 在宝塔面板或命令行执行
mysqldump -u root -p crm_database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 执行诊断脚本
```bash
# 上传 scripts/diagnose-production-cod-issue.sql 到服务器
# 在数据库管理工具中执行
```

### 3. 根据诊断结果执行修复
```bash
# 如果确认需要修复，执行：
# scripts/fix-production-cod-issue.sql
```

### 4. 验证修复结果
- 创建新订单，检查代收金额是否正确
- 发起取消代收申请，检查当前代收金额是否正确
- 查看订单列表，检查"已改代收"标识是否正确

### 5. 重启服务
```bash
# 重启后端服务
pm2 restart crm-backend

# 重启前端服务（如果需要）
pm2 restart crm-frontend
```

## 预防措施

### 1. 数据库迁移脚本
创建标准的数据库迁移脚本，确保开发和生产环境一致。

### 2. 部署检查清单
- [ ] 数据库结构已更新
- [ ] 后端代码已部署
- [ ] 前端代码已构建并部署
- [ ] 环境变量已配置
- [ ] 服务已重启
- [ ] 功能已测试

### 3. 监控和日志
- 启用详细的后端日志
- 监控数据库查询性能
- 记录关键业务操作

## 联系支持

如果以上步骤无法解决问题，请提供：
1. 诊断脚本的完整截图
2. 后端日志（最近 100 行）
3. 浏览器控制台的错误信息
4. 数据库版本信息

## 附录：关键代码位置

### 后端
- 订单创建逻辑：`backend/src/routes/orders.ts`
- 代收申请逻辑：`backend/src/routes/codApplication.ts`
- 代收管理逻辑：`backend/src/routes/codCollection.ts`

### 前端
- 订单列表：`src/views/Order/List.vue`
- 订单详情：`src/views/Order/Detail.vue`
- 代收申请：`src/views/Finance/MyCodApplication.vue`
- 代收管理：`src/views/Finance/CodCollection.vue`

### 数据库
- 表结构定义：`backend/database-schema.sql`
- 初始化脚本：`backend/database-init.sql`
