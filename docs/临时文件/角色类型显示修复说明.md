# 角色类型显示修复说明

## 问题描述

5个系统预设角色（超级管理员、管理员、部门经理、销售员、客服）在前端显示为"自定义角色"，而不是"系统角色"。

## 问题原因

1. **数据库已正确更新**：`roleType` 字段已经设置为 `system`
2. **后端查询遗漏字段**：后端查询角色列表时，SQL 语句中没有包含 `roleType` 字段
3. **前端默认值处理**：前端代码中使用了 `roleType || 'custom'`，导致未返回的字段默认显示为"自定义角色"

## 修复方案

### 1. 修复后端查询 SQL

在两个地方添加 `roleType` 字段：

#### 修复1：角色列表查询

**文件**：`backend/src/controllers/RoleController.ts`

**修复前**：
```typescript
const roles = await dataSource.query(
  `SELECT id, name, code, description, status, level, color, permissions, data_scope as dataScope, created_at as createdAt, updated_at as updatedAt
   FROM roles ${whereClause} ORDER BY level ASC, created_at DESC LIMIT ? OFFSET ?`,
  [...params, Number(limit), offset]
);
```

**修复后**：
```typescript
const roles = await dataSource.query(
  `SELECT id, name, code, description, status, level, color, permissions, roleType, data_scope as dataScope, created_at as createdAt, updated_at as updatedAt
   FROM roles ${whereClause} ORDER BY level ASC, created_at DESC LIMIT ? OFFSET ?`,
  [...params, Number(limit), offset]
);
```

#### 修复2：角色详情查询

**文件**：`backend/src/controllers/RoleController.ts`

**修复前**：
```typescript
const roles = await dataSource.query(
  'SELECT id, name, code, description, status, level, color, permissions, data_scope as dataScope, created_at as createdAt, updated_at as updatedAt FROM roles WHERE id = ?',
  [id]
);
```

**修复后**：
```typescript
const roles = await dataSource.query(
  'SELECT id, name, code, description, status, level, color, permissions, roleType, data_scope as dataScope, created_at as createdAt, updated_at as updatedAt FROM roles WHERE id = ?',
  [id]
);
```

## 验证步骤

### 1. 重启后端服务

```bash
cd backend
npm run dev
```

### 2. 清除浏览器缓存

- 按 `Ctrl + Shift + Delete`（Windows）或 `Cmd + Shift + Delete`（Mac）
- 选择"缓存的图片和文件"
- 点击"清除数据"

或者使用硬刷新：
- 按 `Ctrl + F5`（Windows）或 `Cmd + Shift + R`（Mac）

### 3. 刷新前端页面

1. 登录系统
2. 进入"系统管理" -> "角色权限"
3. 查看角色列表的"角色类型"列

**预期结果**：
| 角色名称 | 角色编码 | 角色类型 |
|---------|---------|---------|
| SuperAdmin | super_admin | 系统角色 |
| 管理员 | admin | 系统角色 |
| 部门经理 | department_manager | 系统角色 |
| 销售员 | sales_staff | 系统角色 |
| 客服 | customer_service | 系统角色 |

### 4. 验证下拉框状态

- 系统预设角色的类型下拉框应该是禁用状态（灰色）
- 自定义角色的类型下拉框应该可以点击

## 数据库验证

如果前端还是显示"自定义角色"，可以直接查询数据库确认：

```sql
SELECT id, name, code, roleType, status 
FROM roles 
WHERE code IN ('super_admin', 'admin', 'department_manager', 'sales_staff', 'customer_service');
```

**预期结果**：所有角色的 `roleType` 字段都应该是 `system`

## 故障排查

### 问题1：前端仍显示"自定义角色"

**可能原因**：
1. 后端服务未重启
2. 浏览器缓存未清除
3. 前端代码未更新

**解决方案**：
1. 重启后端服务
2. 清除浏览器缓存并硬刷新
3. 检查后端日志，确认 SQL 查询包含 `roleType` 字段

### 问题2：数据库中 roleType 为 NULL

**可能原因**：数据库迁移脚本未执行

**解决方案**：
```bash
# 执行迁移脚本
node backend/scripts/update-system-roles-type.js

# 或者直接执行 SQL
mysql -h localhost -u abc789 -p crm_local < backend/database-migrations/update-system-roles-type.sql
```

### 问题3：新创建的角色显示为 NULL

**可能原因**：创建角色时未设置 `roleType` 字段

**解决方案**：检查 `RoleController.ts` 的 `createRole` 方法，确保包含 `roleType` 字段

## 相关文件

- `backend/src/controllers/RoleController.ts` - 角色控制器（已修复）
- `backend/scripts/update-system-roles-type.js` - 数据库迁移脚本
- `backend/database-migrations/update-system-roles-type.sql` - SQL 迁移脚本
- `src/views/System/Role.vue` - 前端角色管理页面

## 注意事项

1. **后端服务必须重启**：修改后端代码后，必须重启服务才能生效
2. **清除浏览器缓存**：前端可能缓存了旧数据，需要清除缓存
3. **数据库字段必须存在**：确保 `roles` 表中有 `roleType` 字段
4. **生产环境同步**：修复后，需要同步部署到生产环境

---

**修复时间**：2026-02-26
**修复人员**：Kiro AI Assistant
**测试状态**：待用户验证
