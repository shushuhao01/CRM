# 外包公司价格配置重构设计

## 设计时间
2026-03-01

## 需求背景
1. 删除独立的"费用配置"功能
2. 将价格配置集成到外包公司管理中
3. 支持多档位价格（按时间生效）
4. 支持两种计价方式：按单计价、按比例计价

## 数据库设计

### 1. 修改 outsource_companies 表
保持现有结构，`default_unit_price` 字段作为默认/兜底价格

### 2. 重新设计 value_added_price_config 表
```sql
CREATE TABLE `value_added_price_config` (
  `id` VARCHAR(50) NOT NULL COMMENT '配置ID',
  `company_id` VARCHAR(50) NOT NULL COMMENT '外包公司ID',
  `tier_name` VARCHAR(100) NOT NULL COMMENT '档位名称（如：第一档、春节档）',
  `tier_order` INT DEFAULT 1 COMMENT '档位排序',
  
  -- 计价方式
  `pricing_type` VARCHAR(20) NOT NULL DEFAULT 'fixed' COMMENT '计价方式：fixed=按单计价, percentage=按比例计价',
  `unit_price` DECIMAL(10,2) DEFAULT 0 COMMENT '按单计价：固定单价',
  `percentage_rate` DECIMAL(5,2) DEFAULT 0 COMMENT '按比例计价：百分比（如5.5表示5.5%）',
  `base_amount_field` VARCHAR(50) DEFAULT 'orderAmount' COMMENT '按比例计价的基数字段',
  
  -- 生效时间
  `start_date` DATE NULL COMMENT '开始日期',
  `end_date` DATE NULL COMMENT '结束日期',
  `is_active` TINYINT DEFAULT 1 COMMENT '是否启用',
  
  -- 优先级和条件
  `priority` INT DEFAULT 0 COMMENT '优先级（数字越大优先级越高）',
  `condition_rules` TEXT NULL COMMENT '条件规则JSON（预留扩展）',
  
  `remark` TEXT NULL COMMENT '备注',
  `created_by` VARCHAR(50) NULL,
  `created_by_name` VARCHAR(100) NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_company_id` (`company_id`),
  KEY `idx_date_range` (`start_date`, `end_date`),
  KEY `idx_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='增值服务价格配置表';
```

## 价格计算逻辑

### 优先级规则
1. 查找当前日期在生效范围内的所有配置
2. 按 `priority` 降序排序
3. 取第一条匹配的配置
4. 如果没有匹配，使用公司的 `default_unit_price`
5. 如果是"待分配"，单价为0

### 计价方式

#### 1. 按单计价（fixed）
```typescript
settlementAmount = unitPrice
```

#### 2. 按比例计价（percentage）
```typescript
settlementAmount = baseAmount * (percentageRate / 100)
```

例如：
- 订单金额 ¥1000
- 比例 5.5%
- 结算金额 = 1000 * 0.055 = ¥55

## 前端UI设计

### 外包公司管理弹窗

#### 主列表调整
```
列宽调整：
- 排序: 70px
- 公司名称: 180px（增加宽度）
- 联系人: 100px
- 联系电话: 130px
- 默认单价: 100px
- 总订单数: 90px
- 有效订单: 90px
- 总金额: 120px
- 状态: 90px（增加宽度，显示完整）
- 操作: 240px
```

#### 新增/编辑公司表单
```
基本信息：
- 公司名称 *
- 联系人
- 联系电话
- 联系邮箱
- 地址
- 默认单价 *（兜底价格）
- 状态
- 备注

价格配置：
[档位列表表格]
- 档位名称 | 计价方式 | 单价/比例 | 开始日期 | 结束日期 | 优先级 | 状态 | 操作
[+ 添加档位] 按钮
```

#### 添加/编辑档位弹窗
```
档位名称: [输入框] *
计价方式: [单选] 按单计价 / 按比例计价 *

[按单计价时显示]
  固定单价: [数字输入] 元/单 *

[按比例计价时显示]
  比例: [数字输入] % *
  基数字段: [下拉选择] 订单金额 / 代收金额 / 商品金额

生效时间:
  开始日期: [日期选择]
  结束日期: [日期选择]

优先级: [数字输入] (数字越大优先级越高)
状态: [单选] 启用 / 停用
备注: [文本域]
```

## API接口设计

### 1. 获取公司价格配置列表
```
GET /api/v1/value-added/companies/:companyId/price-tiers
```

### 2. 创建价格档位
```
POST /api/v1/value-added/companies/:companyId/price-tiers
Body: {
  tierName, pricingType, unitPrice, percentageRate,
  startDate, endDate, priority, isActive, remark
}
```

### 3. 更新价格档位
```
PUT /api/v1/value-added/companies/:companyId/price-tiers/:tierId
```

### 4. 删除价格档位
```
DELETE /api/v1/value-added/companies/:companyId/price-tiers/:tierId
```

### 5. 计算订单价格（内部使用）
```typescript
function calculateOrderPrice(order, company, priceConfigs) {
  // 1. 待分配
  if (order.companyId === 'default-company') {
    return 0;
  }
  
  // 2. 查找匹配的价格配置
  const matchedConfig = findMatchingPriceConfig(
    priceConfigs, 
    order.orderDate
  );
  
  // 3. 根据配置计算
  if (matchedConfig) {
    if (matchedConfig.pricingType === 'fixed') {
      return matchedConfig.unitPrice;
    } else {
      const baseAmount = order[matchedConfig.baseAmountField] || 0;
      return baseAmount * (matchedConfig.percentageRate / 100);
    }
  }
  
  // 4. 使用默认单价
  return company.defaultUnitPrice || 0;
}
```

## 实现步骤

### 阶段1：数据库迁移
1. 修改 `value_added_price_config` 表结构
2. 清理旧的价格配置数据
3. 创建本地和生产环境迁移脚本

### 阶段2：后端实现
1. 更新 PriceConfig 实体
2. 实现价格档位 CRUD 接口
3. 实现价格计算逻辑
4. 更新订单同步时的价格计算

### 阶段3：前端实现
1. 删除独立的"费用配置"按钮和弹窗
2. 重新设计外包公司管理弹窗
3. 实现价格档位管理界面
4. 调整列宽，优化显示
5. 修复待分配单价显示问题

### 阶段4：测试验证
1. 测试价格计算逻辑
2. 测试档位优先级
3. 测试时间范围匹配
4. 测试两种计价方式

## 注意事项

1. **向后兼容**：保留 `default_unit_price` 作为兜底价格
2. **性能优化**：价格配置查询需要缓存
3. **数据迁移**：现有订单的单价不受影响
4. **权限控制**：价格配置修改需要财务权限
5. **审计日志**：记录价格配置的变更历史

## 用户体验优化

1. **档位预设模板**：提供常用档位模板（如节假日档、促销档）
2. **价格预览**：显示当前日期会使用哪个档位
3. **冲突检测**：同一时间段多个档位时提示优先级
4. **批量导入**：支持Excel批量导入价格档位
5. **价格历史**：查看历史价格变更记录
