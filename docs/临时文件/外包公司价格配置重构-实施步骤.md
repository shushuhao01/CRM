# å¤–åŒ…å…¬å¸ä»·æ ¼é…ç½®é‡æ„ - å®æ–½æ­¥éª¤

## å½“å‰è¿›åº¦

### âœ… å·²å®Œæˆ
1. æ•°æ®åº“è¿ç§»è„šæœ¬
   - `backend/database-migrations/redesign-price-config-table.sql`
   - `backend/database-migrations/production-redesign-price-config.sql`

2. åç«¯å®ä½“æ›´æ–°
   - `backend/src/entities/ValueAddedPriceConfig.ts` - å·²æ›´æ–°ä¸ºå¤šæ¡£ä½ç»“æ„

3. åç«¯APIå®ç°
   - `backend/src/routes/valueAdded.ts` - å·²æ·»åŠ ä»·æ ¼æ¡£ä½CRUDæ¥å£
   - å·²å®ç°ä»·æ ¼è®¡ç®—é€»è¾‘å‡½æ•°

4. å‰ç«¯APIæ¥å£
   - `src/api/valueAdded.ts` - å·²æ·»åŠ ä»·æ ¼æ¡£ä½æ¥å£å’Œç±»å‹å®šä¹‰

5. å‰ç«¯ç»„ä»¶
   - `src/views/Finance/components/PriceTierDialog.vue` - ä»·æ ¼æ¡£ä½æ·»åŠ /ç¼–è¾‘å¼¹çª—

### ğŸ”„ å¾…å®Œæˆ

#### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
# æœ¬åœ°ç¯å¢ƒ
cd backend
mysql -u abc789 -p crm_local < database-migrations/redesign-price-config-table.sql

# ç”Ÿäº§ç¯å¢ƒï¼ˆå®å¡”phpMyAdminï¼‰
# å¤åˆ¶ production-redesign-price-config.sql å†…å®¹åˆ°phpMyAdminæ‰§è¡Œ
```

#### 2. æ›´æ–° ValueAddedManage.vue

éœ€è¦è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

##### 2.1 åˆ é™¤è´¹ç”¨é…ç½®ç›¸å…³ä»£ç 
- åˆ é™¤"è´¹ç”¨é…ç½®"æŒ‰é’®ï¼ˆç¬¬145è¡Œï¼‰
- åˆ é™¤å¤–åŒ…å…¬å¸åˆ—è¡¨ä¸­çš„"è´¹ç”¨é…ç½®"æŒ‰é’®ï¼ˆç¬¬323è¡Œï¼‰
- åˆ é™¤è´¹ç”¨ç®¡ç†å¼¹çª—ï¼ˆç¬¬369-395è¡Œï¼‰
- åˆ é™¤è´¹ç”¨é…ç½®å¼¹çª—ï¼ˆç¬¬397-422è¡Œï¼‰
- åˆ é™¤æ·»åŠ /ç¼–è¾‘è´¹ç”¨é…ç½®å¼¹çª—ï¼ˆç¬¬425-458è¡Œï¼‰
- åˆ é™¤ç›¸å…³çš„å“åº”å¼å˜é‡å’Œå‡½æ•°ï¼š
  - `priceConfigs`
  - `priceConfigDialogVisible`
  - `priceManageDialogVisible`
  - `addPriceDialogVisible`
  - `editingPrice`
  - `currentCompanyId`
  - `priceForm`
  - `showPriceManageDialog()`
  - `showPriceConfigDialog()`
  - `handlePriceConfigDialogClose()`
  - `showAddPriceDialog()`
  - `editPriceConfig()`
  - `savePriceConfig()`

##### 2.2 è°ƒæ•´å¤–åŒ…å…¬å¸ç®¡ç†å¼¹çª—åˆ—å®½
```vue
<el-table-column prop="sortOrder" label="æ’åº" width="70" align="center" />
<el-table-column prop="companyName" label="å…¬å¸åç§°" min-width="180">  <!-- å¢åŠ å®½åº¦ -->
<el-table-column prop="contactPerson" label="è”ç³»äºº" width="100" />
<el-table-column prop="contactPhone" label="è”ç³»ç”µè¯" width="130" />  <!-- å¢åŠ å®½åº¦ -->
<el-table-column prop="defaultUnitPrice" label="é»˜è®¤å•ä»·" width="100" align="right" />
<el-table-column prop="totalOrders" label="æ€»è®¢å•æ•°" width="90" align="center" />
<el-table-column prop="validOrders" label="æœ‰æ•ˆè®¢å•" width="90" align="center" />
<el-table-column prop="totalAmount" label="æ€»é‡‘é¢" width="120" align="right" />
<el-table-column prop="status" label="çŠ¶æ€" width="90">  <!-- å¢åŠ å®½åº¦ -->
<el-table-column label="æ“ä½œ" width="240" fixed="right">
```

##### 2.3 åœ¨å¤–åŒ…å…¬å¸ç®¡ç†å¼¹çª—ä¸­æ·»åŠ ä»·æ ¼æ¡£ä½ç®¡ç†
åœ¨å¤–åŒ…å…¬å¸åˆ—è¡¨çš„æ“ä½œåˆ—ä¸­ï¼Œå°†"è´¹ç”¨é…ç½®"æŒ‰é’®æ”¹ä¸º"ä»·æ ¼æ¡£ä½"æŒ‰é’®ï¼š
```vue
<el-button type="primary" link size="small" @click="showPriceTiersDialog(row)">ä»·æ ¼æ¡£ä½</el-button>
```

##### 2.4 æ·»åŠ ä»·æ ¼æ¡£ä½ç®¡ç†å¼¹çª—
```vue
<!-- ä»·æ ¼æ¡£ä½ç®¡ç†å¼¹çª— -->
<el-dialog v-model="priceTiersDialogVisible" title="ä»·æ ¼æ¡£ä½ç®¡ç†" width="1200px">
  <div class="price-tiers-header">
    <div class="company-info">
      <span class="company-name">{{ currentCompany?.companyName }}</span>
      <span class="default-price">é»˜è®¤å•ä»·ï¼šÂ¥{{ formatMoney(currentCompany?.defaultUnitPrice) }}</span>
    </div>
    <el-button type="primary" :icon="Plus" @click="showAddTierDialog">æ·»åŠ æ¡£ä½</el-button>
  </div>
  
  <el-table :data="priceTiers" stripe border>
    <el-table-column prop="tierOrder" label="æ’åº" width="70" align="center" />
    <el-table-column prop="tierName" label="æ¡£ä½åç§°" min-width="120" />
    <el-table-column prop="pricingType" label="è®¡ä»·æ–¹å¼" width="110">
      <template #default="{ row }">
        <el-tag :type="row.pricingType === 'fixed' ? 'success' : 'warning'" size="small">
          {{ row.pricingType === 'fixed' ? 'æŒ‰å•è®¡ä»·' : 'æŒ‰æ¯”ä¾‹è®¡ä»·' }}
        </el-tag>
      </template>
    </el-table-column>
    <el-table-column label="å•ä»·/æ¯”ä¾‹" width="120" align="right">
      <template #default="{ row }">
        <span v-if="row.pricingType === 'fixed'">Â¥{{ formatMoney(row.unitPrice) }}</span>
        <span v-else>{{ row.percentageRate }}%</span>
      </template>
    </el-table-column>
    <el-table-column prop="baseAmountField" label="åŸºæ•°å­—æ®µ" width="100" v-if="false">
      <template #default="{ row }">
        <span v-if="row.pricingType === 'percentage'">
          {{ row.baseAmountField === 'orderAmount' ? 'è®¢å•é‡‘é¢' : row.baseAmountField }}
        </span>
        <span v-else>-</span>
      </template>
    </el-table-column>
    <el-table-column prop="startDate" label="å¼€å§‹æ—¥æœŸ" width="110" />
    <el-table-column prop="endDate" label="ç»“æŸæ—¥æœŸ" width="110" />
    <el-table-column prop="priority" label="ä¼˜å…ˆçº§" width="80" align="center" />
    <el-table-column prop="isActive" label="çŠ¶æ€" width="80">
      <template #default="{ row }">
        <el-tag :type="row.isActive === 1 ? 'success' : 'info'" size="small">
          {{ row.isActive === 1 ? 'å¯ç”¨' : 'åœç”¨' }}
        </el-tag>
      </template>
    </el-table-column>
    <el-table-column label="æ“ä½œ" width="120" fixed="right">
      <template #default="{ row }">
        <el-button type="primary" link size="small" @click="editTier(row)">ç¼–è¾‘</el-button>
        <el-button type="danger" link size="small" @click="deleteTier(row)">åˆ é™¤</el-button>
      </template>
    </el-table-column>
  </el-table>
</el-dialog>

<!-- ä»·æ ¼æ¡£ä½æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
<PriceTierDialog
  v-model:visible="tierDialogVisible"
  :company-id="currentCompany?.id || ''"
  :tier="editingTier"
  @saved="loadPriceTiers"
/>
```

##### 2.5 æ·»åŠ ç›¸å…³çš„å“åº”å¼å˜é‡å’Œå‡½æ•°
```typescript
// ä»·æ ¼æ¡£ä½ç®¡ç†
const priceTiersDialogVisible = ref(false)
const tierDialogVisible = ref(false)
const priceTiers = ref<PriceTier[]>([])
const currentCompany = ref<OutsourceCompany | null>(null)
const editingTier = ref<PriceTier | null>(null)

// æ˜¾ç¤ºä»·æ ¼æ¡£ä½ç®¡ç†å¼¹çª—
const showPriceTiersDialog = async (company: OutsourceCompany) => {
  currentCompany.value = company
  await loadPriceTiers()
  priceTiersDialogVisible.value = true
}

// åŠ è½½ä»·æ ¼æ¡£ä½åˆ—è¡¨
const loadPriceTiers = async () => {
  if (!currentCompany.value) return
  
  try {
    const { getCompanyPriceTiers } = await import('@/api/valueAdded')
    const res = await getCompanyPriceTiers(currentCompany.value.id) as any
    priceTiers.value = res?.data || res || []
  } catch (e) {
    console.error('åŠ è½½ä»·æ ¼æ¡£ä½å¤±è´¥:', e)
    ElMessage.error('åŠ è½½ä»·æ ¼æ¡£ä½å¤±è´¥')
  }
}

// æ˜¾ç¤ºæ·»åŠ æ¡£ä½å¼¹çª—
const showAddTierDialog = () => {
  editingTier.value = null
  tierDialogVisible.value = true
}

// ç¼–è¾‘æ¡£ä½
const editTier = (tier: PriceTier) => {
  editingTier.value = tier
  tierDialogVisible.value = true
}

// åˆ é™¤æ¡£ä½
const deleteTier = async (tier: PriceTier) => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤æ¡£ä½"${tier.tierName}"å—ï¼Ÿ`, 'æç¤º', { type: 'warning' })
  } catch { return }

  try {
    const { deletePriceTier } = await import('@/api/valueAdded')
    await deletePriceTier(currentCompany.value!.id, tier.id)
    ElMessage.success('åˆ é™¤æˆåŠŸ')
    await loadPriceTiers()
  } catch (e: any) {
    ElMessage.error(e?.message || 'åˆ é™¤å¤±è´¥')
  }
}
```

##### 2.6 å¯¼å…¥PriceTierDialogç»„ä»¶
```typescript
import PriceTierDialog from './components/PriceTierDialog.vue'
import type { PriceTier } from '@/api/valueAdded'
```

##### 2.7 åˆ é™¤æ—§çš„ä»·æ ¼é…ç½®å¯¼å…¥
åˆ é™¤ï¼š
```typescript
getPriceConfigs,
createPriceConfig,
updatePriceConfig,
type PriceConfig,
```

#### 3. æ›´æ–°è®¢å•åŒæ­¥é€»è¾‘

åœ¨ `backend/src/routes/valueAdded.ts` çš„è®¢å•åŒæ­¥å‡½æ•°ä¸­ï¼Œéœ€è¦æ›´æ–°ä»·æ ¼è®¡ç®—é€»è¾‘ï¼Œä½¿ç”¨æ–°çš„å¤šæ¡£ä½ç³»ç»Ÿã€‚

æŸ¥æ‰¾å¹¶æ›´æ–°ä»¥ä¸‹ä½ç½®ï¼š
- `syncOrdersToValueAdded` å‡½æ•°ï¼ˆçº¦ç¬¬131è¡Œï¼‰
- `updateOrderCompany` ç›¸å…³é€»è¾‘ï¼ˆçº¦ç¬¬1187è¡Œï¼‰

#### 4. æµ‹è¯•éªŒè¯

##### 4.1 æ•°æ®åº“æµ‹è¯•
```sql
-- æŸ¥çœ‹æ–°è¡¨ç»“æ„
DESC value_added_price_config;

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO value_added_price_config 
(id, company_id, tier_name, tier_order, pricing_type, unit_price, is_active, priority)
VALUES
('test001', 'company_id_here', 'æ ‡å‡†æ¡£', 1, 'fixed', 900.00, 1, 0);
```

##### 4.2 åŠŸèƒ½æµ‹è¯•
1. å¤–åŒ…å…¬å¸ç®¡ç†å¼¹çª—åˆ—å®½æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
2. ç‚¹å‡»"ä»·æ ¼æ¡£ä½"æŒ‰é’®æ˜¯å¦æ­£å¸¸æ‰“å¼€å¼¹çª—
3. æ·»åŠ å›ºå®šå•ä»·æ¡£ä½
4. æ·»åŠ æŒ‰æ¯”ä¾‹è®¡ä»·æ¡£ä½
5. ç¼–è¾‘æ¡£ä½
6. åˆ é™¤æ¡£ä½
7. æµ‹è¯•æ¡£ä½ä¼˜å…ˆçº§
8. æµ‹è¯•æ—¶é—´èŒƒå›´åŒ¹é…
9. æµ‹è¯•å¾…åˆ†é…è®¢å•å•ä»·ä¸º0
10. æµ‹è¯•åˆ†é…å…¬å¸åå•ä»·è‡ªåŠ¨æ›´æ–°

#### 5. æ ·å¼ä¼˜åŒ–

æ·»åŠ ä»¥ä¸‹æ ·å¼åˆ° ValueAddedManage.vueï¼š
```css
.price-tiers-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.company-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.company-name {
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

.default-price {
  font-size: 14px;
  color: #606266;
  background: #f5f7fa;
  padding: 4px 12px;
  border-radius: 4px;
}
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»å‰åŠ¡å¿…å¤‡ä»½ `value_added_price_config` è¡¨
2. **å‘åå…¼å®¹**ï¼šä¿ç•™ `default_unit_price` å­—æ®µä½œä¸ºå…œåº•ä»·æ ¼
3. **æƒé™æ§åˆ¶**ï¼šä»·æ ¼æ¡£ä½ç®¡ç†éœ€è¦è´¢åŠ¡æƒé™
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä»·æ ¼æ¡£ä½æŸ¥è¯¢éœ€è¦æ·»åŠ ç¼“å­˜
5. **ç”¨æˆ·åŸ¹è®­**ï¼šæ–°çš„å¤šæ¡£ä½ç³»ç»Ÿéœ€è¦åŸ¹è®­ç”¨æˆ·å¦‚ä½•ä½¿ç”¨

## ä¸‹ä¸€æ­¥

å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š
1. å…ˆåœ¨æœ¬åœ°ç¯å¢ƒæµ‹è¯•æ•°æ®åº“è¿ç§»
2. å®Œæˆå‰ç«¯ä»£ç ä¿®æ”¹
3. æœ¬åœ°ç¯å¢ƒå®Œæ•´æµ‹è¯•
4. ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“è¿ç§»
5. éƒ¨ç½²å‰ç«¯ä»£ç 
6. ç”Ÿäº§ç¯å¢ƒéªŒè¯
