# 客户分享问题排查指南

## 问题描述
用户在客户列表点击"分享"按钮，选择目标用户后提交，提示"客户不存在"。

## 排查步骤

### 1. 检查数据库中的客户记录

运行以下SQL脚本检查客户是否存在：

```bash
# 在backend目录下运行
node -e "
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./data/crm.db');

// 检查客户表
db.all('SELECT id, code, name, phone, salesPersonId, createdBy FROM customers ORDER BY createdAt DESC LIMIT 10', (err, rows) => {
  if (err) {
    console.error('查询失败:', err);
    return;
  }
  console.log('\\n=== 最近10条客户记录 ===');
  console.table(rows);
  
  // 检查ID格式
  if (rows.length > 0) {
    console.log('\\n=== 客户ID格式检查 ===');
    rows.forEach(row => {
      console.log(\`ID: \${row.id}, 长度: \${row.id.length}, 格式: \${row.id.includes('-') ? 'UUID' : '其他'}\`);
    });
  }
  
  db.close();
});
"
```

或者使用SQL文件：
```bash
sqlite3 backend/data/crm.db < scripts/check-customer-share-issue.sql
```

### 2. 检查前端传递的客户ID

在浏览器开发者工具中：

1. 打开Network标签
2. 点击分享按钮
3. 查看发送到 `/api/v1/customer-share/share` 的请求
4. 检查请求体中的 `customerId` 字段值

**预期格式**：UUID格式，如 `550e8400-e29b-41d4-a716-446655440000`

### 3. 检查后端日志

在后端添加详细日志：

```typescript
// backend/src/routes/customerShare.ts 第76行附近
router.post('/share', async (req: Request, res: Response) => {
  try {
    const { customerId, sharedTo, timeLimit, remark } = req.body;
    const currentUser = (req as any).user;

    console.log('[客户分享] 接收到的参数:', {
      customerId,
      customerId_type: typeof customerId,
      customerId_length: customerId?.length,
      sharedTo,
      timeLimit,
      remark
    });

    if (!customerId || !sharedTo) {
      return res.status(400).json({ success: false, code: 400, message: '参数不完整' });
    }

    const customerRepository = AppDataSource.getRepository(Customer);
    const userRepository = AppDataSource.getRepository(User);
    const shareRepository = AppDataSource.getRepository(CustomerShare);

    // 获取客户信息
    console.log('[客户分享] 查询客户:', customerId);
    const customer = await customerRepository.findOne({ where: { id: customerId } });
    console.log('[客户分享] 查询结果:', customer ? '找到客户' : '客户不存在');
    
    if (!customer) {
      // 额外检查：尝试通过其他方式查找
      const allCustomers = await customerRepository.find({ take: 5 });
      console.log('[客户分享] 数据库中前5条客户ID:', allCustomers.map(c => ({ id: c.id, name: c.name })));
      
      return res.status(404).json({ success: false, code: 404, message: '客户不存在' });
    }
    
    // ... 后续代码
  } catch (error) {
    console.error('[客户分享] 分享失败:', error);
    res.status(500).json({ success: false, code: 500, message: '分享客户失败' });
  }
});
```

### 4. 常见问题和解决方案

#### 问题1：客户ID格式不匹配

**症状**：前端传递的ID和数据库中的ID格式不一致

**解决方案**：
- 检查Customer实体的ID字段定义
- 确保前端和后端使用相同的ID格式

```typescript
// backend/src/entities/Customer.ts
@Entity('customers')
export class Customer {
  @PrimaryGeneratedColumn('uuid')  // 确保是uuid类型
  id: string;
  // ...
}
```

#### 问题2：数据库表不存在或损坏

**症状**：查询时报错或返回空结果

**解决方案**：
```bash
# 检查表结构
sqlite3 backend/data/crm.db "PRAGMA table_info(customers);"

# 检查记录数
sqlite3 backend/data/crm.db "SELECT COUNT(*) FROM customers;"
```

#### 问题3：TypeORM查询条件问题

**症状**：数据库中有记录，但TypeORM查不到

**解决方案**：
```typescript
// 尝试使用原始查询
const customer = await customerRepository
  .createQueryBuilder('customer')
  .where('customer.id = :id', { id: customerId })
  .getOne();

console.log('[调试] 查询结果:', customer);
```

### 5. 临时修复方案

如果问题紧急，可以临时修改后端代码，增加更详细的错误信息：

```typescript
// backend/src/routes/customerShare.ts
const customer = await customerRepository.findOne({ where: { id: customerId } });

if (!customer) {
  // 尝试模糊查询
  const similarCustomers = await customerRepository
    .createQueryBuilder('customer')
    .where('customer.id LIKE :id', { id: `%${customerId}%` })
    .orWhere('customer.code = :code', { code: customerId })
    .take(5)
    .getMany();
  
  console.log('[客户分享] 未找到精确匹配，相似客户:', similarCustomers);
  
  return res.status(404).json({ 
    success: false, 
    code: 404, 
    message: `客户不存在 (ID: ${customerId})`,
    debug: {
      searchId: customerId,
      similarCount: similarCustomers.length,
      similar: similarCustomers.map(c => ({ id: c.id, name: c.name, code: c.code }))
    }
  });
}
```

### 6. 验证修复

修复后，按以下步骤验证：

1. 重启后端服务
2. 清除浏览器缓存
3. 重新登录系统
4. 尝试分享客户
5. 检查Network请求和响应
6. 查看后端日志输出

## 预防措施

1. **数据一致性检查**：定期运行脚本检查客户ID的完整性
2. **日志记录**：保留详细的操作日志
3. **错误提示优化**：提供更详细的错误信息，包括调试数据
4. **单元测试**：为客户分享功能添加单元测试

## 相关文件

- 后端API：`backend/src/routes/customerShare.ts`
- 前端页面：`src/views/Customer/List.vue`
- 前端API：`src/api/customerShare.ts`
- 数据实体：`backend/src/entities/Customer.ts`
- 数据实体：`backend/src/entities/CustomerShare.ts`
