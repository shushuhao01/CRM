# 外包公司价格档位系统 - 实施步骤

## 实施时间
2026-03-01

## 实施顺序

### 阶段1：数据库准备（优先）
1. 创建价格档位表
2. 为现有公司创建默认档位（迁移数据）
3. 删除旧的default_unit_price字段

### 阶段2：后端开发
1. 创建价格档位实体类
2. 创建价格档位API
3. 修改订单同步逻辑（自动匹配档位）
4. 修改公司切换逻辑（重新计算单价）

### 阶段3：前端开发
1. 创建PriceTierDialog组件（价格档位管理）
2. 重构CompanyManageDialog（外包公司管理）
3. 移除费用配置相关代码
4. 调整列宽和UI

### 阶段4：测试验证
1. 测试档位匹配逻辑
2. 测试价格计算
3. 测试UI交互
4. 数据验证

## 详细步骤

### Step 1: 创建数据库迁移文件

文件：`backend/database-migrations/create-price-tier-system.sql`

### Step 2: 创建实体类

文件：`backend/src/entities/ValueAddedCompanyPriceTier.ts`

### Step 3: 注册实体类

文件：`backend/src/config/database.ts`

### Step 4: 创建API路由

文件：`backend/src/routes/valueAdded.ts`
- 添加价格档位CRUD接口
- 添加获取适用档位接口
- 修改订单同步和公司切换逻辑

### Step 5: 创建前端组件

文件：`src/views/Finance/components/PriceTierDialog.vue`

### Step 6: 重构外包公司管理

文件：`src/views/Finance/ValueAddedManage.vue`
- 移除费用配置按钮
- 调整外包公司管理对话框
- 添加价格档位按钮

### Step 7: 更新API接口

文件：`src/api/valueAdded.ts`

### Step 8: 执行数据迁移

### Step 9: 测试验证

### Step 10: 清理旧代码

## 需要确认的问题

1. **订单金额字段**：按比例计价需要订单金额，请确认字段名称
2. **历史订单处理**：是否需要重新计算历史订单的单价？
3. **档位删除限制**：是否允许删除已被订单使用的档位？
4. **默认档位**：新建公司时是否自动创建默认档位？

## 开始实施？

请确认以上设计是否符合需求，我将开始实施。
