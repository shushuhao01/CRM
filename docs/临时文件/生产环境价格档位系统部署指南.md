# 生产环境价格档位系统部署指南

## 问题描述
生产环境增值管理的价格档位保存失败，添加公司后也有错误提示。开发环境正常。

## 原因分析
生产环境缺失价格档位相关的数据库表：`value_added_price_config`

## 解决方案

### 步骤 1：检查缺失的表（可选）
在宝塔 phpMyAdmin 中执行以下 SQL，查看哪些表不存在：

```sql
-- 文件：backend/database-migrations/production-check-missing-tables.sql
-- 逐条执行，查看结果
```

### 步骤 2：创建价格档位表（必须）
在宝塔 phpMyAdmin 中执行以下 SQL：

**文件：`backend/database-migrations/production-create-price-tier-system.sql`**

```sql
-- 1. 创建价格配置表
CREATE TABLE IF NOT EXISTS `value_added_price_config` (
  `id` VARCHAR(50) NOT NULL COMMENT '配置ID',
  `company_id` VARCHAR(50) NOT NULL COMMENT '外包公司ID',
  `tier_name` VARCHAR(100) NOT NULL COMMENT '档位名称',
  `tier_order` INT NOT NULL DEFAULT 1 COMMENT '档位顺序',
  `pricing_type` VARCHAR(20) NOT NULL DEFAULT 'fixed' COMMENT '计价方式: fixed-按单计价, percentage-按比例计价',
  `unit_price` DECIMAL(10,2) DEFAULT 0.00 COMMENT '单价（按单计价时使用）',
  `percentage_rate` DECIMAL(5,2) DEFAULT 0.00 COMMENT '比例（按比例计价时使用，如5.5表示5.5%）',
  `base_amount_field` VARCHAR(50) DEFAULT 'orderAmount' COMMENT '基数字段',
  `start_date` DATE NULL COMMENT '生效开始日期',
  `end_date` DATE NULL COMMENT '生效结束日期',
  `is_active` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-启用, 0-停用',
  `priority` INT DEFAULT 0 COMMENT '优先级',
  `condition_rules` TEXT COMMENT '条件规则JSON',
  `remark` TEXT COMMENT '备注',
  `created_by` VARCHAR(50) COMMENT '创建人ID',
  `created_by_name` VARCHAR(100) COMMENT '创建人姓名',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外包公司价格配置表';
```

执行后应该显示：✓ 查询成功

### 步骤 3：创建索引
逐条执行以下 SQL（如果索引已存在会报错，可以忽略）：

```sql
CREATE INDEX idx_company_id ON value_added_price_config(company_id);
```

```sql
CREATE INDEX idx_tier_order ON value_added_price_config(tier_order);
```

```sql
CREATE INDEX idx_date_range ON value_added_price_config(start_date, end_date);
```

```sql
CREATE INDEX idx_is_active ON value_added_price_config(is_active);
```

### 步骤 4：迁移现有公司的默认单价（必须）
如果生产环境已经有外包公司数据，需要为它们创建默认档位：

**文件：`backend/database-migrations/production-migrate-default-prices.sql`**

```sql
INSERT INTO value_added_price_config (
  id, 
  company_id, 
  tier_name, 
  tier_order, 
  pricing_type, 
  unit_price, 
  start_date, 
  is_active, 
  created_at, 
  created_by_name
)
SELECT 
  CONCAT('tier-', id, '-001') as id,
  id as company_id,
  '第一档' as tier_name,
  1 as tier_order,
  'fixed' as pricing_type,
  COALESCE(default_unit_price, 0) as unit_price,
  '2024-01-01' as start_date,
  1 as is_active,
  NOW() as created_at,
  '系统迁移' as created_by_name
FROM outsource_companies
WHERE NOT EXISTS (
  SELECT 1 
  FROM value_added_price_config 
  WHERE company_id = outsource_companies.id
);
```

### 步骤 5：验证结果
执行以下 SQL 验证数据：

```sql
-- 查看价格档位表
SELECT * FROM value_added_price_config;

-- 查看公司和档位的关联
SELECT 
  c.company_name,
  t.tier_name,
  t.unit_price,
  t.start_date,
  t.is_active
FROM outsource_companies c
LEFT JOIN value_added_price_config t ON c.id = t.company_id
ORDER BY c.sort_order, t.tier_order;
```

### 步骤 6：重启后端服务
在服务器上执行：

```bash
pm2 restart backend
```

### 步骤 7：测试功能
1. 登录生产环境管理后台
2. 进入"增值管理" → "外包公司"
3. 点击"添加公司"，填写信息并保存 → 应该成功
4. 点击某个公司的"价格档位"按钮 → 应该能看到默认档位
5. 点击"添加档位"，填写信息并保存 → 应该成功

## 相关文件
- `backend/database-migrations/production-check-missing-tables.sql` - 检查缺失的表
- `backend/database-migrations/production-create-price-tier-system.sql` - 创建价格档位表
- `backend/database-migrations/production-migrate-default-prices.sql` - 迁移默认单价
- `database/schema.sql` - 完整数据库结构（已更新）

## 注意事项
1. 宝塔 phpMyAdmin 不支持复杂的动态 SQL，所以使用最简单的语法
2. 索引创建如果报错"Duplicate key name"，说明索引已存在，可以忽略
3. 如果表已存在，`CREATE TABLE IF NOT EXISTS` 会自动跳过
4. 迁移默认单价的 SQL 使用了 `NOT EXISTS`，不会重复插入数据
