# 角色权限数量统计测试指南

## 测试目的

验证角色权限管理页面中的"权限数量"列是否正确统计了所有层级的权限（一级菜单 + 二级菜单 + 三级操作权限）。

## 测试环境

- 后端服务：已启动（端口 3000）
- 前端服务：需要手动启动
- 数据库：MySQL（crm_local）

## 测试步骤

### 1. 启动前端服务

```bash
# 在项目根目录执行
npm run dev
```

### 2. 登录系统

- 使用超级管理员账号登录
- 进入"系统管理 → 角色权限"页面

### 3. 查看角色列表

在角色列表中，查看每个角色的"权限数量"列，验证数值是否正确。

## 预期结果

### 系统预设角色

| 角色名称 | 角色类型 | 预期权限数量 | 说明 |
|---------|---------|------------|------|
| 超级管理员 | 系统角色 | 200+ | 拥有所有权限（使用 * 通配符） |
| 管理员 | 系统角色 | 200+ | 拥有所有权限（使用 * 通配符） |
| 部门经理 | 系统角色 | 50+ | 包含所有配置的权限ID |
| 销售员 | 系统角色 | 30+ | 包含所有配置的权限ID |
| 客服 | 系统角色 | 20+ | 包含所有配置的权限ID |

### 自定义角色

自定义角色的权限数量应该等于配置的权限ID数量（包括一级菜单、二级菜单、三级操作权限）。

## 详细验证

### 1. 验证部门经理权限数量

部门经理的默认权限配置（`src/config/defaultRolePermissions.ts`）包含：

```typescript
permissions: [
  // 数据看板（3个）
  'dashboard', 'dashboard.view', 'dashboard.export',
  
  // 客户管理（7个）
  'customer', 'customer.list', 'customer.list.view', 'customer.list.edit', 
  'customer.list.export', 'customer.list.import', 'customer.add', 'customer.add.create',
  
  // 订单管理（5个）
  'order', 'order.list', 'order.list.view', 'order.list.edit',
  'order.add', 'order.add.create',
  
  // ... 更多权限
]
```

统计所有权限ID，应该有 50+ 个。

### 2. 验证销售员权限数量

销售员的默认权限配置包含的权限ID较少，应该有 30+ 个。

### 3. 验证自定义角色权限数量

1. 点击"新增角色"按钮
2. 创建一个自定义角色
3. 点击"权限设置"按钮
4. 勾选一些权限（例如：数据看板 → 查看看板、导出数据）
5. 保存权限
6. 查看角色列表中的权限数量是否正确

## 测试用例

### 用例1：验证超级管理员权限数量

**步骤**：
1. 查看角色列表
2. 找到"超级管理员"角色
3. 查看"权限数量"列

**预期结果**：
- 权限数量应该显示 200+ 个（全部权限）

### 用例2：验证部门经理权限数量

**步骤**：
1. 查看角色列表
2. 找到"部门经理"角色
3. 查看"权限数量"列

**预期结果**：
- 权限数量应该显示 50+ 个（不是 1 个）

### 用例3：验证销售员权限数量

**步骤**：
1. 查看角色列表
2. 找到"销售员"角色
3. 查看"权限数量"列

**预期结果**：
- 权限数量应该显示 30+ 个（不是 3 个）

### 用例4：验证自定义角色权限数量

**步骤**：
1. 点击"新增角色"按钮
2. 输入角色名称："测试角色"
3. 选择角色类型："自定义角色"
4. 点击"确定"
5. 点击"权限设置"按钮
6. 勾选以下权限：
   - 数据看板 → 查看看板
   - 数据看板 → 导出数据
   - 客户管理 → 客户列表 → 查看列表
7. 点击"确定"保存
8. 查看角色列表中的权限数量

**预期结果**：
- 权限数量应该显示 5 个（dashboard, dashboard.view, dashboard.export, customer, customer.list, customer.list.view）

### 用例5：验证修改权限后的数量更新

**步骤**：
1. 选择一个自定义角色
2. 点击"权限设置"按钮
3. 勾选更多权限
4. 点击"确定"保存
5. 查看角色列表中的权限数量是否更新

**预期结果**：
- 权限数量应该增加

### 用例6：验证恢复默认权限后的数量

**步骤**：
1. 选择一个系统预设角色（如"部门经理"）
2. 点击"权限设置"按钮
3. 修改一些权限
4. 点击"确定"保存
5. 点击"恢复默认"按钮
6. 查看角色列表中的权限数量是否恢复

**预期结果**：
- 权限数量应该恢复到默认值（50+ 个）

## 调试信息

如果权限数量显示不正确，可以打开浏览器控制台查看日志：

```javascript
// 查看权限计算日志
[角色权限] 系统全部权限数量: 200+
[角色权限] 系统全部权限ID数量: 200+
[角色权限] 处理角色: 部门经理 (code: department_manager)
  - 默认权限: 50+个
  - 实际权限: 50+个
  - 有效权限: 50+个
  - 用户数量: X人
```

## 常见问题

### Q1: 权限数量显示为 0

**原因**：角色没有配置任何权限

**解决方案**：
1. 点击"权限设置"按钮
2. 勾选一些权限
3. 点击"确定"保存

### Q2: 权限数量显示不正确

**原因**：可能是浏览器缓存问题

**解决方案**：
1. 清除浏览器缓存
2. 刷新页面
3. 重新登录

### Q3: 修改权限后数量没有更新

**原因**：可能是前端缓存问题

**解决方案**：
1. 刷新页面
2. 重新查看角色列表

## 验收标准

- ✅ 超级管理员和管理员的权限数量显示为全部权限数量（200+）
- ✅ 部门经理的权限数量显示为 50+ 个（不是 1 个）
- ✅ 销售员的权限数量显示为 30+ 个（不是 3 个）
- ✅ 客服的权限数量显示为 20+ 个
- ✅ 自定义角色的权限数量等于配置的权限ID数量
- ✅ 修改权限后，权限数量正确更新
- ✅ 恢复默认权限后，权限数量正确恢复

## 相关文件

- `src/views/System/Role.vue` - 角色权限管理页面
- `src/config/defaultRolePermissions.ts` - 系统预设角色的默认权限配置
- `src/services/permissionService.js` - 权限树的完整结构
- `docs/临时文件/角色权限数量统计修复说明.md` - 修复说明文档

---

**测试时间**: 2026-02-26  
**测试人员**: 待测试  
**状态**: 待测试
