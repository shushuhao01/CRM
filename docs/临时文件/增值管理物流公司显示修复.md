# å¢å€¼ç®¡ç†ç‰©æµå…¬å¸æ˜¾ç¤ºä¿®å¤

## é—®é¢˜æè¿°
å¢å€¼ç®¡ç†é¡µé¢çš„ç‰©æµå•å·è¶…é“¾æ¥å¼¹çª—ä¸­ï¼Œç‰©æµå…¬å¸æ˜¾ç¤ºä¸º"æœªçŸ¥"ï¼Œéœ€è¦å‡†ç¡®æ˜ å°„å‘è´§æ—¶é€‰ä¸­çš„ç‰©æµå…¬å¸ã€‚

## é—®é¢˜åŸå› 
`value_added_orders` è¡¨ç¼ºå°‘ `express_company` å­—æ®µï¼Œæ— æ³•å­˜å‚¨å’Œæ˜¾ç¤ºç‰©æµå…¬å¸ä¿¡æ¯ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. æ•°æ®åº“è¿ç§»

#### å¼€å‘ç¯å¢ƒï¼ˆå·²å®Œæˆï¼‰
æ‰§è¡Œè„šæœ¬ï¼š
```bash
cd backend
node migrate-express-company-mysql-fixed.js
```

æ‰§è¡Œç»“æœï¼š
- âœ… æ·»åŠ  `express_company` å­—æ®µ
- âœ… ä»è®¢å•è¡¨åŒæ­¥ç‰©æµå…¬å¸æ•°æ®ï¼ˆ5æ¡è®°å½•ï¼‰
- âœ… åŒæ­¥ç‡ï¼š100%

#### ç”Ÿäº§ç¯å¢ƒ
æ‰§è¡ŒSQLæ–‡ä»¶ï¼š`backend/database-migrations/production-add-express-company-to-value-added.sql`

```sql
-- æ­¥éª¤1: æ·»åŠ å­—æ®µ
ALTER TABLE `value_added_orders` 
ADD COLUMN `express_company` VARCHAR(50) NULL COMMENT 'ç‰©æµå…¬å¸' 
AFTER `tracking_number`;

-- æ­¥éª¤2: åŒæ­¥æ•°æ®
UPDATE `value_added_orders` vo
INNER JOIN `orders` o ON BINARY vo.order_id = BINARY o.id
SET vo.express_company = o.express_company
WHERE vo.order_id IS NOT NULL 
  AND o.express_company IS NOT NULL
  AND o.express_company != '';
```

### 2. åç«¯ä»£ç ä¿®æ”¹

#### å®ä½“ç±»æ›´æ–°
æ–‡ä»¶ï¼š`backend/src/entities/ValueAddedOrder.ts`

```typescript
@Column('varchar', { length: 50, nullable: true, name: 'express_company' })
expressCompany: string | null;
```

#### åŒæ­¥é€»è¾‘æ›´æ–°
æ–‡ä»¶ï¼š`backend/src/routes/valueAdded.ts`

åœ¨ä¸¤ä¸ªåŒæ­¥å‡½æ•°ä¸­æ·»åŠ ç‰©æµå…¬å¸å­—æ®µï¼š
```typescript
valueAddedOrder.expressCompany = order.expressCompany; // ğŸ”¥ æ·»åŠ ç‰©æµå…¬å¸
```

ä½ç½®ï¼š
1. `syncOrdersToValueAddedOptimized()` å‡½æ•°ï¼ˆç¬¬296è¡Œï¼‰
2. `syncOrdersToValueAdded()` å‡½æ•°ï¼ˆç¬¬365è¡Œï¼‰

### 3. å‰ç«¯ä»£ç ä¿®æ”¹

#### ç‰©æµå¼¹çª—æ˜¾ç¤º
æ–‡ä»¶ï¼š`src/views/Finance/ValueAddedManage.vue`

```typescript
const showTrackingDialog = (row: ValueAddedOrder) => {
  currentTrackingNo.value = row.trackingNumber || ''
  currentExpressCompany.value = row.expressCompany || '' // ğŸ”¥ ä½¿ç”¨è®¢å•çš„ç‰©æµå…¬å¸
  currentPhone.value = row.customerPhone || ''
  trackingDialogVisible.value = true
}
```

### 4. Schemaæ›´æ–°
æ–‡ä»¶ï¼š`database/schema.sql`

åœ¨ `value_added_orders` è¡¨å®šä¹‰ä¸­æ·»åŠ ï¼š
```sql
`express_company` VARCHAR(50) DEFAULT NULL COMMENT 'ç‰©æµå…¬å¸',
```

## æµ‹è¯•éªŒè¯

### å¼€å‘ç¯å¢ƒæµ‹è¯•ç»“æœ
```
ç¤ºä¾‹æ•°æ®ï¼ˆå‰5æ¡ï¼‰:
è®¢å•å· | ç‰©æµå•å· | ç‰©æµå…¬å¸
------------------------------------------------------------
ORD20260226979780 | SF73004602W3TR | é¡ºä¸°é€Ÿè¿
ORD20251228110267 | ZT72105791XHCO2 | ZTO
ORD20260225089307 | SF14110419J408 | é¡ºä¸°é€Ÿè¿
ORD20251228128350 | SF72105791K41H3 | SF
ORD20251225267117 | SF69666106N5AP | é¡ºä¸°é€Ÿè¿
```

### æµ‹è¯•æ­¥éª¤
1. âœ… æ•°æ®åº“è¿ç§»æˆåŠŸ
2. â³ é‡å¯åç«¯æœåŠ¡
3. â³ æ‰“å¼€å¢å€¼ç®¡ç†é¡µé¢
4. â³ ç‚¹å‡»ç‰©æµå•å·è¶…é“¾æ¥
5. â³ éªŒè¯ç‰©æµå…¬å¸æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

## éƒ¨ç½²æ­¥éª¤

### å¼€å‘ç¯å¢ƒ
1. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
2. â³ é‡å¯åç«¯æœåŠ¡ï¼š`npm run dev`
3. â³ æµ‹è¯•ç‰©æµå¼¹çª—åŠŸèƒ½

### ç”Ÿäº§ç¯å¢ƒ
1. â³ åœ¨å®å¡”phpMyAdminä¸­æ‰§è¡ŒSQLï¼š
   - `backend/database-migrations/production-add-express-company-to-value-added.sql`
2. â³ é‡å¯åç«¯æœåŠ¡
3. â³ æµ‹è¯•ç‰©æµå¼¹çª—åŠŸèƒ½

## æŠ€æœ¯è¦ç‚¹

### MySQL Collationé—®é¢˜
é—®é¢˜ï¼š`Illegal mix of collations (utf8mb4_0900_ai_ci,IMPLICIT) and (utf8mb4_unicode_ci,IMPLICIT)`

è§£å†³ï¼šä½¿ç”¨ `BINARY` æ¯”è¾ƒé¿å…collationå†²çª
```sql
INNER JOIN orders o ON BINARY vo.order_id = BINARY o.id
```

### è‡ªåŠ¨åŒæ­¥æœºåˆ¶
åç«¯åœ¨ä»¥ä¸‹æƒ…å†µä¼šè‡ªåŠ¨åŒæ­¥è®¢å•æ•°æ®ï¼š
1. é¦–æ¬¡åŠ è½½å¢å€¼ç®¡ç†é¡µé¢ï¼ˆç¬¬1é¡µï¼‰
2. æ— ç­›é€‰æ¡ä»¶æ—¶
3. æŸ¥çœ‹"å…¨éƒ¨"æ ‡ç­¾é¡µæ—¶

åŒæ­¥ç­–ç•¥ï¼š
- åªåŒæ­¥æœ€è¿‘30å¤©çš„è®¢å•
- æ‰¹é‡æŸ¥è¯¢å’Œæ’å…¥ï¼ˆæ¯æ‰¹500æ¡ï¼‰
- å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ

## ç›¸å…³æ–‡ä»¶

### æ•°æ®åº“è¿ç§»
- `backend/database-migrations/add-express-company-to-value-added.sql` - åŸå§‹è¿ç§»SQL
- `backend/database-migrations/production-add-express-company-to-value-added.sql` - ç”Ÿäº§ç¯å¢ƒSQL
- `backend/migrate-express-company-mysql-fixed.js` - å¼€å‘ç¯å¢ƒè¿ç§»è„šæœ¬

### åç«¯ä»£ç 
- `backend/src/entities/ValueAddedOrder.ts` - å®ä½“ç±»
- `backend/src/routes/valueAdded.ts` - è·¯ç”±å’ŒåŒæ­¥é€»è¾‘

### å‰ç«¯ä»£ç 
- `src/views/Finance/ValueAddedManage.vue` - å¢å€¼ç®¡ç†é¡µé¢

### Schema
- `database/schema.sql` - æ•°æ®åº“ç»“æ„å®šä¹‰

## å®ŒæˆçŠ¶æ€
- âœ… æ•°æ®åº“è¿ç§»æ–‡ä»¶åˆ›å»º
- âœ… å¼€å‘ç¯å¢ƒæ•°æ®åº“è¿ç§»æ‰§è¡Œ
- âœ… åç«¯å®ä½“ç±»æ›´æ–°
- âœ… åç«¯åŒæ­¥é€»è¾‘æ›´æ–°
- âœ… å‰ç«¯æ˜¾ç¤ºé€»è¾‘æ›´æ–°
- âœ… Schemaæ–‡ä»¶æ›´æ–°
- â³ åç«¯æœåŠ¡é‡å¯
- â³ åŠŸèƒ½æµ‹è¯•éªŒè¯
- â³ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## ä¸‹ä¸€æ­¥
1. é‡å¯åç«¯æœåŠ¡
2. æµ‹è¯•ç‰©æµå¼¹çª—åŠŸèƒ½
3. ç¡®è®¤ç‰©æµå…¬å¸æ˜¾ç¤ºæ­£ç¡®
4. å‡†å¤‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
