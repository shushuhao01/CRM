# 生产环境快速修复 - 代收功能

## 问题
生产环境代收功能异常：
- 未改代收的订单显示"已改"标识
- 发起取消代收申请时，当前代收金额为 0
- 代收管理中的代收金额为 0

## 根本原因
生产环境数据库 `orders` 表缺少两个字段：
- `cod_amount` - 代收金额
- `cod_modified` - 是否修改过代收

## 快速修复步骤

### 1. 备份数据库（重要！）
在宝塔面板 → 数据库 → 备份

### 2. 执行以下SQL（复制全部内容到SQL窗口执行）

```sql
-- 添加 cod_amount 字段
ALTER TABLE `orders` 
ADD COLUMN `cod_amount` DECIMAL(10,2) DEFAULT NULL COMMENT '代收金额（可修改）' 
AFTER `deposit_amount`;

-- 添加 cod_modified 字段
ALTER TABLE `orders` 
ADD COLUMN `cod_modified` TINYINT(1) DEFAULT 0 COMMENT '是否修改过代收金额' 
AFTER `cod_amount`;

-- 初始化现有订单的代收金额
UPDATE `orders` 
SET `cod_amount` = `total_amount` - IFNULL(`deposit_amount`, 0)
WHERE `cod_amount` IS NULL;

-- 验证结果
SELECT 
    COUNT(*) AS '总订单数',
    SUM(CASE WHEN cod_amount IS NULL THEN 1 ELSE 0 END) AS 'NULL数量',
    SUM(CASE WHEN cod_amount = 0 THEN 1 ELSE 0 END) AS '为0数量',
    SUM(CASE WHEN cod_amount > 0 THEN 1 ELSE 0 END) AS '大于0数量'
FROM `orders`;
```

### 3. 重启后端服务
```bash
pm2 restart crm-backend
```

### 4. 测试功能
1. 创建新订单 → 检查代收金额
2. 查看订单列表 → 检查"已改代收"标识
3. 发起取消代收申请 → 检查当前代收金额

## 预期结果
- ✅ 新订单代收金额 = 订单总额 - 定金
- ✅ 未改代收的订单不显示"已改"标识
- ✅ 取消代收申请显示正确的当前代收金额

## 如果还有问题
查看详细文档：
- `docs/临时文件/生产环境代收功能部署指南.md`
- `docs/临时文件/生产环境代收问题排查指南.md`

或执行诊断脚本：
- `scripts/diagnose-production-cod-issue.sql`
