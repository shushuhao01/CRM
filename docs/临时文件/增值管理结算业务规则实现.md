# 增值管理结算业务规则实现说明

## 实现时间
2026-03-01

## 业务需求
用户要求实现以下三条业务规则：

1. **结算状态限制**：结算状态"已结算"只能在有效状态为"有效"时选择，其他状态必须是"未结算"
2. **实际结算金额显示**：未结算时显示0，已结算时显示单价
3. **单价映射规则**：待分配时单价为0，分配外包公司后单价跟随公司的默认单价

## 实现内容

### 1. 前端验证（ValueAddedManage.vue）

#### 1.1 单个订单结算状态更新
```typescript
// 更新结算状态
const updateSettlementStatus = async (row: ValueAddedOrder, settlementStatus: string) => {
  // 业务规则：只有有效状态为"有效"时才能选择"已结算"
  if (settlementStatus === 'settled' && row.status !== 'valid') {
    ElMessage.warning('只有有效状态为"有效"的订单才能设置为已结算')
    // 恢复原值
    row.settlementStatus = row.settlementStatus === 'settled' ? 'unsettled' : row.settlementStatus
    return
  }
  // ... 调用API
}
```

#### 1.2 批量结算状态更新
```typescript
// 批量改结算状态
const handleBatchSettlementStatus = async (settlementStatus: string) => {
  // 业务规则：如果要批量设置为"已结算"，检查是否所有订单都是"有效"状态
  if (settlementStatus === 'settled') {
    const invalidOrders = selectedRows.value.filter(row => row.status !== 'valid')
    if (invalidOrders.length > 0) {
      ElMessage.warning(`有 ${invalidOrders.length} 个订单的有效状态不是"有效"，无法设置为已结算`)
      return
    }
  }
  // ... 调用API
}
```

#### 1.3 单价映射规则
```typescript
// 更新订单公司
const updateOrderCompany = async (row: ValueAddedOrder, companyId: string) => {
  let companyName = '待分配'
  let unitPrice = 0 // 业务规则：待分配时单价为0

  if (companyId !== 'default-company') {
    const company = companies.value.find(c => c.id === companyId)
    if (!company) return
    companyName = company.companyName
    // 业务规则：使用公司的默认单价
    unitPrice = Number(company.defaultUnitPrice) || 0
  }
  // ... 更新订单
}
```

#### 1.4 实际结算金额显示
```vue
<el-table-column prop="settlementAmount" label="实际结算" width="110" align="right">
  <template #default="{ row }">
    <!-- 业务规则：未结算显示0，已结算显示单价 -->
    <span v-if="row.settlementStatus === 'settled' && row.status === 'valid'" 
          style="color: #67c23a; font-weight: 600;">
      ¥{{ formatMoney(row.unitPrice) }}
    </span>
    <span v-else style="color: #909399; font-weight: 600;">
      ¥0.00
    </span>
  </template>
</el-table-column>
```

### 2. 后端验证（valueAdded.ts）

#### 2.1 结算状态更新验证
```typescript
case 'updateSettlementStatus':
  // 更新结算状态
  const newSettlementStatus = data?.settlementStatus || order.settlementStatus;
  
  // 业务规则：只有有效状态为"有效"时才能设置为"已结算"
  if (newSettlementStatus === 'settled' && order.status !== 'valid') {
    return res.status(400).json({ 
      success: false, 
      message: '只有有效状态为"有效"的订单才能设置为已结算' 
    });
  }
  
  order.settlementStatus = newSettlementStatus;
  if (order.settlementStatus === 'settled') {
    order.settlementDate = new Date();
    // 业务规则：已结算时，实际结算金额=单价
    order.settlementAmount = order.unitPrice;
  } else if (order.settlementStatus === 'unsettled') {
    order.settlementDate = null;
    // 业务规则：未结算时，实际结算金额=0
    order.settlementAmount = 0;
  }
  break;
```

#### 2.2 有效状态更新时的联动处理
```typescript
case 'updateStatus':
  // 更新有效状态
  const newStatus = data?.status || order.status;
  order.status = newStatus;
  
  // 业务规则：如果改为非"有效"状态，自动将结算状态改为"未结算"
  if (order.status !== 'valid' && order.settlementStatus === 'settled') {
    order.settlementStatus = 'unsettled';
    order.settlementDate = null;
  }
  
  // 业务规则：根据结算状态计算实际结算金额
  if (order.settlementStatus === 'settled' && order.status === 'valid') {
    order.settlementAmount = order.unitPrice;
  } else {
    order.settlementAmount = 0;
  }
  break;
```

## 业务逻辑流程图

### 结算状态更新流程
```
用户选择"已结算"
    ↓
检查有效状态是否为"有效"
    ↓
是 → 允许设置，实际结算=单价
    ↓
否 → 拒绝设置，提示错误
```

### 有效状态更新流程
```
用户修改有效状态
    ↓
检查新状态是否为"有效"
    ↓
否 → 自动将结算状态改为"未结算"
    ↓
根据结算状态计算实际结算金额
    ↓
已结算 + 有效 → 实际结算=单价
其他情况 → 实际结算=0
```

### 单价映射流程
```
用户选择外包公司
    ↓
是否为"待分配"？
    ↓
是 → 单价=0
    ↓
否 → 单价=公司默认单价
```

## 测试验证

### 测试脚本
创建了 `backend/test-settlement-logic.js` 测试脚本，包含以下测试用例：

1. **测试规则1**：尝试将非"有效"状态的订单设置为"已结算"（应该失败）
2. **测试规则2**："有效"状态可以设置为"已结算"（应该成功）
3. **测试规则3**：未结算时实际结算金额为0
4. **测试规则4**：改为非"有效"状态时自动取消结算

### 运行测试
```bash
cd backend
node test-settlement-logic.js
```

## 修改文件清单

### 前端文件
- `src/views/Finance/ValueAddedManage.vue`
  - 修改 `updateSettlementStatus` 函数（添加验证）
  - 修改 `handleBatchSettlementStatus` 函数（添加批量验证）
  - 修改 `updateOrderCompany` 函数（单价映射规则）
  - 修改实际结算列显示逻辑

### 后端文件
- `backend/src/routes/valueAdded.ts`
  - 修改 `updateSettlementStatus` case（添加验证和金额计算）
  - 修改 `updateStatus` case（添加联动处理）

### 测试文件
- `backend/test-settlement-logic.js`（新建）

## 注意事项

1. **前后端双重验证**：前端提供即时反馈，后端确保数据安全
2. **自动联动**：修改有效状态为非"有效"时，自动将结算状态改为"未结算"
3. **金额计算**：实际结算金额完全由结算状态和有效状态决定
4. **单价为0**：待分配订单的单价为0，不是之前的固定值900

## 用户体验优化

1. **即时提示**：用户尝试违反规则时立即显示友好提示
2. **批量验证**：批量操作前检查所有订单，避免部分成功部分失败
3. **视觉反馈**：实际结算金额用不同颜色区分（已结算=绿色，未结算=灰色）
4. **自动恢复**：前端验证失败时自动恢复下拉框原值

## 后续建议

1. 考虑添加"结算批次"功能，方便批量结算管理
2. 可以添加结算历史记录，追踪结算状态变更
3. 考虑添加结算审核流程，增加财务管控
