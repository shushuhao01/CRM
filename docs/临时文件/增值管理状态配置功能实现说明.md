# 增值管理状态配置功能实现说明

## 功能概述
为增值管理页面添加状态配置功能,包括:
1. 添加"状态配置"按钮(在外包公司管理按钮前面)
2. 状态配置弹窗(有效状态和结算状态两个标签卡)
3. 修改列表字段名称(状态→有效状态)
4. 实际结算价格样式优化(两位小数、加粗、颜色)
5. 物流单号添加超链接,点击查看物流详情

## 已完成的工作

### 1. 创建状态配置弹窗组件
文件: `src/views/Finance/components/ValueAddedConfigDialog.vue`
- 两个标签卡:有效状态、结算状态
- 支持增删改预设状态
- 参考绩效管理配置弹窗的布局

### 2. 添加API接口
文件: `src/api/valueAdded.ts`
- `getValueAddedStatusConfigs()` - 获取状态配置列表
- `addValueAddedStatusConfig()` - 添加状态配置
- `deleteValueAddedStatusConfig()` - 删除状态配置

## 需要完成的工作

### 1. 修改ValueAddedManage.vue主文件

#### 1.1 导入状态配置弹窗组件
```typescript
import ValueAddedConfigDialog from './components/ValueAddedConfigDialog.vue'
import TrackingDialog from '@/components/Logistics/TrackingDialog.vue'
```

#### 1.2 添加状态配置按钮
在"外包公司管理"按钮前面添加:
```vue
<el-button type="info" :icon="Setting" @click="showStatusConfigDialog">状态配置</el-button>
```

#### 1.3 修改筛选器字段名称
将"状态"改为"有效状态":
```vue
<el-select v-model="statusFilter" placeholder="有效状态" clearable @change="handleSearch" class="filter-item">
  <el-option label="全部状态" value="" />
  <el-option label="待处理" value="pending" />
  <el-option label="有效" value="valid" />
  <el-option label="无效" value="invalid" />
  <el-option label="已补单" value="supplemented" />
</el-select>
```

#### 1.4 修改表格列名称
将"状态"列改为"有效状态":
```vue
<el-table-column prop="status" label="有效状态" width="120">
```

#### 1.5 添加物流单号超链接
```vue
<el-table-column prop="trackingNumber" label="物流单号" min-width="140">
  <template #default="{ row }">
    <el-link 
      v-if="row.trackingNumber" 
      type="primary" 
      @click="showTrackingDialog(row)"
    >
      {{ row.trackingNumber }}
    </el-link>
    <span v-else>-</span>
  </template>
</el-table-column>
```

#### 1.6 优化实际结算价格显示
确保两位小数、加粗、颜色:
```vue
<el-table-column prop="settlementAmount" label="实际结算" width="110" align="right">
  <template #default="{ row }">
    <span v-if="row.status === 'valid'" style="color: #67c23a; font-weight: 600;">
      ¥{{ formatMoney(row.settlementAmount) }}
    </span>
    <span v-else-if="row.status === 'invalid'" style="color: #f56c6c; font-weight: 600;">
      ¥0.00
    </span>
    <span v-else-if="row.settlementStatus === 'settled'" style="color: #409eff; font-weight: 600;">
      ¥{{ formatMoney(row.settlementAmount) }}
    </span>
    <span v-else style="color: #909399; font-weight: 600;">-</span>
  </template>
</el-table-column>
```

#### 1.7 添加状态配置弹窗和物流弹窗
```vue
<!-- 状态配置弹窗 -->
<ValueAddedConfigDialog 
  v-model:visible="statusConfigDialogVisible" 
  @saved="loadStatusConfigs" 
/>

<!-- 物流详情弹窗 -->
<TrackingDialog 
  v-model="trackingDialogVisible" 
  :tracking-no="currentTrackingNo" 
  :company="currentExpressCompany" 
  :phone="currentPhone" 
/>
```

#### 1.8 添加响应式数据和方法
```typescript
// 状态配置弹窗
const statusConfigDialogVisible = ref(false)
const showStatusConfigDialog = () => {
  statusConfigDialogVisible.value = true
}

// 物流弹窗
const trackingDialogVisible = ref(false)
const currentTrackingNo = ref('')
const currentExpressCompany = ref('')
const currentPhone = ref('')

const showTrackingDialog = (row: ValueAddedOrder) => {
  currentTrackingNo.value = row.trackingNumber || ''
  currentExpressCompany.value = row.expressCompany || ''
  currentPhone.value = row.customerPhone || ''
  trackingDialogVisible.value = true
}

// 加载状态配置
const loadStatusConfigs = () => {
  // 重新加载数据以应用新的状态配置
  handleSearch()
}
```

### 2. 添加后端API路由

文件: `backend/src/routes/valueAdded.ts`

#### 2.1 创建状态配置表实体
需要创建 `ValueAddedStatusConfig` 实体:
```typescript
// backend/src/entities/ValueAddedStatusConfig.ts
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn } from 'typeorm'

@Entity('value_added_status_configs')
export class ValueAddedStatusConfig {
  @PrimaryGeneratedColumn('uuid')
  id: string

  @Column({ type: 'varchar', length: 50 })
  type: string // 'validStatus' 或 'settlementStatus'

  @Column({ type: 'varchar', length: 100 })
  value: string

  @Column({ type: 'varchar', length: 100 })
  label: string

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date
}
```

#### 2.2 添加API路由
```typescript
/**
 * 获取状态配置列表
 */
router.get('/status-configs', authenticateToken, async (req: Request, res: Response) => {
  try {
    const configRepo = AppDataSource.getRepository(ValueAddedStatusConfig)
    
    const validStatus = await configRepo.find({ where: { type: 'validStatus' } })
    const settlementStatus = await configRepo.find({ where: { type: 'settlementStatus' } })
    
    res.json({
      success: true,
      data: {
        validStatus,
        settlementStatus
      }
    })
  } catch (error: any) {
    console.error('[ValueAdded] Get status configs error:', error)
    res.status(500).json({ success: false, message: '获取状态配置失败' })
  }
})

/**
 * 添加状态配置
 */
router.post('/status-configs', authenticateToken, async (req: Request, res: Response) => {
  try {
    const { type, value, label } = req.body
    
    if (!type || !value || !label) {
      return res.status(400).json({ success: false, message: '请填写完整信息' })
    }
    
    const configRepo = AppDataSource.getRepository(ValueAddedStatusConfig)
    
    // 检查是否已存在
    const existing = await configRepo.findOne({ where: { type, value } })
    if (existing) {
      return res.status(400).json({ success: false, message: '该状态已存在' })
    }
    
    const config = new ValueAddedStatusConfig()
    config.type = type
    config.value = value
    config.label = label
    
    await configRepo.save(config)
    
    res.json({ success: true, message: '添加成功', data: { id: config.id } })
  } catch (error: any) {
    console.error('[ValueAdded] Add status config error:', error)
    res.status(500).json({ success: false, message: '添加失败' })
  }
})

/**
 * 删除状态配置
 */
router.delete('/status-configs/:id', authenticateToken, async (req: Request, res: Response) => {
  try {
    const { id } = req.params
    
    const configRepo = AppDataSource.getRepository(ValueAddedStatusConfig)
    const config = await configRepo.findOne({ where: { id } })
    
    if (!config) {
      return res.status(404).json({ success: false, message: '配置不存在' })
    }
    
    await configRepo.remove(config)
    
    res.json({ success: true, message: '删除成功' })
  } catch (error: any) {
    console.error('[ValueAdded] Delete status config error:', error)
    res.status(500).json({ success: false, message: '删除失败' })
  }
})
```

### 3. 创建数据库迁移脚本

文件: `backend/database-migrations/create-value-added-status-configs.sql`

```sql
-- 创建增值管理状态配置表
CREATE TABLE IF NOT EXISTS `value_added_status_configs` (
  `id` varchar(36) NOT NULL,
  `type` varchar(50) NOT NULL COMMENT '配置类型: validStatus-有效状态, settlementStatus-结算状态',
  `value` varchar(100) NOT NULL COMMENT '状态值',
  `label` varchar(100) NOT NULL COMMENT '状态标签',
  `created_at` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_value` (`type`, `value`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='增值管理状态配置表';

-- 插入默认有效状态配置
INSERT INTO `value_added_status_configs` (`id`, `type`, `value`, `label`) VALUES
(UUID(), 'validStatus', 'pending', '待处理'),
(UUID(), 'validStatus', 'valid', '有效'),
(UUID(), 'validStatus', 'invalid', '无效'),
(UUID(), 'validStatus', 'supplemented', '已补单');

-- 插入默认结算状态配置
INSERT INTO `value_added_status_configs` (`id`, `type`, `value`, `label`) VALUES
(UUID(), 'settlementStatus', 'unsettled', '未结算'),
(UUID(), 'settlementStatus', 'settled', '已结算');
```

## 样式说明

### 实际结算价格颜色规则
- 有效状态: 绿色 (#67c23a)
- 无效状态: 红色 (#f56c6c)
- 已结算: 蓝色 (#409eff)
- 其他: 灰色 (#909399)
- 所有金额都加粗显示 (font-weight: 600)
- 保留两位小数

### 物流单号超链接
- 使用 `el-link` 组件
- type="primary" 显示为蓝色
- 点击弹出 `TrackingDialog` 组件查看物流详情
- 参考代收管理的实现方式

## 测试步骤

1. 点击"状态配置"按钮,打开配置弹窗
2. 在"有效状态"标签卡中添加/删除状态
3. 在"结算状态"标签卡中添加/删除状态
4. 检查列表中的"有效状态"和"结算状态"下拉框是否更新
5. 检查实际结算价格是否正确显示(两位小数、加粗、颜色)
6. 点击物流单号,检查是否弹出物流详情弹窗
7. 检查筛选器中的字段名称是否正确

## 注意事项

1. 状态配置修改后需要刷新列表数据
2. 物流单号为空时显示"-"
3. 实际结算价格根据订单状态显示不同颜色
4. 确保formatMoney函数返回两位小数
5. 物流弹窗需要传入物流单号、快递公司、客户电话
