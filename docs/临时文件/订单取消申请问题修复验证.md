# 订单取消申请问题修复验证

## 修复的问题

### 问题1：取消订单审核弹窗显示为空
**原因**：提交取消申请时，订单状态被设置为 `'pending'`，而不是 `'pending_cancel'`

**修复**：
```typescript
// 修复前
order.status = 'pending';

// 修复后
order.status = 'pending_cancel'; // 🔥 修复：设置为 pending_cancel 状态
order.cancelReason = cancelReason; // 🔥 保存取消原因到专门的字段
```

### 问题2：消息通知中的取消原因显示英文
**原因**：前端传递的是英文值（如 `customer_cancel`），后端直接使用没有转换

**修复**：
```typescript
// 🔥 修复：将英文取消原因转换为中文
const reasonMap: Record<string, string> = {
  'customer_cancel': '客户主动取消',
  'out_of_stock': '商品缺货',
  'price_change': '价格调整',
  'order_error': '订单信息错误',
  'other': '其他原因'
};
const cancelReasonText = reasonMap[reason] || reason;
const cancelReason = `${cancelReasonText}${description ? ` - ${description}` : ''}`;
```

## 验证步骤

### 1. 测试取消申请提交
1. 登录普通成员账号
2. 在订单列表中选择一个订单
3. 点击"申请取消"按钮
4. 选择取消原因（如"客户主动取消"）
5. 填写详细说明（可选）
6. 提交申请

**预期结果**：
- 提示"取消申请已提交，等待管理员审核"
- 订单状态变为"待取消"（pending_cancel）

### 2. 测试消息通知
1. 查看消息中心
2. 找到取消申请的通知

**预期结果**：
- 通知标题：📝 取消申请待审核
- 通知内容：【销售员：XXX】订单 #订单号（客户：客户名）申请取消，原因：客户主动取消
- 取消原因显示为中文，不是英文

### 3. 测试取消审核弹窗
1. 登录管理员账号
2. 进入订单列表页面
3. 点击"取消订单申请审核"按钮
4. 查看"待审核"标签页

**预期结果**：
- 弹窗中显示刚才申请取消的订单
- 订单信息完整：订单号、客户姓名、负责销售、金额、申请时间、取消原因
- 取消原因显示为中文

### 4. 测试审核操作
1. 在"待审核"标签页中选中订单
2. 点击"审核取消通过"或"审核取消拒绝"

**预期结果**：
- 审核成功
- 订单状态更新（通过：cancelled，拒绝：confirmed）
- 发送通知给申请人

## 数据库验证

### 检查订单状态
```sql
-- 查看待取消的订单
SELECT 
    id, 
    order_number, 
    customer_name, 
    status, 
    cancel_reason, 
    remark,
    created_by_name,
    updated_at
FROM orders 
WHERE status = 'pending_cancel'
ORDER BY updated_at DESC
LIMIT 10;
```

**预期结果**：
- `status` 字段值为 `'pending_cancel'`
- `cancel_reason` 字段包含中文取消原因
- `remark` 字段包含完整的取消信息

### 检查消息通知
```sql
-- 查看取消申请通知
SELECT 
    id,
    type,
    title,
    content,
    target_user_id,
    created_at
FROM system_messages
WHERE type = 'order_cancel_request'
ORDER BY created_at DESC
LIMIT 10;
```

**预期结果**：
- `content` 字段包含中文取消原因
- 通知发送给管理员

## API 测试

### 测试 pending-cancel API
```bash
# 获取待审核的取消订单
curl -X GET http://localhost:3000/api/v1/orders/pending-cancel \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应**：
```json
{
  "success": true,
  "code": 200,
  "data": [
    {
      "id": "订单ID",
      "orderNumber": "订单号",
      "customerName": "客户姓名",
      "customerPhone": "客户电话",
      "totalAmount": 金额,
      "cancelReason": "客户主动取消 - 详细说明",
      "cancelRequestTime": "2026-02-26T08:00:00.000Z",
      "status": "pending_cancel",
      "createdBy": "用户ID",
      "createdByName": "销售员姓名"
    }
  ]
}
```

## 修复文件

- `backend/src/routes/orders.ts` - 修复取消申请逻辑
- `backend/src/entities/Order.ts` - 添加 pending_cancel 状态类型

## 注意事项

1. **已存在的待取消订单**：
   - 如果数据库中已经有 `status = 'pending'` 的取消申请订单
   - 需要手动更新为 `'pending_cancel'`
   - SQL: `UPDATE orders SET status = 'pending_cancel' WHERE status = 'pending' AND remark LIKE '%取消原因%';`

2. **取消原因映射**：
   - 确保前端和后端的取消原因选项保持一致
   - 如果添加新的取消原因，需要同时更新前端和后端的映射

3. **消息通知**：
   - 取消原因会显示在消息通知中
   - 确保取消原因简洁明了，方便管理员快速了解情况
