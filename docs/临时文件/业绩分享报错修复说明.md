# 业绩分享页面报错修复说明

## 问题描述
开发环境访问业绩分享页面出现大量报错：
- `Cannot read properties of undefined (reading 'map')`
- `Cannot read properties of undefined (reading 'toLocaleString')`

## 问题根源
后端 API 返回的数据中，某些字段可能是 `undefined` 或 `null`，导致前端在访问这些字段的方法时报错。

具体问题：
1. `share.shareMembers` 可能是 `undefined`，调用 `.map()` 时报错
2. `orderAmount`、`totalAmount`、`shareAmount` 等金额字段可能是 `undefined`，调用 `.toLocaleString()` 时报错

## 修复方案

### 1. 修复 Store 层（src/stores/performance.ts）

#### 修复点1：shareStats 计算属性
```typescript
// 修复前
const involvedMembers = new Set(shares.flatMap(share => share.shareMembers.map(member => member.userId))).size

// 修复后
const involvedMembers = new Set(
  shares
    .filter(share => share.shareMembers && Array.isArray(share.shareMembers))
    .flatMap(share => share.shareMembers.map(member => member.userId))
).size
```

#### 修复点2：loadPerformanceShares 方法
```typescript
// 修复前
performanceShares.value = response.data.shares || []

// 修复后
performanceShares.value = (response.data.shares || []).map(share => ({
  ...share,
  shareMembers: share.shareMembers || []
}))
```

### 2. 修复视图层（src/views/Performance/Share.vue）

所有使用 `toLocaleString()` 的地方都添加了空值保护：

```vue
<!-- 修复前 -->
¥{{ shareStats.totalAmount.toLocaleString() }}

<!-- 修复后 -->
¥{{ (shareStats.totalAmount || 0).toLocaleString() }}
```

共修复了 7 处：
1. 分享总金额统计卡片
2. 订单金额列表列
3. 订单选择下拉框（2处）
4. 订单详情显示
5. 分享详情订单金额
6. 分享成员金额计算
7. 分享金额列表列

## 修复效果
- 页面不再报错
- 即使后端返回的数据不完整，前端也能正常显示（显示为 ¥0）
- 不影响正常数据的显示

## 为什么生产环境正常？
可能的原因：
1. 生产环境数据库中的数据更完整
2. 生产环境的 API 返回格式更规范
3. 开发环境可能有测试数据或脏数据

## 注意事项
1. 这是防御性修复，确保前端健壮性
2. 不影响任何现有功能
3. 如果后端返回正常数据，显示效果与之前完全一致
4. 只在数据异常时提供降级显示（显示为0）

## 相关文件
- `src/stores/performance.ts` - Store 层修复
- `src/views/Performance/Share.vue` - 视图层修复

## 测试建议
1. 清除浏览器缓存
2. 刷新业绩分享页面
3. 确认不再有控制台报错
4. 测试创建新分享功能是否正常
5. 测试查看分享详情功能是否正常

## 修复时间
2026-02-27

## 修复人
AI Assistant
