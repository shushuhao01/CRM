# ä»·æ ¼æ¡£ä½åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ä¿®å¤

## é—®é¢˜æ€»ç»“

ç”¨æˆ·æŠ¥å‘Šä¸‰ä¸ªé—®é¢˜ï¼š
1. âœ… ä¿å­˜æ¡£ä½ä»·æ ¼æˆåŠŸåï¼Œåœ¨ä»·æ ¼æ¡£ä½åˆ—è¡¨ä¸­æ²¡æœ‰çœ‹åˆ°æ–°æ·»åŠ çš„æ¡£ä½
2. âœ… æ²¡æœ‰çœ‹åˆ°åˆ é™¤æŒ‰é’®
3. âœ… éœ€è¦"æ— é™æœŸ"æ—¶é—´é€‰æ‹©é€‰é¡¹

## æ ¹æœ¬åŸå› 

### ä¸»è¦é—®é¢˜ï¼šæ¡£ä½åˆ—è¡¨ä¸æ˜¾ç¤º

**é”™è¯¯ä»£ç **ï¼ˆ`src/views/Finance/ValueAddedManage.vue`ï¼‰ï¼š
```javascript
const loadCompanyTiers = async (companyId: string) => {
  const res = await getCompanyPriceTiers(companyId)
  companyTiers.value = res.data || []  // âŒ é”™è¯¯ï¼šres.data æ˜¯ undefined
}
```

**åŸå› åˆ†æ**ï¼š
1. åç«¯è¿”å›æ ¼å¼ï¼š`{ success: true, data: [æ¡£ä½æ•°ç»„] }`
2. Axios å“åº”æ‹¦æˆªå™¨ï¼ˆ`src/utils/request.ts` ç¬¬ 177 è¡Œï¼‰è¿”å› `data` å­—æ®µ
3. æ‰€ä»¥ `res` å·²ç»æ˜¯æ¡£ä½æ•°ç»„ï¼Œä¸æ˜¯åŒ…å« `data` å±æ€§çš„å¯¹è±¡
4. è®¿é—® `res.data` å¾—åˆ° `undefined`
5. åˆ—è¡¨è¢«è®¾ç½®ä¸ºç©ºæ•°ç»„ `[]`

**è¿™ä¸ä¹‹å‰ä¿®å¤çš„ç»Ÿè®¡æ•°æ®é—®é¢˜å®Œå…¨ç›¸åŒï¼**

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤æ¡£ä½åˆ—è¡¨åŠ è½½ âœ…

**æ–‡ä»¶**ï¼š`src/views/Finance/ValueAddedManage.vue`

```javascript
const loadCompanyTiers = async (companyId: string) => {
  if (!companyId) {
    console.warn('[loadCompanyTiers] companyIdä¸ºç©º')
    return
  }

  console.log('[loadCompanyTiers] å¼€å§‹åŠ è½½æ¡£ä½ï¼ŒcompanyId:', companyId)
  tiersLoading.value = true
  try {
    const { getCompanyPriceTiers } = await import('@/api/valueAdded')
    const res = await getCompanyPriceTiers(companyId)
    console.log('[loadCompanyTiers] APIè¿”å›:', res)
    // ğŸ”¥ ä¿®å¤ï¼šaxiosæ‹¦æˆªå™¨å·²ç»è¿”å›dataï¼Œreså°±æ˜¯æ¡£ä½æ•°ç»„
    companyTiers.value = Array.isArray(res) ? res : (res?.data || [])
    console.log('[loadCompanyTiers] æ¡£ä½åˆ—è¡¨:', companyTiers.value)
  } catch (e: any) {
    console.error('[loadCompanyTiers] åŠ è½½å¤±è´¥:', e)
    ElMessage.error(e?.message || 'åŠ è½½ä»·æ ¼æ¡£ä½å¤±è´¥')
    companyTiers.value = []
  } finally {
    tiersLoading.value = false
  }
}
```

### 2. å¢å¼ºæ¡£ä½ä¿å­˜å›è°ƒ âœ…

**æ–‡ä»¶**ï¼š`src/views/Finance/ValueAddedManage.vue`

```javascript
const handleTierSaved = async () => {
  console.log('[handleTierSaved] æ¡£ä½ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨')
  console.log('[handleTierSaved] editingCompany:', editingCompany.value)
  if (editingCompany.value) {
    console.log('[handleTierSaved] è°ƒç”¨loadCompanyTiersï¼ŒcompanyId:', editingCompany.value.id)
    await loadCompanyTiers(editingCompany.value.id)
    // åŒæ—¶åˆ·æ–°å…¬å¸åˆ—è¡¨ï¼Œæ›´æ–°"å•ä»·/æ¯”ä¾‹"åˆ—
    await loadCompanies()
  } else {
    console.warn('[handleTierSaved] editingCompanyä¸ºç©ºï¼Œæ— æ³•åˆ·æ–°æ¡£ä½åˆ—è¡¨')
  }
}
```

**æ”¹è¿›**ï¼š
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- ä¿å­˜ååŒæ—¶åˆ·æ–°å…¬å¸åˆ—è¡¨ï¼Œç¡®ä¿"å•ä»·/æ¯”ä¾‹"åˆ—æ˜¾ç¤ºæœ€æ–°æ•°æ®

### 3. æ·»åŠ ä¿å­˜äº‹ä»¶æ—¥å¿— âœ…

**æ–‡ä»¶**ï¼š`src/views/Finance/components/PriceTierDialog.vue`

```javascript
const handleSubmit = async () => {
  // ... éªŒè¯å’Œä¿å­˜é€»è¾‘ ...
  
  if (isEdit.value && props.tier) {
    await updatePriceTier(props.companyId, props.tier.id, submitData)
    ElMessage.success('æ›´æ–°æˆåŠŸ')
  } else {
    await createPriceTier(props.companyId, submitData)
    ElMessage.success('æ·»åŠ æˆåŠŸ')
  }

  console.log('[PriceTierDialog] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡emit savedäº‹ä»¶')
  emit('saved')
  console.log('[PriceTierDialog] savedäº‹ä»¶å·²emit')
  handleClose()
}
```

### 4. æ— é™æœŸé€‰é¡¹ âœ…

**æ–‡ä»¶**ï¼š`src/views/Finance/components/PriceTierDialog.vue`

å·²æ·»åŠ "æ— é™æœŸ"å¤é€‰æ¡†ï¼š
- å‹¾é€‰åéšè—æ—¥æœŸé€‰æ‹©å™¨
- æäº¤æ—¶æ¸…ç©º `startDate` å’Œ `endDate`
- æ˜¾ç¤ºæç¤ºï¼š"è¯¥æ¡£ä½å°†é•¿æœŸæœ‰æ•ˆï¼Œä¸å—æ—¶é—´é™åˆ¶"

```vue
<el-form-item label="ç”Ÿæ•ˆæ—¶é—´">
  <el-checkbox v-model="form.unlimitedTime" style="margin-bottom: 8px;">æ— é™æœŸ</el-checkbox>
  <div v-if="!form.unlimitedTime">
    <el-col :span="11">
      <el-date-picker
        v-model="form.startDate"
        type="date"
        placeholder="å¼€å§‹æ—¥æœŸ"
        value-format="YYYY-MM-DD"
        style="width: 100%"
      />
    </el-col>
    <el-col :span="2" style="text-align: center">-</el-col>
    <el-col :span="11">
      <el-date-picker
        v-model="form.endDate"
        type="date"
        placeholder="ç»“æŸæ—¥æœŸ"
        value-format="YYYY-MM-DD"
        style="width: 100%"
      />
    </el-col>
  </div>
  <div v-else style="color: #909399; font-size: 13px; margin-top: 8px;">
    è¯¥æ¡£ä½å°†é•¿æœŸæœ‰æ•ˆï¼Œä¸å—æ—¶é—´é™åˆ¶
  </div>
</el-form-item>
```

### 5. åˆ é™¤æŒ‰é’®è¯´æ˜ âœ…

åˆ é™¤æŒ‰é’®å·²å­˜åœ¨ï¼Œåªæ˜¯åœ¨åˆ—è¡¨ä¸ºç©ºæ—¶çœ‹ä¸åˆ°ï¼š

**å…¬å¸åˆ—è¡¨åˆ é™¤æŒ‰é’®**ï¼ˆ`ValueAddedManage.vue` ç¬¬ 348 è¡Œï¼‰ï¼š
```vue
<el-button 
  v-if="row.totalOrders === 0" 
  type="danger" 
  link 
  size="small" 
  @click="deleteCompany(row)"
>
  åˆ é™¤
</el-button>
```
- ä»…å½“å…¬å¸æ²¡æœ‰å…³è”è®¢å•æ—¶æ˜¾ç¤º

**æ¡£ä½åˆ—è¡¨åˆ é™¤æŒ‰é’®**ï¼ˆ`ValueAddedManage.vue` ç¬¬ 444 è¡Œï¼‰ï¼š
```vue
<el-table-column label="æ“ä½œ" width="150" fixed="right">
  <template #default="{ row }">
    <el-button link type="primary" size="small" @click="editTier(row)">ç¼–è¾‘</el-button>
    <el-button link type="danger" size="small" @click="deleteTier(row)">åˆ é™¤</el-button>
  </template>
</el-table-column>
```
- æ¯ä¸ªæ¡£ä½éƒ½æœ‰åˆ é™¤æŒ‰é’®
- åˆ é™¤å‰ä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†

## æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æ¡£ä½æ·»åŠ å’Œæ˜¾ç¤º
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. ç‚¹å‡»"å¤–åŒ…å…¬å¸ç®¡ç†"
3. é€‰æ‹©ä¸€ä¸ªå…¬å¸ï¼Œç‚¹å‡»"ç¼–è¾‘"
4. åˆ‡æ¢åˆ°"ä»·æ ¼æ¡£ä½"æ ‡ç­¾é¡µ
5. ç‚¹å‡»"æ·»åŠ æ¡£ä½"
6. å¡«å†™æ¡£ä½ä¿¡æ¯ï¼š
   - æ¡£ä½åç§°ï¼šæµ‹è¯•æ¡£ä½
   - è®¡ä»·æ–¹å¼ï¼šæŒ‰å•è®¡ä»·
   - å›ºå®šå•ä»·ï¼š1000
   - å‹¾é€‰"æ— é™æœŸ"
   - ä¼˜å…ˆçº§ï¼š10
   - æ¡£ä½æ’åºï¼š1
   - çŠ¶æ€ï¼šå¯ç”¨
7. ç‚¹å‡»"ä¿å­˜"

**é¢„æœŸç»“æœ**ï¼š
- æ˜¾ç¤º"æ·»åŠ æˆåŠŸ"æç¤º
- å¼¹çª—è‡ªåŠ¨å…³é—­
- æ¡£ä½åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
- æ–°æ¡£ä½å‡ºç°åœ¨åˆ—è¡¨ä¸­
- æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´çš„è°ƒè¯•æ—¥å¿—

### 2. æµ‹è¯•åˆ é™¤æŒ‰é’®
1. åœ¨æ¡£ä½åˆ—è¡¨ä¸­ï¼Œæ¯è¡Œéƒ½åº”è¯¥æœ‰"ç¼–è¾‘"å’Œ"åˆ é™¤"æŒ‰é’®
2. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
3. ç¡®è®¤åˆ é™¤å¯¹è¯æ¡†å‡ºç°
4. ç‚¹å‡»"ç¡®å®š"

**é¢„æœŸç»“æœ**ï¼š
- æ˜¾ç¤º"åˆ é™¤æˆåŠŸ"æç¤º
- æ¡£ä½ä»åˆ—è¡¨ä¸­ç§»é™¤

### 3. æµ‹è¯•æ— é™æœŸé€‰é¡¹
1. æ·»åŠ æ¡£ä½æ—¶å‹¾é€‰"æ— é™æœŸ"
2. æ—¥æœŸé€‰æ‹©å™¨åº”è¯¥éšè—
3. æ˜¾ç¤ºæç¤ºæ–‡å­—ï¼š"è¯¥æ¡£ä½å°†é•¿æœŸæœ‰æ•ˆï¼Œä¸å—æ—¶é—´é™åˆ¶"
4. ä¿å­˜åï¼Œåœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºä¸º"ä¸é™åˆ¶"

### 4. æµ‹è¯•å•ä»·/æ¯”ä¾‹åˆ—
1. åœ¨å…¬å¸åˆ—è¡¨ä¸­ï¼ŒæŸ¥çœ‹"å•ä»·/æ¯”ä¾‹"åˆ—
2. åº”è¯¥æ˜¾ç¤ºè¯¥å…¬å¸æœ€é«˜ä¼˜å…ˆçº§æ¡£ä½çš„ä»·æ ¼
3. å›ºå®šå•ä»·æ˜¾ç¤ºä¸ºï¼šÂ¥1000.00ï¼ˆç»¿è‰²ï¼‰
4. æ¯”ä¾‹æ˜¾ç¤ºä¸ºï¼š5.00%ï¼ˆæ©™è‰²ï¼‰
5. æœªé…ç½®æ˜¾ç¤ºä¸ºï¼šæœªé…ç½®ï¼ˆç°è‰²ï¼‰

## æ§åˆ¶å°æ—¥å¿—ç¤ºä¾‹

æˆåŠŸçš„æ—¥å¿—åºåˆ—ï¼š
```
[PriceTierDialog] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡emit savedäº‹ä»¶
[PriceTierDialog] savedäº‹ä»¶å·²emit
[handleTierSaved] æ¡£ä½ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡åˆ·æ–°åˆ—è¡¨
[handleTierSaved] editingCompany: {id: "xxx", companyName: "xxx", ...}
[handleTierSaved] è°ƒç”¨loadCompanyTiersï¼ŒcompanyId: xxx
[loadCompanyTiers] å¼€å§‹åŠ è½½æ¡£ä½ï¼ŒcompanyId: xxx
[loadCompanyTiers] APIè¿”å›: [{id: "xxx", tierName: "æµ‹è¯•æ¡£ä½", ...}]
[loadCompanyTiers] æ¡£ä½åˆ—è¡¨: [{id: "xxx", tierName: "æµ‹è¯•æ¡£ä½", ...}]
```

## ç›¸å…³æ–‡ä»¶

### å‰ç«¯æ–‡ä»¶
- `src/views/Finance/ValueAddedManage.vue` - ä¸»é¡µé¢ï¼ŒåŒ…å«æ¡£ä½åˆ—è¡¨
- `src/views/Finance/components/PriceTierDialog.vue` - æ¡£ä½æ·»åŠ /ç¼–è¾‘å¼¹çª—
- `src/api/valueAdded.ts` - API æ¥å£å®šä¹‰
- `src/utils/request.ts` - Axios å“åº”æ‹¦æˆªå™¨

### åç«¯æ–‡ä»¶
- `backend/src/routes/valueAdded.ts` - æ¡£ä½ CRUD ç«¯ç‚¹ï¼ˆç¬¬ 1119-1270 è¡Œï¼‰
- `backend/src/entities/ValueAddedPriceConfig.ts` - æ¡£ä½å®ä½“ç±»

### æ•°æ®åº“
- è¡¨åï¼š`value_added_price_config`
- å­—æ®µï¼šid, company_id, tier_name, tier_order, pricing_type, unit_price, percentage_rate, start_date, end_date, is_active, priority, remark

## åç»­ä¼˜åŒ–å»ºè®®

### 1. ç§»é™¤è°ƒè¯•æ—¥å¿—
é—®é¢˜è§£å†³å¹¶éªŒè¯åï¼Œå¯ä»¥ç§»é™¤ä»¥ä¸‹è°ƒè¯•æ—¥å¿—ï¼š
- `[PriceTierDialog]` ç›¸å…³æ—¥å¿—
- `[handleTierSaved]` ç›¸å…³æ—¥å¿—
- `[loadCompanyTiers]` ç›¸å…³æ—¥å¿—

### 2. ç»Ÿä¸€å“åº”å¤„ç†
å»ºè®®åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€å¤„ç† API å“åº”ï¼Œé¿å…ç±»ä¼¼é—®é¢˜ï¼š
```javascript
// åˆ›å»ºä¸€ä¸ªå·¥å…·å‡½æ•°
function extractData(res: any) {
  return Array.isArray(res) ? res : (res?.data || res)
}

// ä½¿ç”¨
const res = await getCompanyPriceTiers(companyId)
companyTiers.value = extractData(res)
```

### 3. TypeScript ç±»å‹å®šä¹‰
ä¸º API å“åº”æ·»åŠ æ˜ç¡®çš„ç±»å‹å®šä¹‰ï¼Œé¿å…æ··æ·†ï¼š
```typescript
interface ApiResponse<T> {
  success: boolean
  data: T
  message?: string
}

// æ‹¦æˆªå™¨è¿”å›ç±»å‹åº”è¯¥æ˜¯ Tï¼Œä¸æ˜¯ ApiResponse<T>
```

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸‰ä¸ªé—®é¢˜ï¼š
1. âœ… æ¡£ä½åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ - ä¿®å¤äº†å“åº”æ•°æ®è®¿é—®é”™è¯¯
2. âœ… åˆ é™¤æŒ‰é’® - ç¡®è®¤å·²å­˜åœ¨ï¼Œåªæ˜¯åˆ—è¡¨ä¸ºç©ºæ—¶çœ‹ä¸åˆ°
3. âœ… æ— é™æœŸé€‰é¡¹ - å·²æ·»åŠ å®Œæ•´åŠŸèƒ½

æ ¸å¿ƒé—®é¢˜æ˜¯ Axios å“åº”æ‹¦æˆªå™¨å·²ç»æå–äº† `data` å­—æ®µï¼Œä½†ä»£ç ä¸­ä»ç„¶å°è¯•è®¿é—® `res.data`ï¼Œå¯¼è‡´è·å–åˆ° `undefined`ã€‚è¿™ä¸ªé—®é¢˜åœ¨ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºä¸­ä¹Ÿå‡ºç°è¿‡ï¼Œè¯´æ˜éœ€è¦åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ API å“åº”å¤„ç†æ–¹å¼ã€‚
