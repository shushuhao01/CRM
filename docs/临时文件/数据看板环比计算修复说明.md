# 数据看板环比计算修复说明

## 问题描述
数据看板的汇总卡片中，环比指标显示都是 0%，但被对比的数据是有值的。

## 问题原因
后端环比计算逻辑不完整，没有正确处理以下情况：
- 当今天/本月数据为 0，但昨天/上月有数据时，应该显示 -100%
- 原来的逻辑只判断了 `previous === 0` 的情况，没有判断 `current === 0` 的情况

## 修复方案

### 修改文件
`backend/src/routes/dashboard.ts` - 修复 `calculateChange` 函数

### 修复前的逻辑
```typescript
const calculateChange = (current: number, previous: number) => {
  if (previous === 0) {
    return { change: current > 0 ? 100 : 0, trend: current > 0 ? 'up' : 'stable' };
  }
  const change = Number((((current - previous) / previous) * 100).toFixed(1));
  const trend = change > 0 ? 'up' : change < 0 ? 'down' : 'stable';
  return { change, trend };
};
```

### 修复后的逻辑
```typescript
const calculateChange = (current: number, previous: number) => {
  // 如果昨天/上月为0
  if (previous === 0) {
    if (current > 0) {
      // 从0增长到有数据，显示+100%
      return { change: 100, trend: 'up' };
    }
    // 都为0，显示0%
    return { change: 0, trend: 'stable' };
  }
  
  // 如果今天/本月为0，但昨天/上月有数据
  if (current === 0) {
    // 从有数据降到0，显示-100%
    return { change: -100, trend: 'down' };
  }
  
  // 正常计算环比
  const change = Number((((current - previous) / previous) * 100).toFixed(1));
  const trend = change > 0 ? 'up' : change < 0 ? 'down' : 'stable';
  return { change, trend };
};
```

## 环比计算规则

| 情况 | 昨天/上月 | 今天/本月 | 环比显示 | 趋势 |
|------|----------|----------|---------|------|
| 1 | 0 | 0 | 0% | stable |
| 2 | 0 | >0 | +100% | up |
| 3 | >0 | 0 | -100% | down |
| 4 | >0 | >0 | 实际计算 | up/down/stable |

## 测试验证

### 测试脚本
创建了 `backend/test-dashboard-metrics.js` 用于测试环比计算

### 测试结果
```bash
node backend/test-dashboard-metrics.js
```

输出示例：
```
=== 订单数据 ===
今日订单： 0 单，金额：¥ 0
昨日订单： 0 单，金额：¥ 0
本月订单： 0 单，金额：¥ 0
上月订单： 9 单，金额：¥ 7396.00

=== 环比计算 ===
今日订单环比： 0 %
今日金额环比： 0 %
本月订单环比： -100 %  ← 修复后正确显示
本月金额环比： -100 %  ← 修复后正确显示
```

## 部署步骤

1. 拉取最新代码
2. 重启后端服务：
   ```bash
   pm2 restart backend
   ```
3. 刷新前端页面，查看数据看板
4. 验证环比数据显示正确

## 影响范围
- 数据看板的所有环比指标：
  - 今日订单环比
  - 今日业绩环比
  - 新增客户环比
  - 本月单数环比
  - 本月业绩环比
  - 本月签收单数环比
  - 本月签收业绩环比

## 注意事项
- 修复后，如果当前周期（今天/本月）没有数据，但上一周期有数据，会显示 -100%
- 这是正常的业务逻辑，表示业绩下降到0
- 如果两个周期都没有数据，显示 0%（持平）
