# 订单审核撤销功能优化

## 修改时间
2026-03-02

## 问题描述
订单管理模块的订单审核页面，在"已审核通过"标签页中，操作列有"撤销"按钮。
目前该按钮即使订单已发货也能撤销，这不符合业务逻辑。

## 需求
一旦订单状态是发货以后（即物流管理模块的发货列表提交订单发货以后），撤销按钮应该禁用且不可撤销，并提示不能撤销的原因。

## 实现方案

### 1. 订单状态说明
- `pending_shipment`: 待发货（审核通过后的初始状态）
- `shipped`: 已发货（物流发货后的状态）
- `delivered`: 已签收
- `completed`: 已完成

### 2. 撤销规则
- ✅ 可撤销：订单状态为 `pending_shipment`（待发货）
- ❌ 不可撤销：订单状态为 `shipped`（已发货）及之后的所有状态

### 3. 代码修改

#### 3.1 接口定义（AuditOrder）
在订单接口中添加 `status` 字段，用于存储订单的实际状态：

```typescript
interface AuditOrder {
  // ... 其他字段
  auditStatus: 'pending' | 'approved' | 'rejected'  // 审核状态
  status?: string  // 🔥 新增：订单实际状态（shipped, delivered等）
  // ... 其他字段
}
```

#### 3.2 判断函数（canRevokeOrder）
新增判断函数，用于检查订单是否可以撤销：

```typescript
/**
 * 判断订单是否可以撤销审核
 * 规则：只有未发货的订单才能撤销（pending_shipment状态）
 */
const canRevokeOrder = (row: AuditOrder): boolean => {
  // 如果没有status字段，默认允许撤销（兼容旧数据）
  if (!row.status) {
    return true
  }
  
  // 只有待发货状态才能撤销，已发货及之后的状态都不能撤销
  return row.status === 'pending_shipment'
}
```

#### 3.3 撤销按钮UI优化
使用 `el-tooltip` 组件，根据订单状态显示不同的按钮状态和提示：

```vue
<!-- 已审核通过状态的操作按钮 -->
<template v-else-if="activeTab === 'approved'">
  <!-- 可撤销：显示正常的撤销按钮 -->
  <el-tooltip
    v-if="canRevokeOrder(row)"
    content="撤销审核"
    placement="top"
  >
    <el-button
      @click="handleReAudit(row, 'rejected')"
      type="danger"
      link
      size="small"
      :icon="Close"
    >
      撤销
    </el-button>
  </el-tooltip>
  
  <!-- 不可撤销：显示禁用的按钮并提示原因 -->
  <el-tooltip
    v-else
    content="订单已发货，无法撤销审核"
    placement="top"
  >
    <el-button
      type="info"
      link
      size="small"
      :icon="Close"
      disabled
    >
      撤销
    </el-button>
  </el-tooltip>
</template>
```

#### 3.4 撤销操作增强（handleReAudit）
在撤销操作函数中添加状态检查：

```typescript
const handleReAudit = (row: AuditOrder, result: 'approved' | 'rejected') => {
  const actionText = result === 'approved' ? '重新通过' : '撤销'
  
  // 🔥 如果是撤销操作，检查订单状态
  if (result === 'rejected' && !canRevokeOrder(row)) {
    ElMessage.warning('订单已发货，无法撤销审核')
    return
  }
  
  // ... 后续操作
}
```

#### 3.5 数据加载优化
确保从后端加载的订单数据包含 `status` 字段：

```typescript
const convertedOrders = list.map((order: any) => {
  return {
    // ... 其他字段
    auditStatus: order.auditStatus,
    status: order.status, // 🔥 保留订单实际状态，用于判断是否可撤销
    // ... 其他字段
  }
})
```

## 用户体验

### 待发货订单（可撤销）
- 按钮状态：正常显示，红色危险按钮
- 鼠标悬停：显示"撤销审核"提示
- 点击行为：弹出确认对话框，确认后执行撤销操作

### 已发货订单（不可撤销）
- 按钮状态：禁用状态，灰色信息按钮
- 鼠标悬停：显示"订单已发货，无法撤销审核"提示
- 点击行为：无响应（按钮已禁用）

## 测试要点

1. ✅ 待发货订单（pending_shipment）：撤销按钮可用，能正常撤销
2. ✅ 已发货订单（shipped）：撤销按钮禁用，鼠标悬停显示提示
3. ✅ 已签收订单（delivered）：撤销按钮禁用，鼠标悬停显示提示
4. ✅ 已完成订单（completed）：撤销按钮禁用，鼠标悬停显示提示
5. ✅ 旧数据兼容：没有status字段的订单默认允许撤销

## 相关文件
- `src/views/Order/Audit.vue` - 订单审核页面
- `backend/src/routes/orders.ts` - 订单审核API

## 业务流程
1. 订单创建 → `pending_audit`（待审核）
2. 审核通过 → `pending_shipment`（待发货）✅ 可撤销
3. 物流发货 → `shipped`（已发货）❌ 不可撤销
4. 客户签收 → `delivered`（已签收）❌ 不可撤销
5. 订单完成 → `completed`（已完成）❌ 不可撤销

## 注意事项
1. 撤销功能只在"已审核通过"标签页显示
2. 撤销操作会将订单状态改回"审核拒绝"
3. 已发货的订单无法撤销，需要通过售后流程处理
4. 兼容旧数据：如果订单没有status字段，默认允许撤销
