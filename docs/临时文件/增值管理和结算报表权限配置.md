# 增值管理和结算报表权限配置说明

> 创建时间：2026-03-01
> 模块：财务管理 - 增值管理、结算报表
> 状态：已完成权限配置

---

## 一、权限概述

增值管理和结算报表是财务管理模块的核心功能，仅对管理员、超级管理员以及特定授权人员开放。

### 1.1 功能说明

| 功能模块 | 路径 | 功能描述 |
|---------|------|----------|
| 增值管理 | `/finance/value-added-manage` | 管理外包公司增值订单，包括订单创建、状态管理、公司管理、价格配置等 |
| 结算报表 | `/finance/settlement-report` | 查看增值订单结算报表，包括统计图表、公司排名、数据导出等 |

### 1.2 权限策略

- **默认权限**：仅超级管理员和管理员
- **扩展权限**：可通过系统角色权限配置授予特定人员
- **数据范围**：全公司数据（不区分部门和个人）

---

## 二、权限ID设计

### 2.1 命名规范

遵循系统统一的权限ID命名规范：`模块.子模块.操作`

- **一级**：`finance` - 财务管理模块
- **二级**：`finance.value_added` - 增值管理
- **三级**：`finance.value_added.view` - 查看增值订单

### 2.2 增值管理权限列表

| 权限ID | 权限名称 | 权限类型 | 说明 |
|--------|---------|---------|------|
| `finance.value_added` | 增值管理 | menu | 二级菜单权限 |
| `finance.value_added.view` | 查看增值订单 | button | 查看订单列表 |
| `finance.value_added.create` | 创建增值订单 | button | 创建新订单 |
| `finance.value_added.edit` | 编辑增值订单 | button | 编辑订单信息 |
| `finance.value_added.delete` | 删除增值订单 | button | 删除订单 |
| `finance.value_added.batch` | 批量操作订单 | button | 批量处理订单 |
| `finance.value_added.export` | 导出订单数据 | button | 导出Excel |
| `finance.value_added.company` | 管理外包公司 | button | 管理公司信息 |
| `finance.value_added.price_tier` | 配置价格档位 | button | 配置价格档位 |
| `finance.value_added.status_config` | 配置状态选项 | button | 配置状态选项 |

### 2.3 结算报表权限列表

| 权限ID | 权限名称 | 权限类型 | 说明 |
|--------|---------|---------|------|
| `finance.settlement_report` | 结算报表 | menu | 二级菜单权限 |
| `finance.settlement_report.view` | 查看结算报表 | button | 查看报表数据 |
| `finance.settlement_report.export` | 导出报表数据 | button | 导出Excel |
| `finance.settlement_report.charts` | 查看统计图表 | button | 查看图表 |
| `finance.settlement_report.ranking` | 查看公司排名 | button | 查看排名列表 |

---

## 三、角色权限配置

### 3.1 超级管理员 (super_admin)

**权限标识**: `*` (所有权限)

**增值管理权限**:
- ✅ 所有增值管理权限
- ✅ 所有结算报表权限
- ✅ 查看全公司数据
- ✅ 所有操作权限

### 3.2 管理员 (admin)

**权限标识**: `*` (所有权限)

**增值管理权限**:
- ✅ 所有增值管理权限
- ✅ 所有结算报表权限
- ✅ 查看全公司数据
- ✅ 所有操作权限

### 3.3 部门经理 (department_manager)

**默认权限**: ❌ 无权限

**可授予权限**:
- 可通过系统角色权限配置授予查看权限
- 建议仅授予查看和导出权限
- 不建议授予编辑和删除权限

### 3.4 销售员 (sales_staff)

**默认权限**: ❌ 无权限

**可授予权限**:
- 可通过系统角色权限配置授予查看权限
- 建议仅授予查看权限
- 不建议授予任何操作权限

### 3.5 客服 (customer_service)

**默认权限**: ❌ 无权限

**可授予权限**:
- 不建议授予任何权限
- 客服角色不涉及财务管理

---

## 四、数据库配置

### 4.1 SQL脚本

权限配置SQL脚本位置：
```
backend/database-migrations/add-value-added-permissions.sql
```

### 4.2 执行步骤

1. **备份数据库**
   ```bash
   mysqldump -u root -p crm_local > backup_$(date +%Y%m%d).sql
   ```

2. **执行SQL脚本**
   ```bash
   mysql -u root -p crm_local < backend/database-migrations/add-value-added-permissions.sql
   ```

3. **验证权限**
   ```sql
   SELECT id, name, code, module, type, path, sort, status
   FROM permissions 
   WHERE code LIKE 'finance.value_added%' OR code LIKE 'finance.settlement_report%'
   ORDER BY sort;
   ```

4. **清除缓存**
   - 清除用户权限缓存
   - 或要求用户重新登录

### 4.3 生产环境部署

**宝塔面板执行步骤**：

1. 登录宝塔面板
2. 进入数据库管理
3. 选择 `crm_production` 数据库
4. 点击"SQL命令行"
5. 复制 `add-value-added-permissions.sql` 内容
6. 分段执行（避免超时）：
   - 第一段：INSERT permissions
   - 第二段：INSERT role_permissions
   - 第三段：INSERT permissions_closure
   - 第四段：SELECT 验证

---

## 五、前端配置

### 5.1 菜单配置

文件位置：`src/config/menu.ts`

```typescript
{
  id: 'finance-value-added-manage',
  title: '增值管理',
  path: '/finance/value-added-manage',
  roles: ['super_admin', 'admin'],
  permissions: ['finance.value_added']
},
{
  id: 'finance-settlement-report',
  title: '结算报表',
  path: '/finance/settlement-report',
  roles: ['super_admin', 'admin'],
  permissions: ['finance.settlement_report']
}
```

### 5.2 路由配置

文件位置：`src/router/index.ts`

```typescript
{
  path: '/finance/value-added-manage',
  name: 'FinanceValueAddedManage',
  component: () => import('../views/Finance/ValueAddedManage.vue'),
  meta: { 
    title: '增值管理', 
    requiresAuth: true, 
    permissions: ['finance.value_added'] 
  }
},
{
  path: '/finance/settlement-report',
  name: 'FinanceSettlementReport',
  component: () => import('../views/Finance/SettlementReport.vue'),
  meta: { 
    title: '结算报表', 
    requiresAuth: true, 
    permissions: ['finance.settlement_report'] 
  }
}
```

### 5.3 权限检查

在页面组件中使用权限检查：

```typescript
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()

// 检查是否有权限
const hasPermission = (permission: string) => {
  return userStore.hasPermission(permission)
}

// 检查按钮权限
const canEdit = computed(() => hasPermission('finance.value_added.edit'))
const canDelete = computed(() => hasPermission('finance.value_added.delete'))
const canExport = computed(() => hasPermission('finance.value_added.export'))
```

---

## 六、后端API权限控制

### 6.1 路由中间件

文件位置：`backend/src/routes/valueAdded.ts`

```typescript
import { authenticateToken, checkPermission } from '../middleware/auth'

// 增值管理路由
router.get('/orders', 
  authenticateToken, 
  checkPermission('finance.value_added.view'),
  async (req, res) => {
    // 查询订单列表
  }
)

router.post('/orders', 
  authenticateToken, 
  checkPermission('finance.value_added.create'),
  async (req, res) => {
    // 创建订单
  }
)

router.put('/orders/:id', 
  authenticateToken, 
  checkPermission('finance.value_added.edit'),
  async (req, res) => {
    // 更新订单
  }
)

router.delete('/orders/:id', 
  authenticateToken, 
  checkPermission('finance.value_added.delete'),
  async (req, res) => {
    // 删除订单
  }
)

// 结算报表路由
router.get('/settlement-report', 
  authenticateToken, 
  checkPermission('finance.settlement_report.view'),
  async (req, res) => {
    // 查询报表数据
  }
)
```

### 6.2 权限中间件实现

文件位置：`backend/src/middleware/auth.ts`

```typescript
export const checkPermission = (requiredPermission: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const user = (req as any).currentUser
    
    // 超级管理员和管理员拥有所有权限
    if (user.role === 'super_admin' || user.role === 'admin') {
      return next()
    }
    
    // 检查用户权限
    const userPermissions = user.permissions || []
    if (userPermissions.includes(requiredPermission)) {
      return next()
    }
    
    // 无权限
    return res.status(403).json({
      success: false,
      message: '无权限访问'
    })
  }
}
```

---

## 七、权限授予流程

### 7.1 通过角色权限配置

1. 登录系统（超级管理员或管理员）
2. 进入"系统管理" → "角色权限"
3. 选择要配置的角色（如"部门经理"）
4. 点击"权限设置"按钮
5. 在权限树中找到"财务管理"
6. 展开"增值管理"和"结算报表"
7. 勾选需要的权限
8. 点击"保存权限"
9. 用户重新登录后生效

### 7.2 通过用户个人权限

1. 登录系统（超级管理员或管理员）
2. 进入"系统管理" → "用户管理"
3. 找到要授权的用户
4. 点击"权限设置"按钮
5. 勾选需要的权限
6. 填写授权原因
7. 点击"保存"
8. 用户重新登录后生效

---

## 八、注意事项

1. **权限粒度**
   - 菜单权限控制页面访问
   - 按钮权限控制操作权限
   - API权限控制后端接口

2. **数据安全**
   - 增值管理涉及财务数据，权限控制严格
   - 建议仅授予必要人员
   - 定期审计权限使用情况

3. **权限缓存**
   - 权限变更后需要清除缓存
   - 或要求用户重新登录
   - 前端和后端都需要更新

4. **权限继承**
   - 拥有父级权限自动拥有子级权限
   - 例如：`finance.value_added` 包含所有 `finance.value_added.*`

5. **权限验证**
   - 前端验证仅用于UI显示
   - 后端验证是安全保障
   - 两者必须同时实现

---

## 九、测试验证

### 9.1 功能测试

1. **超级管理员测试**
   - ✅ 可以访问增值管理
   - ✅ 可以访问结算报表
   - ✅ 可以执行所有操作

2. **管理员测试**
   - ✅ 可以访问增值管理
   - ✅ 可以访问结算报表
   - ✅ 可以执行所有操作

3. **部门经理测试**
   - ❌ 默认无法访问
   - ✅ 授权后可以访问
   - ✅ 仅能执行授权的操作

4. **销售员测试**
   - ❌ 默认无法访问
   - ✅ 授权后可以访问
   - ✅ 仅能执行授权的操作

5. **客服测试**
   - ❌ 无法访问
   - ❌ 不建议授权

### 9.2 权限测试

1. **菜单显示测试**
   - 无权限用户不显示菜单
   - 有权限用户显示菜单

2. **页面访问测试**
   - 无权限用户访问返回403
   - 有权限用户正常访问

3. **按钮权限测试**
   - 无权限用户按钮隐藏或禁用
   - 有权限用户按钮可用

4. **API权限测试**
   - 无权限用户调用API返回403
   - 有权限用户调用API成功

---

## 十、常见问题

### Q1: 为什么我看不到增值管理菜单？

**A**: 检查以下几点：
1. 确认你的角色是否有权限
2. 确认权限是否已配置
3. 尝试重新登录
4. 清除浏览器缓存

### Q2: 如何给部门经理授予查看权限？

**A**: 
1. 进入"系统管理" → "角色权限"
2. 选择"部门经理"角色
3. 勾选 `finance.value_added.view` 和 `finance.settlement_report.view`
4. 保存后让用户重新登录

### Q3: 权限配置后不生效怎么办？

**A**:
1. 清除用户权限缓存
2. 要求用户重新登录
3. 检查后端API是否添加了权限中间件
4. 检查前端路由是否配置了权限

### Q4: 如何撤销某个用户的权限？

**A**:
1. 进入"系统管理" → "用户管理"
2. 找到该用户
3. 点击"权限设置"
4. 取消勾选相应权限
5. 保存后让用户重新登录

---

> 文档结束


---

## 十一、权限树配置完成

### 11.1 已完成的工作

✅ **权限树数据源更新** (`src/services/permissionService.js`)
- 在财务管理模块下添加了增值管理和结算报表的权限节点
- 增值管理权限节点（9个子权限）：
  - `finance.value_added.view` - 查看增值列表
  - `finance.value_added.create` - 新增增值
  - `finance.value_added.edit` - 编辑增值
  - `finance.value_added.delete` - 删除增值
  - `finance.value_added.batch` - 批量操作
  - `finance.value_added.export` - 导出数据
  - `finance.value_added.company` - 外包公司管理
  - `finance.value_added.price_tier` - 价格档位管理
  - `finance.value_added.status_config` - 状态配置管理
- 结算报表权限节点（4个子权限）：
  - `finance.settlement_report.view` - 查看报表
  - `finance.settlement_report.export` - 导出报表
  - `finance.settlement_report.charts` - 查看图表
  - `finance.settlement_report.ranking` - 查看排名

### 11.2 权限树结构

```
财务管理 (finance)
├── 绩效数据 (finance.performance_data)
│   └── 查看绩效数据
├── 绩效管理 (finance.performance_manage)
│   ├── 查看绩效管理
│   ├── 编辑绩效
│   └── 配置管理
├── 代收管理 (finance.cod_collection)
│   ├── 查看代收
│   ├── 导出代收
│   ├── 编辑代收
│   └── 返款操作
├── 增值管理 (finance.value_added) ✨ 新增
│   ├── 查看增值列表
│   ├── 新增增值
│   ├── 编辑增值
│   ├── 删除增值
│   ├── 批量操作
│   ├── 导出数据
│   ├── 外包公司管理
│   ├── 价格档位管理
│   └── 状态配置管理
└── 结算报表 (finance.settlement_report) ✨ 新增
    ├── 查看报表
    ├── 导出报表
    ├── 查看图表
    └── 查看排名
```

### 11.3 权限生效说明

1. **权限树自动加载**：
   - 系统管理 → 角色权限 → 权限设置对话框
   - 权限树会自动从 `permissionService.getAllPermissions()` 加载
   - 新增的权限节点会立即显示在权限树中

2. **权限保存机制**：
   - 勾选权限后点击"保存权限"
   - 权限保存到数据库 `roles` 表的 `permissions` 字段（JSON格式）
   - 同时更新本地缓存

3. **权限验证**：
   - 前端：通过 `hasPermission()` 方法检查权限
   - 后端：通过中间件验证用户权限
   - 菜单显示：根据 `menu.ts` 中的 `permissions` 字段控制

### 11.4 使用方法

1. **查看权限树**：
   - 登录系统（超级管理员或管理员）
   - 进入"系统管理" → "角色权限"
   - 选择任意角色，点击"权限设置"
   - 在权限树中展开"财务管理"
   - 可以看到新增的"增值管理"和"结算报表"节点

2. **配置权限**：
   - 勾选需要的权限节点
   - 点击"保存权限"按钮
   - 系统会自动保存到数据库
   - 用户重新登录后生效

3. **验证权限**：
   - 使用配置了权限的账号登录
   - 检查左侧菜单是否显示"增值管理"和"结算报表"
   - 进入页面后检查按钮权限是否正确

### 11.5 下一步工作

- [ ] 测试权限树勾选和保存功能
- [ ] 验证权限在前端和后端的生效情况
- [ ] 为超级管理员和管理员角色默认分配这些权限
- [ ] 更新生产环境数据库

---

> 更新时间：2026-03-01
> 更新内容：完成权限树配置，新增增值管理和结算报表权限节点
