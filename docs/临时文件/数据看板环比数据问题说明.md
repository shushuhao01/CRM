# 数据看板环比数据问题说明

## 问题描述
数据看板主页的汇总卡片中显示的环比数据（如"+0%"）是硬编码的，并非真实计算的环比值。

## 当前状态
所有卡片的环比数据都初始化为`'+0%'`，且在数据加载后没有更新：

```typescript
const metrics = ref([
  {
    key: 'orders',
    label: '今日订单',
    value: '0',
    change: '+0%',  // 硬编码
    trend: 'up',
    // ...
  },
  // 其他卡片也是类似
])
```

## 影响范围
以下卡片的环比数据都是硬编码的：
1. 今日订单
2. 新增客户
3. 今日业绩
4. 本月单数
5. 本月业绩
6. 待处理售后
7. 待审核订单
8. 待发货订单
9. 本月签收单数
10. 本月签收业绩

## 问题原因
1. 后端API `/dashboard/metrics` 只返回当前数据，不返回环比数据
2. 前端在`loadRealMetrics`函数中只更新了`value`和`label`，没有更新`change`和`trend`
3. 没有对比历史数据的逻辑

## 解决方案

### 方案1：后端计算环比（推荐）
**优点**：
- 计算准确，性能好
- 前端代码简单
- 可以缓存计算结果

**实现步骤**：
1. 后端API返回环比数据：
```typescript
{
  todayOrders: 10,
  todayOrdersChange: 20.5,  // 环比增长20.5%
  todayOrdersTrend: 'up',   // 趋势：up/down/stable
  // 其他指标类似
}
```

2. 前端更新环比显示：
```typescript
metrics.value[0].change = `${metricsData.todayOrdersChange > 0 ? '+' : ''}${metricsData.todayOrdersChange}%`
metrics.value[0].trend = metricsData.todayOrdersTrend
```

### 方案2：前端计算环比
**优点**：
- 不需要修改后端
- 灵活性高

**缺点**：
- 需要额外请求历史数据
- 计算逻辑复杂
- 性能开销大

**实现步骤**：
1. 请求昨天/上月的数据
2. 计算环比：`(当前值 - 历史值) / 历史值 * 100`
3. 更新显示

## 环比计算公式

### 日环比（今日 vs 昨日）
```
日环比 = (今日数据 - 昨日数据) / 昨日数据 * 100%
```

### 月环比（本月 vs 上月）
```
月环比 = (本月数据 - 上月数据) / 上月数据 * 100%
```

### 趋势判断
- `up`: 环比 > 0
- `down`: 环比 < 0
- `stable`: 环比 = 0

## 示例代码

### 后端实现（推荐）
```typescript
// backend/src/controllers/DashboardController.ts
async getMetrics(req: Request, res: Response) {
  // 获取今日数据
  const todayOrders = await this.getTodayOrders()
  
  // 获取昨日数据
  const yesterdayOrders = await this.getYesterdayOrders()
  
  // 计算环比
  const todayOrdersChange = yesterdayOrders > 0 
    ? ((todayOrders - yesterdayOrders) / yesterdayOrders * 100).toFixed(1)
    : 0
  
  const todayOrdersTrend = todayOrdersChange > 0 ? 'up' : 
                          todayOrdersChange < 0 ? 'down' : 'stable'
  
  res.json({
    success: true,
    data: {
      todayOrders,
      todayOrdersChange,
      todayOrdersTrend,
      // 其他指标...
    }
  })
}
```

### 前端实现
```typescript
// src/views/Dashboard.vue
const loadRealMetrics = async () => {
  const metricsData = await dashboardApi.getMetrics()
  
  // 更新今日订单
  metrics.value[0].value = (metricsData.todayOrders || 0).toString()
  metrics.value[0].change = `${metricsData.todayOrdersChange > 0 ? '+' : ''}${metricsData.todayOrdersChange}%`
  metrics.value[0].trend = metricsData.todayOrdersTrend
  
  // 更新其他指标...
}
```

## 相关文件
- `src/views/Dashboard.vue` - 数据看板主页
- `src/api/dashboard.ts` - Dashboard API
- `backend/src/controllers/DashboardController.ts` - 后端控制器（需要创建）
- `backend/src/routes/dashboard.ts` - 后端路由（需要创建）

## 建议
1. 优先使用后端计算方案，性能更好
2. 如果后端暂时无法实现，可以先在前端实现简单的环比计算
3. 考虑添加环比数据的缓存机制，避免频繁计算

## 注意事项
1. 环比计算需要考虑除零情况（昨日/上月数据为0）
2. 环比数据应该保留1-2位小数
3. 趋势图标和颜色要与环比值匹配
4. 考虑添加环比数据的tooltip说明

## 状态
- ✅ 已修复 - 后端计算环比数据，前端显示
- 修复日期：2026-02-28

## 修复内容

### 后端修复
**文件**: `backend/src/routes/dashboard.ts`

1. 添加昨天和上月的数据查询
2. 实现环比计算函数`calculateChange`
3. 为所有指标计算环比和趋势
4. API返回环比数据字段

**关键代码**:
```typescript
// 计算环比的辅助函数
const calculateChange = (current: number, previous: number): { change: number; trend: string } => {
  if (previous === 0) {
    return { change: current > 0 ? 100 : 0, trend: current > 0 ? 'up' : 'stable' };
  }
  const change = Number((((current - previous) / previous) * 100).toFixed(1));
  const trend = change > 0 ? 'up' : change < 0 ? 'down' : 'stable';
  return { change, trend };
};

// 返回数据包含环比
{
  todayOrders,
  todayOrdersChange: todayOrdersChange.change,
  todayOrdersTrend: todayOrdersChange.trend,
  // 其他指标...
}
```

### 前端修复
**文件**: `src/views/Dashboard.vue`

更新`loadRealMetrics`函数，使用后端返回的环比数据：

```typescript
// 今日订单
metrics.value[0].value = (metricsData.todayOrders || 0).toString()
metrics.value[0].change = `${metricsData.todayOrdersChange > 0 ? '+' : ''}${metricsData.todayOrdersChange || 0}%`
metrics.value[0].trend = metricsData.todayOrdersTrend || 'stable'
```

## 环比计算说明

### 日环比指标
- 今日订单 vs 昨日订单
- 新增客户 vs 昨日新增
- 今日业绩 vs 昨日业绩

### 月环比指标
- 本月单数 vs 上月单数
- 本月业绩 vs 上月业绩
- 本月签收单数 vs 上月签收单数
- 本月签收业绩 vs 上月签收业绩

### 待处理指标
- 待处理售后、待审核订单、待发货订单
- 这些是实时数据，环比暂时设为0（可后续优化）

## 测试验证

1. 重启后端服务
2. 刷新数据看板页面
3. 查看各卡片的环比数据是否正确显示
4. 检查趋势图标（↑↓）是否与环比值匹配

## 相关文件
- `backend/src/routes/dashboard.ts` - 后端路由，计算环比
- `src/views/Dashboard.vue` - 前端页面，显示环比
- `src/api/dashboard.ts` - API接口定义
