# 生产环境增值管理修复指南

## 问题描述
生产环境增值管理出现以下问题：
1. 价格档位保存失败
2. 添加公司后提示"请先保存公司基本信息"
3. 可能缺少必要的数据库表或字段

## 问题原因
生产环境数据库缺少以下内容：
1. `value_added_price_config` 表（价格档位表）
2. `value_added_status_configs` 表（状态配置表）
3. `value_added_remark_presets` 表（备注预设表）
4. `value_added_orders` 表的部分字段（express_company, order_status, order_date）
5. `outsource_companies` 表的 sort_order 字段
6. 必要的索引和初始数据

## 解决方案

### 方案1：完整修复SQL（推荐）
使用文件：`backend/database-migrations/production-fix-value-added-baota.sql`

#### 执行步骤（宝塔phpMyAdmin）

1. **登录宝塔phpMyAdmin**
   - 打开宝塔面板
   - 进入数据库管理
   - 选择CRM数据库

2. **执行SQL（按顺序逐条执行）**

   **第1步：检查表是否存在**
   ```sql
   SELECT 
     TABLE_NAME,
     TABLE_COMMENT
   FROM INFORMATION_SCHEMA.TABLES
   WHERE TABLE_SCHEMA = DATABASE()
     AND TABLE_NAME IN (
       'value_added_orders',
       'outsource_companies',
       'value_added_price_config',
       'value_added_status_configs',
       'value_added_remark_presets'
     );
   ```
   查看结果，确认哪些表已存在。

   **第2-6步：创建缺失的表**
   依次执行SQL文件中的第2-6步，创建以下表：
   - value_added_orders（增值订单表）
   - outsource_companies（外包公司表）
   - value_added_price_config（价格档位表）⭐ 关键
   - value_added_status_configs（状态配置表）
   - value_added_remark_presets（备注预设表）

   **第7-8步：添加缺失字段**
   ```sql
   -- 为 value_added_orders 添加字段
   ALTER TABLE `value_added_orders` ADD COLUMN `express_company` VARCHAR(50) DEFAULT NULL AFTER `tracking_number`;
   ALTER TABLE `value_added_orders` ADD COLUMN `order_status` VARCHAR(20) DEFAULT NULL AFTER `express_company`;
   ALTER TABLE `value_added_orders` ADD COLUMN `order_date` DATETIME DEFAULT NULL AFTER `order_status`;
   
   -- 为 outsource_companies 添加字段
   ALTER TABLE `outsource_companies` ADD COLUMN `sort_order` INT DEFAULT 999 AFTER `status`;
   ```
   ⚠️ 如果字段已存在会报错，可以忽略继续执行。

   **第9步：创建索引（提升性能）**
   执行SQL文件中的第9步所有索引创建语句。
   ⚠️ 如果索引已存在会报错，可以忽略。

   **第10步：同步数据**
   ```sql
   -- 同步物流公司
   UPDATE `value_added_orders` vo
   INNER JOIN `orders` o ON BINARY vo.order_id = BINARY o.id
   SET vo.express_company = o.express_company
   WHERE vo.order_id IS NOT NULL 
     AND o.express_company IS NOT NULL
     AND o.express_company != ''
     AND (vo.express_company IS NULL OR vo.express_company = '');
   
   -- 同步订单状态
   UPDATE `value_added_orders` vo
   INNER JOIN `orders` o ON BINARY vo.order_id = BINARY o.id
   SET vo.order_status = o.status
   WHERE vo.order_id IS NOT NULL 
     AND o.status IS NOT NULL
     AND (vo.order_status IS NULL OR vo.order_status = '');
   
   -- 同步下单日期
   UPDATE `value_added_orders` vo
   INNER JOIN `orders` o ON BINARY vo.order_id = BINARY o.id
   SET vo.order_date = o.created_at
   WHERE vo.order_id IS NOT NULL 
     AND o.created_at IS NOT NULL
     AND vo.order_date IS NULL;
   ```

   **第11步：初始化状态配置**
   ```sql
   INSERT IGNORE INTO `value_added_status_configs` (`id`, `type`, `value`, `label`, `color`, `sort_order`, `is_system`, `is_active`) VALUES
   ('valid_status_pending', 'validStatus', 'pending', '待处理', 'warning', 1, 1, 1),
   ('valid_status_valid', 'validStatus', 'valid', '有效', 'success', 2, 1, 1),
   ('valid_status_invalid', 'validStatus', 'invalid', '无效', 'danger', 3, 1, 1),
   ('valid_status_supplemented', 'validStatus', 'supplemented', '已补单', 'info', 4, 1, 1),
   ('settlement_status_unsettled', 'settlementStatus', 'unsettled', '未结算', 'warning', 1, 1, 1),
   ('settlement_status_settled', 'settlementStatus', 'settled', '已结算', 'success', 2, 1, 1);
   ```

   **第12步：初始化备注预设**
   执行SQL文件中的第12步，插入备注预设数据。

   **第13步：验证结果**
   ```sql
   SELECT 
     TABLE_NAME,
     TABLE_ROWS
   FROM INFORMATION_SCHEMA.TABLES
   WHERE TABLE_SCHEMA = DATABASE()
     AND TABLE_NAME IN (
       'value_added_orders',
       'outsource_companies',
       'value_added_price_config',
       'value_added_status_configs',
       'value_added_remark_presets'
     );
   ```
   确认所有表都已创建且有数据。

3. **重启后端服务**
   ```bash
   pm2 restart crm-backend
   ```

4. **测试功能**
   - 打开增值管理页面
   - 点击"外包公司管理"
   - 添加新公司
   - 点击"价格档位"标签页
   - 添加价格档位
   - 保存并验证

### 方案2：使用完整SQL文件
使用文件：`backend/database-migrations/production-fix-value-added-complete.sql`

这个文件包含动态SQL，可以自动检测字段是否存在，但宝塔phpMyAdmin可能不支持。建议使用方案1。

## 关键表结构说明

### value_added_price_config（价格档位表）⭐
这是解决价格档位保存失败的关键表。

```sql
CREATE TABLE `value_added_price_config` (
  `id` VARCHAR(50) NOT NULL,
  `company_id` VARCHAR(50) NOT NULL,           -- 外包公司ID
  `tier_name` VARCHAR(100) NOT NULL,           -- 档位名称
  `tier_order` INT NOT NULL DEFAULT 1,         -- 档位顺序
  `pricing_type` VARCHAR(20) NOT NULL,         -- 计价方式: fixed/percentage
  `unit_price` DECIMAL(10,2) DEFAULT 0.00,     -- 单价
  `percentage_rate` DECIMAL(5,2) DEFAULT 0.00, -- 比例
  `start_date` DATE DEFAULT NULL,              -- 生效开始日期
  `end_date` DATE DEFAULT NULL,                -- 生效结束日期
  `is_active` TINYINT NOT NULL DEFAULT 1,      -- 状态
  `priority` INT DEFAULT 0,                    -- 优先级
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### value_added_status_configs（状态配置表）
```sql
CREATE TABLE `value_added_status_configs` (
  `id` VARCHAR(50) NOT NULL,
  `type` VARCHAR(50) NOT NULL,      -- validStatus/settlementStatus
  `value` VARCHAR(50) NOT NULL,     -- 状态值
  `label` VARCHAR(100) NOT NULL,    -- 显示标签
  `color` VARCHAR(50) DEFAULT NULL, -- 颜色
  `sort_order` INT DEFAULT 0,       -- 排序
  `is_system` TINYINT(1) DEFAULT 0, -- 是否系统预设
  `is_active` TINYINT(1) DEFAULT 1, -- 是否启用
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_value` (`type`, `value`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### value_added_remark_presets（备注预设表）
```sql
CREATE TABLE `value_added_remark_presets` (
  `id` VARCHAR(50) NOT NULL,
  `type` VARCHAR(50) NOT NULL,         -- invalid/general
  `remark_text` VARCHAR(500) NOT NULL, -- 备注文本
  `sort_order` INT DEFAULT 0,          -- 排序
  `usage_count` INT DEFAULT 0,         -- 使用次数
  `is_active` TINYINT(1) DEFAULT 1,    -- 是否启用
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 验证清单

执行完SQL后，请验证以下内容：

### 1. 表是否存在
```sql
SHOW TABLES LIKE 'value_added%';
SHOW TABLES LIKE 'outsource%';
```
应该看到5个表：
- value_added_orders
- value_added_price_config ⭐
- value_added_status_configs
- value_added_remark_presets
- outsource_companies

### 2. 价格档位表字段
```sql
DESCRIBE value_added_price_config;
```
确认包含以下关键字段：
- id
- company_id
- tier_name
- pricing_type
- unit_price
- start_date
- end_date

### 3. 状态配置数据
```sql
SELECT * FROM value_added_status_configs;
```
应该有6条记录（4个有效状态 + 2个结算状态）

### 4. 备注预设数据
```sql
SELECT * FROM value_added_remark_presets;
```
应该有12条记录（8个无效原因 + 4个通用备注）

### 5. 索引是否创建
```sql
SHOW INDEX FROM value_added_orders;
SHOW INDEX FROM value_added_price_config;
```

## 常见问题

### Q1: 执行ALTER TABLE时报错"Duplicate column name"
**A:** 这是正常的，说明字段已存在，可以忽略继续执行下一条。

### Q2: 执行CREATE INDEX时报错"Duplicate key name"
**A:** 这是正常的，说明索引已存在，可以忽略继续执行下一条。

### Q3: 价格档位还是保存失败
**A:** 检查以下内容：
1. `value_added_price_config` 表是否存在
2. 表结构是否完整（特别是 company_id, tier_name, pricing_type 字段）
3. 后端服务是否已重启
4. 浏览器控制台是否有错误信息

### Q4: 添加公司后还是提示"请先保存"
**A:** 
1. 确认 `outsource_companies` 表存在
2. 确认 `value_added_price_config` 表存在
3. 清除浏览器缓存
4. 重启后端服务

## 执行时间估算
- 创建表：每个表约1-2秒
- 添加字段：每个字段约1秒
- 创建索引：每个索引约1-2秒
- 同步数据：取决于数据量，通常1-5秒
- 总计：约2-5分钟

## 注意事项
1. ⚠️ 执行前建议备份数据库
2. ⚠️ 在低峰期执行，避免影响业务
3. ⚠️ 逐条执行SQL，确认每条成功后再执行下一条
4. ⚠️ 如果某条SQL报错，先判断是否可以忽略（如字段已存在）
5. ⚠️ 执行完成后必须重启后端服务

## 相关文件
- `backend/database-migrations/production-fix-value-added-baota.sql` - 宝塔兼容版SQL（推荐）
- `backend/database-migrations/production-fix-value-added-complete.sql` - 完整版SQL
- `database/schema.sql` - 数据库结构定义（已更新）
