# 开发环境权限缓存清除指南

## 问题描述
销售员角色在生产环境可以看到财务管理菜单，但在开发环境看不到。

## 原因分析
开发环境的浏览器缓存了旧的权限数据，导致新配置的权限没有生效。

---

## 解决方案

### 方案一：清除浏览器缓存（推荐）

1. **打开浏览器开发者工具**
   - Windows: `F12` 或 `Ctrl + Shift + I`
   - Mac: `Cmd + Option + I`

2. **打开控制台（Console）**

3. **执行以下命令清除缓存**
   ```javascript
   // 清除用户数据
   localStorage.removeItem('user')
   
   // 清除权限数据
   localStorage.removeItem('permissions')
   
   // 清除token
   localStorage.removeItem('auth_token')
   
   // 清除所有localStorage（可选）
   localStorage.clear()
   
   // 刷新页面
   location.reload()
   ```

4. **重新登录**
   - 使用销售员账号重新登录
   - 检查左侧菜单是否显示"财务管理"

---

### 方案二：使用无痕模式测试

1. **打开无痕窗口**
   - Chrome: `Ctrl + Shift + N`
   - Firefox: `Ctrl + Shift + P`
   - Edge: `Ctrl + Shift + N`

2. **访问开发环境地址**
   - 例如：`http://localhost:5173`

3. **登录销售员账号**
   - 无痕模式不会使用缓存数据
   - 可以验证新权限配置是否正确

---

### 方案三：手动清除浏览器数据

1. **Chrome浏览器**
   - 打开设置：`chrome://settings/`
   - 隐私和安全 → 清除浏览数据
   - 选择"Cookie 和其他网站数据"和"缓存的图片和文件"
   - 时间范围选择"全部时间"
   - 点击"清除数据"

2. **Firefox浏览器**
   - 打开设置：`about:preferences#privacy`
   - Cookie 和网站数据 → 清除数据
   - 勾选"Cookie 和网站数据"和"缓存的 Web 内容"
   - 点击"清除"

3. **Edge浏览器**
   - 打开设置：`edge://settings/privacy`
   - 清除浏览数据 → 选择要清除的内容
   - 选择"Cookie 和其他网站数据"和"缓存的图像和文件"
   - 点击"立即清除"

---

### 方案四：强制刷新页面

1. **Windows**
   - `Ctrl + F5` 或 `Ctrl + Shift + R`

2. **Mac**
   - `Cmd + Shift + R`

3. **如果还不行，尝试**
   - `Ctrl + Shift + Delete` 打开清除缓存对话框
   - 清除缓存后再刷新

---

## 验证步骤

### 1. 检查权限是否加载

打开浏览器控制台，执行：

```javascript
// 查看当前用户信息
console.log('当前用户:', JSON.parse(localStorage.getItem('user')))

// 查看权限列表
console.log('权限列表:', localStorage.getItem('permissions'))
```

### 2. 检查权限配置

销售员应该有以下权限：

```javascript
[
  'finance',
  'finance.performance_data',
  'finance.performance_data.view',
  'finance.cod_application',
  'finance.cod_application.view',
  'finance.cod_application.create'
]
```

### 3. 检查菜单显示

登录后，左侧菜单应该显示：
- ✅ 财务管理
  - ✅ 绩效数据
  - ✅ 取消代收申请

不应该显示：
- ❌ 绩效管理
- ❌ 代收管理
- ❌ 取消代收审核

---

## 开发环境特殊说明

### 为什么开发环境容易出现缓存问题？

1. **热更新机制**
   - Vite 的热更新只更新代码，不会清除 localStorage
   - 权限配置修改后，旧的权限数据仍然保留在浏览器中

2. **多次登录测试**
   - 开发时频繁切换账号测试
   - 不同账号的权限数据可能混淆

3. **代码回滚**
   - Git 切换分支或回滚代码
   - 权限配置可能与缓存数据不一致

### 开发建议

1. **修改权限配置后**
   - 总是清除浏览器缓存
   - 或使用无痕模式测试

2. **使用开发工具**
   - 安装 Vue DevTools
   - 可以实时查看 Pinia store 中的权限数据

3. **添加调试日志**
   - 在登录时打印权限加载日志
   - 方便排查权限问题

---

## 生产环境部署注意事项

### 1. 通知用户清除缓存

部署新版本后，通知用户：
- 清除浏览器缓存
- 或重新登录

### 2. 版本号管理

在代码中添加版本号检查：

```typescript
const APP_VERSION = '2.1.0'
const cachedVersion = localStorage.getItem('app_version')

if (cachedVersion !== APP_VERSION) {
  // 清除旧版本缓存
  localStorage.clear()
  localStorage.setItem('app_version', APP_VERSION)
  location.reload()
}
```

### 3. 权限更新机制

实现权限热更新：
- 用户登录时从服务器获取最新权限
- 定期检查权限是否有更新
- 权限更新后自动刷新菜单

---

## 常见问题

### Q1: 清除缓存后还是看不到菜单？

**A:** 检查以下几点：
1. 确认用户角色是否正确（应该是 `sales_staff`）
2. 检查权限配置文件是否已保存
3. 检查后端是否返回了正确的权限数据
4. 查看浏览器控制台是否有错误日志

### Q2: 生产环境正常，开发环境不正常？

**A:** 可能原因：
1. 开发环境代码未更新到最新版本
2. 开发环境使用了不同的权限配置
3. 开发环境的数据库数据与生产环境不一致

### Q3: 部分用户看得到，部分用户看不到？

**A:** 可能原因：
1. 不同用户的浏览器缓存状态不同
2. 部分用户使用了旧版本的浏览器
3. 部分用户的账号角色配置不正确

---

## 快速清除脚本

将以下代码保存为书签，点击即可清除缓存：

```javascript
javascript:(function(){localStorage.clear();sessionStorage.clear();alert('缓存已清除，即将刷新页面');location.reload();})();
```

**使用方法**：
1. 在浏览器中新建书签
2. 将上面的代码粘贴到书签的 URL 中
3. 命名为"清除CRM缓存"
4. 需要清除缓存时，点击这个书签即可

---

> 文档创建时间：2026年2月26日
> 
> 适用版本：v2.1.0+
