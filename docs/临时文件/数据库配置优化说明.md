# 数据库配置优化说明

## 优化内容

### 1. 统一使用 MySQL 数据库

**优化前**：
- 开发环境默认使用 SQLite
- 生产环境使用 MySQL
- 需要通过 `DB_TYPE` 环境变量切换

**优化后**：
- 开发环境和生产环境统一使用 MySQL
- 移除了 SQLite 相关配置
- 简化了数据库配置逻辑

### 2. 简化配置结构

**优化前**：
```typescript
const AppDataSource = new DataSource(
  dbType === 'mysql' ? {
    // MySQL 配置
    entities: [...] // 重复定义
  } : {
    // SQLite 配置
    entities: [...] // 重复定义
  }
);
```

**优化后**：
```typescript
// 实体列表统一管理
const entities = [...];

// 直接使用 MySQL 配置
const AppDataSource = new DataSource({
  type: 'mysql',
  // ...
  entities
});
```

### 3. 增强连接池配置

新增以下配置项：
- `connectionLimit`: 连接池大小（默认10）
- `connectTimeout`: 连接超时时间（60秒）
- `acquireTimeout`: 获取连接超时时间（60秒）
- `timeout`: 空闲连接超时时间（60秒）

### 4. 优化日志输出

**优化前**：
```
📦 正在连接数据库: crm @ localhost:3306
✅ 数据库连接成功
```

**优化后**：
```
📦 正在连接 MySQL 数据库...
   环境: development
   数据库: crm_local
   地址: localhost:3306
   用户: abc789
✅ 数据库连接成功
ℹ️  开发环境：数据库结构变更请执行 database-migrations 目录下的迁移脚本
ℹ️  角色权限使用数据库预设数据（不自动初始化）
```

### 5. 增强错误提示

连接失败时，会显示详细的配置信息：
```
❌ 数据库连接失败: ...
   请检查以下配置:
   - DB_HOST: localhost
   - DB_PORT: 3306
   - DB_DATABASE: crm_local
   - DB_USERNAME: abc789
```

## 配置说明

### 环境变量

| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `DB_TYPE` | 数据库类型 | `mysql` | `mysql` |
| `DB_HOST` | 数据库主机 | `localhost` | `localhost` |
| `DB_PORT` | 数据库端口 | `3306` | `3306` |
| `DB_DATABASE` | 数据库名称 | `crm` | `crm_local` |
| `DB_USERNAME` | 数据库用户名 | `root` | `abc789` |
| `DB_PASSWORD` | 数据库密码 | `` | `YtZWJPF2bpsCscHX` |
| `DB_CHARSET` | 字符集 | `utf8mb4` | `utf8mb4` |
| `DB_CONNECTION_LIMIT` | 连接池大小 | `10` | `20` |

### 开发环境配置示例

`.env.local` 文件：
```env
# MySQL 数据库配置
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=crm_local
DB_USERNAME=abc789
DB_PASSWORD=YtZWJPF2bpsCscHX
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
DB_CONNECTION_LIMIT=10
```

### 生产环境配置示例

`.env` 文件：
```env
# MySQL 数据库配置
DB_TYPE=mysql
DB_HOST=<生产环境IP>
DB_PORT=3306
DB_DATABASE=crm
DB_USERNAME=<生产用户名>
DB_PASSWORD=<生产密码>
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
DB_CONNECTION_LIMIT=20
```

## 优化效果

### 1. 代码简化
- 移除了 SQLite 相关代码（约100行）
- 实体列表统一管理，避免重复定义
- 配置逻辑更清晰，易于维护

### 2. 性能提升
- 统一使用 MySQL，避免了数据库类型判断
- 优化了连接池配置，提高并发性能
- 增加了超时配置，避免连接挂起

### 3. 开发体验
- 开发环境和生产环境配置一致，减少环境差异
- 日志输出更详细，便于问题排查
- 错误提示更友好，快速定位配置问题

## 注意事项

### 1. 数据库结构同步

**重要**：优化后 `synchronize` 设置为 `false`，数据库结构变更需要手动执行迁移脚本。

```bash
# 执行迁移脚本
mysql -h localhost -u abc789 -p crm_local < backend/database-migrations/xxx.sql
```

### 2. 开发环境数据迁移

如果之前使用 SQLite，需要将数据迁移到 MySQL：

```bash
# 1. 导出 SQLite 数据
sqlite3 backend/data/crm.db .dump > data.sql

# 2. 转换为 MySQL 格式（需要手动调整）
# 3. 导入到 MySQL
mysql -h localhost -u abc789 -p crm_local < data.sql
```

### 3. 环境变量检查

确保所有环境的 `.env` 文件都包含正确的 MySQL 配置：
- `.env.local` - 本地开发环境
- `.env.development` - 开发环境
- `.env` - 生产环境

### 4. 连接池大小

根据实际并发量调整 `DB_CONNECTION_LIMIT`：
- 开发环境：10（默认）
- 生产环境：20-50（根据服务器配置）

## 测试验证

### 1. 启动测试

```bash
cd backend
npm run dev
```

**预期输出**：
```
📦 正在连接 MySQL 数据库...
   环境: development
   数据库: crm_local
   地址: localhost:3306
   用户: abc789
✅ 数据库连接成功
```

### 2. 功能测试

- ✅ 用户登录
- ✅ 数据查询
- ✅ 数据创建
- ✅ 数据更新
- ✅ 数据删除

### 3. 性能测试

使用压测工具测试并发性能：
```bash
# 使用 ab 工具测试
ab -n 1000 -c 10 http://localhost:3000/api/v1/users
```

## 回滚方案

如果需要回滚到 SQLite（不推荐），可以：

1. 恢复 `database.ts` 文件的旧版本
2. 修改 `.env.local` 文件：
   ```env
   DB_TYPE=sqlite
   ```
3. 重启服务

## 相关文件

- `backend/src/config/database.ts` - 数据库配置文件（已优化）
- `backend/.env.local` - 本地开发环境配置
- `backend/.env.development` - 开发环境配置
- `backend/.env` - 生产环境配置

---

**优化时间**：2026-02-26
**优化人员**：Kiro AI Assistant
**测试状态**：待验证
