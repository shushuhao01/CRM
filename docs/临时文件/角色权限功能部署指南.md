# 角色权限功能部署指南

## 部署时间
2026-02-26

## 功能说明

本次更新实现了角色权限的数据库存储功能，解决了以下问题：
1. ✅ 权限设置弹窗打开时，自动勾选该角色在数据库中的所有权限（模块、菜单、操作）
2. ✅ 管理员修改权限后，保存到数据库而不是 localStorage
3. ✅ 支持恢复默认权限功能
4. ✅ 用户登录时从数据库读取权限

## 部署步骤

### 1. 数据库迁移（重要！）

#### 1.1 备份数据库
```bash
# 在宝塔面板或命令行中备份数据库
mysqldump -u root -p abc789_cn > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 1.2 检查 roles 表结构
```sql
-- 登录MySQL
mysql -u root -p abc789_cn

-- 查看 roles 表结构
SHOW CREATE TABLE roles;

-- 检查是否有 permissions 字段
SHOW COLUMNS FROM roles LIKE 'permissions';
```

#### 1.3 执行迁移脚本
如果 `permissions` 字段不存在，执行以下SQL：

```sql
-- 添加 permissions 字段
ALTER TABLE `roles` 
ADD COLUMN `permissions` JSON DEFAULT NULL COMMENT '权限ID数组（JSON格式）';

-- 添加 data_scope 字段（如果不存在）
ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `data_scope` VARCHAR(20) DEFAULT 'self' COMMENT '数据范围：all-全部数据, department-部门数据, self-个人数据';

-- 添加 status 字段（如果不存在）
ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `status` VARCHAR(20) DEFAULT 'active' COMMENT '状态：active-启用, inactive-禁用';

-- 添加 level 字段（如果不存在）
ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `level` INT DEFAULT 0 COMMENT '角色级别，数字越小权限越高';

-- 添加 color 字段（如果不存在）
ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `color` VARCHAR(20) DEFAULT NULL COMMENT '角色颜色标识';

-- 添加 code 字段（如果不存在）
ALTER TABLE `roles` 
ADD COLUMN IF NOT EXISTS `code` VARCHAR(50) DEFAULT NULL COMMENT '角色编码';

-- 为 code 字段添加唯一索引
CREATE UNIQUE INDEX IF NOT EXISTS `idx_roles_code` ON `roles` (`code`);

-- 更新现有角色的 code 字段（如果为空）
UPDATE `roles` SET `code` = `name` WHERE `code` IS NULL OR `code` = '';

-- 更新现有角色的 permissions 字段为空数组（如果为空）
UPDATE `roles` SET `permissions` = '[]' WHERE `permissions` IS NULL;
```

或者直接执行迁移脚本文件：
```bash
mysql -u root -p abc789_cn < backend/database-migrations/add-permissions-to-roles.sql
```

#### 1.4 验证迁移结果
```sql
-- 查看 roles 表结构
DESC roles;

-- 查看现有角色数据
SELECT 
    id,
    name,
    code,
    status,
    level,
    data_scope,
    JSON_LENGTH(permissions) as permission_count,
    created_at,
    updated_at
FROM `roles`
ORDER BY level ASC, created_at DESC;
```

### 2. 部署后端代码

#### 2.1 拉取最新代码
```bash
cd /www/wwwroot/abc789.cn/backend
git pull origin main
```

#### 2.2 安装依赖（如果有新增）
```bash
npm install
```

#### 2.3 编译TypeScript
```bash
npm run build
```

#### 2.4 重启后端服务
```bash
# 使用 PM2
pm2 restart crm-backend

# 或者使用宝塔面板重启Node.js项目
```

### 3. 部署前端代码

#### 3.1 拉取最新代码
```bash
cd /www/wwwroot/abc789.cn/admin
git pull origin main
```

#### 3.2 安装依赖（如果有新增）
```bash
npm install
```

#### 3.3 构建生产版本
```bash
npm run build
```

#### 3.4 部署到Web服务器
```bash
# 如果使用宝塔面板，dist 目录会自动部署
# 如果手动部署，复制 dist 目录到 Nginx 根目录
cp -r dist/* /www/wwwroot/abc789.cn/admin/
```

### 4. 验证部署

#### 4.1 检查后端API
```bash
# 测试获取角色列表
curl -X GET http://abc789.cn/api/v1/roles \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试获取角色权限
curl -X GET http://abc789.cn/api/v1/roles/3/permissions \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 4.2 检查前端功能
1. 清除浏览器缓存：
   ```javascript
   // 在浏览器控制台执行
   localStorage.clear()
   location.reload()
   ```

2. 重新登录系统（使用超管账号）

3. 进入"系统管理 → 角色权限"页面

4. 点击"销售员"角色的"权限设置"按钮

5. 验证权限树是否正确勾选了所有层级的权限：
   - ✅ 一级菜单（模块）已勾选
   - ✅ 二级菜单（子菜单）已勾选
   - ✅ 操作权限（按钮权限）已勾选

6. 修改权限后点击"保存权限"按钮

7. 重新打开权限设置弹窗，验证修改是否保存成功

8. 点击"恢复默认"按钮，验证是否恢复为预设权限

#### 4.3 测试不同角色
1. 使用销售员账号登录
2. 验证左侧菜单是否正确显示
3. 验证页面访问权限是否正确
4. 验证按钮权限是否正确

### 5. 通知用户

部署完成后，通知所有用户：

```
【系统升级通知】

尊敬的用户：

系统已完成权限管理功能升级，主要变更如下：

1. 权限配置现在保存到数据库，更加稳定可靠
2. 管理员可以更灵活地配置各角色的权限
3. 支持恢复默认权限功能

为确保新功能正常使用，请您：
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 重新登录系统

如有任何问题，请联系系统管理员。

感谢您的配合！
```

### 6. 回滚方案

如果部署后出现问题，可以按以下步骤回滚：

#### 6.1 回滚数据库
```bash
# 恢复备份
mysql -u root -p abc789_cn < backup_YYYYMMDD_HHMMSS.sql
```

#### 6.2 回滚代码
```bash
# 后端
cd /www/wwwroot/abc789.cn/backend
git reset --hard HEAD~1
npm run build
pm2 restart crm-backend

# 前端
cd /www/wwwroot/abc789.cn/admin
git reset --hard HEAD~1
npm run build
```

### 7. 常见问题

#### Q1: 权限树没有正确勾选
**原因**：浏览器缓存了旧的权限数据

**解决方案**：
```javascript
// 在浏览器控制台执行
localStorage.clear()
location.reload()
```

#### Q2: 保存权限后没有生效
**原因**：用户还在使用旧的登录会话

**解决方案**：
- 用户需要重新登录系统
- 或者实现权限热更新机制（后续优化）

#### Q3: 数据库迁移失败
**原因**：字段已存在或SQL语法错误

**解决方案**：
```sql
-- 检查字段是否已存在
SHOW COLUMNS FROM roles;

-- 如果字段已存在，跳过添加字段的步骤
-- 只执行更新数据的SQL
UPDATE `roles` SET `permissions` = '[]' WHERE `permissions` IS NULL;
```

#### Q4: 角色权限为空
**原因**：数据库中 `permissions` 字段为 NULL

**解决方案**：
- 系统会自动使用 `defaultRolePermissions.ts` 中的预设权限
- 管理员可以在权限设置页面重新配置并保存

### 8. 监控和日志

#### 8.1 查看后端日志
```bash
# PM2 日志
pm2 logs crm-backend

# 或者查看日志文件
tail -f /www/wwwroot/abc789.cn/backend/logs/combined.log
```

#### 8.2 查看数据库日志
```bash
# MySQL 慢查询日志
tail -f /var/log/mysql/slow-query.log

# MySQL 错误日志
tail -f /var/log/mysql/error.log
```

#### 8.3 监控关键指标
- 权限API响应时间
- 数据库查询性能
- 用户登录成功率
- 权限验证失败次数

### 9. 性能优化建议

#### 9.1 数据库索引
```sql
-- 为 permissions 字段添加索引（MySQL 5.7+）
ALTER TABLE `roles` ADD INDEX `idx_permissions` ((CAST(permissions AS CHAR(1000))));

-- 为 code 字段添加索引
CREATE INDEX IF NOT EXISTS `idx_roles_code` ON `roles` (`code`);
```

#### 9.2 缓存策略
- 前端缓存权限数据到 localStorage（已实现）
- 后端使用 Redis 缓存角色权限（可选）
- 设置合理的缓存过期时间

#### 9.3 查询优化
- 使用 `SELECT` 指定字段，避免 `SELECT *`
- 合理使用 JOIN 查询
- 避免 N+1 查询问题

---

## 总结

本次部署实现了角色权限的数据库存储功能，提升了系统的稳定性和可维护性。

**关键步骤**：
1. ✅ 备份数据库
2. ✅ 执行数据库迁移脚本
3. ✅ 部署后端代码
4. ✅ 部署前端代码
5. ✅ 验证功能
6. ✅ 通知用户

**注意事项**：
- 部署前务必备份数据库
- 通知用户清除缓存并重新登录
- 监控系统日志，及时发现问题
- 准备好回滚方案

---

> 文档创建时间：2026年2月26日
> 
> 文档版本：v1.0
