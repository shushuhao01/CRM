# 业绩分享页面报错问题分析

## 问题描述
- **现象**：开发环境访问业绩分享页面出现大量报错：`can't access property "map", share.shareMembers is undefined`
- **环境差异**：生产环境正常，开发环境报错
- **报错位置**：`src/views/Performance/Share.vue` 页面

## 问题根源分析

### 1. 数据来源确认
通过检查后端代码 `backend/src/routes/performance.ts`，确认业绩分享功能的数据来源：

**后端API路由**：
- `GET /api/v1/performance/shares` - 获取业绩分享列表
- `GET /api/v1/performance/shares/:id` - 获取详情
- `POST /api/v1/performance/shares` - 创建分享
- `DELETE /api/v1/performance/shares/:id` - 取消分享
- `POST /api/v1/performance/shares/:id/confirm` - 确认分享
- `GET /api/v1/performance/stats` - 获取统计数据

**所需数据库表**：
1. `performance_shares` - 业绩分享记录表
2. `performance_share_members` - 业绩分享成员表

### 2. 问题原因
开发环境和生产环境都使用 MySQL 数据库，但：
- **生产环境**：数据库包含完整的 `performance_shares` 和 `performance_share_members` 表
- **开发环境**：数据库可能缺少这两个表，导致 API 查询失败，返回空数据或错误

### 3. 表结构定义
在 `database/schema.sql` 中已有完整的表定义（第1093-1139行）：

```sql
-- 23. 业绩分享记录表
CREATE TABLE `performance_shares` (
  `id` VARCHAR(50) PRIMARY KEY,
  `share_number` VARCHAR(50) UNIQUE NOT NULL,
  `order_id` VARCHAR(50) NOT NULL,
  `order_number` VARCHAR(50) NOT NULL,
  `order_amount` DECIMAL(10,2) NOT NULL,
  `total_share_amount` DECIMAL(10,2) NOT NULL,
  `share_count` INT DEFAULT 0,
  `status` ENUM('active', 'completed', 'cancelled') DEFAULT 'active',
  `description` TEXT,
  `created_by` VARCHAR(50) NOT NULL,
  `created_by_name` VARCHAR(50),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `completed_at` TIMESTAMP NULL,
  `cancelled_at` TIMESTAMP NULL,
  -- 索引...
);

-- 24. 业绩分享成员表
CREATE TABLE `performance_share_members` (
  `id` VARCHAR(50) PRIMARY KEY,
  `share_id` VARCHAR(50) NOT NULL,
  `user_id` VARCHAR(50) NOT NULL,
  `user_name` VARCHAR(50) NOT NULL,
  `department` VARCHAR(100),
  `share_percentage` DECIMAL(5,2) NOT NULL,
  `share_amount` DECIMAL(10,2) NOT NULL,
  `status` ENUM('pending', 'confirmed', 'rejected') DEFAULT 'pending',
  `confirm_time` TIMESTAMP NULL,
  `reject_reason` TEXT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  -- 外键约束...
  FOREIGN KEY (`share_id`) REFERENCES `performance_shares`(`id`) ON DELETE CASCADE
);
```

## 解决方案

### 步骤1：检查开发环境数据库
执行检查脚本 `scripts/check-performance-shares-tables.sql`：

```sql
-- 检查表是否存在
SELECT 
    'performance_shares' as table_name,
    COUNT(*) as table_exists
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'crm_local' 
  AND TABLE_NAME = 'performance_shares';

SELECT 
    'performance_share_members' as table_name,
    COUNT(*) as table_exists
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'crm_local' 
  AND TABLE_NAME = 'performance_share_members';
```

**预期结果**：
- 如果 `table_exists = 0`，说明表不存在，需要创建
- 如果 `table_exists = 1`，说明表存在，需要检查表结构和数据

### 步骤2：创建缺失的表
如果表不存在，执行创建脚本 `scripts/create-performance-shares-tables-dev.sql`：

**执行方式**：
1. 打开 Navicat 或其他 MySQL 客户端
2. 连接到开发环境数据库 `crm_local`
3. 执行 `scripts/create-performance-shares-tables-dev.sql` 脚本
4. 验证表创建成功

### 步骤3：验证修复
1. 重启后端服务（如果需要）
2. 清除浏览器缓存
3. 访问业绩分享页面
4. 确认不再报错

## 为什么生产环境正常？

生产环境可能在之前的某次数据库迁移或更新中已经创建了这两个表，而开发环境数据库可能是：
1. 从较早的备份恢复的
2. 手动创建时遗漏了这两个表
3. 使用了不完整的初始化脚本

## 预防措施

1. **统一数据库结构**：确保开发环境和生产环境使用相同的 schema 文件
2. **版本控制**：所有数据库变更都应该有对应的迁移脚本
3. **定期同步**：定期检查开发环境和生产环境的表结构差异
4. **文档记录**：在 `database/schema.sql` 中维护完整的表结构定义

## 相关文件
- `backend/src/routes/performance.ts` - 业绩分享后端API
- `src/views/Performance/Share.vue` - 业绩分享前端页面
- `database/schema.sql` - 完整数据库表结构（第1093-1139行）
- `scripts/check-performance-shares-tables.sql` - 检查脚本
- `scripts/create-performance-shares-tables-dev.sql` - 创建脚本

## 注意事项
1. 不要修改前端代码，问题在数据库层面
2. 执行SQL脚本前请备份数据库
3. 确认数据库名称是否为 `crm_local`（开发环境）
4. 创建表后无需重启后端服务，直接刷新页面即可
