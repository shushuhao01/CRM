# 增值管理系统数据库部署指南

## 更新时间
2026-03-01

## 概述
本文档说明增值管理系统的数据库表结构和部署步骤。

## 数据库表结构

### 1. outsource_companies (外包公司表)
管理外包公司的基本信息和统计数据。

**主要字段：**
- `id` - 公司ID
- `company_name` - 公司名称
- `default_unit_price` - 默认单价（新增）
- `contact_person` - 联系人
- `contact_phone` - 联系电话
- `status` - 状态（active/inactive）
- `total_orders` - 总订单数
- `valid_orders` - 有效订单数
- `total_amount` - 总金额
- `settled_amount` - 已结算金额

### 2. value_added_price_config (增值费用配置表)
管理不同外包公司的费用配置。

**主要字段：**
- `id` - 配置ID
- `config_name` - 配置名称
- `company_id` - 外包公司ID（NULL表示通用配置）
- `unit_price` - 单价
- `start_date` - 生效开始日期
- `end_date` - 生效结束日期
- `status` - 状态（active/inactive）

### 3. value_added_orders (增值订单表)
管理所有增值订单数据。

**主要字段：**
- `id` - 记录ID
- `order_id` - 关联订单ID
- `order_number` - 订单号
- `customer_name` - 客户姓名
- `tracking_number` - 物流单号
- `order_status` - 订单状态（新增）
- `order_date` - 下单日期（新增）
- `company_id` - 外包公司ID
- `unit_price` - 单价
- `status` - 有效状态（pending/valid/invalid/supplemented）
- `settlement_status` - 结算状态（unsettled/settled）
- `settlement_amount` - 实际结算金额

### 4. value_added_status_configs (状态配置表)
管理有效状态和结算状态的配置。

**主要字段：**
- `id` - 配置ID
- `type` - 配置类型（validStatus/settlementStatus）
- `value` - 状态值
- `label` - 状态标签

## 迁移脚本说明

### 本地开发环境
- **文件**: `backend/database-migrations/complete-value-added-system.sql`
- **数据库**: `crm_local`
- **状态**: ✅ 已执行

### 生产环境
- **文件**: `backend/database-migrations/production-value-added-system.sql`
- **数据库**: `abc789_cn`
- **状态**: ⏳ 待执行

## 生产环境部署步骤

### 步骤1：备份数据库
```bash
# 在宝塔面板中备份数据库
# 或使用命令行
mysqldump -u root -p abc789_cn > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 步骤2：执行迁移脚本
在宝塔面板的phpMyAdmin或数据库管理工具中：

1. 选择数据库 `abc789_cn`
2. 点击"SQL"标签
3. 复制 `production-value-added-system.sql` 的内容
4. 粘贴并执行

或使用命令行：
```bash
mysql -u root -p abc789_cn < backend/database-migrations/production-value-added-system.sql
```

### 步骤3：验证表创建
执行以下SQL验证：
```sql
USE abc789_cn;

-- 检查表是否创建成功
SHOW TABLES LIKE '%value_added%';
SHOW TABLES LIKE 'outsource_companies';

-- 检查表结构
DESC outsource_companies;
DESC value_added_price_config;
DESC value_added_orders;
DESC value_added_status_configs;

-- 检查默认数据
SELECT * FROM value_added_price_config;
SELECT * FROM value_added_status_configs;
```

### 步骤4：重启后端服务
```bash
cd /www/wwwroot/crm/backend
pm2 restart crm-backend
pm2 logs crm-backend
```

### 步骤5：前端部署
```bash
cd /www/wwwroot/crm/admin
npm run build
# 或在宝塔面板中重新构建
```

### 步骤6：功能测试
1. 登录系统
2. 进入"财务管理" → "增值管理"
3. 测试以下功能：
   - 查看订单列表（应自动同步已签收/已完成订单）
   - 外包公司管理（添加、编辑、查看）
   - 费用配置（添加、编辑）
   - 状态配置（添加、删除有效状态和结算状态）
   - 批量操作（批量改有效状态、批量改结算状态）
   - 批量导出（导出为xlsx文件）

## 数据同步逻辑

### 自动同步规则
系统会自动将以下订单同步到增值管理：
- 订单状态为 `delivered`（已签收）
- 订单状态为 `completed`（已完成）

### 同步时机
- 每次访问增值管理页面时自动检查并同步
- 新同步的订单默认状态为 `pending`（待处理）

### 数据流程
```
订单表 (orders)
  ↓ (status = delivered/completed)
自动同步
  ↓
增值订单表 (value_added_orders)
  ↓ (status = pending)
人工处理
  ↓
设置有效状态 (valid/invalid)
  ↓
设置结算状态 (settled)
```

## 注意事项

1. **数据备份**：执行迁移前务必备份数据库
2. **字符集**：确保数据库使用 utf8mb4 字符集
3. **权限检查**：确保数据库用户有创建表的权限
4. **索引优化**：表已包含必要的索引，无需额外添加
5. **默认数据**：脚本会自动插入默认配置数据
6. **重复执行**：脚本使用 `IF NOT EXISTS` 和 `ON DUPLICATE KEY UPDATE`，可安全重复执行

## 回滚方案

如果需要回滚，执行以下SQL：
```sql
USE abc789_cn;

SET FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS `value_added_status_configs`;
DROP TABLE IF EXISTS `value_added_orders`;
DROP TABLE IF EXISTS `value_added_price_config`;
DROP TABLE IF EXISTS `outsource_companies`;

SET FOREIGN_KEY_CHECKS = 1;
```

## 相关文件

- **完整迁移脚本**: `backend/database-migrations/complete-value-added-system.sql`
- **生产环境脚本**: `backend/database-migrations/production-value-added-system.sql`
- **Schema源文件**: `backend/database-schema.sql`（已更新）
- **实体文件**: 
  - `backend/src/entities/OutsourceCompany.ts`
  - `backend/src/entities/ValueAddedOrder.ts`
  - `backend/src/entities/ValueAddedPriceConfig.ts`
  - `backend/src/entities/ValueAddedStatusConfig.ts`

## 联系支持

如遇到问题，请检查：
1. 数据库连接配置
2. 后端服务日志
3. 浏览器控制台错误
4. 网络请求响应

## 更新记录

- 2026-03-01: 创建增值管理系统数据库表结构
- 2026-03-01: 添加外包公司默认单价字段
- 2026-03-01: 添加订单状态和下单日期字段
- 2026-03-01: 创建状态配置表
