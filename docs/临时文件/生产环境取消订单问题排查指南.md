# 生产环境取消订单问题排查指南

## 问题描述

生产环境取消订单审核弹窗显示问题：
1. ✅ **负责销售显示ID而不是姓名** - 已修复（数据库已更新）
2. ❌ **申请时间还是旧格式（ISO格式）而不是北京时间格式** - 需要重启后端服务
3. ❌ **取消原因显示英文字符串而不是中文** - 需要重启后端服务

## 问题分析

### 1. 负责销售显示ID ✅

**原因**：数据库中 `orders` 表的 `created_by_name` 字段为空

**验证SQL**：
```sql
SELECT id, order_number, created_by, created_by_name 
FROM orders 
WHERE status IN ('pending_cancel', 'cancelled', 'cancel_failed')
LIMIT 10;
```

**修复状态**：✅ 已执行SQL更新，影响7行数据

### 2. 申请时间旧格式 ❌

**原因**：生产环境后端服务没有重启，还在运行旧代码

**验证方法**：
```bash
# 检查后端进程启动时间
pm2 list
pm2 info crm-backend
```

**修复方法**：重启后端服务（见下方步骤）

### 3. 取消原因显示字符串 ❌

**根本原因**：后端API返回的 `cancelReason` 字段使用了错误的数据源

**已修复的代码**：
```typescript
// ✅ 正确：使用 order.cancelReason 字段
cancelReason: order.cancelReason || ''
```

**数据库字段说明**：
- `cancel_reason`：存储取消原因的英文key（如 `customer_cancel`）
- `remark`：存储订单备注（可能包含其他信息）

**前端映射**：前端会自动将英文key映射为中文显示

## Schema验证

✅ `database/schema.sql` 中 `orders` 表已包含正确字段定义：

```sql
`created_by_name` VARCHAR(50) COMMENT '创建人姓名',  -- 第387行
`cancel_reason` TEXT COMMENT '取消原因',            -- 第343行
`remark` TEXT COMMENT '订单备注',                   -- 第369行
```

## 修复步骤

### 步骤1：提交代码到GitHub ✅

```bash
git add backend/src/routes/orders.ts
git commit -m "fix: 修复取消订单审核API返回错误的取消原因字段"
git push origin main
```

### 步骤2：更新生产环境代码

**方式A：使用SSH**

```bash
# 1. SSH登录生产服务器
ssh user@your-production-server

# 2. 进入项目目录
cd /www/wwwroot/crm.yundingshuma.com/backend

# 3. 拉取最新代码
git pull origin main

# 4. 重新构建
npm run build

# 5. 重启后端服务
pm2 restart crm-backend

# 6. 查看日志确认启动成功
pm2 logs crm-backend --lines 30
```

**方式B：使用宝塔面板**

1. 登录宝塔面板
2. 进入"文件"管理
3. 导航到：`/www/wwwroot/crm.yundingshuma.com/backend`
4. 点击"终端"按钮
5. 执行以下命令：
   ```bash
   git pull origin main
   npm run build
   pm2 restart crm-backend
   pm2 logs crm-backend --lines 30
   ```

### 步骤3：清除前端缓存

1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮，选择"清空缓存并硬性重新加载"
3. 或者使用快捷键：Ctrl+Shift+Delete，清除缓存

### 步骤4：验证修复

1. **验证负责销售显示** ✅：
   - 打开取消订单审核弹窗
   - 检查"负责销售"列是否显示姓名而不是ID

2. **验证申请时间格式**：
   - 检查"申请时间"列是否显示为：`YYYY-MM-DD HH:mm:ss` 格式
   - 例如：`2024-12-04 14:30:00`

3. **验证取消原因显示**：
   - 检查"取消原因"列是否显示中文
   - 例如：`客户主动取消`、`商品缺货` 等

## 宝塔面板操作指南

### 1. 更新代码

1. 登录宝塔面板
2. 进入"文件"管理
3. 导航到：`/www/wwwroot/crm.yundingshuma.com/backend`
4. 点击"终端"按钮
5. 执行命令：
   ```bash
   git pull origin main
   npm run build
   ```

### 2. 重启服务

1. 进入"软件商店"
2. 找到"PM2管理器"
3. 找到 `crm-backend` 进程
4. 点击"重启"按钮
5. 查看日志确认启动成功

### 3. 修复数据库（已完成）

✅ 数据库修复SQL已执行，影响7行数据

## 常见问题

### Q1: 代码更新后还是显示旧格式？

**A**: 确保后端服务已重启：
```bash
pm2 restart crm-backend
pm2 logs crm-backend --lines 30
```

检查进程启动时间：
```bash
pm2 info crm-backend
```

### Q2: 负责销售还是显示ID？

**A**: 检查数据库修复SQL是否执行成功：
```sql
SELECT COUNT(*) FROM orders WHERE created_by_name IS NULL OR created_by_name = '';
```
如果返回0，说明修复成功。✅ 已确认修复

### Q3: 取消原因还是显示英文？

**A**: 
1. ✅ 确保后端代码已修改（使用 `order.cancelReason` 而不是 `order.remark`）
2. 确保后端服务已重启
3. 清除浏览器缓存
4. 检查API返回数据：
   ```bash
   # 在浏览器控制台查看网络请求
   # /api/v1/orders/pending-cancel
   # /api/v1/orders/audited-cancel
   ```

### Q4: 如何确认后端代码已更新？

**A**: 
1. 检查Git提交记录：
   ```bash
   cd /www/wwwroot/crm.yundingshuma.com/backend
   git log --oneline -5
   ```

2. 检查文件内容：
   ```bash
   grep -n "cancelReason" src/routes/orders.ts
   ```

3. 查看PM2进程启动时间（应该是最近的时间）：
   ```bash
   pm2 info crm-backend
   ```

## 技术细节

### 时间格式化

后端使用 `formatDateTime` 工具函数：
```typescript
import { formatDateTime } from '../utils/dateFormat';

// 使用示例
cancelRequestTime: formatDateTime(order.updatedAt)
// 输出：2024-12-04 14:30:00
```

### 取消原因映射

**后端返回**：
```typescript
cancelReason: order.cancelReason || ''  // 返回英文key，如 'customer_cancel'
```

**前端映射**：
```typescript
const reasonMap: Record<string, string> = {
  'customer_cancel': '客户主动取消',
  'out_of_stock': '商品缺货',
  'price_change': '价格调整',
  'order_error': '订单信息错误',
  'other': '其他原因'
}

const getCancelReasonText = (reason: string) => {
  return reasonMap[reason] || reason
}
```

## 修复清单

- [x] 数据库 `created_by_name` 字段更新（已执行SQL）
- [x] Schema文件包含正确字段定义
- [x] 修改后端代码使用 `order.cancelReason` 字段
- [x] 提交代码到GitHub
- [ ] 生产服务器拉取最新代码
- [ ] 重新构建后端项目
- [ ] 重启后端服务
- [ ] 清除浏览器缓存
- [ ] 验证所有问题已修复

## 相关文件

- 数据修复脚本：`scripts/fix-production-cancel-orders.sql` ✅
- 后端订单路由：`backend/src/routes/orders.ts` ✅ 已修复
- 前端订单列表：`src/views/Order/List.vue`
- 数据库Schema：`database/schema.sql` ✅
