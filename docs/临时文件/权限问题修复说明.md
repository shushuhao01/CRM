# 权限问题修复说明

## 问题描述

管理员在提交代收取消申请时，提示"没有权限访问此资源"（403错误）。

## 问题原因

后端代码中有严格的权限验证：

```typescript
// 验证权限：只能申请自己创建的订单
if (order.createdBy !== user.id) {
  return res.status(403).json({ success: false, message: '只能申请自己创建的订单' });
}
```

这个逻辑限制了只能申请自己创建的订单，但管理员应该可以申请任何订单。

## 修复方案

### 1. 创建申请接口（POST /api/v1/cod-application/create）

修改权限验证逻辑，允许管理员和超管申请任何订单：

```typescript
// 验证权限：成员只能申请自己创建的订单，管理员和超管不受限制
const isAdmin = user.role === 'admin' || user.role === 'super_admin';
if (!isAdmin && order.createdBy !== user.id) {
  return res.status(403).json({ success: false, message: '只能申请自己创建的订单' });
}
```

### 2. 撤销申请接口（DELETE /api/v1/cod-application/cancel/:id）

同样修改权限验证逻辑：

```typescript
// 验证权限：成员只能撤销自己的申请，管理员和超管不受限制
const isAdmin = user.role === 'admin' || user.role === 'super_admin';
if (!isAdmin && application.applicantId !== user.id) {
  return res.status(403).json({ success: false, message: '只能撤销自己的申请' });
}
```

## 角色说明

系统中的角色代码（存储在 `users.role_id` 字段）：

- `super_admin` - 超级管理员（最高权限）
- `admin` - 管理员（部门负责人）
- `department_manager` - 部门经理
- `sales_staff` - 销售人员
- `customer_service` - 客服人员
- `TONGYONG` - 通用角色

## 权限规则

### 创建申请
- **成员**：只能申请自己创建的订单
- **经理**：只能申请自己创建的订单
- **管理员**：可以申请任何订单 ✅
- **超管**：可以申请任何订单 ✅

### 撤销申请
- **成员**：只能撤销自己的申请
- **经理**：只能撤销自己的申请
- **管理员**：可以撤销任何申请 ✅
- **超管**：可以撤销任何申请 ✅

### 审核申请
- **所有角色**：都可以审核（需要有审核权限）

## 调试信息

添加了详细的日志输出，方便排查问题：

```typescript
console.log('[CodApplication] 权限检查:', {
  userId: user.id,
  username: user.username,
  userRole: user.role,
  isAdmin,
  orderCreatedBy: order.createdBy,
  canApply: isAdmin || order.createdBy === user.id
});
```

## 测试步骤

### 测试1：管理员申请其他人的订单

1. 使用管理员账号登录
2. 进入"代收取消申请"页面
3. 选择一个不是自己创建的订单
4. 填写申请信息并提交
5. ✅ 应该能成功提交

### 测试2：普通成员申请其他人的订单

1. 使用普通成员账号登录
2. 进入"代收取消申请"页面
3. 尝试选择其他人创建的订单
4. ❌ 应该看不到其他人的订单（前端已过滤）

### 测试3：查看后端日志

1. 提交申请时
2. 查看后端控制台或日志文件
3. 应该能看到权限检查的详细信息：
```
[CodApplication] 权限检查: {
  userId: 'admin',
  username: 'admin',
  userRole: 'admin',
  isAdmin: true,
  orderCreatedBy: 'user_xxx',
  canApply: true
}
```

## 如果还是提示没有权限

### 检查1：确认用户角色

在浏览器控制台执行：
```javascript
const token = localStorage.getItem('auth_token');
const payload = JSON.parse(atob(token.split('.')[1]));
console.log('用户角色:', payload.role);
```

应该看到 `admin` 或 `super_admin`。

### 检查2：查看后端日志

查看后端控制台输出的权限检查日志，确认：
- `userRole` 的值是什么
- `isAdmin` 是否为 `true`

### 检查3：可能的角色值

如果你的角色不是 `admin` 或 `super_admin`，可能是：
- `ADMIN` - 大写的管理员角色
- `administrator` - 其他变体
- 或者是中文角色名

如果是这种情况，需要修改代码中的角色判断逻辑。

## 相关文件

- `backend/src/routes/codApplication.ts` - 代收申请路由（已修复）
- `backend/src/controllers/UserController.ts` - 用户登录逻辑
- `backend/src/config/jwt.ts` - JWT token生成
- `backend/src/entities/User.ts` - 用户实体

## 注意事项

1. **后端需要重启**：修改后端代码后需要重启后端服务才能生效
2. **前端需要刷新**：修改后需要刷新浏览器页面
3. **Token有效期**：如果token已过期，需要重新登录

## 重启后端服务

```bash
# 开发环境
cd backend
npm run dev

# 生产环境（使用PM2）
pm2 restart crm-backend
```
