# 生产环境增值管理500错误排查指南

## 问题描述
- 开发环境：增值管理功能正常
- 生产环境：汇总卡片和标签数量正常显示，但列表加载失败，返回500错误
- 错误信息：`Error: 服务器内部错误`

## 可能原因分析

### 1. 数据库字段不一致
生产环境和开发环境的数据库表结构可能不一致，导致查询失败。

### 2. 数据类型问题
某些字段的数据类型在生产环境中可能与预期不符，导致查询或序列化失败。

### 3. 空值处理问题
生产环境的数据可能包含NULL值，而代码没有正确处理。

### 4. 关联查询问题
外包公司表或其他关联表可能存在问题。

## 排查步骤

### 步骤1：运行诊断脚本

在生产服务器上运行诊断脚本：

```bash
cd /www/wwwroot/crm.shushuhao.com/backend
node diagnose-value-added-production.js
```

诊断脚本会检查：
- 表是否存在
- 字段结构是否完整
- 数据量和状态分布
- 查询是否能正常执行
- 外包公司表是否存在
- 索引是否正确

### 步骤2：查看后端日志

查看PM2日志获取详细错误信息：

```bash
pm2 logs backend --lines 100
```

或查看错误日志文件：

```bash
tail -f /www/wwwroot/crm.shushuhao.com/backend/logs/error.log
```

### 步骤3：检查数据库连接

确认生产环境的数据库配置正确：

```bash
cat /www/wwwroot/crm.shushuhao.com/backend/.env
```

检查以下配置项：
- `DB_HOST`
- `DB_PORT`
- `DB_USER`
- `DB_PASSWORD`
- `DB_NAME`

### 步骤4：手动测试SQL查询

登录生产数据库，手动执行查询：

```sql
-- 检查表是否存在
SHOW TABLES LIKE 'value_added_orders';

-- 检查表结构
DESCRIBE value_added_orders;

-- 测试基本查询
SELECT * FROM value_added_orders ORDER BY created_at DESC LIMIT 10;

-- 检查状态分布
SELECT status, COUNT(*) as count FROM value_added_orders GROUP BY status;

-- 检查外包公司表
SELECT * FROM outsource_companies LIMIT 10;
```

## 常见问题及解决方案

### 问题1：字段名不匹配

**症状**：查询时报错 `Unknown column 'xxx' in 'field list'`

**解决方案**：
1. 检查实体定义中的 `@Column` 装饰器是否正确使用了 `name` 参数
2. 确保数据库字段名使用下划线命名（如 `order_date`）
3. 确保实体属性使用驼峰命名（如 `orderDate`）

### 问题2：数据类型不匹配

**症状**：查询成功但序列化失败

**解决方案**：
1. 检查 `decimal` 类型字段是否正确转换为数字
2. 检查 `datetime` 类型字段是否正确转换为日期对象
3. 添加类型转换代码：

```typescript
const list = await queryBuilder.getMany();

// 确保数字类型正确
list.forEach(item => {
  item.unitPrice = Number(item.unitPrice) || 0;
  item.settlementAmount = Number(item.settlementAmount) || 0;
});
```

### 问题3：NULL值处理

**症状**：某些记录导致查询失败

**解决方案**：
在查询构建器中添加NULL值过滤或在代码中处理NULL值：

```typescript
// 方案1：过滤NULL值
queryBuilder.andWhere('order.order_number IS NOT NULL');

// 方案2：在代码中处理
const list = await queryBuilder.getMany();
list.forEach(item => {
  item.orderNumber = item.orderNumber || '';
  item.customerName = item.customerName || '';
  // ... 其他字段
});
```

### 问题4：关联表缺失

**症状**：外包公司相关查询失败

**解决方案**：
1. 确认 `outsource_companies` 表存在
2. 确认至少有一条默认公司记录
3. 如果表不存在，执行建表SQL：

```sql
-- 参考 backend/database-migrations/create-value-added-tables.sql
```

## 临时解决方案

如果问题紧急，可以先禁用自动同步功能：

在 `backend/src/routes/valueAdded.ts` 中修改：

```typescript
// 临时禁用自动同步
const shouldSync = false; // 原来是复杂的条件判断
```

这样可以先让列表查询正常工作，然后再排查同步功能的问题。

## 修复建议

### 1. 增强错误日志

在路由处理函数中添加更详细的错误日志：

```typescript
router.get('/orders', authenticateToken, async (req: Request, res: Response) => {
  try {
    // ... 查询逻辑
    const list = await queryBuilder.getMany();
    console.log(`[ValueAdded] 查询成功，返回 ${list.length} 条记录`);
    
    res.json({
      success: true,
      data: { list, total, page: pageNum, pageSize: size }
    });
  } catch (error: any) {
    console.error('[ValueAdded] Get orders error:', error);
    console.error('[ValueAdded] Error stack:', error.stack);
    console.error('[ValueAdded] Query params:', req.query);
    res.status(500).json({ 
      success: false, 
      message: '获取订单列表失败',
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});
```

### 2. 添加数据验证

在返回数据前进行验证和清理：

```typescript
const list = await queryBuilder.getMany();

// 数据清理和验证
const cleanedList = list.map(item => ({
  ...item,
  unitPrice: Number(item.unitPrice) || 0,
  settlementAmount: Number(item.settlementAmount) || 0,
  orderNumber: item.orderNumber || '',
  customerName: item.customerName || '',
  customerPhone: item.customerPhone || '',
  status: item.status || 'pending',
  settlementStatus: item.settlementStatus || 'unsettled'
}));

res.json({
  success: true,
  data: { list: cleanedList, total, page: pageNum, pageSize: size }
});
```

### 3. 分步调试

如果问题仍然存在，可以分步调试：

```typescript
// 步骤1：测试基本查询
const count = await orderRepo.count();
console.log(`[ValueAdded] 总记录数: ${count}`);

// 步骤2：测试简单查询
const simpleList = await orderRepo.find({ take: 10 });
console.log(`[ValueAdded] 简单查询返回: ${simpleList.length} 条`);

// 步骤3：测试完整查询
const list = await queryBuilder.getMany();
console.log(`[ValueAdded] 完整查询返回: ${list.length} 条`);
```

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：
1. 诊断脚本的完整输出
2. 后端错误日志（最近100行）
3. 数据库表结构（DESCRIBE value_added_orders）
4. 示例数据（SELECT * FROM value_added_orders LIMIT 1）

## 更新记录
- 2026-03-02：创建文档，添加诊断脚本和排查步骤
