# 外包公司创建500错误修复

## 问题描述

用户在添加外包公司时点击"保存"按钮，后端返回500错误，导致无法创建公司。

## 错误原因

在实施价格档位系统时，我们从 `outsource_companies` 表中删除了 `default_unit_price` 字段，改为使用独立的价格档位表 `value_added_price_config`。

但是后端代码中仍然在尝试操作这个已删除的字段：

1. **创建公司API** (`POST /api/value-added/companies`)
   - 从请求体中读取 `defaultUnitPrice`
   - 尝试设置 `company.defaultUnitPrice = defaultUnitPrice || 0`

2. **更新公司API** (`PUT /api/value-added/companies/:id`)
   - 从请求体中读取 `defaultUnitPrice`
   - 尝试更新 `company.defaultUnitPrice = defaultUnitPrice`

3. **实体类定义** (`OutsourceCompany.ts`)
   - 仍然定义了 `defaultUnitPrice` 字段
   - TypeORM尝试将该字段映射到数据库，但数据库中已不存在该列

当TypeORM尝试保存实体时，会因为字段不匹配而抛出数据库错误，导致500响应。

## 修复方案

### 1. 修复创建公司API

**文件**: `backend/src/routes/valueAdded.ts`

**修改前**:
```typescript
const {
  companyName,
  contactPerson,
  contactPhone,
  contactEmail,
  address,
  defaultUnitPrice,  // ❌ 已删除的字段
  remark
} = req.body;

// ...

company.defaultUnitPrice = defaultUnitPrice || 0;  // ❌ 设置已删除的字段

res.json({ success: true, message: '创建成功', data: { id: company.id } });
```

**修改后**:
```typescript
const {
  companyName,
  contactPerson,
  contactPhone,
  contactEmail,
  address,
  // 移除 defaultUnitPrice
  remark
} = req.body;

// ...

// 移除 company.defaultUnitPrice 的设置

res.json({ success: true, message: '创建成功', data: company });  // ✅ 返回完整对象
```

### 2. 修复更新公司API

**文件**: `backend/src/routes/valueAdded.ts`

**修改前**:
```typescript
const {
  companyName,
  contactPerson,
  contactPhone,
  contactEmail,
  address,
  defaultUnitPrice,  // ❌ 已删除的字段
  status,
  remark
} = req.body;

// ...

if (defaultUnitPrice !== undefined) company.defaultUnitPrice = defaultUnitPrice;  // ❌
```

**修改后**:
```typescript
const {
  companyName,
  contactPerson,
  contactPhone,
  contactEmail,
  address,
  // 移除 defaultUnitPrice
  status,
  remark
} = req.body;

// ...

// 移除 defaultUnitPrice 的更新逻辑
```

### 3. 修复实体类定义

**文件**: `backend/src/entities/OutsourceCompany.ts`

**修改前**:
```typescript
@Column('varchar', { length: 20, default: 'active' })
status: string;

@Column('int', { default: 999, name: 'sort_order' })
sortOrder: number;

@Column('tinyint', { default: 0, name: 'is_default' })
isDefault: number;

@Column('decimal', { precision: 10, scale: 2, default: 0, name: 'default_unit_price' })
defaultUnitPrice: number;  // ❌ 已删除的字段

@Column('int', { default: 0, name: 'total_orders' })
totalOrders: number;
```

**修改后**:
```typescript
@Column('varchar', { length: 20, default: 'active' })
status: string;

@Column('int', { default: 999, name: 'sort_order' })
sortOrder: number;

@Column('tinyint', { default: 0, name: 'is_default' })
isDefault: number;

// 移除 defaultUnitPrice 字段定义

@Column('int', { default: 0, name: 'total_orders' })
totalOrders: number;
```

## 附加改进

### 返回完整公司对象

修改创建公司API的返回值，从只返回ID改为返回完整的公司对象：

```typescript
// 修改前
res.json({ success: true, message: '创建成功', data: { id: company.id } });

// 修改后
res.json({ success: true, message: '创建成功', data: company });
```

这样前端可以直接使用返回的完整对象，无需再次查询：

```typescript
// 前端代码
const result = await createOutsourceCompany(companyForm)
editingCompany.value = result.data  // ✅ 直接使用完整对象
companyFormTab.value = 'tiers'
await loadCompanyTiers(result.data.id)
```

## 测试验证

创建了测试脚本 `backend/test-create-company.js` 用于验证修复：

```bash
cd backend
node test-create-company.js
```

测试步骤：
1. 登录获取token
2. 创建测试公司
3. 验证公司是否出现在列表中

## 诊断结果

所有文件通过TypeScript诊断检查：
- ✅ backend/src/routes/valueAdded.ts
- ✅ backend/src/entities/OutsourceCompany.ts

## 相关文件

### 修改的文件
- `backend/src/routes/valueAdded.ts` - 创建和更新公司API
- `backend/src/entities/OutsourceCompany.ts` - 实体类定义

### 测试文件
- `backend/test-create-company.js` - 创建公司功能测试

### 相关文档
- `docs/临时文件/价格档位系统-数据库schema更新完成.md` - 数据库迁移说明
- `docs/临时文件/价格档位系统-UI集成完成.md` - UI集成说明

## 根本原因分析

这个问题的根本原因是：在数据库迁移时删除了字段，但没有同步更新所有相关的代码：

1. ✅ 数据库表结构已更新（删除了 `default_unit_price` 列）
2. ❌ 实体类定义未更新（仍然定义了该字段）
3. ❌ API端点未更新（仍然尝试读取和设置该字段）

## 预防措施

为避免类似问题，在进行数据库字段删除时应该：

1. **检查实体类定义** - 确保TypeORM实体类与数据库表结构一致
2. **检查API端点** - 搜索所有使用该字段的代码
3. **运行诊断** - 使用TypeScript编译器检查类型错误
4. **测试API** - 在修改后测试所有相关的API端点
5. **更新文档** - 记录字段删除和相关代码修改

## 总结

修复了外包公司创建时的500错误，原因是代码中仍在操作已删除的 `default_unit_price` 字段。通过删除实体类中的字段定义和API中的相关代码，问题已解决。

现在用户可以正常创建外包公司，保存成功后会自动切换到价格档位标签页，可以继续配置价格档位。
