# 电销外呼系统技术方案

> 文档版本：v1.0  
> 创建日期：2025-12-25  
> 适用系统：CRM客户管理系统

---

## 目录

1. [方案概述](#一方案概述)
2. [方案一：工作手机外呼](#二方案一工作手机外呼)
3. [方案二：云呼叫中心外呼](#三方案二云呼叫中心外呼)
4. [数据库设计](#四数据库设计)
5. [API接口设计](#五api接口设计)
6. [前端改造方案](#六前端改造方案)
7. [开发计划与工作量](#七开发计划与工作量)
8. [附录](#八附录)

---

## 一、方案概述

### 1.1 业务背景

电销团队日常工作需要大量外呼客户，目前主要使用两种方式：
- **工作手机**：员工使用公司配发的手机拨打客户电话
- **话务机/座机**：通过话务系统拨打客户电话

### 1.2 系统目标

1. 实现PC端一键拨号，自动触发手机/座机外呼
2. 自动记录通话信息（时长、状态、录音）
3. 通话结束后自动弹出跟进记录填写
4. 统计分析外呼数据（通话量、接通率、平均时长等）

### 1.3 方案对比

| 对比项 | 工作手机外呼 | 云呼叫中心外呼 |
|-------|-------------|---------------|
| 硬件需求 | 工作手机 + APP | 无（或耳麦） |
| 通话费用 | 手机套餐费用 | 0.08-0.15元/分钟 |
| 外显号码 | 手机号码 | 固话/400/手机号 |
| 录音功能 | 部分手机支持 | 全部支持 |
| 开发复杂度 | 需开发APP | API对接即可 |
| 适用场景 | 移动办公、外勤 | 固定坐席、大量外呼 |


---

## 二、方案一：工作手机外呼

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           CRM系统 (PC端)                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │
│  │   通话管理    │    │   客户列表   │    │   订单详情   │          │
│  │   点击拨打    │    │   点击拨打   │    │   点击拨打   │          │
│  └───────┬──────┘    └───────┬──────┘    └───────┬──────┘          │
│          │                   │                   │                  │
│          └───────────────────┼───────────────────┘                  │
│                              ▼                                      │
│                    ┌─────────────────┐                              │
│                    │   WebSocket服务  │◄────── 实时双向通信          │
│                    └────────┬────────┘                              │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
                              │ WebSocket长连接
                              │
┌─────────────────────────────┼───────────────────────────────────────┐
│                             ▼                                       │
│                    ┌─────────────────┐                              │
│                    │    手机APP      │                              │
│                    │  (Android/iOS)  │                              │
│                    └────────┬────────┘                              │
│                             │                                       │
│          ┌──────────────────┼──────────────────┐                    │
│          ▼                  ▼                  ▼                    │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │
│   │ 接收拨号指令 │   │ 调起系统拨号 │   │ 监听通话状态 │              │
│   └─────────────┘   └─────────────┘   └─────────────┘              │
│                             │                                       │
│                             ▼                                       │
│                    ┌─────────────────┐                              │
│                    │   上报通话记录   │                              │
│                    │ (时长/状态/录音) │                              │
│                    └─────────────────┘                              │
│                          工作手机                                    │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心流程

#### 2.2.1 设备绑定流程

```
┌──────────┐      ┌──────────┐      ┌──────────┐
│  PC端    │      │  服务器   │      │  手机APP  │
└────┬─────┘      └────┬─────┘      └────┬─────┘
     │                 │                 │
     │ 1.点击"绑定设备" │                 │
     │────────────────>│                 │
     │                 │                 │
     │ 2.返回二维码    │                 │
     │ (含Token+服务器地址)              │
     │<────────────────│                 │
     │                 │                 │
     │                 │ 3.扫码获取信息   │
     │                 │<────────────────│
     │                 │                 │
     │                 │ 4.发起绑定请求   │
     │                 │ (设备ID+手机号)  │
     │                 │<────────────────│
     │                 │                 │
     │                 │ 5.验证并保存绑定 │
     │                 │────────────────>│
     │                 │                 │
     │ 6.推送绑定成功   │                 │
     │<────────────────│                 │
     │                 │                 │
     │                 │ 7.建立WebSocket  │
     │                 │<═══════════════>│
     │                 │   长连接        │
```

**二维码数据结构**：
```json
{
  "action": "bind_device",
  "serverUrl": "wss://api.example.com/ws",
  "token": "临时绑定Token，5分钟有效",
  "userId": "user_001",
  "timestamp": 1703491200000
}
```


#### 2.2.2 发起外呼流程

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│  PC端    │      │  服务器   │      │  手机APP  │      │ 系统拨号  │
└────┬─────┘      └────┬─────┘      └────┬─────┘      └────┬─────┘
     │                 │                 │                 │
     │ 1.点击拨打      │                 │                 │
     │ {customerId,    │                 │                 │
     │  phone}         │                 │                 │
     │────────────────>│                 │                 │
     │                 │                 │                 │
     │                 │ 2.创建通话记录   │                 │
     │                 │ status=calling  │                 │
     │                 │                 │                 │
     │                 │ 3.WebSocket推送  │                 │
     │                 │ DIAL_COMMAND    │                 │
     │                 │────────────────>│                 │
     │                 │                 │                 │
     │                 │                 │ 4.调起拨号器    │
     │                 │                 │ tel://139xxx    │
     │                 │                 │────────────────>│
     │                 │                 │                 │
     │ 5.WebSocket推送  │                 │                 │
     │ 状态=拨号中     │                 │                 │
     │<────────────────│                 │                 │
     │                 │                 │                 │
     │ 显示"正在呼叫..." │                │                 │
```

**拨号指令消息格式**：
```json
{
  "type": "DIAL_COMMAND",
  "messageId": "msg_001",
  "timestamp": 1703491200000,
  "data": {
    "callId": "call_20251225_abc123",
    "customerPhone": "13912345678",
    "customerName": "张三",
    "customerId": "cust_001",
    "orderId": "order_001"
  }
}
```

#### 2.2.3 通话状态监听与上报

```
┌──────────┐      ┌──────────┐      ┌──────────┐
│  手机APP  │      │  服务器   │      │  PC端    │
└────┬─────┘      └────┬─────┘      └────┬─────┘
     │                 │                 │
     │ 1.检测到接通    │                 │
     │ CALL_STATE_     │                 │
     │ OFFHOOK         │                 │
     │────────────────>│                 │
     │                 │                 │
     │                 │ 2.更新记录状态   │
     │                 │ status=connected│
     │                 │                 │
     │                 │ 3.推送PC端      │
     │                 │────────────────>│
     │                 │                 │ 显示"通话中"
     │                 │                 │ 开始计时
     │                 │                 │
     │ 4.检测到挂断    │                 │
     │ CALL_STATE_IDLE │                 │
     │ {duration: 180} │                 │
     │────────────────>│                 │
     │                 │                 │
     │                 │ 5.更新通话记录   │
     │                 │ duration=180    │
     │                 │ status=connected│
     │                 │                 │
     │                 │ 6.推送PC端      │
     │                 │────────────────>│
     │                 │                 │ 显示通话结束
     │                 │                 │ 弹出跟进弹窗
```

**通话状态上报消息格式**：
```json
// 通话接通
{
  "type": "CALL_STATUS",
  "data": {
    "callId": "call_20251225_abc123",
    "status": "connected",
    "timestamp": 1703491200000
  }
}

// 通话结束
{
  "type": "CALL_END",
  "data": {
    "callId": "call_20251225_abc123",
    "status": "connected",
    "startTime": "2025-12-25T10:30:00.000Z",
    "endTime": "2025-12-25T10:33:00.000Z",
    "duration": 180,
    "hasRecording": true,
    "recordingSize": 1024000
  }
}
```


### 2.3 手机APP技术实现

#### 2.3.1 Android APP

**技术栈**：
- 开发语言：Kotlin
- 最低版本：Android 5.0 (API 21)
- 网络通信：OkHttp + WebSocket
- 依赖注入：Hilt
- 数据存储：Room + DataStore

**核心功能模块**：

```
┌─────────────────────────────────────────────────────────────┐
│                      Android APP 架构                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   登录模块   │  │  扫码绑定   │  │  设置模块   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  WebSocket服务                       │   │
│  │  - 长连接保持    - 心跳机制    - 断线重连           │   │
│  │  - 消息收发      - 指令处理                         │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  拨号服务   │  │ 通话监听服务 │  │  录音服务   │         │
│  │ Intent.CALL │  │PhoneState   │  │MediaRecorder│         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  前台服务 (保活)                      │   │
│  │  - 常驻通知栏    - 防止系统杀死                      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**关键代码示例**：

```kotlin
// 1. 通话状态监听器
class CallStateReceiver : BroadcastReceiver() {
    private var callStartTime: Long = 0
    private var currentCallId: String? = null
    
    override fun onReceive(context: Context, intent: Intent) {
        val state = intent.getStringExtra(TelephonyManager.EXTRA_STATE)
        val phoneNumber = intent.getStringExtra(TelephonyManager.EXTRA_INCOMING_NUMBER)
        
        when (state) {
            TelephonyManager.EXTRA_STATE_RINGING -> {
                // 来电响铃（呼入场景）
                reportCallStatus("ringing", phoneNumber)
            }
            TelephonyManager.EXTRA_STATE_OFFHOOK -> {
                // 通话中（接通）
                callStartTime = System.currentTimeMillis()
                reportCallStatus("connected", phoneNumber)
            }
            TelephonyManager.EXTRA_STATE_IDLE -> {
                // 通话结束
                if (callStartTime > 0) {
                    val duration = (System.currentTimeMillis() - callStartTime) / 1000
                    reportCallEnd(duration)
                    callStartTime = 0
                }
            }
        }
    }
}

// 2. 发起拨号
class DialService {
    fun dialPhone(context: Context, phoneNumber: String, callId: String) {
        // 保存当前通话ID
        CallStateManager.setCurrentCallId(callId)
        
        // 调起系统拨号器
        val intent = Intent(Intent.ACTION_CALL).apply {
            data = Uri.parse("tel:$phoneNumber")
            flags = Intent.FLAG_ACTIVITY_NEW_TASK
        }
        context.startActivity(intent)
    }
}

// 3. WebSocket服务
class WebSocketService : Service() {
    private lateinit var webSocket: WebSocket
    private val reconnectDelay = 5000L
    
    private val listener = object : WebSocketListener() {
        override fun onMessage(webSocket: WebSocket, text: String) {
            val message = Gson().fromJson(text, WsMessage::class.java)
            when (message.type) {
                "DIAL_COMMAND" -> handleDialCommand(message.data)
                "HEARTBEAT_ACK" -> handleHeartbeatAck()
            }
        }
        
        override fun onFailure(webSocket: WebSocket, t: Throwable, response: Response?) {
            // 断线重连
            Handler(Looper.getMainLooper()).postDelayed({
                connect()
            }, reconnectDelay)
        }
    }
    
    private fun handleDialCommand(data: DialCommandData) {
        DialService().dialPhone(this, data.customerPhone, data.callId)
    }
}

// 4. 通话录音
class CallRecordingService {
    private var mediaRecorder: MediaRecorder? = null
    private var recordingFile: File? = null
    
    fun startRecording(callId: String) {
        val file = File(getExternalFilesDir(null), "recordings/$callId.mp3")
        recordingFile = file
        
        mediaRecorder = MediaRecorder().apply {
            setAudioSource(MediaRecorder.AudioSource.VOICE_COMMUNICATION)
            setOutputFormat(MediaRecorder.OutputFormat.MPEG_4)
            setAudioEncoder(MediaRecorder.AudioEncoder.AAC)
            setOutputFile(file.absolutePath)
            prepare()
            start()
        }
    }
    
    fun stopRecording(): File? {
        mediaRecorder?.apply {
            stop()
            release()
        }
        mediaRecorder = null
        return recordingFile
    }
}
```

**所需权限**：
```xml
<uses-permission android:name="android.permission.CALL_PHONE" />
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.CAMERA" /> <!-- 扫码 -->
<uses-permission android:name="android.permission.WAKE_LOCK" />
```


#### 2.3.2 iOS APP

**技术栈**：
- 开发语言：Swift
- 最低版本：iOS 12.0
- 网络通信：URLSession WebSocket / Starscream
- UI框架：SwiftUI / UIKit

**核心功能模块**：

```
┌─────────────────────────────────────────────────────────────┐
│                       iOS APP 架构                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   登录模块   │  │  扫码绑定   │  │  设置模块   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  WebSocket服务                       │   │
│  │  - URLSessionWebSocketTask                          │   │
│  │  - 心跳保活    - 断线重连                            │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐                          │
│  │  拨号服务   │  │ CallKit监听 │  ⚠️ iOS无法录音          │
│  │ tel:// URL  │  │CXCallObserver│                         │
│  └─────────────┘  └─────────────┘                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │              后台模式 (Background Modes)              │   │
│  │  - VoIP Push    - Background fetch                   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**关键代码示例**：

```swift
// 1. 通话状态监听 (CallKit)
import CallKit

class CallObserver: NSObject, CXCallObserverDelegate {
    private let callObserver = CXCallObserver()
    private var callStartTime: Date?
    
    override init() {
        super.init()
        callObserver.setDelegate(self, queue: nil)
    }
    
    func callObserver(_ callObserver: CXCallObserver, callChanged call: CXCall) {
        if call.hasConnected && !call.hasEnded {
            // 通话接通
            callStartTime = Date()
            WebSocketManager.shared.reportCallStatus(status: "connected")
        }
        
        if call.hasEnded {
            // 通话结束
            if let startTime = callStartTime {
                let duration = Int(Date().timeIntervalSince(startTime))
                WebSocketManager.shared.reportCallEnd(duration: duration)
            }
            callStartTime = nil
        }
    }
}

// 2. 发起拨号
class DialService {
    func dialPhone(phoneNumber: String) {
        // iOS只能跳转到拨号界面，用户需手动点击拨打
        if let url = URL(string: "tel://\(phoneNumber)") {
            UIApplication.shared.open(url)
        }
    }
}

// 3. WebSocket管理
class WebSocketManager {
    static let shared = WebSocketManager()
    private var webSocketTask: URLSessionWebSocketTask?
    
    func connect(url: URL) {
        let session = URLSession(configuration: .default)
        webSocketTask = session.webSocketTask(with: url)
        webSocketTask?.resume()
        receiveMessage()
        startHeartbeat()
    }
    
    private func receiveMessage() {
        webSocketTask?.receive { [weak self] result in
            switch result {
            case .success(let message):
                switch message {
                case .string(let text):
                    self?.handleMessage(text)
                default:
                    break
                }
                self?.receiveMessage() // 继续监听
            case .failure(let error):
                print("WebSocket error: \(error)")
                self?.reconnect()
            }
        }
    }
    
    private func handleMessage(_ text: String) {
        guard let data = text.data(using: .utf8),
              let message = try? JSONDecoder().decode(WsMessage.self, from: data) else {
            return
        }
        
        switch message.type {
        case "DIAL_COMMAND":
            DialService().dialPhone(phoneNumber: message.data.customerPhone)
        default:
            break
        }
    }
}
```

**iOS限制说明**：
| 功能 | 支持情况 | 说明 |
|-----|---------|------|
| 自动拨号 | ❌ 不支持 | 只能跳转拨号界面，用户需手动点击 |
| 通话状态监听 | ✅ 支持 | 通过CallKit的CXCallObserver |
| 通话录音 | ❌ 不支持 | iOS系统限制，无法录制通话 |
| 后台保活 | ⚠️ 受限 | 需要VoIP Push或特殊处理 |


### 2.4 服务器端实现

#### 2.4.1 WebSocket消息协议

**消息基础结构**：
```json
{
  "type": "消息类型",
  "messageId": "唯一消息ID",
  "timestamp": 1703491200000,
  "data": { ... }
}
```

**消息类型定义**：

| 方向 | 类型 | 说明 |
|-----|------|------|
| 服务器→APP | `DIAL_COMMAND` | 拨号指令 |
| 服务器→APP | `CANCEL_DIAL` | 取消拨号 |
| 服务器→APP | `HEARTBEAT_ACK` | 心跳响应 |
| 服务器→APP | `DEVICE_UNBIND` | 设备解绑通知 |
| APP→服务器 | `DEVICE_ONLINE` | 设备上线 |
| APP→服务器 | `DEVICE_OFFLINE` | 设备离线 |
| APP→服务器 | `CALL_STATUS` | 通话状态变更 |
| APP→服务器 | `CALL_END` | 通话结束 |
| APP→服务器 | `HEARTBEAT` | 心跳 |
| APP→服务器 | `RECORDING_UPLOAD` | 录音上传完成 |

#### 2.4.2 后端服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                      后端服务架构                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   API Gateway                        │   │
│  │  /api/v1/calls/*                                    │   │
│  └──────────────────────┬──────────────────────────────┘   │
│                         │                                   │
│  ┌──────────────────────┼──────────────────────────────┐   │
│  │                      ▼                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │ 设备管理    │  │ 外呼控制    │  │ 通话记录    │ │   │
│  │  │ DeviceCtrl  │  │ DialCtrl    │  │ RecordCtrl  │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  │                      │                              │   │
│  │  ┌─────────────────────────────────────────────────┐│   │
│  │  │              WebSocket Manager                  ││   │
│  │  │  - 连接管理    - 消息路由    - 心跳检测        ││   │
│  │  │  - 设备映射    - 消息队列                      ││   │
│  │  └─────────────────────────────────────────────────┘│   │
│  │                                                     │   │
│  │  ┌─────────────────────────────────────────────────┐│   │
│  │  │              录音存储服务                        ││   │
│  │  │  - 本地存储    - OSS上传    - 文件管理         ││   │
│  │  └─────────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    数据库                            │   │
│  │  work_phones | call_records | phone_configs         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4.3 关键代码实现

```typescript
// WebSocket连接管理
class MobileDeviceWebSocketManager {
  // 设备连接映射: userId -> WebSocket
  private deviceConnections: Map<string, WebSocket> = new Map();
  
  // 处理设备连接
  handleConnection(ws: WebSocket, userId: string, deviceId: string) {
    // 保存连接
    this.deviceConnections.set(userId, ws);
    
    // 更新设备在线状态
    this.updateDeviceStatus(userId, deviceId, 'online');
    
    // 监听消息
    ws.on('message', (data) => this.handleMessage(userId, data));
    
    // 监听断开
    ws.on('close', () => {
      this.deviceConnections.delete(userId);
      this.updateDeviceStatus(userId, deviceId, 'offline');
    });
    
    // 启动心跳检测
    this.startHeartbeat(ws, userId);
  }
  
  // 发送拨号指令
  async sendDialCommand(userId: string, callData: DialCommandData) {
    const ws = this.deviceConnections.get(userId);
    if (!ws) {
      throw new Error('设备未连接');
    }
    
    const message = {
      type: 'DIAL_COMMAND',
      messageId: generateId(),
      timestamp: Date.now(),
      data: callData
    };
    
    ws.send(JSON.stringify(message));
  }
  
  // 处理APP上报的消息
  private handleMessage(userId: string, data: string) {
    const message = JSON.parse(data);
    
    switch (message.type) {
      case 'HEARTBEAT':
        this.handleHeartbeat(userId);
        break;
      case 'CALL_STATUS':
        this.handleCallStatus(message.data);
        break;
      case 'CALL_END':
        this.handleCallEnd(message.data);
        break;
    }
  }
  
  // 处理通话结束
  private async handleCallEnd(data: CallEndData) {
    // 更新通话记录
    await CallRecordService.updateRecord(data.callId, {
      status: data.status,
      duration: data.duration,
      endTime: data.endTime,
      hasRecording: data.hasRecording
    });
    
    // 推送PC端
    WebSocketService.pushToUser(data.userId, {
      type: 'CALL_ENDED',
      data: {
        callId: data.callId,
        duration: data.duration,
        status: data.status
      }
    });
  }
}
```


---

## 三、方案二：云呼叫中心外呼

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           CRM系统                                    │
│  ┌──────────────┐                                                   │
│  │   点击拨打    │                                                   │
│  └───────┬──────┘                                                   │
│          │                                                          │
│          ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       后端服务                               │   │
│  │  1. 调用云服务商API发起外呼                                  │   │
│  │  2. 接收Webhook回调更新通话状态                              │   │
│  │  3. 获取录音文件URL                                          │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
                              │ HTTPS API
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       云呼叫中心服务商                               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │
│  │   外呼API    │    │   状态回调   │    │   录音存储   │          │
│  └───────┬──────┘    └───────┬──────┘    └──────────────┘          │
│          │                   │                                      │
│          ▼                   │                                      │
│  ┌───────────────────────────┴─────────────────────────────────┐   │
│  │                      运营商线路                              │   │
│  │                (移动/联通/电信中继线)                         │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
                              │ 电话网络
                              ▼
                       ┌─────────────┐
                       │   客户手机   │
                       └─────────────┘
```

### 3.2 服务商选择

#### 3.2.1 主流服务商对比

| 服务商 | 产品 | 外呼费用 | 录音 | 特点 | 官网 |
|-------|------|---------|------|------|------|
| **阿里云** | 云呼叫中心 | 0.10-0.15元/分钟 | ✅ | 文档全，稳定 | cloud.aliyun.com |
| **腾讯云** | 云呼叫中心 | 0.10-0.12元/分钟 | ✅ | 价格便宜 | cloud.tencent.com |
| **容联云** | 七陌云客服 | 0.08-0.12元/分钟 | ✅ | 电销专业 | yuntongxun.com |
| **天润融通** | 天润呼叫中心 | 按坐席收费 | ✅ | 大客户多 | ti-net.com.cn |
| **合力亿捷** | 云呼叫中心 | 按坐席收费 | ✅ | 老牌厂商 | hollycrm.com |

#### 3.2.2 推荐选择

**中小团队（<50坐席）**：阿里云或腾讯云
- 按量付费，成本可控
- API文档完善，对接简单
- 无需专业运维

**中大型团队（50-200坐席）**：容联云或天润融通
- 功能更专业（智能质检、话术管理等）
- 有专属客户经理
- 可定制开发

### 3.3 开通流程（以阿里云为例）

#### 3.3.1 准备材料

```
企业资质材料：
├── 营业执照（三证合一）
├── 法人身份证正反面
├── 企业对公账户信息
└── 授权委托书（如非法人操作）

业务材料：
├── 外呼业务说明（用途、话术内容）
├── 被叫号码来源说明（客户授权、合法获取）
├── 外呼时间说明（工作时间、频次限制）
└── 投诉处理机制说明
```

#### 3.3.2 开通步骤

```
步骤1：注册并实名认证
├── 注册阿里云账号
├── 完成企业实名认证
└── 开通云呼叫中心服务

步骤2：创建呼叫中心实例
├── 选择地域（建议选择离用户近的）
├── 选择坐席数量
├── 配置实例名称
└── 获取实例ID (InstanceId)

步骤3：申请外显号码
├── 选择号码类型
│   ├── 固话号码（如 021-12345678）
│   ├── 400号码（如 400-123-4567）
│   └── 手机号码（如 13800138000）
├── 提交号码申请
├── 上传资质材料
└── 等待审核（3-7个工作日）

步骤4：配置坐席账号
├── 创建坐席用户
├── 分配技能组
├── 绑定外显号码
└── 设置权限

步骤5：配置回调地址
├── 设置通话状态回调URL
├── 设置录音完成回调URL
├── 配置签名验证密钥
└── 测试回调连通性

步骤6：获取API凭证
├── 创建AccessKey
├── 获取AccessKey ID
├── 获取AccessKey Secret
└── 配置到系统中
```


### 3.4 API对接详解

#### 3.4.1 阿里云API对接

**安装SDK**：
```bash
npm install @alicloud/ccc20200701 --save
```

**初始化客户端**：
```typescript
import China from '@alicloud/ccc20200701';
import * as China from '@alicloud/openapi-client';

const config = new China.Config({
  accessKeyId: process.env.ALIYUN_ACCESS_KEY_ID,
  accessKeySecret: process.env.ALIYUN_ACCESS_KEY_SECRET,
  endpoint: 'ccc.cn-shanghai.aliyuncs.com'
});

const client = new China(config);
```

**发起外呼**：
```typescript
interface MakeCallParams {
  instanceId: string;      // 呼叫中心实例ID
  caller: string;          // 主叫号码（外显号码）
  callee: string;          // 被叫号码（客户电话）
  userId: string;          // 坐席用户ID
  timeoutSeconds?: number; // 呼叫超时时间
  tags?: string;           // 自定义标签（JSON字符串）
}

async function makeCall(params: MakeCallParams) {
  const request = new China.MakeCallRequest({
    instanceId: params.instanceId,
    caller: params.caller,
    callee: params.callee,
    userId: params.userId,
    timeoutSeconds: params.timeoutSeconds || 60,
    tags: params.tags
  });
  
  try {
    const response = await client.makeCall(request);
    return {
      success: true,
      callId: response.body.data.callContext.callId,
      jobId: response.body.data.callContext.jobId
    };
  } catch (error) {
    console.error('发起外呼失败:', error);
    throw error;
  }
}

// 使用示例
const result = await makeCall({
  instanceId: 'ccc-instance-xxx',
  caller: '02112345678',        // 外显号码
  callee: '13912345678',        // 客户电话
  userId: 'agent@example.com',  // 坐席账号
  tags: JSON.stringify({
    customerId: 'cust_001',
    orderId: 'order_001',
    source: 'crm'
  })
});
```

**挂断通话**：
```typescript
async function hangupCall(instanceId: string, jobId: string) {
  const request = new China.ReleaseCallRequest({
    instanceId,
    jobId
  });
  
  await client.releaseCall(request);
}
```

**获取通话详情**：
```typescript
async function getCallDetail(instanceId: string, callId: string) {
  const request = new China.GetCallDetailRecordRequest({
    instanceId,
    callId
  });
  
  const response = await client.getCallDetailRecord(request);
  return response.body.data;
}
```

#### 3.4.2 Webhook回调处理

**回调地址配置**：
```
通话状态回调：https://api.example.com/api/v1/calls/webhook/aliyun/status
录音完成回调：https://api.example.com/api/v1/calls/webhook/aliyun/recording
```

**回调数据结构**：
```typescript
// 通话状态回调
interface CallStatusCallback {
  instanceId: string;
  callId: string;
  jobId: string;
  event: 'Dialing' | 'Ringing' | 'Answered' | 'Released';
  eventTime: string;
  caller: string;
  callee: string;
  agentId: string;
  releaseReason?: string;  // 挂断原因
  duration?: number;       // 通话时长（秒）
  tags?: string;           // 自定义标签
}

// 录音完成回调
interface RecordingCallback {
  instanceId: string;
  callId: string;
  recordingUrl: string;
  recordingDuration: number;
  recordingSize: number;
  recordingTime: string;
}
```

**回调处理代码**：
```typescript
// 通话状态回调处理
router.post('/api/v1/calls/webhook/aliyun/status', async (req, res) => {
  const callback: CallStatusCallback = req.body;
  
  // 验证签名（可选但推荐）
  if (!verifySignature(req)) {
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // 解析自定义标签
  const tags = callback.tags ? JSON.parse(callback.tags) : {};
  
  switch (callback.event) {
    case 'Dialing':
      // 正在拨号
      await updateCallRecord(callback.callId, {
        status: 'dialing',
        providerCallId: callback.callId,
        providerJobId: callback.jobId
      });
      // 推送PC端
      pushToPC(tags.userId, { type: 'CALL_DIALING', callId: callback.callId });
      break;
      
    case 'Ringing':
      // 对方振铃
      await updateCallRecord(callback.callId, { status: 'ringing' });
      pushToPC(tags.userId, { type: 'CALL_RINGING', callId: callback.callId });
      break;
      
    case 'Answered':
      // 已接听
      await updateCallRecord(callback.callId, {
        status: 'connected',
        startTime: new Date(callback.eventTime)
      });
      pushToPC(tags.userId, { type: 'CALL_CONNECTED', callId: callback.callId });
      break;
      
    case 'Released':
      // 通话结束
      const finalStatus = callback.duration > 0 ? 'connected' : 'missed';
      await updateCallRecord(callback.callId, {
        status: finalStatus,
        duration: callback.duration || 0,
        endTime: new Date(callback.eventTime),
        hangupCause: callback.releaseReason
      });
      pushToPC(tags.userId, {
        type: 'CALL_ENDED',
        callId: callback.callId,
        duration: callback.duration,
        status: finalStatus
      });
      break;
  }
  
  res.json({ success: true });
});

// 录音完成回调处理
router.post('/api/v1/calls/webhook/aliyun/recording', async (req, res) => {
  const callback: RecordingCallback = req.body;
  
  await updateCallRecord(callback.callId, {
    recordingUrl: callback.recordingUrl,
    recordingDuration: callback.recordingDuration,
    recordingSize: callback.recordingSize,
    hasRecording: true
  });
  
  res.json({ success: true });
});
```


### 3.5 腾讯云API对接

**安装SDK**：
```bash
npm install tencentcloud-sdk-nodejs --save
```

**发起外呼**：
```typescript
import * as tencentcloud from 'tencentcloud-sdk-nodejs';

const CccClient = tencentcloud.ccc.v20200210.Client;

const client = new CccClient({
  credential: {
    secretId: process.env.TENCENT_SECRET_ID,
    secretKey: process.env.TENCENT_SECRET_KEY
  },
  region: 'ap-guangzhou',
  profile: {
    httpProfile: {
      endpoint: 'ccc.tencentcloudapi.com'
    }
  }
});

async function makeCall(params: {
  sdkAppId: number;
  caller: string;
  callee: string;
  staffUserId: string;
}) {
  const response = await client.CreateAutoCalloutTask({
    SdkAppId: params.sdkAppId,
    Callees: [params.callee],
    Callers: [params.caller],
    IvrId: 0,  // 直接外呼，不使用IVR
    Name: `外呼任务_${Date.now()}`,
    Description: 'CRM系统外呼'
  });
  
  return response;
}
```

### 3.6 容联云API对接

**发起外呼（回拨模式）**：
```typescript
import axios from 'axios';
import crypto from 'crypto';

class RongLianClient {
  private accountSid: string;
  private authToken: string;
  private appId: string;
  private baseUrl = 'https://app.cloopen.com:8883';
  
  constructor(accountSid: string, authToken: string, appId: string) {
    this.accountSid = accountSid;
    this.authToken = authToken;
    this.appId = appId;
  }
  
  // 生成签名
  private getSignature(timestamp: string): string {
    const sig = crypto
      .createHash('md5')
      .update(this.accountSid + this.authToken + timestamp)
      .digest('hex')
      .toUpperCase();
    return sig;
  }
  
  // 发起回拨
  async callback(from: string, to: string, customerData?: string) {
    const timestamp = new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14);
    const sig = this.getSignature(timestamp);
    
    const url = `${this.baseUrl}/2013-12-26/Accounts/${this.accountSid}/Calls/Callback`;
    
    const response = await axios.post(
      `${url}?sig=${sig}`,
      {
        appId: this.appId,
        from,           // 主叫号码（坐席）
        to,             // 被叫号码（客户）
        customerSerNum: from,  // 外显号码
        fromSerNum: from,
        userData: customerData  // 自定义数据，回调时返回
      },
      {
        headers: {
          'Authorization': Buffer.from(`${this.accountSid}:${timestamp}`).toString('base64'),
          'Content-Type': 'application/json'
        }
      }
    );
    
    return response.data;
  }
}
```

### 3.7 费用估算

```
场景假设：
- 坐席数量：10人
- 每人每天外呼：100通
- 平均通话时长：2分钟
- 工作日：22天/月

月通话量计算：
- 总通话数 = 10人 × 100通 × 22天 = 22,000通
- 总通话时长 = 22,000通 × 2分钟 = 44,000分钟

费用估算（阿里云）：
┌─────────────────────────────────────────────────────┐
│ 费用项目          │ 单价           │ 月费用         │
├───────────────────┼────────────────┼────────────────┤
│ 通话费用          │ 0.10元/分钟    │ 4,400元        │
│ 号码月租          │ 50元/号        │ 50元（1个号码）│
│ 录音存储          │ 0.12元/GB      │ ~50元          │
├───────────────────┼────────────────┼────────────────┤
│ 合计              │                │ ~4,500元/月    │
└─────────────────────────────────────────────────────┘

对比传统话务机：
- 话务机设备：2,000-5,000元/台 × 10台 = 20,000-50,000元（一次性）
- 线路月租：500-1,000元/月
- 通话费用：0.10-0.15元/分钟

结论：云呼叫中心更适合中小团队，无需前期投入，按量付费。
```


---

## 四、数据库设计

### 4.1 现有表结构

系统已有以下相关表：
- `call_records` - 通话记录表
- `call_lines` - 外呼线路表
- `work_phones` - 工作手机表
- `phone_configs` - 电话配置表
- `phone_blacklist` - 黑名单表

### 4.2 表结构扩展

#### 4.2.1 work_phones 表扩展

```sql
-- 工作手机表扩展字段
ALTER TABLE work_phones 
ADD COLUMN device_id VARCHAR(100) COMMENT '设备唯一标识',
ADD COLUMN device_token VARCHAR(255) COMMENT '推送Token',
ADD COLUMN websocket_id VARCHAR(100) COMMENT 'WebSocket连接ID',
ADD COLUMN online_status ENUM('online', 'offline') DEFAULT 'offline' COMMENT '在线状态',
ADD COLUMN last_heartbeat DATETIME COMMENT '最后心跳时间',
ADD COLUMN app_version VARCHAR(20) COMMENT 'APP版本号',
ADD COLUMN os_type ENUM('android', 'ios') COMMENT '操作系统类型',
ADD COLUMN os_version VARCHAR(20) COMMENT '操作系统版本',
ADD COLUMN bind_time DATETIME COMMENT '绑定时间';

-- 添加索引
CREATE INDEX idx_work_phones_device_id ON work_phones(device_id);
CREATE INDEX idx_work_phones_online_status ON work_phones(online_status);
```

#### 4.2.2 call_lines 表扩展

```sql
-- 外呼线路表扩展字段
ALTER TABLE call_lines
ADD COLUMN provider_type ENUM('aliyun', 'tencent', 'ronglian', 'tianrun', 'custom') 
    DEFAULT 'aliyun' COMMENT '服务商类型',
ADD COLUMN provider_config JSON COMMENT '服务商配置（加密存储）',
ADD COLUMN caller_number VARCHAR(20) COMMENT '外显号码',
ADD COLUMN webhook_url VARCHAR(255) COMMENT '回调地址',
ADD COLUMN webhook_secret VARCHAR(100) COMMENT '回调签名密钥',
ADD COLUMN daily_limit INT DEFAULT 0 COMMENT '每日外呼上限（0=不限）',
ADD COLUMN today_count INT DEFAULT 0 COMMENT '今日已呼数量',
ADD COLUMN last_reset_date DATE COMMENT '上次重置日期';

-- provider_config 示例（阿里云）
-- {
--   "accessKeyId": "xxx",
--   "accessKeySecret": "xxx（加密）",
--   "instanceId": "ccc-instance-xxx",
--   "region": "cn-shanghai"
-- }
```

#### 4.2.3 call_records 表扩展

```sql
-- 通话记录表扩展字段
ALTER TABLE call_records
ADD COLUMN call_method ENUM('mobile', 'cloud', 'sip') DEFAULT 'mobile' COMMENT '外呼方式',
ADD COLUMN line_id INT COMMENT '使用的线路ID',
ADD COLUMN provider_call_id VARCHAR(100) COMMENT '服务商通话ID',
ADD COLUMN provider_job_id VARCHAR(100) COMMENT '服务商任务ID',
ADD COLUMN hangup_cause VARCHAR(50) COMMENT '挂断原因',
ADD COLUMN recording_size BIGINT DEFAULT 0 COMMENT '录音文件大小（字节）',
ADD COLUMN caller_number VARCHAR(20) COMMENT '主叫号码（外显）',
ADD COLUMN ring_duration INT DEFAULT 0 COMMENT '振铃时长（秒）';

-- 添加索引
CREATE INDEX idx_call_records_call_method ON call_records(call_method);
CREATE INDEX idx_call_records_line_id ON call_records(line_id);
CREATE INDEX idx_call_records_provider_call_id ON call_records(provider_call_id);
```

#### 4.2.4 新增：设备绑定日志表

```sql
-- 设备绑定日志表
CREATE TABLE device_bindlogs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(50) NOT NULL COMMENT '用户ID',
  device_id VARCHAR(100) COMMENT '设备ID',
  phone_number VARCHAR(20) COMMENT '手机号码',
  device_name VARCHAR(100) COMMENT '设备名称',
  device_model VARCHAR(100) COMMENT '设备型号',
  os_type ENUM('android', 'ios') COMMENT '操作系统',
  bind_type ENUM('qrcode', 'manual') DEFAULT 'qrcode' COMMENT '绑定方式',
  action ENUM('bind', 'unbind') NOT NULL COMMENT '操作类型',
  ip_address VARCHAR(50) COMMENT 'IP地址',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_device_bindlogs_user_id (user_id),
  INDEX idx_device_bindlogs_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备绑定日志表';
```

#### 4.2.5 新增：外呼任务表（可选，用于批量外呼）

```sql
-- 外呼任务表
CREATE TABLE call_tasks (
  id VARCHAR(50) PRIMARY KEY COMMENT '任务ID',
  name VARCHAR(100) NOT NULL COMMENT '任务名称',
  type ENUM('single', 'batch') DEFAULT 'single' COMMENT '任务类型',
  status ENUM('pending', 'running', 'paused', 'completed', 'cancelled') 
    DEFAULT 'pending' COMMENT '任务状态',
  call_method ENUM('mobile', 'cloud') NOT NULL COMMENT '外呼方式',
  line_id INT COMMENT '使用的线路ID',
  total_count INT DEFAULT 0 COMMENT '总数量',
  success_count INT DEFAULT 0 COMMENT '成功数量',
  failed_count INT DEFAULT 0 COMMENT '失败数量',
  pending_count INT DEFAULT 0 COMMENT '待呼数量',
  created_by VARCHAR(50) NOT NULL COMMENT '创建人',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  started_at DATETIME COMMENT '开始时间',
  completed_at DATETIME COMMENT '完成时间',
  
  INDEX idx_call_tasks_status (status),
  INDEX idx_call_tasks_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外呼任务表';

-- 外呼任务明细表
CREATE TABLE call_task_items (
  id INT AUTO_INCREMENT PRIMARY KEY,
  task_id VARCHAR(50) NOT NULL COMMENT '任务ID',
  customer_id VARCHAR(50) COMMENT '客户ID',
  customer_name VARCHAR(100) COMMENT '客户姓名',
  customer_phone VARCHAR(20) NOT NULL COMMENT '客户电话',
  status ENUM('pending', 'calling', 'success', 'failed', 'skipped') 
    DEFAULT 'pending' COMMENT '状态',
  call_id VARCHAR(50) COMMENT '关联的通话记录ID',
  retry_count INT DEFAULT 0 COMMENT '重试次数',
  last_call_time DATETIME COMMENT '最后呼叫时间',
  remark VARCHAR(255) COMMENT '备注',
  sort_order INT DEFAULT 0 COMMENT '排序',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_call_task_items_task_id (task_id),
  INDEX idx_call_task_items_status (status),
  FOREIGN KEY (task_id) REFERENCES call_tasks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外呼任务明细表';
```


---

## 五、API接口设计

### 5.1 设备管理接口

```yaml
# 生成设备绑定二维码
POST /api/v1/calls/device/bindQRCode
Request:
  - userId: string (可选，默认当前用户)
Response:
  - qrCodeUrl: string (二维码图片URL或Base64)
  - qrCodeData: string (二维码数据JSON)
  - expiresAt: string (过期时间)

# APP扫码绑定设备
POST /api/v1/calls/device/bind
Request:
  - token: string (二维码中的临时Token)
  - deviceId: string (设备唯一标识)
  - phoneNumber: string (手机号码)
  - deviceName: string (设备名称)
  - deviceModel: string (设备型号)
  - osType: 'android' | 'ios'
  - osVersion: string
  - appVersion: string
Response:
  - success: boolean
  - websocketUrl: string (WebSocket连接地址)
  - userId: string
  - authToken: string (WebSocket认证Token)

# 获取已绑定设备列表
GET /api/v1/calls/device/list
Query:
  - userId: string (可选)
Response:
  - devices: Array<{
      id: number,
      phoneNumber: string,
      deviceName: string,
      deviceModel: string,
      osType: string,
      onlineStatus: 'online' | 'offline',
      lastActiveAt: string,
      bindTime: string
    }>

# 解绑设备
DELETE /api/v1/calls/device/:id
Response:
  - success: boolean

# 检查设备在线状态
GET /api/v1/calls/device/:id/status
Response:
  - online: boolean
  - lastHeartbeat: string
```

### 5.2 外呼线路管理接口

```yaml
# 获取外呼线路列表
GET /api/v1/calls/lines
Response:
  - lines: Array<{
      id: number,
      name: string,
      providerType: string,
      callerNumber: string,
      status: 'active' | 'inactive',
      maxConcurrent: number,
      currentConcurrent: number,
      dailyLimit: number,
      todayCount: number
    }>

# 添加外呼线路
POST /api/v1/calls/lines
Request:
  - name: string
  - providerType: 'aliyun' | 'tencent' | 'ronglian' | 'custom'
  - callerNumber: string
  - providerConfig: object (服务商配置)
  - maxConcurrent: number
  - dailyLimit: number
Response:
  - id: number
  - success: boolean

# 更新外呼线路
PUT /api/v1/calls/lines/:id
Request:
  - name: string
  - callerNumber: string
  - providerConfig: object
  - status: 'active' | 'inactive'
  - maxConcurrent: number
  - dailyLimit: number

# 删除外呼线路
DELETE /api/v1/calls/lines/:id

# 测试线路连通性
POST /api/v1/calls/lines/:id/test
Response:
  - success: boolean
  - latency: number (毫秒)
  - message: string
```

### 5.3 外呼控制接口

```yaml
# 发起外呼
POST /api/v1/calls/dial
Request:
  - customerId: string (客户ID)
  - customerPhone: string (客户电话)
  - customerName: string (客户姓名，可选)
  - callMethod: 'mobile' | 'cloud' (外呼方式)
  - lineId: number (线路ID，云呼叫时必填)
  - orderId: string (关联订单ID，可选)
Response:
  - success: boolean
  - callId: string (通话记录ID)
  - message: string

# 挂断通话
POST /api/v1/calls/hangup
Request:
  - callId: string
Response:
  - success: boolean

# 获取通话状态
GET /api/v1/calls/:callId/status
Response:
  - callId: string
  - status: 'calling' | 'ringing' | 'connected' | 'ended'
  - duration: number (当前通话时长，秒)
  - startTime: string
```

### 5.4 Webhook回调接口

```yaml
# 阿里云通话状态回调
POST /api/v1/calls/webhook/aliyun/status
Request: (阿里云回调数据)

# 阿里云录音完成回调
POST /api/v1/calls/webhook/aliyun/recording
Request: (阿里云回调数据)

# 腾讯云回调
POST /api/v1/calls/webhook/tencent
Request: (腾讯云回调数据)

# 容联云回调
POST /api/v1/calls/webhook/ronglian
Request: (容联云回调数据)
```

### 5.5 APP上报接口

```yaml
# 上报通话状态（APP调用）
POST /api/v1/calls/mobile/status
Headers:
  - Authorization: Bearer <token>
  - X-Device-Id: <deviceId>
Request:
  - callId: string
  - status: 'ringing' | 'connected' | 'ended'
  - timestamp: number

# 上报通话结束（APP调用）
POST /api/v1/calls/mobile/end
Request:
  - callId: string
  - status: 'connected' | 'missed' | 'busy' | 'rejected'
  - startTime: string
  - endTime: string
  - duration: number
  - hasRecording: boolean

# 上传录音文件（APP调用）
POST /api/v1/calls/mobile/recording/upload
Content-Type: multipart/form-data
Request:
  - callId: string
  - file: File (录音文件)
Response:
  - success: boolean
  - recordingUrl: string
```


---

## 六、前端改造方案

### 6.1 呼出配置弹窗改造

**当前问题**：
- 配置项过于复杂，很多是模拟功能
- SDK连接逻辑是前端模拟，没有实际功能
- 缺少线路管理入口

**改造方案**：

```
┌─────────────────────────────────────────────────────────────┐
│                      呼出配置弹窗                            │
├─────────────────────────────────────────────────────────────┤
│  [外呼方式]  [呼叫参数]  [高级设置]                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  外呼方式：                                                  │
│  ○ 工作手机外呼                                             │
│  ○ 云呼叫中心                                               │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  【工作手机外呼】                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  已绑定设备：iPhone 15 Pro (139****8888)            │   │
│  │  状态：● 在线                                        │   │
│  │  [解绑设备]  [重新绑定]                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  或                                                         │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [二维码图片]                                        │   │
│  │                                                      │   │
│  │  请使用CRM手机APP扫描二维码绑定设备                   │   │
│  │  [下载Android APP]  [下载iOS APP]                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  【云呼叫中心】                                              │
│  外呼线路：[选择线路 ▼]  [管理线路]                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  线路名称：阿里云主线路                              │   │
│  │  外显号码：021-12345678                              │   │
│  │  状态：● 正常  今日已呼：156/500                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│                              [取消]  [保存配置]             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 线路管理弹窗（新增）

```
┌─────────────────────────────────────────────────────────────┐
│                      外呼线路管理                            │
├─────────────────────────────────────────────────────────────┤
│  [+ 添加线路]                                               │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 阿里云主线路                                         │   │
│  │ 服务商：阿里云  外显：021-12345678  状态：● 正常     │   │
│  │ 今日：156/500  并发：2/10                            │   │
│  │                              [编辑] [测试] [删除]    │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 腾讯云备用线路                                       │   │
│  │ 服务商：腾讯云  外显：400-123-4567  状态：○ 停用     │   │
│  │ 今日：0/1000  并发：0/20                             │   │
│  │                              [编辑] [测试] [启用]    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 添加/编辑线路弹窗

```
┌─────────────────────────────────────────────────────────────┐
│                      添加外呼线路                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  线路名称：[________________________]                       │
│                                                             │
│  服务商：  [阿里云 ▼]                                       │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  阿里云配置：                                               │
│                                                             │
│  AccessKey ID：    [________________________]               │
│  AccessKey Secret：[________________________] 👁            │
│  实例ID：          [________________________]               │
│  外显号码：        [________________________]               │
│  服务区域：        [华东1（杭州） ▼]                        │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  限制设置：                                                 │
│                                                             │
│  最大并发数：[10____]                                       │
│  每日上限：  [500___] (0=不限制)                            │
│                                                             │
│                              [取消]  [测试连接]  [保存]     │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 通话状态显示改造

**点击拨打后的状态显示**：

```
┌─────────────────────────────────────────────────────────────┐
│                      正在呼叫                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    📞 正在呼叫...                           │
│                                                             │
│                    张三                                     │
│                    139****5678                              │
│                                                             │
│                    ⏱ 00:00:05                              │
│                                                             │
│                    [挂断]                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      通话中                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    📞 通话中                                │
│                                                             │
│                    张三                                     │
│                    139****5678                              │
│                                                             │
│                    ⏱ 00:02:35                              │
│                                                             │
│              [静音]  [挂断]  [转接]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      通话结束                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    ✅ 通话已结束                            │
│                                                             │
│                    张三 139****5678                         │
│                    通话时长：2分35秒                        │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  快速记录：                                                 │
│                                                             │
│  通话结果：[已接通 ▼]                                       │
│  客户意向：[有意向 ▼]                                       │
│  备注：    [________________________]                       │
│                                                             │
│  下次跟进：[2025-12-26 ▼] [10:00 ▼]                        │
│                                                             │
│                              [跳过]  [保存并关闭]           │
└─────────────────────────────────────────────────────────────┘
```


---

## 七、开发计划与工作量

### 7.1 工作手机外呼开发计划

| 阶段 | 任务 | 工作量 | 负责人 |
|-----|------|-------|-------|
| **阶段1：基础架构** | | **5天** | |
| | 数据库表结构扩展 | 0.5天 | 后端 |
| | 设备管理API开发 | 1天 | 后端 |
| | WebSocket消息协议实现 | 1.5天 | 后端 |
| | 前端配置界面改造 | 2天 | 前端 |
| **阶段2：Android APP** | | **5天** | |
| | APP基础框架搭建 | 1天 | 移动端 |
| | 登录/扫码绑定功能 | 1天 | 移动端 |
| | WebSocket通信模块 | 1天 | 移动端 |
| | 拨号/通话监听功能 | 1.5天 | 移动端 |
| | 录音功能（可选） | 0.5天 | 移动端 |
| **阶段3：iOS APP** | | **5天** | |
| | APP基础框架搭建 | 1天 | 移动端 |
| | 登录/扫码绑定功能 | 1天 | 移动端 |
| | WebSocket通信模块 | 1天 | 移动端 |
| | 拨号/CallKit监听 | 2天 | 移动端 |
| **阶段4：联调测试** | | **3天** | |
| | Android联调测试 | 1天 | 全员 |
| | iOS联调测试 | 1天 | 全员 |
| | Bug修复与优化 | 1天 | 全员 |
| **总计** | | **18天** | |

### 7.2 云呼叫中心开发计划

| 阶段 | 任务 | 工作量 | 负责人 |
|-----|------|-------|-------|
| **阶段0：服务开通** | | **5-10天（等待审核）** | |
| | 注册云服务商账号 | 0.5天 | 运营 |
| | 提交企业资质审核 | 等待3-7天 | 运营 |
| | 申请外显号码 | 等待3-7天 | 运营 |
| **阶段1：后端开发** | | **4天** | |
| | 数据库表结构扩展 | 0.5天 | 后端 |
| | 线路管理API开发 | 1天 | 后端 |
| | 外呼API封装（阿里云） | 1天 | 后端 |
| | Webhook回调处理 | 1天 | 后端 |
| | 状态同步与推送 | 0.5天 | 后端 |
| **阶段2：前端开发** | | **3天** | |
| | 呼出配置界面改造 | 1天 | 前端 |
| | 线路管理界面开发 | 1天 | 前端 |
| | 通话状态显示优化 | 1天 | 前端 |
| **阶段3：联调测试** | | **2天** | |
| | 全流程联调 | 1天 | 全员 |
| | Bug修复与优化 | 1天 | 全员 |
| **总计（不含审核等待）** | | **9天** | |

### 7.3 总体开发计划

```
┌─────────────────────────────────────────────────────────────────────┐
│                        开发计划甘特图                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  第1周    第2周    第3周    第4周    第5周                          │
│  ├────────┼────────┼────────┼────────┼────────┤                    │
│                                                                     │
│  云呼叫中心：                                                        │
│  ████████████████████████████                                       │
│  [服务开通等待] [后端开发] [前端] [测试]                             │
│                                                                     │
│  工作手机外呼：                                                      │
│            ████████████████████████████████████████                 │
│            [基础架构] [Android APP] [iOS APP] [联调]                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

建议开发顺序：
1. 先开发云呼叫中心（对接简单，可快速上线）
2. 同时申请云服务商资质（利用等待时间）
3. 再开发工作手机外呼（需要APP开发，周期长）
```

### 7.4 技术风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 云服务商资质审核不通过 | 无法使用云呼叫 | 提前准备完整材料，选择多个服务商备选 |
| Android录音功能受限 | 部分手机无法录音 | 提示用户手动录音，或使用外部录音设备 |
| iOS无法自动拨号 | 用户体验下降 | 优化交互，减少用户操作步骤 |
| APP后台被杀死 | 无法接收拨号指令 | 使用前台服务、VoIP Push等保活方案 |
| WebSocket断连 | 实时性下降 | 实现断线重连、消息队列缓存 |


---

## 八、附录

### 8.1 云服务商开通指南链接

| 服务商 | 产品文档 | 控制台 |
|-------|---------|-------|
| 阿里云 | [云呼叫中心文档](https://help.aliyun.com/product/90012.html) | [控制台](https://ccc.console.aliyun.com/) |
| 腾讯云 | [云呼叫中心文档](https://cloud.tencent.com/document/product/679) | [控制台](https://console.cloud.tencent.com/ccc) |
| 容联云 | [七陌云客服文档](https://www.yuntongxun.com/doc/rest/callcenter/) | [控制台](https://app.cloopen.com/) |

### 8.2 挂断原因码说明

| 原因码 | 说明 | 处理建议 |
|-------|------|---------|
| `NORMAL_CLEARING` | 正常挂断 | 无需处理 |
| `USER_BUSY` | 用户忙 | 稍后重拨 |
| `NO_ANSWER` | 无人接听 | 稍后重拨 |
| `CALL_REJECTED` | 拒接 | 标记客户状态 |
| `INVALID_NUMBER` | 无效号码 | 核实号码 |
| `UNALLOCATED_NUMBER` | 空号 | 标记为无效 |
| `NETWORK_ERROR` | 网络错误 | 检查线路 |
| `TIMEOUT` | 呼叫超时 | 稍后重拨 |

### 8.3 通话状态流转图

```
                    ┌─────────┐
                    │  待呼叫  │
                    │ pending │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │  拨号中  │
                    │ calling │
                    └────┬────┘
                         │
              ┌──────────┼──────────┐
              │          │          │
              ▼          ▼          ▼
         ┌─────────┐ ┌─────────┐ ┌─────────┐
         │  振铃中  │ │  未接通  │ │  失败   │
         │ ringing │ │ missed  │ │ failed  │
         └────┬────┘ └─────────┘ └─────────┘
              │
              │
    ┌─────────┼─────────┐
    │         │         │
    ▼         ▼         ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│  已接通  │ │  拒接   │ │  忙线   │
│connected│ │rejected │ │  busy   │
└────┬────┘ └─────────┘ └─────────┘
     │
     ▼
┌─────────┐
│  已结束  │
│  ended  │
└─────────┘
```

### 8.4 WebSocket心跳机制

```
客户端每30秒发送心跳：
{
  "type": "HEARTBEAT",
  "timestamp": 1703491200000
}

服务端响应：
{
  "type": "HEARTBEAT_ACK",
  "timestamp": 1703491200100
}

超时判断：
- 60秒未收到心跳，标记设备离线
- 90秒未收到心跳，断开WebSocket连接
```

### 8.5 录音文件存储方案

```
存储路径规则：
/recordings/{year}/{month}/{day}/{callId}.mp3

示例：
/recordings/2025/12/25/call_20251225_abc123.mp3

存储策略：
- 本地存储：适合小规模，成本低
- OSS存储：适合大规模，可靠性高
- 混合存储：本地缓存 + 异步上传OSS

保留策略：
- 默认保留90天
- 可配置保留时长
- 到期自动清理
```

---

## 文档修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|-----|------|---------|-------|
| v1.0 | 2025-12-25 | 初始版本 | Kiro |

---

*本文档为技术方案设计文档，具体实现可能根据实际情况调整。*
