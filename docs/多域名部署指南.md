# 云客CRM 多域名部署指南

## 域名规划

| 系统 | 域名 | 用途 |
|------|------|------|
| 官网 | `abc789.cn` | 产品介绍、注册、购买 |
| CRM系统 | `app.abc789.cn` | 客户使用的CRM系统 |
| 管理后台 | `admin.abc789.cn` | 内部运营管理 |
| API接口 | `api.abc789.cn` | 移动端API（可选） |

## 部署步骤

### 1. 域名解析

登录域名管理后台，添加以下DNS记录：

```
类型    主机记录    记录值
A       @          服务器IP
A       www        服务器IP
A       app        服务器IP
A       admin      服务器IP
A       api        服务器IP
```

### 2. 服务器目录结构

```
/var/www/
├── website/          # 官网
│   └── dist/
├── crm/              # CRM系统（原来的前端）
│   └── dist/
├── admin/            # 管理后台
│   └── dist/
└── backend/          # 后端服务
    └── ...
```

### 3. 构建各项目

```bash
# 构建官网
cd website
npm run build
# 将 dist 目录上传到 /var/www/website/dist

# 构建CRM前端
cd ..  # 回到项目根目录
npm run build
# 将 dist 目录上传到 /var/www/crm/dist

# 构建管理后台
cd admin
npm run build
# 将 dist 目录上传到 /var/www/admin/dist
```

### 4. 配置Nginx

```bash
# 备份原配置
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak

# 复制新配置
sudo cp nginx-multi-domain-config.conf /etc/nginx/conf.d/abc789.conf

# 测试配置
sudo nginx -t

# 重载Nginx
sudo nginx -s reload
```

### 5. 申请SSL证书（推荐）

使用 Let's Encrypt 免费证书：

```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书（会自动配置Nginx）
sudo certbot --nginx -d abc789.cn -d www.abc789.cn -d app.abc789.cn -d admin.abc789.cn -d api.abc789.cn

# 设置自动续期
sudo certbot renew --dry-run
```

### 6. 更新前端配置

#### CRM系统 API 地址
修改 `src/utils/request.ts` 或环境变量：
```typescript
// 生产环境使用相对路径，Nginx会代理
const baseURL = '/api'
```

#### 管理后台 API 地址
修改 `admin/src/api/request.ts`：
```typescript
const baseURL = '/api'
```

#### 官网 API 地址
修改 `website/src/views/Register.vue` 等文件：
```typescript
const API_BASE = '/api/v1'
```

## 迁移现有系统

如果你现在 `abc789.cn` 已经在运行CRM系统：

### 方案A：平滑迁移（推荐）

1. 先配置好 `app.abc789.cn` 指向CRM系统
2. 测试 `app.abc789.cn` 正常访问
3. 通知用户新地址，设置过渡期
4. 修改主域名配置指向官网
5. 主域名原来的访问自动跳转到 `app.abc789.cn`

临时跳转配置：
```nginx
server {
    listen 80;
    server_name abc789.cn www.abc789.cn;
    
    # 如果访问的是登录页或系统页面，跳转到app子域名
    location ~ ^/(login|dashboard|customer|order) {
        return 301 https://app.abc789.cn$request_uri;
    }
    
    # 其他访问官网
    root /var/www/website/dist;
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 方案B：直接切换

1. 选择低峰期操作
2. 一次性更新所有Nginx配置
3. 通知用户新的访问地址

## 常见问题

### Q: 原来的用户书签怎么办？
A: 在主域名配置301跳转，访问原系统路径自动跳转到 `app.abc789.cn`

### Q: API跨域问题？
A: 每个子域名的Nginx都配置了API代理，前端使用相对路径 `/api`，不存在跨域

### Q: 如何回滚？
A: 保留原Nginx配置备份，随时可以恢复

## 验证清单

- [ ] DNS解析生效（可用 `ping app.abc789.cn` 测试）
- [ ] 官网可正常访问
- [ ] CRM系统可正常登录
- [ ] 管理后台可正常登录
- [ ] API接口可正常调用
- [ ] WebSocket连接正常
- [ ] SSL证书配置正确
