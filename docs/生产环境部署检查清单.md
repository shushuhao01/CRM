# 生产环境部署检查清单

## 当前问题总结

### 问题1：WebSocket 连接失败
- APP 日志：`[WebSocket] 连接错误:, {}`
- 原因：JWT_SECRET 不一致或后端没有正确处理 WebSocket 连接

### 问题2：CRM端解绑工作手机 404
- 错误：`DELETE /call-config/work-phones/ 404`
- 原因：`phone.id` 是 `undefined`

### 问题3：APP端解绑返回 500
- 错误：`/mobile/unbind 500 {"success":false,"message":"解绑失败"}`
- 原因：后端抛出异常

### 问题4：前端代码没有更新
- 生产环境：`CallManagement-Vayp_2bN.js`
- 本地构建：`CallManagement-x9S4Tp6q.js`
- **这是最关键的问题！**

---

## 部署步骤

### 1. 上传前端代码
```bash
# 确保上传的是最新构建的 dist 文件夹
# 检查文件名是否包含 CallManagement-x9S4Tp6q.js
```

### 2. 更新后端代码
```bash
cd /www/wwwroot/abc789.cn/backend
git pull origin main
```

### 3. 检查后端 .env 文件
确保生产环境的 `.env` 文件包含：
```
JWT_SECRET=35d51d8221f3688c16040e1236854a7248ec3972bf62a6e9532de2d3741a8c69
```

**重要：这个值必须和本地开发环境一致！**

### 4. 重启后端服务
```bash
pm2 restart all
# 或
pm2 restart crm-backend
```

### 5. 清除浏览器缓存
- 按 Ctrl+Shift+Delete 清除缓存
- 或使用无痕模式访问

### 6. APP 重新扫码绑定
因为 wsToken 是用 JWT_SECRET 签名的，如果密钥变了，旧的 token 就无效了。

---

## 验证方法

### 验证前端代码是否更新
打开浏览器开发者工具 → Network → 搜索 `CallManagement`
- 如果文件名是 `CallManagement-x9S4Tp6q.js`，说明更新成功
- 如果还是 `CallManagement-Vayp_2bN.js`，说明没有更新

### 验证后端 WebSocket 服务
查看后端日志：
```bash
pm2 logs crm-backend --lines 100
```
应该能看到：
- `📱 移动端 WebSocket 服务已初始化 (路径: /ws/mobile)`
- `[MobileWS] 收到连接请求, URL: ...`

### 验证 JWT_SECRET
在后端日志中应该能看到：
- `[MobileWS] 验证 token, JWT_SECRET 前缀: 35d51d8221...`

如果前缀不是 `35d51d8221`，说明 JWT_SECRET 配置不正确。
