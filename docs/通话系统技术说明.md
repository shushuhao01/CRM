# 通话系统技术说明

## 问题分析与解决方案

### 问题1：挂断系统电话后CRM通话中页面不同步关闭

**原因分析**：
- APP使用 `plus.device.dial()` 调用系统电话，这是一个"发射后不管"的API
- 系统电话应用是独立进程，APP无法直接监听其状态变化
- 之前的实现依赖用户在结束通话页面提交跟进记录后才通知CRM

**解决方案**：
- 新增 `callStateService.ts` 服务，使用 Android TelephonyManager API 轮询检测通话状态
- 通过 `plus.android.importClass` 调用原生 API 获取通话状态
- 状态变化时自动通过 WebSocket 通知 CRM 端

**技术实现**：
```typescript
// 使用 Android TelephonyManager 获取通话状态
const main = plus.android.runtimeMainActivity()
const Context = plus.android.importClass('android.content.Context')
plus.android.importClass('android.telephony.TelephonyManager')
const telephonyManager = main.getSystemService(Context.TELEPHONY_SERVICE)
const callState = telephonyManager.getCallState()
// callState: 0=IDLE, 1=RINGING, 2=OFFHOOK
```

### 问题2：对方接通后CRM页面不开始计时

**原因分析**：
- 同问题1，`plus.device.dial()` 无法获取通话接通状态
- CRM端收不到"connected"状态消息

**解决方案**：
- `callStateService` 检测到 `OFFHOOK` 状态（callState=2）时，表示通话已接通
- 自动通过 WebSocket 发送 `connected` 状态给 CRM 端
- CRM 端收到后开始计时

### 问题3：通话中备注保存

**现状**：
- CRM端的 `saveCallNotes` 函数已实现
- 调用 `callConfigApi.updateCallNotes` API 保存备注
- 通话结束时会自动保存备注

### 问题4 & 5：录音问题

**解决方案：系统录音 + 自动扫描上传**

由于 Android 系统限制，普通APP无法直接录制通话双向音频。我们采用以下方案：

1. **利用手机系统自带的通话录音功能**
   - 大部分国产手机（小米、华为、OPPO、VIVO等）都有通话录音功能
   - 用户需要在手机设置中开启"通话自动录音"

2. **APP自动扫描录音文件**
   - 通话结束后，APP扫描系统录音文件夹
   - 根据通话时间和电话号码匹配对应的录音文件
   - 支持多种手机品牌的录音路径

3. **自动上传到服务器**
   - 找到匹配的录音后自动上传
   - 通过 WebSocket 通知 CRM 端录音已上传

**支持的录音路径**：
```
小米: /storage/emulated/0/MIUI/sound_recorder/call_rec/
华为: /storage/emulated/0/Sounds/CallRecord/
OPPO: /storage/emulated/0/Recordings/Call/
VIVO: /storage/emulated/0/Record/Call/
三星: /storage/emulated/0/Call/
通用: /storage/emulated/0/Recordings/
```

## 当前实现状态

### 已实现功能
1. ✅ 通话状态监听（通过 TelephonyManager）
2. ✅ 通话接通检测和计时
3. ✅ 通话结束自动检测
4. ✅ WebSocket 状态同步到 CRM
5. ✅ 通话备注保存
6. ✅ 跟进记录提交
7. ✅ 系统录音文件扫描
8. ✅ 录音文件自动匹配
9. ✅ 录音文件自动上传
10. ✅ 录音设置页面

### 使用说明

1. **开启系统录音**
   - 进入APP设置页面
   - 点击"开启系统录音"
   - 在手机设置中开启"通话自动录音"

2. **检测录音状态**
   - 在设置页面点击"检测录音状态"
   - 如果显示"已开启"，说明系统录音正常工作

3. **自动上传**
   - 通话结束后，APP会自动扫描并上传录音
   - 上传成功后会显示"录音已上传"提示

## 权限要求

APP需要以下权限：
```xml
<uses-permission android:name="android.permission.CALL_PHONE"/>
<uses-permission android:name="android.permission.READ_PHONE_STATE"/>
<uses-permission android:name="android.permission.RECORD_AUDIO"/>
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
```

## 更新日志

- 2025-12-28: 新增 callStateService 服务，实现通话状态监听
- 2025-12-28: 修复通话接通后CRM不计时的问题
- 2025-12-28: 修复通话结束后CRM窗口不关闭的问题
- 2025-12-28: 新增 recordingService 服务，实现系统录音扫描和上传
- 2025-12-28: 新增录音设置页面，支持检测和开启系统录音
