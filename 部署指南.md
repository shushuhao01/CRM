# 部署指南

## 部署方式选择

本系统支持多种部署方式：

1. **宝塔面板部署**（推荐）- 适合新手，图形化操作
2. **Docker 部署** - 适合容器化环境
3. **手动部署** - 适合自定义配置

---

## 一、宝塔面板部署（推荐）

### 前置要求

- 服务器系统：CentOS 7+ / Ubuntu 18+ / Debian 9+
- 内存：至少 2GB
- 已安装宝塔面板 7.x+
- 已安装 Nginx 1.20+
- 已安装 MySQL 8.0+
- 已安装 Node.js 18+
- 已安装 PM2

### 步骤 1：准备服务器环境

#### 1.1 安装宝塔面板
```bash
# CentOS
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh

# Ubuntu/Debian
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

#### 1.2 安装软件
在宝塔面板中安装：
- Nginx 1.20+
- MySQL 8.0+
- Node.js 18+ (使用 PM2 管理器)

### 步骤 2：创建数据库

1. 进入宝塔面板 → 数据库
2. 点击"添加数据库"
3. 填写信息：
   - 数据库名：`crm_db`
   - 用户名：`crm_user`
   - 密码：自动生成或自定义
4. 点击"提交"

### 步骤 3：导入数据库结构

1. 点击数据库名称进入管理
2. 点击"导入"
3. 上传 `database/schema.sql` 文件
4. 点击"导入"

### 步骤 4：上传项目文件

#### 4.1 上传代码
```bash
# 方式一：使用 Git（推荐）
cd /www/wwwroot
git clone https://github.com/your-repo/crm.git
cd crm

# 方式二：使用宝塔面板上传
# 在宝塔面板 → 文件 → 上传项目压缩包
```

#### 4.2 安装依赖
```bash
# 前端依赖
npm install

# 后端依赖
cd backend
npm install
cd ..
```

### 步骤 5：配置环境变量

#### 5.1 配置后端环境变量
编辑 `backend/.env`：
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=crm_user
DB_PASSWORD=你的数据库密码
DB_NAME=crm_db

# 服务器配置
PORT=3000
NODE_ENV=production

# JWT 配置
JWT_SECRET=你的JWT密钥（随机生成）
JWT_EXPIRES_IN=7d
```

#### 5.2 配置前端环境变量
编辑 `.env.production`：
```env
# API 地址
VITE_API_BASE_URL=https://你的域名/api

# 是否使用真实 API
VITE_USE_REAL_API=true
```

### 步骤 6：构建前端

```bash
npm run build
```

构建完成后，会在 `dist` 目录生成静态文件。

### 步骤 7：配置 Nginx

#### 7.1 创建网站
1. 进入宝塔面板 → 网站
2. 点击"添加站点"
3. 填写信息：
   - 域名：`你的域名.com`
   - 根目录：`/www/wwwroot/crm/dist`
   - PHP 版本：纯静态
4. 点击"提交"

#### 7.2 配置反向代理
1. 点击网站名称 → 设置
2. 点击"反向代理"
3. 添加反向代理：
   - 代理名称：`api`
   - 目标 URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`
   - 内容替换：留空
4. 点击"保存"

#### 7.3 配置 URL 重写
在"配置文件"中添加：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}

location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 步骤 8：启动后端服务

#### 8.1 使用 PM2 启动
```bash
cd /www/wwwroot/crm/backend
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

#### 8.2 查看运行状态
```bash
pm2 list
pm2 logs crm-backend
```

### 步骤 9：配置 SSL 证书（可选）

1. 进入网站设置 → SSL
2. 选择"Let's Encrypt"
3. 点击"申请"
4. 开启"强制 HTTPS"

### 步骤 10：验证部署

1. 访问 `https://你的域名.com`
2. 使用测试账号登录：
   - 用户名：`admin`
   - 密码：`admin123`
3. 检查功能是否正常

---

## 二、Docker 部署

### 前置要求

- 已安装 Docker 20+
- 已安装 Docker Compose 2+

### 步骤 1：准备配置文件

创建 `docker-compose.yml`：
```yaml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: crm-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: crm_db
      MYSQL_USER: crm_user
      MYSQL_PASSWORD: crm_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/schema.sql

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: crm-backend
    restart: always
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: crm_user
      DB_PASSWORD: crm_password
      DB_NAME: crm_db
      PORT: 3000
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      - mysql

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crm-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

### 步骤 2：创建 Dockerfile

#### 前端 Dockerfile
创建 `Dockerfile`：
```dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 后端 Dockerfile
创建 `backend/Dockerfile`：
```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
RUN npm run build

EXPOSE 3000
CMD ["node", "dist/app.js"]
```

### 步骤 3：启动服务

```bash
docker-compose up -d
```

### 步骤 4：查看日志

```bash
docker-compose logs -f
```

---

## 三、手动部署

### 前置要求

- Node.js 18+
- MySQL 8.0+
- Nginx 1.20+
- PM2

### 步骤 1：安装依赖

```bash
# 前端
npm install

# 后端
cd backend
npm install
cd ..
```

### 步骤 2：配置数据库

```bash
mysql -u root -p
CREATE DATABASE crm_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'crm_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON crm_db.* TO 'crm_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 导入数据库结构
mysql -u crm_user -p crm_db < database/schema.sql
```

### 步骤 3：配置环境变量

参考"宝塔部署"中的环境变量配置。

### 步骤 4：构建项目

```bash
# 构建前端
npm run build

# 构建后端
cd backend
npm run build
cd ..
```

### 步骤 5：配置 Nginx

创建 `/etc/nginx/sites-available/crm`：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/crm/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

启用配置：
```bash
ln -s /etc/nginx/sites-available/crm /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

### 步骤 6：启动后端

```bash
cd backend
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

---

## 部署检查清单

### 部署前检查

- [ ] 服务器环境准备完成
- [ ] 数据库创建完成
- [ ] 环境变量配置正确
- [ ] 依赖安装完成
- [ ] 代码构建成功

### 部署后检查

- [ ] 前端页面可以访问
- [ ] 后端 API 可以访问
- [ ] 数据库连接正常
- [ ] 登录功能正常
- [ ] 权限控制正常
- [ ] 数据读写正常
- [ ] 文件上传正常
- [ ] 日志记录正常

### 性能检查

- [ ] 页面加载速度 < 3s
- [ ] API 响应时间 < 500ms
- [ ] 数据库查询优化
- [ ] 静态资源 CDN 加速
- [ ] 开启 Gzip 压缩

### 安全检查

- [ ] HTTPS 证书配置
- [ ] 数据库密码强度
- [ ] JWT 密钥安全
- [ ] 防火墙规则配置
- [ ] 定期备份策略

---

## 常见问题

### Q: 部署后页面空白？
A: 检查：
1. Nginx 配置是否正确
2. 前端构建是否成功
3. 浏览器控制台是否有错误
4. API 地址配置是否正确

### Q: API 请求 404？
A: 检查：
1. 后端服务是否启动
2. Nginx 反向代理配置是否正确
3. 端口是否被占用
4. 防火墙是否开放端口

### Q: 数据库连接失败？
A: 检查：
1. 数据库服务是否启动
2. 数据库配置是否正确
3. 用户权限是否足够
4. 防火墙是否允许连接

### Q: PM2 启动失败？
A: 检查：
1. Node.js 版本是否正确
2. 依赖是否安装完整
3. 环境变量是否配置
4. 端口是否被占用

### Q: 如何更新代码？
A: 
```bash
# 1. 拉取最新代码
git pull

# 2. 安装新依赖
npm install
cd backend && npm install && cd ..

# 3. 重新构建
npm run build
cd backend && npm run build && cd ..

# 4. 重启后端
pm2 restart crm-backend
```

---

## 维护建议

### 日常维护

1. **定期备份**
   - 每天备份数据库
   - 每周备份代码和配置
   - 使用自动化备份脚本

2. **监控日志**
   ```bash
   # 查看后端日志
   pm2 logs crm-backend
   
   # 查看 Nginx 日志
   tail -f /var/log/nginx/access.log
   tail -f /var/log/nginx/error.log
   ```

3. **性能监控**
   ```bash
   # 查看进程状态
   pm2 monit
   
   # 查看系统资源
   htop
   ```

### 安全维护

1. **定期更新**
   - 更新系统补丁
   - 更新 Node.js 版本
   - 更新依赖包

2. **安全审计**
   - 检查异常登录
   - 审查操作日志
   - 监控系统资源

3. **备份恢复**
   - 定期测试备份恢复
   - 制定灾难恢复计划

---

## 技术支持

如遇到部署问题，请提供以下信息：

1. 服务器系统和版本
2. Node.js 版本
3. 错误日志
4. 配置文件
5. 操作步骤

联系方式：
- GitHub Issues
- 技术支持邮箱
