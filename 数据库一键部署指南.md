# CRM系统数据库一键部署指南

## 🎯 概述

本指南提供了CRM系统数据库的完整一键部署解决方案，支持Node.js 22环境，适用于宝塔面板和各种Linux服务器环境。

## 📋 部署文件说明

### 核心文件
- `backend/database-init.sql` - 完整的数据库表结构和初始数据
- `db-deploy.sh` - 数据库一键部署脚本
- `test-db.sh` - 数据库连接测试脚本
- `backend/.env.database` - 数据库配置模板
- `start.sh` - 集成数据库部署的完整系统部署脚本

## 🚀 快速开始

### 方法一：完全一键部署（推荐）

```bash
# 1. 克隆项目到服务器
git clone https://github.com/your-username/CRM.git
cd CRM

# 2. 运行完整部署脚本
chmod +x start.sh
./start.sh

# 3. 选择数据库配置选项
# 选择 1: 数据库一键部署（自动创建数据库和表）
# 选择 2: 手动配置（需要先配置.env文件）
# 选择 3: 跳过数据库（仅构建前端）
```

### 方法二：单独数据库部署

```bash
# 1. 运行数据库部署脚本
chmod +x db-deploy.sh
./db-deploy.sh

# 2. 按提示输入数据库信息
# - 数据库主机（默认：localhost）
# - 数据库端口（默认：3306）
# - 数据库名称（默认：crm_system）
# - 数据库用户名（默认：root）
# - 数据库密码

# 3. 脚本将自动：
# - 创建数据库
# - 导入表结构
# - 插入初始数据
# - 生成.env配置文件
```

### 方法三：手动配置

```bash
# 1. 复制配置模板
cp backend/.env.database backend/.env

# 2. 编辑配置文件
nano backend/.env

# 3. 修改数据库连接信息
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=your_username
DB_PASSWORD=your_password
DB_DATABASE=your_database

# 4. 手动导入SQL脚本
mysql -u your_username -p your_database < backend/database-init.sql
```

## 🔧 宝塔面板部署步骤

### 1. 环境准备

在宝塔面板中安装：
- **Node.js v22.19.0**（软件商店 → 运行环境）
- **MySQL 8.0+**（软件商店 → 数据库）
- **PM2管理器**（软件商店 → 系统工具）

### 2. 创建数据库

1. 进入宝塔面板 → 数据库
2. 点击"添加数据库"
3. 填写数据库信息：
   - 数据库名：`crm_system`
   - 用户名：`crm_user`
   - 密码：设置强密码
4. 记录数据库信息备用

### 3. 上传项目代码

```bash
# 在服务器上克隆代码
cd /www/wwwroot/
git clone https://github.com/your-username/CRM.git
cd CRM

# 或者通过宝塔文件管理器上传
```

### 4. 一键部署

```bash
# 运行一键部署脚本
chmod +x start.sh
./start.sh

# 选择选项1进行数据库一键部署
# 输入刚才创建的数据库信息
```

### 5. 配置网站

1. 宝塔面板 → 网站 → 添加站点
2. 域名：填写你的域名
3. 根目录：`/www/wwwroot/CRM/dist`
4. PHP版本：纯静态
5. 在网站设置中添加反向代理：

```nginx
location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## 🧪 测试数据库连接

```bash
# 运行数据库连接测试
chmod +x test-db.sh
./test-db.sh
```

测试脚本将检查：
- ✅ 数据库连接状态
- ✅ MySQL版本兼容性
- ✅ 数据表结构完整性
- ✅ 初始数据是否正确

## 📊 数据库结构

### 核心数据表

| 表名 | 说明 | 记录数 |
|------|------|--------|
| `users` | 用户表 | 1（默认管理员） |
| `departments` | 部门表 | 4（默认部门） |
| `customers` | 客户表 | 0 |
| `products` | 产品表 | 0 |
| `product_categories` | 产品分类表 | 4（默认分类） |
| `orders` | 订单表 | 0 |
| `order_items` | 订单商品表 | 0 |
| `system_configs` | 系统配置表 | 6（基础配置） |

### 默认账户信息

- **用户名**: `admin`
- **密码**: `admin123`
- **邮箱**: `admin@crm.com`
- **角色**: 系统管理员

⚠️ **重要提醒**: 首次登录后请立即修改默认密码！

## 🔍 故障排除

### 常见问题

#### 1. 数据库连接失败
```bash
# 检查MySQL服务状态
systemctl status mysql

# 检查端口是否开放
netstat -tlnp | grep 3306

# 测试数据库连接
mysql -h localhost -u root -p
```

#### 2. 权限问题
```bash
# 给脚本执行权限
chmod +x *.sh

# 检查文件所有者
chown -R www:www /www/wwwroot/CRM
```

#### 3. Node.js版本问题
```bash
# 检查Node.js版本
node -v

# 如果版本不对，在宝塔面板切换版本
# 软件商店 → Node.js → 版本管理
```

#### 4. 端口冲突
```bash
# 检查3000端口占用
lsof -i :3000

# 修改后端端口（在.env文件中）
PORT=3001
```

### 日志查看

```bash
# 查看PM2服务状态
pm2 list

# 查看后端服务日志
pm2 logs crm-backend

# 查看系统日志
tail -f backend/logs/app.log
```

## 🔄 数据库维护

### 备份数据库

```bash
# 创建数据库备份
mysqldump -u crm_user -p crm_system > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 恢复数据库

```bash
# 恢复数据库备份
mysql -u crm_user -p crm_system < backup_20240101_120000.sql
```

### 重置数据库

```bash
# 重新运行部署脚本
./db-deploy.sh

# 选择删除现有数据库并重新创建
```

## 📈 性能优化

### MySQL配置优化

在宝塔面板 → 数据库 → MySQL管理 → 配置修改中添加：

```ini
[mysqld]
# 字符集设置
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# 性能优化
innodb_buffer_pool_size=256M
max_connections=200
query_cache_size=32M
```

### 定期维护

```bash
# 优化数据库表
mysqlcheck -u crm_user -p --optimize crm_system

# 分析表结构
mysqlcheck -u crm_user -p --analyze crm_system
```

## 🆕 版本升级

### 升级数据库结构

```bash
# 1. 备份现有数据
mysqldump -u crm_user -p crm_system > backup_before_upgrade.sql

# 2. 拉取最新代码
git pull origin main

# 3. 运行升级脚本（如果有）
# ./upgrade-db.sh

# 4. 测试数据库连接
./test-db.sh
```

## 📞 技术支持

如果遇到问题，请：

1. 查看本文档的故障排除部分
2. 运行 `./test-db.sh` 进行诊断
3. 检查日志文件：`pm2 logs crm-backend`
4. 提交Issue到GitHub仓库

---

## 🎉 部署完成检查清单

- [ ] Node.js 22.19.0 已安装
- [ ] MySQL 8.0+ 已安装并运行
- [ ] 数据库已创建并导入表结构
- [ ] .env配置文件已正确设置
- [ ] 数据库连接测试通过
- [ ] 后端服务启动成功（PM2）
- [ ] 前端构建完成
- [ ] Nginx反向代理配置正确
- [ ] 默认管理员账户可以登录
- [ ] 系统功能正常运行

✅ **恭喜！CRM系统数据库部署完成！**