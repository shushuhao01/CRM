# CRM系统部署指南

## 宝塔面板部署说明

### 1. 数据持久化功能说明

本CRM系统已实现完整的数据持久化功能，确保用户数据在页面刷新后不会丢失。系统使用localStorage进行本地数据存储，具有以下特性：

- ✅ **自动保存**: 数据变化时自动保存到浏览器本地存储
- ✅ **自动恢复**: 页面刷新后自动恢复用户数据
- ✅ **版本控制**: 支持数据版本管理，升级时自动处理
- ✅ **过期管理**: 支持数据过期时间，自动清理过期数据
- ✅ **错误处理**: 完善的错误处理机制，确保生产环境稳定性
- ✅ **存储优化**: 智能存储空间管理，防止存储溢出

### 2. 部署前准备

#### 2.1 环境要求
- Node.js 16+ 
- npm 或 yarn
- 现代浏览器支持（Chrome 60+, Firefox 55+, Safari 11+, Edge 79+）

#### 2.2 构建项目
```bash
# 安装依赖
npm install

# 构建生产版本
npm run build
```

### 3. 宝塔面板部署步骤

#### 3.1 创建网站
1. 登录宝塔面板
2. 点击"网站" -> "添加站点"
3. 输入域名和选择PHP版本（可选择纯静态）
4. 创建网站

#### 3.2 上传文件
1. 将构建后的 `dist` 目录下的所有文件上传到网站根目录
2. 确保文件权限正确（755）

#### 3.3 配置Nginx（推荐）
在网站设置中添加以下Nginx配置：

```nginx
location / {
    try_files $uri $uri/ /index.html;
}

# 静态资源缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# 安全头设置
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
```

#### 3.4 SSL证书配置
建议配置SSL证书，确保HTTPS访问，这对localStorage的安全性很重要。

### 4. 部署后验证

#### 4.1 自动检查
系统启动时会自动运行部署检查，在浏览器控制台查看检查结果：
- ✅ 检查通过：显示"数据持久化功能检查通过"
- ❌ 检查失败：显示具体错误信息

#### 4.2 手动测试
1. 访问网站并登录
2. 添加一些测试数据（客户、订单等）
3. 刷新页面，确认数据仍然存在
4. 访问 `/persistence-test` 页面进行完整测试

#### 4.3 浏览器兼容性测试
在以下浏览器中测试：
- Chrome（推荐）
- Firefox
- Safari
- Edge

### 5. 常见问题解决

#### 5.1 数据不持久化
**问题**: 刷新页面后数据丢失
**解决方案**:
1. 检查浏览器是否支持localStorage
2. 确认浏览器没有禁用本地存储
3. 检查是否在隐私模式下访问
4. 查看浏览器控制台是否有错误信息

#### 5.2 存储空间不足
**问题**: 控制台显示存储空间警告
**解决方案**:
1. 系统会自动清理过期数据
2. 用户可以在设置中清除本地数据
3. 建议定期清理浏览器缓存

#### 5.3 跨域问题
**问题**: API请求失败
**解决方案**:
1. 确保API服务器配置了正确的CORS头
2. 检查网站域名配置
3. 确认HTTPS/HTTP协议一致性

### 6. 性能优化建议

#### 6.1 CDN配置
建议使用CDN加速静态资源加载：
- 配置宝塔面板的CDN功能
- 或使用第三方CDN服务

#### 6.2 Gzip压缩
在宝塔面板中启用Gzip压缩：
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

#### 6.3 浏览器缓存
合理配置静态资源缓存时间，提高加载速度。

### 7. 监控和维护

#### 7.1 日志监控
定期检查以下日志：
- Nginx访问日志
- Nginx错误日志
- 浏览器控制台日志

#### 7.2 数据备份
虽然使用localStorage存储，但建议：
- 定期导出重要数据
- 配置数据库备份（如果有后端API）

#### 7.3 版本更新
更新系统时：
1. 备份当前版本
2. 更新版本号配置
3. 测试数据迁移功能
4. 逐步发布更新

### 8. 技术支持

如果在部署过程中遇到问题：
1. 查看浏览器控制台错误信息
2. 检查网络请求是否正常
3. 确认服务器配置是否正确
4. 联系技术支持团队

---

**重要提醒**: 
- 数据持久化功能依赖浏览器localStorage，请确保用户使用现代浏览器
- 建议在生产环境中配置HTTPS，提高安全性
- 定期检查系统运行状态，确保数据持久化功能正常工作