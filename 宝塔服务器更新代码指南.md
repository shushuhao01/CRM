# 宝塔服务器更新代码指南

> 本指南教您如何在宝塔服务器上更新 CRM 系统代码

---

## 📋 更新内容

本次更新包括：
- ✅ 优化部署脚本 `deploy.sh`
  - 自动内存检测和优化
  - 支持 2GB 内存服务器
  - 自动配置 npm 镜像加速
  - 智能配置文件管理
- ✅ 新增完整部署教程
  - 宝塔一键部署教程-最新版.md
  - 本地构建部署指南.md
  - 数据库配置指南.md
  - 代码更新指南.md

---

## 🚀 方法一：使用 Git 更新（推荐）

### 适用场景
- 已使用 Git 克隆的项目
- 需要保持与 GitHub 同步

### 操作步骤

#### 步骤 1：打开宝塔终端

1. 登录宝塔面板
2. 点击右上角的 **"终端"** 按钮

#### 步骤 2：备份当前配置（重要！）

```bash
# 进入项目目录
cd /www/wwwroot/CRM

# 备份配置文件
cp backend/.env backend/.env.backup
cp .env.production .env.production.backup 2>/dev/null || true

echo "✅ 配置文件已备份"
```

#### 步骤 3：拉取最新代码

```bash
# 保存本地修改（如果有）
git stash

# 拉取最新代码
git pull origin main

# 查看更新内容
git log --oneline -5
```

**应该看到**：
```
1f2b6f8 优化部署脚本：支持2GB内存服务器+新增完整部署教程
a97f05a 添加数据库最终版本说明文档 v1.8.3
...
```

#### 步骤 4：恢复配置文件

```bash
# 恢复配置文件
cp backend/.env.backup backend/.env
cp .env.production.backup .env.production 2>/dev/null || true

echo "✅ 配置文件已恢复"
```

#### 步骤 5：重新部署

```bash
# 给新脚本执行权限
chmod +x deploy.sh
chmod +x update.sh
chmod +x build-local.sh
chmod +x deploy-server-only.sh

# 执行部署（使用优化后的脚本）
./deploy.sh
```

#### 步骤 6：验证更新

```bash
# 查看服务状态
pm2 list

# 查看日志
pm2 logs crm-backend --lines 20
```

---

## 🔄 方法二：手动更新（适用于上传方式部署）

### 适用场景
- 未使用 Git 克隆
- 通过宝塔面板上传的项目

### 操作步骤

#### 步骤 1：下载最新代码

在本地电脑上：
1. 访问：https://github.com/shushuhao01/CRM
2. 点击绿色的 "Code" 按钮
3. 选择 "Download ZIP"
4. 下载到本地

#### 步骤 2：备份服务器上的配置

在宝塔面板：
1. 点击左侧 "文件"
2. 进入 `/www/wwwroot/CRM/backend`
3. 右键 `.env` 文件，选择 "下载"
4. 保存到本地

#### 步骤 3：备份旧项目（可选）

在宝塔终端：
```bash
cd /www/wwwroot
mv CRM CRM.backup.$(date +%Y%m%d)
```

#### 步骤 4：上传新代码

1. 在宝塔面板，进入 `/www/wwwroot`
2. 点击 "上传" 按钮
3. 选择刚下载的 ZIP 文件
4. 等待上传完成
5. 解压文件

#### 步骤 5：恢复配置文件

1. 将之前下载的 `.env` 文件上传到 `/www/wwwroot/CRM/backend/`
2. 如果有 `.env.production`，也上传到 `/www/wwwroot/CRM/`

#### 步骤 6：重新部署

在宝塔终端：
```bash
cd /www/wwwroot/CRM
chmod +x deploy.sh
./deploy.sh
```

---

## 📝 方法三：使用更新脚本（最简单）

### 适用场景
- 已部署的项目
- 需要快速更新

### 操作步骤

#### 步骤 1：打开宝塔终端

#### 步骤 2：执行更新脚本

```bash
# 进入项目目录
cd /www/wwwroot/CRM

# 给更新脚本执行权限
chmod +x update.sh

# 执行更新
./update.sh
```

**脚本会自动完成**：
1. ✅ 备份配置文件
2. ✅ 保存本地修改
3. ✅ 拉取最新代码
4. ✅ 恢复配置文件
5. ✅ 更新依赖
6. ✅ 构建前端
7. ✅ 重启后端服务

---

## ✅ 验证更新是否成功

### 1. 检查服务状态

```bash
pm2 list
```

应该看到 `crm-backend` 状态为 `online`

### 2. 查看日志

```bash
pm2 logs crm-backend --lines 20
```

检查是否有错误信息

### 3. 访问网站

在浏览器访问您的网站，测试功能是否正常

### 4. 测试新功能

- ✅ 登录系统
- ✅ 查看数据看板
- ✅ 测试客户管理
- ✅ 测试订单管理

---

## 🆕 新功能说明

### 1. 优化后的部署脚本

新版 `deploy.sh` 脚本特点：

#### 自动内存优化
```bash
# 脚本会自动检测服务器内存并优化
💾 系统内存: 2048MB
📊 Node.js 内存限制: 1.5GB
```

#### 自动配置管理
```bash
# 自动检查和创建配置文件
🔍 检查配置文件...
✅ 配置文件检查完成
```

#### npm 镜像加速
```bash
# 自动配置淘宝镜像
🔧 配置 npm 镜像...
✅ npm 镜像配置完成
```

### 2. 新增的部署教程

- **宝塔一键部署教程-最新版.md** - 最新最完整的部署教程
- **本地构建部署指南.md** - 适合低配服务器的本地构建方案
- **数据库配置指南.md** - 详细的数据库配置说明
- **update-guide.md** - 代码更新指南

### 3. 新增的辅助脚本

- **update.sh** - 一键更新脚本
- **build-local.sh** - 本地构建脚本（Mac/Linux）
- **build-local.bat** - 本地构建脚本（Windows）
- **deploy-server-only.sh** - 仅部署后端脚本

---

## ⚠️ 注意事项

### 1. 配置文件不会被覆盖

更新代码时，以下文件不会被覆盖：
- `backend/.env` - 后端配置
- `.env.production` - 前端配置

但建议在更新前备份，以防万一。

### 2. 数据库不会被影响

更新代码不会影响数据库数据，您的：
- ✅ 客户数据
- ✅ 订单数据
- ✅ 用户数据
- ✅ 所有业务数据

都会保持不变。

### 3. 需要重启服务

更新代码后，必须重启后端服务才能生效：
```bash
pm2 restart crm-backend
```

### 4. 清除浏览器缓存

更新前端后，建议清除浏览器缓存：
- 按 `Ctrl + Shift + Delete`
- 或按 `Ctrl + F5` 强制刷新

---

## 🔧 常见问题

### 问题 1：Git 拉取失败

**错误信息**：
```
error: Your local changes to the following files would be overwritten by merge
```

**解决方案**：
```bash
# 保存本地修改
git stash

# 拉取代码
git pull origin main

# 恢复本地修改
git stash pop
```

### 问题 2：部署脚本执行失败

**解决方案**：
```bash
# 检查脚本权限
ls -la deploy.sh

# 给予执行权限
chmod +x deploy.sh

# 重新执行
./deploy.sh
```

### 问题 3：服务启动失败

**解决方案**：
```bash
# 查看详细日志
pm2 logs crm-backend

# 检查配置文件
cat backend/.env

# 检查端口占用
netstat -tunlp | grep 3000
```

### 问题 4：前端更新后页面没变化

**解决方案**：
1. 清除浏览器缓存
2. 按 `Ctrl + F5` 强制刷新
3. 检查 dist 目录是否更新：
   ```bash
   ls -la dist/
   ```

---

## 📊 更新前后对比

| 项目 | 更新前 | 更新后 |
|------|--------|--------|
| 内存优化 | ❌ 无 | ✅ 自动优化 |
| 配置管理 | ⚠️ 手动 | ✅ 自动检查 |
| npm 镜像 | ❌ 默认 | ✅ 淘宝镜像 |
| 构建优化 | ❌ 无 | ✅ 缓存清理 |
| 最低配置 | 4GB | ✅ 2GB |
| 部署成功率 | ⚠️ 中等 | ✅ 高 |

---

## 🎯 推荐更新流程

### 对于生产环境：

1. **选择低峰期更新**（如凌晨）
2. **提前通知用户**
3. **备份数据库**：
   ```bash
   mysqldump -u root -p crm_db > backup_$(date +%Y%m%d).sql
   ```
4. **备份配置文件**
5. **执行更新**
6. **测试功能**
7. **监控日志**

### 对于测试环境：

1. **直接更新**
2. **测试新功能**
3. **确认无问题后再更新生产环境**

---

## 📞 需要帮助？

如果更新过程中遇到问题：

1. 查看本文档的常见问题部分
2. 查看 PM2 日志：`pm2 logs crm-backend`
3. 查看 Nginx 日志：`/www/wwwlogs/`
4. 在 GitHub 提交 Issue
5. 联系技术支持

---

## 🎉 更新完成！

更新完成后，您的系统将拥有：
- ✅ 更优化的部署脚本
- ✅ 更好的内存管理
- ✅ 更快的构建速度
- ✅ 更完善的文档

祝使用愉快！🚀

---

**版本**：v2.0  
**更新日期**：2024-11-23  
**适用于**：CRM 系统 v1.8.3+
