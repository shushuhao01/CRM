# 数据库更新说明 v1.8.1

## 📅 更新时间
2024-11-23

## 🎯 更新内容

### 一、订单表(orders)字段完善

#### 新增字段：
1. **service_wechat** (VARCHAR(100)) - 客服微信号
   - 用途：记录负责该订单的客服微信号
   - 必填：是
   - 索引：无

2. **order_source** (VARCHAR(50)) - 订单来源
   - 用途：记录订单来源渠道（如：线上商城、微信小程序、电话咨询等）
   - 必填：是
   - 索引：idx_order_source
   - 可配置：支持在系统设置中自定义来源选项

3. **deposit_amount** (DECIMAL(10,2)) - 定金金额
   - 用途：记录客户支付的定金金额
   - 默认值：0.00

4. **deposit_screenshots** (JSON) - 定金截图
   - 用途：存储定金支付截图的URL列表
   - 格式：JSON数组

5. **express_company** (VARCHAR(50)) - 快递公司
   - 用途：指定使用的快递公司
   - 必填：是

6. **mark_type** (VARCHAR(20)) - 订单标记类型
   - 用途：标记订单类型（normal-正常发货单，reserved-预留单）
   - 默认值：normal
   - 索引：idx_mark_type

7. **custom_fields** (JSON) - 自定义字段
   - 用途：存储管理员配置的自定义字段数据
   - 格式：JSON对象
   - 可扩展：支持在系统设置中动态添加字段

### 二、新增通话管理表

#### 1. call_records - 通话记录表
存储所有呼入呼出通话记录

**主要字段：**
- id: 通话ID
- customer_id: 客户ID
- customer_name: 客户姓名
- customer_phone: 客户电话
- call_type: 通话类型（outbound-呼出，inbound-呼入）
- call_status: 通话状态（connected-已接通，missed-未接听，busy-忙线，failed-失败，rejected-拒接）
- start_time: 开始时间
- end_time: 结束时间
- duration: 通话时长（秒）
- recording_url: 录音文件URL
- notes: 通话备注
- follow_up_required: 是否需要跟进
- user_id: 操作员ID
- user_name: 操作员姓名
- department: 所属部门

**索引：**
- idx_customer: 客户ID索引
- idx_user: 操作员ID索引
- idx_call_type: 通话类型索引
- idx_call_status: 通话状态索引
- idx_start_time: 开始时间索引
- idx_follow_up: 跟进标记索引

#### 2. follow_up_records - 跟进记录表
存储客户跟进计划和执行记录

**主要字段：**
- id: 跟进ID
- call_id: 关联通话ID
- customer_id: 客户ID
- customer_name: 客户姓名
- follow_up_type: 跟进方式（call-电话，visit-拜访，email-邮件，message-短信）
- content: 跟进内容
- next_follow_up_date: 下次跟进时间
- priority: 优先级（low-低，medium-中，high-高，urgent-紧急）
- status: 状态（pending-待处理，completed-已完成，cancelled-已取消）
- user_id: 跟进人ID
- user_name: 跟进人姓名

**索引：**
- idx_call: 通话ID索引
- idx_customer: 客户ID索引
- idx_user: 跟进人ID索引
- idx_status: 状态索引
- idx_priority: 优先级索引
- idx_next_follow_up: 下次跟进时间索引

### 三、新增短信管理表

#### 1. sms_templates - 短信模板表
存储短信模板和审核状态

**主要字段：**
- id: 模板ID
- name: 模板名称
- category: 模板分类（order-订单，logistics-物流，marketing-营销，service-服务，reminder-提醒）
- content: 模板内容
- variables: 变量列表（JSON格式）
- description: 模板描述
- applicant: 申请人ID
- applicant_name: 申请人姓名
- applicant_dept: 申请人部门
- status: 审核状态（pending-待审核，approved-已通过，rejected-已拒绝）
- approved_by: 审核人ID
- approved_at: 审核时间
- is_system: 是否系统模板

**索引：**
- idx_category: 分类索引
- idx_status: 状态索引
- idx_applicant: 申请人索引
- idx_is_system: 系统模板标记索引

#### 2. sms_records - 短信发送记录表
存储短信发送记录和统计

**主要字段：**
- id: 记录ID
- template_id: 模板ID
- template_name: 模板名称
- content: 短信内容
- recipients: 接收人列表（JSON格式）
- recipient_count: 接收人数量
- success_count: 成功数量
- fail_count: 失败数量
- status: 发送状态（pending-待发送，sending-发送中，completed-已完成，failed-失败）
- send_details: 发送详情（JSON格式）
- applicant: 申请人ID
- applicant_name: 申请人姓名
- applicant_dept: 申请人部门
- approved_by: 审核人ID
- approved_at: 审核时间
- sent_at: 发送时间
- remark: 备注

**索引：**
- idx_template: 模板ID索引
- idx_status: 状态索引
- idx_applicant: 申请人索引
- idx_sent_at: 发送时间索引

## 📊 数据库统计

### 更新前：15个表
- 核心表：5个
- 业务表：5个
- 统计表：2个
- 配置表：3个

### 更新后：19个表
- 核心表：5个
- 业务表：5个
- 统计表：2个
- 配置表：3个
- **通话管理表：2个** ✨新增
- **短信管理表：2个** ✨新增

## 🔄 升级方式

### 方式一：全新安装（推荐）
如果是新系统，直接导入最新的 `schema.sql` 文件即可。

### 方式二：增量升级
如果已有旧数据库，可以执行以下SQL语句进行升级：

```sql
-- 1. 修改订单表，添加新字段
ALTER TABLE `orders` 
ADD COLUMN `service_wechat` VARCHAR(100) COMMENT '客服微信号' AFTER `customer_phone`,
ADD COLUMN `order_source` VARCHAR(50) COMMENT '订单来源' AFTER `service_wechat`,
ADD COLUMN `deposit_amount` DECIMAL(10,2) DEFAULT 0.00 COMMENT '定金金额' AFTER `final_amount`,
ADD COLUMN `deposit_screenshots` JSON COMMENT '定金截图' AFTER `deposit_amount`,
ADD COLUMN `express_company` VARCHAR(50) COMMENT '快递公司' AFTER `shipping_name`,
ADD COLUMN `mark_type` VARCHAR(20) DEFAULT 'normal' COMMENT '订单标记类型' AFTER `express_company`,
ADD COLUMN `custom_fields` JSON COMMENT '自定义字段' AFTER `mark_type`,
ADD INDEX `idx_order_source` (`order_source`),
ADD INDEX `idx_mark_type` (`mark_type`);

-- 2. 创建通话记录表
-- （见 schema.sql 中的 call_records 表定义）

-- 3. 创建跟进记录表
-- （见 schema.sql 中的 follow_up_records 表定义）

-- 4. 创建短信模板表
-- （见 schema.sql 中的 sms_templates 表定义）

-- 5. 创建短信记录表
-- （见 schema.sql 中的 sms_records 表定义）
```

## ⚠️ 注意事项

1. **备份数据**：升级前请务必备份现有数据库
2. **测试环境**：建议先在测试环境验证升级脚本
3. **字符集**：确保数据库使用 utf8mb4 字符集
4. **权限检查**：确保数据库用户有 ALTER TABLE 权限
5. **应用版本**：需要配合前端应用 v1.8.0+ 版本使用

## 📝 功能说明

### 订单自定义字段
- 管理员可在"系统设置 > 订单设置"中配置自定义字段
- 支持多种字段类型：文本、数字、日期、下拉选择、单选、多选
- 自定义字段数据以JSON格式存储在 `custom_fields` 字段中

### 订单来源配置
- 管理员可在"系统设置 > 订单设置"中配置订单来源选项
- 默认提供：线上商城、微信小程序、微信客服、电话咨询等
- 支持自定义添加和修改来源选项

### 通话记录功能
- 支持呼入呼出通话记录
- 自动记录通话时长
- 支持通话录音存储
- 支持通话后跟进提醒

### 短信管理功能
- 支持短信模板管理和审核
- 支持批量发送短信
- 记录发送成功/失败详情
- 支持短信发送统计

## 🔗 相关文档

- [数据库完整说明](./database/README.md)
- [数据库脚本](./database/schema.sql)
- [宝塔部署指南](./宝塔部署快速指南.md)

## 📞 技术支持

如有问题，请查看项目文档或提交 Issue。
