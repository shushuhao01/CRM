# 部门管理和用户管理问题诊断与修复

## 问题描述

### 问题1：URL构造错误
生产环境部署后，访问部门管理和用户管理页面时出现以下错误：
- 部门管理：无法加载数据，创建新部门失败
- 用户管理：显示"服务器内部错误"
- 浏览器控制台错误：`TypeError: Failed to construct 'URL': Invalid URL`

### 问题2：登录TOKEN问题
登录后提示"找不到TOKEN"，无法正常使用系统。

## 问题原因

### 原因1：URL构造问题
`.env.production` 文件中的 `VITE_API_BASE_URL=/api/v1` 是相对路径，但在 `src/api/request.ts` 的 `buildUrl` 函数中使用 `new URL()` 构造 URL 时，需要完整的 URL（包含协议和域名）。

当 `BASE_URL` 是相对路径时，`new URL('/api/v1/system/departments')` 会抛出 `Invalid URL` 错误。

### 原因2：TOKEN验证机制被错误修改
为了解决之前的"秒退"问题，`src/stores/user.ts` 中的 `initUser` 函数被修改成了"跳过所有验证"，导致TOKEN机制被完全绕过。

## 解决方案

### 1. 修改 `src/api/request.ts` 中的 `buildUrl` 函数（已完成）

**修改前：**
```typescript
const buildUrl = (endpoint: string, params?: RequestParams): string => {
  const base = API_CONFIG.BASE_URL.replace(/\/+$/, '')
  const path = String(endpoint || '').replace(/^\/+/, '')
  const url = new URL(`${base}/${path}`)  // ❌ 相对路径会报错

  if (params) {
    Object.keys(params).forEach(key => {
      if (params[key] !== undefined && params[key] !== null) {
        url.searchParams.append(key, String(params[key]))
      }
    })
  }

  return url.toString()
}
```

**修改后：**
```typescript
const buildUrl = (endpoint: string, params?: RequestParams): string => {
  const base = API_CONFIG.BASE_URL.replace(/\/+$/, '')
  const path = String(endpoint || '').replace(/^\/+/, '')
  
  // 如果 BASE_URL 是相对路径（如 /api/v1），直接拼接
  let urlString: string
  if (base.startsWith('/')) {
    urlString = `${base}/${path}`
  } else {
    // 如果是绝对路径（如 http://...），使用 URL 对象
    urlString = `${base}/${path}`
  }

  // 添加查询参数
  if (params && Object.keys(params).length > 0) {
    const searchParams = new URLSearchParams()
    Object.keys(params).forEach(key => {
      if (params[key] !== undefined && params[key] !== null) {
        searchParams.append(key, String(params[key]))
      }
    })
    const queryString = searchParams.toString()
    if (queryString) {
      urlString += `?${queryString}`
    }
  }

  return urlString
}
```

### 2. 恢复正确的TOKEN验证机制（已完成）

修改 `src/stores/user.ts` 中的 `initUser` 函数：
- 保留TOKEN机制，确保有TOKEN才能登录
- 直接从localStorage恢复登录状态，不进行API验证（避免秒退）
- 恢复权限配置和权限服务

修改 `src/services/apiService.ts` 中的 `handleUnauthorized` 函数：
- 在Mock API模式下，忽略401错误，保持登录状态
- 只在真正需要时才清除认证信息

### 3. 重新构建前端

```bash
npm run build
```

### 4. 部署到服务器

1. 将 `dist` 文件夹的内容上传到宝塔面板的前端目录
2. 重启后端服务（如果需要）：
   ```bash
   pm2 restart abc789.cn-backend
   ```

## 验证步骤

1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 访问系统并登录
3. 进入"系统设置" → "部门管理"，检查是否能看到3个默认部门
4. 进入"系统设置" → "用户管理"，检查是否能看到5个系统预设用户
5. 尝试创建新部门，验证功能是否正常

## 后端API端点

部门管理相关API：
- `GET /api/v1/system/departments` - 获取部门列表
- `GET /api/v1/system/departments/tree` - 获取部门树
- `GET /api/v1/system/departments/stats` - 获取部门统计
- `POST /api/v1/system/departments` - 创建部门
- `PUT /api/v1/system/departments/:id` - 更新部门
- `DELETE /api/v1/system/departments/:id` - 删除部门

用户管理相关API：
- `GET /api/v1/users` - 获取用户列表
- `GET /api/v1/users/statistics` - 获取用户统计
- `POST /api/v1/users` - 创建用户

## 注意事项

1. 确保后端服务正常运行
2. 确保数据库连接正常
3. 确保Nginx配置正确，API请求能正确转发到后端
4. 如果仍有问题，检查后端日志：`pm2 logs abc789.cn-backend`

## 关键修复点

1. **URL构造修复**：支持相对路径和绝对路径的URL构造
2. **TOKEN机制恢复**：
   - 保留TOKEN验证，确保安全性
   - 避免不必要的API验证，防止秒退
   - Mock API模式下忽略401错误
3. **权限恢复**：正确恢复用户权限和权限服务配置

## 修复时间
2025-11-28

## 修复状态
✅ 已修复URL构造问题
✅ 已恢复TOKEN验证机制
⏳ 等待重新构建和部署
