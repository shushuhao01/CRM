# 数据库配置指南

## 📋 配置位置

数据库配置文件位于：**`backend/.env`**

---

## 🚀 快速配置步骤

### 步骤1：创建配置文件

在 `backend` 目录下，复制示例配置文件：

```bash
cd backend
cp .env.example .env
```

或者手动创建 `backend/.env` 文件。

---

### 步骤2：填写数据库信息

打开 `backend/.env` 文件，找到数据库配置部分，填写您的数据库信息：

```env
# ==========================================
# 数据库配置 - 必须修改
# ==========================================

# 数据库主机地址（宝塔面板通常为 localhost）
DB_HOST=localhost

# 数据库端口（MySQL默认 3306）
DB_PORT=3306

# 数据库用户名（填写您在宝塔面板创建的数据库用户名）
DB_USERNAME=crm_user

# 数据库密码（填写您在宝塔面板创建的数据库密码）
DB_PASSWORD=your_password_here

# 数据库名称（填写您在宝塔面板创建的数据库名）
DB_DATABASE=crm_db

# 数据库字符集（保持默认即可）
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
```

---

## 📝 配置示例

### 示例1：宝塔面板配置

假设您在宝塔面板创建了以下数据库：
- 数据库名：`crm_system`
- 用户名：`crm_admin`
- 密码：`Abc123456!`

则配置如下：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=crm_admin
DB_PASSWORD=Abc123456!
DB_DATABASE=crm_system
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
```

---

### 示例2：远程数据库配置

如果数据库在其他服务器上：

```env
DB_HOST=192.168.1.100
DB_PORT=3306
DB_USERNAME=remote_user
DB_PASSWORD=RemotePass123!
DB_DATABASE=crm_db
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
```

---

## 🔐 其他重要配置

### JWT密钥配置（必须修改）

```env
# JWT密钥（请生成随机字符串，用于用户登录认证）
JWT_SECRET=your_super_secret_jwt_key_change_in_production
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d
```

**建议生成方式**：
```bash
# 方法1：使用Node.js生成
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# 方法2：使用在线工具
# 访问 https://www.random.org/strings/ 生成随机字符串
```

---

### CORS跨域配置

```env
# 开发环境
CORS_ORIGIN=http://localhost:5173

# 生产环境（填写您的域名）
CORS_ORIGIN=https://your-domain.com

# 允许所有域名（不推荐生产环境使用）
CORS_ORIGIN=*
```

---

## 📂 完整的 .env 配置文件模板

```env
# ==========================================
# 服务器配置
# ==========================================
NODE_ENV=production
PORT=3000
API_PREFIX=/api/v1

# ==========================================
# 数据库配置 - 必须修改
# ==========================================
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=your_db_username
DB_PASSWORD=your_db_password
DB_DATABASE=your_database_name
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00

# ==========================================
# JWT配置 - 必须修改
# ==========================================
JWT_SECRET=your_super_secret_jwt_key_change_in_production
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# ==========================================
# 加密配置
# ==========================================
BCRYPT_ROUNDS=12

# ==========================================
# CORS配置 - 根据实际情况修改
# ==========================================
CORS_ORIGIN=*
CORS_CREDENTIALS=true

# ==========================================
# 文件上传配置
# ==========================================
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,image/gif,application/pdf

# ==========================================
# 邮件配置（可选）
# ==========================================
MAIL_HOST=smtp.qq.com
MAIL_PORT=587
MAIL_SECURE=false
MAIL_USER=your_email@qq.com
MAIL_PASS=your_email_password
MAIL_FROM=CRM系统 <your_email@qq.com>

# ==========================================
# 日志配置
# ==========================================
LOG_LEVEL=info
LOG_MAX_SIZE=20m
LOG_MAX_FILES=14d

# ==========================================
# 限流配置
# ==========================================
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# ==========================================
# 安全配置
# ==========================================
HELMET_ENABLED=true
COMPRESSION_ENABLED=true
```

---

## ✅ 配置验证

### 1. 检查配置文件是否存在

```bash
cd backend
ls -la .env
```

应该能看到 `.env` 文件。

---

### 2. 测试数据库连接

创建测试脚本 `backend/test-db.js`：

```javascript
require('dotenv').config();
const mysql = require('mysql2/promise');

async function testConnection() {
  try {
    const connection = await mysql.createConnection({
      host: process.env.DB_HOST,
      port: process.env.DB_PORT,
      user: process.env.DB_USERNAME,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_DATABASE
    });
    
    console.log('✅ 数据库连接成功！');
    console.log('数据库信息：', {
      host: process.env.DB_HOST,
      port: process.env.DB_PORT,
      database: process.env.DB_DATABASE,
      user: process.env.DB_USERNAME
    });
    
    await connection.end();
  } catch (error) {
    console.error('❌ 数据库连接失败：', error.message);
    process.exit(1);
  }
}

testConnection();
```

运行测试：

```bash
cd backend
node test-db.js
```

---

## 🔧 常见问题

### 问题1：找不到 .env 文件

**解决方案**：
```bash
cd backend
cp .env.example .env
# 然后编辑 .env 文件
```

---

### 问题2：数据库连接失败

**可能原因**：
1. 数据库用户名或密码错误
2. 数据库名称不存在
3. MySQL服务未启动
4. 防火墙阻止连接

**解决方案**：
1. 检查宝塔面板中的数据库信息
2. 确认数据库已创建
3. 确认MySQL服务正在运行
4. 检查防火墙设置

---

### 问题3：字符集问题

**解决方案**：
确保数据库字符集为 `utf8mb4`：

```sql
ALTER DATABASE your_database_name CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

---

### 问题4：时区问题

**解决方案**：
在 `.env` 中设置：

```env
DB_TIMEZONE=+08:00
```

---

## 📱 宝塔面板配置步骤

### 1. 登录宝塔面板

访问：`http://your-server-ip:8888`

---

### 2. 创建数据库

1. 点击左侧菜单 **"数据库"**
2. 点击 **"添加数据库"**
3. 填写信息：
   - 数据库名：`crm_system`
   - 用户名：`crm_admin`
   - 密码：生成强密码或自定义
   - 访问权限：选择 **"本地服务器"**
4. 点击 **"提交"**

---

### 3. 导入数据库

1. 在数据库列表中找到刚创建的数据库
2. 点击 **"管理"** 按钮
3. 点击 **"导入"** 标签
4. 上传 `database/schema.sql` 文件
5. 点击 **"导入"** 按钮

---

### 4. 记录数据库信息

将以下信息填写到 `backend/.env` 文件：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=crm_admin
DB_PASSWORD=你在宝塔面板设置的密码
DB_DATABASE=crm_system
```

---

## 🚀 启动应用

配置完成后，启动应用：

```bash
# 进入后端目录
cd backend

# 安装依赖（如果还没安装）
npm install

# 启动应用
npm start

# 或使用PM2启动（推荐生产环境）
pm2 start ecosystem.config.js
```

---

## 📊 验证配置成功

### 1. 检查日志

查看 `backend/logs/combined.log`，应该看到：

```
✅ 数据库连接成功
✅ 服务器启动成功，端口：3000
```

---

### 2. 测试API

访问：`http://your-server-ip:3000/api/v1/health`

应该返回：

```json
{
  "status": "ok",
  "database": "connected",
  "timestamp": "2024-11-23T12:00:00.000Z"
}
```

---

### 3. 测试登录

使用预设账号登录：
- 用户名：`superadmin`
- 密码：`super123456`

---

## 🔒 安全建议

1. **修改默认密码**：登录后立即修改所有预设账号的密码
2. **使用强密码**：数据库密码至少12位，包含大小写字母、数字和特殊字符
3. **限制访问**：数据库访问权限设置为"本地服务器"
4. **定期备份**：设置自动备份数据库
5. **更新JWT密钥**：生产环境必须使用随机生成的JWT密钥
6. **HTTPS**：生产环境使用HTTPS协议
7. **防火墙**：只开放必要的端口

---

## 📞 需要帮助？

如果配置过程中遇到问题：

1. 检查 `backend/logs/error.log` 日志文件
2. 确认数据库信息是否正确
3. 确认MySQL服务是否正常运行
4. 查看宝塔面板的数据库管理界面

---

## 🎉 配置完成！

配置完成后，您的CRM系统就可以正常使用了！

**下一步**：
1. 登录系统
2. 修改默认密码
3. 创建新用户
4. 开始使用CRM系统

---

**版本**：v1.0  
**更新日期**：2024-11-23  
**适用于**：CRM系统 v1.8.3
