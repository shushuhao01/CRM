<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手动添加客户流程测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .step h3 {
            margin-top: 0;
            color: #333;
            display: flex;
            align-items: center;
        }
        .step-number {
            background: #409eff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56565;
        }
        button.danger:hover {
            background: #fc8181;
        }
        .result {
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #fef0f0;
            border: 1px solid #fbc4c4;
            color: #f56565;
        }
        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #38a169;
        }
        .warning {
            background: #fffbf0;
            border: 1px solid #fed7aa;
            color: #d69e2e;
        }
        .links {
            margin-top: 20px;
        }
        .links a {
            display: inline-block;
            background: #67c23a;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            margin: 5px;
        }
        .links a:hover {
            background: #85ce61;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>手动添加客户流程测试</h1>
        <p>此页面用于测试手动添加客户的完整流程，模拟真实的用户操作</p>
        
        <div class="links">
            <a href="http://localhost:5175" target="_blank">打开CRM系统</a>
            <a href="http://localhost:5175/customer/list" target="_blank">客户列表页面</a>
            <a href="http://localhost:5175/customer/add" target="_blank">新增客户页面</a>
        </div>
    </div>

    <div class="container">
        <div class="step">
            <h3><span class="step-number">1</span>检查初始状态</h3>
            <p>检查当前localStorage中的客户数据</p>
            <button onclick="checkInitialState()">检查初始状态</button>
            <div id="step1-result" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span>模拟手动添加客户</h3>
            <p>填写客户信息并模拟提交流程</p>
            
            <div class="form-row">
                <div class="form-group">
                    <label>客户姓名 *</label>
                    <input type="text" id="customerName" value="测试客户" placeholder="请输入客户姓名">
                </div>
                <div class="form-group">
                    <label>手机号 *</label>
                    <input type="text" id="customerPhone" placeholder="请输入手机号">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>年龄</label>
                    <input type="number" id="customerAge" value="28" placeholder="请输入年龄">
                </div>
                <div class="form-group">
                    <label>客户等级</label>
                    <select id="customerLevel">
                        <option value="normal">普通客户</option>
                        <option value="silver">银卡客户</option>
                        <option value="gold">金卡客户</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>地址</label>
                <input type="text" id="customerAddress" value="北京市朝阳区测试地址" placeholder="请输入地址">
            </div>
            
            <button onclick="simulateManualAdd()">模拟手动添加客户</button>
            <button onclick="generateRandomPhone()">生成随机手机号</button>
            <div id="step2-result" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span>验证数据保存</h3>
            <p>检查客户数据是否正确保存到localStorage</p>
            <button onclick="verifyDataSaved()">验证数据保存</button>
            <div id="step3-result" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h3><span class="step-number">4</span>模拟列表页面刷新</h3>
            <p>模拟客户列表页面的数据加载和显示逻辑</p>
            <button onclick="simulateListRefresh()">模拟列表刷新</button>
            <div id="step4-result" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h3><span class="step-number">5</span>完整流程测试</h3>
            <p>运行完整的手动添加客户流程测试</p>
            <button onclick="runFullManualTest()">运行完整测试</button>
            <button onclick="clearTestData()" class="danger">清除测试数据</button>
            <div id="step5-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'crm_customers_unified';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = message;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function generateRandomPhone() {
            const phone = '139' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
            document.getElementById('customerPhone').value = phone;
        }

        function checkInitialState() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                let message = '=== 初始状态检查 ===\n';
                
                if (data) {
                    const parsed = JSON.parse(data);
                    message += `✓ 找到客户数据\n`;
                    message += `  - 客户数量: ${parsed.customers ? parsed.customers.length : 0}\n`;
                    message += `  - 数据版本: ${parsed.version}\n`;
                    message += `  - 最后更新: ${new Date(parsed.lastUpdated).toLocaleString()}\n\n`;
                    
                    if (parsed.customers && parsed.customers.length > 0) {
                        message += `最新3个客户:\n`;
                        parsed.customers.slice(0, 3).forEach((c, i) => {
                            message += `  ${i + 1}. ${c.name} (${c.phone}) - ${new Date(c.createTime).toLocaleString()}\n`;
                        });
                    }
                } else {
                    message += `✗ 未找到客户数据\n`;
                }
                
                log('step1-result', message, 'success');
            } catch (error) {
                log('step1-result', `检查初始状态失败: ${error.message}`, 'error');
            }
        }

        async function simulateManualAdd() {
            try {
                const name = document.getElementById('customerName').value;
                const phone = document.getElementById('customerPhone').value;
                const age = parseInt(document.getElementById('customerAge').value) || 28;
                const level = document.getElementById('customerLevel').value;
                const address = document.getElementById('customerAddress').value;

                if (!name || !phone) {
                    throw new Error('请填写客户姓名和手机号');
                }

                const timestamp = Date.now();
                const customerData = {
                    id: `customer_${timestamp}_${Math.random().toString(36).substr(2, 9)}`,
                    code: `TEST${timestamp}`,
                    name: name,
                    phone: phone,
                    age: age,
                    address: address,
                    level: level,
                    status: 'active',
                    salesPersonId: 'admin',
                    createdBy: 'admin',
                    createTime: new Date().toISOString(),
                    orderCount: 0,
                    source: 'manual_test',
                    tags: ['手动测试'],
                    remarks: '这是手动添加的测试客户'
                };

                let message = '=== 模拟手动添加客户 ===\n';
                message += `客户信息:\n`;
                message += `  - 姓名: ${customerData.name}\n`;
                message += `  - 手机: ${customerData.phone}\n`;
                message += `  - 年龄: ${customerData.age}\n`;
                message += `  - 等级: ${customerData.level}\n`;
                message += `  - 地址: ${customerData.address}\n\n`;

                // 步骤1: 模拟customerApi.checkExists
                message += '步骤1: 检查客户是否已存在\n';
                const existingData = localStorage.getItem(STORAGE_KEY);
                let customers = [];
                if (existingData) {
                    const parsed = JSON.parse(existingData);
                    customers = parsed.customers || [];
                }
                
                const existingCustomer = customers.find(c => c.phone === customerData.phone);
                if (existingCustomer) {
                    throw new Error(`客户已存在: ${existingCustomer.name} (${existingCustomer.phone})`);
                }
                message += `  ✓ 客户不存在，可以添加\n\n`;

                // 步骤2: 模拟customerStore.createCustomer
                message += '步骤2: 调用customerStore.createCustomer\n';
                
                // 2.1: 模拟customerApi.create -> mockApi.createCustomer
                message += '  2.1: 调用customerApi.create\n';
                message += '  2.2: 调用mockApi.createCustomer\n';
                message += '  2.3: 调用customerStorage.addCustomer\n';
                
                // 模拟customerStorage.addCustomer的逻辑
                customers.unshift(customerData);
                const newData = {
                    customers: customers,
                    lastUpdated: Date.now(),
                    version: '1.0.0'
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
                message += `  ✓ 客户已保存到localStorage\n\n`;

                // 步骤3: 模拟customerStore.loadCustomers
                message += '步骤3: 重新加载客户数据\n';
                message += `  ✓ 当前客户总数: ${customers.length}\n`;
                message += `  ✓ 新客户位置: 第1位\n\n`;

                // 步骤4: 模拟路由跳转
                message += '步骤4: 模拟路由跳转到客户列表\n';
                message += `  ✓ 跳转参数: refresh=true&timestamp=${timestamp}\n\n`;

                message += '=== 手动添加客户模拟完成 ===\n';
                message += `✓ 客户 ${customerData.name} 添加成功\n`;
                message += `✓ 数据已保存到localStorage\n`;
                message += `✓ 准备跳转到客户列表页面`;

                log('step2-result', message, 'success');
                
                // 保存最后添加的客户信息，供后续步骤使用
                window.lastAddedCustomer = customerData;
                
            } catch (error) {
                log('step2-result', `模拟手动添加客户失败: ${error.message}`, 'error');
            }
        }

        function verifyDataSaved() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (!data) {
                    log('step3-result', '没有找到客户数据，请先运行步骤2', 'warning');
                    return;
                }

                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];
                
                let message = '=== 验证数据保存 ===\n';
                message += `✓ localStorage中客户总数: ${customers.length}\n`;
                
                if (window.lastAddedCustomer) {
                    const lastAdded = window.lastAddedCustomer;
                    const found = customers.find(c => c.phone === lastAdded.phone);
                    
                    if (found) {
                        message += `✓ 找到最后添加的客户: ${found.name} (${found.phone})\n`;
                        message += `  - 客户ID: ${found.id}\n`;
                        message += `  - 创建时间: ${new Date(found.createTime).toLocaleString()}\n`;
                        message += `  - 在列表中的位置: ${customers.findIndex(c => c.id === found.id) + 1}\n`;
                    } else {
                        message += `✗ 未找到最后添加的客户: ${lastAdded.name} (${lastAdded.phone})\n`;
                    }
                }
                
                message += `\n最新3个客户:\n`;
                customers.slice(0, 3).forEach((c, i) => {
                    message += `  ${i + 1}. ${c.name} (${c.phone}) - ${new Date(c.createTime).toLocaleString()}\n`;
                });

                log('step3-result', message, 'success');
            } catch (error) {
                log('step3-result', `验证数据保存失败: ${error.message}`, 'error');
            }
        }

        function simulateListRefresh() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (!data) {
                    log('step4-result', '没有找到客户数据，请先运行步骤2', 'warning');
                    return;
                }

                const parsed = JSON.parse(data);
                const customers = parsed.customers || [];

                let message = '=== 模拟列表页面刷新 ===\n';
                
                // 模拟客户列表页面接收到refresh=true参数
                message += '步骤1: 接收到refresh=true参数\n';
                message += '  ✓ 重置分页到第1页\n';
                message += '  ✓ 清除搜索条件\n\n';
                
                // 模拟loadCustomerList(true)调用
                message += '步骤2: 调用loadCustomerList(true)\n';
                message += '  ✓ forceReload = true\n';
                message += '  ✓ 调用customerStore.forceRefreshCustomers\n\n';
                
                // 模拟forceRefreshCustomers
                message += '步骤3: 执行forceRefreshCustomers\n';
                message += '  ✓ 调用customerApi.getList\n';
                message += '  ✓ Mock API从customerStorage获取数据\n';
                message += `  ✓ 返回客户数据: ${customers.length} 个客户\n\n`;
                
                // 模拟数据显示
                message += '步骤4: 数据显示处理\n';
                message += '  ✓ 更新customerStore.customers\n';
                message += '  ✓ 触发filteredCustomers计算属性\n';
                message += '  ✓ 触发searchResults计算属性\n\n';
                
                // 显示最终结果
                const sortedCustomers = customers.sort((a, b) => {
                    return new Date(b.createTime).getTime() - new Date(a.createTime).getTime();
                });
                
                message += '最终显示结果:\n';
                message += `  - 总客户数: ${sortedCustomers.length}\n`;
                message += `  - 第1页显示: ${Math.min(50, sortedCustomers.length)} 个客户\n\n`;
                
                if (sortedCustomers.length > 0) {
                    message += '前3个客户（按创建时间降序）:\n';
                    sortedCustomers.slice(0, 3).forEach((c, i) => {
                        message += `  ${i + 1}. ${c.name} (${c.phone}) - ${new Date(c.createTime).toLocaleString()}\n`;
                    });
                }
                
                message += '\n=== 列表刷新模拟完成 ===';

                log('step4-result', message, 'success');
            } catch (error) {
                log('step4-result', `模拟列表刷新失败: ${error.message}`, 'error');
            }
        }

        async function runFullManualTest() {
            try {
                let message = '=== 完整手动添加客户流程测试 ===\n\n';
                
                // 自动生成测试数据
                const timestamp = Date.now();
                document.getElementById('customerName').value = `测试客户${timestamp}`;
                document.getElementById('customerPhone').value = '139' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
                document.getElementById('customerAge').value = '28';
                document.getElementById('customerLevel').value = 'normal';
                document.getElementById('customerAddress').value = '北京市朝阳区测试地址';
                
                message += '步骤1: 检查初始状态\n';
                checkInitialState();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                message += '步骤2: 模拟手动添加客户\n';
                await simulateManualAdd();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                message += '步骤3: 验证数据保存\n';
                verifyDataSaved();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                message += '步骤4: 模拟列表刷新\n';
                simulateListRefresh();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                message += '\n=== 完整流程测试完成 ===\n';
                message += '✓ 所有步骤执行成功\n';
                message += '✓ 客户数据正确保存和显示\n';
                message += '✓ 流程逻辑验证通过\n\n';
                message += '建议操作:\n';
                message += '1. 打开客户列表页面查看实际效果\n';
                message += '2. 尝试手动添加客户验证真实流程\n';
                message += '3. 检查新客户是否显示在列表第1位';

                log('step5-result', message, 'success');
            } catch (error) {
                log('step5-result', `完整流程测试失败: ${error.message}`, 'error');
            }
        }

        function clearTestData() {
            if (confirm('确定要清除所有测试数据吗？这将删除localStorage中的所有客户数据！')) {
                localStorage.removeItem(STORAGE_KEY);
                log('step5-result', '✓ 测试数据已清除', 'warning');
                
                // 清空表单
                document.getElementById('customerName').value = '测试客户';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerAge').value = '28';
                document.getElementById('customerLevel').value = 'normal';
                document.getElementById('customerAddress').value = '北京市朝阳区测试地址';
                
                // 清空结果显示
                ['step1-result', 'step2-result', 'step3-result', 'step4-result'].forEach(id => {
                    const element = document.getElementById(id);
                    element.style.display = 'none';
                });
            }
        }

        // 页面加载时自动生成随机手机号
        window.onload = function() {
            generateRandomPhone();
            checkInitialState();
        };
    </script>
</body>
</html>