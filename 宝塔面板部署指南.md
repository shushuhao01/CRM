# CRM系统宝塔面板部署指南

## 📋 部署前准备

### 1. 服务器环境要求
- 操作系统：CentOS 7+ / Ubuntu 18+ / Debian 9+
- 内存：至少 2GB RAM
- 硬盘：至少 20GB 可用空间
- 宝塔面板：7.7.0+

### 2. 已完成的配置
✅ **依赖安装**：前端和后端依赖已安装完成  
✅ **环境变量配置**：已配置生产环境变量  
✅ **数据库配置**：已更新数据库连接信息  
✅ **项目构建**：后端TypeScript已编译完成  

## 🗄️ 数据库部署

### 1. 在宝塔面板中执行SQL
1. 登录宝塔面板
2. 进入 **数据库** → **phpMyAdmin**
3. 选择数据库 `abc789_cn`
4. 点击 **SQL** 标签
5. 复制并执行以下SQL文件内容：
   ```
   backend/database-schema.sql
   ```

### 2. 数据库信息确认
- **数据库名**：abc789_cn
- **用户名**：abc789_cn  
- **密码**：pM8rpkQ22CS3
- **默认管理员账户**：
  - 用户名：admin
  - 密码：admin123

## 🚀 后端部署

### 1. 上传项目文件
将整个项目上传到服务器，建议路径：`/www/wwwroot/crm`

### 2. 安装Node.js环境
1. 在宝塔面板中安装 **Node.js项目管理器**
2. 安装Node.js版本：**18.x** 或更高版本
3. 安装PM2管理器

### 3. 配置Node.js项目

⚠️ **Node.js版本说明**：
- **推荐版本**：Node.js 18+ 或 20+
- **您的版本**：Node.js 16.20.2（已兼容处理）
- **兼容性**：项目已调整为支持Node.js 16+

#### 配置步骤：
1. 进入 **Node.js项目管理器**
2. 添加项目：
   - **项目路径**：`/www/wwwroot/crm/backend`
   - **启动文件**：`dist/app.js`
   - **端口**：3000
   - **项目名称**：crm-backend
   - **Node版本**：16.20.2

#### Node.js 16特殊配置：
```bash
# 安装依赖时使用兼容模式
npm install --production --legacy-peer-deps

# 如果遇到权限问题
npm install --production --legacy-peer-deps --unsafe-perm
```

### 4. 环境变量配置
确保 `backend/.env` 文件包含正确的配置：
```env
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_NAME=abc789_cn
DB_USERNAME=abc789_cn
DB_PASSWORD=pM8rpkQ22CS3
```

### 5. 启动后端服务
```bash
cd /www/wwwroot/crm/backend
npm install --production
npm run build
pm2 start ecosystem.config.js --env production
```

## 🌐 前端部署

### 1. 构建前端项目
在本地或服务器上执行：
```bash
cd /www/wwwroot/crm
npm run build
```

### 2. 配置网站
1. 在宝塔面板中添加站点
2. **域名**：您的域名（如：abc789.cn）
3. **根目录**：`/www/wwwroot/crm/dist`
4. **PHP版本**：纯静态（不需要PHP）

### 3. 配置Nginx反向代理
在站点设置中添加反向代理规则：

```nginx
# API代理
location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# 静态文件
location / {
    try_files $uri $uri/ /index.html;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# 上传文件代理
location /uploads/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## 🔧 部署步骤总结

### 第一步：数据库初始化
1. ✅ 在宝塔面板phpMyAdmin中执行 `backend/database-schema.sql`
2. ✅ 确认数据库连接信息正确

### 第二步：后端部署
1. 上传项目文件到服务器
2. 安装Node.js环境和PM2
3. 配置Node.js项目
4. 启动后端服务

### 第三步：前端部署
1. 构建前端项目
2. 配置网站和域名
3. 设置Nginx反向代理

### 第四步：测试验证
1. 访问网站首页
2. 测试登录功能（admin/admin123）
3. 检查API接口是否正常

## 🛠️ 常见问题解决

### 1. 数据库连接失败
- 检查数据库服务是否启动
- 确认数据库用户权限
- 验证连接信息是否正确

### 2. Node.js服务启动失败
- 检查端口是否被占用
- 查看PM2日志：`pm2 logs crm-backend`
- 确认依赖是否安装完整

### 3. 前端页面无法访问
- 检查Nginx配置是否正确
- 确认域名解析是否生效
- 查看网站错误日志

### 4. API接口404错误
- 检查反向代理配置
- 确认后端服务是否正常运行
- 验证API路径是否正确

## 📞 技术支持

如遇到部署问题，请检查：
1. 宝塔面板系统日志
2. Node.js项目运行日志
3. Nginx错误日志
4. 数据库连接状态

---

**重要提醒**：
- 部署完成后请立即修改默认管理员密码
- 定期备份数据库和项目文件
- 监控服务器资源使用情况
- 及时更新系统和依赖包