# 🚀 宝塔面板 CRM 系统部署指南

## 📋 概述

本指南专门针对宝塔面板 Node.js 16 环境下的 CRM 系统部署，解决了所有已知的兼容性问题。

## 🎯 适用场景

- ✅ 宝塔面板 Linux 环境
- ✅ Node.js 16.x 版本
- ✅ 前端构建失败问题
- ✅ crypto.getRandomValues 错误
- ✅ 依赖安装问题

## 🛠️ 修复工具集

### 1. 一键修复脚本 `bt-one-click-fix.sh` ⭐推荐

**最强大的修复工具，解决所有问题**

```bash
# 下载最新代码
git pull origin main

# 运行一键修复
chmod +x bt-one-click-fix.sh
./bt-one-click-fix.sh
```

**功能特点：**
- 🔍 自动环境检查
- 🧹 智能清理缓存
- 📦 兼容性依赖安装
- 🔨 多种构建方式尝试
- 🚀 自动服务启动
- 📊 完整状态报告

### 2. 专用部署脚本 `bt-deploy-node16.sh`

**简化版部署脚本，适合快速部署**

```bash
chmod +x bt-deploy-node16.sh
./bt-deploy-node16.sh
```

### 3. 故障排除工具 `bt-troubleshoot.sh`

**诊断和排查问题**

```bash
chmod +x bt-troubleshoot.sh
./bt-troubleshoot.sh
```

### 4. 兼容性修复脚本 `fix-node16-crypto.js`

**Node.js 16 兼容性修复**

```bash
node fix-node16-crypto.js
```

## 🔧 手动修复步骤

如果自动脚本无法解决问题，可以按以下步骤手动修复：

### 步骤1: 环境准备

```bash
# 设置环境变量
export NODE_OPTIONS="--max-old-space-size=4096"
export VITE_LEGACY_BUILD=true
export NODE_ENV=production

# 配置npm镜像源
npm config set registry https://registry.npmmirror.com
```

### 步骤2: 清理环境

```bash
# 停止服务
pm2 delete all

# 清理缓存
npm cache clean --force
rm -rf node_modules/.cache
rm -rf node_modules/.vite
rm -rf dist
```

### 步骤3: 安装依赖

```bash
# 前端依赖（兼容模式）
npm install --legacy-peer-deps --production=false

# 后端依赖
cd backend
npm install --legacy-peer-deps --production=false
cd ..
```

### 步骤4: 构建应用

```bash
# 运行兼容性修复
node fix-node16-crypto.js

# 构建前端（选择一种方式）
npm run build-node16                           # 推荐
# 或
npx vite build --config vite.config.node16.ts # 备选
# 或
npx vite build --mode production --target es2015 # 兜底

# 构建后端
cd backend
npm run build
cd ..
```

### 步骤5: 启动服务

```bash
cd backend
pm2 start dist/app.js --name "crm-backend" --env production
cd ..
```

## 🌐 宝塔面板配置

### 1. 添加网站

1. 登录宝塔面板
2. 点击"网站" → "添加站点"
3. 填写域名信息
4. **网站根目录设置为**: `/path/to/your/project/dist`

### 2. 配置 Nginx 反向代理

在网站设置中添加以下配置：

```nginx
location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 3. 配置 SSL（可选）

1. 在网站设置中点击"SSL"
2. 选择"Let's Encrypt"或上传证书
3. 开启"强制HTTPS"

## 🔍 常见问题解决

### Q1: 前端构建失败，提示 crypto.getRandomValues 错误

**解决方案：**
```bash
# 运行兼容性修复
node fix-node16-crypto.js

# 使用专用配置构建
npm run build-node16
```

### Q2: 依赖安装失败

**解决方案：**
```bash
# 清理依赖
rm -rf node_modules package-lock.json

# 兼容性安装
npm install --legacy-peer-deps --production=false
```

### Q3: 内存不足错误

**解决方案：**
```bash
# 增加Node.js内存限制
export NODE_OPTIONS="--max-old-space-size=4096"

# 或者在构建时指定
NODE_OPTIONS="--max-old-space-size=4096" npm run build-node16
```

### Q4: 服务启动失败

**解决方案：**
```bash
# 检查端口占用
netstat -tlnp | grep 3000

# 查看服务日志
pm2 logs crm-backend

# 重启服务
pm2 restart crm-backend
```

### Q5: 网络连接问题

**解决方案：**
```bash
# 使用国内镜像源
npm config set registry https://registry.npmmirror.com

# 或使用代理
npm config set proxy http://your-proxy:port
```

## 📊 验证部署

### 1. 检查构建结果

```bash
# 检查前端文件
ls -la dist/

# 检查后端文件
ls -la backend/dist/
```

### 2. 检查服务状态

```bash
# 查看PM2服务
pm2 list

# 检查端口监听
netstat -tlnp | grep 3000

# 测试API接口
curl http://localhost:3000/api/health
```

### 3. 检查网站访问

1. 访问你的域名
2. 检查前端页面是否正常加载
3. 测试API接口是否正常

## 🚨 紧急修复

如果遇到严重问题，使用紧急修复命令：

```bash
# 完全重置并修复
git pull origin main
rm -rf node_modules backend/node_modules dist backend/dist
./bt-one-click-fix.sh
```

## 📞 技术支持

### 日志收集

```bash
# 收集系统信息
./bt-troubleshoot.sh > system-info.log

# 收集服务日志
pm2 logs crm-backend > service.log

# 收集构建日志
npm run build-node16 > build.log 2>&1
```

### 联系支持

如果问题仍然存在，请提供以下信息：
- 系统信息日志 (`system-info.log`)
- 服务日志 (`service.log`)
- 构建日志 (`build.log`)
- 错误截图

## 🎉 部署成功标志

✅ 前端构建成功，生成 `dist` 目录  
✅ 后端构建成功，生成 `backend/dist` 目录  
✅ PM2 服务运行正常  
✅ 端口 3000 正常监听  
✅ 网站可以正常访问  
✅ API 接口响应正常  

## 📝 更新日志

- **v2.0** - 添加一键修复工具集
- **v1.5** - 增强 Node.js 16 兼容性
- **v1.0** - 基础宝塔面板支持

---

🎯 **记住：遇到问题先运行 `./bt-one-click-fix.sh`，90% 的问题都能自动解决！**