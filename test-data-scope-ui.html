<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据范围控制UI测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .user-info {
            background-color: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .access-yes {
            color: #4caf50;
            font-weight: bold;
        }
        .access-no {
            color: #f44336;
            font-weight: bold;
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        .test-fail {
            background-color: #ffeaea;
            border-left: 4px solid #f44336;
        }
        .button-group {
            text-align: center;
            margin: 20px 0;
        }
        .test-button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background-color: #1976d2;
        }
        .summary {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔒 数据范围控制UI测试</h1>
            <p>验证不同角色用户在订单列表页面看到的数据是否符合权限设置</p>
        </div>

        <div class="button-group">
            <button class="test-button" onclick="testAllRoles()">开始全面测试</button>
            <button class="test-button" onclick="clearResults()">清除结果</button>
            <button class="test-button" onclick="openCRMSystem()">打开CRM系统</button>
        </div>

        <div id="test-results"></div>

        <div class="summary" id="test-summary" style="display: none;">
            <h3>📊 测试总结</h3>
            <div id="summary-content"></div>
        </div>
    </div>

    <script>
        // 模拟用户数据
        const mockUsers = [
            {
                id: 'admin_001',
                name: '张三（超级管理员）',
                role: 'admin',
                roleText: '超级管理员',
                dataScope: 'all',
                departmentId: null,
                expectedAccess: {
                    allOrders: true,
                    ownOrders: true,
                    departmentOrders: true,
                    otherDepartmentOrders: true
                }
            },
            {
                id: 'manager_001',
                name: '李四（部门负责人）',
                role: 'department_manager',
                roleText: '部门负责人',
                dataScope: 'department',
                departmentId: 'dept_sales',
                expectedAccess: {
                    allOrders: false,
                    ownOrders: true,
                    departmentOrders: true,
                    otherDepartmentOrders: false
                }
            },
            {
                id: 'sales_001',
                name: '王五（销售员）',
                role: 'sales_staff',
                roleText: '销售员',
                dataScope: 'self',
                departmentId: 'dept_sales',
                expectedAccess: {
                    allOrders: false,
                    ownOrders: true,
                    departmentOrders: false,
                    otherDepartmentOrders: false
                }
            },
            {
                id: 'cs_001',
                name: '赵六（客服）',
                role: 'customer_service',
                roleText: '客服',
                dataScope: 'custom',
                departmentId: 'dept_service',
                customerServiceType: 'after_sales',
                expectedAccess: {
                    allOrders: false,
                    ownOrders: true,
                    departmentOrders: false,
                    otherDepartmentOrders: true, // 售后客服可以查看所有售后相关订单
                    afterSalesOrders: true
                }
            }
        ];

        // 模拟订单数据
        const mockOrders = [
            {
                id: 'order_001',
                orderNumber: 'ORD20241201001',
                customerName: '客户A',
                ownerId: 'admin_001',
                departmentId: 'dept_sales',
                type: 'normal',
                status: 'pending_shipment'
            },
            {
                id: 'order_002',
                orderNumber: 'ORD20241201002',
                customerName: '客户B',
                ownerId: 'sales_001',
                departmentId: 'dept_sales',
                type: 'normal',
                status: 'delivered'
            },
            {
                id: 'order_003',
                orderNumber: 'ORD20241201003',
                customerName: '客户C',
                ownerId: 'sales_002',
                departmentId: 'dept_marketing',
                type: 'after_sales',
                status: 'after_sales_created'
            },
            {
                id: 'order_004',
                orderNumber: 'ORD20241201004',
                customerName: '客户D',
                ownerId: 'manager_001',
                departmentId: 'dept_sales',
                type: 'normal',
                status: 'shipped'
            }
        ];

        // 数据访问权限检查函数
        function checkDataAccess(userId, dataOwnerId, dataDepartmentId, dataType = 'normal') {
            const user = mockUsers.find(u => u.id === userId);
            if (!user) return false;

            // 超级管理员可以访问所有数据
            if (user.dataScope === 'all') {
                return true;
            }

            // 用户可以访问自己创建的数据
            if (dataOwnerId === userId) {
                return true;
            }

            // 部门负责人可以访问部门内的数据
            if (user.dataScope === 'department') {
                return dataDepartmentId === user.departmentId;
            }

            // 销售员只能访问自己创建的数据
            if (user.dataScope === 'self') {
                return dataOwnerId === userId;
            }

            // 客服根据类型判断
            if (user.dataScope === 'custom' && user.customerServiceType === 'after_sales') {
                // 售后客服可以查看所有售后相关订单
                return dataType === 'after_sales' || dataOwnerId === userId;
            }

            return false;
        }

        // 测试单个用户的数据访问权限
        function testUserDataAccess(user) {
            const results = [];
            
            mockOrders.forEach(order => {
                const hasAccess = checkDataAccess(user.id, order.ownerId, order.departmentId, order.type);
                results.push({
                    order: order,
                    hasAccess: hasAccess,
                    expected: shouldHaveAccess(user, order)
                });
            });

            return results;
        }

        // 判断用户是否应该有访问权限（期望结果）
        function shouldHaveAccess(user, order) {
            if (user.dataScope === 'all') return true;
            if (order.ownerId === user.id) return true;
            if (user.dataScope === 'department' && order.departmentId === user.departmentId) return true;
            if (user.dataScope === 'self') return order.ownerId === user.id;
            if (user.dataScope === 'custom' && user.customerServiceType === 'after_sales') {
                return order.type === 'after_sales' || order.ownerId === user.id;
            }
            return false;
        }

        // 测试所有角色
        function testAllRoles() {
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = '';

            let totalTests = 0;
            let passedTests = 0;

            mockUsers.forEach(user => {
                const testResults = testUserDataAccess(user);
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'test-section';

                let sectionHTML = `
                    <div class="test-title">🧪 ${user.roleText}权限测试</div>
                    <div class="user-info">
                        <strong>用户信息：</strong>${user.name} | 
                        <strong>角色：</strong>${user.roleText} | 
                        <strong>数据范围：</strong>${getDataScopeText(user.dataScope)} | 
                        <strong>部门：</strong>${user.departmentId || '无'}
                        ${user.customerServiceType ? ` | <strong>客服类型：</strong>${getCustomerServiceTypeText(user.customerServiceType)}` : ''}
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>客户名称</th>
                                <th>创建者</th>
                                <th>所属部门</th>
                                <th>订单类型</th>
                                <th>实际访问权限</th>
                                <th>期望访问权限</th>
                                <th>测试结果</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let sectionPassed = 0;
                testResults.forEach(result => {
                    const isCorrect = result.hasAccess === result.expected;
                    totalTests++;
                    if (isCorrect) {
                        passedTests++;
                        sectionPassed++;
                    }

                    sectionHTML += `
                        <tr>
                            <td>${result.order.orderNumber}</td>
                            <td>${result.order.customerName}</td>
                            <td>${getUserName(result.order.ownerId)}</td>
                            <td>${result.order.departmentId}</td>
                            <td>${getOrderTypeText(result.order.type)}</td>
                            <td class="${result.hasAccess ? 'access-yes' : 'access-no'}">
                                ${result.hasAccess ? '✓ 可访问' : '✗ 不可访问'}
                            </td>
                            <td class="${result.expected ? 'access-yes' : 'access-no'}">
                                ${result.expected ? '✓ 应可访问' : '✗ 应不可访问'}
                            </td>
                            <td class="${isCorrect ? 'access-yes' : 'access-no'}">
                                ${isCorrect ? '✓ 正确' : '✗ 错误'}
                            </td>
                        </tr>
                    `;
                });

                sectionHTML += `
                        </tbody>
                    </table>
                    <div class="test-result ${sectionPassed === testResults.length ? 'test-pass' : 'test-fail'}">
                        <strong>测试结果：</strong>
                        ${sectionPassed}/${testResults.length} 个测试用例通过
                        ${sectionPassed === testResults.length ? ' - ✅ 全部通过' : ' - ❌ 存在问题'}
                    </div>
                `;

                sectionDiv.innerHTML = sectionHTML;
                resultsContainer.appendChild(sectionDiv);
            });

            // 显示总结
            showTestSummary(totalTests, passedTests);
        }

        // 显示测试总结
        function showTestSummary(total, passed) {
            const summaryDiv = document.getElementById('test-summary');
            const summaryContent = document.getElementById('summary-content');
            
            const passRate = ((passed / total) * 100).toFixed(1);
            const isAllPassed = passed === total;

            summaryContent.innerHTML = `
                <p><strong>总测试用例：</strong>${total} 个</p>
                <p><strong>通过测试：</strong>${passed} 个</p>
                <p><strong>失败测试：</strong>${total - passed} 个</p>
                <p><strong>通过率：</strong>${passRate}%</p>
                <p class="${isAllPassed ? 'access-yes' : 'access-no'}">
                    <strong>整体结果：</strong>${isAllPassed ? '✅ 数据范围控制功能正常' : '❌ 数据范围控制存在问题'}
                </p>
            `;

            summaryDiv.style.display = 'block';
            summaryDiv.className = isAllPassed ? 'summary test-pass' : 'summary test-fail';
        }

        // 辅助函数
        function getDataScopeText(scope) {
            const scopeMap = {
                'all': '全部数据',
                'department': '部门数据',
                'self': '个人数据',
                'custom': '自定义范围'
            };
            return scopeMap[scope] || scope;
        }

        function getCustomerServiceTypeText(type) {
            const typeMap = {
                'after_sales': '售后客服',
                'audit': '审核客服',
                'logistics': '物流客服',
                'product': '商品客服',
                'general': '通用客服'
            };
            return typeMap[type] || type;
        }

        function getOrderTypeText(type) {
            const typeMap = {
                'normal': '普通订单',
                'after_sales': '售后订单',
                'refund': '退款订单',
                'return': '退货订单'
            };
            return typeMap[type] || type;
        }

        function getUserName(userId) {
            const user = mockUsers.find(u => u.id === userId);
            return user ? user.name.split('（')[0] : userId;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').style.display = 'none';
        }

        function openCRMSystem() {
            window.open('http://localhost:5173', '_blank');
        }

        // 页面加载完成后自动运行测试
        window.onload = function() {
            console.log('数据范围控制UI测试页面已加载');
            // 可以选择自动运行测试
            // testAllRoles();
        };
    </script>
</body>
</html>