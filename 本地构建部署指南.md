# 本地构建部署指南

> 适用于低配置服务器（2GB 内存），在本地构建前端，只在服务器部署后端

---

## 📋 方案优势

- ✅ **节省服务器资源**：不在服务器上构建，节省内存和 CPU
- ✅ **构建速度快**：本地电脑性能通常比服务器好
- ✅ **部署简单**：服务器只需部署后端，操作简单
- ✅ **适合低配服务器**：2GB 内存也能流畅运行

---

## 🎯 部署流程概览

```
本地电脑                          服务器
   │                               │
   ├─ 1. 克隆代码                  │
   ├─ 2. 安装依赖                  │
   ├─ 3. 构建前端                  │
   ├─ 4. 打包 dist                 │
   │                               │
   └─ 5. 上传 dist ──────────────> ├─ 6. 解压 dist
                                   ├─ 7. 安装后端依赖
                                   ├─ 8. 启动后端服务
                                   └─ 9. 配置 Nginx
```

---

## 第一部分：本地构建（在您的电脑上）

### 前置要求

- ✅ 已安装 Node.js（16.x 或更高版本）
- ✅ 已安装 Git
- ✅ 网络连接正常

### 步骤 1：克隆项目到本地

#### Windows 用户：

1. 打开命令提示符（CMD）或 PowerShell
2. 进入您想要存放项目的目录，例如：
   ```cmd
   cd D:\Projects
   ```
3. 克隆项目：
   ```cmd
   git clone https://github.com/shushuhao01/CRM.git
   cd CRM
   ```

#### Mac/Linux 用户：

```bash
cd ~/Projects
git clone https://github.com/shushuhao01/CRM.git
cd CRM
```

### 步骤 2：配置环境变量

编辑 `.env.production` 文件（如果不存在，从 `.env.example` 复制）：

```env
# 生产环境配置
VITE_API_BASE_URL=/api
VITE_APP_TITLE=CRM管理系统
NODE_ENV=production
VITE_USE_REAL_API=true
```

**重要**：`VITE_API_BASE_URL=/api` 使用相对路径即可，Nginx 会处理反向代理。

### 步骤 3：运行构建脚本

#### Windows 用户：

双击运行 `build-local.bat` 文件，或在命令行执行：

```cmd
build-local.bat
```

#### Mac/Linux 用户：

```bash
chmod +x build-local.sh
./build-local.sh
```

### 步骤 4：等待构建完成

构建过程包括：
1. ✅ 配置 npm 镜像
2. ✅ 安装依赖（约 3-5 分钟）
3. ✅ 检查配置文件
4. ✅ 构建前端（约 2-3 分钟）
5. ✅ 打包构建文件

**看到以下信息表示成功**：
```
✅ 本地构建完成！
📁 构建文件位置: D:\Projects\CRM\dist
```

### 步骤 5：准备上传文件

构建完成后，您会得到：
- `dist` 文件夹（包含所有前端文件）
- `dist.zip`（如果自动打包成功）

---

## 第二部分：上传到服务器

### 方法一：使用宝塔面板上传（推荐）

#### 1. 打包 dist 文件夹

**Windows**：
- 右键 `dist` 文件夹
- 选择 "发送到" → "压缩(zipped)文件夹"
- 得到 `dist.zip`

**Mac**：
- 右键 `dist` 文件夹
- 选择 "压缩"
- 得到 `dist.zip`

#### 2. 上传到宝塔

1. 登录宝塔面板
2. 点击左侧 "文件"
3. 进入 `/www/wwwroot/abc789.cn`
4. 点击 "上传" 按钮
5. 选择 `dist.zip` 文件
6. 等待上传完成

#### 3. 解压文件

1. 在文件列表中找到 `dist.zip`
2. 点击右侧的 "解压" 按钮
3. 解压路径选择：`/www/wwwroot/abc789.cn`
4. 点击 "解压" 按钮
5. 解压完成后，删除 `dist.zip`

### 方法二：使用 FTP 上传

1. 使用 FileZilla 或其他 FTP 工具
2. 连接到服务器
3. 上传整个 `dist` 文件夹到 `/www/wwwroot/abc789.cn/dist`

### 方法三：使用 SCP 命令（Mac/Linux）

```bash
# 压缩 dist 文件夹
cd /path/to/CRM
tar -czf dist.tar.gz dist/

# 上传到服务器
scp dist.tar.gz root@您的服务器IP:/www/wwwroot/abc789.cn/

# SSH 登录服务器
ssh root@您的服务器IP

# 解压
cd /www/wwwroot/abc789.cn
tar -xzf dist.tar.gz
rm dist.tar.gz
```

---

## 第三部分：服务器部署（仅后端）

### 步骤 1：上传部署脚本

将 `deploy-server-only.sh` 文件上传到服务器的 `/www/wwwroot/abc789.cn` 目录。

### 步骤 2：配置后端环境变量

在宝塔面板中，编辑 `/www/wwwroot/abc789.cn/backend/.env` 文件：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=您的数据库用户名
DB_PASSWORD=您的数据库密码
DB_DATABASE=您的数据库名
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00

# 服务器配置
NODE_ENV=production
PORT=3000
API_PREFIX=/api/v1

# JWT配置
JWT_SECRET=您生成的随机密钥
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# CORS配置
CORS_ORIGIN=*
CORS_CREDENTIALS=true
```

### 步骤 3：运行部署脚本

在宝塔终端执行：

```bash
# 进入项目目录
cd /www/wwwroot/abc789.cn

# 给脚本执行权限
chmod +x deploy-server-only.sh

# 运行部署脚本
./deploy-server-only.sh
```

### 步骤 4：验证部署

脚本会自动完成：
1. ✅ 检查前端构建文件
2. ✅ 配置 npm 镜像
3. ✅ 安装后端依赖（仅生产环境）
4. ✅ 启动后端服务

**看到以下信息表示成功**：
```
✅ 部署完成！
📊 服务状态：
┌─────┬──────────────┬─────────┬─────────┐
│ id  │ name         │ status  │ restart │
├─────┼──────────────┼─────────┼─────────┤
│ 0   │ crm-backend  │ online  │ 0       │
└─────┴──────────────┴─────────┴─────────┘
```

---

## 第四部分：配置 Nginx

### 步骤 1：创建网站

1. 在宝塔面板，点击左侧 "网站"
2. 点击 "添加站点"
3. 填写信息：
   - **域名**：您的域名或 IP
   - **根目录**：`/www/wwwroot/abc789.cn/dist`
   - **PHP版本**：纯静态
4. 点击 "提交"

### 步骤 2：配置反向代理

1. 在网站列表找到刚创建的网站
2. 点击 "设置"
3. 点击 "反向代理" 标签
4. 点击 "添加反向代理"
5. 填写：
   - **代理名称**：`api`
   - **目标URL**：`http://127.0.0.1:3000`
   - **发送域名**：`$host`
6. 点击 "保存"

### 步骤 3：配置 URL 重写

1. 在网站设置中，点击 "配置文件" 标签
2. 找到 `location /` 部分，修改为：

```nginx
location / {
    try_files $uri $uri/ /index.html;
}

location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

3. 点击 "保存"

---

## 第五部分：测试验证

### 1. 检查后端服务

```bash
pm2 list
pm2 logs crm-backend --lines 20
```

### 2. 访问网站

在浏览器输入：`http://您的IP或域名`

应该能看到登录页面。

### 3. 测试登录

使用预设账号：
- 用户名：`superadmin`
- 密码：`super123456`

### 4. 测试功能

- ✅ 查看数据看板
- ✅ 客户管理
- ✅ 订单管理
- ✅ 数据查询

---

## 🔄 后续更新流程

当代码更新后，只需重复以下步骤：

### 在本地：

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 重新构建
./build-local.sh  # 或 build-local.bat

# 3. 上传新的 dist 文件夹
```

### 在服务器：

```bash
# 1. 备份旧文件（可选）
mv dist dist.backup

# 2. 解压新的 dist 文件夹

# 3. 如果后端代码有更新
cd /www/wwwroot/abc789.cn/backend
git pull origin main
npm install --production
pm2 restart crm-backend
```

---

## 📊 资源使用对比

| 部署方式 | 内存占用 | 构建时间 | 适用配置 |
|---------|---------|---------|---------|
| **服务器构建** | 1.5-2GB | 10-20分钟 | 4GB+ |
| **本地构建** | 200-500MB | 2-5分钟 | 2GB+ ✅ |

---

## 🔧 常见问题

### 问题 1：本地构建失败

**解决方案**：
```bash
# 清理缓存
rm -rf node_modules
rm -rf package-lock.json

# 重新安装
npm install

# 重新构建
npm run build
```

### 问题 2：上传文件太大

**解决方案**：
- 在宝塔面板 → 设置 → 上传限制，调整为 500MB
- 或使用 FTP/SCP 上传

### 问题 3：后端启动失败

**解决方案**：
```bash
# 查看详细日志
pm2 logs crm-backend

# 检查配置文件
cat backend/.env

# 检查端口占用
netstat -tunlp | grep 3000
```

### 问题 4：页面空白

**解决方案**：
1. 检查 dist 文件是否完整
2. 检查 Nginx 配置是否正确
3. 按 F12 查看浏览器控制台错误

---

## 💡 优化建议

### 1. 添加 Swap 虚拟内存

```bash
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 2. 优化 PM2 配置

创建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'crm-backend',
    script: 'npm',
    args: 'start',
    cwd: '/www/wwwroot/abc789.cn/backend',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

### 3. 定期清理日志

```bash
# 清理 PM2 日志
pm2 flush

# 清理系统日志
sudo journalctl --vacuum-time=7d
```

---

## 📞 需要帮助？

如果遇到问题：

1. 查看本文档的常见问题部分
2. 查看 PM2 日志：`pm2 logs crm-backend`
3. 查看 Nginx 日志：`/www/wwwlogs/`
4. 在 GitHub 提交 Issue

---

**版本**：v1.0  
**更新日期**：2024-11-23  
**适用于**：CRM 系统 v1.8.3+  
**推荐配置**：2GB+ 内存服务器
