# 数据库更新说明 v1.8.2

## 📅 更新时间
2024-11-23

## 🎯 更新概述

本次更新新增 **10个数据库表**，完善系统核心功能模块，包括消息通知、订单审核、业绩分享、物流管理等功能的数据持久化支持。

---

## 📊 新增数据库表详情

### 一、消息通知模块（2个表）

#### 1. notifications - 消息通知表

**用途**：存储用户的系统消息通知

**主要字段**：
- `id` - 通知ID
- `user_id` - 接收用户ID
- `type` - 消息类型（50+种类型）
- `title` - 消息标题
- `content` - 消息内容
- `category` - 消息分类（订单、售后、客户、物流、审核、业绩、短信等）
- `priority` - 优先级（low/normal/high/urgent）
- `is_read` - 是否已读
- `read_at` - 阅读时间
- `related_id` - 关联业务ID
- `related_type` - 关联业务类型
- `action_url` - 操作链接
- `icon` - 图标
- `color` - 颜色

**索引**：
- idx_user: 用户ID索引
- idx_type: 消息类型索引
- idx_category: 消息分类索引
- idx_is_read: 已读状态索引
- idx_priority: 优先级索引
- idx_related: 关联业务索引
- idx_created_at: 创建时间索引

**功能支持**：
- ✅ 50+种消息类型
- ✅ 消息分类管理
- ✅ 优先级管理
- ✅ 已读/未读状态
- ✅ 关联业务跳转
- ✅ 消息统计

---

#### 2. system_announcements - 系统公告表

**用途**：存储系统公告和通知

**主要字段**：
- `id` - 公告ID
- `title` - 公告标题
- `content` - 公告内容
- `type` - 公告类型（system/maintenance/update/notice）
- `priority` - 优先级
- `status` - 状态（draft/published/archived）
- `target_users` - 目标用户（JSON）
- `target_roles` - 目标角色（JSON）
- `target_departments` - 目标部门（JSON）
- `publish_time` - 发布时间
- `expire_time` - 过期时间
- `is_popup` - 是否弹窗显示
- `is_top` - 是否置顶
- `read_count` - 阅读次数
- `attachments` - 附件列表（JSON）

**功能支持**：
- ✅ 定向发布（用户/角色/部门）
- ✅ 定时发布
- ✅ 弹窗提醒
- ✅ 置顶功能
- ✅ 附件支持
- ✅ 阅读统计

---

### 二、订单审核模块（1个表）

#### 3. order_audits - 订单审核记录表

**用途**：记录订单的审核历史和流程

**主要字段**：
- `id` - 审核ID
- `order_id` - 订单ID
- `order_number` - 订单号
- `audit_type` - 审核类型（create/modify/cancel/return）
- `audit_status` - 审核状态（pending/approved/rejected）
- `audit_level` - 审核级别
- `auditor_id` - 审核人ID
- `auditor_name` - 审核人姓名
- `audit_time` - 审核时间
- `audit_result` - 审核结果
- `audit_remark` - 审核备注
- `before_data` - 修改前数据（JSON）
- `after_data` - 修改后数据（JSON）
- `applicant_id` - 申请人ID
- `applicant_name` - 申请人姓名
- `apply_reason` - 申请原因
- `apply_time` - 申请时间

**功能支持**：
- ✅ 多种审核类型
- ✅ 多级审核流程
- ✅ 审核历史追溯
- ✅ 数据变更对比
- ✅ 审核统计报表

---

### 三、业绩分享模块（2个表）

#### 4. performance_shares - 业绩分享记录表

**用途**：记录业绩分享的基本信息

**主要字段**：
- `id` - 分享ID
- `share_number` - 分享编号
- `order_id` - 订单ID
- `order_number` - 订单号
- `order_amount` - 订单金额
- `total_share_amount` - 总分享金额
- `share_count` - 分享人数
- `status` - 状态（active/completed/cancelled）
- `description` - 分享说明
- `created_by` - 创建人ID
- `created_by_name` - 创建人姓名
- `completed_at` - 完成时间
- `cancelled_at` - 取消时间

---

#### 5. performance_share_members - 业绩分享成员表

**用途**：记录业绩分享的成员明细

**主要字段**：
- `id` - 成员ID
- `share_id` - 分享记录ID（外键）
- `user_id` - 用户ID
- `user_name` - 用户姓名
- `department` - 所属部门
- `share_percentage` - 分享比例
- `share_amount` - 分享金额
- `status` - 确认状态（pending/confirmed/rejected）
- `confirm_time` - 确认时间
- `reject_reason` - 拒绝原因

**功能支持**：
- ✅ 多人业绩分配
- ✅ 比例自动计算
- ✅ 成员确认机制
- ✅ 分享历史记录
- ✅ 业绩统计分析

---

### 四、物流管理模块（4个表）

#### 6. logistics_companies - 物流公司表

**用途**：管理物流公司信息和配置

**主要字段**：
- `id` - 公司ID
- `code` - 公司代码（唯一）
- `name` - 公司名称
- `short_name` - 公司简称
- `logo` - Logo URL
- `website` - 官网地址
- `tracking_url` - 跟踪查询地址
- `api_url` - API接口地址
- `api_key` - API密钥
- `api_secret` - API密钥
- `contact_phone` - 联系电话
- `contact_email` - 联系邮箱
- `service_area` - 服务区域
- `price_info` - 价格信息（JSON）
- `status` - 状态（active/inactive）
- `sort_order` - 排序
- `remark` - 备注

**功能支持**：
- ✅ 物流公司管理
- ✅ API接口配置
- ✅ 价格信息管理
- ✅ 服务区域设置

---

#### 7. logistics_status_history - 物流状态历史表

**用途**：记录物流状态的变更历史

**主要字段**：
- `id` - 历史ID
- `logistics_id` - 物流记录ID
- `order_id` - 订单ID
- `order_number` - 订单号
- `tracking_number` - 物流单号
- `old_status` - 原状态
- `new_status` - 新状态
- `status_text` - 状态描述
- `location` - 当前位置
- `operator` - 操作人
- `operator_name` - 操作人姓名
- `update_source` - 更新来源（manual/auto/api）
- `remark` - 备注

**功能支持**：
- ✅ 状态变更追溯
- ✅ 自动/手动更新记录
- ✅ 位置信息记录
- ✅ 操作人追踪

---

#### 8. logistics_exceptions - 物流异常记录表

**用途**：记录和处理物流异常情况

**主要字段**：
- `id` - 异常ID
- `logistics_id` - 物流记录ID
- `order_id` - 订单ID
- `order_number` - 订单号
- `tracking_number` - 物流单号
- `exception_type` - 异常类型
- `exception_desc` - 异常描述
- `exception_time` - 异常时间
- `status` - 处理状态（pending/processing/resolved/closed）
- `handler_id` - 处理人ID
- `handler_name` - 处理人姓名
- `handle_time` - 处理时间
- `handle_result` - 处理结果
- `solution` - 解决方案
- `images` - 相关图片（JSON）

**功能支持**：
- ✅ 异常类型分类
- ✅ 异常处理流程
- ✅ 图片证据上传
- ✅ 处理结果记录

---

#### 9. logistics_todos - 物流待办事项表

**用途**：管理物流相关的待办事项

**主要字段**：
- `id` - 待办ID
- `logistics_id` - 物流记录ID
- `order_id` - 订单ID
- `order_number` - 订单号
- `tracking_number` - 物流单号
- `todo_type` - 待办类型
- `todo_title` - 待办标题
- `todo_content` - 待办内容
- `priority` - 优先级（low/normal/high/urgent）
- `status` - 状态（pending/processing/completed/cancelled）
- `assigned_to` - 负责人ID
- `assigned_to_name` - 负责人姓名
- `due_date` - 截止时间
- `remind_time` - 提醒时间
- `completed_time` - 完成时间
- `remark` - 备注
- `created_by` - 创建人ID
- `created_by_name` - 创建人姓名

**功能支持**：
- ✅ 待办任务管理
- ✅ 优先级设置
- ✅ 任务分配
- ✅ 到期提醒
- ✅ 完成状态追踪

---

### 五、订单配置模块（1个表）

#### 10. order_field_configs - 订单字段配置表

**用途**：管理订单的自定义字段配置

**主要字段**：
- `id` - 配置ID
- `field_key` - 字段键名（唯一）
- `field_name` - 字段名称
- `field_type` - 字段类型（text/number/date/datetime/select/radio/checkbox）
- `field_options` - 字段选项（JSON）
- `default_value` - 默认值
- `placeholder` - 占位符
- `is_required` - 是否必填
- `is_visible` - 是否可见
- `show_in_list` - 列表显示
- `show_in_detail` - 详情显示
- `sort_order` - 排序
- `validation_rules` - 验证规则（JSON）
- `description` - 字段描述

**功能支持**：
- ✅ 动态字段配置
- ✅ 多种字段类型
- ✅ 字段验证规则
- ✅ 显示控制
- ✅ 排序管理

---

## 📈 数据库统计

### 更新前：19个表
- 核心表：5个
- 业务表：5个
- 统计表：2个
- 配置表：3个
- 通话管理表：2个
- 短信管理表：2个

### 更新后：29个表
- 核心表：5个
- 业务表：5个
- 统计表：2个
- 配置表：3个
- 通话管理表：2个
- 短信管理表：2个
- **消息通知表：2个** ✨新增
- **订单审核表：1个** ✨新增
- **业绩分享表：2个** ✨新增
- **物流扩展表：4个** ✨新增
- **订单配置表：1个** ✨新增

---

## 🔄 升级方式

### 方式一：全新安装（推荐）
如果是新系统，直接导入最新的 `schema.sql` 文件即可。

### 方式二：增量升级
如果已有旧数据库，执行以下SQL语句进行升级：

```sql
-- 执行 schema.sql 中第20-29个表的创建语句
-- 或者单独执行每个表的 CREATE TABLE 语句
```

---

## ⚠️ 注意事项

1. **数据迁移**：
   - 消息通知：需要从 localStorage 迁移到数据库
   - 业绩分享：需要从 localStorage 迁移到数据库
   - 物流公司：需要初始化常用物流公司数据

2. **API适配**：
   - 需要更新后端API接口以支持新表
   - 需要修改前端代码，从 localStorage 改为 API 调用

3. **权限配置**：
   - 需要为新表配置相应的数据权限规则
   - 需要更新角色权限配置

4. **索引优化**：
   - 所有新表都已添加必要的索引
   - 根据实际查询场景可能需要调整

5. **外键约束**：
   - `performance_share_members` 表有外键约束
   - 删除分享记录时会级联删除成员记录

---

## 💡 功能增强

### 1. 消息通知系统
- 支持50+种消息类型
- 支持消息分类和优先级
- 支持已读/未读状态管理
- 支持关联业务跳转
- 支持消息统计和报表

### 2. 订单审核系统
- 支持多种审核类型
- 支持多级审核流程
- 支持审核历史追溯
- 支持数据变更对比
- 支持审核统计报表

### 3. 业绩分享系统
- 支持多人业绩分配
- 支持比例自动计算
- 支持成员确认机制
- 支持分享历史记录
- 支持业绩统计分析

### 4. 物流管理系统
- 支持物流公司管理
- 支持状态变更追溯
- 支持异常处理流程
- 支持待办任务管理
- 支持API接口配置

### 5. 订单配置系统
- 支持动态字段配置
- 支持多种字段类型
- 支持字段验证规则
- 支持显示控制
- 支持排序管理

---

## 🔗 相关文档

- [数据库完整说明](./database/README.md)
- [数据库脚本](./database/schema.sql)
- [数据库表补充分析](./数据库表补充分析.md)
- [宝塔部署指南](./宝塔部署快速指南.md)

---

## 📞 技术支持

如有问题，请查看项目文档或提交 Issue。

---

## 🎯 下一步计划

1. **数据迁移脚本**：编写 localStorage 到数据库的迁移脚本
2. **API接口开发**：开发新表对应的后端API接口
3. **前端适配**：修改前端代码以使用新的API接口
4. **测试验证**：全面测试新功能的数据持久化
5. **性能优化**：根据实际使用情况优化索引和查询

---

**版本**：v1.8.2  
**更新日期**：2024-11-23  
**更新内容**：新增10个数据库表，完善系统核心功能
