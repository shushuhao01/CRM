# 宝塔部署快速指南（5分钟完成）

## 前提条件

- ✅ 已安装宝塔面板 7.x+
- ✅ 已安装 Nginx 1.20+
- ✅ 已安装 MySQL 8.0+
- ✅ 已安装 Node.js 18+ (通过宝塔软件商店安装)
- ✅ 已安装 PM2 (通过宝塔软件商店安装)

---

## 快速部署步骤

### 第一步：上传代码（2分钟）

#### 方式一：使用 Git（推荐）
```bash
# 1. SSH 连接到服务器
ssh root@your-server-ip

# 2. 进入网站目录
cd /www/wwwroot

# 3. 克隆项目
git clone https://github.com/shushuhao01/CRM.git
cd CRM

# 4. 安装依赖（自动执行）
npm install
cd backend && npm install && cd ..
```

#### 方式二：使用宝塔面板上传
1. 在宝塔面板 → 文件 → 上传项目压缩包
2. 解压到 `/www/wwwroot/CRM`

---

### 第二步：创建数据库（1分钟）

1. 进入宝塔面板 → 数据库
2. 点击"添加数据库"
3. 填写信息：
   - 数据库名：`crm_db`
   - 用户名：`crm_user`
   - 密码：自动生成（记住这个密码）
4. 点击"提交"
5. 点击数据库名称 → 导入 → 上传 `database/schema.sql`

---

### 第三步：配置环境变量（1分钟）

#### 配置后端环境变量
编辑 `backend/.env` 文件：
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=crm_user
DB_PASSWORD=你的数据库密码
DB_NAME=crm_db

# 服务器配置
PORT=3000
NODE_ENV=production

# JWT 配置（随机生成一个）
JWT_SECRET=your-random-secret-key-here
JWT_EXPIRES_IN=7d
```

#### 配置前端环境变量
编辑 `.env.production` 文件：
```env
# API 地址（改成你的域名）
VITE_API_BASE_URL=https://你的域名.com/api

# 使用真实 API
VITE_USE_REAL_API=true
```

---

### 第四步：构建前端（1分钟）

```bash
cd /www/wwwroot/CRM
npm run build
```

构建完成后，`dist` 目录包含静态文件。

---

### 第五步：配置 Nginx（1分钟）

#### 5.1 创建网站
1. 宝塔面板 → 网站 → 添加站点
2. 填写信息：
   - 域名：`你的域名.com`
   - 根目录：`/www/wwwroot/CRM/dist`
   - PHP 版本：纯静态
3. 点击"提交"

#### 5.2 配置反向代理
1. 点击网站名称 → 设置 → 反向代理
2. 添加反向代理：
   - 代理名称：`api`
   - 目标 URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`
3. 点击"保存"

#### 5.3 配置 URL 重写
点击"配置文件"，在 `location /` 块中添加：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}

location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

点击"保存"。

---

### 第六步：启动后端服务（30秒）

```bash
cd /www/wwwroot/CRM/backend
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

查看运行状态：
```bash
pm2 list
pm2 logs crm-backend
```

---

### 第七步：配置图片上传目录（重要！）

#### 7.1 创建上传目录
```bash
cd /www/wwwroot/CRM/backend
mkdir -p uploads/system uploads/products uploads/avatars uploads/orders uploads/services
chmod -R 755 uploads
```

#### 7.2 配置 Nginx 静态文件服务
在网站配置文件中添加（在 `location /api` 之前）：
```nginx
# 静态文件服务 - 上传的图片
location ^~ /uploads/ {
    alias /www/wwwroot/CRM/backend/uploads/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin *;
}
```

#### 7.3 存储配置说明
系统支持两种存储方式：
- **本地存储**（默认）：图片保存在服务器 `backend/uploads/` 目录
- **阿里云OSS**：图片上传到阿里云对象存储

在系统设置 → 存储设置中可以切换存储方式。

---

### 第八步：配置 SSL（可选，1分钟）

1. 网站设置 → SSL
2. 选择"Let's Encrypt"
3. 点击"申请"
4. 开启"强制 HTTPS"

---

### 第九步：验证部署（30秒）

1. 访问 `https://你的域名.com`
2. 使用测试账号登录：
   - 用户名：`admin`
   - 密码：`admin123`
3. 检查功能是否正常
4. 测试图片上传功能（系统设置 → 上传二维码）

---

## 一键部署脚本

为了更方便，我们提供了一键部署脚本：

```bash
# 下载并执行部署脚本
cd /www/wwwroot/CRM
chmod +x deploy.sh
./deploy.sh
```

脚本会自动：
1. ✅ 检查依赖是否安装
2. ✅ 安装前后端依赖
3. ✅ 构建前端
4. ✅ 启动后端服务
5. ✅ 显示部署状态

---

## 常见问题

### Q: 如何检查依赖是否已安装？
```bash
# 检查前端依赖
ls node_modules | wc -l

# 检查后端依赖
ls backend/node_modules | wc -l

# 如果数量为 0，说明未安装，执行：
npm install
cd backend && npm install
```

### Q: 如何重新安装依赖？
```bash
# 删除旧依赖
rm -rf node_modules package-lock.json
rm -rf backend/node_modules backend/package-lock.json

# 重新安装
npm install
cd backend && npm install
```

### Q: 后端启动失败怎么办？
```bash
# 查看错误日志
pm2 logs crm-backend

# 常见问题：
# 1. 端口被占用 → 修改 backend/.env 中的 PORT
# 2. 数据库连接失败 → 检查 backend/.env 中的数据库配置
# 3. 依赖缺失 → cd backend && npm install
```

### Q: 前端页面空白怎么办？
```bash
# 1. 检查构建是否成功
ls dist/

# 2. 检查 Nginx 配置
nginx -t

# 3. 重新构建
npm run build

# 4. 重启 Nginx
systemctl restart nginx
```

### Q: API 请求 404 怎么办？
```bash
# 1. 检查后端是否运行
pm2 list

# 2. 检查端口是否监听
netstat -tlnp | grep 3000

# 3. 检查 Nginx 反向代理配置
# 确保有 location /api 配置
```

### Q: 图片上传成功但无法显示（404）怎么办？
```bash
# 1. 检查上传目录是否存在
ls -la /www/wwwroot/CRM/backend/uploads/

# 2. 检查目录权限
chmod -R 755 /www/wwwroot/CRM/backend/uploads/

# 3. 检查 Nginx 配置是否包含 /uploads 静态文件服务
# 确保有以下配置：
# location ^~ /uploads/ {
#     alias /www/wwwroot/CRM/backend/uploads/;
# }

# 4. 重启 Nginx
systemctl restart nginx

# 5. 测试图片访问
curl -I https://你的域名.com/uploads/system/test.jpg
```

### Q: 如何切换到阿里云OSS存储？
1. 登录系统 → 系统设置 → 存储设置
2. 选择"阿里云OSS"
3. 填写 Access Key、Secret Key、Bucket名称、存储区域
4. 点击"保存设置"
5. 新上传的图片将自动存储到OSS

---

## 部署检查清单

部署完成后，请检查以下项目：

- [ ] 前端页面可以访问
- [ ] 可以正常登录
- [ ] 菜单显示正常
- [ ] 可以新增客户
- [ ] 可以新增订单
- [ ] 数据可以保存
- [ ] 后端 API 正常响应
- [ ] PM2 进程运行正常
- [ ] SSL 证书配置成功（如果需要）
- [ ] 图片上传功能正常（系统设置 → 上传二维码测试）
- [ ] 上传的图片可以正常显示
- [ ] 商品图片可

---

## 更新代码

当需要更新代码时：

```bash
cd /www/wwwroot/CRM

# 1. 拉取最新代码
git pull

# 2. 安装新依赖（如果有）
npm install
cd backend && npm install && cd ..

# 3. 重新构建前端
npm run build

# 4. 重启后端
pm2 restart crm-backend

# 5. 查看状态
pm2 logs crm-backend
```

---

## 性能优化建议

### 1. 开启 Gzip 压缩
在 Nginx 配置中添加：
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
gzip_min_length 1000;
```

### 2. 配置缓存
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

### 3. 数据库优化
- 定期备份数据库
- 添加必要的索引
- 定期清理日志表

---

## 技术支持

如遇到问题，请提供：
1. 错误日志（`pm2 logs crm-backend`）
2. Nginx 错误日志（`/var/log/nginx/error.log`）
3. 系统信息（`uname -a`）
4. Node.js 版本（`node -v`）

GitHub Issues: https://github.com/shushuhao01/CRM/issues
