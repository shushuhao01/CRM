# 🔄 宝塔面板代码更新指南

## 📝 更新说明
本次更新内容：
- ✅ 恢复MySQL数据库配置支持
- ✅ 优化一键部署脚本
- ✅ 更新环境配置文件
- ✅ 完善部署指南文档

## 🚀 快速更新步骤

### 方法一：Git拉取更新（推荐）

如果你的服务器已经部署了代码，使用这种方法最简单：

1. **登录宝塔面板终端**
   ```bash
   # 进入项目目录
   cd /www/wwwroot/你的网站目录
   ```

2. **拉取最新代码**
   ```bash
   # 拉取最新代码
   git pull origin main
   ```

3. **重新构建和启动**
   ```bash
   # 运行更新脚本
   chmod +x start.sh
   ./start.sh
   ```

### 方法二：重新下载部署

如果遇到Git冲突或者是首次部署：

1. **备份现有配置**
   ```bash
   # 备份数据库配置
   cp backend/.env.production backend/.env.production.backup
   ```

2. **下载最新代码**
   ```bash
   # 删除旧代码（注意备份重要数据）
   rm -rf /www/wwwroot/你的网站目录/*
   
   # 重新克隆代码
   git clone https://github.com/shushuhao01/CRM.git /www/wwwroot/你的网站目录
   ```

3. **恢复配置文件**
   ```bash
   # 恢复数据库配置
   cp backend/.env.production.backup backend/.env.production
   ```

4. **运行部署脚本**
   ```bash
   chmod +x start.sh
   ./start.sh
   ```

## ⚙️ 配置更新

### 1. 检查MySQL配置

确保 `backend/.env.production` 文件包含正确的MySQL配置：

```env
# MySQL数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=你的数据库用户名
DB_PASSWORD=你的数据库密码
DB_DATABASE=crm
```

### 2. 验证服务状态

```bash
# 检查PM2服务状态
pm2 list

# 查看服务日志
pm2 logs crm-backend

# 重启服务（如果需要）
pm2 restart crm-backend
```

## 🔍 更新验证

### 1. 检查后端服务
```bash
# 测试后端API
curl http://localhost:3000/api/health
```

### 2. 检查前端访问
- 打开浏览器访问你的网站
- 确认页面正常加载
- 测试登录功能

### 3. 检查数据库连接
- 查看PM2日志确认没有数据库连接错误
- 测试系统功能是否正常

## ❗ 常见问题

### Q1: Git拉取失败？
```bash
# 强制拉取（会覆盖本地修改）
git fetch --all
git reset --hard origin/main
```

### Q2: PM2启动失败？
```bash
# 查看详细错误
pm2 logs crm-backend --lines 50

# 删除旧进程重新启动
pm2 delete crm-backend
./start.sh
```

### Q3: 数据库连接失败？
- 检查MySQL服务是否运行
- 确认数据库配置信息正确
- 检查数据库用户权限

### Q4: 前端页面空白？
```bash
# 重新构建前端
npm run build

# 检查Nginx配置
nginx -t
systemctl reload nginx
```

## 📞 技术支持

如果更新过程中遇到问题：

1. **查看日志**：`pm2 logs crm-backend`
2. **检查服务**：`pm2 list`
3. **重启服务**：`pm2 restart crm-backend`
4. **重新部署**：删除项目重新克隆

## 🎉 更新完成

更新成功后，你的CRM系统将：
- ✅ 支持MySQL数据库
- ✅ 拥有更稳定的部署脚本
- ✅ 更完善的配置管理
- ✅ 更好的错误处理

享受你的升级版CRM系统吧！🚀